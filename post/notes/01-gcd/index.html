<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ğŸ“’ä¸ªäººå¤‡å¿˜ - é˜Ÿåˆ—ã€GCDã€çº¿ç¨‹åŸºç¡€ - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="åœŸåœŸEdmondæœ¨" /><meta name="description" content="[toc] å¼•å­ æœ¬ç¯‡å†…å®¹å¤§å¤šæ¥è‡ªç½‘ç»œä¸Šçš„ä¸€äº›æ–‡ç« ï¼Œå¸Œæœ›åšä¸€ä¸ª ğŸ“ å’Œå‚è€ƒï¼Œå¦‚æœ‰å‡ºé”™çš„åœ°æ–¹å¸Œæœ›æŒ‡æ­£ã€‚ èµ·å› æ˜¯å…¬å¸å†…éƒ¨çš„åŒå­¦åœ¨å¼€å‘ä¸­é‡åˆ°äº† FMDB çš„ä¸€ä¸ª Crashï¼ŒæŸ¥" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.71.1 with theme even" />


<link rel="canonical" href="http://looseyi.github.io/post/notes/01-gcd/" />
  <link href="http://looseyi.github.io/post/notes/01-gcd/index.xml" rel="alternate" type="application/rss+xml" title="" />
  <link href="http://looseyi.github.io/post/notes/01-gcd/index.xml" rel="feed" type="application/rss+xml" title="" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="ğŸ“’ä¸ªäººå¤‡å¿˜ - é˜Ÿåˆ—ã€GCDã€çº¿ç¨‹åŸºç¡€" />
<meta property="og:description" content="[toc] å¼•å­ æœ¬ç¯‡å†…å®¹å¤§å¤šæ¥è‡ªç½‘ç»œä¸Šçš„ä¸€äº›æ–‡ç« ï¼Œå¸Œæœ›åšä¸€ä¸ª ğŸ“ å’Œå‚è€ƒï¼Œå¦‚æœ‰å‡ºé”™çš„åœ°æ–¹å¸Œæœ›æŒ‡æ­£ã€‚ èµ·å› æ˜¯å…¬å¸å†…éƒ¨çš„åŒå­¦åœ¨å¼€å‘ä¸­é‡åˆ°äº† FMDB çš„ä¸€ä¸ª Crashï¼ŒæŸ¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://looseyi.github.io/post/notes/01-gcd/" />
<meta property="article:published_time" content="2020-06-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-16T00:00:00+00:00" />
<meta itemprop="name" content="ğŸ“’ä¸ªäººå¤‡å¿˜ - é˜Ÿåˆ—ã€GCDã€çº¿ç¨‹åŸºç¡€">
<meta itemprop="description" content="[toc] å¼•å­ æœ¬ç¯‡å†…å®¹å¤§å¤šæ¥è‡ªç½‘ç»œä¸Šçš„ä¸€äº›æ–‡ç« ï¼Œå¸Œæœ›åšä¸€ä¸ª ğŸ“ å’Œå‚è€ƒï¼Œå¦‚æœ‰å‡ºé”™çš„åœ°æ–¹å¸Œæœ›æŒ‡æ­£ã€‚ èµ·å› æ˜¯å…¬å¸å†…éƒ¨çš„åŒå­¦åœ¨å¼€å‘ä¸­é‡åˆ°äº† FMDB çš„ä¸€ä¸ª Crashï¼ŒæŸ¥">
<meta itemprop="datePublished" content="2020-06-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-06-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3545">



<meta itemprop="keywords" content="iOS&#39;,ğŸ“’,GCD," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ğŸ“’ä¸ªäººå¤‡å¿˜ - é˜Ÿåˆ—ã€GCDã€çº¿ç¨‹åŸºç¡€"/>
<meta name="twitter:description" content="[toc] å¼•å­ æœ¬ç¯‡å†…å®¹å¤§å¤šæ¥è‡ªç½‘ç»œä¸Šçš„ä¸€äº›æ–‡ç« ï¼Œå¸Œæœ›åšä¸€ä¸ª ğŸ“ å’Œå‚è€ƒï¼Œå¦‚æœ‰å‡ºé”™çš„åœ°æ–¹å¸Œæœ›æŒ‡æ­£ã€‚ èµ·å› æ˜¯å…¬å¸å†…éƒ¨çš„åŒå­¦åœ¨å¼€å‘ä¸­é‡åˆ°äº† FMDB çš„ä¸€ä¸ª Crashï¼ŒæŸ¥"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Aha Moment</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Aha Moment</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">ğŸ“’ä¸ªäººå¤‡å¿˜ - é˜Ÿåˆ—ã€GCDã€çº¿ç¨‹åŸºç¡€</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-06-16 </span>
        <div class="post-category">
            <a href="/categories/ios/"> iOS </a>
            <a href="/categories//"> ğŸ“’ </a>
            </div>
          <span class="more-meta"> çº¦ 3545 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#å¹¶è¡Œå’Œå¹¶å‘">å¹¶è¡Œå’Œå¹¶å‘</a></li>
    <li><a href="#dispatch-queues">Dispatch Queues</a>
      <ul>
        <li><a href="#serial-dispatch-queue">Serial Dispatch Queue</a></li>
        <li><a href="#concurrent-dispatch-queue">Concurrent Dispatch Queue</a></li>
        <li><a href="#main-dispatch-queue">Main Dispatch Queue</a></li>
      </ul>
    </li>
    <li><a href="#runloop">RunLoop</a></li>
  </ul>

  <ul>
    <li><a href="#dispatch_sync">dispatch_sync</a></li>
    <li><a href="#dispatch_async">dispatch_async</a></li>
    <li><a href="#queues--dispatch">Queues &amp; Dispatch</a>
      <ul>
        <li><a href="#serial-queues-dispatch">Serial Queues Dispatch</a></li>
        <li><a href="#concurrent-queue-dispatch">Concurrent Queue Dispatch</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#ä¸èƒ½åµŒå¥—è°ƒç”¨-fmdatabasequeue-å¦åˆ™çº¿ç¨‹æ­»é”">ä¸èƒ½åµŒå¥—è°ƒç”¨ FMDatabaseQueue å¦åˆ™çº¿ç¨‹æ­»é”</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>[toc]</p>
<h1 id="å¼•å­">å¼•å­</h1>
<p>æœ¬ç¯‡å†…å®¹å¤§å¤šæ¥è‡ªç½‘ç»œä¸Šçš„ä¸€äº›æ–‡ç« ï¼Œå¸Œæœ›åšä¸€ä¸ª ğŸ“ å’Œå‚è€ƒï¼Œå¦‚æœ‰å‡ºé”™çš„åœ°æ–¹å¸Œæœ›æŒ‡æ­£ã€‚</p>
<p>èµ·å› æ˜¯å…¬å¸å†…éƒ¨çš„åŒå­¦åœ¨å¼€å‘ä¸­é‡åˆ°äº† FMDB çš„ä¸€ä¸ª Crashï¼ŒæŸ¥çœ‹æºç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">inDatabase:</span><span class="p">(</span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noescape</span><span class="p">))</span> <span class="nv">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span><span class="p">))</span><span class="nv">block</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG
</span><span class="cp"></span>    <span class="n">FMDatabaseQueue</span> <span class="o">*</span><span class="n">currentSyncQueue</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="kt">id</span><span class="p">)</span><span class="n">dispatch_get_specific</span><span class="p">(</span><span class="n">kDispatchQueueSpecificKey</span><span class="p">);</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="cp">#endif
</span><span class="cp"></span>    <span class="n">dispatch_sync</span><span class="p">(</span><span class="n">_queue</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">database</span><span class="p">];</span>        
        <span class="n">block</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	    <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å‘ç° FMDB å†…éƒ¨å±…ç„¶æ˜¯ä½¿ç”¨äº† <code>dispatch_sync</code>ï¼Œæˆ‘ä»¬ä»å°å°±è¢«æ•™è‚²è¦å°‘ç”¨ sync è€Œè¿™é‡Œå±…ç„¶æ˜ç›®å¼ èƒ†çš„ä½¿ç”¨äº†ã€‚ã€‚ã€‚</p>
<p>çœ‹æ¥ä¸€å®šæ˜¯æˆ‘å“ªé‡Œæœ‰æ‰€è¯¯è§£ã€‚</p>
<h1 id="gcd-åŸºç¡€">GCD åŸºç¡€</h1>
<p>GCD å±äºè‹¹æœæ ¸å¿ƒç³»ç»Ÿï¼Œå®ƒå°è£…äº†å¤šçº¿ç¨‹æ“ä½œå¹¶åœ¨å…¶ä¹‹ä¸Šå¢åŠ äº†ä»»åŠ¡å®¹å™¨ &mdash; Dispatch queuesã€‚å¯ä»¥è¯´ï¼ŒApple å¸Œæœ›æ·¡åŒ–çº¿ç¨‹æ¦‚å¿µï¼Œå¼ºåŒ–æ˜“ç†è§£çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<h2 id="å¹¶è¡Œå’Œå¹¶å‘">å¹¶è¡Œå’Œå¹¶å‘</h2>
<p>åœ¨å¤šçº¿ç¨‹æ¨¡å‹çš„è®¨è®ºä¸­ï¼Œææ˜ç™½ <strong>å¹¶è¡Œå’Œå¹¶å‘</strong> è¿™ä¸¤ä¸ªæ¦‚å¿µååˆ†é‡è¦ï¼Œå…³äºå®ƒä»¬çš„è§£é‡Šä¹Ÿæ˜¯å„æœ‰ä¸åŒï¼Œè¿™é‡Œå‚è€ƒ StackOverflow ä¸Šçš„<a href="https://stackoverflow.com/questions/1050222/what-is-the-difference-between-concurrency-and-parallelism#:~:text=Concurrency%20is%20when%20two%20or,complete%20in%20overlapping%20time%20periods.&amp;text=Parallelism%20is%20when%20tasks%20literally,two%20threads%20are%20making%20progress.">å›ç­”</a>ï¼š</p>
<p><strong>Concurrency</strong></p>
<blockquote>
<p>Concurrency is when two or more tasks can start, run, and complete in overlapping time <strong>periods</strong>. It doesn&rsquo;t necessarily mean they&rsquo;ll ever both be running <strong>at the same instant</strong>. For example, <em>multitasking</em> on a single-core machine.</p>
</blockquote>
<p><img src="https://ww1.sinaimg.cn/large/8157560cgy1ggt4oj7d0wj20hf090dfz.jpg" alt="01-Concurrency"></p>
<p><strong>Parallelism</strong></p>
<blockquote>
<p>Parallelism is when tasks <em>literally</em> run at the same time, e.g., on a multicore processor.</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/8157560cgy1ggt4ojabfzj20hf090dg8.jpg" alt="02-Parallelism"></p>
<p>å€Ÿç”¨ <a href="http://ipn.li/kernelpanic/13">å†…æ ¸ææ…Œ</a> ä¸­ Rio çš„æè¿°ï¼š</p>
<blockquote>
<p>å¹¶å‘å’Œå¹¶è¡Œæ˜¯ä¸€ç§è®¡ç®—æ¨¡å‹ï¼Œä½¿å¾—è®¡ç®—æœºèƒ½å¤Ÿåœ¨åŒä¸€æ—¶é—´å¤„ç†å¤šä¸ªä»»åŠ¡ï¼›</p>
<p>å¹¶å‘è¡¨ç¤ºé€»è¾‘æ¦‚å¿µä¸Šçš„åŒæ—¶ï¼Œå¹¶è¡Œè¡¨ç¤ºç‰©ç†æ¦‚å¿µä¸Šçš„åŒæ—¶ã€‚</p>
</blockquote>
<p>ç®€å•æ¥è¯´ï¼Œè‹¥è¯´ä¸¤ä¸ªä»»åŠ¡ A å’Œ B å¹¶å‘æ‰§è¡Œï¼Œåˆ™è¡¨ç¤ºä»»åŠ¡ A å’Œä»»åŠ¡ B åœ¨åŒä¸€æ—¶é—´æ®µé‡Œè¢«æ‰§è¡Œï¼ˆæ›´å¤šçš„å¯èƒ½æ˜¯äºŒè€…äº¤æ›¿æ‰§è¡Œï¼‰ï¼›</p>
<p>è‹¥è¯´ä»»åŠ¡ A å’Œ B å¹¶è¡Œæ‰§è¡Œï¼Œåˆ™è¡¨ç¤ºä»»åŠ¡ A å’Œä»»åŠ¡ B åœ¨åŒæ—¶è¢«æ‰§è¡Œï¼ˆè¿™è¦æ±‚è®¡ç®—æœºæœ‰å¤šä¸ªè¿ç®—å™¨ï¼‰ã€‚</p>
<p>ä¸€å¥è¯æ€»ç»“ï¼šå¹¶è¡Œè¦æ±‚å¹¶å‘ï¼Œä½†å¹¶å‘å¹¶ä¸èƒ½ä¿è¯å¹¶è¡Œã€‚</p>
<p>å…³äºå¹¶å‘å’Œå¹¶è¡Œï¼Œ<a href="https://www.raywenderlich.com/60749/grand-central-dispatch-in-depth-part-1">Grand Central Dispatch In-Depth: Part 1/2</a> ä¸­æœ‰æ›´è¯¦ç»†ç”ŸåŠ¨çš„å›¾æ–‡è§£é‡Šã€‚</p>
<h2 id="dispatch-queues">Dispatch Queues</h2>
<blockquote>
<p>A dispatch queue is an object-like structure that manages the tasks you submit to it. All dispatch queues are first-in, first-out data structures.</p>
</blockquote>
<p>å…³äºä»€ä¹ˆæ˜¯ dispatch queue <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html">è‹¹æœæ–‡æ¡£</a> å·²ç»ç»™å‡ºäº†æ˜ç¡®çš„å®šä¹‰ï¼Œå®ƒæ˜¯<strong>ä»¥ FIFO çš„é¡ºåºæ¥è°ƒåº¦ä»»åŠ¡çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</strong></p>
<p>GCD æä¾›äº†ä¸€äº›å…¬å…±çš„ Dispatch Queueï¼Œä½†æ˜¯ç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€äº› dispatch queueã€‚GCD çš„å‡ºç°æ˜¯ä¸ºäº†æ·¡åŒ–ç”¨æˆ·å¯¹äºçº¿ç¨‹çš„æ“ä½œï¼Œæˆ‘ä»¬ä»…éœ€å…³å¿ƒä»»åŠ¡ä¸ä»»åŠ¡ä¹‹é—´çš„å…³ç³»ï¼Œå®ƒä»¬æ˜¯é¡ºåºæ‰§è¡Œè¿˜æ˜¯å¹¶å‘æ‰§è¡Œã€‚ä¸éœ€è¦å¤ªåœ¨æ„ä»»åŠ¡æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚</p>
<p>iOS å¯¹ dispatch queue åšäº†å½’ç±»ï¼Œåˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>Serial Dispatch Queue</li>
<li>Concurrent Dispatch Queue</li>
<li>Main Dispatch Queue</li>
</ul>
<p>ä¸‹é¢è¿™å¼ å›¾ï¼Œæƒ³å¿…å¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿå§ï¼š</p>
<p><img src="https://www.objc.io/images/issue-2/gcd-queues@2x-82965db9.png" alt="gcd_pool"></p>
<p>å…³äº GCD çš„æ–‡ç« æ¨è <a href="https://www.objc.io/issues/2-concurrency/concurrency-apis-and-pitfalls/?spm=a2c6h.12873639.0.0.ff803537RByKvJ#priority-inversion">objc.io è¿™ç¯‡</a></p>
<h3 id="serial-dispatch-queue">Serial Dispatch Queue</h3>
<blockquote>
<p>Serial queues (also known as <em>private dispatch queues</em>) execute one task at a time in the order in which they are added to the queue. The currently executing task runs on a distinct thread (which can vary from task to task) that is managed by the dispatch queue. Serial queues are often used to synchronize access to a specific resource.</p>
</blockquote>
<p>serial dispatch queue ä¸­çš„ä»»åŠ¡æ˜¯ä¾ç…§ FIFO çš„é¡ºåºæ‰§è¡Œï¼Œå®é™…ä¸Šä¸ºå•çº¿ç¨‹æ‰§è¡Œã€‚å³æ¯æ¬¡ä» queue ä¸­å–å‡ºä¸€ä¸ª task è¿›è¡Œå¤„ç†ï¼›ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºä»»æ„å¤šçš„ serial dispatch queueï¼Œserial dispatch queue å½¼æ­¤ä¹‹é—´æ˜¯å¹¶å‘çš„ï¼›</p>
<p>ä¸²è¡Œé˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•å¦‚ä¸‹ï¼Œä»…éœ€æ³¨æ„å‚æ•°ï¼š<code>DISPATCH_QUEUE_SERIAL</code>ï¼ˆå³<code>NULL</code>ï¼‰å³å¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&#34;com.example.MySerialQueue&#34;</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_SERIAL</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="concurrent-dispatch-queue">Concurrent Dispatch Queue</h3>
<blockquote>
<p>Concurrent queues (also known as a type of <em>global dispatch queue</em>) execute one or more tasks concurrently, but tasks are still started in the order in which they were added to the queue. The currently executing tasks run on distinct threads that are managed by the dispatch queue. The exact number of tasks executing at any given point is variable and depends on system conditions.</p>
</blockquote>
<p>Concurrent Dispatch Queue ä¸€æ¬¡æ€§å¹¶å‘æ‰§è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ª taskï¼›ä½œä¸ºå…¨å±€è°ƒåº¦é˜Ÿåˆ—ï¼ŒGCD æä¾› <code>dispatch_get_global_queue</code> ä»¥è·å–ä¸åŒä¼˜å…ˆçº§çš„å¹¶å‘é˜Ÿåˆ—ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦è‡ªå·±å®šä¹‰ concurrent queueï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&#34;com.example.MyConcurrentQueue&#34;</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_CONCURRENT</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å¹¶å‘é˜Ÿåˆ—ç±»ä¼¼äºå…¶ä»–è¯­è¨€é‡Œçš„çº¿ç¨‹æ± ï¼Œå…¶ç®¡ç†çš„ task å¯èƒ½åœ¨å¤šä¸ªä¸åŒ thread ä¸Šæ‰§è¡Œï¼Œè‡³äº GCD ç®¡ç†å¤šå°‘ä¸ª thread æ˜¯æœªçŸ¥çš„ï¼Œè¿™è¦è§†ç³»ç»Ÿèµ„æºè€Œå®šã€‚</p>
<h3 id="main-dispatch-queue">Main Dispatch Queue</h3>
<blockquote>
<p>The main dispatch queue is a globally available serial queue that executes tasks on the applicationâ€™s main thread.</p>
</blockquote>
<p>main dispatch queue æ˜¯ç‰¹æ®Šçš„ serial dispatch queueï¼Œæ¯•ç«Ÿä¸»çº¿ç¨‹åªæœ‰ä¸€ä¸ªã€‚æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºçš„ä¸»è¦ä»»åŠ¡ ï¼ˆä¾‹å¦‚ UI æ“ä½œï¼‰éƒ½åœ¨ main thread ä¸­å®Œæˆï¼Œè€Œå…¨å±€çš„ main disaptch queue æ‰€è°ƒåº¦çš„ task éƒ½åœ¨ main thread ä¸­è¿è¡Œã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦æ›´æ–° UIï¼Œåˆ™å¿…é¡»åœ¨ main dispatch queue ä¸­å¤„ç†ï¼Œè·å– main dispatch queue ä¹Ÿå¾ˆå®¹æ˜“ï¼Œè°ƒç”¨ <code>dispatch_get_main_queue()</code> å‡½æ•°å³å¯ã€‚</p>
<h2 id="runloop">RunLoop</h2>
<p>åœ¨ iOS ä¸­å¯¹äºå¤šçº¿ç¨‹é—®é¢˜æ˜¯é€ƒä¸å¼€ RunLoop çš„ï¼Œä¸è¿‡ RunLoop ä¸ GCD åŸºæœ¬æ²¡åŠæ¯›é’±å…³ç³»ã€‚</p>
<p>RunLoop ä¸çº¿ç¨‹æ‰æ˜¯ä¸€å¯¹å¥½åŸºå‹ã€‚</p>
<blockquote>
<p>çº¿ç¨‹å’Œ RunLoop ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ Dictionary é‡Œã€‚çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰ RunLoopï¼Œå¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´éƒ½ä¸ä¼šæœ‰ã€‚RunLoop çš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoop çš„é”€æ¯æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ã€‚ä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶ RunLoopï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼‰ã€‚</p>
</blockquote>
<p>å…³äº RunLoop åº”è¯¥æ²¡æœ‰æ¯” <a href="https://blog.ibireme.com/2015/05/18/runloop/">æ·±å…¥ç†è§£RunLoop</a> æ–‡ç« è¯´çš„æ›´æ¸…æ¥šçš„äº†ï¼Œè¦ä¸å°±è‡ªè¡Œçœ‹æºç ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“æ–°å¼€çº¿ç¨‹æ˜¯éœ€è¦å¼€é”€çš„ã€‚å¦‚æœæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå°±å¼€ä¸€æ¬¡çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œæ¯•å°±é‡Šæ”¾äº†ã€‚å½“ä»»åŠ¡ç‰¹åˆ«ç»†ç¢ï¼Œå¹¶ä¸”éå¸¸å¤šæ—¶ï¼Œè¿™ä¸æ–­æ¶ˆè´¹çº¿ç¨‹çš„å¼€é”€ä¼šæ¯”å¤„ç†è¿™äº›ä»»åŠ¡çš„å¼€é”€è¦å¤§å¾—å¤šã€‚RunLoop å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿçš„ï¼Œæœ‰ä»»åŠ¡æ—¶å”¤é†’çº¿ç¨‹ï¼Œæ— ä»»åŠ¡çš„æ—¶å€™ä¼‘çœ ä½†ä¸é€€å‡ºï¼Œå¦‚æ­¤å¾€å¤ã€‚</p>
<p>å› æ­¤ï¼Œæ²¡æœ‰ RunLoop,  çº¿ç¨‹å¯èƒ½ä¼š &ldquo;æ­»&rdquo;;  çº¿ç¨‹ â€œæ­»â€äº†ï¼ŒRunLoop æ‰ä¼šåœæ­¢è¿è¡Œã€‚</p>
<h1 id="dispatch-queues-çš„ä»»åŠ¡è°ƒåº¦">Dispatch Queues çš„ä»»åŠ¡è°ƒåº¦</h1>
<p>åœ¨ GCD ä¸­ï¼Œ<code>dispatch_sync</code> ç”¨äºæ´¾å‘åŒæ­¥ä»»åŠ¡ï¼Œ<code>dispatch_async</code> ç”¨äºæ´¾å‘å¼‚æ­¥ä»»åŠ¡ã€‚</p>
<h2 id="dispatch_sync">dispatch_sync</h2>
<p>å…ˆæ¥ä¸€æ®µä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// dispatch task synchronously
</span><span class="c1"></span><span class="n">dispatch_sync</span><span class="p">(</span><span class="n">someQueue1</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    <span class="c1">// do something 1
</span><span class="c1"></span><span class="p">});</span>
<span class="c1">// do something 2
</span></code></pre></td></tr></table>
</div>
</div><p>å½“æ‰§è¡Œåˆ°  <code>dispatch_sync(...)</code> æ—¶ï¼Œå…¶ä¸Šä¸‹æ–‡è¢«é˜»å¡ï¼Œç›´åˆ° <code>dispatch_sync</code> æ´¾å‘çš„ block è¢«æ‰§è¡Œå®Œæ¯•ã€‚</p>
<p>æ­£å¦‚ä¸Šé¢ä»£ç ï¼Œ<code>do something 2</code> ä¸€å®šä¼šåœ¨ <code>do something 1</code> å®Œæˆä¹‹åæ‰§è¡Œï¼Œå³æ‰€è°“çš„<strong>åŒæ­¥</strong>ã€‚</p>
<p>ä¾æ® <a href="https://developer.apple.com/documentation/dispatch/1452870-dispatch_sync">å®˜æ–¹æè¿°</a>ï¼š</p>
<blockquote>
<p>Submits a block to the specified dispatch queue for synchronous execution. Unlike <a href="https://developer.apple.com/documentation/dispatch/1453057-dispatch_async"><code>dispatch_async</code></a>, this function does not return until the block has finished. Calling this function and targeting the current queue results in deadlock.</p>
<p>Unlike with <code>dispatch_async</code>, no retain is performed on the target queue. Because calls to this function are synchronous, it &ldquo;borrows&rdquo; the reference of the caller. Moreover, no <code>Block_copy</code> is performed on the block.</p>
<p>As a performance optimization, this function executes blocks on the current thread whenever possible, with one obvious exception. Specifically, blocks submitted to the main dispatch queue always run on the main thread.</p>
</blockquote>
<p>ç”±äºæ˜¯åŒæ­¥ç­‰å¾…ä»»åŠ¡ï¼Œ<code>dispatch_sync</code> å¹¶ä¸ä¼šå¯¹æ´¾å‘çš„ block è¿›è¡Œ copy æ“ä½œï¼Œblock å†…å¦‚æœæœ‰ä½¿ç”¨å¤–éƒ¨å˜é‡ä¹Ÿéƒ½ä¼šç›´æ¥ <strong>å€Ÿç”¨</strong> å¤–éƒ¨çš„ï¼Œè€Œä¸ä¼šå¯¹å…¶å¼•ç”¨è¿›è¡Œ retainã€‚</p>
<p>ä»¥æ€§èƒ½ä¼˜åŒ–çš„è§’åº¦ï¼Œ<code>dispatch_sync</code> æ´¾å‘çš„ block ä¼šå°½é‡åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä¸»é˜Ÿåˆ—ä¸­æ´¾å‘äº† blockï¼Œé‚£ block å°†ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</p>
<p>ç»“è®º 1ï¼š<strong>dispatch_sync æ´¾å‘çš„ block æ‰€æ‰§çš„è¡Œçº¿ç¨‹ä¸ dispatch_sync ä¸Šä¸‹æ–‡çº¿ç¨‹æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</strong></p>
<p>ç»“è®º 2ï¼š<strong>dispatch_sync æ˜¯ä¸éœ€è¦æ‹·è´ block çš„ï¼Œç†ç”±ä¸ºç»“è®º 1</strong></p>
<h2 id="dispatch_async">dispatch_async</h2>
<p>å…ˆæ¥ä¸€æ®µä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">// dispatch task asynchronously
</span><span class="c1"></span><span class="n">dispatch_async</span><span class="p">(</span><span class="n">someQueue2</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    <span class="c1">// do something 3
</span><span class="c1"></span><span class="p">});</span>
<span class="c1">// do something 4
</span></code></pre></td></tr></table>
</div>
</div><p>å½“æ‰§è¡Œåˆ° <code>dispatch_async(...)</code> æ—¶ï¼Œå…¶ä¸Šä¸‹æ–‡ä¸è¢«é˜»å¡ï¼Œç»§ç»­è¿è¡Œã€‚æ­£å¦‚ä¸Šé¢çš„ä»£ç ï¼Œ <code>do something 4</code> ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œä¸ä¼šç­‰åˆ° <code>do something 3</code> æ‰§è¡Œå®Œï¼Œå³æ‰€è°“<strong>å¼‚æ­¥</strong>ã€‚</p>
<p>ä¾æ® <a href="https://developer.apple.com/documentation/dispatch/1453057-dispatch_async">å®˜æ–¹æè¿°</a>ï¼š</p>
<blockquote>
<p>This function is the fundamental mechanism for submitting blocks to a dispatch queue. Calls to this function always return immediately after the block has been submitted and never wait for the block to be invoked. The target queue determines whether the block is invoked serially or concurrently with respect to other blocks submitted to that same queue. Independent serial queues are processed concurrently with respect to each other.</p>
</blockquote>
<p>ç»“è®º 3ï¼š<strong>dispatch_async æ´¾å‘çš„ block æ‰€æ‰§è¡Œçš„çº¿ç¨‹å’Œ dispatch_async ä¸Šä¸‹æ–‡çº¿ç¨‹ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</strong>ã€‚</p>
<h2 id="queues--dispatch">Queues &amp; Dispatch</h2>
<p>é˜Ÿåˆ—ä¸æ´¾å‘çš„ç»„åˆå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>dispatch_sync</th>
<th>dispatch_async</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>serial queue</strong></td>
<td>åŒæ­¥ä¸²è¡Œé˜Ÿåˆ—</td>
<td>å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—</td>
</tr>
<tr>
<td><strong>concurrent queue</strong></td>
<td>åŒæ­¥å¹¶å‘é˜Ÿåˆ—</td>
<td>å¼‚æ­¥å¹¶å‘é˜Ÿåˆ—</td>
</tr>
</tbody>
</table>
<h3 id="serial-queues-dispatch">Serial Queues Dispatch</h3>
<p>æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// 1. create a serial dispatch queue
</span><span class="c1"></span><span class="n">dispatch_queue_t</span> <span class="n">serial_queue</span><span class="o">=</span>
<span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&#34;com.zhangbuhuai.test&#34;</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_SERIAL</span><span class="p">);</span>	<span class="c1">// Thread main
</span><span class="c1"></span>
<span class="c1">// 2. add tasks to serial dispatch queue
</span><span class="c1">// 1) add a task synchronously
</span><span class="c1"></span><span class="n">dispatch_sync</span><span class="p">(</span><span class="n">serial_queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
   <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>	<span class="c1">// ä¼‘çœ 3ç§’
</span><span class="c1"></span>   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;task 1 %@&#34;</span><span class="p">,</span> <span class="n">NSThread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// 2) add a task synchronously too
</span><span class="c1"></span><span class="n">dispatch_sync</span><span class="p">(</span><span class="n">serial_queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;task 2 %@&#34;</span><span class="p">,</span> <span class="n">NSThread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// 3) add a task asynchronously
</span><span class="c1"></span><span class="n">dispatch_async</span><span class="p">(</span><span class="n">serial_queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;task 3 %@&#34;</span><span class="p">,</span> <span class="n">NSThread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// 4) add a task asynchronously too
</span><span class="c1"></span><span class="n">dispatch_async</span><span class="p">(</span><span class="n">serial_queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
   <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;task 4 %@&#34;</span><span class="p">,</span> <span class="n">NSThread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;test end&#34;</span><span class="p">);</span>         <span class="c1">// Thread main
</span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">task <span class="m">1</span> &lt;NSThread: 0x600002d04d00&gt;<span class="o">{</span><span class="nv">number</span> <span class="o">=</span> 1, <span class="nv">name</span> <span class="o">=</span> main<span class="o">}</span>
task <span class="m">2</span> &lt;NSThread: 0x600002d04d00&gt;<span class="o">{</span><span class="nv">number</span> <span class="o">=</span> 1, <span class="nv">name</span> <span class="o">=</span> main<span class="o">}</span>
<span class="nb">test</span> end
task <span class="m">3</span> &lt;NSThread: 0x600002d452c0&gt;<span class="o">{</span><span class="nv">number</span> <span class="o">=</span> 4, <span class="nv">name</span> <span class="o">=</span> <span class="o">(</span>null<span class="o">)}</span>
task <span class="m">4</span> &lt;NSThread: 0x600002d452c0&gt;<span class="o">{</span><span class="nv">number</span> <span class="o">=</span> 4, <span class="nv">name</span> <span class="o">=</span> <span class="o">(</span>null<span class="o">)}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¯´æ˜ï¼Œå¯¹äº serial dispatch queue ä¸­çš„ tasksï¼Œæ— è®ºæ˜¯åŒæ­¥æ´¾å‘è¿˜æ˜¯å¼‚æ­¥æ´¾å‘ï¼Œå…¶æ‰§è¡Œé¡ºåºéƒ½éµå¾ª FIFOï¼›åŒæ ·ï¼Œè¿™ä¸ªç¤ºä¾‹ä¹Ÿå¯ä»¥ç›´è§‚é˜è¿° <code>dispatch_sync</code> å’Œ <code>dispatch_async</code> çš„ä¸åŒæ•ˆæœã€‚</p>
<p>ç»“è®º 4ï¼š<strong>ä¸å­˜åœ¨æ‰€è°“çš„ åŒæ­¥é˜Ÿåˆ— å’Œ å¼‚æ­¥é˜Ÿåˆ—</strong></p>
<p>åŒæ­¥æˆ–å¼‚æ­¥æè¿°çš„æ˜¯ task ä¸å…¶ä¸Šä¸‹æ–‡ä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤ï¼Œ<em>åŒæ­¥é˜Ÿåˆ—</em> å’Œ <em>å¼‚æ­¥é˜Ÿåˆ—</em> å¯¹äº GCD è€Œè¨€æ˜¯ä¸é è°±çš„æ¦‚å¿µã€‚</p>
<p>ç»“è®º 5ï¼š<strong>Serial Dispatch Queue ä¸Šçš„ tasks å¹¶éåªåœ¨åŒä¸€ä¸ª thread ä¸Šæ‰§è¡Œ</strong></p>
<p>å¯¹äºåŒæ­¥è¯·æ±‚çš„ä»»åŠ¡ï¼Œå¦‚æœç”¨ <code>dispatch_sync</code> æ·»åŠ åˆ° serial dispatch queue ä¸­ï¼Œå…¶è¿è¡Œçš„ task å¾€å¾€ä¸æ‰€åœ¨çš„ä¸Šä¸‹æ–‡æ˜¯åŒä¸€ä¸ª threadï¼›</p>
<p>å¯¹äºå¼‚æ­¥è¯·æ±‚çš„ä»»åŠ¡ï¼Œå¦‚æœç”¨ <code>dispatch_async</code> æ·»åŠ åˆ° serial dispatch queue ä¸­ï¼Œå…¶è¿è¡Œçš„ task å¾€å¾€æ˜¯å¦ä¸€ä¸ªçš„ threadã€‚</p>
<p>æ€»ä¹‹ï¼Œthread å’Œ dispatch queue ä¹‹é—´æ²¡æœ‰ä»å±å…³ç³»ï¼Œä¹Ÿä¸å­˜åœ¨ä¸€å¯¹ä¸€æˆ–è€…ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</p>
<h3 id="concurrent-queue-dispatch">Concurrent Queue Dispatch</h3>
<p>å†æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">// 1. create a concurrent dispatch queue
</span><span class="c1"></span><span class="n">dispatch_queue_t</span> <span class="n">serial_queue</span><span class="o">=</span>
<span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&#34;com.zhangbuhuai.test&#34;</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_CONCURRENT</span><span class="p">);</span>    <span class="c1">// Thread main
</span><span class="c1"></span>
<span class="c1">// 2. add tasks to concurrent dispatch queue
</span><span class="c1">// ç¬¬äºŒæ­¥é€»è¾‘ä¸ä¸²è¡Œé˜Ÿåˆ—ä¸€è‡´ï¼Œæ­¤å¤„ä¸ä½œå±•å¼€ 
</span><span class="c1">// ... 
</span></code></pre></td></tr></table>
</div>
</div><p>å…¶æ‰§è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">task 1 &lt;NSThread: 0x600000ff8d00&gt;{number = 1, name = main}
task 2 &lt;NSThread: 0x600000ff8d00&gt;{number = 1, name = main}
test end
task 4 &lt;NSThread: 0x600000ff8c40&gt;{number = 5, name = (null)}
task 3 &lt;NSThread: 0x600000ff2700&gt;{number = 4, name = (null)}
</code></pre></td></tr></table>
</div>
</div><p>è¯´æ˜ï¼Œå¯¹äº <code>dispatch_sync</code> ä¸­çš„ tasksï¼Œä¸è®ºæ˜¯åœ¨ CONCURRENT æˆ–æ˜¯ SERIAL é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼ŒåŒæ­¥æ´¾å‘çš„ block æ‰€æ‰§çš„è¡Œçº¿ç¨‹ä¸ å…¶ä¸Šä¸‹æ–‡çº¿ç¨‹æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼›åŒæ­¥æ´¾å‘çš„æ‰§è¡Œé¡ºåºéµå¾ª FIFOï¼›è€Œå¼‚æ­¥æ´¾å‘çš„æ‰§è¡Œé¡ºåºå°±ä¸ä¸€å®šäº†ï¼›</p>
<h1 id="ä½¿ç”¨åŒæ­¥ä¸²è¡Œé˜Ÿåˆ—ä¿æŠ¤ä»£ç ">ä½¿ç”¨åŒæ­¥ä¸²è¡Œé˜Ÿåˆ—ä¿æŠ¤ä»£ç </h1>
<p>æœ€åï¼Œè®©æˆ‘ä»¬å›åˆ°å¼•å­ä¸­æåˆ°çš„ <code>FMDatabaseQueue</code> çš„å†…éƒ¨å®ç°ã€‚å®ƒé€šè¿‡å†…éƒ¨ç»´æŠ¤çš„ <code>serial dispatch queue</code> + <code>dispatch_sync</code> æ¥å¤„ç† <code>inDatabase:</code> ä¼ å…¥çš„ blockï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ƒç”¨ <code>inDatabase:</code> æ—¶ï¼Œä»£ç å®é™…ä¸Šæ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚</p>
<blockquote>
<p>FMDatabaseQueue will run the blocks on a serialized queue (hence the name of the class).  So if you call FMDatabaseQueue &lsquo;s methods from multiple threads at the same time, they will be executed in the order they are received.  This way queries and updates won&rsquo;t step on each other&rsquo;s toes, and every one is happy.</p>
</blockquote>
<p>FMDB è¿™ä¹ˆè®¾è®¡çš„ç›®çš„æ˜¯è®©æˆ‘ä»¬é¿å…å‘ç”Ÿå¹¶å‘è®¿é—®æ•°æ®åº“çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒæ— æ³•ä¿è¯ç”¨æˆ·è®¿é—®æ•°æ®åº“çš„æ—¶æœºã€‚é€šè¿‡å†…ç½®çš„åŒæ­¥ä¸²è¡Œé˜Ÿåˆ—åï¼Œ<code>FMDatabaseQueue</code> å°±å˜æˆçº¿ç¨‹å®‰å…¨äº†ï¼Œæ‰€æœ‰çš„æ•°æ®åº“è®¿é—®éƒ½æ˜¯åŒæ­¥æ‰§è¡Œï¼Œè€Œä¸”è¿™æ¯”ä½¿ç”¨ @synchronized æˆ– NSLock è¦é«˜æ•ˆå¾—å¤šã€‚</p>
<p>ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ FMDB è¿™ä¹ˆåšäº†ä¹‹åï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>FMDatabaseQueue</code> æ—¶å€™å°±å¾—å°å¿ƒäº†ã€‚</p>
<h3 id="ä¸èƒ½åµŒå¥—è°ƒç”¨-fmdatabasequeue-å¦åˆ™çº¿ç¨‹æ­»é”">ä¸èƒ½åµŒå¥—è°ƒç”¨ FMDatabaseQueue å¦åˆ™çº¿ç¨‹æ­»é”</h3>
<p>å‚è§å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">[</span><span class="n">queue</span> <span class="nl">inDatabase</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">db</span> <span class="nl">executeUpdate</span><span class="p">:...</span>

    <span class="p">[</span><span class="n">queue</span> <span class="nl">inDatabase</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">FMDatabase</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">db</span> <span class="nl">executeUpdate</span><span class="p">:...</span>
    <span class="p">}];</span> 
<span class="p">}];</span>
</code></pre></td></tr></table>
</div>
</div><p>ç”±äºæ˜¯åŒæ­¥ä¸²è¡Œé˜Ÿåˆ—ï¼ŒåµŒå¥—è°ƒç”¨ä¼šå¯¼è‡´äº’ç›¸ç­‰å¾…ï¼Œé€ æˆæ­»é”ã€‚è¿™ä¸ªä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´åˆ°çš„å°‘ç”¨ <code>dispatch_sync</code> çš„ä¸»è¦åŸå› ã€‚</p>
<p>ä¸ªäººçœ‹æ³•ï¼š<strong>å­˜åœ¨å³åˆç†</strong>ï¼Œçœ‹ä¼¼å®‰å…¨çš„æ–¹æ³•ä½¿ç”¨ä¸å½“ä¹Ÿå¯èƒ½é€ æˆä¸¥é‡å¼‚å¸¸ã€‚åä¹‹ï¼Œåœ¨åˆç†çš„åœºæ™¯ä¸‹ä½¿ç”¨åˆé€‚çš„æ–¹æ³•ï¼Œå¦‚ï¼š <code>dispatch_sync</code> åè€Œæœ‰ä¸é”™çš„æ•ˆæœï¼Œä¸èƒ½å› å™åºŸé£Ÿã€‚</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">åœŸåœŸEdmondæœ¨</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2020-06-16
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ios/">iOS&#39;</a>
          <a href="/tags//">ğŸ“’</a>
          <a href="/tags/gcd/">GCD</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/tool/cocoa-documentation-2/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Cocoa æ–‡æ¡£æ³¨é‡Šä¸ç”Ÿæˆå·¥å…·ä½¿ç”¨ - Jazzy &#43; SourceKitten</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/post/tool/cocoa-documentation-1/">
            <span class="next-text nav-default">Cocoa æ–‡æ¡£æ³¨é‡Šä¸ç”Ÿæˆ</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:chun574271939@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/looseyi" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/looseyi" class="iconfont icon-github" title="github"></a>
      <a href="https://www.weibo.com/foreverclp" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/tu-tu-edmondmu" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="http://looseyi.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019-12-11 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">åœŸåœŸEdmondæœ¨</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
