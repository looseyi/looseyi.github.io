<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>æµ…æ - å¾®ä¿¡ MMKV 1.1.1 - Aha Edmond</title>

  
  
  <meta name="description" content="ä»‹ç» MMKV is an efficient, small, easy-to-use mobile key-value storage framework used in the WeChat application. It&rsquo;s currently available on Android, iOS/macOS, Win32 and POSIX. ä½œä¸ºä¸€ä¸ªç²¾ç®€æ˜“ç”¨ä¸”æ€§èƒ½å¼ºæ‚çš„å…¨å¹³å° K-V å­˜å‚¨æ¡†æ¶ï¼ŒMMKV æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š é«˜æ•ˆï¼š åˆ©ç”¨ mmap ç›´æ¥å°†æ–‡ä»¶" />
  <meta name="author" content="åœŸåœŸEdmondæœ¨" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-ios/source-code-mmkv/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="æµ…æ - å¾®ä¿¡ MMKV 1.1.1" />
<meta property="og:description" content="ä»‹ç» MMKV is an efficient, small, easy-to-use mobile key-value storage framework used in the WeChat application. It&rsquo;s currently available on Android, iOS/macOS, Win32 and POSIX. ä½œä¸ºä¸€ä¸ªç²¾ç®€æ˜“ç”¨ä¸”æ€§èƒ½å¼ºæ‚çš„å…¨å¹³å° K-V å­˜å‚¨æ¡†æ¶ï¼ŒMMKV æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š é«˜æ•ˆï¼š åˆ©ç”¨ mmap ç›´æ¥å°†æ–‡ä»¶" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-ios/source-code-mmkv/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-21T00:00:00&#43;08:00" />
<meta property="article:modified_time" content="2020-05-21T00:00:00&#43;08:00" />


  
  <meta itemprop="name" content="æµ…æ - å¾®ä¿¡ MMKV 1.1.1">
<meta itemprop="description" content="ä»‹ç» MMKV is an efficient, small, easy-to-use mobile key-value storage framework used in the WeChat application. It&rsquo;s currently available on Android, iOS/macOS, Win32 and POSIX. ä½œä¸ºä¸€ä¸ªç²¾ç®€æ˜“ç”¨ä¸”æ€§èƒ½å¼ºæ‚çš„å…¨å¹³å° K-V å­˜å‚¨æ¡†æ¶ï¼ŒMMKV æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š é«˜æ•ˆï¼š åˆ©ç”¨ mmap ç›´æ¥å°†æ–‡ä»¶"><meta itemprop="datePublished" content="2020-05-21T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-05-21T00:00:00&#43;08:00" />
<meta itemprop="wordCount" content="12168">
<meta itemprop="keywords" content="Source Code,iOS,Cache," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æµ…æ - å¾®ä¿¡ MMKV 1.1.1"/>
<meta name="twitter:description" content="ä»‹ç» MMKV is an efficient, small, easy-to-use mobile key-value storage framework used in the WeChat application. It&rsquo;s currently available on Android, iOS/macOS, Win32 and POSIX. ä½œä¸ºä¸€ä¸ªç²¾ç®€æ˜“ç”¨ä¸”æ€§èƒ½å¼ºæ‚çš„å…¨å¹³å° K-V å­˜å‚¨æ¡†æ¶ï¼ŒMMKV æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š é«˜æ•ˆï¼š åˆ©ç”¨ mmap ç›´æ¥å°†æ–‡ä»¶"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2020-05-21</time>
      
      <span>åœŸåœŸEdmondæœ¨</span>
      
    </p>
    <h1>æµ…æ - å¾®ä¿¡ MMKV 1.1.1</h1>
  </header>
  <section class="post-content"><h1 id="ä»‹ç»">ä»‹ç»</h1>
<blockquote>
<p>MMKV is an <strong>efficient</strong>, <strong>small</strong>, <strong>easy-to-use</strong> mobile key-value storage framework used in the WeChat application. It&rsquo;s currently available on <strong>Android</strong>, <strong>iOS/macOS</strong>, <strong>Win32</strong> and <strong>POSIX</strong>.</p>
</blockquote>
<p>ä½œä¸ºä¸€ä¸ªç²¾ç®€æ˜“ç”¨ä¸”æ€§èƒ½å¼ºæ‚çš„å…¨å¹³å° K-V å­˜å‚¨æ¡†æ¶ï¼Œ<a href="https://github.com/tencent/mmkv">MMKV</a> æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>é«˜æ•ˆ</strong>ï¼š
<ul>
<li>åˆ©ç”¨ mmap ç›´æ¥å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼›</li>
<li>åˆ©ç”¨ protobuf å¯¹é”®å€¼è¿›è¡Œç¼–è§£ç å‹ç¼©ï¼›</li>
<li>å¤šè¿›ç¨‹å¹¶å‘ï¼›</li>
</ul>
</li>
<li><strong>æ˜“ç”¨</strong>ï¼šæ— éœ€æ‰‹åŠ¨ <code>synchronize</code> å’Œé…ç½®ï¼Œå…¨ç¨‹è‡ªåŠ¨åŒæ­¥ï¼›</li>
<li><strong>ç²¾ç®€</strong>.
<ul>
<li><strong>å°‘é‡çš„æ–‡ä»¶</strong>: ä»…åŒ…æ‹¬äº†ç¼–è§£ç å·¥å…·ç±»å’Œ mmap é€»è¾‘ä»£ç ï¼Œæ— å†—ä½™ä¾èµ–ï¼›</li>
<li><strong>äºŒè¿›åˆ¶æ–‡ä»¶ä»…å°äº 30K</strong>: å¦‚ä¸º ipa æ–‡ä»¶åˆ™ä¼šæ›´å°ï¼›</li>
</ul>
</li>
</ul>
<p>å…·ä½“æ€§èƒ½ï¼Œå¾®ä¿¡å›¢é˜Ÿæä¾›äº†ç®€å•çš„ <a href="https://mp.weixin.qq.com/s/cZQ3FQxRJBx4px1woBaasg">benchmark</a>ã€‚æ€»ä¹‹å°±æ˜¯ç§’æ€è‹¹æœçš„ NSUserDefaultsï¼Œæ€§èƒ½å·®å¼‚è¾¾ 100 å¤šå€ã€‚</p>
<p>è¯´æ˜ï¼Œç°åœ¨å¤§å®¶çœ‹åˆ°çš„è¿™ç¯‡æ–‡ç« æ˜¯é‡å†™çš„ 2.0 ç‰ˆæœ¬ã€‚å°±åœ¨å‰ä¸ä¹…ï¼ŒMMKV æ‚„æ‘¸åœ°å‘å¸ƒäº†ä¸»ç‰ˆæœ¬æ›´æ–° <a href="https://github.com/Tencent/MMKV/releases/tag/v1.1.0">v1.1.0</a>ï¼Œè€ŒåŸæœ‰çš„å®ç°å·²é¢ç›®å…¨é ğŸ’”ï¼ŒåŸå› <a href="https://github.com/Tencent/MMKV/releases">è¯¦è§</a>ï¼š</p>
<blockquote>
<p>We refactor the whole MMKV project and unify the cross-platform Core library. From now on, MMKV on iOS/macOS, Android, Win32 all <strong>share the same core logic code</strong>.</p>
</blockquote>
<p>å¦ï¼Œæœ¬ç¯‡æ¶‰åŠå¤§é‡ C++ å®ç°ï¼Œå¦‚æœæè¿°æœ‰è¯¯æœ›åŠæ—¶æŒ‡å‡ºã€‚</p>
<h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h2>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å‡ ä¸ªæ¦‚å¿µï¼Œç†Ÿæ‚‰çš„åŒå­¦å¯ passã€‚</p>
<p><a href="https://www.cnblogs.com/huxiao-tee/p/4660352.html"><strong>mmap</strong></a></p>
<blockquote>
<p>mmapæ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚å®ç°è¿™æ ·çš„æ˜ å°„å…³ç³»åï¼Œè¿›ç¨‹å°±å¯ä»¥é‡‡ç”¨æŒ‡é’ˆçš„æ–¹å¼è¯»å†™æ“ä½œè¿™ä¸€æ®µå†…å­˜ï¼Œè€Œç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”çš„æ–‡ä»¶ç£ç›˜ä¸Šï¼Œå³å®Œæˆäº†å¯¹æ–‡ä»¶çš„æ“ä½œè€Œä¸å¿…å†è°ƒç”¨read,writeç­‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚ç›¸åï¼Œå†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿç›´æ¥åæ˜ ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œå¯ä»¥å®ç°ä¸åŒè¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«ã€‚</p>
</blockquote>
<p>é€šå¸¸ï¼Œæˆ‘ä»¬çš„æ–‡ä»¶è¯»å†™æ“ä½œéœ€è¦é¡µç¼“å­˜ä½œä¸ºå†…æ ¸å’Œåº”ç”¨å±‚çš„ä¸­è½¬ã€‚å› æ­¤ï¼Œä¸€æ¬¡æ–‡ä»¶æ“ä½œéœ€è¦ä¸¤æ¬¡æ•°æ®æ‹·è´ï¼ˆå†…æ ¸åˆ°é¡µç¼“å­˜ï¼Œé¡µç¼“å­˜åˆ°åº”ç”¨å±‚ï¼‰ï¼Œè€Œ mmap å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ•°æ®çš„ç›´æ¥äº¤äº’è€Œçœå»äº†é¡µç¼“å­˜ã€‚å½“ç„¶æœ‰åˆ©ä¹Ÿæœ‰å¼Šï¼Œå¦‚ <a href="https://developer.Apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemAdvancedPT/MappingFilesIntoMemory/MappingFilesIntoMemory.html">è‹¹æœæ–‡æ¡£</a> æ‰€è¿°ï¼Œæƒ³é«˜æ•ˆä½¿ç”¨ mmap éœ€è¦ç¬¦åˆä»¥ä¸‹åœºæ™¯ï¼š</p>
<blockquote>
<ul>
<li>You have a large file whose contents you want to access randomly one or more times.</li>
<li>You have a small file whose contents you want to read into memory all at once and access frequently. This technique is best for files that are no more than a few virtual memory pages in size.</li>
<li>You want to cache specific portions of a file in memory. File mapping eliminates the need to cache the data at all, which leaves more room in the system disk caches for other data.</li>
</ul>
</blockquote>
<p>å› æ­¤ï¼Œå½“æˆ‘ä»¬éœ€è¦é«˜é¢‘ç‡çš„è®¿é—®æŸä¸€è¾ƒå¤§æ–‡ä»¶ä¸­çš„ä¸€å°éƒ¨åˆ†å†…å®¹çš„æ—¶å€™ï¼Œmmap çš„æ•ˆç‡æ˜¯æœ€é«˜çš„ã€‚</p>
<p>å…¶å®ä¸å…‰æ˜¯ MMKV åŒ…æ‹¬å¾®ä¿¡çš„ XLog å’Œ ç¾å›¢çš„ Logan æ—¥å¿—å·¥å…·ï¼Œè¿˜æœ‰ SQLight éƒ½ä½¿ç”¨ mmap æ¥æå‡é«˜é¢‘æ›´æ–°åœºæ™¯ä¸‹çš„æ–‡ä»¶è®¿é—®æ•ˆç‡ã€‚</p>
<p><a href="https://www.wikiwand.com/en/Protocol_Buffers"><strong>Protocol Buffer</strong></a></p>
<blockquote>
<p>Protobuf is a method of <a href="https://www.wikiwand.com/en/Serialization">serializing</a> structured data. It is useful in developing programs to communicate with each other over a wire or for storing data. The method involves an <a href="https://www.wikiwand.com/en/Interface_description_language">interface description language</a> that describes the structure of some data and a program that generates source code from that description for generating or parsing a stream of bytes that represents the structured data.</p>
</blockquote>
<p>Protobuf æ˜¯ä¸€ç§å°†ç»“æ„åŒ–æ•°æ®è¿›è¡Œåºåˆ—åŒ–çš„æ–¹æ³•ã€‚å®ƒæœ€åˆæ˜¯ä¸ºäº†è§£å†³æœåŠ¡å™¨ç«¯æ–°æ—§åè®®ï¼ˆé«˜ä½ç‰ˆæœ¬ï¼‰å…¼å®¹æ€§é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚å› æ­¤ï¼Œç§°ä¸ºâ€œåè®®ç¼“å†²åŒºâ€ï¼Œåªä¸è¿‡åæœŸæ…¢æ…¢å‘å±•æˆç”¨äºä¼ è¾“æ•°æ®å’Œå­˜å‚¨ç­‰ã€‚</p>
<p>MMKV æ­£æ˜¯è€ƒè™‘åˆ°äº† protobuf åœ¨æ€§èƒ½å’Œç©ºé—´ä¸Šçš„ä¸é”™è¡¨ç°ï¼Œä»¥ç®€åŒ–ç‰ˆ protobuf ä½œä¸ºåºåˆ—åŒ–æ–¹æ¡ˆï¼Œè¿˜æ‰©å±•äº† protobuf çš„å¢é‡æ›´æ–°çš„èƒ½åŠ›ï¼Œå°† K-V å¯¹è±¡åºåˆ—åŒ–åï¼Œç›´æ¥ append åˆ°å†…å­˜æœ«å°¾è¿›è¡Œåºåˆ—åŒ–ã€‚</p>
<p>é‚£ Protobuf æ˜¯å¦‚ä½•å®ç°é«˜æ•ˆç¼–ç ï¼Ÿ</p>
<ol>
<li>ä»¥ <code>Tag - Value</code> (Tag - Length - Value)çš„ç¼–ç æ–¹å¼çš„å®ç°ã€‚å‡å°‘äº†åˆ†éš”ç¬¦çš„ä½¿ç”¨ï¼Œæ•°æ®å­˜å‚¨æ›´åŠ ç´§å‡‘ï¼›</li>
<li>åˆ©ç”¨ <code>base 128 varint</code> (å˜é•¿ç¼–ç ï¼‰åŸç†å‹ç¼©æ•°æ®ä»¥åï¼ŒäºŒè¿›åˆ¶æ•°æ®éå¸¸ç´§å‡‘ï¼Œpb ä½“ç§¯æ›´å°ã€‚ä¸è¿‡ pb å¹¶æ²¡æœ‰å‹ç¼©åˆ°æé™ï¼Œfloatã€double æµ®ç‚¹å‹éƒ½æ²¡æœ‰å‹ç¼©ï¼›</li>
<li>ç›¸æ¯”  JSON å’Œ XML å°‘äº† <code>{ã€}ã€:</code> è¿™äº›ç¬¦å·ï¼Œä½“ç§¯ä¹Ÿå‡å°‘ä¸€äº›ã€‚å†åŠ ä¸Š varintã€gzip å‹ç¼©ä»¥åä½“ç§¯æ›´å°ã€‚</li>
</ol>
<p><strong><a href="https://www.wikiwand.com/en/Cyclic_redundancy_check">CRC æ ¡éªŒ</a></strong></p>
<blockquote>
<p>å¾ªç¯å†—ä½™æ ¡éªŒï¼ˆCyclic redundancy checkï¼‰æ˜¯ä¸€ç§æ ¹æ®ç½‘ç»œæ•°æ®åŒ…æˆ–è®¡ç®—æœºæ–‡ä»¶ç­‰æ•°æ®äº§ç”Ÿç®€çŸ­å›ºå®šä½æ•°æ ¡éªŒç çš„ä¸€ç§æ•£åˆ—å‡½æ•°ï¼Œä¸»è¦ç”¨æ¥æ£€æµ‹æˆ–æ ¡éªŒæ•°æ®ä¼ è¾“æˆ–è€…ä¿å­˜åå¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚ç”Ÿæˆçš„æ•°å­—åœ¨ä¼ è¾“æˆ–è€…å­˜å‚¨ä¹‹å‰è®¡ç®—å‡ºæ¥å¹¶ä¸”é™„åŠ åˆ°æ•°æ®åé¢ï¼Œç„¶åæ¥æ”¶æ–¹è¿›è¡Œæ£€éªŒç¡®å®šæ•°æ®æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚</p>
</blockquote>
<p>åŒæ ·æ˜¯ç”¨äºè®¡ç®—æ ¡éªŒå€¼ï¼Œç›¸æ¯” MD5 æˆ–è€… SHA1ï¼ŒCRC çš„è®¡ç®—æ•ˆç‡è¾ƒé«˜ï¼Œå®‰å…¨æ€§è¾ƒå¼±ã€‚è€ƒè™‘åˆ°æ–‡ä»¶ç³»ç»Ÿã€æ“ä½œç³»ç»Ÿéƒ½æœ‰ä¸€å®šçš„ä¸ç¨³å®šæ€§ï¼ŒMMKV å¢åŠ äº† CRC æ ¡éªŒï¼Œå¯¹æ— æ•ˆæ•°æ®è¿›è¡Œç”„åˆ«ã€‚</p>
<p>åœ¨ iOS å¾®ä¿¡ç°ç½‘ç¯å¢ƒä¸Šï¼Œæœ‰å¹³å‡çº¦ 70ä¸‡æ—¥æ¬¡çš„æ•°æ®æ ¡éªŒä¸é€šè¿‡ã€‚</p>
<h1 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h1>
<p>åœ¨ v1.1.0 ç‰ˆæœ¬ Tencent å›¢é˜Ÿé‡å†™äº†æ•´ä¸ª MMVK é¡¹ç›®ï¼Œç»Ÿä¸€è·¨å¹³å°æ ¸å¿ƒåº“ã€‚è‡ªæ­¤ MMKV åœ¨ iOS/macOS, Android, Win32 å…±äº«åŒä¸€ä»½æ ¸å¿ƒé€»è¾‘ã€‚åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†å¯ç»´æŠ¤æ€§ï¼Œä»¥åŠä¼˜åŠ¿å…±äº«ã€‚ä¹Ÿæ­£æ˜¯ç”±äºè¿™ä¸€ç‚¹ï¼Œåœ¨ iOS/macOS ä¸Šå¯ä»¥å®ç° <strong>Multi-Process Access</strong>ã€‚</p>
<p>åœ¨ä»£ç ç»“æ„ä¸Šï¼ŒMMKV ç‹¬ç«‹å‡ºå•ç‹¬çš„ <a href="https://github.com/Tencent/MMKV/blob/master/MMKVCore.podspec">MMVKCore</a>ï¼ŒApple å¹³å°åŸºäº MMKV Core åšäº†ä¸€å±‚ Objc çš„å°è£…ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gehfsnonv8j21fy0w4gqq.jpg" alt="MMVK Core.png"></p>
<p>åŸæœ‰çš„å®ç°åŸºæœ¬éƒ½è¿ç§»åˆ° MMKV Core ä¸­å¹¶æ›¿æ¢æˆäº† C++ å®ç°ã€‚å¯¹ä¸åŒå¹³å°çš„æ‰€ç‹¬æœ‰çš„ API æˆ–é€»è¾‘é€šè¿‡ä¸åŒçš„æ–‡ä»¶åå’Œå®æ¥éš”ç¦»ã€‚ä»¥ MemoryFile ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>MemoryFile.h
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>MemoryFile.cpp
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>MemoryFile_Android.cpp
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>MemoryFile_OSX.cpp
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>MemoryFile_Win32.cpp
</code></pre></div><p>æœ¬ç¯‡æˆ‘ä»¬é‡ç‚¹å…³æ³¨ Apple ç›¸å…³é€»è¾‘ã€‚</p>
<h2 id="class-initialize">Class Initialize</h2>
<p>MMKV åœ¨ä½¿ç”¨å‰çš„å‡†å¤‡å·¥ä½œåˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>åˆå§‹åŒ– <code>g_instanceDic</code> ç­‰é™æ€å˜é‡ã€‚å®ƒåœ¨åº”ç”¨å¯åŠ¨æ—¶çš„ pre_main å‡½æ•°å‰ï¼Œåœ¨ MMKV class çš„  <code>+ initialize</code> é‡Œå®Œæˆçš„ã€‚</li>
<li>éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œ <code>+initializeMMKV</code> æ¥å®Œæˆ <code>g_basePath</code> çš„æŒ‡å®šï¼Œå³ MMKV çš„æ ¹ç›®å½•ã€‚</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>+ (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">initialize</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (<span style="color:#b58900">self</span> <span style="color:#719e07">==</span> MMKV.<span style="color:#719e07">class</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        g_instanceDic <span style="color:#719e07">=</span> [[NSMutableDictionary alloc] init];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        g_lock <span style="color:#719e07">=</span> new mmkv<span style="color:#719e07">::</span>ThreadLock();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        g_lock<span style="color:#719e07">-&gt;</span>initialize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        mmkv<span style="color:#719e07">::</span>MMKV<span style="color:#719e07">::</span>minimalInit([<span style="color:#b58900">self</span> mmkvBasePath].UTF8String);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#586e75">/* æ³¨å†Œå¯åŠ¨é€šçŸ¥ */</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>}
</code></pre></div><p>åœ¨ç±»çš„åˆå§‹åŒ–ä¸­ï¼Œåšäº†å››ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li><code>g_instanceDic</code> ï¼šå…¨å±€ MMKV å®ä¾‹çš„å®¹å™¨ï¼Œkey ç”±å¤šä¸ªå­—æ®µæ··åˆç”Ÿæˆçš„ï¼Œåé¢ä¼šè¯´æ˜ï¼›</li>
<li><code>g_lock</code> : ä¸º <code>g_instanceDic</code> é…äº†æŠŠçº¿ç¨‹é”ï¼›</li>
<li><code>minimalInit</code>ï¼šä»¥ MMKV é»˜è®¤çš„æ ¹ç›®å½• (ï½/Document/mmkv) ï¼Œåˆå§‹åŒ– MMKV Core ä¸­çš„å…¨å±€å˜é‡ï¼›</li>
<li>æ³¨å†Œ App ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„é€šçŸ¥ ï¼ˆä»… iOS åº”ç”¨ä¸»ä½“ï¼‰</li>
</ul>
<p>è¿™é‡Œä¹‹å‰æœ‰ä¸æ˜ç™½ä¹‹å¤„ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œæ²¡æœ‰ä½¿ç”¨  <code>dispatch_once</code> æ¥ä¿è¯ä¸å¯é‡å…¥å‘¢ï¼Ÿ</p>
<p>å½“ç¿»çœ‹è¯¥æ–‡ä»¶çš„ history æ—¶ï¼Œå‘ç°æ—©æœŸç‰ˆæœ¬ç¡®å®ç”¨åˆ°äº† <code>dispatch_once</code> æ¥é¿å…é‡å…¥ã€‚è€Œç°åœ¨æ¢æˆè¿™ç§å†™æ³•éš¾é“æ˜¯</p>
<p>ç”¨äº†ä»€ä¹ˆæ–°ç‰¹æ€§å—ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ <code>+initialize</code> æ˜¯æœ‰å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨çš„ï¼Œä½†æ˜¯å¯¹å…¶å¦‚ä½•è¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¢«è°å¤šæ¬¡è°ƒç”¨ï¼Œè¿™é‡Œç†è§£æœ‰è¯¯ã€‚</p>
<p>ä»¥ MMKV ä¸ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬å£°æ˜ <strong>MMKVTest</strong> ä½œä¸ºå…¶ MMKV çš„å­ç±»ï¼Œä½†æœªå®ç° <code>+initialize</code> æˆ–è€… <strong>MMKVTest</strong> åœ¨å…¶ <code>+initialize</code>  ä¸­æ˜¾å¼çš„è°ƒç”¨ <code>[super initialize]</code> æ–¹æ³•ï¼Œé‚£ä¹ˆ MMKV çš„ <code>+initialize</code> æ‰ä¼šè¢«è°ƒç”¨å¤šæ¬¡ã€‚</p>
<p>ä½†æ˜¯å¿½ç•¥äº†å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œ<code>+initialize</code> æ˜¯ class methodï¼Œå®Œå…¨å¯ä»¥é€šè¿‡åˆ¤æ–­ class ç±»å‹æ¥é¿å…é‡å…¥ã€‚è¿™ä¹Ÿæ˜¯ç¬¬ä¸€è¡Œåˆ¤æ–­ <code>self == MMKV.class</code> çš„é‡è¦æ€§å’Œä½œç”¨ã€‚</p>
<h3 id="minimalinit">MinimalInit</h3>
<blockquote>
<p>protect from some old code that don&rsquo;t call initializeMMKV()</p>
</blockquote>
<p>ä¸ºäº†ç¡®ä¿ç›¸å…³å±æ€§è®¿é—®æ—¶å·²åˆå§‹åŒ–å®Œæˆï¼Œåœ¨ç±»åˆå§‹åŒ–æ—¶éœ€è¦æå‰å¤‡å¥½å…¨å±€å˜é‡ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>minimalInit(MMKVPath_t defaultRootDir) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    ThreadLock<span style="color:#719e07">::</span>ThreadOnce(<span style="color:#719e07">&amp;</span>once_control, initialize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#dc322f">int</span> device <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>, version <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    GetAppleMachineInfo(device, version);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">#    ifdef __aarch64__
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07"></span>    <span style="color:#719e07">if</span> ((device <span style="color:#719e07">==</span> iPhone <span style="color:#719e07">&amp;&amp;</span> version <span style="color:#719e07">&gt;=</span> <span style="color:#2aa198">9</span>) <span style="color:#719e07">||</span> (device <span style="color:#719e07">==</span> iPad <span style="color:#719e07">&amp;&amp;</span> version <span style="color:#719e07">&gt;=</span> <span style="color:#2aa198">7</span>)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        CRC32 <span style="color:#719e07">=</span> mmkv<span style="color:#719e07">::</span>armv8_crc32;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">#    endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    g_rootDir <span style="color:#719e07">=</span> defaultRootDir;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    mkPath(g_rootDir);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>}
</code></pre></div><p>è¯¥æ–¹æ³•ä»¥æœ€ä½é™åº¦æŠŠå¿…é¡»è¦å®Œæˆçš„äº‹æƒ…æ”¾åˆ°äº†åº”ç”¨çš„å¯åŠ¨å‰ï¼Œä¸»è¦ä¸‰ä»¶äº‹ï¼š</p>
<ol>
<li>æ‰§è¡Œ initialize å®Œæˆå…¨å±€å˜é‡çš„ initã€‚</li>
<li>ç¡®å®š CRC æ ¡éªŒçš„ç®—æ³•ï¼›</li>
<li>ç”Ÿæˆ mmkv æ ¹ç›®å½•ï¼›</li>
</ol>
<h3 id="initialize">Initialize</h3>
<p><strong>ThreadLock::ThreadOnce</strong> èƒŒåä»¥ <a href="https://pubs.opengroup.org/onlinepubs/007908799/xsh/pthread_once.html">pthread_once</a> æ¥ä¿è¯å•è¯è°ƒç”¨ï¼Œä»¥å®Œæˆ <code>initialize()</code>ï¼Œæœ€åç”¨ <code>g_rootDir</code> åˆ›å»ºå¯¹åº”çš„æ–‡ä»¶ç›®å½•ã€‚æ¥çœ‹ç§æœ‰çš„ <strong>initialize</strong> æ–¹æ³•åšäº†å•¥ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">void</span> <span style="color:#268bd2">initialize</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    g_instanceDic <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> unordered_map<span style="color:#719e07">&lt;</span>string, MMKV <span style="color:#719e07">*&gt;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    g_instanceLock <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> ThreadLock();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    g_instanceLock<span style="color:#719e07">-&gt;</span>initialize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    mmkv<span style="color:#719e07">::</span>DEFAULT_MMAP_SIZE <span style="color:#719e07">=</span> mmkv<span style="color:#719e07">::</span>getPageSize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>}
</code></pre></div><p>åœ¨ MMKV Core å®ç°ä¸­ä¹Ÿç»´æŠ¤äº† <code>g_instanceDic</code> å’Œ <code>g_instanceLock</code> ã€‚çœ‹åˆ°è¿™ä¸å¤ªç†è§£ï¼Œé‚£åœ¨ iOS / MacOS ç«¯ä¸ºä½•ä»æ—§ä¿ç•™äº†è¿™ä¸¤ ï¼Ÿæ±‚å‘ŠçŸ¥ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">static</span> NSMutableDictionary <span style="color:#719e07">*</span>g_instanceDic <span style="color:#719e07">=</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">static</span> mmkv<span style="color:#719e07">::</span>ThreadLock <span style="color:#719e07">*</span>g_lock;
</code></pre></div><h3 id="crc32">CRC32</h3>
<blockquote>
<p>è¯¥æ–¹æ³•ç”¨äºè·å–æ–‡ä»¶çš„ digest æ ¡éªŒå€¼ã€‚</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">typedef</span> <span style="color:#268bd2">uint32_t</span> (<span style="color:#719e07">*</span>CRC32_Func_t)(<span style="color:#dc322f">uint32_t</span> crc, <span style="color:#719e07">const</span> <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>buf, size_t len);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">extern</span> CRC32_Func_t CRC32;
</code></pre></div><p>è¿™é‡Œçš„ CRC32 å°±æ˜¯æ­£å„¿å…«ç»çš„å‡½æ•°æŒ‡é’ˆï¼Œé»˜è®¤æŒ‡å‘çš„æ˜¯ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">static</span> <span style="color:#268bd2">inline</span> <span style="color:#dc322f">uint32_t</span> <span style="color:#268bd2">_crc32Wrap</span>(<span style="color:#dc322f">uint32_t</span> crc, <span style="color:#719e07">const</span> <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>buf, size_t len) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    <span style="color:#719e07">return</span> <span style="color:#719e07">static_cast</span><span style="color:#719e07">&lt;</span><span style="color:#dc322f">uint32_t</span><span style="color:#719e07">&gt;</span>(<span style="color:#719e07">::</span>crc32(crc, buf, <span style="color:#719e07">static_cast</span><span style="color:#719e07">&lt;</span>uInt<span style="color:#719e07">&gt;</span>(len)));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>}
</code></pre></div><p>ä¸è¿‡è¿™é‡Œä½œè€…åšäº†ä¼˜åŒ–ï¼Œå½“ CPU æ¶æ„ä¸º aarch64ï¼Œåˆ™æ”¹æ¢äº† <code>mmkv::armv8_crc32</code> çš„å®ç°ã€‚ç”±äº crc32 æŒ‡ä»¤éœ€è¦A10èŠ¯ç‰‡ï¼Œä¹Ÿå°±æ˜¯ iPhone 7 æˆ– iPad çš„ç¬¬å…­ä»£ã€‚å› æ­¤ï¼Œè¿™ä¸ªé€šè¿‡ <code>GetAppleMachineInfo</code>  è·å–è®¾å¤‡å’Œç³»ç»Ÿç‰ˆæœ¬æ¥åˆ¤æ–­ã€‚</p>
<p>æœ€åä¸€æ­¥ï¼Œè·å–å†…å­˜é¡µçš„å¤§å°ç”¨äºåç»­æ–‡ä»¶å­˜å–æ—¶è®¡ç®—æ‰€éœ€å†…å­˜ï¼Œå¹¶å­˜å…¥ <code>DEFAULT_MMAP_SIZE</code>ã€‚</p>
<h3 id="æ³¨å†Œé€šçŸ¥">æ³¨å†Œé€šçŸ¥</h3>
<p>MMKV åœ¨ <a href="Core/MMKVPredef.h">Core/MMKVPredef.h</a> å®šä¹‰äº†å„ä¸ªå¹³å°çš„å®ï¼Œè¿™é‡Œåªåœ¨ iOS åº”ç”¨ä¸»ä½“æ³¨å†Œäº† Notificationï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">#if defined(MMKV_IOS) &amp;&amp; !defined(MMKV_IOS_EXTENSION)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07"></span><span style="color:#719e07">if</span> ([[[NSBundle mainBundle] bundlePath] hasSuffix:<span style="color:#2aa198">@&#34;.appex&#34;</span>]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>     g_isRunningInAppExtension <span style="color:#719e07">=</span> <span style="color:#b58900">YES</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>}
</code></pre></div><p>è¿™é‡Œç”±äºæ‹…å¿ƒé—æ¼å¯¹ <code>MMKV_IOS_EXTENSION</code>  çš„åˆ¤æ–­ï¼Œæ•…æ­¤æ·»åŠ äº† g_isRunningInAppExtension é™æ€å˜é‡ï¼›</p>
<p>æ³¨å†Œçš„ä¸¤ä¸ª Notification çš„æ–¹æ³•ä¸ºï¼š<code>didEnterBackground</code> å’Œ <code>didBecomeActive</code>ï¼Œç”¨äºç›‘å¬ <strong>UIApplicationState</strong> åœ¨å‰åå°çš„çŠ¶æ€å˜åŒ–ã€‚åœ¨æ³¨å†Œé€šçŸ¥æ—¶ï¼Œä¹Ÿä¼šè·å–äº†å½“å‰ applicationState å¹¶é€šè¿‡æ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>setIsInBackground(<span style="color:#dc322f">bool</span> isInBackground)
</code></pre></div><p>æ¥æ›´æ–° <code>g_isInBackground</code>ã€‚è¿™ä¹ˆåšæ˜¯ä¸ºäº†ä¿è¯åœ¨åå°æ—¶èƒ½å¤Ÿå®‰å…¨çš„æ‰§è¡Œæ–‡ä»¶å†™å…¥ã€‚</p>
<h3 id="initializemmkv">InitializeMMKV</h3>
<p>çœŸæ­£ä½¿ç”¨å‰è¿˜éœ€è¦æ‰‹åŠ¨è°ƒç”¨ä¸€æ¬¡ <code>+initializeMMKV: logLevel:</code> æˆ–å…¶ç›¸å…³ convene methodã€‚</p>
<p>æ–¹æ³•å†…éƒ¨ä½¿ç”¨ <code>static BOOL g_hasCalledInitializeMMKV</code> æ¥é˜²æ­¢è¢«å¤šæ¬¡è°ƒç”¨:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> (g_hasCalledInitializeMMKV) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    MMKVWarning(<span style="color:#2aa198">&#34;already called +initializeMMKV before, ignore this request&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">return</span> [self mmkvBasePath];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>g_hasCalledInitializeMMKV <span style="color:#719e07">=</span> YES;
</code></pre></div><p><code>initializeMMKV:</code> ç¬¬ä¸€ä¸ªå‚æ•°ä¸º rootDir ç”¨äºæ›´æ–° <code>g_basePath</code>ï¼Œä¸ºç©ºçš„è¯å°±ç”¨é»˜è®¤å€¼ã€‚æ¥ç€ä¼ å…¥ logLevelï¼Œæ‰§è¡Œ MMKV Core æä¾›çš„åˆå§‹åŒ–æ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>initializeMMKV(<span style="color:#719e07">const</span> MMKVPath_t <span style="color:#719e07">&amp;</span>rootDir, MMKVLogLevel logLevel) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    g_currentLogLevel <span style="color:#719e07">=</span> logLevel;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    ThreadLock<span style="color:#719e07">::</span>ThreadOnce(<span style="color:#719e07">&amp;</span>once_control, initialize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    g_rootDir <span style="color:#719e07">=</span> rootDir;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    mkPath(g_rootDir);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>}
</code></pre></div><p>è¿™é‡ŒåŒæ ·ä¹Ÿè°ƒç”¨äº† <code>ThreadLock::ThreadOnce</code> ä¿è¯ MMKV Core èƒ½å¤ŸæˆåŠŸåˆå§‹åŒ–ã€‚</p>
<p>åœ¨ 1.1 ç‰ˆæœ¬ä¸­ï¼Œç”±äºåº•å±‚å®ç°çš„ç»Ÿä¸€ï¼ŒiOS ç«¯å¯ä»¥æ”¯æŒå¤šè¿›ç¨‹è°ƒç”¨ï¼Œè¿™é‡Œå¤šå‡ºæ¥ä¸€ä¸ªæ§åˆ¶å‚æ•°ï¼Œå¯¹åº”çš„æ–¹æ³•ä¸ºï¼š</p>
<p><code>+initializeMMKV: groupDir: logLevel:</code>ã€‚å†…éƒ¨ä¹Ÿæ˜¯èµ°ä¸Šé¢çš„æ–¹æ³•ï¼Œä¸è¿‡å¤šå‡ºæ¥ä¸€ä¸ªå…¨å±€å˜é‡ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>g_groupPath <span style="color:#719e07">=</span> [groupDir stringByAppendingPathComponent:<span style="color:#2aa198">@&#34;mmkv&#34;</span>];
</code></pre></div><h2 id="instance-initialize">Instance Initialize</h2>
<h3 id="mmkvwithid">mmkvWithID</h3>
<p>è·å–å®ä¾‹ MMKV åŒæ ·æä¾›äº†å¤šä¸ª convince methodï¼Œæœ€ç»ˆæ”¶å£çš„ç§æœ‰ç±»æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>+ (<span style="color:#dc322f">instancetype</span>)<span style="color:#268bd2">mmkvWithID:</span>(NSString <span style="color:#719e07">*</span>)<span style="color:#268bd2">mmapID</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>                  <span style="color:#268bd2">cryptKey:</span>(NSData <span style="color:#719e07">*</span>)<span style="color:#268bd2">cryptKey</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>              <span style="color:#268bd2">relativePath:</span>(nullable NSString <span style="color:#719e07">*</span>)<span style="color:#268bd2">relativePath</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>                      <span style="color:#268bd2">mode:</span>(MMKVMode)<span style="color:#268bd2">mode</span>
</code></pre></div><p>æ³¨æ„ï¼Œæ­£å¼å› ä¸º relativePath å’Œ mode æ˜¯äº’æ–¥çš„ï¼Œä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œè¿™æ‰ä½œä¸ºç§æœ‰æ–¹æ³•ã€‚é‚£å°±ä¸€æ¢ç©¶ç«Ÿå§ã€‚</p>
<p>é¦–å…ˆï¼Œä¼šæ£€æŸ¥ <code>g_hasCalledInitializeMMKV</code> æ˜¯å¦æ‰§è¡Œè¿‡ <code>+initializeMMKV:</code> ä»¥åŠ mmapID æ˜¯å¦æœ‰æ•ˆã€‚</p>
<p>ä¸Šé” <code>SCOPED_LOCK(g_lock)</code>ä¹‹åï¼Œæ¥ç€å°±æ˜¯å¤„ç† relativePath å’Œ mode çš„é—®é¢˜äº†ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> (mode <span style="color:#719e07">==</span> MMKVMultiProcess) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>relativePath) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>        relativePath <span style="color:#719e07">=</span> g_groupPath;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>relativePath) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>        MMKVError(<span style="color:#2aa198">&#34;Getting a multi-process MMKV [%@] without setting groupDir makes no sense&#34;</span>, mmapID);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>        MMKV_ASSERT(<span style="color:#2aa198">0</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>}
</code></pre></div><p><code>g_groupPath</code> æœ¬èº«æ˜¯æœåŠ¡äº multi-process çš„ï¼Œå¯¹äºå•è¿›ç¨‹è€Œè¨€ <code>g_groupPath</code> å€¼è‡ªç„¶ä¸º nilï¼Œä¹Ÿå°±ä¸ä¼šæœ‰å†²çªä¸€è¯´ã€‚ä¸Šè¿°é€»è¾‘åšçš„äº‹æƒ…ä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼Œå°±æ˜¯åœ¨ multi-process ä¸‹ï¼Œä¼šå°† relativePath  è¦†ç›–ï¼Œå¹¶ä¿è¯èµ·ä¸èƒ½ä¸ºç©ºã€‚</p>
<p>è‡³äºä¸ºä½•ä¸èƒ½ä¸ºç©ºï¼ŸMMKVError ä¸­å·²ç»åšäº†å¾ˆæ˜ç¡®çš„è¯´æ˜äº†ã€‚</p>
<p>åˆå§‹åŒ– MMKV å®ä¾‹</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>NSString <span style="color:#719e07">*</span>kvKey <span style="color:#719e07">=</span> [MMKV mmapKeyWithMMapID:mmapID relativePath:relativePath];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>MMKV <span style="color:#719e07">*</span>kv <span style="color:#719e07">=</span> [g_instanceDic objectForKey:kvKey];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">if</span> (kv <span style="color:#719e07">==</span> <span style="color:#b58900">nil</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    kv <span style="color:#719e07">=</span> [[MMKV alloc] initWithMMapID:mmapID cryptKey:cryptKey relativePath:relativePath mode:mode];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>kv<span style="color:#719e07">-&gt;</span>m_mmkv) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    kv<span style="color:#719e07">-&gt;</span>m_mmapKey <span style="color:#719e07">=</span> kvKey;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    [g_instanceDic setObject:kv forKey:kvKey];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>}
</code></pre></div><p>é¦–å…ˆï¼Œé€šè¿‡ mmapID å’Œ relativePath æ¥ç”Ÿæˆ kvKeyï¼Œç”¨äºå…³è”ç”Ÿæˆçš„ mmkv å®ä¾‹ï¼Œæœ€ç»ˆå­˜å‚¨åœ¨ <code>g_instanceDic</code> ä¸­ã€‚å¦‚æœ relativePath ä¸ºæœ‰æ•ˆå­—ç¬¦ä¸²ï¼Œkey å€¼ä¸º relativePath å’Œ mmapID æ‹¼æ¥åçš„çš„ md5 å€¼ã€‚</p>
<p>æ¥ç€ï¼Œå°è¯•é€šè¿‡ key æ¥è·å–å®ä¾‹ã€‚æ²¡æœ‰çš„è¯å°±éœ€è¦è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶å°† mmkv å®ä¾‹ä¿å­˜åˆ° <code>g_instanceDic</code>ã€‚</p>
<p>è¿™é‡Œæ¯ä¸ªå®ä¾‹æœ¬èº«ä¹Ÿä¼šå°† key ä¿å­˜åœ¨ <code>m_mmapKey</code> ä¸­ï¼Œä»¥å¾…å…¶ç»“æŸæ—¶ï¼Œå°†è‡ªèº«ä» <code>g_instanceDic</code> ä¸­ç§»é™¤ã€‚</p>
<h3 id="initwithmmapid">initWithMMapID</h3>
<p>é€šè¿‡ MMKV Core çš„ <code>mmkv::MMKV::mmkvWithID</code> æ–¹æ³•æ¥è·å– m_mmkv å®ä¾‹ã€‚å‚æ•°å°±æ˜¯å°† mmapIDã€cryptKeyã€relativePath è½¬ä¸º c string ä¼ å…¥ã€‚</p>
<p>åŒç±»çš„åˆå§‹åŒ–ä¸€æ ·ï¼ŒMMKV Core æ„é€ å‡½æ•°çš„å®ç°ä¸ iOS ä¾§æ— å¼‚ï¼Œåªæ˜¯ç”¨ C++ çš„æ–¹å¼å†åšäº†ä¸€éã€‚è¿™é‡Œé™¤äº†å¯¹ variable è¿›è¡Œé»˜è®¤å€¼çš„èµ‹å€¼ä¹‹å¤–ï¼Œæœ€ç»ˆè°ƒç”¨ <code>loadFromFile()</code> æ¥åŠ è½½ mmkv æ–‡ä»¶å’Œ CRC æ–‡ä½“ã€‚MMKV çš„æ„é€ å‡½æ•°å®Œæ•´å®ç°å°±ä¸è´´å‡ºæ¥äº†ï¼Œç®€å•çœ‹ä¸€ä¸‹å£°æ˜å§ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">#ifndef MMKV_ANDROID
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07"></span>    MMKV(<span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string <span style="color:#719e07">&amp;</span>mmapID, MMKVMode mode, std<span style="color:#719e07">::</span>string <span style="color:#719e07">*</span>cryptKey, MMKVPath_t <span style="color:#719e07">*</span>relativePath);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    std<span style="color:#719e07">::</span>string m_mmapKey;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">#else </span><span style="color:#586e75">// defined(MMKV_ANDROID)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span>    MMKV(<span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string <span style="color:#719e07">&amp;</span>mmapID, <span style="color:#dc322f">int</span> size, MMKVMode mode, std<span style="color:#719e07">::</span>string <span style="color:#719e07">*</span>cryptKey, MMKVPath_t <span style="color:#719e07">*</span>relativePath);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    MMKV(<span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string <span style="color:#719e07">&amp;</span>mmapID, <span style="color:#dc322f">int</span> ashmemFD, <span style="color:#dc322f">int</span> ashmemMetaFd, std<span style="color:#719e07">::</span>string <span style="color:#719e07">*</span>cryptKey <span style="color:#719e07">=</span> <span style="color:#719e07">nullptr</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">#endif
</span></code></pre></div><h2 id="data-structure">Data Structure</h2>
<p>æœ¬èŠ‚ï¼Œä¼šç¨å¾®ä»‹ç»ä¸€ä¸‹ MMKV ä¸­ç”¨åˆ°çš„ç›¸å…³æ•°æ®ç»“æ„å’Œä¸€äº›å˜é‡ã€‚å¯¹ä¸»è¦æ•°æ®ç»“æ„æœ‰åŸºæœ¬äº†è§£åï¼Œåœ¨è§£é‡Šå®ç°æ—¶æˆ‘ä»¬æ›´èƒ½å¤Ÿ Focus åœ¨æ ¸å¿ƒé€»è¾‘ã€‚</p>
<p>å…ˆæ¥çœ‹ MMKV çš„å®ä¾‹å˜é‡ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>mmkv<span style="color:#719e07">::</span>MMKVMap m_dic; <span style="color:#586e75">/// ä¿å­˜å½“å‰æ˜ å°„åˆ°å†…å­˜çš„ k-v 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#586e75"></span>std<span style="color:#719e07">::</span>string m_mmapID;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>MMKVPath_t m_path; <span style="color:#586e75">// mmkv path
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span>MMKVPath_t m_crcPath; <span style="color:#586e75">// crc file path
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>mmkv<span style="color:#719e07">::</span>MemoryFile <span style="color:#719e07">*</span>m_file; <span style="color:#586e75">// mmap æ˜ å°„çœŸå®æ•°æ®æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬ file descrpitot ç­‰
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span>size_t m_actualSize; <span style="color:#586e75">//å½“å‰ k-v å ç”¨å†…å­˜å¤§å°
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#586e75"></span>mmkv<span style="color:#719e07">::</span>CodedOutputData <span style="color:#719e07">*</span>m_output; <span style="color:#586e75">// æ˜ å°„å†…å­˜æ‰€å‰©ä½™ç©ºé—´
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#dc322f">bool</span> m_needLoadFromFile; <span style="color:#586e75">// æ ‡è®°æ˜¯å¦éœ€è¦é‡æ–°è½½å…¥ m_file
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span><span style="color:#dc322f">bool</span> m_hasFullWriteback; <span style="color:#586e75">// æ˜¯å¦éœ€è¦æ‰§è¡Œå†™å›ï¼Œä¾‹å¦‚ m_file è¯»å–å¤±è´¥ï¼Œå†…å­˜å¼‚å¸¸ç­‰ç­‰
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#dc322f">uint32_t</span> m_crcDigest;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>mmkv<span style="color:#719e07">::</span>MemoryFile <span style="color:#719e07">*</span>m_metaFile; <span style="color:#586e75">// mmap æ˜ å°„ crc æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬ file descrpitot etc.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#586e75"></span>mmkv<span style="color:#719e07">::</span>MMKVMetaInfo <span style="color:#719e07">*</span>m_metaInfo; <span style="color:#586e75">// ä¿å­˜äº† crc æ–‡ä»¶çš„ digest å’Œ size etc.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>mmkv<span style="color:#719e07">::</span>AESCrypt <span style="color:#719e07">*</span>m_crypter; <span style="color:#586e75">// åŠ å¯†å™¨ï¼Œæ–‡ä»¶å†…å®¹æ›´æ–°åä¼šé‡æ–°è®¡ç®—åŠ å¯†å€¼
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>mmkv<span style="color:#719e07">::</span>ThreadLock <span style="color:#719e07">*</span>m_lock; <span style="color:#586e75">// k-v æ–‡ä»¶é”
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#586e75"></span>mmkv<span style="color:#719e07">::</span>FileLock <span style="color:#719e07">*</span>m_fileLock; <span style="color:#586e75">// crc æ–‡ä»¶é”
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#586e75"></span>mmkv<span style="color:#719e07">::</span>InterProcessLock <span style="color:#719e07">*</span>m_sharedProcessLock; <span style="color:#586e75">// è¯»é”
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span><span style="color:#586e75"></span>mmkv<span style="color:#719e07">::</span>InterProcessLock <span style="color:#719e07">*</span>m_exclusiveProcessLock; <span style="color:#586e75">// å†™é”
</span></code></pre></div><p>ä¸Šè¿°å˜é‡ä¼šåœ¨ MMKV æ„é€ å‡½æ•°è°ƒç”¨æ—¶å®Œæˆ initializeã€‚</p>
<h3 id="mmkvmap">MMKVMap</h3>
<p>é¦–å…ˆæ˜¯ <code>MMKVMap</code>ï¼Œå®ƒåŒºåˆ†äº† Apple ç³»å’Œå…¶ä»–ç³»ç»Ÿã€‚å¦‚æœæ˜¯ Apple ç³»ï¼Œåˆ™ä½¿ç”¨ NSString ä¸º keyï¼Œvalue ä¸ä»…æ˜¯ <code>MMBuffer</code> ç±»å‹ï¼Œéœ€è¦å®ç° KeyHasher å’Œ KeyEqualer åè®®ï¼Œæ¯•ç«Ÿ unordered_map æ˜¯ C++ æ³›å‹ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">struct</span> KeyHasher {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    size_t operator()(NSString <span style="color:#719e07">*</span>key) <span style="color:#719e07">const</span> { <span style="color:#719e07">return</span> key.hash; }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">struct</span> KeyEqualer {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#dc322f">bool</span> operator()(NSString <span style="color:#719e07">*</span>left, NSString <span style="color:#719e07">*</span>right) <span style="color:#719e07">const</span> { <span style="color:#586e75">/* left isEqual right */</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">#ifdef MMKV_APPLE
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07"></span>using MMKVMap <span style="color:#719e07">=</span> std<span style="color:#719e07">::</span>unordered_map<span style="color:#719e07">&lt;</span>NSString <span style="color:#719e07">*</span>, mmkv<span style="color:#719e07">::</span>MMBuffer, KeyHasher, KeyEqualer<span style="color:#719e07">&gt;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07"></span>using MMKVMap <span style="color:#719e07">=</span> std<span style="color:#719e07">::</span>unordered_map<span style="color:#719e07">&lt;</span>std<span style="color:#719e07">::</span>string, mmkv<span style="color:#719e07">::</span>MMBuffer<span style="color:#719e07">&gt;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">#endif
</span></code></pre></div><p>æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„ <code>m_dic</code> ä¸­å­˜å‚¨çš„æ•°æ®ç±»å‹æ˜¯ <code>MMBuffer</code> è€ŒéçœŸå®æ•°æ®ç±»å‹ã€‚åªæœ‰å½“æˆ‘ä»¬é€šè¿‡ Access è®¿é—®çš„æ—¶å€™æ‰ä¼š encode / decode å‡ºæ¥ã€‚</p>
<h3 id="mmkvkey_t">MMKVKey_t</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">#ifdef MMKV_APPLE
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07"></span>    <span style="color:#719e07">using</span> MMKVKey_t <span style="color:#719e07">=</span> NSString <span style="color:#719e07">*</span>__unsafe_unretained;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">static</span> <span style="color:#dc322f">bool</span> <span style="color:#268bd2">isKeyEmpty</span>(MMKVKey_t key) { <span style="color:#719e07">return</span> key.length <span style="color:#719e07">&lt;=</span> <span style="color:#2aa198">0</span>; }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07"></span>    <span style="color:#719e07">using</span> MMKVKey_t <span style="color:#719e07">=</span> <span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string <span style="color:#719e07">&amp;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    <span style="color:#719e07">static</span> <span style="color:#dc322f">bool</span> <span style="color:#268bd2">isKeyEmpty</span>(MMKVKey_t key) { <span style="color:#719e07">return</span> key.empty(); }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">#endif
</span></code></pre></div><p>æ³¨æ„ï¼Œæ•´ä¸ª MMKV Core çš„æºç ä¸­ï¼Œåº”è¯¥åªæœ‰ <strong>MMKV.cpp</strong> è¿™ä¸ªæ–‡ä»¶æ˜¯ä»¥ MRC çš„æ–¹å¼è¿›è¡Œå†…å­˜ç®¡ç†çš„ï¼Œå…¶ä»–çš„ C++ ç±»åˆ™ä½¿ç”¨äº† ARCï¼Œå¯ä»¥æŸ¥çœ‹ <a href="https://github.com/Tencent/MMKV/blob/master/MMKVCore.podspec">MMKVCore.podspec</a>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>s<span style="color:#719e07">.</span>requires_arc <span style="color:#719e07">=</span> <span style="color:#719e07">[</span><span style="color:#2aa198">&#39;Core/MemoryFile.cpp&#39;</span>, <span style="color:#719e07">...]</span>
</code></pre></div><p>è¿™é‡Œå¹¶æœªå‘ç°åŒ…å«äº† MMKV.cpp æ–‡ä»¶ï¼Œåç»­ä»£ç ä¸­ä¼šè¯´æ˜ã€‚</p>
<h3 id="mmkvpath_t">MMKVPath_t</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">using</span> MMKVPath_t <span style="color:#719e07">=</span> std<span style="color:#719e07">::</span>string;
</code></pre></div><h3 id="memoryfile">MemoryFile</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">MemoryFile</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    MMKVPath_t m_name;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    MMKVFileHandle_t m_fd; <span style="color:#586e75">// file descriptior (ä¸åŒå¹³å°æœ‰æ‰€å·®å¼‚)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span><span style="color:#719e07">#ifdef MMKV_WIN32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07"></span>    HANDLE m_fileMapping;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07"></span>    <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>m_ptr; <span style="color:#586e75">// æŒ‡å‘ mmap å†…å­˜çš„èµ·å§‹åœ°å€
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#586e75"></span>    size_t m_size; <span style="color:#586e75">// è¡¨ç¤ºçš„æ˜¯æ–‡ä»¶æŒ‰ç…§å†…å­˜æ•´æ•°é¡µæˆªæ–­åçš„ sizeã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#dc322f">bool</span> <span style="color:#268bd2">mmap</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">doCleanMemoryCache</span>(<span style="color:#dc322f">bool</span> forceClean);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">public</span><span style="color:#719e07">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">#ifndef MMKV_ANDROID
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07"></span>    <span style="color:#719e07">explicit</span> MemoryFile(<span style="color:#719e07">const</span> MMKVPath_t <span style="color:#719e07">&amp;</span>path);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07"></span>    MemoryFile(<span style="color:#719e07">const</span> MMKVPath_t <span style="color:#719e07">&amp;</span>path, size_t size, FileType fileType);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">explicit</span> <span style="color:#268bd2">MemoryFile</span>(MMKVFileHandle_t ashmemFD);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">const</span> FileType m_fileType;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">#endif </span><span style="color:#586e75">// MMKV_ANDROID
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#586e75"></span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>   <span style="color:#586e75">/* methods ... */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>}
</code></pre></div><p>MMKV ä¹‹æ‰€ä»¥é«˜æ•ˆå°±æ˜¯æºè‡ª mmapï¼Œæ­£æ˜¯ MemoryFile å°è£…äº† mmapã€mumapã€msync ç­‰ã€‚</p>
<p>éå®‰å“å¹³å°æ„é€ å‡½æ•°åªéœ€ filePathï¼Œå…¶ä½™å˜é‡å‡é€šè¿‡ <code>reloadFromFile()</code> æ¥è·å–ã€‚è¿™é‡Œå¤šè¯´ä¸€å˜´ <strong>FileType</strong>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">enum</span> <span style="color:#268bd2">FileType</span> <span style="color:#719e07">:</span> <span style="color:#dc322f">bool</span> { MMFILE_TYPE_FILE <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>, MMFILE_TYPE_ASHMEM <span style="color:#719e07">=</span> <span style="color:#b58900">true</span> };
</code></pre></div><p><code>MMFILE_TYPE_ASHMEM</code> æŒ‡ Android ä¸­æ‰€ç‹¬æœ‰çš„åŒ¿åå…±äº«å†…å­˜æ–¹å¼ <a href="https://developer.android.com/ndk/reference/group/memory">ASharedMemory</a>ï¼Œæœ¬è´¨ä¹Ÿæ˜¯ mmap å“ˆã€‚</p>
<p><strong>reloadFromFile</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">void</span> MemoryFile<span style="color:#719e07">::</span>reloadFromFile() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">#    ifdef MMKV_ANDROID
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07"></span>    <span style="color:#719e07">if</span> (m_fileType <span style="color:#719e07">==</span> MMFILE_TYPE_ASHMEM) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">#    endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07"></span>    <span style="color:#719e07">if</span> (isFileValid()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        MMKVWarning(<span style="color:#2aa198">&#34;calling reloadFromFile while the cache [%s] is still valid&#34;</span>, m_name.c_str());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        MMKV_ASSERT(<span style="color:#2aa198">0</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        clearMemoryCache();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    m_fd <span style="color:#719e07">=</span> open(m_name.c_str(), O_RDWR <span style="color:#719e07">|</span> O_CREAT <span style="color:#719e07">|</span> O_CLOEXEC, S_IRWXU);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">if</span> (m_fd <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        MMKVError(<span style="color:#2aa198">&#34;fail to open:%s, %s&#34;</span>, m_name.c_str(), strerror(errno));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        FileLock <span style="color:#268bd2">fileLock</span>(m_fd);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        InterProcessLock <span style="color:#268bd2">lock</span>(<span style="color:#719e07">&amp;</span>fileLock, ExclusiveLockType);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>        SCOPED_LOCK(<span style="color:#719e07">&amp;</span>lock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        mmkv<span style="color:#719e07">::</span>getFileSize(m_fd, m_size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        <span style="color:#586e75">// round up to (n * pagesize)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span><span style="color:#586e75"></span>        <span style="color:#719e07">if</span> (m_size <span style="color:#719e07">&lt;</span> DEFAULT_MMAP_SIZE <span style="color:#719e07">||</span> (m_size <span style="color:#719e07">%</span> DEFAULT_MMAP_SIZE <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span>)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>            size_t roundSize <span style="color:#719e07">=</span> ((m_size <span style="color:#719e07">/</span> DEFAULT_MMAP_SIZE) <span style="color:#719e07">+</span> <span style="color:#2aa198">1</span>) <span style="color:#719e07">*</span> DEFAULT_MMAP_SIZE;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>            truncate(roundSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>        } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>            <span style="color:#719e07">auto</span> ret <span style="color:#719e07">=</span> mmap();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>            <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>ret) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>                doCleanMemoryCache(<span style="color:#b58900">true</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span><span style="color:#719e07">#    ifdef MMKV_IOS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span><span style="color:#719e07"></span>        tryResetFileProtection(m_name);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span><span style="color:#719e07">#    endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span><span style="color:#719e07"></span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>}
</code></pre></div><p>ç¬¬ä¸€æ­¥å°±æ˜¯åˆ¤æ–­ <code>m_fileType</code>ï¼Œå¦‚æœä¸º <strong>MMFILE_TYPE_ASHMEM</strong> åˆ™ç›´æ¥ return ä»¥é€šè¿‡ <a href="https://developer.android.com/ndk/reference/group/memory#group___memory_1ga77a46b5986e5ab903b3c343df5870439">ASharedMemory_create</a> æ¥å®Œæˆå†…å­˜æ˜ å°„ã€‚</p>
<p>æ¥ç€åˆ¤æ–­ <code>fd</code> æ˜¯å¦æŒ‡å‘æœ‰æ•ˆå†…å­˜ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">#ifndef MMKV_WIN32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07"></span>    <span style="color:#dc322f">bool</span> <span style="color:#268bd2">isFileValid</span>() { <span style="color:#719e07">return</span> m_fd <span style="color:#719e07">&gt;=</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">&amp;&amp;</span> m_size <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">&amp;&amp;</span> m_ptr; }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07"></span>    <span style="color:#dc322f">bool</span> <span style="color:#268bd2">isFileValid</span>() { <span style="color:#719e07">return</span> m_fd <span style="color:#719e07">!=</span> INVALID_HANDLE_VALUE <span style="color:#719e07">&amp;&amp;</span> m_size <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">&amp;&amp;</span> m_fileMapping <span style="color:#719e07">&amp;&amp;</span> m_ptr; }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">#endif
</span></code></pre></div><p>å¦‚æœæœ‰æ•ˆï¼Œåˆ™ä¼šæ‰§è¡Œ <strong>MemoryFile::clearMemoryCache()</strong> ï¼Œå†…éƒ¨å…ˆè°ƒç”¨ <code>mumap(m_ptr, m_size)</code> æ¸…ç†å†…å­˜ç¼“å­˜ï¼Œå†å…³é—­æ–‡ä»¶è®¿é—® <code>close(m_fd)</code> è¿˜åŸ <code>m_fd</code> å’Œ <code>m_size</code>ã€‚</p>
<p>åœ¨ mmap å‰ä¼šæœ‰ä¸€ä¸ªå†…å­˜å–æ•´çš„æ£€æŸ¥ï¼Œä»¥ä¿è¯æ‰€æ˜ å°„çš„æ•°æ®æ˜¯å†…å­˜é¡µ <strong>DEFAULT_MMAP_SIZE</strong> çš„æ•´æ•°å€ï¼Œä»¥å‡å°‘å†…å­˜ç¢ç‰‡ã€‚</p>
<p>æœ€åï¼Œåœ¨ iOS ä¸Šä¼šè°ƒæ•´æ–‡ä»¶çš„è¯»å†™ä¿æŠ¤ï¼Œå‰é¢åœ¨æ³¨å†Œé€šçŸ¥ä¸­æåˆ°è¿‡ï¼Œä¸ºäº†ç¡®ä¿åº”ç”¨åœ¨åå°æ—¶èƒ½å®‰å…¨çš„è¿›è¡Œæ–‡ä»¶è®¿é—®ï¼Œè€Œä¸è‡³äºè¢«ç³»ç»Ÿé”™æ€ âš ï¸ã€‚</p>
<p><strong>truncate</strong></p>
<p>å†…å­˜åŒºå–æ•´ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MemoryFile<span style="color:#719e07">::</span>truncate(size_t size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (m_fd <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> (size <span style="color:#719e07">==</span> m_size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">#    ifdef MMKV_ANDROID
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07"></span>        ...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">#    endif </span><span style="color:#586e75">// MMKV_ANDROID
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#719e07">auto</span> oldSize <span style="color:#719e07">=</span> m_size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    m_size <span style="color:#719e07">=</span> size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#586e75">// round up to (n * pagesize)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#586e75"></span>    <span style="color:#719e07">if</span> (m_size <span style="color:#719e07">&lt;</span> DEFAULT_MMAP_SIZE <span style="color:#719e07">||</span> (m_size <span style="color:#719e07">%</span> DEFAULT_MMAP_SIZE <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span>)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        m_size <span style="color:#719e07">=</span> ((m_size <span style="color:#719e07">/</span> DEFAULT_MMAP_SIZE) <span style="color:#719e07">+</span> <span style="color:#2aa198">1</span>) <span style="color:#719e07">*</span> DEFAULT_MMAP_SIZE;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">::</span>ftruncate(m_fd, <span style="color:#719e07">static_cast</span><span style="color:#719e07">&lt;</span>off_t<span style="color:#719e07">&gt;</span>(m_size)) <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        MMKVError(<span style="color:#2aa198">&#34;fail to truncate [%s] to size %zu, %s&#34;</span>, m_name.c_str(), m_size, strerror(errno));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        m_size <span style="color:#719e07">=</span> oldSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">if</span> (m_size <span style="color:#719e07">&gt;</span> oldSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>zeroFillFile(m_fd, oldSize, m_size <span style="color:#719e07">-</span> oldSize)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>            MMKVError(<span style="color:#2aa198">&#34;fail to zeroFile [%s] to size %zu, %s&#34;</span>, m_name.c_str(), m_size, strerror(errno));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>            m_size <span style="color:#719e07">=</span> oldSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>            <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>    <span style="color:#719e07">if</span> (m_ptr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>        <span style="color:#719e07">if</span> (munmap(m_ptr, oldSize) <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>            MMKVError(<span style="color:#2aa198">&#34;fail to munmap [%s], %s&#34;</span>, m_name.c_str(), strerror(errno));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>    <span style="color:#719e07">auto</span> ret <span style="color:#719e07">=</span> mmap();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>ret) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>        doCleanMemoryCache(<span style="color:#b58900">true</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>    <span style="color:#719e07">return</span> ret;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>}
</code></pre></div><p>ä¸ºä¿è¯ size å‡†ç¡®æ€§ï¼Œå†è¿›è¡Œä¸€æ¬¡ <strong>round up to (n * pagesize)</strong> åæ‰è¿›è¡Œå–æ•´ã€‚ä¸¤æ­¥èµ°ï¼š</p>
<p><strong><a href="https://linux.die.net/man/2/ftruncate">ftruncate</a> + <a href="http://man7.org/linux/man-pages/man2/lseek.2.html">lseek</a></strong></p>
<p>å¯¹æ–‡ä»¶æ‰©å®¹æˆ–è£å‰ªï¼Œå¹¶å°† file offset æ›´æ–°è‡³å½“å‰å®¹é‡çš„æœ€åä½ç½®ã€‚ç”±äº truncate å¹¶ä¸ä¼šæ“ä½œ file offset æ‰€ä»¥éœ€è¦å€ŸåŠ© lseekï¼Œå‰©ä½™çš„éƒ¨åˆ†å‡ç”¨ <code>'\0'</code> å†™å…¥ã€‚</p>
<p><strong><a href="https://linux.die.net/man/2/munmap">munmap</a> + mmap</strong></p>
<p>ç”±äº mmap å…³è”çš„æ˜¯ oldSize çš„å†…å­˜ï¼Œè€Œç°åœ¨æˆ‘ä»¬è°ƒæ•´äº† <code>m_size</code> å¤§å°ï¼Œéœ€è¦é‡æ–°ç»‘å®šæ–‡ä»¶ä¸å†…å­˜å…³ç³»ã€‚</p>
<h3 id="mmbuffer">MMBuffer</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">MMBuffer</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">private</span><span style="color:#719e07">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>ptr;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    size_t size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    MMBufferCopyFlag isNoCopy;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">#ifdef MMKV_APPLE
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07"></span>    NSData <span style="color:#719e07">*</span>m_data <span style="color:#719e07">=</span> nil;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">public</span><span style="color:#719e07">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">explicit</span> MMBuffer(size_t length <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    MMBuffer(<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>source, size_t length, MMBufferCopyFlag flag <span style="color:#719e07">=</span> MMBufferCopy);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">#ifdef MMKV_APPLE
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07"></span>    <span style="color:#719e07">explicit</span> <span style="color:#268bd2">MMBuffer</span>(NSData <span style="color:#719e07">*</span>data, MMBufferCopyFlag flag <span style="color:#719e07">=</span> MMBufferCopy);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07"></span>   <span style="color:#586e75">// æ•°æ®è¯»å†™æ–¹æ³• ...
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#586e75"></span>}
</code></pre></div><p>å°±æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜åœ°å€ï¼Œåœ¨ Apple ä¸Šåˆ™ç”¨ NSData æŒ‡å‘ï¼Œå…¶ä»–å¹³å°åˆ™æ˜¯é€šè¿‡ <code>ptr + size</code> æ¥å¼•ç”¨ã€‚</p>
<p>åœ¨ MMKV ä¸­ä¸è®ºæ˜¯ä»æ•°æ®å†™å…¥æ–‡ä»¶è¿˜æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–ï¼Œç»Ÿä¸€è½¬æ¢ä¸º MMBuffer ä½œä¸ºè¿‡æ¸¡ã€‚</p>
<h3 id="codedoutputdata">CodedOutputData</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">CodedOutputData</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> m_ptr;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    size_t m_size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    size_t m_position;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">public</span><span style="color:#719e07">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    CodedOutputData(<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>ptr, size_t len);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    size_t <span style="color:#268bd2">spaceLeft</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span><span style="color:#268bd2">curWritePointer</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">seek</span>(size_t addedSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">writeRawByte</span>(<span style="color:#dc322f">uint8_t</span> value);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#586e75">/// å…¶ä»–åŸºæœ¬æ•°æ®ç±»å‹å†™å…¥ ...
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75"></span>}
</code></pre></div><h3 id="codedoutputdata-1">CodedOutputData</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">CodedInputData</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> m_ptr;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>	 size_t m_size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    size_t m_position;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#dc322f">int8_t</span> <span style="color:#268bd2">readRawByte</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">public</span><span style="color:#719e07">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    CodedInputData(<span style="color:#719e07">const</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>oData, size_t length);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#dc322f">bool</span> <span style="color:#268bd2">isAtEnd</span>() { <span style="color:#719e07">return</span> m_position <span style="color:#719e07">==</span> m_size; };
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#586e75">/// å…¶ä»–åŸºæœ¬æ•°æ®ç±»å‹è¯»å– ...
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#586e75"></span>}
</code></pre></div><p><code>CodedInputData</code> å’Œ <code>CodedOutputData</code> ä¸»è¦ç”¨äºçœŸå®æ•°æ®ç±»å‹å’Œ MMBuffer ä¹‹é—´è½¬æ¢ï¼Œå…³ç³»å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>MMBuffer <span style="color:#719e07">-&gt;</span> Input <span style="color:#719e07">-&gt;</span> çœŸå®æ•°æ® <span style="color:#719e07">-&gt;</span> output <span style="color:#719e07">-&gt;</span> MMBuffer
</code></pre></div><p><code>CodedInputData</code> å°† binary Data ä» MMBuffer ä¸­è¯»å–å‡ºæ¥ï¼Œè½¬æ¢ä¸ºçœŸå®æ•°æ®ç±»å‹ï¼›</p>
<p><code>CodedOutputData</code> åˆ™å°†çœŸå®æ•°æ®ç±»å‹è½¬æ¢ä¸º binaryData è¾“å‡ºåˆ° MMBuffer ä¸­ï¼›</p>
<p>å¯è§ï¼Œå®ƒä»¬ä¸¤èµ·åˆ°äº†æ¡¥æ¢çš„ä½œç”¨ï¼Œå®Œæˆäº†çœŸå®æ•°æ®å’Œ MMBuffer çš„ç›¸äº’è½¬æ¢ã€‚</p>
<h3 id="interprocesslock">InterProcessLock</h3>
<p>MMKV é‡‡ç”¨æ–‡ä»¶é”æ¥å¤„ç†å¤šè¿›ç¨‹ä¸­çš„æ–‡ä»¶è®¿é—®ã€‚<strong>ç”¨æ’ä»–é”ä½œä¸ºå†™é”ï¼Œç”¨å…±äº«é”ä½œä¸ºè¯»é”ã€‚</strong> è¿™é‡Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ç³»ç»Ÿçš„ <a href="http://man7.org/linux/man-pages/man2/flock.2.html">flock</a> è€Œæ˜¯ç”¨ FileLock å°†å…¶å°è£…äº†ä¸€å±‚ï¼Œè¯»å†™é”å‡ä¸º <code>InterProcessLock</code> æœ¬è´¨ä¸º FileLockã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">InterProcessLock</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    FileLock <span style="color:#719e07">*</span>m_fileLock;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    LockType m_lockType;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">public</span><span style="color:#719e07">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    InterProcessLock(FileLock <span style="color:#719e07">*</span>fileLock, LockType lockType)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">:</span> m_fileLock(fileLock), m_lockType(lockType), m_enable(<span style="color:#b58900">true</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        MMKV_ASSERT(m_fileLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#dc322f">bool</span> m_enable;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">lock</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">if</span> (m_enable) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>            m_fileLock<span style="color:#719e07">-&gt;</span>lock(m_lockType);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#dc322f">bool</span> <span style="color:#268bd2">try_lock</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        <span style="color:#719e07">if</span> (m_enable) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>            <span style="color:#719e07">return</span> m_fileLock<span style="color:#719e07">-&gt;</span>try_lock(m_lockType);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">unlock</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        <span style="color:#719e07">if</span> (m_enable) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>            m_fileLock<span style="color:#719e07">-&gt;</span>unlock(m_lockType);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>};
</code></pre></div><p>MMVK.h ä¸­è¿˜å£°æ˜äº†å˜é‡ <strong>m_isInterProcess</strong> ç”¨äºæ§åˆ¶é”åŠŸèƒ½å¼€å…³ã€‚å¯¹äºæ”¯æŒå¤šè¿›ç¨‹çš„ MMKV è€Œè¨€ï¼Œm_isInterProcess ä»£è¡¨äº†å½“å‰å®ä¾‹æ‰€é‡‡ç”¨çš„è¯»å†™æ¨¡å¼ï¼š<strong>MMKVMode</strong>ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">enum</span> <span style="color:#268bd2">MMKVMode</span> <span style="color:#719e07">:</span> <span style="color:#dc322f">uint32_t</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    MMKV_SINGLE_PROCESS <span style="color:#719e07">=</span> <span style="color:#2aa198">0x1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    MMKV_MULTI_PROCESS <span style="color:#719e07">=</span> <span style="color:#2aa198">0x2</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">#ifdef MMKV_ANDROID
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07"></span>    CONTEXT_MODE_MULTI_PROCESS <span style="color:#719e07">=</span> <span style="color:#2aa198">0x4</span>, <span style="color:#586e75">// in case someone mistakenly pass Context.MODE_MULTI_PROCESS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75"></span>    MMKV_ASHMEM <span style="color:#719e07">=</span> <span style="color:#2aa198">0x8</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07"></span>};
</code></pre></div><p>å…³äºé”çš„ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹è¿™ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/25134841">flock æ–‡ä»¶é”</a>ã€‚</p>
<p>ç”±äºæœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œå¾ˆå¤šæè¿°ä¸­å¿½ç•¥äº†é”ç›¸å…³çš„ç»†èŠ‚ï¼ˆå…¶å®éå¸¸é‡è¦çš„ï¼‰ï¼Œä¹‹åä¼šå•ç‹¬å¼€ç¯‡æ¥èŠèŠã€‚</p>
<h1 id="loaddata">LoadData</h1>
<p>æœ¬èŠ‚ä¸»è¦ä»‹ç» MMKV å¦‚ä½•ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€å¼‚å¸¸æ•°æ®å¤„ç†ã€ä»¥åŠå¦‚ä½•åˆ©ç”¨ CRC æ¥æ ¡éªŒæ–‡ä»¶çš„å®Œæ•´æ€§ã€‚</p>
<p>åœ¨åº”ç”¨é¦–æ¬¡åˆå§‹åŒ–ã€æ•°æ®å¼‚å¸¸ï¼Œå†…å­˜è­¦å‘Šã€æ¸…ç†æ•°æ®æ—¶éƒ½ä¼šæ‰§è¡Œ <code>loadFromFile()</code> æ¥åˆ·æ–°å†…å­˜ä¸­å¯¹åº”çš„æ•°æ®ï¼Œä¿è¯å…¶å‡†ç¡®æ€§ã€‚æ•´ä¸ª m_file åŠ è½½ä¸»è¦åˆ†ä¸‰æ­¥ï¼š</p>
<ol>
<li>æ ¡éªŒ CRC æ–‡ä»¶ã€m_file çš„æœ‰æ•ˆæ€§ï¼Œåˆå§‹åŒ– AESCrypterï¼›</li>
<li>æ£€æŸ¥æ–‡ä»¶å†…éƒ¨æ•°æ®çš„æœ‰æ•ˆæ€§ï¼›</li>
<li>åŠ è½½æ•°æ®åˆ°å†…å­˜ã€‚</li>
</ol>
<h2 id="æ–‡ä»¶æœ‰æ•ˆæ€§">æ–‡ä»¶æœ‰æ•ˆæ€§</h2>
<p>åœ¨ MMKV æ„é€ å‡½æ•°æ‰§è¡Œæ—¶ï¼Œm_metaFile ä¸ºæœ¬åœ° crc æ–‡ä»¶çš„å†…å­˜æ˜ å°„ï¼Œè€Œ m_metaInfo åˆ™è®°å½•äº†å½“å‰å†…å­˜æ•°æ®çš„ç›¸å…³ crc æ ¡éªŒå€¼ï¼Œé»˜è®¤ä¸ºç©ºã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">struct</span> <span style="color:#268bd2">MMKVMetaInfo</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#dc322f">uint32_t</span> m_crcDigest <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#dc322f">uint32_t</span> m_version <span style="color:#719e07">=</span> MMKVVersionSequence;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#dc322f">uint32_t</span> m_sequence <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; <span style="color:#586e75">// full write-back count
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"></span>    <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">char</span> m_vector[AES_KEY_LEN] <span style="color:#719e07">=</span> {};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#dc322f">uint32_t</span> m_actualSize <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#586e75">// confirmed info: it&#39;s been synced to file
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>    <span style="color:#719e07">struct</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        <span style="color:#dc322f">uint32_t</span> lastActualSize <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        <span style="color:#dc322f">uint32_t</span> lastCRCDigest <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#dc322f">uint32_t</span> __reserved__[<span style="color:#2aa198">16</span>] <span style="color:#719e07">=</span> {};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    } m_lastConfirmedMetaInfo;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">write</span>(<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>ptr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        MMKV_ASSERT(ptr);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        memcpy(ptr, <span style="color:#719e07">this</span>, <span style="color:#719e07">sizeof</span>(MMKVMetaInfo));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">writeCRCAndActualSizeOnly</span>(<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>ptr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        MMKV_ASSERT(ptr);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        <span style="color:#719e07">auto</span> other <span style="color:#719e07">=</span> (MMKVMetaInfo <span style="color:#719e07">*</span>) ptr;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        other<span style="color:#719e07">-&gt;</span>m_crcDigest <span style="color:#719e07">=</span> m_crcDigest;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>        other<span style="color:#719e07">-&gt;</span>m_actualSize <span style="color:#719e07">=</span> m_actualSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>    <span style="color:#dc322f">void</span> <span style="color:#268bd2">read</span>(<span style="color:#719e07">const</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>ptr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>        MMKV_ASSERT(ptr);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>        memcpy(<span style="color:#719e07">this</span>, ptr, <span style="color:#719e07">sizeof</span>(MMKVMetaInfo));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>};
</code></pre></div><p>å› æ­¤ï¼ŒMMKV åœ¨åŠ è½½ m_file å‰è¦å°† crc çš„æ ¡éªŒå€¼è½½å…¥ m_metaInfoï¼Œè½½å…¥å‰ä¼šç¡®è®¤ crc å®Œæˆæ˜ å°„ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> (m_metaFile<span style="color:#719e07">-&gt;</span>isFileValid()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    m_metaInfo<span style="color:#719e07">-&gt;</span>read(m_metaFile<span style="color:#719e07">-&gt;</span>getMemory());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>}
</code></pre></div><p>æ³¨æ„ m_version è¡¨ç¤ºå½“å‰ç¼“å­˜çš„å†…å®¹æ•°æ®çš„çŠ¶æ€ï¼Œåˆå§‹å€¼ä¸º MMKVVersionSequenceã€‚æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">enum</span> <span style="color:#268bd2">MMKVVersion</span> <span style="color:#719e07">:</span> <span style="color:#dc322f">uint32_t</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    MMKVVersionDefault <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#586e75">// è®°å½•äº†å®Œå…¨å›å†™çš„æ¬¡æ•°
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#586e75"></span>    MMKVVersionSequence <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    <span style="color:#586e75">// å­˜å‚¨äº†åŠ å¯†çš„éšæœº iv 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75"></span>    MMKVVersionRandomIV <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    <span style="color:#586e75">// å­˜å‚¨äº† actual sizeã€crc checksum, ç”¨äºå‡å°‘æ–‡ä»¶æŸåçš„æƒ…å†µ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#586e75"></span>    MMKVVersionActualSize <span style="color:#719e07">=</span> <span style="color:#2aa198">3</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>};
</code></pre></div><h3 id="aescrypter">AESCrypter</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> (m_crypter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    <span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">&gt;=</span> MMKVVersionRandomIV) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>        m_crypter<span style="color:#719e07">-&gt;</span>resetIV(m_metaInfo<span style="color:#719e07">-&gt;</span>m_vector, <span style="color:#719e07">sizeof</span>(m_metaInfo<span style="color:#719e07">-&gt;</span>m_vector));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>}
</code></pre></div><p>MMKV åˆå§‹åŒ–æ—¶ï¼Œç”¨æˆ·å¦‚æœä¼ å…¥ AES Keyï¼Œä¼šé€šè¿‡ <code>resetIV</code> æ¥åˆå§‹åŒ– AESã€‚</p>
<p>AES å±äºå—åŠ å¯†ä¸”å­˜åœ¨å¤šç§åŠ å¯†æ¨¡å¼ï¼ŒMMKV ä¸­ä½¿ç”¨çš„æ˜¯ CFB-128 æ¨¡å¼ã€‚è¯¥æ¨¡å¼éœ€è¦åŒæ—¶ä½¿ç”¨ KEY å’Œ IV æ¥å®Œæˆå¯¹æ•°æ®çš„åŠ å¯†ã€‚</p>
<p>å…³äº AES çš„ä»‹ç»å¯ä»¥çœ‹ <a href="https://www.wikiwand.com/en/Block_cipher_mode_of_operation">WiKi</a>ï¼Œè¿™é‡Œåªä»‹ç»ä¸€ä¸‹ IV å‘é‡çš„ä½œç”¨ã€‚</p>
<blockquote>
<p>IVç§°ä¸ºåˆå§‹å‘é‡ï¼Œä¸åŒçš„IVåŠ å¯†åçš„å­—ç¬¦ä¸²æ˜¯ä¸åŒçš„ï¼ŒåŠ å¯†å’Œè§£å¯†éœ€è¦ç›¸åŒçš„IVï¼Œæ—¢ç„¶IVçœ‹èµ·æ¥å’Œkeyä¸€æ ·ï¼Œå´è¿˜è¦å¤šä¸€ä¸ªIVçš„ç›®çš„ï¼Œå¯¹äºæ¯ä¸ªå—æ¥è¯´ï¼Œkeyæ˜¯ä¸å˜çš„ï¼Œä½†æ˜¯åªæœ‰ç¬¬ä¸€ä¸ªå—çš„IVæ˜¯ç”¨æˆ·æä¾›çš„ï¼Œå…¶ä»–å—IVéƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆã€‚
IVçš„é•¿åº¦ä¸º16å­—èŠ‚ã€‚è¶…è¿‡æˆ–è€…ä¸è¶³ï¼Œå¯èƒ½å®ç°çš„åº“éƒ½ä¼šè¿›è¡Œè¡¥é½æˆ–æˆªæ–­ã€‚ä½†æ˜¯ç”±äºå—çš„é•¿åº¦æ˜¯16å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€èˆ¬å¯ä»¥è®¤ä¸ºéœ€è¦çš„IVæ˜¯16å­—èŠ‚ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ metaInfo-&gt;m_vector è®°å½•çš„å°±æ˜¯ AES çš„ IV å‘é‡ï¼Œå…¶é•¿åº¦ <strong>AES_KEY_LEN</strong> ä¸º 16ã€‚</p>
<p>æ¥ç€å°±æ˜¯ m_file æœ‰æ•ˆæ€§æ£€æŸ¥ <code>isFileValid</code>ã€‚é€šè¿‡å°±è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼Œå¦åˆ™å°è¯• <strong>reloadFromFile</strong>ã€‚</p>
<h2 id="æ•°æ®æœ‰æ•ˆæ€§">æ•°æ®æœ‰æ•ˆæ€§</h2>
<p>æ•´ä¸ªæ•°æ®æœ‰æ•ˆæ€§æ˜¯åœ¨ <code>checkDataValid</code> ä¸­å®Œæˆçš„ï¼Œé¦–å…ˆæ˜¯è¯»å– <code>m_actualSize</code> ã€‚</p>
<h3 id="readactualsize">readActualSize</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>size_t MMKV<span style="color:#719e07">::</span>readActualSize() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    MMKV_ASSERT(m_file<span style="color:#719e07">-&gt;</span>getMemory());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    MMKV_ASSERT(m_metaFile<span style="color:#719e07">-&gt;</span>isFileValid());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#dc322f">uint32_t</span> actualSize <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    memcpy(<span style="color:#719e07">&amp;</span>actualSize, m_file<span style="color:#719e07">-&gt;</span>getMemory(), Fixed32Size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">&gt;=</span> MMKVVersionActualSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_actualSize <span style="color:#719e07">!=</span> actualSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            MMKVWarning(<span style="color:#2aa198">&#34;[%s] actual size %u, meta actual size %u&#34;</span>ï¼Œ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#719e07">return</span> m_metaInfo<span style="color:#719e07">-&gt;</span>m_actualSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">return</span> actualSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>}
</code></pre></div><p>å¦‚æœ m_metaInfo è®°å½•äº† m_actualSize å°†å…¶ä¼˜å…ˆè¿”å›ã€‚å¦åˆ™ä»¥æ–‡ä»¶è®°å½•å€¼ä¸ºå‡†ã€‚è¿™é‡Œ actualSize é€šè¿‡è¯»å– m_file å¤´éƒ¨çš„å›ºå®šé•¿åº¦ <strong>Fixed32Size</strong> çš„æ•°æ®ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">constexpr</span> <span style="color:#dc322f">uint32_t</span> LittleEdian32Size <span style="color:#719e07">=</span> <span style="color:#2aa198">4</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">constexpr</span> <span style="color:#dc322f">uint32_t</span> <span style="color:#268bd2">pbFixed32Size</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#719e07">return</span> LittleEdian32Size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">constexpr</span> <span style="color:#dc322f">uint32_t</span> Fixed32Size <span style="color:#719e07">=</span> pbFixed32Size();
</code></pre></div><p>å…¶æ¬¡ï¼Œç¡®è®¤å½“å‰æ–‡ä»¶æ‰€å‰©ä½™ç©ºé—´æ˜¯å¦è¶³å¤Ÿä½¿ç”¨ã€‚å‰é¢æè¿‡å¯¹äºæœªå­˜å‚¨æ•°æ®çš„éƒ¨åˆ†é»˜è®¤æ˜¯ä»¥ <code>\0</code> å¡«å……çš„ï¼Œå› æ­¤è¿™é‡Œéœ€è¦å°†æ–‡ä»¶å¤§å°å’ŒçœŸå®æ•°æ®å¤§å°è¿›è¡Œæ¯”è¾ƒã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>checkDataValid(<span style="color:#dc322f">bool</span> <span style="color:#719e07">&amp;</span>loadFromFile, <span style="color:#dc322f">bool</span> <span style="color:#719e07">&amp;</span>needFullWriteback) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#586e75">// try auto recover from last confirmed location
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>    <span style="color:#719e07">auto</span> fileSize <span style="color:#719e07">=</span> m_file<span style="color:#719e07">-&gt;</span>getFileSize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#719e07">auto</span> checkLastConfirmedInfo <span style="color:#719e07">=</span> [<span style="color:#719e07">&amp;</span>] { ... }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    m_actualSize <span style="color:#719e07">=</span> readActualSize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">if</span> (m_actualSize <span style="color:#719e07">&lt;</span> fileSize <span style="color:#719e07">&amp;&amp;</span> (m_actualSize <span style="color:#719e07">+</span> Fixed32Size) <span style="color:#719e07">&lt;=</span> fileSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">if</span> (checkFileCRCValid(m_actualSize, m_metaInfo<span style="color:#719e07">-&gt;</span>m_crcDigest)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            loadFromFile <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>; <span style="color:#586e75">/// æ•°æ®æ­£ç¡®ä¸”å‰©ä½™ç©ºé—´è¶³å¤Ÿ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>        } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>            checkLastConfirmedInfo();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>           <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>loadFromFile) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>                âš ï¸ Handler <span style="color:#2aa198">3</span><span style="color:#719e07">:</span> æ•°æ®å¼‚å¸¸
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        checkLastConfirmedInfo();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>loadFromFile) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>            âš ï¸ Handler <span style="color:#2aa198">4</span><span style="color:#719e07">:</span> ç©ºé—´ä¸è¶³
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>}
</code></pre></div><p>å¦‚æœç©ºé—´è¶³å¤Ÿï¼Œåˆ™è®¡ç®—å‡ºå½“å‰ m_file çœŸå®æ•°æ®çš„ crc digestï¼Œå¹¶ä¸ m_metaInfo çš„ m_crcDigest å¯¹æ¯”ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>checkFileCRCValid(size_t actualSize, <span style="color:#dc322f">uint32_t</span> crcDigest) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">auto</span> ptr <span style="color:#719e07">=</span> (<span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span>) m_file<span style="color:#719e07">-&gt;</span>getMemory();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">if</span> (ptr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        m_crcDigest <span style="color:#719e07">=</span> (<span style="color:#dc322f">uint32_t</span>) CRC32(<span style="color:#2aa198">0</span>, (<span style="color:#719e07">const</span> <span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span>) ptr <span style="color:#719e07">+</span> Fixed32Size, (<span style="color:#dc322f">uint32_t</span>) actualSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">if</span> (m_crcDigest <span style="color:#719e07">==</span> crcDigest) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>            <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        MMKVError(<span style="color:#2aa198">&#34;check crc [%s] fail, crc32:%u, m_crcDigest:%u&#34;</span>, ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>}
</code></pre></div><p>å¦ï¼Œå…³äº CRC å·®é”™æ£€æµ‹èƒ½åŠ›ï¼Œç§»æ­¥<a href="https://baike.baidu.com/item/CRC/1453359">ç™¾ç§‘</a>ã€‚</p>
<p>æ ¡éªŒé€šè¿‡å°±å¼€å§‹ m_file å†…å®¹çš„åŠ è½½ã€‚</p>
<h3 id="checklastconfirmedinfo">checkLastConfirmedInfo</h3>
<p>å¦‚æœæ•°æ®å¼‚å¸¸æˆ–è€…ç©ºé—´ä¸è¶³ï¼Œéƒ½ä¼šè°ƒç”¨ checkLastConfirmedInfo é‡æ–°ç¡®è®¤ loadFromFile çŠ¶æ€ã€‚checkLastConfirmedInfo ä¸º C++ ä¸­çš„ lambda å‡½æ•°ï¼Œå…¶å£°æ˜åœ¨ checkDataValid ä¸­ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">&gt;=</span> MMKVVersionActualSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#586e75">// downgrade &amp; upgrade support
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>    <span style="color:#dc322f">uint32_t</span> oldStyleActualSize <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    memcpy(<span style="color:#719e07">&amp;</span>oldStyleActualSize, m_file<span style="color:#719e07">-&gt;</span>getMemory(), Fixed32Size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> (oldStyleActualSize <span style="color:#719e07">!=</span> m_actualSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        MMKVWarning(<span style="color:#2aa198">&#34;oldStyleActualSize not equal to meta actual size&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">if</span> (oldStyleActualSize <span style="color:#719e07">&lt;</span> fileSize <span style="color:#719e07">&amp;&amp;</span> (oldStyleActualSize <span style="color:#719e07">+</span> Fixed32Size) <span style="color:#719e07">&lt;=</span> fileSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>            <span style="color:#719e07">if</span> (checkFileCRCValid(oldStyleActualSize, m_metaInfo<span style="color:#719e07">-&gt;</span>m_crcDigest)) { âš ï¸ Handler <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>                MMKVInfo(<span style="color:#2aa198">&#34;looks like [%s] been downgrade &amp; upgrade again&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>                loadFromFile <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>                writeActualSize(oldStyleActualSize, m_metaInfo<span style="color:#719e07">-&gt;</span>m_crcDigest, <span style="color:#719e07">nullptr</span>, KeepSequence);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>                <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>            MMKVWarning(<span style="color:#2aa198">&#34;oldStyleActualSize greater than file size&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">auto</span> lastActualSize <span style="color:#719e07">=</span> m_metaInfo<span style="color:#719e07">-&gt;</span>m_lastConfirmedMetaInfo.lastActualSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>    <span style="color:#719e07">if</span> (lastActualSize <span style="color:#719e07">&lt;</span> fileSize <span style="color:#719e07">&amp;&amp;</span> (lastActualSize <span style="color:#719e07">+</span> Fixed32Size) <span style="color:#719e07">&lt;=</span> fileSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        <span style="color:#719e07">auto</span> lastCRCDigest <span style="color:#719e07">=</span> m_metaInfo<span style="color:#719e07">-&gt;</span>m_lastConfirmedMetaInfo.lastCRCDigest;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        <span style="color:#719e07">if</span> (checkFileCRCValid(lastActualSize, lastCRCDigest)) { âš ï¸ Handler <span style="color:#2aa198">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>            loadFromFile <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>            writeActualSize(lastActualSize, lastCRCDigest, <span style="color:#719e07">nullptr</span>, KeepSequence);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>            MMKVError(<span style="color:#2aa198">&#34;check lastActualSize, lastActualCRC error&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>        MMKVError(<span style="color:#2aa198">&#34;check lastActualSize, file size error&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>}
</code></pre></div><p>åœ¨ MMKVMetaInfo ä¸­çš„ <strong>m_lastConfirmedMetaInfo</strong> å¯èƒ½è®°å½•äº†ä¸Šä¸€æ¬¡æ ¡éªŒè¿‡çš„ metaInfoï¼Œè€Œåªåœ¨ m_version ä¸º <strong>MMKVVersionActualSize</strong> æ—¶ï¼Œm_lastConfirmedMetaInfo æ‰æœ‰æ•°æ®ã€‚æ•…è€Œ check çš„å‰ç½®æ¡ä»¶ä¸º  &gt;= MMKVVersionActualSizeã€‚</p>
<p>æ£€æŸ¥ä¸­æœ‰ä¸¤æ¬¡æ¢å¤æ­£ç¡® metaInfo çš„æœºä¼šï¼š</p>
<p><strong>Handler 1</strong></p>
<p><code>oldStyleActualSize</code> è®°å½•å€¼ä¸º m_file çš„å†…å®¹æ•°æ®å¤§å°ï¼Œå½“å…¶å€¼ä¸ç­‰äº m_metaInfo-&gt;m_actualSize æ—¶ï¼Œå°è¯•ä»¥ <code>oldStyleActualSize</code> ä¸ºå‡†æ›´æ–° metaInfo çš„ä¿¡æ¯ã€‚æ›´æ–°ä»ç„¶è¦è¿›è¡Œ CRC æ ¡éªŒï¼Œé€šè¿‡åå°† loadFromFile æ ‡è®°ä¸º trueï¼Œè°ƒç”¨ writeActualSize å®Œæˆ metaInfo çš„æ¢å¤ã€‚</p>
<p><strong>Handler 2</strong></p>
<p>æœ€åä¸€æ ¹æ•‘å‘½ç¨»è‰ä¸º <strong>m_metaInfo-&gt;m_lastConfirmedMetaInfo.lastActualSize</strong>ã€‚ç”¨å®ƒå†è¿›è¡Œä¸€æ¬¡ Handler 1 çš„æ£€æŸ¥ã€‚</p>
<h3 id="writeactualsize">writeActualSize</h3>
<p>ç”¨äºæ›´æ–° m_metaInfo ä¿¡æ¯ï¼ŒåŒ…æ‹¬ actualSizeã€crcDigestã€IVã€lastConfrimInfoã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>writeActualSize(size_t size, <span style="color:#dc322f">uint32_t</span> crcDigest, <span style="color:#719e07">const</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>iv, <span style="color:#dc322f">bool</span> increaseSequence) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>   <span style="color:#586e75">// backward compatibility
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>   oldStyleWriteActualSize(size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>   <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>m_metaFile<span style="color:#719e07">-&gt;</span>isFileValid()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>       <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>   }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>   <span style="color:#dc322f">bool</span> needsFullWrite <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>   m_actualSize <span style="color:#719e07">=</span> size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>   m_metaInfo<span style="color:#719e07">-&gt;</span>m_actualSize <span style="color:#719e07">=</span> <span style="color:#719e07">static_cast</span><span style="color:#719e07">&lt;</span><span style="color:#dc322f">uint32_t</span><span style="color:#719e07">&gt;</span>(size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>   m_crcDigest <span style="color:#719e07">=</span> crcDigest;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>   m_metaInfo<span style="color:#719e07">-&gt;</span>m_crcDigest <span style="color:#719e07">=</span> crcDigest;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>   <span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">&lt;</span> MMKVVersionSequence) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>       m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">=</span> MMKVVersionSequence;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>       needsFullWrite <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>   }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>   <span style="color:#719e07">if</span> (unlikely(iv)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>       memcpy(m_metaInfo<span style="color:#719e07">-&gt;</span>m_vector, iv, <span style="color:#719e07">sizeof</span>(m_metaInfo<span style="color:#719e07">-&gt;</span>m_vector));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>       <span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">&lt;</span> MMKVVersionRandomIV) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>           m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">=</span> MMKVVersionRandomIV;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>       }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>       needsFullWrite <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>   }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>   <span style="color:#719e07">if</span> (unlikely(increaseSequence)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>       m_metaInfo<span style="color:#719e07">-&gt;</span>m_sequence<span style="color:#719e07">++</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>       m_metaInfo<span style="color:#719e07">-&gt;</span>m_lastConfirmedMetaInfo.lastActualSize <span style="color:#719e07">=</span> <span style="color:#719e07">static_cast</span><span style="color:#719e07">&lt;</span><span style="color:#dc322f">uint32_t</span><span style="color:#719e07">&gt;</span>(size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>       m_metaInfo<span style="color:#719e07">-&gt;</span>m_lastConfirmedMetaInfo.lastCRCDigest <span style="color:#719e07">=</span> crcDigest;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>       <span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">&lt;</span> MMKVVersionActualSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>           m_metaInfo<span style="color:#719e07">-&gt;</span>m_version <span style="color:#719e07">=</span> MMKVVersionActualSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>       }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>       needsFullWrite <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>   }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span><span style="color:#719e07">#ifdef MMKV_IOS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span><span style="color:#719e07"></span>   <span style="color:#719e07">return</span> <span style="color:#268bd2">protectFromBackgroundWriting</span>(m_metaFile<span style="color:#719e07">-&gt;</span>getMemory(), <span style="color:#719e07">sizeof</span>(MMKVMetaInfo), <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>     <span style="color:#719e07">if</span> (unlikely(needsFullWrite)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>         m_metaInfo<span style="color:#719e07">-&gt;</span>write(m_metaFile<span style="color:#719e07">-&gt;</span>getMemory());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>     } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>         m_metaInfo<span style="color:#719e07">-&gt;</span>writeCRCAndActualSizeOnly(m_metaFile<span style="color:#719e07">-&gt;</span>getMemory());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>     }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>   });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span><span style="color:#719e07"></span>   ...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44</span><span style="color:#719e07">#endif
</span></code></pre></div><p>å‰ä¸‰ä¸ªå‚æ•°å°±ä¸ç”¨è¯´äº†ï¼Œçœ‹æœ€åå‚æ•° <code>increaseSequence</code>ï¼Œç±»å‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">enum</span> : <span style="color:#268bd2">bool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    KeepSequence <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    IncreaseSequence <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>};
</code></pre></div><p>å®ƒç”¨äºæ§åˆ¶æ˜¯å¦æ›´æ–°æ–‡ä»¶çš„ full write-back count åŠ needsFullWriteã€‚needsFullWrite ç›¸å½“äº dirty bit çš„ä½œç”¨ï¼Œæ¯å½“ m_version æœ‰æ›´æ–°ï¼Œéƒ½ä¼šå°† needsFullWrite æ ‡è®°ä¸º dirty ç”¨äºä¹‹åçš„å†™å›æ›´æ–°ã€‚</p>
<p><strong>write-back</strong> æ¦‚å¿µåé¢ä¼šä»‹ç»ã€‚</p>
<h3 id="checkdatavalid">checkDataValid</h3>
<p>åˆ°è¿™é‡Œï¼Œæ•°æ®æ ¡éªŒçš„ä¸»æµç¨‹ç®—æ˜¯ä»‹ç»å®Œäº†ï¼Œæˆ‘ä»¬å›åˆ° checkDataValidï¼Œè¡¥ä¸Š checkLastConfirmedInfo åæ•°æ®çŠ¶æ€ä¾æ—§é”™è¯¯ï¼ŒloadlFromFile ä¸º false çš„æƒ…å†µã€‚</p>
<p><strong>Handler 3</strong> ï¼ˆæ ‡è®°åœ¨ğŸ‘†ä»£ç ä¸­ï¼‰</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">auto</span> strategic <span style="color:#719e07">=</span> onMMKVCRCCheckFail(m_mmapID);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">if</span> (strategic <span style="color:#719e07">==</span> OnErrorRecover) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    loadFromFile <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    needFullWriteback <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>MMKVInfo(<span style="color:#2aa198">&#34;recover strategic for [%s] is %d&#34;</span>, m_mmapID.c_str(), strategic);
</code></pre></div><p><strong>Handler 4</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">auto</span> strategic <span style="color:#719e07">=</span> onMMKVFileLengthError(m_mmapID);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">if</span> (strategic <span style="color:#719e07">==</span> OnErrorRecover) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#586e75">// make sure we don&#39;t over read the file
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#586e75"></span>    m_actualSize <span style="color:#719e07">=</span> fileSize <span style="color:#719e07">-</span> Fixed32Size;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    loadFromFile <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    needFullWriteback <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>MMKVInfo(<span style="color:#2aa198">&#34;recover strategic for [%s] is %d&#34;</span>, m_mmapID.c_str(), strategic);
</code></pre></div><p>å¯¹äºå¼‚å¸¸çš„å¤„ç†ç­–ç•¥ï¼ŒMMKV ä¸ºæˆ‘ä»¬æä¾›äº†ä¿®æ”¹çš„å›è°ƒã€‚ç­–ç•¥æœ‰ä¸¤ç§ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">enum</span> <span style="color:#268bd2">MMKVRecoverStrategic</span> <span style="color:#719e07">:</span> <span style="color:#dc322f">int</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    OnErrorDiscard <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    OnErrorRecover,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>};
</code></pre></div><p>é»˜è®¤ MMKV ä¼šä¸¢å¼ƒå½“å‰æ•°æ®ã€æ¸…ç©ºæ–‡ä»¶å’Œ metaInfoã€‚æ­¤æ—¶å¯é€šè¿‡ <strong>g_errorHandler</strong> ä¿®æ”¹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">static</span> MMKVRecoverStrategic <span style="color:#268bd2">onMMKVCRCCheckFail</span>(<span style="color:#719e07">const</span> string <span style="color:#719e07">&amp;</span>mmapID) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (g_errorHandler) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> g_errorHandler(mmapID, MMKVErrorType<span style="color:#719e07">::</span>MMKVCRCCheckFail);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">return</span> OnErrorDiscard;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">static</span> MMKVRecoverStrategic <span style="color:#268bd2">onMMKVFileLengthError</span>(<span style="color:#719e07">const</span> string <span style="color:#719e07">&amp;</span>mmapID) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">if</span> (g_errorHandler) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        <span style="color:#719e07">return</span> g_errorHandler(mmapID, MMKVErrorType<span style="color:#719e07">::</span>MMKVFileLength);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#719e07">return</span> OnErrorDiscard;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>}
</code></pre></div><h2 id="æ•°æ®å¤„ç†">æ•°æ®å¤„ç†</h2>
<p>æ ¡éªŒå®Œæœ‰æ•ˆæ€§ï¼Œä¾æ®å…¶ç»“æœ <strong>loadFromFile</strong> å’Œ <strong>needFullWriteback</strong> å€¼æ¥åˆ¤å®šåç»­æ“ä½œã€‚ç®€åŒ–åçš„ loadFromFileï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>loadFromFile() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#586e75">/// 1. æ–‡ä»¶æœ‰æ•ˆæ€§
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>    <span style="color:#586e75">/// 2. æ•°æ®æœ‰æ•ˆæ€§
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span>    ...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#dc322f">bool</span> loadFromFile <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>, needFullWriteback <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    checkDataValid(loadFromFile, needFullWriteback);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    ...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">auto</span> ptr <span style="color:#719e07">=</span> (<span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span>) m_file<span style="color:#719e07">-&gt;</span>getMemory();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">if</span> (loadFromFile <span style="color:#719e07">&amp;&amp;</span> m_actualSize <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>       MMKVInfo(<span style="color:#2aa198">&#34;loading [%s] with crc %u sequence %u version&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>       <span style="color:#586e75">// loading    
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75"></span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>       <span style="color:#586e75">// file not valid or empty, discard everything
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#586e75"></span>       SCOPED_LOCK(m_exclusiveProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>       m_output <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> CodedOutputData(ptr <span style="color:#719e07">+</span> Fixed32Size, m_file<span style="color:#719e07">-&gt;</span>getFileSize() <span style="color:#719e07">-</span> Fixed32Size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>       <span style="color:#719e07">if</span> (m_actualSize <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>           writeActualSize(<span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#719e07">nullptr</span>, IncreaseSequence);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>           sync(MMKV_SYNC);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>       } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>           writeActualSize(<span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, <span style="color:#719e07">nullptr</span>, KeepSequence);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>       }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>   }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>};
</code></pre></div><p>å…ˆçœ‹å¼‚å¸¸å¤„ç†ã€‚</p>
<p>å½“æ ¡éªŒå¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œç›´æ¥è°ƒç”¨ writeActualSize æ¸…ç† metaInfo ç¼“å­˜ã€‚</p>
<p>å¦‚æœæ–‡ä»¶å¼‚å¸¸ï¼Œä¼ å…¥ IncreaseSequence æ¥è®¾ç½® dirt bitï¼Œä»¥å¾…ä¸‹æ¬¡é‡è½½ m_fileã€‚</p>
<h3 id="loading">Loading</h3>
<p>å½“ loadFromFile ä¸º true ä¸”æ–‡ä»¶å†…å®¹ä¸ä¸ºç©ºï¼Œå°†æ•°æ®ä»å†…å­˜è¯»å…¥ MMBufferï¼Œè¿›è¡Œ AES è§£å¯†ã€æ¸…ç©º m_dicã€å‡†å¤‡ buffer æ•°æ®å†™å…¥ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75">// loading
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#586e75"></span>MMBuffer <span style="color:#268bd2">inputBuffer</span>(ptr <span style="color:#719e07">+</span> Fixed32Size, m_actualSize, MMBufferNoCopy);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">if</span> (m_crypter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    decryptBuffer(<span style="color:#719e07">*</span>m_crypter, inputBuffer);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>clearDictionary(m_dic);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">if</span> (needFullWriteback) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    MiniPBCoder<span style="color:#719e07">::</span>greedyDecodeMap(m_dic, inputBuffer);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>} <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    MiniPBCoder<span style="color:#719e07">::</span>decodeMap(m_dic, inputBuffer);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>m_output <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> CodedOutputData(ptr <span style="color:#719e07">+</span> Fixed32Size, m_file<span style="color:#719e07">-&gt;</span>getFileSize() <span style="color:#719e07">-</span> Fixed32Size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>m_output<span style="color:#719e07">-&gt;</span>seek(m_actualSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07">if</span> (needFullWriteback) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    fullWriteback();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>}
</code></pre></div><p>æ•°æ®å†™å…¥ m_dic åï¼Œåˆ›å»º CodedOutputData å¯¹è±¡æ¥è®°å½•å½“å‰æ˜ å°„çš„å†…å­˜æŒ‡é’ˆå’Œæ–‡ä»¶å¤§å°ï¼Œé€šè¿‡ seek æ¥è®°å½•è¯»å–çš„æ–‡ä»¶ä½ç½®ã€‚</p>
<p>æœ€åï¼Œå½“ needFullWriteback ä¸º true æ—¶è¿›è¡Œæ–‡ä»¶å†™å› <code>fullWriteback</code>ã€‚</p>
<p>å†™å…¥ç­–ç•¥åˆ†ä¸ºè´ªå©ªæ¨¡å¼å’Œæ™®é€šä¸¤ç§ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">void</span> MiniPBCoder<span style="color:#719e07">::</span>decodeMap(MMKVMap <span style="color:#719e07">&amp;</span>dic, <span style="color:#719e07">const</span> MMBuffer <span style="color:#719e07">&amp;</span>oData, size_t size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    MiniPBCoder <span style="color:#268bd2">oCoder</span>(<span style="color:#719e07">&amp;</span>oData);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    oCoder.decodeOneMap(dic, size, <span style="color:#b58900">false</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#dc322f">void</span> MiniPBCoder<span style="color:#719e07">::</span>greedyDecodeMap(MMKVMap <span style="color:#719e07">&amp;</span>dic, <span style="color:#719e07">const</span> MMBuffer <span style="color:#719e07">&amp;</span>oData, size_t size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    MiniPBCoder <span style="color:#268bd2">oCoder</span>(<span style="color:#719e07">&amp;</span>oData);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>    oCoder.decodeOneMap(dic, size, <span style="color:#b58900">true</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>}
</code></pre></div><p>åŒºåˆ«åœ¨äº greed ä¼šå°†æ‰€æœ‰ buffer è½¬æˆ k-v ä¿å­˜åœ¨ m_dic ä¸­ã€‚</p>
<p>åœ¨å‰é¢çš„æ•°æ®æ ¡éªŒä¸­å¯çŸ¥ï¼Œä»…å½“æ ¡éªŒå¤±è´¥ä¸”æ¢å¤ç­–ç•¥ä¸º <code>OnErrorRecover</code> ä¼šå°† <strong>needFullWriteback</strong> æ ‡è®°ä¸º tureã€‚å°±æ˜¯è¯´ï¼Œå½“æ•°æ®å¼‚å¸¸æˆ–ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šé‡‡ç”¨è´ªå©ªç­–ç•¥å°½å¯èƒ½çš„å°†æ•°æ®ä¼˜å…ˆè¯»å…¥å†…å­˜ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">void</span> MiniPBCoder<span style="color:#719e07">::</span>decodeOneMap(MMKVMap <span style="color:#719e07">&amp;</span>dic, size_t size, <span style="color:#dc322f">bool</span> greedy) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">auto</span> block <span style="color:#719e07">=</span> [size, <span style="color:#719e07">this</span>](MMKVMap <span style="color:#719e07">&amp;</span>dictionary) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">if</span> (size <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>            [[maybe_unused]] <span style="color:#719e07">auto</span> length <span style="color:#719e07">=</span> m_inputData<span style="color:#719e07">-&gt;</span>readInt32();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">while</span> (<span style="color:#719e07">!</span>m_inputData<span style="color:#719e07">-&gt;</span>isAtEnd()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>            <span style="color:#719e07">const</span> <span style="color:#719e07">auto</span> <span style="color:#719e07">&amp;</span>key <span style="color:#719e07">=</span> m_inputData<span style="color:#719e07">-&gt;</span>readString();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>            <span style="color:#719e07">if</span> (key.length <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>                <span style="color:#719e07">auto</span> value <span style="color:#719e07">=</span> m_inputData<span style="color:#719e07">-&gt;</span>readData();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>                <span style="color:#719e07">if</span> (value.length() <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>                    dictionary[key] <span style="color:#719e07">=</span> move(value);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>                    [key retain];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>                } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>                    <span style="color:#719e07">auto</span> itr <span style="color:#719e07">=</span> dictionary.find(key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>                    <span style="color:#719e07">if</span> (itr <span style="color:#719e07">!=</span> dictionary.end()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>                        dictionary.erase(itr);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>                        [itr<span style="color:#719e07">-&gt;</span>first release];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>                    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    };
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">if</span> (greedy) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        <span style="color:#719e07">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>            block(dic);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        } <span style="color:#719e07">catch</span> (std<span style="color:#719e07">::</span>exception <span style="color:#719e07">&amp;</span>exception) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>            MMKVError(<span style="color:#2aa198">&#34;%s&#34;</span>, exception.what());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>        <span style="color:#719e07">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>            MMKVMap tmpDic;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>            block(tmpDic);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>            dic.swap(tmpDic);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>            <span style="color:#719e07">for</span> (<span style="color:#719e07">auto</span> <span style="color:#719e07">&amp;</span>pair : tmpDic) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>                [pair.first release];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>        } <span style="color:#719e07">catch</span> (std<span style="color:#719e07">::</span>exception <span style="color:#719e07">&amp;</span>exception) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>            MMKVError(<span style="color:#2aa198">&#34;%s&#34;</span>, exception.what());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>}
</code></pre></div><h3 id="fullwriteback">fullWriteback</h3>
<p>å†™å› (write-back) ä½œä¸ºç¼“å­˜ç­–ç•¥ä¸­çš„ä¸€ç§ï¼Œå…¶æ¦‚å¿µå¯ä»¥æŸ¥çœ‹ <strong><a href="https://www.wikiwand.com/en/Cache_(computing)">wiki</a></strong>ï¼Œç®€å•æè¿°å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ä»…å½“ä¸€ä¸ªç¼“å­˜å—éœ€è¦è¢«æ›¿æ¢å›å†…å­˜æ—¶ï¼Œæ‰å°†å…¶å†…å®¹å†™å…¥å†…å­˜ã€‚è€Œä¸ºäº†å‡å°‘å†…å­˜å†™æ“ä½œï¼Œé€šè¿‡è„ä½æ ‡è¯†è¯¥å—åœ¨è¢«è½½å…¥ä¹‹åæ˜¯å¦å‘ç”Ÿè¿‡æ›´æ–°ã€‚å¦‚æœä¸€ä¸ªç¼“å­˜å—åœ¨è¢«ç½®æ¢å›å†…å­˜ä¹‹å‰ä»æœªè¢«å†™å…¥è¿‡ï¼Œåˆ™å¯ä»¥å…å»å›å†™æ“ä½œã€‚</p>
</blockquote>
<p>MMKV çš„å†™å›æ“ä½œå°±æ˜¯å°†å†…å­˜æ•°æ® m_dic åºåˆ—åŒ–åå†™å›æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>fullWriteback() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    ...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">auto</span> allData <span style="color:#719e07">=</span> MiniPBCoder<span style="color:#719e07">::</span>encodeDataWithObject(m_dic);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    SCOPED_LOCK(m_exclusiveProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> (allData.length() <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">auto</span> fileSize <span style="color:#719e07">=</span> m_file<span style="color:#719e07">-&gt;</span>getFileSize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">if</span> (allData.length() <span style="color:#719e07">+</span> Fixed32Size <span style="color:#719e07">&lt;=</span> fileSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>            <span style="color:#719e07">return</span> <span style="color:#268bd2">doFullWriteBack</span>(std<span style="color:#719e07">::</span>move(allData));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            <span style="color:#586e75">// ensureMemorySize will extend file &amp; full rewrite, no need to write back again
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>            <span style="color:#719e07">return</span> <span style="color:#268bd2">ensureMemorySize</span>(allData.length() <span style="color:#719e07">+</span> Fixed32Size <span style="color:#719e07">-</span> fileSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>}
</code></pre></div><p>æ“ä½œå‰ä¼šæ£€æŸ¥å‡ ä¸ªçŠ¶æ€ï¼š</p>
<ul>
<li>m_hasFullWritebackï¼šç›´æ¥ return true</li>
<li>m_needLoadFromFileï¼šç›´æ¥ return true</li>
<li>isFileValid() ä¸º falseï¼šç›´æ¥ return false</li>
<li>m_dic.empty() ï¼š<code>clearAll()</code> å return true</li>
</ul>
<p>æ—¢ç„¶æ˜¯æ•°æ®è¯»å–ï¼Œå¦‚æœ m_dic ä¸ºç©ºï¼Œè®¤ä¸ºæ•°æ®å¯èƒ½å‡ºç°å¼‚å¸¸ã€‚å°†ä¼šæ¸…ç†ä¸´æ—¶æ•°æ®å’Œå†…å­˜ç¼“å­˜ã€é‡ç½®ç›¸å…³æ ‡è®°ä½ã€é‡æ–°åŠ è½½æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>clearAll() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    MMKVInfo(<span style="color:#2aa198">&#34;cleaning all key-values from [%s]&#34;</span>, m_mmapID.c_str());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    SCOPED_LOCK(m_lock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    SCOPED_LOCK(m_exclusiveProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">if</span> (m_needLoadFromFile) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        m_file<span style="color:#719e07">-&gt;</span>reloadFromFile();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    m_file<span style="color:#719e07">-&gt;</span>truncate(DEFAULT_MMAP_SIZE);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">auto</span> ptr <span style="color:#719e07">=</span> m_file<span style="color:#719e07">-&gt;</span>getMemory();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#719e07">if</span> (ptr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        memset(ptr, <span style="color:#2aa198">0</span>, m_file<span style="color:#719e07">-&gt;</span>getFileSize());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    m_file<span style="color:#719e07">-&gt;</span>msync(MMKV_SYNC);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">char</span> newIV[AES_KEY_LEN];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    AESCrypt<span style="color:#719e07">::</span>fillRandomIV(newIV);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">if</span> (m_crypter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        m_crypter<span style="color:#719e07">-&gt;</span>resetIV(newIV, <span style="color:#719e07">sizeof</span>(newIV));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    writeActualSize(<span style="color:#2aa198">0</span>, <span style="color:#2aa198">0</span>, newIV, IncreaseSequence);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    m_metaFile<span style="color:#719e07">-&gt;</span>msync(MMKV_SYNC);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    clearMemoryCache();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    loadFromFile();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>}
</code></pre></div><p>æ£€æŸ¥é€šè¿‡åï¼Œå°† m_dic è½¬æ¢ä¸º <strong>MiniPBCoder</strong> å³ binary dataï¼Œå†™å…¥å‰ä¼šç¡®è®¤å½“å‰æ–‡ä»¶ size æ˜¯å¦è¶³å¤Ÿæ»¡è¶³å½“å‰æ•°æ®çš„å†™å…¥ï¼Œå¦åˆ™è¿›è¡Œæ‰©å®¹ã€‚</p>
<h3 id="dofullwriteback">doFullWriteBack</h3>
<p>é¦–å…ˆï¼Œç”Ÿæˆ AES éšæœº IV å¯¹ allData è¿›è¡ŒåŠ å¯†ï¼Œæ¥ç€é€šè¿‡ CodedOutputData æŠŠ MMBuffer å†™å…¥ m_fileï¼Œæœ€åæ›´æ–° crc æ ¡éªŒå€¼ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>doFullWriteBack(MMBuffer <span style="color:#719e07">&amp;&amp;</span>allData) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">#ifdef MMKV_IOS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07"></span>    <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">char</span> oldIV[AES_KEY_LEN];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">char</span> newIV[AES_KEY_LEN];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> (m_crypter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        memcpy(oldIV, m_crypter<span style="color:#719e07">-&gt;</span>m_vector, <span style="color:#719e07">sizeof</span>(oldIV));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07"></span>    <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">char</span> newIV[AES_KEY_LEN];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">if</span> (m_crypter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07"></span>        AESCrypt<span style="color:#719e07">::</span>fillRandomIV(newIV);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        m_crypter<span style="color:#719e07">-&gt;</span>resetIV(newIV, <span style="color:#719e07">sizeof</span>(newIV));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        <span style="color:#719e07">auto</span> ptr <span style="color:#719e07">=</span> allData.getPtr();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        m_crypter<span style="color:#719e07">-&gt;</span>encrypt(ptr, ptr, allData.length());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">auto</span> ptr <span style="color:#719e07">=</span> (<span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span>) m_file<span style="color:#719e07">-&gt;</span>getMemory();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    <span style="color:#719e07">delete</span> m_output;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    m_output <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> CodedOutputData(ptr <span style="color:#719e07">+</span> Fixed32Size, m_file<span style="color:#719e07">-&gt;</span>getFileSize() <span style="color:#719e07">-</span> Fixed32Size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">#ifdef MMKV_IOS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07"></span>    <span style="color:#719e07">auto</span> ret <span style="color:#719e07">=</span> protectFromBackgroundWriting(m_output<span style="color:#719e07">-&gt;</span>curWritePointer(), allData.length(), <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      m_output<span style="color:#719e07">-&gt;</span>writeRawData(allData); <span style="color:#586e75">// note: don&#39;t write size of data
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span><span style="color:#586e75"></span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>ret) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        <span style="color:#586e75">// revert everything
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span><span style="color:#586e75"></span>        <span style="color:#719e07">if</span> (m_crypter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>            m_crypter<span style="color:#719e07">-&gt;</span>resetIV(oldIV);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>        <span style="color:#719e07">delete</span> m_output;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>        m_output <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> CodedOutputData(ptr <span style="color:#719e07">+</span> Fixed32Size, m_file<span style="color:#719e07">-&gt;</span>getFileSize() <span style="color:#719e07">-</span> Fixed32Size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>        m_output<span style="color:#719e07">-&gt;</span>seek(m_actualSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span><span style="color:#719e07"></span>    m_output<span style="color:#719e07">-&gt;</span>writeRawData(allData); <span style="color:#586e75">// note: don&#39;t write size of data
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span><span style="color:#586e75"></span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span><span style="color:#719e07"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>    m_actualSize <span style="color:#719e07">=</span> allData.length();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>    <span style="color:#719e07">if</span> (m_crypter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>        recaculateCRCDigestWithIV(newIV);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>        recaculateCRCDigestWithIV(<span style="color:#719e07">nullptr</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44</span>    m_hasFullWriteback <span style="color:#719e07">=</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45</span>    <span style="color:#586e75">// make sure lastConfirmedMetaInfo is saved
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">46</span><span style="color:#586e75"></span>    sync(MMKV_SYNC);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">47</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">48</span>}
</code></pre></div><h3 id="recaculatecrcdigestwithiv">recaculateCRCDigestWithIV</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>recaculateCRCDigestWithIV(<span style="color:#719e07">const</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>iv) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">auto</span> ptr <span style="color:#719e07">=</span> (<span style="color:#719e07">const</span> <span style="color:#dc322f">uint8_t</span> <span style="color:#719e07">*</span>) m_file<span style="color:#719e07">-&gt;</span>getMemory();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">if</span> (ptr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    m_crcDigest <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    m_crcDigest <span style="color:#719e07">=</span> (<span style="color:#dc322f">uint32_t</span>) CRC32(<span style="color:#2aa198">0</span>, ptr <span style="color:#719e07">+</span> Fixed32Size, (<span style="color:#dc322f">uint32_t</span>) m_actualSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    writeActualSize(m_actualSize, m_crcDigest, iv, IncreaseSequence);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>}
</code></pre></div><p>æ³¨æ„ï¼Œé‡æ–°ç”Ÿæˆ crc digest è¿™ä¸€è¡Œä¸ºåªæœ‰åœ¨ full write-back ä¸­è¢«è°ƒç”¨ã€‚å°½ç®¡è¿™é‡Œè°ƒç”¨ writeActualSize æ›´æ–° m_metaInfo å¹¶å¢åŠ äº† m_sequenceï¼Œ<strong>ä½†æ˜¯ actualSize å¹¶æ²¡æœ‰å˜åŒ–</strong>ã€‚</p>
<h3 id="ensurememorysize">ensureMemorySize</h3>
<p>é™¤äº†å®Œå…¨å†™å›çš„æƒ…å†µï¼Œå½“ append çš„æ•°æ®è¶…å‡º fileSize ä¹Ÿä¼šè¿›è¡Œæ‰©å®¹ã€‚æ‰©å®¹ç­–ç•¥ä»¥ 2 å€äºåŸæ¥çš„ fileSizeï¼Œä¸æ–­æ‰©å……ï¼Œç›´åˆ°æ¯”æ‰©å……çš„é¢å¤–å®¹é‡å¤§ä¸ºæ­¢ã€‚æœ€åé€šè¿‡ truncate è£å‰ªè‡³ <code>DEFAULT_MMAP_SIZE</code> çš„æ•´æ•°å€ã€‚</p>
<p>æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">constexpr</span> size_t ItemSizeHolderSize <span style="color:#719e07">=</span> <span style="color:#2aa198">4</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">if</span> (m_dic.empty()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    newSize <span style="color:#719e07">+=</span> ItemSizeHolderSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">if</span> (newSize <span style="color:#719e07">&gt;=</span> m_output<span style="color:#719e07">-&gt;</span>spaceLeft() <span style="color:#719e07">||</span> m_dic.empty()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">auto</span> fileSize <span style="color:#719e07">=</span> m_file<span style="color:#719e07">-&gt;</span>getFileSize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    MMBuffer data <span style="color:#719e07">=</span> MiniPBCoder<span style="color:#719e07">::</span>encodeDataWithObject(m_dic);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    size_t lenNeeded <span style="color:#719e07">=</span> data.length() <span style="color:#719e07">+</span> Fixed32Size <span style="color:#719e07">+</span> newSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    size_t avgItemSize <span style="color:#719e07">=</span> lenNeeded <span style="color:#719e07">/</span> std<span style="color:#719e07">::</span>max<span style="color:#719e07">&lt;</span>size_t<span style="color:#719e07">&gt;</span>(<span style="color:#2aa198">1</span>, m_dic.size());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    size_t futureUsage <span style="color:#719e07">=</span> avgItemSize <span style="color:#719e07">*</span> std<span style="color:#719e07">::</span>max<span style="color:#719e07">&lt;</span>size_t<span style="color:#719e07">&gt;</span>(<span style="color:#2aa198">8</span>, (m_dic.size() <span style="color:#719e07">+</span> <span style="color:#2aa198">1</span>) <span style="color:#719e07">/</span> <span style="color:#2aa198">2</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>	<span style="color:#586e75">// æ‰€éœ€ç©ºé—´ &gt;= å½“å‰æ–‡ä»¶å¤§å° || æ‰€éœ€ç©ºé—´çš„ 1.5 å€äºå½“å‰æ–‡ä»¶å¤§å°
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#586e75"></span>    <span style="color:#719e07">if</span> (lenNeeded <span style="color:#719e07">&gt;=</span> fileSize <span style="color:#719e07">||</span> (lenNeeded <span style="color:#719e07">+</span> futureUsage) <span style="color:#719e07">&gt;=</span> fileSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        size_t oldSize <span style="color:#719e07">=</span> fileSize;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">do</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>            fileSize <span style="color:#719e07">*=</span> <span style="color:#2aa198">2</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        } <span style="color:#719e07">while</span> (lenNeeded <span style="color:#719e07">+</span> futureUsage <span style="color:#719e07">&gt;=</span> fileSize);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>m_file<span style="color:#719e07">-&gt;</span>truncate(fileSize)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>            <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>isFileValid()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>            MMKVWarning(<span style="color:#2aa198">&#34;[%s] file not valid&#34;</span>, m_mmapID.c_str());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>            <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>    <span style="color:#719e07">return</span> <span style="color:#268bd2">doFullWriteBack</span>(std<span style="color:#719e07">::</span>move(data));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>}
</code></pre></div><h1 id="setter">Setter</h1>
<p>æ”¹ç‰ˆå iOS ç«¯çš„ setter åˆ™ç›´æ¥åœ¨ C++ API ä¸Šå¥—äº†ä¸€å±‚ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">bool</span> <span style="color:#268bd2">set</span>(<span style="color:#dc322f">bool</span> value, MMKVKey_t key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#586e75">// avoid unexpected type conversion (pointer to bool, etc)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span><span style="color:#719e07">template</span> <span style="color:#719e07">&lt;</span><span style="color:#719e07">typename</span> T<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#dc322f">bool</span> set(T value, MMKVKey_t key) <span style="color:#719e07">=</span> <span style="color:#719e07">delete</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#dc322f">bool</span> <span style="color:#268bd2">set</span>(NSObject<span style="color:#719e07">&lt;</span>NSCoding<span style="color:#719e07">&gt;</span> <span style="color:#719e07">*</span>__unsafe_unretained obj, MMKVKey_t key);
</code></pre></div><p>å…ˆä»¥ bool ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>set(<span style="color:#dc322f">bool</span> value, MMKVKey_t key) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (isKeyEmpty(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    size_t size <span style="color:#719e07">=</span> pbBoolSize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    MMBuffer <span style="color:#268bd2">data</span>(size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    CodedOutputData <span style="color:#268bd2">output</span>(data.getPtr(), size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    output.writeBool(value);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">return</span> <span style="color:#268bd2">setDataForKey</span>(std<span style="color:#719e07">::</span>move(data), key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>}
</code></pre></div><p>value é€šè¿‡ CodedOutputData å†™å…¥ MMBufferï¼Œæœ€åèµ°å‘äº† setDataForKeyã€‚å…¶ä»–æ•°æ®ç±»å‹ä¹Ÿæ˜¯ä¸€æ ·å¥—è·¯ã€‚</p>
<h2 id="setdataforkey">setDataForKey</h2>
<p>æ›´æ–° k-v çš„æ ¸å¿ƒæ–¹æ³•ï¼Œæ‰¿æ¥äº†å…¨éƒ¨æ•°æ®æ›´æ–°çš„å…¥å£ï¼Œåšäº†ä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>æ•°æ®æ ¡éªŒï¼Œç¡®è®¤æ˜¯å¦éœ€è¦åˆ·æ–°ç¼“å­˜ï¼Œé‡æ–°åŠ è½½æ–‡ä»¶ï¼›</li>
<li>å°† buffer æ•°æ®å†™å…¥æ–‡ä»¶ï¼›</li>
<li>æ›´æ–° m_dic;</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>setDataForKey(MMBuffer <span style="color:#719e07">&amp;&amp;</span>data, MMKVKey_t key) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (data.length() <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">||</span> isKeyEmpty(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    SCOPED_LOCK(m_lock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    SCOPED_LOCK(m_exclusiveProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    checkLoadData();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">auto</span> ret <span style="color:#719e07">=</span> appendDataWithKey(data, key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">if</span> (ret) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        m_dic[key] <span style="color:#719e07">=</span> std<span style="color:#719e07">::</span>move(data);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        m_hasFullWriteback <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">#ifdef MMKV_APPLE
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07"></span>        [key retain];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07"></span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">return</span> ret;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>}
</code></pre></div><p>æ•´ä¸ª MMKV.cpp æ–‡ä»¶ä¸­å°±è¿™æ–¹æ³•é‡Œå†’å‡ºæ¥ä¸€è¡Œ <strong>[key retain]</strong>ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºå•¥è¿™é‡Œ MMKV.cpp é‡‡ç”¨ MRC çš„åŸå› ã€‚è‡³äºä¸ºå•¥è¦ retain å¤§å®¶å¯ä»¥ ğŸ¤” ä¸€ä¸‹ã€‚</p>
<h3 id="checkloaddata">checkLoadData</h3>
<p>æ•°æ®æ ¡éªŒï¼Œç¬¬ä¸€æ­¥æ˜¯ç¡®è®¤ m_needLoadFromFile ä¸º trueï¼Œæ˜¯åˆ™åŠ é”æ‰§è¡Œ loadFromFileã€‚</p>
<p>æ¥ä¸‹æ¥çš„æ£€æŸ¥æ˜¯é˜²æ­¢æ–‡ä»¶è¢«å…¶ä»–è¿›ç¨‹ç¯¡æ”¹ï¼Œå¯¹äºå•è¿›ç¨‹åˆ™æ— éœ€è€ƒè™‘è¯¥ caseï¼Œç›´æ¥ returnã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">void</span> MMKV<span style="color:#719e07">::</span>checkLoadData() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (m_needLoadFromFile) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        SCOPED_LOCK(m_sharedProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        m_needLoadFromFile <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        loadFromFile();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>m_isInterProcess) { <span style="color:#586e75">// single process
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>m_metaFile<span style="color:#719e07">-&gt;</span>isFileValid()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#586e75">// TODO: atomic lock m_metaFile?
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#586e75"></span>    MMKVMetaInfo metaInfo;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    metaInfo.read(m_metaFile<span style="color:#719e07">-&gt;</span>getMemory());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_sequence <span style="color:#719e07">!=</span> metaInfo.m_sequence) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        MMKVInfo(<span style="color:#2aa198">&#34;[%s] oldSeq %u, newSeq %u&#34;</span>, ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        SCOPED_LOCK(m_sharedProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        clearMemoryCache();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>        loadFromFile();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        notifyContentChanged();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    } <span style="color:#719e07">else</span> <span style="color:#268bd2">if</span> (m_metaInfo<span style="color:#719e07">-&gt;</span>m_crcDigest <span style="color:#719e07">!=</span> metaInfo.m_crcDigest) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        MMKVDebug(<span style="color:#2aa198">&#34;[%s] oldCrc %u, newCrc %u, new actualSize&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>        SCOPED_LOCK(m_sharedProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>        size_t fileSize <span style="color:#719e07">=</span> m_file<span style="color:#719e07">-&gt;</span>getActualFileSize();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>        <span style="color:#719e07">if</span> (m_file<span style="color:#719e07">-&gt;</span>getFileSize() <span style="color:#719e07">!=</span> fileSize) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>            MMKVInfo(<span style="color:#2aa198">&#34;file size has changed [%s] from %zu to %zu&#34;</span> ...);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>            clearMemoryCache();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>            loadFromFile();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>        } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>            partialLoadFromFile();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>        notifyContentChanged();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>}
</code></pre></div><p>é˜²æ­¢æ–‡ä»¶çš„å¤šè¿›ç¨‹ç¯¡æ”¹ï¼Œä¼šå…ˆè¯»å– crc æ–‡ä»¶ä¸­è®°å½•çš„ metaInfo ä¸å½“å‰å†…å­˜çš„ m_metaInfo å¯¹æ¯”ã€‚metaInfo ä¸­çš„æ•°æ®æ›´æ–°éƒ½åœ¨ writeActualSize ä¸­å®Œæˆã€‚è€Œå½“æ–‡ä»¶è¯»å–å¼‚å¸¸ã€ç©ºé—´ä¸è¶³æˆ– crc æ ¡éªŒå¤±è´¥ï¼Œè¿™äº›æƒ…å†µå‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘ meta_info çš„å˜æ›´ã€‚å…·ä½“å¤„ç†ï¼š</p>
<ol>
<li>m_sequence ä»£è¡¨äº†è„ä½æ•°æ® dirt bit å­˜åœ¨ï¼Œæ­¤æ—¶éœ€è¦ é‡æ–°åŠ è½½ m_fileã€‚</li>
<li>m_crcDigest ä¸åŒä¸” fileSize ä¸åŒï¼Œè¯´æ˜è¿›è¡Œäº†æ‰©å®¹ï¼Œä¹Ÿéœ€è¦é‡æ–°åŠ è½½ m_fileã€‚</li>
<li>m_crcDigest ä¸åŒä¸” fileSize ç›¸åŒï¼Œè¯´æ˜è¿›è¡Œäº† full write-backï¼Œä¹‹åä¼šé€šè¿‡ <code>partialLoadFromFile</code> å®Œæˆç›¸å…³å†…å­˜æ•°æ®çš„æ›´æ–°ã€‚</li>
</ol>
<h3 id="appenddata">appendData</h3>
<p>å®˜æ–¹è¯´æ˜</p>
<blockquote>
<p>æ ‡å‡† protobuf ä¸æä¾›å¢é‡æ›´æ–°çš„èƒ½åŠ›ï¼Œæ¯æ¬¡å†™å…¥éƒ½å¿…é¡»å…¨é‡å†™å…¥ã€‚è€ƒè™‘åˆ°ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯é¢‘ç¹åœ°è¿›è¡Œå†™å…¥æ›´æ–°ï¼Œæˆ‘ä»¬éœ€è¦æœ‰å¢é‡æ›´æ–°çš„èƒ½åŠ›ï¼šå°†å¢é‡ kv å¯¹è±¡åºåˆ—åŒ–åï¼Œç›´æ¥ append åˆ°å†…å­˜æœ«å°¾ï¼›è¿™æ ·åŒä¸€ä¸ª key ä¼šæœ‰æ–°æ—§è‹¥å¹²ä»½æ•°æ®ï¼Œæœ€æ–°çš„æ•°æ®åœ¨æœ€åï¼›é‚£ä¹ˆåªéœ€åœ¨ç¨‹åºå¯åŠ¨ç¬¬ä¸€æ¬¡æ‰“å¼€ mmkv æ—¶ï¼Œä¸æ–­ç”¨åè¯»å…¥çš„ value æ›¿æ¢ä¹‹å‰çš„å€¼ï¼Œå°±å¯ä»¥ä¿è¯æ•°æ®æ˜¯æœ€æ–°æœ‰æ•ˆçš„ã€‚</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>appendDataWithKey(<span style="color:#719e07">const</span> MMBuffer <span style="color:#719e07">&amp;</span>data, MMKVKey_t key) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">#ifdef MMKV_APPLE
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07"></span>    <span style="color:#719e07">auto</span> keyData <span style="color:#719e07">=</span> [key dataUsingEncoding:NSUTF8StringEncoding];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    size_t keyLength <span style="color:#719e07">=</span> keyData.length;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07"></span>    size_t keyLength <span style="color:#719e07">=</span> key.length();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07"></span>    <span style="color:#586e75">// size needed to encode the key
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>    size_t size <span style="color:#719e07">=</span> keyLength <span style="color:#719e07">+</span> pbRawVarint32Size((<span style="color:#dc322f">int32_t</span>) keyLength);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#586e75">// size needed to encode the value
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>    size <span style="color:#719e07">+=</span> data.length() <span style="color:#719e07">+</span> pbRawVarint32Size((<span style="color:#dc322f">int32_t</span>) data.length());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    SCOPED_LOCK(m_exclusiveProcessLock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#dc322f">bool</span> hasEnoughSize <span style="color:#719e07">=</span> ensureMemorySize(size);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>hasEnoughSize <span style="color:#719e07">||</span> <span style="color:#719e07">!</span>isFileValid()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">#ifdef MMKV_IOS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07"></span>    <span style="color:#719e07">auto</span> ret <span style="color:#719e07">=</span> protectFromBackgroundWriting(m_output<span style="color:#719e07">-&gt;</span>curWritePointer(), size, <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      m_output<span style="color:#719e07">-&gt;</span>writeData(MMBuffer(keyData, MMBufferNoCopy));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      m_output<span style="color:#719e07">-&gt;</span>writeData(data); <span style="color:#586e75">// note: write size of data
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span><span style="color:#586e75"></span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>ret) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span><span style="color:#719e07"></span>    ... <span style="color:#586e75">/// é™¤äº† iOS éœ€è¦åˆ¤æ–­ background modeï¼Œå…¶ä½™å‡ç›´æ¥ m_output-&gt;writeData(data);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span><span style="color:#586e75"></span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span><span style="color:#719e07"></span>    ... <span style="color:#586e75">// encrypt æ•°æ®ï¼Œæ›´æ–° m_actualSizeã€crcDigest
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span><span style="color:#586e75"></span>    <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>}
</code></pre></div><p>è¿½åŠ é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†å­˜å‚¨ Keyã€Data çš„ MMBuffer ç»è¿‡ pb å‹ç¼©åå†™å…¥ m_fileã€‚ç›´æ¥è¿½åŠ åˆ° m_file æœ«å°¾å¸¦æ¥çš„é—®é¢˜å°±æ˜¯ç©ºé—´å¿«é€Ÿå¢é•¿ï¼Œå¯¼è‡´æ–‡ä»¶å¤§å°ä¸å¯æ§ã€‚å› æ­¤ï¼Œæ¯æ¬¡å†™å…¥éœ€è¦æ£€æŸ¥å‰©ä½™æ–‡ä»¶ç©ºé—´ã€‚</p>
<h3 id="set-object">Set Object</h3>
<p>å†æ¥çœ‹çœ‹ Objc ä¸­çš„ NSObject æ˜¯å¦‚ä½•å­˜å–çš„ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>set(NSObject<span style="color:#719e07">&lt;</span>NSCoding<span style="color:#719e07">&gt;</span> <span style="color:#719e07">*</span>__unsafe_unretained obj, MMKVKey_t key) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (isKeyEmpty(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>obj) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        removeValueForKey(key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    MMBuffer data;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">if</span> (MiniPBCoder<span style="color:#719e07">::</span>isCompatibleObject(obj)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        data <span style="color:#719e07">=</span> MiniPBCoder<span style="color:#719e07">::</span>encodeDataWithObject(obj);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        <span style="color:#586e75">/*if ([object conformsToProtocol:@protocol(NSCoding)])*/</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>            <span style="color:#719e07">auto</span> tmp <span style="color:#719e07">=</span> [NSKeyedArchiver archivedDataWithRootObject:obj];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>            <span style="color:#719e07">if</span> (tmp.length <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>                data <span style="color:#719e07">=</span> MMBuffer(tmp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    <span style="color:#719e07">return</span> <span style="color:#268bd2">setDataForKey</span>(std<span style="color:#719e07">::</span>move(data), key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>}
</code></pre></div><p>å¯¹ Objc è€Œè¨€ MiniPBCoder ä»…æ”¯æŒäº†åŸºæœ¬æ•°æ®ç±»å‹å’Œ NSStringã€NSDataã€NSDate è¿™ä¸‰ç§ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MiniPBCoder<span style="color:#719e07">::</span>isCompatibleObject(NSObject <span style="color:#719e07">*</span>obj) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> ([obj isKindOfClass:[NSString <span style="color:#719e07">class</span>]]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> ([obj isKindOfClass:[NSData <span style="color:#719e07">class</span>]]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">if</span> ([obj isKindOfClass:[NSDate <span style="color:#719e07">class</span>]]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">return</span> <span style="color:#b58900">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>}
</code></pre></div><p>å…¶ä½™ NSObject å¯¹è±¡å°±éœ€è¦èµ° NSCoding åè®®é€šè¿‡ NSArchive æ–¹å¼ç¼–ç ä¸º NSData å­˜å…¥ã€‚</p>
<h1 id="getter">Getter</h1>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">bool</span> <span style="color:#268bd2">getBool</span>(MMKVKey_t key, <span style="color:#dc322f">bool</span> defaultValue <span style="color:#719e07">=</span> <span style="color:#b58900">false</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">#ifdef MMKV_APPLE
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07"></span>    NSObject <span style="color:#719e07">*</span>getObject(MMKVKey_t key, Class cls);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07">#else  </span><span style="color:#586e75">// !defined(MMKV_APPLE)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#586e75"></span>    mmkv<span style="color:#719e07">::</span>MMBuffer getBytes(MMKVKey_t key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>    <span style="color:#dc322f">bool</span> <span style="color:#268bd2">getVector</span>(MMKVKey_t key, std<span style="color:#719e07">::</span>vector<span style="color:#719e07">&lt;</span>std<span style="color:#719e07">::</span>string<span style="color:#719e07">&gt;</span> <span style="color:#719e07">&amp;</span>result);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">#endif </span><span style="color:#586e75">// MMKV_APPLE
</span></code></pre></div><p>ä»¥ bool ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">bool</span> MMKV<span style="color:#719e07">::</span>getBool(MMKVKey_t key, <span style="color:#dc322f">bool</span> defaultValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (isKeyEmpty(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> defaultValue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    SCOPED_LOCK(m_lock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">auto</span> <span style="color:#719e07">&amp;</span>data <span style="color:#719e07">=</span> getDataForKey(key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">if</span> (data.length() <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        <span style="color:#719e07">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>            CodedInputData <span style="color:#268bd2">input</span>(data.getPtr(), data.length());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            <span style="color:#719e07">return</span> input.readBool();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        } <span style="color:#719e07">catch</span> (std<span style="color:#719e07">::</span>exception <span style="color:#719e07">&amp;</span>exception) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>            MMKVError(<span style="color:#2aa198">&#34;%s&#34;</span>, exception.what());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#719e07">return</span> defaultValue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>}
</code></pre></div><p>æ•°æ®è¯»å–å°±æ›´ç®€å•äº†ï¼Œç›´æ¥ä» getDataForKey ä¸­å–å‡º MMBufferï¼Œç»è¿‡ CodedOutputData è½¬æ¢å¾—åˆ° boolã€‚</p>
<h2 id="getdataforkey">getDataForKey</h2>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">const</span> MMBuffer <span style="color:#719e07">&amp;</span>MMKV<span style="color:#719e07">::</span>getDataForKey(MMKVKey_t key) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    checkLoadData();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">auto</span> itr <span style="color:#719e07">=</span> m_dic.find(key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#719e07">if</span> (itr <span style="color:#719e07">!=</span> m_dic.end()) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>        <span style="color:#719e07">return</span> itr<span style="color:#719e07">-&gt;</span>second;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    <span style="color:#719e07">static</span> MMBuffer nan;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>    <span style="color:#719e07">return</span> nan;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>}
</code></pre></div><h2 id="get-object">Get Object</h2>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>NSObject <span style="color:#719e07">*</span>MMKV<span style="color:#719e07">::</span>getObject(MMKVKey_t key, Class cls) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (isKeyEmpty(key) <span style="color:#719e07">||</span> <span style="color:#719e07">!</span>cls) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">return</span> nil;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    SCOPED_LOCK(m_lock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">auto</span> <span style="color:#719e07">&amp;</span>data <span style="color:#719e07">=</span> getDataForKey(key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">if</span> (data.length() <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        <span style="color:#719e07">if</span> (MiniPBCoder<span style="color:#719e07">::</span>isCompatibleClass(cls)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>            <span style="color:#719e07">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>                <span style="color:#719e07">auto</span> result <span style="color:#719e07">=</span> MiniPBCoder<span style="color:#719e07">::</span>decodeObject(data, cls);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>                <span style="color:#719e07">return</span> result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>            } <span style="color:#719e07">catch</span> (std<span style="color:#719e07">::</span>exception <span style="color:#719e07">&amp;</span>exception) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>                MMKVError(<span style="color:#2aa198">&#34;%s&#34;</span>, exception.what());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>            <span style="color:#719e07">if</span> ([cls conformsToProtocol:@protocol(NSCoding)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>                <span style="color:#719e07">auto</span> tmp <span style="color:#719e07">=</span> [NSData dataWithBytesNoCopy:data.getPtr() length:data.length() freeWhenDone:NO];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>                <span style="color:#719e07">return</span> [NSKeyedUnarchiver unarchiveObjectWithData:tmp];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    <span style="color:#719e07">return</span> nil;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>}
</code></pre></div><p>è¿™ä¸ªä¹Ÿæ¯”è¾ƒç®€å•å°±ä¸å±•å¼€äº†ã€‚</p>
<h2 id="æ€»ç»“"><strong>æ€»ç»“</strong></h2>
<p><strong>å®å¯é”™æ€ä¸€åƒï¼Œä¹Ÿç»ä¸æ”¾è¿‡ä¸€ä¸ªã€‚</strong></p>
<p>è¿™æ˜¯æ•´ä½“è¯»å®Œ MMKV æ ¸å¿ƒé€»è¾‘çš„ç¬¬ä¸€æ„Ÿå—ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>MMKV ä½œä¸ºå¤šè¿›ç¨‹è¯»å†™çš„æ¡†æ¶ã€‚ç»†å¿ƒçš„åŒå­¦å¯ä»¥å‘ç°ï¼Œåœ¨å®ƒçš„æ¯ä¸€ä¸ªæ–¹æ³•çš„çœŸæ­£é€»è¾‘æ‰§è¡Œå‰éƒ½è¿›è¡Œäº†å¤§é‡çš„å¼‚å¸¸æ ¡éªŒï¼ŒåŒæ—¶å¯¹äºè„æ•°æ®çš„ä¿æŠ¤å’Œå®¹é”™ä¹Ÿæ¯”è¾ƒç»•ã€‚æ„Ÿè§‰ä½ ä¸æŠŠæ‰€æœ‰æ–¹æ³•çœ‹è¿‡ä¸€éï¼Œæ¯”è¾ƒéš¾ get åˆ°å…¶ä¸­çš„ç”¨æ„ã€‚ç›¸æ¯”è¿™ä¸€ç‚¹ï¼Œ<a href="https://juejin.im/post/5eafe0796fb9a0438c2550e3">CocoaLumberjack</a> çš„ä»£ç å°±éå¸¸å‹å¥½äº†ï¼Œæ¯ä¸ªå…³é”®å­—æ®µçš„ä½œç”¨ï¼Œæ ¸å¿ƒé€»è¾‘çš„è§£é‡Šï¼Œä»¥åŠèƒŒåçš„ä¸€äº›åŸç†éƒ½æœ‰å¾ˆè¯¦ç»†çš„æ³¨é‡Šã€‚</p>
<p>æœ¬æ–‡å¿½ç•¥äº† MiniPB çš„ç¼–è§£ç é€»è¾‘å’Œè¯»å†™é”ä¿æŠ¤ï¼Œä»¥æ ¸å¿ƒé€»è¾‘æ–‡ä»¶è¯»å†™ä¸ºä¸»ã€‚MMKV å¯¹äºåªè¦å¼‚å¸¸å°±æ˜¯å„ç§æ ‡è®°ï¼Œç„¶åé‡è½½ã€‚æ•´ä¸ªæ¡†æ¶ä¹Ÿæ˜¯å›´ç»• loadFromFile ä¸æ–­çš„æ·»åŠ ä¿æŠ¤ï¼Œæ–‡ä»¶é”ï¼Œcrc æ ¡éªŒï¼Œè„æ•°æ®å†™å›ã€‚</p>
<p>å¦‚æœä½ çœ‹åˆ°è¿™é‡Œï¼Œåº”è¯¥èƒ½å‘ç°ï¼Œæœ¬æ–‡æ˜¯æŒ‰ç…§è°ƒç”¨é€»è¾‘ä¸€å±‚å±‚æ·±å…¥ï¼Œå°½å¯èƒ½åœ°è®©å„ä¸ªæ–¹æ³•çš„ä¸Šä¸‹æ–‡æ˜¯è¡”æ¥æœ‰åºã€‚å¸Œæœ›èƒ½å¸®åŠ©å„ä½å¤§è‡´äº†è§£ MMKV çš„æ ¸å¿ƒé€»è¾‘ã€‚</p>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/source-code">Source Code</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/cache">Cache</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/sourcecode-cocoapods/01-cocoapods-toolchains/"><span>â†</span><span>1. ç‰ˆæœ¬ç®¡ç†å·¥å…·åŠ Ruby å·¥å…·é“¾ç¯å¢ƒ</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-3/"><span>æµ…æ - CocoaLumberjack 3.6 ä¹‹ DatabaseLogger</span><span>â†’</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugoï¸ï¸</a>ï¸</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
