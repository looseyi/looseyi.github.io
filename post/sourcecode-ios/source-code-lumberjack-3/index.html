<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>æµ…æ - CocoaLumberjack 3.6 ä¹‹ DatabaseLogger - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="åœŸåœŸEdmondæœ¨" /><meta name="description" content="å‰è¨€ è¿™æ˜¯ DDLog æºç é˜…è¯»çš„æœ€åä¸€ç¯‡ã€‚æœ¬ç¯‡é‡ç‚¹ä»‹ç» DDLogger å¯¹æ•°æ®åº“å­˜å‚¨çš„æ”¯æŒï¼ŒåŸç†åº”è¯¥å’Œ FileLogger ä¸€æ ·ï¼Œlog ç£ç›˜å­˜å‚¨çš„é¢‘ç‡ï¼Œè¿‡æœŸ log çš„æ·˜æ±°ç­–ç•¥ï¼Œä»¥åŠ log å­˜å‚¨çš„ç¼“å­˜ç­–" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.62.0 with theme even" />


<link rel="canonical" href="http://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-3/" />
  <link href="http://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-3/index.xml" rel="alternate" type="application/rss+xml" title="" />
  <link href="http://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-3/index.xml" rel="feed" type="application/rss+xml" title="" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DatabaseLogger" />
<meta property="og:description" content="å‰è¨€ è¿™æ˜¯ DDLog æºç é˜…è¯»çš„æœ€åä¸€ç¯‡ã€‚æœ¬ç¯‡é‡ç‚¹ä»‹ç» DDLogger å¯¹æ•°æ®åº“å­˜å‚¨çš„æ”¯æŒï¼ŒåŸç†åº”è¯¥å’Œ FileLogger ä¸€æ ·ï¼Œlog ç£ç›˜å­˜å‚¨çš„é¢‘ç‡ï¼Œè¿‡æœŸ log çš„æ·˜æ±°ç­–ç•¥ï¼Œä»¥åŠ log å­˜å‚¨çš„ç¼“å­˜ç­–" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-3/" />
<meta property="article:published_time" content="2020-05-16T00:00:00+08:00" />
<meta property="article:modified_time" content="2020-05-16T00:00:00+08:00" />
<meta itemprop="name" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DatabaseLogger">
<meta itemprop="description" content="å‰è¨€ è¿™æ˜¯ DDLog æºç é˜…è¯»çš„æœ€åä¸€ç¯‡ã€‚æœ¬ç¯‡é‡ç‚¹ä»‹ç» DDLogger å¯¹æ•°æ®åº“å­˜å‚¨çš„æ”¯æŒï¼ŒåŸç†åº”è¯¥å’Œ FileLogger ä¸€æ ·ï¼Œlog ç£ç›˜å­˜å‚¨çš„é¢‘ç‡ï¼Œè¿‡æœŸ log çš„æ·˜æ±°ç­–ç•¥ï¼Œä»¥åŠ log å­˜å‚¨çš„ç¼“å­˜ç­–">
<meta itemprop="datePublished" content="2020-05-16T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-05-16T00:00:00&#43;08:00" />
<meta itemprop="wordCount" content="4321">



<meta itemprop="keywords" content="Source Code,iOS,Logger," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DatabaseLogger"/>
<meta name="twitter:description" content="å‰è¨€ è¿™æ˜¯ DDLog æºç é˜…è¯»çš„æœ€åä¸€ç¯‡ã€‚æœ¬ç¯‡é‡ç‚¹ä»‹ç» DDLogger å¯¹æ•°æ®åº“å­˜å‚¨çš„æ”¯æŒï¼ŒåŸç†åº”è¯¥å’Œ FileLogger ä¸€æ ·ï¼Œlog ç£ç›˜å­˜å‚¨çš„é¢‘ç‡ï¼Œè¿‡æœŸ log çš„æ·˜æ±°ç­–ç•¥ï¼Œä»¥åŠ log å­˜å‚¨çš„ç¼“å­˜ç­–"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Aha Moment</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Aha Moment</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">æµ…æ - CocoaLumberjack 3.6 ä¹‹ DatabaseLogger</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-05-16 </span>
        <div class="post-category">
            <a href="/categories/ios/"> iOS </a>
            </div>
          <span class="more-meta"> çº¦ 4321 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 9 åˆ†é’Ÿ </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#heading">å‰è¨€</a></li>
  </ul>

  <ul>
    <li><a href="#timer-">Timer çš„ç”Ÿå‘½å‘¨æœŸ</a>
      <ul>
        <li><a href="#createsuspendedsavetimer">createSuspendedSaveTimer</a></li>
        <li><a href="#updateandresumesavetimer">updateAndResumeSaveTimer</a></li>
        <li><a href="#destroysavetimer">destroySaveTimer</a></li>
        <li><a href="#createandstartdeletetimer">createAndStartDeleteTimer</a></li>
        <li><a href="#updatedeletetimer">updateDeleteTimer</a></li>
        <li><a href="#destroydeletetimer">destroyDeleteTimer</a></li>
      </ul>
    </li>
    <li><a href="#configuration">Configuration</a>
      <ul>
        <li><a href="#setsavethreshold">setSaveThreshold</a></li>
        <li><a href="#setsaveinterval">setSaveInterval</a></li>
        <li><a href="#setmaxage">setMaxAge</a></li>
        <li><a href="#setdeleteinterval">setDeleteInterval</a></li>
      </ul>
    </li>
    <li><a href="#save--delete">Save & Delete</a>
      <ul>
        <li><a href="#public-api">Public API</a></li>
        <li><a href="#performsaveandsuspendsavetimer">performSaveAndSuspendSaveTimer</a></li>
        <li><a href="#performdelete">performDelete</a></li>
      </ul>
    </li>
    <li><a href="#ddlogger">DDLogger</a>
      <ul>
        <li><a href="#didaddlogger">didAddLogger</a></li>
        <li><a href="#willremovelogger">willRemoveLogger</a></li>
        <li><a href="#logmessage">logMessage</a></li>
        <li><a href="#flush">flush</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#db-log">db_log</a></li>
    <li><a href="#db-save">db_save</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="heading">å‰è¨€</h2>
<p>è¿™æ˜¯ DDLog æºç é˜…è¯»çš„æœ€åä¸€ç¯‡ã€‚æœ¬ç¯‡é‡ç‚¹ä»‹ç» DDLogger å¯¹æ•°æ®åº“å­˜å‚¨çš„æ”¯æŒï¼ŒåŸç†åº”è¯¥å’Œ FileLogger ä¸€æ ·ï¼Œlog ç£ç›˜å­˜å‚¨çš„é¢‘ç‡ï¼Œè¿‡æœŸ log çš„æ·˜æ±°ç­–ç•¥ï¼Œä»¥åŠ log å­˜å‚¨çš„ç¼“å­˜ç­–ç•¥ç­‰ã€‚</p>
<p>å¼€å§‹ä¹‹å‰ï¼Œå»ºè®®å¤§å®¶å›é¡¾å‰ä¸¤ç¯‡æ–‡ç« ï¼Œå¾ˆå¤šåŸºæœ¬çš„æ¦‚å¿µæœ¬ç¯‡ä¼šç›´æ¥å¿½ç•¥ã€‚</p>
<p>ä¸Šç¯‡ï¼š<a href="https://juejin.im/post/5eafe0796fb9a0438c2550e3">ã€Šæµ…æ CocoaLumberjack ä¹‹ DDLogã€‹</a></p>
<p>ä¸­ç¯‡ï¼š<a href="https://juejin.im/post/5eb6dc6bf265da7bf1691c13">ã€Šæµ…æ CocoaLumberjack ä¹‹ FileLoggerã€‹</a></p>
<h1 id="ddabstractdatabaselogger">DDAbstractDatabaseLogger</h1>
<p>ä½œä¸ºæŠ½è±¡ç±»ï¼Œä½ å¯ä»¥è‡ªç”±çš„æ ¹æ®é¡¹ç›®æ‰€ä½¿ç”¨çš„æ•°æ®åº“ç±»å‹æ¥æä¾›å…·ä½“çš„å­ç±»å®ç°ã€‚DDLog åœ¨ Demo ä¸­æä¾›äº† FMDBLogger å’Œ CoreDataLogger çš„å®è·µï¼Œä¼šåœ¨åé¢ç¨å¾®ä»‹ç»ã€‚ å› æ­¤ï¼ŒdbLogger ä¸»è¦æ˜¯ä¿è¯ log entify (message å¯¹åº”çš„ SQL) çš„è¯»å†™ç­–ç•¥ã€‚æ¥çœ‹å‡ ä¸ªæš´éœ² property çš„å£°æ˜ï¼Œå…ˆæ¥çœ‹ç¬¬ä¸€ç»„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">readwrite</span><span class="p">)</span> <span class="n">NSUInteger</span> <span class="n">saveThreshold</span><span class="p">;</span> <span class="c1">// 500
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">readwrite</span><span class="p">)</span> <span class="n">NSTimeInterval</span> <span class="n">saveInterval</span><span class="p">;</span> <span class="c1">// 60s
</span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸¤ä¸ªæ˜¯ç”¨äºæ§åˆ¶ entities å†™å…¥ç£ç›˜çš„é¢‘ç‡ã€‚æ¯•ç«Ÿæˆ‘ä»¬ä¸èƒ½é’ˆå¯¹æ¯ä¸€æ¡ log éƒ½æ‰§è¡Œ SQL æ’å…¥è¯­å¥ (I/O æ“ä½œï¼‰ã€‚</p>
<ul>
<li>saveThresholdï¼šå½“å‰æœªå¤„ç† entities æ•°é‡çš„é˜ˆå€¼ï¼Œé»˜è®¤ 500 æ¡ï¼›</li>
<li>saveIntervalï¼šæ‰§è¡Œä¸‹ä¸€æ¬¡å†™å…¥çš„æ—¶é—´é—´éš”ï¼›</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†è¿™ä¸¤ä¸ªçš„å€¼å½’é›¶çš„æ–¹å¼æ¥è¡¨ç¤ºğŸˆ²ï¸æ­¢å¯¹åº”çš„æ§åˆ¶ã€‚å½“ç„¶ï¼Œè¿™é‡Œä¸å»ºè®®å°†ä¸¤ä¸ªå€¼éƒ½ç½®é›¶ã€‚</p>
<p>å¦å¤–ä¸‰ä¸ªä¸»è¦ç”¨äºæ§åˆ¶å·²ä¿å­˜ entities çš„æ¸…é™¤é¢‘ç‡ï¼Œæ¯•ç«Ÿæˆ‘ä»¬å¯ä¸æ„¿ç”¨æˆ·å‘ç°ç£ç›˜è¢«æˆ‘ä»¬ç»™å†™æ»¡äº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">readwrite</span><span class="p">)</span> <span class="n">NSTimeInterval</span> <span class="n">maxAge</span><span class="p">;</span> <span class="c1">// 7 day
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">readwrite</span><span class="p">)</span> <span class="n">NSTimeInterval</span> <span class="n">deleteInterval</span><span class="p">;</span> <span class="c1">// 5 min
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">readwrite</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">deleteOnEverySave</span><span class="p">;</span> <span class="c1">// NO
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>maxAgeï¼šæ—¥å¿—æœ€å¤šä¿ç•™æ—¶é•¿ï¼Œé»˜è®¤ä¸º 7 å¤©ï¼›</li>
<li>deleteIntervalï¼šè¿‡æœŸæ—¥å¿—åˆ é™¤çš„é¢‘ç‡ï¼Œé»˜è®¤ä¸º 5 åˆ†é’Ÿï¼›</li>
<li>deleteOnEverySaveï¼šå¦å¤–ä¸€ä¸ªå¯é€‰é¡¹ï¼Œç”¨äºæ§åˆ¶æ¯æ¬¡æ—¥å¿—å†™å…¥æ—¶ï¼Œæ˜¯å¦éœ€è¦è¿›è¡Œè¿‡æœŸæ—¥å¿—çš„æ¸…é™¤ã€‚</li>
</ul>
<p>åŒæ ·ï¼Œ<code>maxAge</code> å’Œ <code>deleteInterval</code> ä¹Ÿå¯é€šè¿‡ç½®é›¶æ¥ disable å…¶åŠŸèƒ½ã€‚</p>
<h2 id="timer-">Timer çš„ç”Ÿå‘½å‘¨æœŸ</h2>
<p>æ—¢ç„¶æ˜¯è·Ÿè¸ªæ—¥å¿—çš„å†™å…¥å’Œæ“¦é™¤ï¼Œtimer æ˜¯å°‘ä¸äº†çš„ã€‚dbLogger åˆ†åˆ«é’ˆå¯¹ save å’Œ delete æ“ä½œéƒ½åˆ†é…äº†ä¸€ä¸ª <code>dispatch_source_t</code>  ä½œä¸º timerã€‚å¯¹åº”çš„åˆ›å»ºã€æ›´æ–°ã€é”€æ¯çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center">Save</th>
<th align="center">Delete</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">createSuspendedSaveTimer</td>
<td align="center">createAndStartDeleteTimer</td>
</tr>
<tr>
<td align="center">updateAndResumeSaveTimer</td>
<td align="center">updateDeleteTimer</td>
</tr>
<tr>
<td align="center">destroySaveTimer</td>
<td align="center">destroyDeleteTimer</td>
</tr>
</tbody>
</table>
<h3 id="createsuspendedsavetimer">createSuspendedSaveTimer</h3>
<p>SaveTimer åœ¨æ‰§è¡Œ log å†™å…¥æ“ä½œçš„æ—¶å€™ä¼šå…ˆæš‚åœï¼Œåœ¨å†™å…¥ç»“æŸåé‡æ–°æ¢å¤è®¡æ—¶ã€‚è¿™é‡Œ DDLog ä½¿ç”¨äº† <strong>_saveTimerSuspended</strong> ä½œä¸ºæ ‡è¯† (ä¸º NSInteger ç±»å‹) ï¼Œæ ‡è®° timer çš„çŠ¶æ€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="n">_saveTimer</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_saveInterval</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_saveTimer</span> <span class="o">=</span> <span class="n">dispatch_source_create</span><span class="p">(</span><span class="n">DISPATCH_SOURCE_TYPE_TIMER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">loggerQueue</span><span class="p">)</span><span class="p">;</span>

    <span class="n">dispatch_source_set_event_handler</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> 
        <span class="k">@autoreleasepool</span> <span class="p">{</span> <span class="p">[</span><span class="nb">self</span> <span class="n">performSaveAndSuspendSaveTimer</span><span class="p">]</span><span class="p">;</span> <span class="p">}</span> 
    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
    <span class="n">_saveTimerSuspended</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>_saveInterval &gt; 0.0</code> è¡¨æ˜å¼€å¯äº† â²ï¸ æ£€æŸ¥ log å†™å…¥ä»»åŠ¡ï¼›</li>
<li>ä¸º timer è®¾ç½®äº†å®šæ—¶å›è°ƒ <code>performSaveAndSuspendSaveTimer</code> ï¼›</li>
</ul>
<p><strong>_saveTimerSuspended</strong>  çš„å€¼æœ‰ä¸‰ç§ç±»å‹ï¼Œåˆ†åˆ«å¯¹åº” dispatch_source_t çš„ä¸‰ä¸ªçŠ¶æ€ï¼š</p>
<table>
<thead>
<tr>
<th align="center">value</th>
<th align="center">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">-1</td>
<td align="center">åˆ›å»ºæ—¶çš„åˆå§‹çŠ¶æ€ï¼š inactivited</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">è¢«æ¿€æ´»çŠ¶æ€ï¼šactived / resumed</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">è¢«æŒ‚èµ·çŠ¶æ€ï¼šsuspended</td>
</tr>
</tbody>
</table>
<p>æ‰€ä»¥ timer è¢« create æ—¶æ˜¯å¤„äºæœªæ¿€æ´»çš„æš‚åœçŠ¶æ€ã€‚</p>
<h3 id="updateandresumesavetimer">updateAndResumeSaveTimer</h3>
<p>æ¿€æ´»æˆ–æ¢å¤ SaveTimerï¼Œæ¢å¤å‰ä¼šæ£€æŸ¥ <strong>_unsavedTime</strong> æ˜¯å¦å¤§äº 0ï¼Œ<code>_unsavedTime</code> ä¸ºæ¯æ¬¡æ‰§è¡Œ <strong>logMessage</strong> æ—¶æ‰€è®°å½•çš„å½“å‰æ—¶é—´ã€‚<code>_unsavedTime</code> ä¹Ÿå°±æ˜¯ timer æ¢å¤çš„ startTimeã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="n">_saveTimer</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_saveInterval</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_unsavedTime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">uint64_t</span> <span class="n">interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="p">(</span><span class="n">_saveInterval</span> <span class="o">*</span> <span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span> <span class="n">NSEC_PER_SEC</span><span class="p">)</span><span class="p">;</span>
    <span class="n">dispatch_time_t</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">_unsavedTime</span><span class="p">,</span> <span class="p">(</span><span class="n">int64_t</span><span class="p">)</span><span class="n">interval</span><span class="p">)</span><span class="p">;</span>

    <span class="n">dispatch_source_set_timer</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="mi">1ull</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">)</span><span class="p">;</span>
    <span class="c1">//... æ¿€æ´» timer
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¿€æ´»è®¡æ—¶å™¨ä¼šé‡ç½® timer çš„ startTime å’Œ intervalã€‚</p>
<p>æ¢å¤ timer çš„é€»è¾‘ï¼Œè¿™é‡Œå¯¹ä¸åŒç‰ˆæœ¬çš„ GCD API åšäº†å…¼å®¹æ€§çš„é€‚é…ã€‚åœ¨ <strong>macOS 10.12, iOS 10.0</strong> ä¹‹åï¼Œæ–°å‡ºäº† <strong>dispatch_activate</strong> API åŒºåˆ«äºåŸæœ‰çš„ <strong>dispatch_resume</strong>ã€‚è¿™é‡Œé¢æœ‰ä¸€ä¸ªå‘éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå…ˆæ¥çœ‹çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ–‡æ¡£æè¿°ï¼š</p>
<p><strong>dispatch_activate</strong></p>
<blockquote>
<p>Suspends the invocation of blocks on a dispatch object.</p>
</blockquote>
<p>æ–°ç”Ÿæˆçš„ queue æˆ– source é»˜è®¤ä¸º inactive çŠ¶æ€ï¼Œå®ƒä»¬å¿…é¡»è®¾ç½®ä¸º active åå…¶å…³è”çš„ event handler æ‰å¯èƒ½è¢«invokeã€‚</p>
<p>å¯¹äºæœªæ¿€æ´»çš„ dispatch objc æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>dispatch_set_target_queue()</code> æ¥æ›´æ–°åˆå§‹åŒ–æ—¶ç»‘å®šçš„  queueï¼Œä¸€æ—¦ä¸º active è¯ï¼Œè¿™ä¹ˆåšå°±å¯èƒ½å¯¼è‡´ crashï¼Œå‘ç‚¹ 1ã€‚å¦å¤–ï¼Œdispatch_activate å¯¹å·²æ¿€æ´»çš„ dispatch objc æ˜¯æ²¡æœ‰å‰¯ä½œç”¨çš„ã€‚</p>
<p><strong>dispatch_resume</strong></p>
<blockquote>
<p>Resumes the invocation of blocks on a dispatch object.</p>
</blockquote>
<p>dispatch source é€šè¿‡ <code>dispatch_suspend()</code> æ—¶ï¼Œä¼šå¢åŠ å†…éƒ¨çš„ suspension countï¼Œresume åˆ™æ˜¯ç›¸åæ“ä½œã€‚å½“ suspension count æ¸…ç©ºåï¼Œæ³¨å†Œçš„ event handler æ‰èƒ½è¢«å†æ¬¡è§¦å‘ã€‚</p>
<p>ä¸ºäº†å‘åå…¼å®¹ï¼Œå¯¹äº inactive çš„ source è°ƒç”¨ dispatch_resume çš„æ•ˆæœä¸ dispatch_active ä¸€è‡´ã€‚å¯¹äº inactive çš„  source å»ºè®®ä½¿ç”¨ dispatch_activate æ¥æ¿€æ´»ã€‚</p>
<p>å¦‚æœå¯¹ suspension count ä¸º 0 ä¸”ä¸º inactive çŠ¶æ€çš„ source æ‰§è¡Œ dispatch_resumeï¼Œåˆ™ä¼šè§¦å‘æ–­è¨€è¢«å¼ºåˆ¶é€€å‡ºã€‚</p>
<p>æ¿€æ´» Timer å®ç°å¦‚ä¸‹ï¼Œæ‰€ä»¥ä¸‹é¢è¿™æ®µä»£ç å¯¹ä¸åŒç‰ˆæœ¬çš„ timer çš„ä¸åŒçŠ¶æ€åšäº†åŒºåˆ†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.12</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_saveTimerSuspended</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// inactive
</span><span class="c1"></span>        <span class="n">dispatch_activate</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
        <span class="n">_saveTimerSuspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_saveTimerSuspended</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// active
</span><span class="c1"></span>        <span class="n">dispatch_resume</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
        <span class="n">_saveTimerSuspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_saveTimerSuspended</span> <span class="o">!</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// inactive
</span><span class="c1"></span>        <span class="n">dispatch_resume</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
        <span class="n">_saveTimerSuspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="destroysavetimer">destroySaveTimer</h3>
<p>é”€æ¯ timerã€‚é¦–å…ˆæ‰§è¡Œ <code>dispatch_source_cancel</code> å°† timer æ ‡è®°ä¸º cacneled ä»¥å–æ¶ˆä¹‹åçš„ event handler çš„æ‰§è¡Œã€‚ä¹‹åå°† timer çŠ¶æ€æ ‡è®°ä¸º activedï¼Œå¦åˆ™åœ¨ release inactive çš„ source ä¼šå¯¼è‡´ crashã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.12</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_saveTimerSuspended</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dispatch_activate</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_saveTimerSuspended</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dispatch_resume</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_saveTimerSuspended</span> <span class="o">!</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dispatch_resume</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æœ€åé‡Šæ”¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="cp">#</span><span class="cp">if !OS_OBJECT_USE_OBJC</span><span class="cp">
</span><span class="cp"></span><span class="n">dispatch_release</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span><span class="n">_saveTimer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">_saveTimerSuspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="createandstartdeletetimer">createAndStartDeleteTimer</h3>
<p>Delete Timer çš„é€»è¾‘å°±æ¯”è¾ƒç®€å•ä¸€äº›ã€‚ç”±äº log æ¸…é™¤çš„é€»è¾‘ä¸éœ€è¦åƒå†™å…¥ä¸€æ ·ï¼Œåœ¨æ¯æ¬¡ logMessage çš„æ—¶å€™éƒ½é‡æ–°æ›´æ–° startTime å¹¶æ¢å¤ä¸º active çŠ¶æ€ã€‚åŒæ—¶ Delete Timer åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±ä¿è¯äº†å…¶ä¸º active çŠ¶æ€ã€‚æ‰€ä»¥ Delete Timer åœ¨ update çš„æ—¶å€™ï¼Œä¹Ÿä¸éœ€è¦å†ç¡®ä¿çŠ¶æ€ä¸º activeã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="n">_deleteTimer</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_deleteInterval</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_maxAge</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_deleteTimer</span> <span class="o">=</span> <span class="n">dispatch_source_create</span><span class="p">(</span><span class="n">DISPATCH_SOURCE_TYPE_TIMER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">loggerQueue</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_deleteTimer</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dispatch_source_set_event_handler</span><span class="p">(</span><span class="n">_deleteTimer</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> 
           <span class="k">@autoreleasepool</span> <span class="p">{</span> <span class="p">[</span><span class="nb">self</span> <span class="n">performDelete</span><span class="p">]</span><span class="p">;</span> <span class="p">}</span> 
        <span class="p">}</span><span class="p">)</span><span class="p">;</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">updateDeleteTimer</span><span class="p">]</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.12</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span><span class="p">)</span>
            <span class="n">dispatch_activate</span><span class="p">(</span><span class="n">_deleteTimer</span><span class="p">)</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nf">dispatch_resume</span><span class="p">(</span><span class="n">_deleteTimer</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="updatedeletetimer">updateDeleteTimer</h3>
<p>æ›´æ–° Delete Timer æ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æ‰§è¡Œè¿‡ä¸€æ¬¡æ¸…é™¤æ“ä½œã€‚å¦‚æœæœ‰ï¼Œä¼šä»¥ä¸Šæ¬¡æ¸…æ¥šçš„æ—¶é—´æˆ³ä½œä¸º startTimeã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="n">_deleteTimer</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_deleteInterval</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_maxAge</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">int64_t</span> <span class="n">interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">int64_t</span><span class="p">)</span><span class="p">(</span><span class="n">_deleteInterval</span> <span class="o">*</span> <span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span> <span class="n">NSEC_PER_SEC</span><span class="p">)</span><span class="p">;</span>
    <span class="n">dispatch_time_t</span> <span class="n">startTime</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_lastDeleteTime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">_lastDeleteTime</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dispatch_source_set_timer</span><span class="p">(</span><span class="n">_deleteTimer</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="n">interval</span><span class="p">,</span> <span class="mi">1ull</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="destroydeletetimer">destroyDeleteTimer</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="n">_deleteTimer</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dispatch_source_cancel</span><span class="p">(</span><span class="n">_deleteTimer</span><span class="p">)</span><span class="p">;</span>
    <span class="cp">#</span><span class="cp">if !OS_OBJECT_USE_OBJC</span><span class="cp">
</span><span class="cp"></span>    <span class="n">dispatch_release</span><span class="p">(</span><span class="n">_deleteTimer</span><span class="p">)</span><span class="p">;</span>
    <span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>    <span class="n">_deleteTimer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="configuration">Configuration</h2>
<p>dbLogger å¯¹å†™å…¥å’Œæ¸…é™¤æ“ä½œæ§åˆ¶ç­–ç•¥çš„å±æ€§è¿›è¡Œäº†é‡è½½ã€‚è¿™å‡ ä¸ª Access æ–¹æ³•çš„ getter å’Œ setter éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨ loggingQueue å’Œ  loggerQueue ä¸­æ¥æ‰§è¡Œæ“ä½œçš„ï¼Œå…·ä½“å¯ä»¥çœ‹ <a href="https://juejin.im/post/5eafe0796fb9a0438c2550e3">DDLog ä¸Šç¯‡</a>ã€‚getter åªæ˜¯å–å€¼ï¼Œå› æ­¤è¿™é‡Œä¸»è¦èŠèŠï¼Œå…¶å€¼æ›´æ–°æ—¶æœ‰å“ªäº›æ“ä½œã€‚</p>
<h3 id="setsavethreshold">setSaveThreshold</h3>
<p>æ›´æ–° saveThreshold åï¼Œéœ€è¦æ£€æŸ¥å½“å‰æœªå†™å…¥çš„ entities æ•°æ˜¯å¦è¶…è¿‡æ–°èµ‹å€¼çš„é˜ˆå€¼ã€‚å¦‚æœè¶…å‡ºéœ€è¦ä¸»åŠ¨æ‰§è¡Œå†™å…¥æ“ä½œå¹¶æ›´æ–° SaveTimerï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="nb">self</span><span class="o">-</span><span class="o">&gt;</span><span class="n">_unsavedCount</span> <span class="o">&gt;</span><span class="o">=</span> <span class="nb">self</span><span class="o">-</span><span class="o">&gt;</span><span class="n">_saveThreshold</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="nb">self</span><span class="o">-</span><span class="o">&gt;</span><span class="n">_saveThreshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">performSaveAndSuspendSaveTimer</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="setsaveinterval">setSaveInterval</h3>
<p>æ›´æ–°ä¸‹ä¸€æ¬¡æ‰§è¡Œ log entries çš„æ—¶é—´é—´éš”ã€‚<strong>åˆå‡ºç°æ–°çŸ¥è¯†ç‚¹äº†</strong>ï¼Œè¿™é‡Œä½œè€…ä½¿ç”¨äº† <strong><a href="https://en.cppreference.com/w/c/numeric/math/islessgreater">islessgreater</a></strong> å®æ¥åˆ¤æ–­ saveInterval æ˜¯å¦æœ‰å˜åŒ–ã€‚è¿™ä¸ª islessgreater æ˜¯ C99 æ ‡å‡†ä¸­æ¨èçš„æµ®ç‚¹æ•°æ¯”è¾ƒçš„å®:</p>
<blockquote>
<p>The built-in operator&lt; and operator&gt; for floating-point numbers may raise <a href="https://en.cppreference.com/w/c/numeric/fenv/FE_exceptions">FE_INVALID</a> if one or both of the arguments is NaN. This function is a &ldquo;quiet&rdquo; version of the expression x &lt; y || x &gt; y. The macro does not evaluate x and y twice.</p>
</blockquote>
<p>ä½¿ç”¨å®ƒèƒ½é¿å…å› ä¸ºå€¼ä¸º NaN è€Œå‡ºç°çš„å¼‚å¸¸ã€‚å…³äºæµ®ç‚¹æ•°çš„å¯¹æ¯”ï¼Œè¿™é‡Œæœ‰ä¸€ç¯‡ä¸é”™çš„æ–‡ç« ï¼š<a href="https://floating-point-gui.de/errors/comparison/">comparison</a>ã€‚</p>
<p>ç”±äº saveInterval æ˜¯å¦ä¸º 0 æ˜¯ç”¨äºæ§åˆ¶å®šæ—¶å†™å…¥åŠŸèƒ½ï¼Œå› æ­¤ï¼Œæ›´æ–°åæœ‰ä¸‰ç§æƒ…å†µéœ€è¦å¤„ç†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">-</span><span class="o">&gt;</span><span class="n">_saveInterval</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">-</span><span class="o">&gt;</span><span class="n">_saveTimer</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">createSuspendedSaveTimer</span><span class="p">]</span><span class="p">;</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">updateAndResumeSaveTimer</span><span class="p">]</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">updateAndResumeSaveTimer</span><span class="p">]</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">-</span><span class="o">&gt;</span><span class="n">_saveTimer</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">destroySaveTimer</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>éœ€è¦å¼€å¯å®šæ—¶å†™å…¥ä¸” timer ä¸º NULLï¼›éœ€è¦åˆ›å»º SaveTimer å¹¶æ¿€æ´»å®ƒï¼›</li>
<li>éœ€è¦å¼€å¯å®šæ—¶å†™å…¥ä¸” timer å­˜åœ¨ï¼›æ¿€æ´»å¹¶æ¢å¤ SaveTimerï¼›</li>
<li>æ— éœ€å®šæ—¶å†™å…¥ï¼šé”€æ¯ Timerï¼›</li>
</ul>
<h3 id="setmaxage">setMaxAge</h3>
<p>maxAge çš„æƒ…å†µæ›´å¤šä¸€äº›ï¼Œæœ‰å››ç§ caseã€‚åœ¨æ›´æ–° maxAge å‰ï¼Œä¿ç•™äº†æ—§å€¼ç”¨äºå¯¹æ¯”ï¼ŒåŒæ ·ç”¨åˆ°äº† islessgreaterã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">BOOL</span> <span class="n">shouldDeleteNow</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">oldMaxAge</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newMaxAge</span> <span class="o">&lt;</span><span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// 1
</span><span class="c1"></span>        <span class="p">[</span><span class="nb">self</span> <span class="n">destroyDeleteTimer</span><span class="p">]</span><span class="p">;</span>
       
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oldMaxAge</span> <span class="o">&gt;</span> <span class="n">newMaxAge</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shouldDeleteNow</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span> <span class="c1">/// 4
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newMaxAge</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">shouldDeleteNow</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span> <span class="c1">/// 2
</span><span class="c1"></span><span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">shouldDeleteNow</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">performDelete</span><span class="p">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">-</span><span class="o">&gt;</span><span class="n">_deleteTimer</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">updateDeleteTimer</span><span class="p">]</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">createAndStartDeleteTimer</span><span class="p">]</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>maxAge æ£€æŸ¥ä»å¼€å¯å˜ä¸ºå…³é—­çŠ¶æ€ï¼Œæ­¤æ—¶åªéœ€è¦é”€æ¯ Delete Timerï¼›</li>
<li>maxAge æ£€æŸ¥ä»å…³é—­å˜ä¸ºå¼€å¯çŠ¶æ€ï¼Œéœ€è¦ç«‹å³æ¸…ç†è¿‡æœŸæ—¥å¿—ï¼Œå¹¶åˆå§‹åŒ– Delete Timer</li>
<li>æ—¥å¿—ä¿ç•™æ—¶é•¿å¢åŠ ï¼Œdo nothingï¼›</li>
<li>æ—¥å¿—ä¿ç•™æ—¶é•¿å‡å°‘ï¼Œéœ€è¦ç«‹å³æ¸…ç†ï¼›</li>
</ol>
<h3 id="setdeleteinterval">setDeleteInterval</h3>
<p>deleteInterval åŒ saveInterval å¯¹ timer çš„æ“ä½œé€»è¾‘ç›¸åŒï¼Œå°±ä¸å±•å¼€äº†ã€‚</p>
<h2 id="save--delete">Save &amp; Delete</h2>
<p>æ—¢ç„¶åšä¸ºæŠ½è±¡ç±»ï¼Œè‚¯å®šéœ€è¦æœ‰å‡ ä¸ªæ–¹æ³•æš´éœ²ç»™å­ç±»å»å®ç°ï¼Œè¦ä¸å°±æ˜¯é€šè¿‡ protocol è®© delegate å»å®ç°ã€‚è¿™é‡Œ ddLogger é¢„ç•™äº†å››ä¸ªè™šæ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">db_log:</span><span class="p">(</span><span class="n">__unused</span> <span class="n">DDLogMessage</span> <span class="o">*</span><span class="p">)</span><span class="nv">logMessage</span> <span class="p">{</span>
	<span class="c1">// Return YES if an item was added to the buffer.
</span><span class="c1"></span>	<span class="c1">// Return NO if the logMessage was ignored.
</span><span class="c1"></span>	<span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">db_save</span> <span class="p">{</span><span class="p">}</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">db_delete</span> <span class="p">{</span><span class="p">}</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">db_saveAndDelete</span> <span class="p">{</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="public-api">Public API</h3>
<p>dbLogger ä¸ºç”¨æˆ·ä¸»åŠ¨æ‰§è¡Œå†™å…¥å’Œæ¸…é™¤æä¾›äº†ä¸¤ä¸ªæ–¹æ³• <strong>savePendingLogEntries</strong> å’Œ <strong>deleteOldLogEntries</strong>ã€‚</p>
<p>ä½œä¸º logger çš„å…¬å…±æ–¹æ³•ï¼Œå…¶æ‰§è¡Œå¿…é¡»åœ¨ loggerQueue ä¸­ï¼Œä»¥ <code>savePendingLogEntries</code> ä¸ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">dispatch_block_t</span> <span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
     <span class="k">@autoreleasepool</span> <span class="p">{</span>
         <span class="p">[</span><span class="nb">self</span> <span class="n">performSaveAndSuspendSaveTimer</span><span class="p">]</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">}</span><span class="p">;</span>

 <span class="k">if</span> <span class="p">(</span><span class="p">[</span><span class="nb">self</span> <span class="n">isOnInternalLoggerQueue</span><span class="p">]</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">block</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="n">dispatch_async</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">loggerQueue</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>performSaveAndSuspendSaveTimer</code> åˆ™æ˜¯å…¶å¯¹åº”çš„ private methodï¼ŒåŒæ ·çš„ <code>deleteOldLogEntries</code> å¯¹åº”çš„ private method ä¸º <code>performDelete</code> ã€‚</p>
<h3 id="performsaveandsuspendsavetimer">performSaveAndSuspendSaveTimer</h3>
<p>ä»æ–¹æ³•åå¯çŸ¥è¿™é‡Œåšäº†ä¸¤ä»¶äº‹ï¼šæ‰§è¡Œæ—¥å¿—å†™å…¥å’ŒæŒ‚èµ· SaveTimerã€‚</p>
<p>å†™å…¥å‰ç¡®ä¿å­˜åœ¨æœªå†™å…¥æ—¥å¿—ï¼Œç„¶åä¾æ® _deleteOnEverySave åŒºåˆ†æ˜¯å¦éœ€è¦åœ¨æ¯æ¬¡å†™å…¥çš„åŒæ—¶è¿›è¡Œæ¸…æ¥šæ“ä½œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="n">_unsavedCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_deleteOnEverySave</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">db_saveAndDelete</span><span class="p">]</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">db_save</span><span class="p">]</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">/// å†™å…¥ç»“æŸé‡ç½®çŠ¶æ€ï¼›
</span><span class="c1"></span><span class="n">_unsavedCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">_unsavedTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¥ç€å°† timer æŒ‚èµ·ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡çš„ logMessage ä»¥åˆ·æ–° timerï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="n">_saveTimer</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">_saveTimerSuspended</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dispatch_suspend</span><span class="p">(</span><span class="n">_saveTimer</span><span class="p">)</span><span class="p">;</span>
    <span class="n">_saveTimerSuspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨ <strong>_saveTimerSuspended</strong> ä½œä¸ºæ ‡è®°ï¼Œé˜²æ­¢å¤šæ¬¡æ‰§è¡Œ <strong>dispatch_suspend</strong> æ“ä½œï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº† source æ˜¯å¤„äº active çŠ¶æ€ã€‚å‰é¢åœ¨ dispatch source çš„çŠ¶æ€å˜æ›´ä¸­æåˆ°ï¼Œsource å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª suspension countï¼Œå¤šæ¬¡æ‰§è¡Œä¼šå¯¼è‡´ count å¢å¤§ã€‚è¿™é‡Œç®—æ˜¯ä¸€é±¼å¤šåƒäº†ï¼ŒğŸ‘ã€‚</p>
<h3 id="performdelete">performDelete</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="n">_maxAge</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">db_delete</span><span class="p">]</span><span class="p">;</span>

    <span class="n">_lastDeleteTime</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¼€å¯æ¸…æ¥šæ“ä½œçš„è¯å°±æ‰§è¡Œ deleteï¼Œç»“æŸåæ›´æ–° <code>_lastDeleteTime</code>ã€‚</p>
<h2 id="ddlogger">DDLogger</h2>
<p>åœ¨éµå¾ª DDLogger çš„æ–¹æ³•ä¸­åŸºæœ¬ä¹Ÿæ˜¯ç»´æŠ¤ timer çš„çŠ¶æ€ï¼Œè§¦å‘ save æ“ä½œã€‚</p>
<h3 id="didaddlogger">didAddLogger</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">[</span><span class="nb">self</span> <span class="n">createSuspendedSaveTimer</span><span class="p">]</span><span class="p">;</span>
<span class="p">[</span><span class="nb">self</span> <span class="n">createAndStartDeleteTimer</span><span class="p">]</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="willremovelogger">willRemoveLogger</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">[</span><span class="nb">self</span> <span class="n">performSaveAndSuspendSaveTimer</span><span class="p">]</span><span class="p">;</span>

<span class="p">[</span><span class="nb">self</span> <span class="n">destroySaveTimer</span><span class="p">]</span><span class="p">;</span>
<span class="p">[</span><span class="nb">self</span> <span class="n">destroyDeleteTimer</span><span class="p">]</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="logmessage">logMessage</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">(</span><span class="p">[</span><span class="nb">self</span> <span class="nl">db_log</span><span class="p">:</span><span class="n">logMessage</span><span class="p">]</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* æ›´æ–° save timer */</span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>logMessage æ–¹æ³•æ˜¯ç”¨æˆ·äº§ç”Ÿ new log æ‰€è§¦å‘çš„ï¼ŒåŒ…å«äº†å…³é”®çš„ log messageã€‚åœ¨ FileLogger ä¸­æ—¶å°† message è½¬æ¢ä¸º NSData è°ƒç”¨ <code>lt_logData</code> æ¥å†™å…¥æ–‡ä»¶ï¼Œè€Œè¿™é‡Œåˆ™ä¼šå°† message è½¬æ¢ä¸º log entity ä»¥æœŸå†™å…¥ DB ä¸­ã€‚<strong>db_log</strong> æ‰€åšçš„çœŸæ˜¯å’Œ <code>lt_logData</code> ä¸€è‡´çš„ã€‚</p>
<p>ä¸è¿‡è¿™é‡Œç•™äº†ä¸€ä¸ªå¼€å…³ï¼Œå°±æ˜¯ db_log çš„è¿”å›å€¼ã€‚å¦‚æœè¿”å› NO åˆ™æ„å‘³ç€æ”¹æ¡ log è¢«ä¸¢å¼ƒï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦æ›´æ–° timer çš„ startTime æˆ–è€…è§¦å‘ save æ“ä½œã€‚</p>
<p>æ›´æ–°é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">BOOL</span> <span class="n">firstUnsavedEntry</span> <span class="o">=</span> <span class="p">(</span><span class="o">+</span><span class="o">+</span><span class="n">_unsavedCount</span> <span class="o">=</span><span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="n">_unsavedCount</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">_saveThreshold</span><span class="p">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">_saveThreshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">performSaveAndSuspendSaveTimer</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">firstUnsavedEntry</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_unsavedTime</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">updateAndResumeSaveTimer</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="flush">flush</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">[</span><span class="nb">self</span> <span class="n">performSaveAndSuspendSaveTimer</span><span class="p">]</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>è¯¥æ–¹æ³•æ˜¯å½“åº”ç”¨é€€å‡ºæˆ–å´©æºƒæ—¶ä¸»åŠ¨è°ƒç”¨ï¼Œä»¥åŠæ—¶ä¿å­˜è¿˜åœ¨ pendding çŠ¶æ€çš„ log entitiesã€‚</p>
<h1 id="fmdblogger">FMDBLogger</h1>
<p>ç®€å•ä»‹ç»ä¸€ä¸‹ FMDBLoggerï¼Œå®ƒæ˜¯é€šè¿‡ FMDB æä¾›çš„ API å°† log message å†™å…¥æ•°æ®åº“ã€‚</p>
<p>è¿™é‡Œæ¯æ¡ DDLogMessage å¯¹åº”ä¸º FMDBLogEntryï¼Œå®ƒç®€å•å­˜å‚¨äº† contextã€flagã€messageã€timestampã€‚æ•°æ®åº“å»ºè¡¨å’Œæ ¡éªŒå°±ä¸è¯´äº†ï¼Œä¸»è¦å›´ç»•é‡è½½çš„å‡ ä¸ªæ–¹æ³•ã€‚</p>
<h2 id="db-log">db_log</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">FMDBLogEntry</span> <span class="o">*</span><span class="n">logEntry</span> <span class="o">=</span> <span class="p">[</span><span class="p">[</span><span class="n">FMDBLogEntry</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithLogMessage</span><span class="p">:</span><span class="n">logMessage</span><span class="p">]</span><span class="p">;</span>
<span class="p">[</span><span class="n">pendingLogEntries</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">logEntry</span><span class="p">]</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œå¹¶æ²¡æœ‰ç›´æ¥å°† logEntry æ’å…¥ dbï¼Œè€Œæ˜¯æ·»åŠ åˆ°ç¼“å†²åˆ—è¡¨ä¸­ã€‚æˆ‘ä»¬çœŸçš„éœ€è¦è¿™ä¸ªç¼“å†²åŒºå—ï¼Ÿ</p>
<p>æ¥çœ‹ SQLite ä½œè€…çš„å›ç­”ï¼š<a href="https://www.sqlite.org/faq.html#q19"><strong>(19) INSERT is really slow - I can only do few dozen INSERTs per second</strong></a></p>
<blockquote>
<p>Actually, SQLite will easily do 50,000 or more <a href="https://www.sqlite.org/lang_insert.html">INSERT</a> statements per second on an average desktop computer. But it will only do a few dozen transactions per second. Transaction speed is limited by the rotational speed of your disk drive. A transaction normally requires two complete rotations of the disk platter, which on a 7200RPM disk drive limits you to about 60 transactions per second.</p>
<p>Transaction speed is limited by disk drive speed because (by default) SQLite actually waits until the data really is safely stored on the disk surface before the transaction is complete. That way, if you suddenly lose power or if your OS crashes, your data is still safe. For details, read about <a href="https://www.sqlite.org/atomiccommit.html">atomic commit in SQLite.</a>.</p>
<p>By default, each INSERT statement is its own transaction. But if you surround multiple INSERT statements with <a href="https://www.sqlite.org/lang_transaction.html">BEGIN</a>&hellip;<a href="https://www.sqlite.org/lang_transaction.html">COMMIT</a> then all the inserts are grouped into a single transaction. The time needed to commit the transaction is amortized over all the enclosed insert statements and so the time per insert statement is greatly reduced.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¤šæ¡æ’å…¥è¯­å¥ç”¨ <code>BEGIN ... COMMIT</code> çš„æ–¹æ³•åŒ…è£¹èµ·æ¥ä½œä¸ºå•ç‹¬çš„äº‹åŠ¡æ¥æäº¤ï¼Œæ•ˆç‡å°†ä¼šæœ‰å·¨å¤§çš„æå‡ã€‚</p>
<h2 id="db-save">db_save</h2>
<p>æœ€ç»ˆå°è¯•å°† pendingLogEntries ä½œä¸ºäº‹åŠ¡æ‰§è¡Œçš„æ–¹æ³•ã€‚ä¼šå…ˆæ£€æŸ¥ pendingLogEntries count ä»¥åŠ database æ˜¯å¦æ­£åœ¨æ‰§è¡Œäº‹åŠ¡ï¼Œæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨  <code>BEGIN ... COMMIT</code> ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">BOOL</span> <span class="n">saveOnlyTransaction</span> <span class="o">=</span> <span class="o">!</span><span class="p">[</span><span class="n">database</span> <span class="n">inTransaction</span><span class="p">]</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">saveOnlyTransaction</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">database</span> <span class="n">beginTransaction</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* INSERT INTO logs &amp; remove pendingLogEntries  */</span> 

<span class="k">if</span> <span class="p">(</span><span class="n">saveOnlyTransaction</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">database</span> <span class="n">commit</span><span class="p">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="p">[</span><span class="n">database</span> <span class="n">hadError</span><span class="p">]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;</span><span class="s">%@: Error inserting log entries: code(%d): %@</span><span class="s">&#34;</span><span class="p">,</span>
                <span class="p">[</span><span class="nb">self</span> <span class="k">class</span><span class="p">]</span><span class="p">,</span> <span class="p">[</span><span class="n">database</span> <span class="n">lastErrorCode</span><span class="p">]</span><span class="p">,</span> <span class="p">[</span><span class="n">database</span> <span class="n">lastErrorMessage</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„äº‹åŠ¡å¹¶éå¼ºåˆ¶æ‰§è¡Œçš„ï¼Œå› æ­¤è¿˜æ˜¯æœ‰ä¼˜åŒ–ç©ºé—´çš„ã€‚æ¯”å¦‚é€šè¿‡ä¸²è¡Œé˜Ÿåˆ—æ¥ä¿è¯æ¯æ¬¡ save éƒ½èƒ½åœ¨ transaction ä¸­å®Œæˆã€‚</p>
<p><strong>db_delete</strong> ä¸ <strong>db_saveAndDelete</strong> å°±ä¸å±•å¼€äº†ã€‚</p>
<h1 id="the-end">The End</h1>
<p>DDLog æ‰€æä¾›çš„ Demo ä¸­è¿˜æœ‰ CoreDataLoggerã€WebSocketLogger ç­‰è‡ªå®šä¹‰ logger çš„æ‰©å±•ã€‚æ¯”å¦‚ï¼Œé€šè¿‡ WebSocketLogger æˆ‘ä»¬å¯ä»¥å°†æ—¥å¿—ç›´æ¥è¾“å‡ºåˆ°æµè§ˆå™¨ä¸Šæ¥æ—¶æ—¶é¢„è§ˆå’Œæ ¡éªŒæ—¥å¿—æˆ–æ£€æŸ¥åŸ‹ç‚¹æ•°æ®ç­‰ç­‰ã€‚</p>
<p>é€šè¿‡è¿™äº› Demo æˆ‘ä»¬å¯¹ DDLog çš„éœ€æ±‚å®Œå…¨å¯ä»¥é€šè¿‡ Logger çš„æ‰©å±•æ¥å®ç°ã€‚æ¯”å¦‚ï¼Œé€šè¿‡ mmap æ¥å­˜å‚¨æ—¥å¿—ã€‚è¿™æ–¹é¢ Xlog å’Œ logan ç›®å‰å°±æ˜¯è¿™ä¹ˆå®ç°çš„ã€‚è€ŒåŸºäºå¾®ä¿¡ç°æœ‰æä¾›çš„ MMKVï¼Œæˆ‘ä»¬ç”¨ Logger ç®€å•æ‰©å±•å°±èƒ½å®ç°é«˜æ•ˆå­˜å‚¨ã€‚</p>
<p>DDLog ä¸­å¯ä»¥çœ‹åˆ°å…¶å¯¹ dispatch source çš„å®‰å…¨ä½¿ç”¨ï¼ŒåŒ…æ‹¬ queue å’Œ timer å’Œå¤šçº¿ç¨‹çš„å¤„ç†ï¼›å¯¹ NSProxy çš„å·§å¦™ä½¿ç”¨æ¥ä¸º fileHandler æ·»åŠ  buffer æ”¯æŒï¼›å¯¹ç³»ç»Ÿçš„ log system çš„äº†è§£ï¼Œä»¥åŠä»£ç çš„å¥å£®æ€§ï¼Œæ—¥å¿—æ›´æ–°å­˜å‚¨ç­–ç•¥ç­‰ç­‰ã€‚éå¸¸å€¼å¾—ä¸€çœ‹ã€‚</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">åœŸåœŸEdmondæœ¨</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2020-05-16
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/source-code/">Source Code</a>
          <a href="/tags/ios/">iOS</a>
          <a href="/tags/logger/">Logger</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/sourcecode-ios/source-code-lumberjack-2/">
            <span class="next-text nav-default">æµ…æ - CocoaLumberjack 3.6 ä¹‹ FileLogger</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:chun574271939@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/looseyi" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/looseyi" class="iconfont icon-github" title="github"></a>
      <a href="https://www.weibo.com/foreverclp" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/tu-tu-edmondmu" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="http://looseyi.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019-12-11 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">åœŸåœŸEdmondæœ¨</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
