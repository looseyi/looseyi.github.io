<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>浅析 cocoapods-binary - Aha Edmond</title>

  
  
  <meta name="description" content="介绍 cocoapods-binary 最早是在 CocoaPods 的 Blog 中发现的：pre-compiling dependencies。虽非官方出品，但却是国内程序员的力作，medium 原版介绍" />
  <meta name="author" content="土土Edmond木" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-ios/cocoapods-binary-1/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="浅析 cocoapods-binary" />
<meta property="og:description" content="介绍 cocoapods-binary 最早是在 CocoaPods 的 Blog 中发现的：pre-compiling dependencies。虽非官方出品，但却是国内程序员的力作，medium 原版介绍" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-ios/cocoapods-binary-1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-02T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-10-02T00:00:00&#43;00:00" />


  
  <meta itemprop="name" content="浅析 cocoapods-binary">
<meta itemprop="description" content="介绍 cocoapods-binary 最早是在 CocoaPods 的 Blog 中发现的：pre-compiling dependencies。虽非官方出品，但却是国内程序员的力作，medium 原版介绍"><meta itemprop="datePublished" content="2021-10-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-10-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="4707">
<meta itemprop="keywords" content="CocoaPods,iOS,Binary," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="浅析 cocoapods-binary"/>
<meta name="twitter:description" content="介绍 cocoapods-binary 最早是在 CocoaPods 的 Blog 中发现的：pre-compiling dependencies。虽非官方出品，但却是国内程序员的力作，medium 原版介绍"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2021-10-02</time>
      
      <span>土土Edmond木</span>
      
    </p>
    <h1>浅析 cocoapods-binary</h1>
  </header>
  <section class="post-content"><h1 id="介绍">介绍</h1>
<p>cocoapods-binary 最早是在 CocoaPods 的 Blog 中发现的：<a href="https://guides.cocoapods.org/plugins/pre-compiling-dependencies.html">pre-compiling dependencies</a>。虽非官方出品，但却是国内程序员的力作，medium 原版介绍：<a href="https://medium.com/@gaojiji/%E5%8A%A0%E5%BF%AB-cocoapods-%E9%A1%B9%E7%9B%AE%E7%BC%96%E8%AF%91%E6%97%B6%E9%97%B4-pod-%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84%E5%82%BB%E7%93%9C%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-6b791daf192d">Pod 预编译的傻瓜式解决方案</a>：</p>
<blockquote>
<p>A CocoaPods plugin to integrate pods in form of prebuilt frameworks, not source code, by adding <strong>just one flag</strong> in podfile. Speed up compiling dramatically.</p>
</blockquote>
<p>简单来说，cocoapods-binary 通过开关，在 pod insatll 的过程中进行 library 的预编译，生成 framework，并自动集成到项目中。</p>
<p>整个预编译工作分成了三个阶段来完成：</p>
<ul>
<li>binary pod 的安装</li>
<li>binary  pod 的预编译</li>
<li>binary pod 的集成</li>
</ul>
<h1 id="binary-pod-的安装">Binary Pod 的安装</h1>
<p>Binary Pod 的安装作是以 <code>pre_install</code> hook 作为入口，开始插件的运作。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gfopbdyts7j20l10f3dh6.jpg" alt="pre_install.png"></p>
<p>当我们在命令行中执行 <code>pod install</code>，CocoaPods 会依次执行 👆 图的几个方法。cocoapods-binary 的 <code>pre_install</code> 就是在 prepare 阶段插入的逻辑。</p>
<p>这里的 <code>pre_install</code> 不同于 <code>Podfile</code> 中的 <a href="https://guides.cocoapods.org/syntax/podfile.html#pre_install">pre_install</a>，其拦截方式如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">HooksManager</span><span style="color:#719e07">.</span>register(<span style="color:#2aa198">&#39;cocoapods-binary&#39;</span>, <span style="color:#2aa198">:pre_install</span>) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>installer_context<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>	<span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">end</span>
</code></pre></div><p>利用 CocoaPods 提供的 <a href="https://www.rubydoc.info/github/CocoaPods/CocoaPods/Pod/HooksManager">HooksManager</a> 注册 <code>pre_install</code> hook 来下载 binary pods。过程分两步：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gflvtlvtqvj208n067aa9.jpg" alt="Main.png"></p>
<h2 id="环境检查">环境检查</h2>
<p>环境检查，首先是通过标记全局的 <code>is_prebuild_stage</code> 来防止 <code>pre_install</code> 重复的进入。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">.</span>is_prebuild_stage
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  	 <span style="color:#719e07">next</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">end</span>
</code></pre></div><p>接着检查 podfile 是否设置了 <code>use_framework!</code>。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>podfile <span style="color:#719e07">=</span> installer_context<span style="color:#719e07">.</span>podfile
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>podfile<span style="color:#719e07">.</span>target_definition_list<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>target_definition<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">next</span> <span style="color:#719e07">if</span> target_definition<span style="color:#719e07">.</span>prebuild_framework_pod_names<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#719e07">if</span> <span style="color:#719e07">not</span> target_definition<span style="color:#719e07">.</span>uses_frameworks?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>        <span style="color:#cb4b16">STDERR</span><span style="color:#719e07">.</span>puts <span style="color:#2aa198">&#34;[!] Cocoapods-binary requires `use_frameworks!`&#34;</span><span style="color:#719e07">.</span>red
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>        <span style="color:#b58900">exit</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">end</span>
</code></pre></div><p>即 cocoapods-binary 需要打出的包为 framework 的形式。了解更多 CocoaPods 使用 framework 的原因，请猛戳 <a href="https://stackoverflow.com/questions/41210249/why-do-we-use-use-frameworks-in-cocoapods">这里</a>。</p>
<h2 id="binary-pod-的下载安装">Binary Pod 的下载安装</h2>
<blockquote>
<p>这里说的 binary pod 都是在 podfile 中被标记为 <code>:binary =&gt; true</code> 的。</p>
</blockquote>
<p>安装前需要 hook 相关方法进行预编译状态检查，并在安装结束后将它们重置。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">.</span>is_prebuild_stage <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Podfile</span><span style="color:#719e07">::</span><span style="color:#cb4b16">DSL</span><span style="color:#719e07">.</span>enable_prebuild_patch <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Installer</span><span style="color:#719e07">.</span>force_disable_integration <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Config</span><span style="color:#719e07">.</span>force_disable_write_lockfile <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Installer</span><span style="color:#719e07">.</span>disable_install_complete_message <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07">...</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#586e75"># install 成功后将 👆 5 个变量重置为 false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">UserInterface</span><span style="color:#719e07">.</span>warnings <span style="color:#719e07">=</span> <span style="color:#719e07">[]</span> <span style="color:#586e75"># clean the warning in the prebuild step, it&#39;s duplicated.</span>
</code></pre></div><p>接着初始化 binary_installer：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>update <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>repo_update <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">include</span> <span style="color:#cb4b16">ObjectSpace</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#cb4b16">ObjectSpace</span><span style="color:#719e07">.</span>each_object(<span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Installer</span>) { <span style="color:#719e07">|</span>installer<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    update <span style="color:#719e07">=</span> installer<span style="color:#719e07">.</span>update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    repo_update <span style="color:#719e07">=</span> installer<span style="color:#719e07">.</span>repo_update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>standard_sandbox <span style="color:#719e07">=</span> installer_context<span style="color:#719e07">.</span>sandbox
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>prebuild_sandbox <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">PrebuildSandbox</span><span style="color:#719e07">.</span>from_standard_sandbox(standard_sandbox)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>prebuild_podfile <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Podfile</span><span style="color:#719e07">.</span>from_Ruby(podfile<span style="color:#719e07">.</span>defined_in_file)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>lockfile <span style="color:#719e07">=</span> installer_context<span style="color:#719e07">.</span>lockfile
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>binary_installer <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Installer</span><span style="color:#719e07">.</span>new(prebuild_sandbox, prebuild_podfile, lockfile)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#586e75"># install ...</span>
</code></pre></div><p>installer 的初始化需要：<code>prebuild_sandbox</code>、<code>prebuild_podfile</code>、<code>lockfile</code>。</p>
<p><code>prebuild_sandbox</code> 管理的目录在 <code>Pods/_Prebuild</code>，它是 Sandbox 的子类。Sandbox 管理着 CocoaPods 的 <code>/Pods</code> 目录。</p>
<p>lockfile 和 prebuild_podfile 是分别从工程目录的 <code>podfile.lock</code> 和 <code>Podfile</code> 中读取的。</p>
<h3 id="install">install</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> binary_installer<span style="color:#719e07">.</span>have_exact_prebuild_cache? <span style="color:#719e07">&amp;&amp;</span> <span style="color:#719e07">!</span>update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    binary_installer<span style="color:#719e07">.</span>install_when_cache_hit!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    binary_installer<span style="color:#719e07">.</span>update <span style="color:#719e07">=</span> update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    binary_installer<span style="color:#719e07">.</span>repo_update <span style="color:#719e07">=</span> repo_update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    binary_installer<span style="color:#719e07">.</span>install!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">end</span>
</code></pre></div><p>当缓存命中且没有 pod 需要更新时，会执行 <code>install_when_cache_hit!</code> （就是打印一下 cache pods），否则开始 binary pod 的下载，下载目录就在  <code>Pods/_Prebuild</code> 下。</p>
<h2 id="预编译环境控制">预编译环境控制</h2>
<p>聊一下上面的 5 个环境控制开关，定义在 <a href="https://github.com/leavez/cocoapods-binary/blob/master/lib/cocoapods-binary/helper/feature_switches.rb">feature_switches.rb</a> 。</p>
<h3 id="is_prebuild_stag">is_prebuild_stag</h3>
<blockquote>
<p>用于标记当前是否在进行 binary install。</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>class_attr_accessor <span style="color:#2aa198">:is_prebuild_stage</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">class_attr_accessor</span>(symbol)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>class<span style="color:#719e07">.</span>send(<span style="color:#2aa198">:attr_accessor</span>, symbol)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">end</span>
</code></pre></div><p><code>attr_accessor</code> 是 Ruby 为 instance 提供的 Access 方法，类似 Objc 的 <code>@perperty</code> 可以自动生成 getter &amp; setter。作者利用 Ruby 的动态调用，将 symbol 发送给 <code>attr_accessor</code> 来添加 <code>class_attr_accessor</code> 的扩展。</p>
<h3 id="enable_prebuild_patch">enable_prebuild_patch</h3>
<blockquote>
<p>用于过滤出需要预编译的 pod，默认为 false。</p>
</blockquote>
<p>Cocoapods-Binary 在<a href="https://github.com/leavez/cocoapods-binary#usage">使用说明</a>中提到过两种设置预编译的方式：</p>
<ul>
<li>针对单个具体的 pod 的可选参数：<code>:binary =&gt; true</code></li>
<li>在所有 targets 之前的全局参数：<code>all_binary!</code></li>
</ul>
<p>enable_prebuild_patch 就是用于实现这两个变量的判断逻辑，只有在 binary install 时会将 enable_prebuild_patch 设为 true，开启之后不需要预编译的 <code>pod</code> 都会被忽略掉。实现如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">Podfile</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">module</span> DSL        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        @@enable_prebuild_patch <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">enable_prebuild_patch</span>(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>            @@enable_prebuild_patch <span style="color:#719e07">=</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        old_method <span style="color:#719e07">=</span> <span style="color:#b58900">instance_method</span>(<span style="color:#2aa198">:pod</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        define_method(<span style="color:#2aa198">:pod</span>) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span><span style="color:#b58900">name</span>, <span style="color:#719e07">*</span>args<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            <span style="color:#719e07">if</span> <span style="color:#719e07">!</span>@@enable_prebuild_patch
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>                old_method<span style="color:#719e07">.</span>bind(<span style="color:#b58900">self</span>)<span style="color:#719e07">.</span>(<span style="color:#b58900">name</span>, <span style="color:#719e07">*</span>args)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>                <span style="color:#719e07">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>            <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>            <span style="color:#586e75"># --- patch content ---</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>            <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span><span style="color:#719e07">end</span>
</code></pre></div><p>由于可选参数 <code>:binary =&gt; true</code> 是添加在每个 pod 上，因此我们需要先 hook pod 实现来获取 options。</p>
<ol>
<li>通过 <code>instance_method</code> 获取旧的 <code>pod</code> 方法</li>
<li>用 <code>define_method</code> 来完成重载</li>
<li>以 <code>old_method.bind(self).(name, *args)</code> 完成原有逻辑的调用。</li>
</ol>
<p><strong>Ruby Method Swizzling 三部曲</strong> 😂 ，后续还有许多使用该方式的 hook 操作。</p>
<p>接着看 patch content 逻辑：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>should_prebuild <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Podfile</span><span style="color:#719e07">::</span><span style="color:#cb4b16">DSL</span><span style="color:#719e07">.</span>prebuild_all
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>local <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>options <span style="color:#719e07">=</span> args<span style="color:#719e07">.</span>last
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">if</span> options<span style="color:#719e07">.</span>is_a?(<span style="color:#cb4b16">Hash</span>) <span style="color:#719e07">and</span> options<span style="color:#719e07">[</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Prebuild</span><span style="color:#719e07">.</span>keyword<span style="color:#719e07">]</span> <span style="color:#719e07">!=</span> <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    should_prebuild <span style="color:#719e07">=</span> options<span style="color:#719e07">[</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Prebuild</span><span style="color:#719e07">.</span>keyword<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    local <span style="color:#719e07">=</span> (options<span style="color:#719e07">[</span><span style="color:#2aa198">:path</span><span style="color:#719e07">]</span> <span style="color:#719e07">!=</span> <span style="color:#719e07">nil</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">if</span> should_prebuild <span style="color:#719e07">and</span> (<span style="color:#719e07">not</span> local)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    old_method<span style="color:#719e07">.</span>bind(<span style="color:#b58900">self</span>)<span style="color:#719e07">.</span>(<span style="color:#b58900">name</span>, <span style="color:#719e07">*</span>args)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">end</span>
</code></pre></div><ol>
<li>
<p>检查总开关 <code>prebuild_all</code> 对应的是 <code>all_binary!</code> 的声明。</p>
</li>
<li>
<p>检查 <code>pod</code> 方法中是否存在可选参数 <code>:binary</code>，并更新 <code>should_prebuild</code></p>
</li>
<li>
<p>只有 <code>should_prebuild</code> 为 true 的 pod 方法才会走原有逻辑，false 的会被忽略</p>
</li>
</ol>
<p>作者通过这样的配合完成了一键 <code>all_binary!</code> 和单个 <code>:binary</code> 的个性化设置。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gfm7kp2ee5j20ln0dqabf.jpg" alt="enable_prebuild_patch.png"></p>
<h3 id="force_disable_integration">force_disable_integration</h3>
<blockquote>
<p>a force disable option for integral</p>
</blockquote>
<p>正常 CocoaPods 安装后会执行 <a href="https://www.rubydoc.info/github/CocoaPods/CocoaPods/Pod%2FInstaller:integrate_user_project">integrate_user_project</a> 整合用户的 project：</p>
<ul>
<li>创建 xcode 的 workspace, 并整合所有的 target 到新的 workspace 中</li>
<li>抛出 Podfile 空项目依赖和 xcconfig 是否被原有的 xcconfig 所覆盖依赖相关的警告。</li>
</ul>
<p>这里 通过 force_disable_integration 拦截后强制跳过合成这一步。</p>
<h3 id="disable_install_complete_message">disable_install_complete_message</h3>
<blockquote>
<p>a option to disable install complete message</p>
</blockquote>
<p>install 后会执行 <a href="https://www.rubydoc.info/github/CocoaPods/CocoaPods/Pod/Installer:print_post_install_message">print_post_install_message</a> 来输出各种收集的警告，这里同样以 hook 强制跳过。</p>
<h3 id="force_disable_write_lockfile">force_disable_write_lockfile</h3>
<blockquote>
<p>option to disable write lockfiles</p>
</blockquote>
<p>正常的 pod install 会生成 <code>podfile.lock</code> 文件以保存上次的 Pods 依赖配置。在预编译中我们通过替换 <code>lockfile_path</code> 将锁文件保存到了 <code>Pods/_Prebuild/Manifest.lock.tmp</code>。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">Config</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    @@force_disable_write_lockfile <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">force_disable_write_lockfile</span>(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        @@force_disable_write_lockfile <span style="color:#719e07">=</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    old_method <span style="color:#719e07">=</span> <span style="color:#b58900">instance_method</span>(<span style="color:#2aa198">:lockfile_path</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    define_method(<span style="color:#2aa198">:lockfile_path</span>) <span style="color:#719e07">do</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">if</span> @@force_disable_write_lockfile
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            <span style="color:#719e07">return</span> <span style="color:#cb4b16">PrebuildSandbox</span><span style="color:#719e07">.</span>from_standard_sanbox_path(sandbox_root)<span style="color:#719e07">.</span>root <span style="color:#719e07">+</span> <span style="color:#2aa198">&#39;Manifest.lock.tmp&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>            <span style="color:#719e07">return</span> old_method<span style="color:#719e07">.</span>bind(<span style="color:#b58900">self</span>)<span style="color:#719e07">.</span>()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">end</span>
</code></pre></div><p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gfm5t282twj20xb0hqjut.jpg" alt="feature_switch.png"></p>
<h1 id="binary-pod-的预编译">Binary Pod 的预编译</h1>
<p>cocoapods-binary 在下载 binary pod 源码前会先检查是否已经有预编译好的二进制包，如果没有缓存才会开始binary pod 的下载和预编译。</p>
<h2 id="预编译的缓存查询">预编译的缓存查询</h2>
<p>缓存查询方法为 <strong>have_exact_prebuild_cache?</strong> ，我们在前面提到过，来看其实现：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">have_exact_prebuild_cache?</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">return</span> <span style="color:#719e07">false</span> <span style="color:#719e07">if</span> local_manifest <span style="color:#719e07">==</span> <span style="color:#719e07">nil</span> <span style="color:#586e75"># step 1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#586e75"># step 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    changes <span style="color:#719e07">=</span> prebuild_pods_changes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    added <span style="color:#719e07">=</span> changes<span style="color:#719e07">.</span>added
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    changed <span style="color:#719e07">=</span> changes<span style="color:#719e07">.</span>changed 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    unchanged <span style="color:#719e07">=</span> changes<span style="color:#719e07">.</span>unchanged
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    deleted <span style="color:#719e07">=</span> changes<span style="color:#719e07">.</span>deleted 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    exsited_framework_pod_names <span style="color:#719e07">=</span> sandbox<span style="color:#719e07">.</span>exsited_framework_pod_names
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    missing <span style="color:#719e07">=</span> unchanged<span style="color:#719e07">.</span>select <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>pod_name<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#719e07">not</span> exsited_framework_pod_names<span style="color:#719e07">.</span>include?(pod_name)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    needed <span style="color:#719e07">=</span> (added <span style="color:#719e07">+</span> changed <span style="color:#719e07">+</span> deleted <span style="color:#719e07">+</span> missing)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#719e07">return</span> needed<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07">end</span>
</code></pre></div><ol>
<li>检查 <code>PrebuildSandbox</code> 下是否存在 <code>Manifest.lock</code> 文件，没有则说明没有成功执行过 binary pod 安装过也就不会有缓存，可以直接 return false</li>
<li>执行 <code>prebuild_pods_changes</code> 获取 pod 变更</li>
<li>执行 <code>exsited_framework_pod_names</code> 查看是否有预编译过的 framework</li>
<li>结合前两步的结果判断是否存在缓存</li>
</ol>
<h3 id="预编译的-mainfest-检查">预编译的 mainfest 检查</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">local_manifest</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    <span style="color:#719e07">if</span> <span style="color:#719e07">not</span> @local_manifest_inited
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>        @local_manifest_inited <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>        <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#34;This method should be call before generate project&#34;</span> <span style="color:#719e07">unless</span> <span style="color:#b58900">self</span><span style="color:#719e07">.</span>analysis_result <span style="color:#719e07">==</span> <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>        @local_manifest <span style="color:#719e07">=</span> <span style="color:#b58900">self</span><span style="color:#719e07">.</span>sandbox<span style="color:#719e07">.</span>manifest
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    @local_manifest
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">end</span>
</code></pre></div><p>local_manifest 其实是 ruby 的一个方法，作用上面介绍过，那 Manifest.lock 文件又是啥？详细：<a href="https://www.objc.io/issues/6-build-tools/cocoapods-under-the-hood/">objc.io</a></p>
<blockquote>
<p>This is a copy of the <code>Podfile.lock</code> that gets created every time you run <code>pod install</code>. If you’ve ever seen the error <code>The sandbox is not in sync with the Podfile.lock</code>, it’s because this file is no longer the same as the <code>Podfile.lock</code>.</p>
</blockquote>
<p>由于 <code>Pods</code> 目录并不一定会添加到项目的 version control 中，所以利用 <code>Mainfest.lock</code> 来确保工程师在运行项目前能够准确更新对应的 pod。否则会导致 build 失败等各种问题。</p>
<h3 id="预编译的-pods-变更检查">预编译的 pods 变更检查</h3>
<p>接着通过 <code>prebuild_pods_changes</code> 检查是否有需要更新的 pod：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">prebuild_pods_changes</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">return</span> <span style="color:#719e07">nil</span> <span style="color:#719e07">if</span> local_manifest<span style="color:#719e07">.</span>nil?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">if</span> @prebuild_pods_changes<span style="color:#719e07">.</span>nil?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        changes <span style="color:#719e07">=</span> local_manifest<span style="color:#719e07">.</span>detect_changes_with_podfile(podfile)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        @prebuild_pods_changes <span style="color:#719e07">=</span> <span style="color:#cb4b16">Analyzer</span><span style="color:#719e07">::</span><span style="color:#cb4b16">SpecsState</span><span style="color:#719e07">.</span>new(changes)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#586e75"># save the chagnes info for later stage</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Prebuild</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Passer</span><span style="color:#719e07">.</span>prebuild_pods_changes <span style="color:#719e07">=</span> @prebuild_pods_changes 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    @prebuild_pods_changes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">end</span>
</code></pre></div><p>方法第一行也检查了 <code>local_manifest</code> 是因为会被多处调用，所有这里也添加了判断。核心是依赖 cocoapods-core 的 <a href="https://www.Rubydoc.info/gems/cocoapods-core/Pod%2FLockfile:detect_changes_with_podfile">detect_changes_with_podfile</a> 来获取需要更新的 pods，其描述如下：</p>
<blockquote>
<p>Analyzes the <a href="https://www.Rubydoc.info/gems/cocoapods-core/Pod/Lockfile">Pod::Lockfile</a> and detects any changes applied to the <a href="https://www.Rubydoc.info/gems/cocoapods-core/Pod/Podfile">Podfile</a> since the last installation.</p>
</blockquote>
<p>它对于每个 pod 会检查如下几个状态：</p>
<ul>
<li>added: Pods that weren&rsquo;t present in the Podfile.</li>
<li>changed: Pods that were present in the Podfile but changed:
<ul>
<li>Pods whose version is not compatible anymore with Podfile,</li>
<li>Pods that changed their external options.</li>
</ul>
</li>
<li>removed: Pods that were removed form the Podfile.</li>
<li>unchanged: Pods that are still compatible with Podfile.</li>
</ul>
<p>最后从 <code>unchanged</code> 中查找 <code>exsited_framework_pod_names</code> 来判断是否有已预编译过的 framework。</p>
<h3 id="预编译的-framework-缓存检查">预编译的 framework 缓存检查</h3>
<p>预编译的 framework 检查即 <code> exsited_framework_pod_names</code> 从 <code>exsited_framework_name_pairs</code> 中 map 过来的。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">exsited_framework_pod_names</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    exsited_framework_name_pairs<span style="color:#719e07">.</span>map {<span style="color:#719e07">|</span>pair<span style="color:#719e07">|</span> pair<span style="color:#719e07">[</span><span style="color:#2aa198">1</span><span style="color:#719e07">]</span>}<span style="color:#719e07">.</span>uniq
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">end</span>
</code></pre></div><p><strong>exsited_framework_name_pairs</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">pod_name_for_target_folder</span>(target_folder_path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#b58900">name</span> <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pathname</span><span style="color:#719e07">.</span>new(target_folder_path)<span style="color:#719e07">.</span>children<span style="color:#719e07">.</span>find <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>child<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        child<span style="color:#719e07">.</span>to_s<span style="color:#719e07">.</span>end_with? <span style="color:#2aa198">&#34;.pod_name&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#b58900">name</span> <span style="color:#719e07">=</span> <span style="color:#b58900">name</span><span style="color:#719e07">.</span>basename(<span style="color:#2aa198">&#34;.pod_name&#34;</span>)<span style="color:#719e07">.</span>to_s <span style="color:#719e07">unless</span> <span style="color:#b58900">name</span><span style="color:#719e07">.</span>nil?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#b58900">name</span> <span style="color:#719e07">||=</span> <span style="color:#cb4b16">Pathname</span><span style="color:#719e07">.</span>new(target_folder_path)<span style="color:#719e07">.</span>basename<span style="color:#719e07">.</span>to_s <span style="color:#586e75"># for compatibility with older version</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"># Array&lt;[target_name, pod_name]&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">def</span> <span style="color:#268bd2">exsited_framework_name_pairs</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">return</span> <span style="color:#719e07">[]</span> <span style="color:#719e07">unless</span> generate_framework_path<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    generate_framework_path<span style="color:#719e07">.</span>children()<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>framework_path<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        <span style="color:#719e07">if</span> framework_path<span style="color:#719e07">.</span>directory? <span style="color:#719e07">&amp;&amp;</span> (<span style="color:#719e07">not</span> framework_path<span style="color:#719e07">.</span>children<span style="color:#719e07">.</span>empty?)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>            <span style="color:#719e07">[</span>framework_path<span style="color:#719e07">.</span>basename<span style="color:#719e07">.</span>to_s,  pod_name_for_target_folder(framework_path)<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>            <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    <span style="color:#719e07">end</span><span style="color:#719e07">.</span>reject(<span style="color:#719e07">&amp;</span><span style="color:#2aa198">:nil?</span>)<span style="color:#719e07">.</span>uniq
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">end</span>
</code></pre></div><p>该方法虽然逻辑简单，却是比较核心的逻辑之一。</p>
<p>它最终调用 <code>pod_name_for_target_folder</code> 来检查 <code>Pods/_Prebuild/GeneratedFrameworks</code> 目录下对应的 framework 中是否存在以 <strong>.pod_name</strong> 为结尾的文件，来标示该 framework 是否完成了预编译。它就是一个空文件而已。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gfmci591ncj20np0g3q53.jpg" alt="exact_prebuild_cache.png"></p>
<h2 id="target-编译">Target 编译</h2>
<p>通过 <code>pre_install</code> 下载完 pods 后就要开始编译啦，入口如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>old_method2 <span style="color:#719e07">=</span> <span style="color:#b58900">instance_method</span>(<span style="color:#2aa198">:run_plugins_post_install_hooks</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>define_method(<span style="color:#2aa198">:run_plugins_post_install_hooks</span>) <span style="color:#719e07">do</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    old_method2<span style="color:#719e07">.</span>bind(<span style="color:#b58900">self</span>)<span style="color:#719e07">.</span>()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#719e07">if</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span>is_prebuild_stage
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>        <span style="color:#b58900">self</span><span style="color:#719e07">.</span>prebuild_frameworks!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">end</span>
</code></pre></div><p>为了保证 <code>prebuild_frameworks!</code> 是在最后一步执行，作者并未通过 <code>HooksManager</code> 来添加 plugins 的 <code>post_install</code> 而是直接 <strong>Override</strong> 了它的调用方法。</p>
<p>关于 install hooks，CocoaPods 提供了两种类型：Podfile hook 和 plugin hook。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gfnfd0b99ij210r0hqtbm.jpg" alt="hooks.png"></p>
<p>插件的 hooks 操作都是通过 <code>HooksManager</code> 来完成调用的，podfile 中提供的 hooks 则是单独的方法执行时机也是各有不同。</p>
<h3 id="prebuild_frameworks">prebuild_frameworks!</h3>
<p>方法比较长就不贴完整的代码了，概括如下：</p>
<p><strong>第一步：获取待更新的 targets</strong></p>
<p>targets 的获取逻辑同预编译缓存检查中的 <strong>needed</strong> 的获取有些类似。</p>
<ol>
<li>通过 <code>prebuild_pods_changes</code> 和 <code>exsited_framework_pod_names</code> 得到 <code>root_names_to_update</code></li>
<li>接着用 <code>fast_get_targets_for_pod_name</code> 找出对应的 taregets</li>
<li>调用 <code>recursive_dependent_targets</code> 将 targets 的依赖 map 出来，合并到 targets 中并去重复</li>
<li>过滤掉已预编译过的 targets 以及被标记为  <code>:binary =&gt; false</code> 的 target。</li>
</ol>
<p>注意，如果 pod target 原本就是以  <code>.a + .h</code>  形式存在的二进制包，则会被直接过滤掉。</p>
<p><strong>第二步：完成 pod target 的编译、保存资源文件、写入以 <code>.pod_name</code> 为结尾的标记文件。</strong></p>
<p>核心逻辑是通过 <code>xcodebuild</code> 命令来完成编译打包，最后将生成的二进制包和 dSYM 输出到 <code>GeneratedFrameworks</code> 目录。需要注意的是对于 iOS 平台生成的二进制包同时包含了模拟器和真机的二进制文件，分别打包后再通过 <code>libo</code> 合并成一份 <strong>Fat Binary</strong> 的。</p>
<p>完整的构建代码在 <a href="https://github.com/leavez/cocoapods-binary/blob/master/lib/cocoapods-binary/rome/build_framework.rb">build_framework.rb</a> 中这里也不作展开，就补充两点：</p>
<ol>
<li>对于 static framework 需要在编译后，手动将相关资源 copy 回来。因此，需要先将对应路径保存。</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>path_objects <span style="color:#719e07">=</span> resources<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>path<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    object <span style="color:#719e07">=</span> <span style="color:#cb4b16">Prebuild</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Passer</span><span style="color:#719e07">::</span><span style="color:#cb4b16">ResourcePath</span><span style="color:#719e07">.</span>new
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    object<span style="color:#719e07">.</span>real_file_path <span style="color:#719e07">=</span> framework_path <span style="color:#719e07">+</span> <span style="color:#cb4b16">File</span><span style="color:#719e07">.</span>basename(path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    object<span style="color:#719e07">.</span>target_file_path <span style="color:#719e07">=</span> path<span style="color:#719e07">.</span>gsub(<span style="color:#2aa198">&#39;${PODS_ROOT}&#39;</span>, standard_sandbox_path<span style="color:#719e07">.</span>to_s) <span style="color:#719e07">if</span> path<span style="color:#719e07">.</span>start_with? <span style="color:#2aa198">&#39;${PODS_ROOT}&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    object<span style="color:#719e07">.</span>target_file_path <span style="color:#719e07">=</span> path<span style="color:#719e07">.</span>gsub(<span style="color:#2aa198">&#34;${PODS_CONFIGURATION_BUILD_DIR}&#34;</span>, standard_sandbox_path<span style="color:#719e07">.</span>to_s) <span style="color:#719e07">if</span> path<span style="color:#719e07">.</span>start_with? <span style="color:#2aa198">&#34;${PODS_CONFIGURATION_BUILD_DIR}&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#cb4b16">Prebuild</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Passer</span><span style="color:#719e07">.</span>resources_to_copy_for_static_framework<span style="color:#719e07">[</span>target<span style="color:#719e07">.</span>name<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> path_objects
</code></pre></div><ol start="2">
<li>如果 pod 中包含了 <strong>vendored library</strong> 和 <strong>vendered framework</strong> 也会在 build 后 copy 回来。</li>
</ol>
<p><strong>第三步：清理无用文件和 pods</strong></p>
<p>注意！install 完成后仅保存 <code>PrebuildSandbox</code> 下的 <code>Manifest.lock</code> 以及 <code>GeneratedFrameworks</code> 目录下的 framework，而下载至 <code>_Prebuild</code> 目录下的源码都会被清理。</p>
<h1 id="binary-pod-的集成">Binary Pod 的集成</h1>
<p>最后集成工作是在普通的 pod install 模式下，同样通过 <strong>Ruby Method Swizzling 三部曲</strong> 来拦截的。</p>
<h2 id="resolve-dependencies">resolve dependencies</h2>
<p>resolve_dependencies 在 cocoapods 中是通过创建 <code>Analyzer</code> 来分析 podfile 的 dependencies。</p>
<p>这里 hook 后主要用于清理并修改 prebuild specs 中对应的数据。</p>
<ol>
<li>删除 prebuild framework 时下载的 source code 和生成的 target support files；</li>
<li>将 prebuild spec 中的 source_files 的配置全部置空，然后用 prebuild 后的 framework 作为 vender framework 替代；</li>
<li>清除 prebuild spec 中的 resource_bundles；</li>
</ol>
<p>简化后逻辑如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>old_method2 <span style="color:#719e07">=</span> <span style="color:#b58900">instance_method</span>(<span style="color:#2aa198">:resolve_dependencies</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>define_method(<span style="color:#2aa198">:resolve_dependencies</span>) <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>		
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>remove_target_files_if_needed <span style="color:#586e75"># 1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    old_method2<span style="color:#719e07">.</span>bind(<span style="color:#b58900">self</span>)<span style="color:#719e07">.</span>()    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>validate_every_pod_only_have_one_form
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    cache <span style="color:#719e07">=</span> <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    specs <span style="color:#719e07">=</span> <span style="color:#b58900">self</span><span style="color:#719e07">.</span>analysis_result<span style="color:#719e07">.</span>specifications
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    prebuilt_specs <span style="color:#719e07">=</span> (specs<span style="color:#719e07">.</span>select <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>spec<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#b58900">self</span><span style="color:#719e07">.</span>prebuild_pod_names<span style="color:#719e07">.</span>include? spec<span style="color:#719e07">.</span>root<span style="color:#719e07">.</span>name
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#719e07">end</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    prebuilt_specs<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>spec<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>		  <span style="color:#586e75"># 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        targets <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">.</span>fast_get_targets_for_pod_name(spec<span style="color:#719e07">.</span>root<span style="color:#719e07">.</span>name, <span style="color:#b58900">self</span><span style="color:#719e07">.</span>pod_targets, cache)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        targets<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>target<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>            framework_file_path <span style="color:#719e07">=</span> target<span style="color:#719e07">.</span>framework_name
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>            framework_file_path <span style="color:#719e07">=</span> target<span style="color:#719e07">.</span>name <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;/&#34;</span> <span style="color:#719e07">+</span> framework_file_path <span style="color:#719e07">if</span> targets<span style="color:#719e07">.</span>count <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>            add_vendered_framework(spec, target<span style="color:#719e07">.</span>platform<span style="color:#719e07">.</span>name<span style="color:#719e07">.</span>to_s, framework_file_path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>        empty_source_files(spec)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>			
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>        <span style="color:#586e75"># 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        <span style="color:#719e07">if</span> spec<span style="color:#719e07">.</span>attributes_hash<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;resource_bundles&#34;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>            bundle_names <span style="color:#719e07">=</span> spec<span style="color:#719e07">.</span>attributes_hash<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;resource_bundles&#34;</span><span style="color:#719e07">].</span>keys
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>            spec<span style="color:#719e07">.</span>attributes_hash<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;resource_bundles&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>            spec<span style="color:#719e07">.</span>attributes_hash<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;resources&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">||=</span> <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>            spec<span style="color:#719e07">.</span>attributes_hash<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;resources&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">+=</span> bundle_names<span style="color:#719e07">.</span>map{<span style="color:#719e07">|</span>n<span style="color:#719e07">|</span> n<span style="color:#719e07">+</span><span style="color:#2aa198">&#34;.bundle&#34;</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>        <span style="color:#586e75"># to avoid the warning of missing license</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>        spec<span style="color:#719e07">.</span>attributes_hash<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;license&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span><span style="color:#719e07">end</span>
</code></pre></div><p>关于这三步操作，分别做一些解答。</p>
<p>第一步的清理工作是在执行原有逻辑前执行，是为了避免生成的旧的 targets 文件触发文件修改的警告。</p>
<p>call original 后又执行了一次 <code>validate_every_pod_only_have_one_form</code>，虽然没有副作用，但目的是为了避免一些异常情况下，某些 pod 以源码的形式又出现在其他 target 中。</p>
<p><strong>target_checker</strong> 中作者提到过 cocoapods-binary 有一个限制：</p>
<blockquote>
<p>一个 pod 只能允许对应一个 target。</p>
</blockquote>
<p>理由就是我们在第二步将预编译后的 static framework 作为 vender framework 的方式嵌入到项目中，同时清空了全部 platform 上的 source_files 的配置。</p>
<p>第三步对于 resource bundle target 的清理，是为了避免 resource bundle 的重复 copy。</p>
<p>因为 pod install 中 ，如果 podspec 指定了 <code>resource_bundles</code> ，Xcode 是会为我们生成 bundle target 的。而我们在 static framework 中已经生成并 copy 了，所以避免重复需要清除一下。</p>
<h2 id="download-dependencies">download dependencies</h2>
<p>这一步是 hook 了 <code>download_dependencies</code> 执行中会触发的一个方法：<code>install_source_of_pod</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>old_method <span style="color:#719e07">=</span> <span style="color:#b58900">instance_method</span>(<span style="color:#2aa198">:install_source_of_pod</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>define_method(<span style="color:#2aa198">:install_source_of_pod</span>) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>pod_name<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75"># original logic ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> <span style="color:#b58900">self</span><span style="color:#719e07">.</span>prebuild_pod_names<span style="color:#719e07">.</span>include? pod_name
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        pod_installer<span style="color:#719e07">.</span>install_for_prebuild!(<span style="color:#b58900">self</span><span style="color:#719e07">.</span>sandbox)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        pod_installer<span style="color:#719e07">.</span>install!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#586e75"># original logic ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">end</span>
</code></pre></div><p>这里的目的是为跳过 binary pod 的下载，以及完成 symbol link 的操作。简化逻辑如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">install_for_prebuild!</span>(standard_sanbox)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">return</span> <span style="color:#719e07">if</span> standard_sanbox<span style="color:#719e07">.</span>local? <span style="color:#b58900">self</span><span style="color:#719e07">.</span>name
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    prebuild_sandbox <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">PrebuildSandbox</span><span style="color:#719e07">.</span>from_standard_sandbox(standard_sanbox)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    target_names <span style="color:#719e07">=</span> prebuild_sandbox<span style="color:#719e07">.</span>existed_target_names_for_pod_name(<span style="color:#b58900">self</span><span style="color:#719e07">.</span>name)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    target_names<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span><span style="color:#b58900">name</span><span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        real_file_folder <span style="color:#719e07">=</span> prebuild_sandbox<span style="color:#719e07">.</span>framework_folder_path_for_target_name(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>                
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        target_folder <span style="color:#719e07">=</span> standard_sanbox<span style="color:#719e07">.</span>pod_dir(<span style="color:#b58900">self</span><span style="color:#719e07">.</span>name)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#719e07">if</span> target_names<span style="color:#719e07">.</span>count <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">1</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>            target_folder <span style="color:#719e07">+=</span> real_file_folder<span style="color:#719e07">.</span>basename
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        target_folder<span style="color:#719e07">.</span>rmtree <span style="color:#719e07">if</span> target_folder<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        target_folder<span style="color:#719e07">.</span>mkpath
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>        walk(real_file_folder) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>child<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>            source <span style="color:#719e07">=</span> child
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>            <span style="color:#586e75"># only make symlink to file and `.framework` folder</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>            <span style="color:#719e07">if</span> child<span style="color:#719e07">.</span>directory? <span style="color:#719e07">and</span> <span style="color:#719e07">[</span><span style="color:#2aa198">&#34;.framework&#34;</span>, <span style="color:#2aa198">&#34;.dSYM&#34;</span><span style="color:#719e07">].</span>include? child<span style="color:#719e07">.</span>extname
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>                mirror_with_symlink(source, real_file_folder, target_folder)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>                <span style="color:#719e07">next</span> <span style="color:#719e07">false</span>  <span style="color:#586e75"># return false means don&#39;t go deeper</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>            <span style="color:#719e07">elsif</span> child<span style="color:#719e07">.</span>file?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>                mirror_with_symlink(source, real_file_folder, target_folder)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>                <span style="color:#719e07">next</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>            <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>                <span style="color:#719e07">next</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>            <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>        <span style="color:#586e75"># symbol link copy resource for static framework</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>        <span style="color:#b58900">hash</span> <span style="color:#719e07">=</span> <span style="color:#cb4b16">Prebuild</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Passer</span><span style="color:#719e07">.</span>resources_to_copy_for_static_framework <span style="color:#719e07">||</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>        path_objects <span style="color:#719e07">=</span> <span style="color:#b58900">hash</span><span style="color:#719e07">[</span><span style="color:#b58900">name</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>        <span style="color:#719e07">if</span> path_objects <span style="color:#719e07">!=</span> <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>            path_objects<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>object<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>                make_link(object<span style="color:#719e07">.</span>real_file_path, object<span style="color:#719e07">.</span>target_file_path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>            <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>    <span style="color:#719e07">end</span> <span style="color:#586e75"># of for each </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span><span style="color:#719e07">end</span> <span style="color:#586e75"># of method</span>
</code></pre></div><p>核心是 <strong>walk</strong> 方法，它遍历每个 static framework 目录下的文件和 <code>.framework</code> 文件夹，将其作为 <code>Pods</code> 目录下对应文件的引用。</p>
<h2 id="embedframeworksscript">EmbedFrameworksScript</h2>
<p>这一步是为了解决 symbol link 后，对于 embeded framework 中产生的问题。<code>embedded framework</code> 是苹果在 iOS 8 后提出的代码共享方案，为了解决宿主 App 和 Extensions 的代码共用而产生的。详细 <a href="https://medium.com/hootsuite-engineering/an-introduction-to-creating-and-distributing-embedded-frameworks-in-ios-367b7a45a304">medium</a> 文章；</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Ruby" data-lang="Ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>old_method <span style="color:#719e07">=</span> <span style="color:#b58900">instance_method</span>(<span style="color:#2aa198">:script</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>define_method(<span style="color:#2aa198">:script</span>) <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    script <span style="color:#719e07">=</span> old_method<span style="color:#719e07">.</span>bind(<span style="color:#b58900">self</span>)<span style="color:#719e07">.</span>()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    patch <span style="color:#719e07">=</span> <span style="color:#2aa198">&lt;&lt;-SH.strip_heredoc
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#2aa198"></span>        <span style="color:#586e75">#!/bin/sh</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        old_read_link<span style="color:#719e07">=</span><span style="color:#586e75">`which readlink`</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        readlink () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>            path<span style="color:#719e07">=</span><span style="color:#586e75">`$old_read_link $1`</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            <span style="color:#719e07">if</span> <span style="color:#719e07">[</span> $(echo <span style="color:#2aa198">&#34;$path&#34;</span> <span style="color:#719e07">|</span> cut <span style="color:#719e07">-</span>c <span style="color:#2aa198">1</span><span style="color:#719e07">-</span><span style="color:#2aa198">1</span>) <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;/&#39;</span> <span style="color:#719e07">]</span>; <span style="color:#719e07">then</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>                echo $path;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>            <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>                echo <span style="color:#2aa198">&#34;`dirname $1`/$path&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>            fi
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#cb4b16">SH</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    script <span style="color:#719e07">=</span> script<span style="color:#719e07">.</span>gsub <span style="color:#2aa198">&#34;rsync --delete&#34;</span>, <span style="color:#2aa198">&#34;rsync --copy-links --delete&#34;</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    patch <span style="color:#719e07">+</span> script
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">end</span>
</code></pre></div><p>上一步中把 pod target 文件夹中的 framework 文件改成了相对路径的 symblink，而 EmbedFrameworksScript 是通过 <code>readlink</code> 的方式来读取路径，它对相对路径的处理不太好，这里需要重写。</p>
<p>重写其实就是在把相对路径改为绝对路径。</p>
<h2 id="流程图">流程图</h2>
<p>最后贴一下，梳理的流程图：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/cocoapods-binary-10-flow.png" alt=""></p>
<h2 id="结果对比">结果对比</h2>
<p>基本的模块介绍完，我们来看看，引入 cocoapods-binary 插件后 Pods 的文件构成：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/cocoapods-binary-08-prebuild-product.png" alt=""></p>
<p>_Prebuild 目录下则完整保存了一份 Pods 源代码，同时多出来的 GeneratedFrameworks 则缓存了预编译后的 binary 文件以及 dSYM 符号表。在最后的 integration 阶段 symbol link 替换完后源码则会被删除同时指向binary。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/cocoapods-binary-09-linkproduct.png" alt=""></p>
<h2 id="总结">总结</h2>
<p>使用过程中这个方案还是有很多限制的：</p>
<ul>
<li>由于 CocoaPods 在 1.7 以上版本修改了 framework 生成逻辑，不会把 bundle copy 至 framework，因此需要将 Pod 环境固定到 1.6.2；</li>
<li>pod 要支持 binary，header ref 需要变更为 <code>#import &lt;&gt;</code> 或者 <code>@import</code> 以符合 moduler 标准；</li>
<li>需要统一开发环境。如果项目支持 Swift，不同 compiler 编译产物有 Swift 版本兼容问题；</li>
<li>最终的 binary 体积比使用源码的时候大一点，不建议最终上传 Store；</li>
<li>建议 ignore Pods 文件夹，否则在 source code 与 binary 切换过程会有大量 change，增加 git 负担；</li>
<li>如果需要 debug 就需要切换回源码，或者通过 dSYM 映射来完成方法对定位。</li>
</ul>
<p>整体感觉是很不错的思路，适用于人数不多的中小型项目。一旦项目依赖库较多，可能就不太适用了，限制太多，同时对开发的要求和环境的一致性要求比较高。</p>
<p>前期准备基本介绍完了，下一节就是核心的 prebuild 逻辑。先上一张脑图补一补：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/cocoapods-binary-07-class-diagram.png" alt="structure"></p>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/cocoapods">CocoaPods</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/binary">Binary</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/tool/objective-c-framework-for-swift/"><span>←</span><span>Move Objective-C frameworks for Swift</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-cocoapods/09-cocoapods-xcodeproj-edit/"><span>9. Xcode 工程文件编辑</span><span>→</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
