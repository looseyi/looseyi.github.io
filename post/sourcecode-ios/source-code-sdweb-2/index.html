<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>浅析 SDWebImage 5.5.2 - WebP Plugin - Aha Edmond</title>

  
  
  <meta name="description" content="本文基于 SDWebImage 5.5.2。重读的原因也是由于发现它的 API 在不断迭代，许多结构已经不同与早期版本，同时也是为了做一个记录。整体分析可以查看上一篇文章" />
  <meta name="author" content="土土Edmond木" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-ios/source-code-sdweb-2/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="浅析 SDWebImage 5.5.2 - WebP Plugin" />
<meta property="og:description" content="本文基于 SDWebImage 5.5.2。重读的原因也是由于发现它的 API 在不断迭代，许多结构已经不同与早期版本，同时也是为了做一个记录。整体分析可以查看上一篇文章" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-ios/source-code-sdweb-2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-03-11T23:08:12&#43;08:00" />
<meta property="article:modified_time" content="2020-03-11T23:08:12&#43;08:00" />


  
  <meta itemprop="name" content="浅析 SDWebImage 5.5.2 - WebP Plugin">
<meta itemprop="description" content="本文基于 SDWebImage 5.5.2。重读的原因也是由于发现它的 API 在不断迭代，许多结构已经不同与早期版本，同时也是为了做一个记录。整体分析可以查看上一篇文章"><meta itemprop="datePublished" content="2020-03-11T23:08:12&#43;08:00" />
<meta itemprop="dateModified" content="2020-03-11T23:08:12&#43;08:00" />
<meta itemprop="wordCount" content="4349">
<meta itemprop="keywords" content="Source Code,iOS,Cache,WebImage," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="浅析 SDWebImage 5.5.2 - WebP Plugin"/>
<meta name="twitter:description" content="本文基于 SDWebImage 5.5.2。重读的原因也是由于发现它的 API 在不断迭代，许多结构已经不同与早期版本，同时也是为了做一个记录。整体分析可以查看上一篇文章"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2020-03-11</time>
      
      <span>土土Edmond木</span>
      
    </p>
    <h1>浅析 SDWebImage 5.5.2 - WebP Plugin</h1>
  </header>
  <section class="post-content"><p>本文基于 SDWebImage 5.5.2。重读的原因也是由于发现它的 API 在不断迭代，许多结构已经不同与早期版本，同时也是为了做一个记录。整体分析可以查看上一篇文章：<a href="https://looseyi.github.io/post/SourceCode-sdweb/">浅析 SDWebImage 5.5.2</a>。</p>
<p>本篇主要关于其插件系统，如何简单的通过插件来支持多样化的图片格式、支持系统图片加载，富文本 URL 加载，以及第三方插件的集成，比如 <a href="https://airbnb.design/lottie/">Lottie</a>、<a href="https://github.com/ibireme/YYImage">YYImage</a>、<a href="https://github.com/ibireme/YYCache">YYCache</a>、<a href="https://github.com/Flipboard/FLAnimatedImage">FLAnimatedImage</a>。目前支持的如下：</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cgy1gco39siml4j21n40lmgq0.jpg" alt="plugins"></p>
<p>详细请看官方文档：<a href="https://sdwebimage.github.io/">Documen Address</a>。</p>
<h2 id="coder-plugins">Coder Plugins</h2>
<p>我们先从 Coder 的 WebP 开始聊。上篇中只提过一嘴 Coder，这次会稍微具体展开介绍。<a href="https://developers.google.com/speed/webp">WebP</a> 图片格式是由狗爹提出的一种图片压缩格式。SD 在2013.10 SD 就已经支持的了 (<a href="https://github.com/SDWebImage/SDWebImage/releases/tag/3.5">Tag: 3.5</a>) ，当时的做法是通过 CocoaPods 提供的 subspec 的方式来实现的，这个方式一直延续到了4.x 的最后一个版本，也就是在5.x 协议化后去掉的。原来是这么做的：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>s<span style="color:#719e07">.</span>subspec <span style="color:#2aa198">&#39;WebP&#39;</span> <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>webp<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    webp<span style="color:#719e07">.</span>source_files <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;SDWebImage/UIImage+WebP.{h,m}&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    webp<span style="color:#719e07">.</span>xcconfig <span style="color:#719e07">=</span> { <span style="color:#2aa198">&#39;GCC_PREPROCESSOR_DEFINITIONS&#39;</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;$(inherited) SD_WEBP=1&#39;</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    webp<span style="color:#719e07">.</span>dependency <span style="color:#2aa198">&#39;SDWebImage/Core&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    webp<span style="color:#719e07">.</span>dependency <span style="color:#2aa198">&#39;libwebp&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07">end</span>
</code></pre></div><p>大家如果对 subspec 不太熟悉，可以看 <a href="https://guides.cocoapods.org/syntax/podspec.html#subspec">subspec 文档</a>，你可以理解他是当前 Podspec 的一个子集，也可以定义自己的 source_files、dependency、resource_bundle 等，所支持的配置与 Podspec 差不多。</p>
<p>如果我们要开启 WebP 的话就是通过 <code>pod 'SDWebImage/WebP'</code> 或者 <code>pod 'SDWebImage', subspecs: ['WebP']</code> 来设置。可以看到它时通过修改 xcodefig 中预编译宏 <code>GCC_PREPROCESSOR_DEFINITIONS</code> 的 <strong>SD_WEBP=1</strong> 作为标记。然后内部通过 SD_WEBP 这个宏来达到条件编译的效果。</p>
<p>当我们仅需要支持一种图片格式时，是比较简单的，一旦有更多格式需要支持的话，用宏来控制就比较痛苦了：</p>
<ul>
<li>类似 SD_WEBP 的宏满天飞，维护性差；</li>
<li>当需要支持新格式时，必须更改核心代码，稳定性差；</li>
<li>没有全局标识指明当前操作的图片格式，API 模糊不清，便利性差；</li>
</ul>
<p>至此，迎来了 5.x 的 <strong>SDImageCoder</strong> 协议。</p>
<p>整个 pod <strong>SDWebImageWebPCoder</strong> 就两文件，其中的 <code>UIImage+WebP.h</code> 还仅是对 <code>+[SDImageWebPCoder decodedImageWithData]</code> 的包装。而 WebPCoder 声明如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">@interface</span> <span style="color:#268bd2">SDImageWebPCoder</span> : <span style="color:#268bd2">NSObject</span> <span style="color:#719e07">&lt;</span>SDProgressiveImageCoder, SDAnimatedImageCoder<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">class</span>, <span style="color:#719e07">readonly</span>, nonnull) SDImageWebPCoder <span style="color:#719e07">*</span>sharedCoder;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">@end</span>
</code></pre></div><p>够简单吧。不过，主要是看 <strong>SDImageCoder</strong> 和 <strong>SDAnimatedImageCoder</strong> 协议：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@protocol</span> <span style="color:#268bd2">SDImageCoder</span> <span style="color:#719e07">&lt;</span>NSObject<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">@required</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">#pragma mark - Decoding
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07"></span><span style="color:#719e07">-</span> (<span style="color:#dc322f">BOOL</span>)canDecodeFromData:(nullable NSData <span style="color:#719e07">*</span>)data;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#586e75">/// 如果支持动图，可通过`+[SDImageCoderHelper animatedImageWithFrames:]` 来生成各帧的图片.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span>- (nullable UIImage <span style="color:#719e07">*</span>)<span style="color:#268bd2">decodedImageWithData:</span>(nullable NSData <span style="color:#719e07">*</span>)<span style="color:#268bd2">data</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>                                   <span style="color:#268bd2">options:</span>(nullable SDImageCoderOptions <span style="color:#719e07">*</span>)<span style="color:#268bd2">options</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">#pragma mark - Encoding
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07"></span>- (<span style="color:#dc322f">BOOL</span>)<span style="color:#268bd2">canEncodeToFormat:</span>(SDImageFormat)<span style="color:#268bd2">format</span> NS_SWIFT_NAME(canEncode(to:));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75">/// 如果支持动图，可通过 `+[SDImageCoderHelper framesFromAnimatedImage:]` 将各帧集合成动图.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#586e75"></span>- (nullable NSData <span style="color:#719e07">*</span>)<span style="color:#268bd2">encodedDataWithImage:</span>(nullable UIImage <span style="color:#719e07">*</span>)<span style="color:#268bd2">image</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>                                   <span style="color:#268bd2">format:</span>(SDImageFormat)<span style="color:#268bd2">format</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>                                  <span style="color:#268bd2">options:</span>(nullable SDImageCoderOptions <span style="color:#719e07">*</span>)<span style="color:#268bd2">options</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span><span style="color:#719e07">@end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07">@protocol</span> <span style="color:#268bd2">SDAnimatedImageCoder</span> <span style="color:#719e07">&lt;</span>SDImageCoder, SDAnimatedImageProvider<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span><span style="color:#719e07">@required</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span><span style="color:#719e07">-</span> (nullable <span style="color:#dc322f">instancetype</span>)initWithAnimatedImageData:(nullable NSData <span style="color:#719e07">*</span>)data options:(nullable SDImageCoderOptions <span style="color:#719e07">*</span>)options;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span><span style="color:#719e07">@end</span>
</code></pre></div><p><strong>SDProgressiveImageCoder</strong> 协议就不列出来了，大同小异。So，内部实现就是围绕这几个方法来实现的。</p>
<h4 id="imagecontenttype"><strong>ImageContentType</strong></h4>
<p>说实现之前，需要说明一个问题，<strong>如何通过 image data 分辨出图片格式 ？</strong> 我们需要回到 SD 的 <code>NSData+ImageContentType.h</code> 看看它所支持的图片格式：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">typedef</span> NSInteger SDImageFormat NS_TYPED_EXTENSIBLE_ENUM;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatUndefined <span style="color:#719e07">=</span> <span style="color:#719e07">-</span><span style="color:#2aa198">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatJPEG      <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatPNG       <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatGIF       <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatTIFF      <span style="color:#719e07">=</span> <span style="color:#2aa198">3</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatWebP      <span style="color:#719e07">=</span> <span style="color:#2aa198">4</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatHEIC      <span style="color:#719e07">=</span> <span style="color:#2aa198">5</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatHEIF      <span style="color:#719e07">=</span> <span style="color:#2aa198">6</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatPDF       <span style="color:#719e07">=</span> <span style="color:#2aa198">7</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> SDImageFormat SDImageFormatSVG       <span style="color:#719e07">=</span> <span style="color:#2aa198">8</span>;
</code></pre></div><p>发现没，这里的枚举定义方式与我们熟知的 <code>typedef NS_ENUM(NSInteger, xxx) {};</code> 不太一样。新东西 <strong>NS_TYPED_EXTENSIBLE_ENUM</strong> 可能你会比较陌生，不过，系统的 UILayoutPriority 也是可扩展枚举：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">typedef</span> <span style="color:#dc322f">float</span> UILayoutPriority NS_TYPED_EXTENSIBLE_ENUM;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">static</span> <span style="color:#719e07">const</span> UILayoutPriority UILayoutPriorityRequired <span style="color:#268bd2">API_AVAILABLE</span>(ios(<span style="color:#2aa198">6.0</span>)) <span style="color:#719e07">=</span> <span style="color:#2aa198">1000</span>; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>...
</code></pre></div><p>关于它的说明网上比较少，这里找到篇相关的文章：<a href="https://medium.com/@derrickho_28266/why-ns-typed-enum-is-the-future-c67ed8affe03">Why NS_TYPED_ENUM is the future</a>。</p>
<p>extensible enum 使用时很简单，而且它是 <strong>Swift 兼容的 API</strong> ，特点就是可扩展。它的想象力在哪里呢？当它和协议化后的类结合后，简直可以 <em>一个打十个</em> 。你可以不需要修改 SD 的核心代码，就能支持你想要的编码格式，真正的做到无入侵。是不是有一点点 <em><a href="https://developer.apple.com/videos/play/wwdc2015/408/">Protocol-Oriented Programming</a></em> 的感觉。</p>
<p>该文章中提到的另一个 <strong>NS_STRING_ENUM</strong> 在 SD 中也有用到：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">typedef</span> NSString <span style="color:#719e07">*</span> SDImageCoderOption NS_STRING_ENUM;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>FOUNDATION_EXPORT SDImageCoderOption _Nonnull <span style="color:#719e07">const</span> SDImageCoderDecodeFirstFrameOnly;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>FOUNDATION_EXPORT SDImageCoderOption _Nonnull <span style="color:#719e07">const</span> SDImageCoderDecodeScaleFactor;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>...
</code></pre></div><p>回到我们的 <code>NSData+ImageContentType.h</code> ，有三个方法：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">@interface</span> <span style="color:#268bd2">NSData</span> (ImageContentType)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#586e75">/// 通过 data 获取 image format
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#586e75"></span>+ (SDImageFormat)<span style="color:#268bd2">sd_imageFormatForImageData:</span>(nullable NSData <span style="color:#719e07">*</span>)<span style="color:#268bd2">data</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#586e75">/// 通过 image format 转换 UTType
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span>+ (nonnull CFStringRef)<span style="color:#268bd2">sd_UTTypeFromImageFormat:</span>(SDImageFormat)<span style="color:#268bd2">format</span> CF_RETURNS_NOT_RETAINED <span style="color:#268bd2">NS_SWIFT_NAME</span>(sd_UTType(from:));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75">/// 通过 UTType 转换为 image format
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#586e75"></span>+ (SDImageFormat)<span style="color:#268bd2">sd_imageFormatFromUTType:</span>(nonnull CFStringRef)<span style="color:#268bd2">uttype</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">@end</span>
</code></pre></div><p>稍微提一下这里的 <a href="https://www.wikiwand.com/en/Uniform_Type_Identifier">UTType (Uniform Type Identifiers)</a> 统一类型标识符是苹果在 Mac OS 10.4 提出的，它包括文本、图片、音频、视频格式等。这个<a href="https://escapetech.eu/manuals/qdrop/uti.html">网站</a>有详细的列出了它支持的格式，以及 UTType的作用，也可参照 wiki。而目前 UTType 是没用支持 WebP 和 SVG 的，但是它是可以提供扩展的，本质上 UTType 就是一个纯文本的字符串而已。WebP 和 SVG 在 SD 中的定义如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75">// Currently Image/IO does not support WebP
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#586e75"></span><span style="color:#719e07">#define kSDUTTypeWebP ((__bridge CFStringRef)@&#34;public.webp&#34;)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">#define kSVGTagEnd @&#34;&lt;/svg&gt;&#34;
</span></code></pre></div><p>可以回答前面的问题：<strong>如何通过 image data 分辨出图片格式 ？</strong> 就是：<strong><a href="https://www.garykessler.net/library/file_sigs.html">FILE SIGNATURES TABLE</a></strong></p>
<blockquote>
<p>In <a href="https://www.wikiwand.com/en/Computer">computing</a>, a <strong>file signature</strong> is data used to identify or verify the contents of a file. In particular, it may refer to:</p>
<ul>
<li><a href="https://www.wikiwand.com/en/File_format#Magic_number">File magic number</a>: bytes within a file used to identify the format of the file; generally a short sequence of bytes (most are 2-4 bytes long) placed at the beginning of the file; see <a href="https://www.wikiwand.com/en/List_of_file_signatures">list of file signatures</a></li>
<li><a href="https://www.wikiwand.com/en/Checksum">File checksum</a> or more generally the result of a <a href="https://www.wikiwand.com/en/Hash_function">hash function</a> over the file contents: data used to verify the integrity of the file contents, generally against transmission errors or malicious attacks. The signature can be included at the end of the file or in a separate file.</li>
</ul>
</blockquote>
<p>我们知道 Image 有两种描述方式：矢量图形或光栅图形(或称位图)，屏幕显示的都是位图，包含大量像素点信息。而为了提高对图片的传输和存储效率，都会采用一定算法对像素信息进行压缩。上面列出的各种格式则是对不同压缩算法的表示。由于图片数据都是  binary files，因此，按十六进制描述  JPEG 文件 file header 的字节序为：<code>FF D8</code> ，而 WebP 的则是 <code>57 45</code>：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#2aa198">52</span> <span style="color:#2aa198">49</span> <span style="color:#2aa198">46</span> <span style="color:#2aa198">46</span> xx xx xx xx						RIFF ....   <span style="color:#586e75">//xx xx xx xx 是表示文件大小
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#586e75"></span><span style="color:#2aa198">57</span> <span style="color:#2aa198">45</span> <span style="color:#2aa198">42</span> <span style="color:#2aa198">50</span>	 									WEBP
</code></pre></div><p>这里需要介绍一下 <a href="https://developers.google.com/speed/webp/docs/riff_container#color_profile">WebP</a> 构成：</p>
<blockquote>
<p>WebP is an image format that uses either (i) the VP8 key frame encoding to compress image data in a lossy way, or (ii) the WebP lossless encoding (and possibly other encodings in the future). These encoding schemes should make it more efficient than currently used formats. It is optimized for fast image transfer over the network (e.g., for websites). The WebP format has feature parity (color profile, metadata, animation etc) with other formats as well. This document describes the structure of a WebP file.</p>
</blockquote>
<p>WebP 是可以由多种编码压缩方式 (无损压缩、有损压缩<a href="https://www.wikiwand.com/en/VP8">VP8</a>) + 颜色描述文件 (<a href="https://fileinfo.com/extension/icc">ICC</a>) + 元数据 (metaData) + 多帧图片(动图) 组合的一种图片描述格式。同时 WebP 的这种描述格式是基于 <a href="https://www.wikiwand.com/en/Resource_Interchange_File_Format">RIFF File Format</a>，RIFF (resource interchange file forma) 是一种资源交换文件格式，或者说通用的容器文件格式。更多信息这里就不展开了。</p>
<h2 id="sdwebimagewebpcoderhttpsgithubcomsdwebimagesdwebimagewebpcoder"><a href="https://github.com/SDWebImage/SDWebImageWebPCoder">SDWebImageWebPCoder</a></h2>
<p>先看一眼 WebPCoder 有那些主要私有变量：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@implementation</span> <span style="color:#268bd2">SDImageWebPCoder</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    WebPIDecoder <span style="color:#719e07">*</span>_idec; <span style="color:#586e75">// incremental decoding 增量解码器
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>    WebPDemuxer <span style="color:#719e07">*</span>_demux; <span style="color:#586e75">// image data 分离器
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span>    WebPData <span style="color:#719e07">*</span>_webpdata; <span style="color:#586e75">// Copied for progressive animation demuxer
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"></span>    NSData <span style="color:#719e07">*</span>_imageData;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    NSUInteger _loopCount; <span style="color:#586e75">// 动画循环次数
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span>    NSUInteger _frameCount; <span style="color:#586e75">// 动画帧数
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#586e75"></span>    NSArray<span style="color:#719e07">&lt;</span>SDWebPCoderFrame <span style="color:#719e07">*&gt;</span> <span style="color:#719e07">*</span>_frames; <span style="color:#586e75">// 动画帧数据集合
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>    CGContextRef _canvas; <span style="color:#586e75">// 图片画布
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#586e75"></span>    CGColorSpaceRef _colorSpace; <span style="color:#586e75">// 图片 icc 彩色空间
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>    <span style="color:#dc322f">BOOL</span> _hasAlpha;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    CGFloat _canvasWidth; <span style="color:#586e75">// 图片画布宽度
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75"></span>    CGFloat _canvasHeight; <span style="color:#586e75">// 图片画布高度
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#586e75"></span>    NSUInteger _currentBlendIndex; <span style="color:#586e75">//动画的当前混合帧率
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#586e75"></span>}
</code></pre></div><p>稍微说明一下 demux 这个词 (de multiplex <a href="https://blog.csdn.net/haomcu/article/details/7072707">音视频中的概念</a>) ，表示真心不懂。</p>
<p>以上数据均通过解析 WebP 数据获取，还有部分是通过 SDImageCoderOptions 获取的：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">BOOL</span> decodeFirstFrame <span style="color:#719e07">=</span> [options[SDImageCoderDecodeFirstFrameOnly] boolValue];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>NSNumber <span style="color:#719e07">*</span>scaleFactor <span style="color:#719e07">=</span> options[SDImageCoderDecodeScaleFactor];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>NSValue <span style="color:#719e07">*</span>thumbnailSizeValue <span style="color:#719e07">=</span> options[SDImageCoderDecodeThumbnailPixelSize];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>NSNumber <span style="color:#719e07">*</span>preserveAspectRatioValue <span style="color:#719e07">=</span> options[SDImageCoderDecodePreserveAspectRatio];
</code></pre></div><h3 id="decodedimage">DecodedImage</h3>
<p>开始解码前先生成 WebPData、WebPDemuxer、WebPIterator、CGColorSpaceRef 以及从 coder options 获取配置信息，简化后如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>WebPData webpData;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>WebPDataInit(<span style="color:#719e07">&amp;</span>webpData);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>webpData.bytes <span style="color:#719e07">=</span> data.bytes;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>webpData.size <span style="color:#719e07">=</span> data.length;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>WebPDemuxer <span style="color:#719e07">*</span>demuxer <span style="color:#719e07">=</span> WebPDemux(<span style="color:#719e07">&amp;</span>webpData);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>uint32_t flags <span style="color:#719e07">=</span> WebPDemuxGetI(demuxer, WEBP_FF_FORMAT_FLAGS);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#dc322f">BOOL</span> hasAnimation <span style="color:#719e07">=</span> flags <span style="color:#719e07">&amp;</span> ANIMATION_FLAG;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#586e75">// 获取 coder options 配置 scale、thumnailSize、preserveAspectRatio、decodeFirstFrame
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75">// ...
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75">// for animated webp image
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#586e75"></span>WebPIterator iter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#586e75">// libwebp&#39;s index start with 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#586e75"></span><span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>WebPDemuxGetFrame(demuxer, <span style="color:#2aa198">1</span>, <span style="color:#719e07">&amp;</span>iter)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    WebPDemuxReleaseIterator(<span style="color:#719e07">&amp;</span>iter);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    WebPDemuxDelete(demuxer);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>CGColorSpaceRef colorSpace <span style="color:#719e07">=</span> [<span style="color:#b58900">self</span> sd_createColorSpaceWithDemuxer:demuxer];
</code></pre></div><p>这里的 colorSpace 是通过读取 WebP 中的 <a href="https://developers.google.com/speed/webp/docs/riff_container#color_profile">ICC color profile</a> 来生成的，如果没有则使用 <code>[SDImageCoderHelper colorSpaceGetDeviceRGB];</code></p>
<p>在获取缩略图尺寸后会与 WebP 的图片 canvas size 对比，检查是否需要使用缩略图：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">int</span> canvasWidth <span style="color:#719e07">=</span> WebPDemuxGetI(demuxer, WEBP_FF_CANVAS_WIDTH);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#dc322f">int</span> canvasHeight <span style="color:#719e07">=</span> WebPDemuxGetI(demuxer, WEBP_FF_CANVAS_HEIGHT);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>CGSize scaledSize <span style="color:#719e07">=</span> SDCalculateThumbnailSize(CGSizeMake(canvasWidth, canvasHeight), preserveAspectRatio, thumbnailSize);
</code></pre></div><p><strong>AnimatedImage</strong></p>
<p>SD 在 5.x 推出了 SDAnimatedImage（protocol too) 正是为动图设计的，而 WebP 是支持动图的，因此这里的解码会区分是否为动图。</p>
<p>如果是单张图片则使用 <code>[self sd_createWebpImageWithData: colorSpace: scaledSize:]</code>  生成 CGImageRef 最后生成 image 并设置 <code>sd_imageFormat = SDImageFormatWebP</code>。</p>
<p>如果为动图，先初始化 <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_images/dq_images.html#//apple_ref/doc/uid/TP30001066-CH212-CJBHEGIB">CGBitmapInfo</a> 来提供位图的布局信息：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">BOOL</span> hasAlpha <span style="color:#719e07">=</span> config.input.has_alpha;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>CGBitmapInfo bitmapInfo <span style="color:#719e07">=</span> kCGBitmapByteOrder32Host;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>bitmapInfo <span style="color:#719e07">|=</span> hasAlpha <span style="color:#719e07">?</span> kCGImageAlphaPremultipliedFirst : kCGImageAlphaNoneSkipFirst;
</code></pre></div><p>我们先说为什么是使用 <em>kCGBitmapByteOrder32Host</em> ，我们知道 iPhone 是小端序，应该使用 <em>kCGBitmapByteOrder32Little</em> 才对，不过 32Host 是系统提供的一个宏，帮我们屏蔽了大小端端问题，定义如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">#ifdef __BIG_ENDIAN__
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07"></span>    <span style="color:#719e07">#define kCGBitmapByteOrder16Host kCGBitmapByteOrder16Big
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07"></span>    <span style="color:#719e07">#define kCGBitmapByteOrder32Host kCGBitmapByteOrder32Big
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">#else </span><span style="color:#586e75">/* Little endian. */</span><span style="color:#719e07">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07"></span>    <span style="color:#719e07">#define kCGBitmapByteOrder16Host kCGBitmapByteOrder16Little
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07"></span>    <span style="color:#719e07">#define kCGBitmapByteOrder32Host kCGBitmapByteOrder32Little
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">#endif
</span></code></pre></div><p>简单来说 Apple 的 GPU 仅支持 32 bit 的颜色格式，if not 则会消耗 CPU 进行颜色格式转换。具体可以看 <a href="http://blog.leichunfeng.com/blog/2017/02/20/talking-about-the-decompression-of-the-image-in-ios/">WWDC 2014 Session 419</a> 。</p>
<p>剩下一个 alpa 信息是由 CGImageAlphaInfo 来控制，其定义如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>ypedef <span style="color:#268bd2">CF_ENUM</span>(uint32_t, CGImageAlphaInfo) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    kCGImageAlphaNone,               <span style="color:#586e75">/* For example, RGB. */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    kCGImageAlphaPremultipliedLast,  <span style="color:#586e75">/* For example, premultiplied RGBA */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    kCGImageAlphaPremultipliedFirst, <span style="color:#586e75">/* For example, premultiplied ARGB */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    kCGImageAlphaLast,               <span style="color:#586e75">/* For example, non-premultiplied RGBA */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    kCGImageAlphaFirst,              <span style="color:#586e75">/* For example, non-premultiplied ARGB */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    kCGImageAlphaNoneSkipLast,       <span style="color:#586e75">/* For example, RBGX. */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    kCGImageAlphaNoneSkipFirst,      <span style="color:#586e75">/* For example, XRGB. */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    kCGImageAlphaOnly                <span style="color:#586e75">/* No color data, alpha data only */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>};
</code></pre></div><p><a href="https://blog.csdn.net/mydreamremindme/article/details/50817294?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task">这里</a> 有一个解释关于 premutipled 的作用的说明，还蛮不错的。AlphaInfo 提供了三方面的信息：</p>
<ul>
<li>是否有 alpha 值；</li>
<li>如有 alpha 值，alpha 所处位置 first or last，like RGBA or ARGB；</li>
<li>如有 alpha 值，每个颜色的分量是否已乘上 alpha 值。好处是可以避免 3 次的乘法运算。</li>
</ul>
<p>关于具体的使用这里有一个<a href="https://stackoverflow.com/questions/23723564/which-cgimagealphainfo-should-we-use">讨论</a> ，结论就是不包含 alpha 时用 <code>kCGImageAlphaNoneSkipFirst</code> ，否则使用 <code>kCGImageAlphaPremultipliedFirst</code>。</p>
<p>紧接着就是生成 canvas 和 iterator 开始每一帧的绘制：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>CGContextRef canvas <span style="color:#719e07">=</span> CGBitmapContextCreate(<span style="color:#b58900">NULL</span>, canvasWidth, canvasHeight, <span style="color:#2aa198">8</span>, <span style="color:#2aa198">0</span>, [SDImageCoderHelper colorSpaceGetDeviceRGB], bitmapInfo);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>canvas) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    WebPDemuxDelete(demuxer);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    CGColorSpaceRelease(colorSpace);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>NSMutableArray<span style="color:#719e07">&lt;</span>SDImageFrame <span style="color:#719e07">*&gt;</span> <span style="color:#719e07">*</span>frames <span style="color:#719e07">=</span> [NSMutableArray array];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">do</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        CGImageRef imageRef <span style="color:#719e07">=</span> [<span style="color:#b58900">self</span> sd_drawnWebpImageWithCanvas:canvas iterator:iter colorSpace:colorSpace scaledSize:scaledSize];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>imageRef) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>            <span style="color:#719e07">continue</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07">#if SD_UIKIT || SD_WATCH
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07"></span>        UIImage <span style="color:#719e07">*</span>image <span style="color:#719e07">=</span> [[UIImage alloc] initWithCGImage:imageRef scale:scale orientation:UIImageOrientationUp];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07"></span>        UIImage <span style="color:#719e07">*</span>image <span style="color:#719e07">=</span> [[UIImage alloc] initWithCGImage:imageRef scale:scale orientation:kCGImagePropertyOrientationUp];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07"></span>        CGImageRelease(imageRef);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        NSTimeInterval duration <span style="color:#719e07">=</span> [<span style="color:#b58900">self</span> sd_frameDurationWithIterator:iter];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>        SDImageFrame <span style="color:#719e07">*</span>frame <span style="color:#719e07">=</span> [SDImageFrame frameWithImage:image duration:duration];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        [frames addObject:frame];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>} <span style="color:#719e07">while</span> (WebPDemuxNextFrame(<span style="color:#719e07">&amp;</span>iter));
</code></pre></div><p>最后释放对应 iterator、demuer、canvas、colorSpace，生成 animatedImage，decode 结束：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>UIImage <span style="color:#719e07">*</span>animatedImage <span style="color:#719e07">=</span> [SDImageCoderHelper animatedImageWithFrames:frames];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>animatedImage.sd_imageLoopCount <span style="color:#719e07">=</span> loopCount;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>animatedImage.sd_imageFormat <span style="color:#719e07">=</span> SDImageFormatWebP;
</code></pre></div><h3 id="drawnwebpimage">DrawnWebpImage</h3>
<p>drawnWebImage 方法是用于生成动图的每一帧图片的，内部通过 CreateWebpImage 生成当前帧的 image 然后在 canvas 上进行混合操作（基于 canvas size），最后根据 scale size 进行一定比例缩放。blend 代码如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#dc322f">BOOL</span> shouldBlend <span style="color:#719e07">=</span> iter.blend_method <span style="color:#719e07">==</span> WEBP_MUX_BLEND;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75">// If not blend, cover the target image rect. (firstly clear then draw)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span><span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>shouldBlend) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    CGContextClearRect(canvas, imageRect);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>CGContextDrawImage(canvas, imageRect, imageRef);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>CGImageRef newImageRef <span style="color:#719e07">=</span> CGBitmapContextCreateImage(canvas);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>CGImageRelease(imageRef);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">if</span> (iter.dispose_method <span style="color:#719e07">==</span> WEBP_MUX_DISPOSE_BACKGROUND) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    CGContextClearRect(canvas, imageRect);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>}
</code></pre></div><p>blend_method 是当前帧指定的混合方式，如果无需混合会清理当地画布再进图像转换。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75">// Blend operation (animation only). Indicates how transparent pixels of the
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#586e75">// current frame are blended with those of the previous canvas.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#586e75"></span><span style="color:#719e07">typedef</span> <span style="color:#719e07">enum</span> WebPMuxAnimBlend {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  WEBP_MUX_BLEND,              <span style="color:#586e75">// Blend.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span>  WEBP_MUX_NO_BLEND            <span style="color:#586e75">// Do not blend.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75"></span>} WebPMuxAnimBlend;
</code></pre></div><p>同时当前帧渲染结束还有一个 dispose_method 决定是否在下一帧渲染前清除当前 context：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75">// Dispose method (animation only). Indicates how the area used by the current
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#586e75">// frame is to be treated before rendering the next frame on the canvas.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#586e75"></span><span style="color:#719e07">typedef</span> <span style="color:#719e07">enum</span> WebPMuxAnimDispose {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  WEBP_MUX_DISPOSE_NONE,       <span style="color:#586e75">// Do not dispose.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span>  WEBP_MUX_DISPOSE_BACKGROUND  <span style="color:#586e75">// Dispose to background color.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75"></span>} WebPMuxAnimDispose;
</code></pre></div><h3 id="createwebpimage">CreateWebpImage</h3>
<p>创建图片会初始化 WebPDecoderConfig 以及检查 webp 图片完整性：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>WebPDecoderConfig config;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>WebPInitDecoderConfig(<span style="color:#719e07">&amp;</span>config)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75">// 检查 webp 图片完整性
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75"></span><span style="color:#719e07">if</span> (WebPGetFeatures(webpData.bytes, webpData.size, <span style="color:#719e07">&amp;</span>config.input) <span style="color:#719e07">!=</span> VP8_STATUS_OK) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>}
</code></pre></div><p>WebPDecoderConfig 声明如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75">// Main object storing the configuration for advanced decoding.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#586e75"></span><span style="color:#719e07">struct</span> <span style="color:#268bd2">WebPDecoderConfig</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  WebPBitstreamFeatures input;  <span style="color:#586e75">// Immutable bitstream features (optional)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#586e75"></span>  WebPDecBuffer output;         <span style="color:#586e75">// Output buffer (can point to external mem)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span>  WebPDecoderOptions options;   <span style="color:#586e75">// Decoding options
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75"></span>};
</code></pre></div><p>对 WebPBitstreamFeatures、WebPDecBuffer、WebPDecoderOptions 具体包含数据类型可查看：<a href="https://developers.google.com/speed/webp/docs/api">WebP Doc</a> 。在 SD 中对 config 做了如下设置：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>config.options.use_threads <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>; <span style="color:#586e75">// 开启多线程解码；
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#586e75"></span>config.output.colorspace <span style="color:#719e07">=</span> MODE_bgrA; <span style="color:#586e75">// 颜色空间指定为 RGBA 顺序；
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#586e75">// Use scaling for thumbnail
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#586e75"></span><span style="color:#719e07">if</span> (scaledSize.width <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">&amp;&amp;</span> scaledSize.height <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    config.options.use_scaling <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    config.options.scaled_width <span style="color:#719e07">=</span> scaledSize.width;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    config.options.scaled_height <span style="color:#719e07">=</span> scaledSize.height;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>}
</code></pre></div><p>这里的 <code>MODE_bgrA</code> 是属于 <a href="https://code.woboq.org/qt5/include/webp/decode.h.html">WEBP_CSP_MODE</a> 对 colorspace 的定义，不熟悉的可以看<a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101">苹果文档</a> 。</p>
<p>配置完 decode Config，还有就是 CGBitmapInfo。 这个与 decode image 中的逻辑一样就不多说了，直接解码生成 CGImageRef：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75">// Decode the WebP image data into a RGBA value array
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#586e75"></span><span style="color:#719e07">if</span> (WebPDecode(webpData.bytes, webpData.size, <span style="color:#719e07">&amp;</span>config) <span style="color:#719e07">!=</span> VP8_STATUS_OK) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">return</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75">// Construct a UIImage from the decoded RGBA value array
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#586e75"></span>CGDataProviderRef provider <span style="color:#719e07">=</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>CGDataProviderCreateWithData(<span style="color:#b58900">NULL</span>, config.output.u.RGBA.rgba, config.output.u.RGBA.size, FreeImageData);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>size_t bitsPerComponent <span style="color:#719e07">=</span> <span style="color:#2aa198">8</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>size_t bitsPerPixel <span style="color:#719e07">=</span> <span style="color:#2aa198">32</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>size_t bytesPerRow <span style="color:#719e07">=</span> config.output.u.RGBA.stride;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>size_t width <span style="color:#719e07">=</span> config.output.width;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>size_t height <span style="color:#719e07">=</span> config.output.height;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>CGColorRenderingIntent renderingIntent <span style="color:#719e07">=</span> kCGRenderingIntentDefault;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>CGImageRef imageRef <span style="color:#719e07">=</span> CGImageCreate(width, height, bitsPerComponent, bitsPerPixel, bytesPerRow, colorSpaceRef, bitmapInfo, provider, <span style="color:#b58900">NULL</span>, <span style="color:#b58900">NO</span>, renderingIntent);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>CGDataProviderRelease(provider);
</code></pre></div><p>这里在第一步创建 dataProvider 的时候就传入了 FreeImageData 作为 callback，保证结束后及时清理 data：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">static</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">FreeImageData</span>(<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>info, <span style="color:#719e07">const</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>data, size_t size) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    free((<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>)data);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>}
</code></pre></div><p>这里的 info 信息其实是 <a href="https://developer.apple.com/documentation/coregraphics/1408288-cgdataprovidercreatewithdata?language=objc">CGDataProviderCreateWithData</a> 调用时传入的 NULL 它也可以是任意类型。</p>
<p>至此，WebP decode 核心实现已经差不多了，剩下的 ProgressCoder 和 SDAnimatedImageCoder 中的 decode 逻辑也都大同小异。稍微不同的，在于 AnimatedImage 内部会将 WebPIterator 增量的帧迭代器中的各帧数据存储到 SDWebPCoderFrame 中，可以说 SDWebPCoderFrame 就是 WebPIterator 的翻版。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@interface</span> <span style="color:#268bd2">SDWebPCoderFrame</span> : <span style="color:#268bd2">NSObject</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) NSUInteger index; <span style="color:#586e75">// Frame index (zero based)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) NSTimeInterval duration; <span style="color:#586e75">// Frame duration in seconds
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) NSUInteger width; <span style="color:#586e75">// Frame width
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) NSUInteger height; <span style="color:#586e75">// Frame height
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) NSUInteger offsetX; <span style="color:#586e75">// Frame origin.x in canvas (left-bottom based)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) NSUInteger offsetY; <span style="color:#586e75">// Frame origin.y in canvas (left-bottom based)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) <span style="color:#dc322f">BOOL</span> hasAlpha; <span style="color:#586e75">// Whether frame contains alpha
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) <span style="color:#dc322f">BOOL</span> isFullSize; <span style="color:#586e75">// Whether frame size is equal to canvas size
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) <span style="color:#dc322f">BOOL</span> shouldBlend; <span style="color:#586e75">// Frame dispose method
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) <span style="color:#dc322f">BOOL</span> shouldDispose; <span style="color:#586e75">// Frame blend operation
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75"></span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">assign</span>) NSUInteger blendFromIndex; <span style="color:#586e75">// The nearest previous frame index which blend mode is WEBP_MUX_BLEND
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">@end</span>
</code></pre></div><p>WebPIterator 可参照 <a href="https://developers.google.com/speed/webp/docs/container-api">WebP 文档</a> 。</p>
<h3 id="encodedimage">EncodedImage</h3>
<p>decode 逻辑与 encode 也基本是相反操作，细节先不表了。</p>
<h2 id="总结">总结</h2>
<p>这篇，主要描述了 SD 的 Coder 插件是如何运行的，SD 当前所支持的 image 格式。以及如何为其添加新类型的图片格式并融入整个 SD 的处理流中。 重点介绍 WebP 解码的实现和相关 API，并未涉及太多 WebP 内部实现。</p>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/source-code">Source Code</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/cache">Cache</a>
     
    <a href="https://looseyi.github.io/tags/webimage">WebImage</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/sourcecode-ios/source-code-rxswift/"><span>←</span><span>浅析 RxSwift 5.0 - Subscription</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-ios/source-code-sdweb-1/"><span>浅析 SDWebImage 5.6</span><span>→</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
