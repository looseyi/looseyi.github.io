<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog - Aha Edmond</title>

  
  
  <meta name="description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥" />
  <meta name="author" content="åœŸåœŸEdmondæœ¨" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-1/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog" />
<meta property="og:description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-04T18:20:00&#43;08:00" />
<meta property="article:modified_time" content="2020-05-04T18:20:00&#43;08:00" />


  
  <meta itemprop="name" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog">
<meta itemprop="description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥"><meta itemprop="datePublished" content="2020-05-04T18:20:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-05-04T18:20:00&#43;08:00" />
<meta itemprop="wordCount" content="7919">
<meta itemprop="keywords" content="Source Code,iOS,Logger," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog"/>
<meta name="twitter:description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2020-05-04</time>
      
      <span>åœŸåœŸEdmondæœ¨</span>
      
    </p>
    <h1>æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog</h1>
  </header>
  <section class="post-content"><h1 id="ä»‹ç»">ä»‹ç»</h1>
<blockquote>
<p><strong>CocoaLumberjack</strong> is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS.</p>
</blockquote>
<p>å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚
ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥å¿—åº“ç”¨çš„è¿™ä¸ªå•è¯ã€‚æœ€åè¿˜æ˜¯æ„Ÿè°¢ç½‘å‹æç¤ºï¼šlog æœ‰ä»£è¡¨æœ¨å¤´çš„æ„æ€ï¼Œæ‰€ä»¥ç”¨ lumberjack è¿˜æ˜¯éå¸¸è´´åˆ‡çš„ï¼ŒğŸ˜‚ã€‚</p>
<p>å†™è¿™ç¯‡æ–‡ç« æ˜¯æœ€è¿‘åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¶ç„¶å‘ç°ï¼Œå®ƒå±…ç„¶æœ‰è¿™ä¹ˆå¤šéšè—åŠŸèƒ½ï¼Œå°½ç®¡é¡¹ç›®é‡Œå¼•å…¥ä¹Ÿæœ‰å¥½å¤šå¹´äº†ã€‚æ¥ç€åˆçœ‹äº†ä¸€ä¸‹å®˜æ–¹æä¾›çš„ demosï¼Œ ç®€ç›´æ˜¯æƒŠå‘†äº†ï¼ˆPSï¼šä¹Ÿå¤ªä¸°å¯Œäº†å§ï¼‰ã€‚æ‰€ä»¥æœ¬æ–‡å¸Œæœ›ä»æºç æ¥ç€é‡æ¥ä»‹ç»å®ƒçš„ä¸€äº›è®¾è®¡å’Œ ğŸ¤” ã€‚æœ€åä¼šä»‹ç»ä¸€ä¸‹å®ƒæ‰€æ”¯æŒçš„æ‰©å±•ã€‚</p>
<h3 id="document">Document</h3>
<p>ä½œä¸ºå†å²æ‚ ä¹…çš„ libraryï¼Œå®ƒçš„ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/tree/master/Documentation">document</a> è¿˜æ˜¯éå¸¸è¯¦ç»†çš„ï¼Œä¸»è¦åˆ†ä¸‰ä¸ªçº§åˆ«ï¼š</p>
<ul>
<li>Beginner å…¥é—¨çº§ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/GettingStarted.md">ä½¿ç”¨è¯´æ˜</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomFormatters.md">è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/Performance.md">æ€§èƒ½æµ‹è¯•</a>ã€æ”¯æŒ<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/XcodeColors.md">å½©è‰²è¾“å‡º</a>ç­‰ï¼›</li>
<li>Intermediate è¿›é˜¶ï¼šlumberjack <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/Architecture.md">å†…éƒ¨æ¦‚è¿°</a>ï¼Œå¦‚ä½•å®šåˆ¶ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomContext.md">custom logging context</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLoggers.md">custrom logger</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLogLevels.md">custom log levels</a> ç­‰ï¼›</li>
<li>Advancedï¼šé«˜é˜¶ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/DynamicLogLevels.md">åŠ¨æ€ä¿®æ”¹ log levels</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/LogFileManagement.md">log æ–‡ä»¶ç®¡ç†ï¼ˆå‹ç¼©ã€ä¸Šä¼ </a>ã€‚</li>
</ul>
<h3 id="architecturehttpsgithubcomcocoalumberjackcocoalumberjackblobmasterdocumentationarchitecturemd"><a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/Architecture.md">Architecture</a></h3>
<p>ç…§ä¾‹ï¼Œæˆ‘ä»¬å…ˆé¢„è§ˆä¸€ä¸‹ç±»å›¾ï¼Œæœ‰ä¸ªå¤§æ¦‚çš„å°è±¡ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gdzck4x5v5j213v0iv41x.jpg" alt="CocoaLumberjackClassDiagram.png"></p>
<p>åœ¨æ¢³ç†å®Œè„‘å›¾æ‰å‘ç°å®˜æ–¹å…¶å®æä¾›äº†å®Œæ•´çš„ UML å›¾ã€‚ä¸è¿‡æ—¢ç„¶æ•´ç†äº†è„‘å›¾ï¼Œé‚£æˆ‘æŠŠå®ƒè´´åœ¨æ–‡æœ«ã€‚</p>
<p>UML ä¸Šç›´è§‚æ„Ÿå—å°±æ˜¯ class å¹¶ä¸å¤šï¼Œä½†æ˜¯åŠŸèƒ½ç¡®å®ååˆ†å®Œå–„ï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥çœ‹çœ‹ã€‚</p>
<h1 id="ddlog">DDLog</h1>
<p>æœ¬æ–‡é»˜è®¤ä½ æ˜¯ç»å†è¿‡æ–°æ‰‹æ‘çš„ï¼Œå¦‚æœå¯¹ Lumberjack çš„ API å®Œå…¨ä¸ç†Ÿæ‚‰ï¼Œè¯·æŒªæ­¥ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/GettingStarted.md">getting start</a>ã€‚</p>
<p>æ ¸å¿ƒæ–‡ä»¶ DDLog.h ä¸­æœ‰å£°æ˜äº†æœ€é‡è¦çš„ä¸¤ä¸ªåè®® <strong>DDLoger</strong> å’Œ <strong>DDLogFormatter</strong>ï¼Œè€Œ <strong>DDLog</strong> class å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª manager çš„å­˜åœ¨ï¼Œå®ƒç®¡ç†ç€æ‰€æœ‰æ³¨å†Œåœ¨æ¡ˆçš„ loogers å’Œ formattersã€‚è¿™ä¸‰ä¸ªå¯¹äºæ­£å¸¸é¡¹ç›®æ¥è¯´å·²ç»å®Œå…¨å¤Ÿç”¨äº†ã€‚æˆ‘ä»¬å°±ä» protocol ç€æ‰‹ï¼Œæœ€åæ¥è¯´è¿™ä¸ª DDLogã€‚</p>
<h2 id="loggers">Loggers</h2>
<blockquote>
<p>A logger is a class that does something with a log message. The lumberjack framework comes with several different loggers. (You can also <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLoggers.md">create your own</a>.) Loggers such as <code>DDOSLogger</code> can be used to duplicate the functionality of <code>NSLog</code>. And <code>DDFileLogger</code> can be used to write log messages to a log file.</p>
</blockquote>
<p>loggers ç›¸å…³ç±»ä¸»è¦æ˜¯å¯¹ log message è¿›è¡ŒåŠ å·¥å¤„ç†ã€‚é‚£ä¹ˆä¸€æ¡ DDLogMessage ä¼šå­˜æœ‰å“ªäº›å¯ç”¨ä¿¡æ¯å‘¢ï¼Ÿ</p>
<h3 id="ddlogmessage">DDLogMessage</h3>
<blockquote>
<p>Used by the logging primitives. (And the macros use the logging primitives.)</p>
</blockquote>
<p>log message ç”¨äºè®°å½•æ—¥å¿—åŸè¯­ï¼Œå®ƒæ˜¯é€šè¿‡å®æ¥å®ç°çš„ã€‚logging primitives æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¯ä»¥ç†è§£ä¸º log message ä¿å­˜äº† log è¢«è°ƒç”¨æ—¶çš„ä¸€ç³»åˆ—ç›¸å…³ç¯å¢ƒçš„ä¸Šä¸‹æ–‡ã€‚å•è¯ primitive ä¸€å¼€å§‹æ²¡çœ‹æ˜ç™½ï¼Œä¸è¿‡è®¡ç®—æœºä¸­å€’æ˜¯æœ‰ä¸€ä¸ª<a href="https://baike.baidu.com/item/%E5%8E%9F%E8%AF%AD">åŸè¯­</a>çš„æ¦‚å¿µï¼ˆä¸ä¸€å®šå¯¹ï¼‰ï¼Œå¯ä»¥å¸®åŠ©å¤§å®¶ç†è§£è¿™ä¸ªå•è¯ã€‚</p>
<p>å…·ä½“å­˜äº†å“ªäº›ä¸œè¥¿å‘¢ï¼Ÿ</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@interface</span> <span style="color:#268bd2">DDLogMessage</span> : <span style="color:#268bd2">NSObject</span> <span style="color:#719e07">&lt;</span>NSCopying<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#586e75">// Direct accessors to be used only for performance
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span>    <span style="color:#719e07">@public</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    NSString <span style="color:#719e07">*</span>_message;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    DDLogLevel _level;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    DDLogFlag _flag;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    NSInteger _context;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    NSString <span style="color:#719e07">*</span>_file;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    NSString <span style="color:#719e07">*</span>_fileName;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    NSString <span style="color:#719e07">*</span>_function;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    NSUInteger _line;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#dc322f">id</span> _tag;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    DDLogMessageOptions _options;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    NSDate <span style="color:#719e07">*</span> _timestamp;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    NSString <span style="color:#719e07">*</span>_threadID;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    NSString <span style="color:#719e07">*</span>_threadName;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    NSString <span style="color:#719e07">*</span>_queueLabel;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    NSUInteger _qos;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>}
</code></pre></div><p>è¿™é‡Œé€šè¿‡å‰ç½®å£°æ˜å®ä¾‹å˜é‡ï¼Œè¿™æ ·è°ƒç”¨æ–¹å¯ä»¥é¿å¼€ getter ç›´æ¥è®¿é—®å˜é‡ï¼Œæ¥æé«˜è®¿é—®æ•ˆç‡ã€‚å½“ç„¶ä½œè€…ä¹Ÿæä¾›äº† readonly çš„ @property methodã€‚</p>
<p>é¦–å…ˆï¼Œmessageã€fileã€function <strong>é»˜è®¤ä¸ä¼šæ‰§è¡Œ copy æ“ä½œ</strong>ï¼Œå¦‚æœéœ€è¦å¯ä»¥é€šè¿‡ DDLogMessageOptions æ¥æ§åˆ¶ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">typedef</span> <span style="color:#268bd2">NS_OPTIONS</span>(NSInteger, DDLogMessageOptions){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>	 <span style="color:#586e75">/// Use this to use a copy of the file path
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#586e75"></span>    DDLogMessageCopyFile        <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">0</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span> 	 <span style="color:#586e75">/// Use this to use a copy of the function name
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span>    DDLogMessageCopyFunction    <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>	 <span style="color:#586e75">/// Use this to use avoid a copy of the message
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#586e75"></span>    DDLogMessageDontCopyMessage <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>};
</code></pre></div><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äº NSString çš„æ“ä½œéœ€è¦ä½¿ç”¨ copy ï¼Œä»¥ä¿è¯æˆ‘ä»¬å¯¹å®ƒæ“ä½œæ—¶æ˜¯å®‰å…¨åŠä¸å¯å˜çš„ã€‚è¿™é‡Œé’ˆå¯¹ messageã€fileã€function å´ä¸é‡‡ç”¨ copyï¼Œæ˜¯ä¸ºäº†é¿å…ä¸å¿…è¦çš„ allocations å¼€é”€ã€‚å› ä¸º file å’Œ function æ˜¯é€šè¿‡ __FILE__ and __FUNCTION__ è¿™ä¸¤ä¸ªå®æ¥è·å–çš„ï¼Œå®ƒä»¬æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦å¸¸é‡ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆæ“ä½œã€‚è€Œ message æ­£å¸¸ç”± DDlog å†…éƒ¨ç”Ÿæˆçš„ï¼ŒLumberjack æ¥ä¿è¯ mesage ä¸å¯ä¿®æ”¹ã€‚So å®˜æ–¹æç¤ºå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>If you find need to manually create logMessage objects, there is one thing you should be aware of.</p>
</blockquote>
<p>è¯´çš„å°±æ˜¯ï¼Œå½“ä½ éœ€è¦æ‰‹åŠ¨ç”Ÿæˆ log message çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œè¿™ä¸‰ä¸ªå‚æ•°çš„å†…å­˜ä¿®é¥°æ“ä½œã€‚</p>
<p>log message å†…éƒ¨å®ç°å°±æ¯”è¾ƒç®€å•äº†ï¼Œä»¥ message å­—æ®µä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#dc322f">BOOL</span> copyMessage <span style="color:#719e07">=</span> (options <span style="color:#719e07">&amp;</span> DDLogMessageDontCopyMessage) <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>_message <span style="color:#719e07">=</span> copyMessage <span style="color:#719e07">?</span> [message <span style="color:#719e07">copy</span>] <span style="color:#719e07">:</span> message;
</code></pre></div><p>å¦å¤–ï¼Œå°±æ˜¯æ¯ä¸ª logMessage ä¼šè®°å½•å½“å‰è°ƒç”¨çš„ thread &amp; queue ä¿¡æ¯ï¼Œåˆ†åˆ«å¦‚ä¸‹:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>__uint64_t tid;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">if</span> (pthread_threadid_np(<span style="color:#b58900">NULL</span>, <span style="color:#719e07">&amp;</span>tid) <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    _threadID <span style="color:#719e07">=</span> [[NSString alloc] initWithFormat:<span style="color:#2aa198">@&#34;%llu&#34;</span>, tid];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>} <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    _threadID <span style="color:#719e07">=</span> <span style="color:#2aa198">@&#34;missing threadId&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>_threadName   <span style="color:#719e07">=</span> NSThread.currentThread.name;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#586e75">// Try to get the current queue&#39;s label
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>_queueLabel <span style="color:#719e07">=</span> [[NSString alloc] initWithFormat:<span style="color:#2aa198">@&#34;%s&#34;</span>, dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL)];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">if</span> (@available(macOS <span style="color:#2aa198">10.10</span>, iOS <span style="color:#2aa198">8.0</span>, <span style="color:#719e07">*</span>))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    _qos <span style="color:#719e07">=</span> (NSUInteger) qos_class_self();
</code></pre></div><h3 id="ddloglevel">DDLogLevel</h3>
<blockquote>
<p>Log levels are used to filter out logs. Used together with flags.</p>
</blockquote>
<p>æ¯ä¸€æ¡ log mesage éƒ½è®¾ç½®äº†å¯¹åº”çš„æ—¥å¿—çº§åˆ«ï¼Œç”¨äºè¿‡æ»¤ logs çš„ã€‚å…¶å®šä¹‰æ˜¯ä¸€ä¸ªæšä¸¾ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">typedef</span> <span style="color:#268bd2">NS_ENUM</span>(NSUInteger, DDLogLevel) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#586e75">// No logs
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>    DDLogLevelOff       <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>, 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75">// Error logs only
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"></span>    DDLogLevelError     <span style="color:#719e07">=</span> (DDLogFlagError), 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#586e75">// Error and warning logs
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span>    DDLogLevelWarning   <span style="color:#719e07">=</span> (DDLogLevelError   <span style="color:#719e07">|</span> DDLogFlagWarning),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#586e75">// Error, warning and info logs
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>    DDLogLevelInfo      <span style="color:#719e07">=</span> (DDLogLevelWarning <span style="color:#719e07">|</span> DDLogFlagInfo), 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#586e75">// Error, warning, info and debug logs
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>    DDLogLevelDebug     <span style="color:#719e07">=</span> (DDLogLevelInfo    <span style="color:#719e07">|</span> DDLogFlagDebug), 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#586e75">// Error, warning, info, debug and verbose logs
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75"></span>    DDLogLevelVerbose   <span style="color:#719e07">=</span> (DDLogLevelDebug   <span style="color:#719e07">|</span> DDLogFlagVerbose), 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#586e75">// All logs (1...11111)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#586e75"></span>    DDLogLevelAll       <span style="color:#719e07">=</span> NSUIntegerMax 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>};
</code></pre></div><p>è€Œ loglevel æ˜¯ç”± DDLogFlag æ§åˆ¶ï¼Œå…¶å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">typedef</span> <span style="color:#268bd2">NS_OPTIONS</span>(NSUInteger, DDLogFlag) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#586e75">// 0...00001 DDLogFlagError
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>    DDLogFlagError      <span style="color:#719e07">=</span> (<span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">0</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75">// 0...00010 DDLogFlagWarning
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"></span>    DDLogFlagWarning    <span style="color:#719e07">=</span> (<span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">1</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#586e75">// 0...00100 DDLogFlagInfo
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span>    DDLogFlagInfo       <span style="color:#719e07">=</span> (<span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">2</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#586e75">// 0...01000 DDLogFlagDebug
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>    DDLogFlagDebug      <span style="color:#719e07">=</span> (<span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">3</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#586e75">// 0...10000 DDLogFlagVerbose
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>    DDLogFlagVerbose    <span style="color:#719e07">=</span> (<span style="color:#2aa198">1</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">4</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>};
</code></pre></div><p>è¿™äº›å°±æ˜¯ DDLog æ‰€é¢„è®¾çš„ 5 ç§ levelï¼Œå¯¹äºæ–°æ‰‹æ¥è¯´åŸºæœ¬å¤Ÿç”¨äº†ã€‚åŒæ—¶ï¼Œå¯¹äºæœ‰è‡ªå®šä¹‰ level éœ€æ±‚çš„ç”¨æˆ·æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡ç»“æ„åŒ–çš„å®ï¼Œå°±èƒ½è½»æ¾å®ç°ã€‚è¯¦è§ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLogLevels.md">CustomLogLevels.md</a>ã€‚</p>
<p>å…¶æ ¸å¿ƒæ˜¯å…ˆå°†é¢„è®¾çš„ level æ¸…é™¤ï¼Œç„¶ååœ¨è¿›è¡Œé‡æ–°å®šä¹‰ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75">// First undefine the default stuff we don&#39;t want to use.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#586e75"></span><span style="color:#719e07">#undef DDLogError
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">#undef DDLogWarn
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">#undef DDLogInfo
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">#undef DDLogDebug
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">#undef DDLogVerbose
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07"></span>...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#586e75">// Now define everything how we want it
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span><span style="color:#719e07">#define LOG_FLAG_FATAL   (1 &lt;&lt; 0)  </span><span style="color:#586e75">// 0...000001
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#586e75"></span><span style="color:#719e07">#define LOG_LEVEL_FATAL   (LOG_FLAG_FATAL)  </span><span style="color:#586e75">// 0...000001
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span><span style="color:#719e07">#define LOG_FATAL   (ddLogLevel &amp; LOG_FLAG_FATAL )
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">#define DDLogFatal(frmt, ...)    SYNC_LOG_OBJC_MAYBE(ddLogLevel, LOG_FLAG_FATAL,  0, frmt, ##__VA_ARGS__)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07"></span>...
</code></pre></div><p>é™¤äº†å¯¹ level çš„é‡å®šä¹‰ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å¯¹ level è¿›è¡Œæ‰©å±•æ¥æ»¡è¶³æˆ‘ä»¬å¯¹éœ€æ±‚ã€‚ç”±äº lumberjack ä½¿ç”¨çš„æ˜¯ bitmask ä¸”åªé¢„è®¾äº† 5 ä¸ª bitï¼Œå¯¹åº” 5 ç§ log flagã€‚</p>
<p>è€Œ logLevel ä½œä¸º Int ç±»å‹ï¼Œæ„å‘³ç€å¯¹äº 32 ä½çš„ç³»ç»Ÿè€Œè¨€ï¼Œé¢„ç•™ç»™æˆ‘ä»¬çš„ levels è¿˜æœ‰ 28 bitsï¼Œå› ä¸ºé»˜è®¤çš„ level ä»…ä»…å ç”¨äº† 4 bitsã€‚æ‰©å±•ç©ºé—´å¯ä»¥è¯´æ˜¯ç»°ç»°æœ‰ä½™çš„ã€‚å®˜æ–¹æä¾›äº†ä¸¤ä¸ªéœ€è¦è¿›è¡Œæ‰©å±•çš„åœºæ™¯ï¼Œè¯¦è§ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/FineGrainedLogging.md">FineGrainedLogging.md</a>ã€‚</p>
<h3 id="ddloger">DDLoger</h3>
<blockquote>
<p>This protocol describes a basic logger behavior.</p>
<ul>
<li>Basically, it can log messages, store a logFormatter plus a bunch of optional behaviors.</li>
<li>(i.e. flush, get its loggerQueue, get its name, &hellip;</li>
</ul>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@protocol</span> <span style="color:#268bd2">DDLogger</span> <span style="color:#719e07">&lt;</span>NSObject<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">-</span> (<span style="color:#dc322f">void</span>)logMessage:(DDLogMessage <span style="color:#719e07">*</span>)logMessage NS_SWIFT_NAME(log(message:));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">strong</span>, nullable) <span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogFormatter<span style="color:#719e07">&gt;</span> logFormatter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">@optional</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">-</span> (<span style="color:#dc322f">void</span>)didAddLogger;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">didAddLoggerInQueue:</span>(dispatch_queue_t)<span style="color:#268bd2">queue</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">willRemoveLogger</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">flush</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, DISPATCH_QUEUE_REFERENCE_TYPE, <span style="color:#719e07">readonly</span>) dispatch_queue_t loggerQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">copy</span>, <span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">readonly</span>) DDLoggerName loggerName;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">@end</span>
</code></pre></div><p>logMessage æ²¡å•¥å¥½è¯´çš„ï¼ŒlogFormatter ä¼šåœ¨åé¢ä»‹ç»ã€‚é‡ç‚¹çœ‹ä¸Šé¢çš„å‡ ä¸ª optional æ–¹æ³•å’Œå‚æ•°ã€‚</p>
<p><strong>loggerQueue</strong></p>
<p>å…ˆçœ‹ loggerQueueï¼Œç”±äºæ—¥å¿—æ‰“å°å‡ä¸ºå¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥ä¼šä¸ºæ¯ä¸ª looger åˆ†é…ä¸€ä¸ª dispatch_queue_tã€‚å¦‚æœ logger æœªæä¾› loggerQueueï¼Œé‚£ä¹ˆ DDLog ä¸ºæ ¹æ®ä½ æ‰€æŒ‡å®šçš„ loggerName ä¸»åŠ¨ä¸ºä½ ç”Ÿæˆã€‚</p>
<p><strong>didAddLogger</strong></p>
<p>åŒæ ·ç”±äºå¼‚æ­¥æ‰“å°æ—¥å¿—çš„åŸå› ï¼Œlooger è¢«æ·»åŠ åˆ° loogers ä¸­æ—¶ä¹Ÿæ˜¯å¼‚æ­¥çš„è¿‡ç¨‹ï¼ŒdidAddLogger æ–¹æ³•å°±æ˜¯ç”¨äºé€šçŸ¥  logger å·²è¢«æˆåŠŸæ·»åŠ ï¼Œè€Œè¿™ä¸ªæ“ä½œæ—¶åœ¨ loggerQueue ä¸­å®Œæˆçš„ã€‚</p>
<p>åŒæ ·ï¼Œ<code>didAddLoggerInQueue:</code> å’Œ <code>willRemoveLogger</code> ç›®çš„ä¹Ÿæ˜¯ç±»ä¼¼ã€‚</p>
<p><strong>flush</strong></p>
<p>ç”¨äºåˆ·æ–°å­˜åœ¨åœ¨é˜Ÿåˆ—ä¸­è¿˜æœªå¤„ç†çš„ log messageã€‚æ¯”å¦‚ï¼Œdatabase logger å¯èƒ½é€šè¿‡ I/O buffer æ¥å‡å°‘æ—¥å¿—å­˜å‚¨é¢‘ç‡ï¼Œæ¯•ç«Ÿç£ç›˜ I/O æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œlogger ä¸­å¯èƒ½ç•™æœ‰æœªè¢«åŠæ—¶å¤„ç†çš„ log messageã€‚</p>
<p>DDLog ä¼šé€šè¿‡ <code>flushLog</code> æ¥æ‰§è¡Œ flush ã€‚éœ€è¦âš ï¸çš„æ˜¯ï¼Œå½“åº”ç”¨é€€å‡ºçš„æ—¶å€™  <code>flushLog</code> ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚å½“ç„¶ï¼Œä½œä¸ºå¼€å‘è€…æˆ‘ä»¬å¯ä»¥åœ¨é€‚å½“çš„æƒ…å†µä¸‹æ‰‹åŠ¨è§¦å‘åˆ·æ–°ï¼Œæ­£å¸¸æ˜¯ä¸éœ€è¦æ‰‹åŠ¨è§¦å‘çš„ã€‚</p>
<h3 id="ddlogformatter">DDLogFormatter</h3>
<blockquote>
<p>Formatter allow you to format a log message before the logger logs it.</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@protocol</span> <span style="color:#268bd2">DDLogFormatter</span> <span style="color:#719e07">&lt;</span>NSObject<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">@required</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">-</span> (nullable NSString <span style="color:#719e07">*</span>)formatLogMessage:(DDLogMessage <span style="color:#719e07">*</span>)logMessage NS_SWIFT_NAME(format(message:));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">@optional</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">-</span> (<span style="color:#dc322f">void</span>)didAddToLogger:(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)logger;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">didAddToLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span> <span style="color:#268bd2">inQueue:</span>(dispatch_queue_t)<span style="color:#268bd2">queue</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">willRemoveFromLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">@end</span>
</code></pre></div><p><strong>formatLogMessage:</strong></p>
<p>formatter æ˜¯å¯ä»¥æ·»åŠ åˆ°ä»»ä½• logger ä¸Šçš„ï¼Œé€šè¿‡ <code>formatLogMessage:</code> æå¤§æé«˜äº† logging çš„è‡ªç”±åº¦ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>formatLogMessage:</code> ç»™ file logger å’Œ console è¿”å›ä¸åŒçš„ç»“æœã€‚ä¾‹å¦‚ console ä¸€èˆ¬ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨ log å‰æ·»åŠ æ—¶é—´æˆ³ï¼Œè€Œå½“æˆ‘ä»¬å†™å…¥ log file æ—¶å°±éœ€è¦è‡ªè¡Œæ¥æ·»åŠ æ—¶é—´ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è¿”å› nil å°†å…¶ä½œä¸º filter æ¥è¿‡æ»¤å¯¹åº”çš„ logã€‚</p>
<p><strong>didAddToLogger</strong></p>
<p>ä¸€ä¸ª formatter å¯ä»¥è¢«æ·»åŠ åˆ°å¤šä¸ª logger ä¸Šã€‚å½“ formatter è¢«æ·»åŠ æ—¶ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥é€šçŸ¥å®ƒã€‚è¯¥æ–¹æ³•æ˜¯éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨å¼‚å¸¸ã€‚</p>
<p>åŒç†ï¼Œ<code>didAddToLogger: inQueue</code> æ˜¯æŒ‡åœ¨æŒ‡å®šé˜Ÿåˆ—ä¸­è¿›è¡Œ format æ“ä½œã€‚</p>
<p><code>willRemoveFromLogger</code> åˆ™æ˜¯ formatter è¢«ç§»é™¤æ—¶çš„é€šçŸ¥ã€‚</p>
<h2 id="ddlog-1">DDLog</h2>
<blockquote>
<p>The main class, exposes all logging mechanisms, loggers, &hellip;</p>
<p>For most of the users, this class is hidden behind the logging functions like <code>DDLogInfo</code></p>
</blockquote>
<p>DDLog ä½œä¸º lumberjack çš„ç®¡ç†ç±»ï¼Œè´Ÿè´£å°†ç”¨æˆ·çš„ log ä¿¡æ¯æ”¶é›†åé›†ä¸­è°ƒåº¦è‡³ä¸åŒçš„ logger å·²è¾¾åˆ°ä¸åŒçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ console log å’Œ file logã€‚å› æ­¤ï¼Œä½œä¸ºå•ä¾‹æ˜¯å¿…é¡»çš„ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒåˆå§‹åŒ–éƒ½å‡†å¤‡äº†ä»€ä¹ˆä¸œè¥¿ã€‚</p>
<h3 id="initialize">Initialize</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@interface</span> <span style="color:#268bd2">DDLog</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">strong</span>) NSMutableArray <span style="color:#719e07">*</span>_loggers;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">@end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">@implementation</span> <span style="color:#268bd2">DDLog</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">static</span> dispatch_queue_t _loggingQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">static</span> dispatch_group_t _loggingGroup;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">static</span> dispatch_semaphore_t _queueSemaphore;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">static</span> NSUInteger _numProcessors;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>...
</code></pre></div><p>ä¸Šé¢å‡ ä¸ªå‡ä¸ºç§æœ‰å˜é‡ï¼Œ_loggers è‡ªä¸å¿…è¯´ï¼Œä»»ä½• logger çš„æ·»åŠ /åˆ é™¤éƒ½éœ€è¦åœ¨ loggingQueue/loggingThread ä¸­è¿›è¡Œçš„ã€‚</p>
<p><strong>_loggingQueue</strong></p>
<p>å…¨å±€çš„ log queue ç”¨äºä¿è¯ FIFO çš„æ“ä½œé¡ºåºï¼Œæ‰€æœ‰ logger ä¼šé€šè¿‡å®ƒæ¥é¡ºåºæ‰§è¡Œå„ logger çš„ <code>logMessage:</code> ã€‚</p>
<p><strong>_loggingGroup</strong></p>
<p>ç”±äºæ¯ä¸ª logger æ·»åŠ æ—¶å€™éƒ½é…ç½®äº†å¯¹åº”çš„ log queueã€‚å› æ­¤ï¼Œloggers ä¹‹é—´çš„è®°å½•è¡Œä¸ºæ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚è€Œ dispatch group å¯ä»¥åŒæ­¥æ‰€æœ‰ loggers çš„æ“ä½œï¼Œç¡®ä¿è®°å½•è¡Œä¸ºé¡ºåˆ©å®Œæˆã€‚</p>
<p><strong>_queueSemaphore</strong></p>
<p>é˜²æ­¢æ‰€ä½¿ç”¨çš„é˜Ÿåˆ—è¿‡çˆ†ã€‚ç”±äºå¤§å¤šæ•°è®°å½•éƒ½æ˜¯å¼‚æ­¥æ“ä½œï¼Œå› æ­¤ï¼Œå¯èƒ½é­åˆ°æ¶æ„çº¿ç¨‹å¤§é‡çš„å¢åŠ  log å½±å“æ­£å¸¸çš„è®°å½•è¡Œä¸ºã€‚æœ€å¤§é™åˆ¶æ•°ä¸º DDLOG_MAX_QUEUE_SIZE (1000)ï¼Œä¹Ÿå°±æ˜¯è¯´å½“é˜Ÿåˆ—æ•°è¶…è¿‡é™åˆ¶ï¼Œåˆ™ä¼šä¸»åŠ¨é˜»å¡çº¿ç¨‹ï¼Œä»¥å¾…æ‰§è¡Œé˜Ÿåˆ—é™è‡³å®‰å…¨æ°´å¹³ã€‚</p>
<p>ä¾‹å¦‚ï¼šåœ¨å¤§å‹å¾ªç¯ä¸­éšæ„æ·»åŠ æ—¥å¿—è¯­å¥æ—¶ä¼šå‘ç”Ÿè¿‡ğŸ’¥ã€‚</p>
<p><strong>_numProcessors</strong></p>
<p>è®°å½•å¤„ç†å™¨å†…æ ¸æ•°é‡ï¼Œä»¥é’ˆå¯¹å•æ ¸æƒ…å†µæ—¶è¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ã€‚</p>
<p>ä½œä¸ºé™æ€å˜é‡ï¼Œå…¶åˆå§‹åŒ–åˆ™æ”¾åœ¨ <code>initialize</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>+ (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">initialize</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">static</span> dispatch_once_t DDLogOnceToken;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    dispatch_once(<span style="color:#719e07">&amp;</span>DDLogOnceToken, <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        NSLogDebug(<span style="color:#2aa198">@&#34;DDLog: Using grand central dispatch&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        _loggingQueue <span style="color:#719e07">=</span> dispatch_queue_create(<span style="color:#2aa198">&#34;cocoa.lumberjack&#34;</span>, <span style="color:#b58900">NULL</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        _loggingGroup <span style="color:#719e07">=</span> dispatch_group_create();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>nonNullValue <span style="color:#719e07">=</span> GlobalLoggingQueueIdentityKey; <span style="color:#586e75">// Whatever, just not null
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#586e75"></span>        dispatch_queue_set_specific(_loggingQueue, GlobalLoggingQueueIdentityKey, nonNullValue, <span style="color:#b58900">NULL</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        _queueSemaphore <span style="color:#719e07">=</span> dispatch_semaphore_create(DDLOG_MAX_QUEUE_SIZE);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        <span style="color:#586e75">// Figure out how many processors are available.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#586e75"></span>        <span style="color:#586e75">// This may be used later for an optimization on uniprocessor machines.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        _numProcessors <span style="color:#719e07">=</span> MAX([NSProcessInfo processInfo].processorCount, (NSUInteger) <span style="color:#2aa198">1</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        NSLogDebug(<span style="color:#2aa198">@&#34;DDLog: numProcessors = %@&#34;</span>, @(_numProcessors));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>}
</code></pre></div><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œé€šè¿‡ <code>dispatch_queue_set_specific</code> ä¸º _loggingQueue æ·»åŠ äº† keyï¼š<strong>GlobalLoggingQueueIdentityKey</strong> ä½œä¸ºæ ‡è®°ã€‚ä¹‹åä¼šåœ¨æ‰€æœ‰çš„å†…éƒ¨æ–¹æ³•æ‰§è¡Œå‰é€šè¿‡ <code>dispatch_get_specific</code> è·å– flag æ¥è¿›è¡Œæ–­è¨€ï¼Œç¡®ä¿å†…éƒ¨æ–¹æ³•éƒ½æ˜¯åœ¨å…¨å±€çš„ _loggingQueue ä¸­è°ƒåº¦çš„ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ DDLog å®ä¾‹çš„åˆå§‹åŒ–ï¼Œä»…åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>_loggers åˆå§‹åŒ–ï¼›</li>
<li>å°è¯•æ³¨å†Œé€šçŸ¥ï¼Œç¡®ä¿ APP è¿›ç¨‹ç»“æŸå‰èƒ½å¤ŸåŠæ—¶å°† Logger ä¸­çš„ message å¤„ç†å®Œæ¯•ï¼›</li>
</ul>
<p>ç”±äº lumberjack æ”¯æŒå…¨å¹³å°ä»¥åŠå‘½ä»¤è¡Œï¼Œè¿™é‡Œçš„ notificationName åˆ¤æ–­æ¡ä»¶ç›¸å¯¹å¤šä¸€äº›ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">#if TARGET_OS_IOS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07"></span>    NSString <span style="color:#719e07">*</span>notificationName <span style="color:#719e07">=</span> UIApplicationWillTerminateNotification;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07"></span>    NSString <span style="color:#719e07">*</span>notificationName <span style="color:#719e07">=</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#586e75">// On Command Line Tool apps AppKit may not be available
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#586e75"></span><span style="color:#719e07">#if !defined(DD_CLI) &amp;&amp; __has_include(&lt;AppKit/NSApplication.h&gt;)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07"></span>    <span style="color:#719e07">if</span> (NSApp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        notificationName <span style="color:#719e07">=</span> NSApplicationWillTerminateNotification;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07"></span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>notificationName) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#586e75">// If there is no NSApp -&gt; we are running Command Line Tool app.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#586e75"></span>        <span style="color:#586e75">// In this case terminate notification wouldn&#39;t be fired, so we use workaround.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#586e75"></span>        <span style="color:#719e07">__weak</span> __auto_type weakSelf <span style="color:#719e07">=</span> <span style="color:#b58900">self</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        atexit_b (<span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>            [weakSelf applicationWillTerminate:<span style="color:#b58900">nil</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">#endif </span><span style="color:#586e75">/* if TARGET_OS_IOS */</span><span style="color:#719e07">
</span></code></pre></div><p>ç¨å¾®æä¸€ç‚¹ï¼Œå‘½ä»¤è¡Œä¸­æ˜¯å¦‚ä½•æ¥ç›‘å¬ç¨‹åºé€€å‡ºï¼Ÿè¿™é‡Œç”¨åˆ°äº† <code>atexit</code></p>
<blockquote>
<p>The atexit() function registers the given function to be called at program exit, whether via exit(3) or via return from the program&rsquo;s main().  Functions so registered are called in reverse order; no arguments are passed.</p>
</blockquote>
<p>å°±æ˜¯è¯´ï¼Œç¨‹åºåœ¨é€€å‡ºæ—¶ï¼Œç³»ç»Ÿä¼šä¸»åŠ¨è°ƒç”¨é€šè¿‡ atexit æ³¨å†Œçš„ callbacksï¼Œå¯ä»¥æ³¨å†Œå¤šä¸ªå›è°ƒï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚</p>
<p>DDLog åœ¨æ”¶åˆ°é€šçŸ¥åä¼šè§¦å‘ <code>flush</code>ï¼Œè¿™ä¸ªæˆ‘ä»¬æ™šä¸€ç‚¹å±•å¼€ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">if</span> (notificationName) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    [[NSNotificationCenter defaultCenter] addObserver:<span style="color:#b58900">self</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>                                             selector:<span style="color:#719e07">@selector</span>(applicationWillTerminate:)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>                                                 name:notificationName
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>                                               object:<span style="color:#b58900">nil</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">-</span> (<span style="color:#dc322f">void</span>)applicationWillTerminate:(NSNotification <span style="color:#719e07">*</span> __attribute__((unused)))notification {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    [<span style="color:#b58900">self</span> flushLog];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>}
</code></pre></div><h3 id="logger-management">Logger Management</h3>
<p>å¯¹ logger çš„æ“ä½œä¸»è¦æ˜¯æ·»åŠ å’Œåˆ é™¤ã€‚</p>
<p><strong>AddLogger</strong></p>
<p>DDLog æä¾›äº†å¤šä¸ªæ·»åŠ  logger çš„ convince æ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>+ (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">addLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">addLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>+ (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">addLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span> <span style="color:#268bd2">withLevel:</span>(DDLogLevel)<span style="color:#268bd2">level</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">addLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span> <span style="color:#268bd2">withLevel:</span>(DDLogLevel)<span style="color:#268bd2">level</span>ï¼›
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">-</span> (<span style="color:#dc322f">void</span>)addLogger:(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)logger withLevel:(DDLogLevel)level {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>logger) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    dispatch_async(_loggingQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        [<span style="color:#b58900">self</span> lt_addLogger:logger level:level];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    } });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>}
</code></pre></div><p>åœ¨æ”¾å…¥ _loggingQueue åï¼Œæœ€ç»ˆèµ°åˆ°äº† <code>lt_addLogger: level:</code> æ–¹æ³•ã€‚è¿™é‡Œçš„å‰ç¼€ <code>lt</code> æ˜¯ lgging thread çš„ç¼©å†™ã€‚åœ¨ logger æ·»åŠ å‰ä¼šæ£€æŸ¥å»é‡ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">for</span> (DDLoggerNode <span style="color:#719e07">*</span>node <span style="color:#719e07">in</span> <span style="color:#b58900">self</span>._loggers) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    <span style="color:#719e07">if</span> (node<span style="color:#719e07">-&gt;</span>_logger <span style="color:#719e07">==</span> logger <span style="color:#719e07">&amp;&amp;</span> node<span style="color:#719e07">-&gt;</span>_level <span style="color:#719e07">==</span> level) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>        <span style="color:#586e75">// Exactly same logger already added, exit
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>}
</code></pre></div><p><strong>DDLoggerNode</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@interface</span> <span style="color:#268bd2">DDLoggerNode</span> : <span style="color:#268bd2">NSObject</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#586e75">// Direct accessors to be used only for performance
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span>    <span style="color:#719e07">@public</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span> _logger;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    DDLogLevel _level;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    dispatch_queue_t _loggerQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>+ (<span style="color:#dc322f">instancetype</span>)<span style="color:#268bd2">nodeWithLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>                   <span style="color:#268bd2">loggerQueue:</span>(dispatch_queue_t)<span style="color:#268bd2">loggerQueue</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>                         <span style="color:#268bd2">level:</span>(DDLogLevel)<span style="color:#268bd2">level</span>;
</code></pre></div><p>ç§æœ‰ç±»ï¼Œç”¨äºå…³è” loggerã€level å’Œ loggerQueueã€‚</p>
<p>ç¨å¾®æä¸€ä¸‹ï¼Œåœ¨ DDLoggerNode çš„åˆå§‹åŒ–æ–¹æ³•ä¸­çš„ï¼Œå…¼å®¹äº† MRC çš„ä½¿ç”¨ã€‚å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªå® <code>OS_OBJECT_USE_OBJC</code> æ¥åŒºåˆ† GCD æ˜¯å¦æ”¯æŒ ARCã€‚åœ¨6.0 ä¹‹å‰ GCD ä¸­çš„å¯¹è±¡æ˜¯ä¸æ”¯æŒ ARCï¼Œå› æ­¤åœ¨ 6.0 ä¹‹å‰ <code>OS_OBJECT_USE_OBJC</code> æ˜¯æ²¡æœ‰çš„ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> (loggerQueue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    _loggerQueue <span style="color:#719e07">=</span> loggerQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">#if !OS_OBJECT_USE_OBJC
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07"></span>    dispatch_retain(loggerQueue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    <span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07"></span>}
</code></pre></div><p>æ¥ç€å°±æ˜¯å‰é¢æ‰€æåˆ°çš„ QueueIdentity çš„æ–­è¨€ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>NSAssert(dispatch_get_specific(GlobalLoggingQueueIdentityKey),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>         <span style="color:#2aa198">@&#34;This method should only be run on the logging thread/queue&#34;</span>);
</code></pre></div><p>å‡†å¤‡ loggerQueueï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>dispatch_queue_t loggerQueue <span style="color:#719e07">=</span> <span style="color:#b58900">NULL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">if</span> ([logger respondsToSelector:<span style="color:#719e07">@selector</span>(loggerQueue)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    loggerQueue <span style="color:#719e07">=</span> logger.loggerQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">if</span> (loggerQueue <span style="color:#719e07">==</span> <span style="color:#b58900">nil</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>loggerQueueName <span style="color:#719e07">=</span> <span style="color:#b58900">NULL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">if</span> ([logger respondsToSelector:<span style="color:#719e07">@selector</span>(loggerName)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        loggerQueueName <span style="color:#719e07">=</span> logger.loggerName.UTF8String;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    loggerQueue <span style="color:#719e07">=</span> dispatch_queue_create(loggerQueueName, <span style="color:#b58900">NULL</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>}
</code></pre></div><p>è¿™æ®µä»£ç ï¼Œæœ‰æ²¡æœ‰ä¼¼æ›¾ç›¸è¯†çš„å¹²ï¼Ÿè¿™æ˜¯åœ¨ <code>DDLogger Protocol</code> å£°æ˜æ—¶æåˆ°çš„é€»è¾‘ã€‚å¦‚æœ logger æä¾›äº† loggerQueue åˆ™ç›´æ¥ä½¿ç”¨ã€‚å¦åˆ™ï¼Œé€šè¿‡ loggerName æ¥åˆ›å»ºã€‚</p>
<p>æœ€åå°±æ˜¯åˆ›å»º DDLoggerNodeï¼Œæ·»åŠ  loggerï¼Œå‘é€ <code>didAddLogger</code> é€šçŸ¥ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>DDLoggerNode <span style="color:#719e07">*</span>loggerNode <span style="color:#719e07">=</span> [DDLoggerNode nodeWithLogger:logger loggerQueue:loggerQueue level:level];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>[<span style="color:#b58900">self</span>._loggers addObject:loggerNode];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">if</span> ([logger respondsToSelector:<span style="color:#719e07">@selector</span>(didAddLoggerInQueue:)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    dispatch_async(loggerNode<span style="color:#719e07">-&gt;</span>_loggerQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        [logger didAddLoggerInQueue:loggerNode<span style="color:#719e07">-&gt;</span>_loggerQueue];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    } });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>} <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> ([logger respondsToSelector:<span style="color:#719e07">@selector</span>(didAddLogger)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    dispatch_async(loggerNode<span style="color:#719e07">-&gt;</span>_loggerQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        [logger didAddLogger];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    } });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>}
</code></pre></div><p><strong>RemoveLogger</strong></p>
<p>åŒ addLogger ç±»ä¼¼ï¼ŒremoveLogger ä¹Ÿæä¾›äº†å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•ã€‚ç±»æ–¹æ³•é€šè¿‡ sharedInstance æœ€ç»ˆæ”¶å£åˆ°å®ä¾‹æ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">removeLogger:</span>(<span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>)<span style="color:#268bd2">logger</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>logger) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>        <span style="color:#719e07">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    dispatch_async(_loggingQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>        [<span style="color:#b58900">self</span> lt_removeLogger:logger];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    } });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>}
</code></pre></div><p><strong>-[DDLog lt_removeLogger:]</strong></p>
<p>åˆ é™¤å‰ï¼Œç…§ä¾‹æ˜¯ loggingQueue æ£€æŸ¥ï¼Œç„¶åéå†è·å– loggerNodeï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>DDLoggerNode <span style="color:#719e07">*</span>loggerNode <span style="color:#719e07">=</span> <span style="color:#b58900">nil</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">for</span> (DDLoggerNode <span style="color:#719e07">*</span>node <span style="color:#719e07">in</span> <span style="color:#b58900">self</span>._loggers) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">if</span> (node<span style="color:#719e07">-&gt;</span>_logger <span style="color:#719e07">==</span> logger) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>        loggerNode <span style="color:#719e07">=</span> node;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>        <span style="color:#719e07">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>}
</code></pre></div><p>å¦‚æœ loggerNode ä¸å­˜åœ¨ï¼Œåˆ™æå‰ç»“æŸã€‚å­˜åœ¨ï¼Œåˆ™ä¼šå…ˆå‘ loggerNode å‘é€ <code>willRemoveLogger</code> é€šçŸ¥ï¼Œå†ç§»é™¤ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> ([logger respondsToSelector:<span style="color:#719e07">@selector</span>(willRemoveLogger)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    dispatch_async(loggerNode<span style="color:#719e07">-&gt;</span>_loggerQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>        [logger willRemoveLogger];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    } });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>[<span style="color:#b58900">self</span>._loggers removeObject:loggerNode];
</code></pre></div><p>DDLog è¿˜æä¾›äº† removeAllLoggers çš„æ–¹æ³•ï¼Œä»¥ä¸€æ¬¡æ€§æ¸…é›¶ loggersï¼Œå®ç°åŒ <code>lt_removeLogger:</code> ç±»ä¼¼ï¼Œè¿™é‡Œä¸å±•å¼€äº†ã€‚</p>
<h3 id="logging">Logging</h3>
<p>logging ç›¸å…³æ–¹æ³•æ˜¯ DDLog çš„æ ¸å¿ƒï¼Œæä¾›ä¸‰ç§ç±»å‹çš„å®ä¾‹æ–¹æ³•ï¼Œä»¥åŠåˆ†åˆ«å¯¹åº”çš„ç±»æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹ç¬¬ä¸€ä¸ªï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>+ (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">log:</span>(<span style="color:#dc322f">BOOL</span>)<span style="color:#268bd2">asynchronous</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>      <span style="color:#268bd2">level:</span>(DDLogLevel)<span style="color:#268bd2">level</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>       <span style="color:#268bd2">flag:</span>(DDLogFlag)<span style="color:#268bd2">flag</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#268bd2">context:</span>(NSInteger)<span style="color:#268bd2">context</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>       <span style="color:#268bd2">file:</span>(<span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>)<span style="color:#268bd2">file</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>   <span style="color:#268bd2">function:</span>(nullable <span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>)<span style="color:#268bd2">function</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>       <span style="color:#268bd2">line:</span>(NSUInteger)<span style="color:#268bd2">line</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>        <span style="color:#268bd2">tag:</span>(nullable <span style="color:#dc322f">id</span>)<span style="color:#268bd2">tag</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>     <span style="color:#268bd2">format:</span>(NSString <span style="color:#719e07">*</span>)<span style="color:#268bd2">format</span>, ... NS_FORMAT_FUNCTION(<span style="color:#2aa198">9</span>,<span style="color:#2aa198">10</span>);
</code></pre></div><p>ç†Ÿæ‚‰å§ï¼Œè¿™äº›å‚æ•°å‰é¢éƒ½ä»‹ç»è¿‡äº†ï¼Œæ˜¯æ„é€  log message æ‰€éœ€çš„å…³å‚æ•°ã€‚æœ€åä¸€ä¸ª C å†™æ³•çš„å¯å˜å‚æ•° <code>...</code> ç”¨äºç”Ÿæˆ log message stringï¼ŒåŒæ · DDLog ä¹Ÿæä¾›äº†å®ƒçš„å˜ç§ <code>args:(va_list)argList</code> ï¼Œè¿™å°±æ˜¯ç¬¬äºŒç§ log æ–¹æ³•ã€‚æœ€åä¸€ç§åˆ™æ˜¯ç”±ç”¨æˆ·ç›´æ¥æä¾› logMessageã€‚</p>
<p>å¯¹äº <code>...</code> çš„å¯å˜å‚æ•°çš„è·å–ï¼Œæ˜¯é€šè¿‡ c æä¾›çš„å®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>va_list args;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>va_start(args, format);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>NSString <span style="color:#719e07">*</span>message <span style="color:#719e07">=</span> [[NSString alloc] initWithFormat:format arguments:args];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>va_end(args);
</code></pre></div><p><strong>-[DDLog queueLogMessage: asynchronously:]</strong></p>
<p>å‡†å¤‡å¥½ log message åˆ™å¼€å§‹åˆ†å‘ï¼Œè¿›è¡Œå¼‚æ­¥è°ƒç”¨ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">queueLogMessage:</span>(DDLogMessage <span style="color:#719e07">*</span>)<span style="color:#268bd2">logMessage</span> <span style="color:#268bd2">asynchronously:</span>(<span style="color:#dc322f">BOOL</span>)<span style="color:#268bd2">asyncFlag</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>   dispatch_block_t logBlock <span style="color:#719e07">=</span> <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        dispatch_semaphore_wait(_queueSemaphore, DISPATCH_TIME_FOREVER);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>            [<span style="color:#b58900">self</span> lt_log:logMessage];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    };
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">if</span> (asyncFlag) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        dispatch_async(_loggingQueue, logBlock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    } <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> (dispatch_get_specific(GlobalLoggingQueueIdentityKey)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        logBlock();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    } <span style="color:#719e07">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        dispatch_sync(_loggingQueue, logBlock);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>}
</code></pre></div><p>å…ˆå¿½ç•¥ logBlockï¼Œçœ‹ DDLog å¦‚æœå¤„ç† loggingQueue è°ƒåº¦ï¼Œä»¥åŠå¦‚ä½•æ¥é¿å…çº¿ç¨‹æ­»é”é—®é¢˜ã€‚è¿™é‡Œçš„è§£å†³æ–¹å¼ç»å¯¹éœ€è¦<strong>åˆ’é‡ç‚¹</strong>ã€‚å¤§å®¶ç»å¸¸é‡åˆ°çš„ä¸»çº¿ç¨‹æ­»é”ï¼Œå¾ˆå¸¸è§çš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">viewDidLoad</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    [<span style="color:#b58900">super</span> viewDidLoad];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    NSLog(<span style="color:#2aa198">@&#34;1&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    dispatch_sync(dispatch_get_main_queue(), <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>        NSLog(<span style="color:#2aa198">@&#34;2&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    NSLog(<span style="color:#2aa198">@&#34;3&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>}
</code></pre></div><p>è¿™ä¸ªä¹Ÿæ˜¯é¢è¯•ä¼šè¢«å¸¸å¸¸é—®åˆ°çš„ caseã€‚æ ¸å¿ƒç‚¹åœ¨äºï¼Œä¸Šè¿°ä»£ç åœ¨ main thread æ‰§è¡Œäº† dispatch_sync å¼€å¯äº† main queue çš„åŒæ­¥ç­‰å¾…ã€‚è§£å†³æ–¹æ¡ˆå°±æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ SDWebImage ä¸­å°±æä¾›äº† <a href="https://looseyi.github.io/post/sourcecode-ios/source-code-sdweb-1/">dispatch_main_async_safe</a> æ¥é¿å…è¯¥é—®é¢˜ã€‚</p>
<p>å›åˆ° DDLogï¼Œç°åœ¨å¤§å®¶å¯ä»¥æ˜ç™½åœ¨ dispatch_sync å‰ä¸ºä½•éœ€è¦å¤šä¸€æ­¥ queue identity çš„åˆ¤æ–­äº†å§ã€‚å¦å¤–ï¼Œå…³äºè¿™ä¸ªé—®é¢˜ï¼Œ<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/issues/812#issuecomment-298853313">github issuse #812</a> ä¸­æœ‰æ¯”è¾ƒè¯¦ç»†çš„è®ºè¿°ã€‚</p>
<p>æ¥ç€çœ‹ logBlockï¼Œå®ƒåœ¨æ‰§è¡Œç¬¬ä¸€è¡Œä»£ç æ—¶ï¼Œå°±å¼€å¯äº† semaphore_wait ç›´åˆ°å¯ç”¨é˜Ÿåˆ—æ•°å°äº maximumQueueSizeã€‚é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ç»™ queueSize åŠ é”çš„æ–¹å¼æ¥ç¡®ä¿å¯ç”¨é˜Ÿåˆ—æ•°çš„å‡†ç¡®æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚ä½†æ˜¯è¿™é‡Œä½œè€…å¸Œæœ›ï¼Œèƒ½å¤Ÿæ›´å¿«é€Ÿçš„æ¥è·å–æ·»åŠ  log mesage å…¥é˜Ÿåˆ—çš„æ—¶æœºï¼Œæ¯•ç«Ÿé”çš„å¼€é”€æ¯”è¾ƒå¤§ã€‚</p>
<p>è¿™ç§å®è·µåœ¨å¾ˆå¤šä¼˜ç§€å¼€æºåº“ä¸­éƒ½ç”¨åˆ°äº†ï¼Œæ¯”å¦‚ SDWebImageã€‚</p>
<p><strong>- [DDLog lt_log:]</strong></p>
<p>è¯¥æ–¹æ³•æ˜¯å°† log message åˆ†é…åˆ°æ‰€ä»¥æ»¡è¶³çš„ logger æ‰‹ä¸­ã€‚å¼€å§‹å‰ç…§ä¾‹è¿›è¡Œ QueueIdentity çš„æ–­è¨€ã€‚æ¥ç€ä¾æ® CPU å†…æ ¸æ•°æ˜¯å•æ ¸æˆ–è€…å¤šæ ¸åŒºåˆ«å¯¹å¾…ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">if</span> (_numProcessors <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">1</span>) {  ... } <span style="color:#719e07">else</span> { ... }
</code></pre></div><ol>
<li>å¤šæ ¸å¤„ç†å™¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">for</span> (DDLoggerNode <span style="color:#719e07">*</span>loggerNode <span style="color:#719e07">in</span> <span style="color:#b58900">self</span>._loggers) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span>(logMessage<span style="color:#719e07">-&gt;</span>_flag <span style="color:#719e07">&amp;</span> loggerNode<span style="color:#719e07">-&gt;</span>_level)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>        <span style="color:#719e07">continue</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    dispatch_group_async(_loggingGroup, loggerNode<span style="color:#719e07">-&gt;</span>_loggerQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>        [loggerNode<span style="color:#719e07">-&gt;</span>_logger logMessage:logMessage];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    } });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>dispatch_group_wait(_loggingGroup, DISPATCH_TIME_FOREVER);
</code></pre></div><p>ç¨å¾®æä¸€ä¸‹ DDLog çš„è®¾è®¡æ€è·¯ï¼Œç”±äºä¸€æ¡ log message å¯èƒ½ä¼šæä¾›ç»™å¤šä¸ªä¸åŒç±»å‹çš„ logger å¤„ç†ã€‚ä¾‹å¦‚ï¼Œä¸€æ¡ log å¯èƒ½åŒæ—¶éœ€è¦è¾“å‡ºåˆ°ç»ˆç«¯ã€å†™å…¥åˆ° log file ä¸­ã€é€šè¿‡ websocket è¾“å‡ºåˆ°æµè§ˆå™¨æ–¹ä¾¿æµ‹è¯•ç­‰æ“ä½œã€‚</p>
<p>é¦–å…ˆï¼Œé€šè¿‡ logMessage-&gt;_flag è¿‡æ»¤æ‰ level ä¸åŒ¹é…çš„ loggerNodeã€‚ç„¶åä»åŒ¹é…åˆ°çš„ loggerNode ä¸­å–å‡º loggerQueue å’Œ logger è°ƒç”¨ <code>logMessage:</code> ã€‚</p>
<p>é‡ç‚¹æ¥äº†ï¼Œè¿™é‡Œåˆ©ç”¨ _loggingGroup å°†æœ¬æ¬¡çš„ <code>logMessage:</code> å…³è”åˆ° group ä¸­ï¼Œæ‰“åŒ…æˆä¸€ä¸ª &ldquo;äº‹åŠ¡&rdquo;ï¼Œä»¥ä¿è¯æ¯æ¬¡çš„ <code>lt_log:</code> éƒ½æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚è€Œæ¯ä¸ª logger æœ¬èº«éƒ½åˆ†é…äº†ç‹¬ç«‹çš„ loggerQueueï¼Œé€šè¿‡è¿™ç§ç»„åˆï¼Œå³ä¿è¯äº† logger çš„å¹¶å‘è°ƒç”¨ï¼Œåˆèƒ½æ»¡è¶³ queueSize çš„é™åˆ¶ã€‚</p>
<p>ä½¿ç”¨ dispatch_group_wait è¿˜æœ‰ä¸€ä¸ªç›®çš„ï¼Œå°±æ˜¯ç¡®ä¿é‚£äº›æ‰§è¡Œæ•ˆæœæ…¢çš„ logger ä¹Ÿèƒ½æŒ‰é¡ºåºå®Œæˆè°ƒç”¨ï¼Œé¿å…é˜Ÿåˆ—ä»»åŠ¡è¿‡å¤šæ—¶ï¼Œè¿™äº› logger æ²¡èƒ½åŠæ—¶å®Œæˆå¯¼è‡´å¤§é‡çš„ padding log message æ²¡æœ‰è¢«åŠæ—¶å¤„ç†ã€‚</p>
<ol start="2">
<li>å¯¹å•æ ¸å¤„ç†å°±æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯ç¬¬äºŒæ­¥ä¸åŒã€‚ä¸å­˜åœ¨ gropu æ“ä½œï¼š</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>dispatch_sync(loggerNode<span style="color:#719e07">-&gt;</span>_loggerQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>    [loggerNode<span style="color:#719e07">-&gt;</span>_logger logMessage:logMessage];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>} });
</code></pre></div><p>æœ€åï¼Œåˆ†é…å®Œ logger message åï¼Œéœ€è¦å°† _queueSemaphore åŠ  1:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>dispatch_semaphore_signal(_queueSemaphore);
</code></pre></div><p><strong>lt_flush</strong></p>
<p>DDLog çš„æœ€åä¸€ä¸ªæ–¹æ³•ï¼Œä¼šåœ¨ç¨‹åºç»“æŸå‰ç”±é€šçŸ¥æ¥è§¦å‘æ‰§è¡Œï¼Œå…¶å®ç°åŒ <code>lt_log:</code> ç±»ä¼¼ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>- (<span style="color:#dc322f">void</span>)<span style="color:#268bd2">lt_flush</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    NSAssert(dispatch_get_specific(GlobalLoggingQueueIdentityKey),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>             <span style="color:#2aa198">@&#34;This method should only be run on the logging thread/queue&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">for</span> (DDLoggerNode <span style="color:#719e07">*</span>loggerNode <span style="color:#719e07">in</span> <span style="color:#b58900">self</span>._loggers) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>        <span style="color:#719e07">if</span> ([loggerNode<span style="color:#719e07">-&gt;</span>_logger respondsToSelector:<span style="color:#719e07">@selector</span>(flush)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>            dispatch_group_async(_loggingGroup, loggerNode<span style="color:#719e07">-&gt;</span>_loggerQueue, <span style="color:#719e07">^</span>{ <span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>                [loggerNode<span style="color:#719e07">-&gt;</span>_logger flush];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>            } });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    dispatch_group_wait(_loggingGroup, DISPATCH_TIME_FOREVER);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>}
</code></pre></div><h3 id="å°ç»“">å°ç»“</h3>
<p>DDLog åå‰¯å…¶å®çš„ managerï¼Œåˆ©ç”¨äº†ä¿¡å·é‡å’Œ group é«˜æ•ˆçš„å®Œæˆå¯¹ message çš„è°ƒåº¦ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å·¥ä½œï¼š</p>
<ol>
<li>ç®¡ç† logger çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶å¯¹å…¶æ·»åŠ ã€åˆ é™¤æ“ä½œè¿›è¡Œç›¸åº”é€šçŸ¥ï¼›</li>
<li>ç”Ÿæˆ logMessage å¹¶åœ¨çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œå°†å…¶åˆ†é…åˆ°å¯¹åº”çš„ logger ä»¥åŠ å·¥ messageã€‚</li>
<li>åœ¨ç¨‹åºç»“æŸåï¼ŒåŠæ—¶é€šçŸ¥ logger æ¸…ç† pending çŠ¶æ€çš„ messageã€‚</li>
</ol>
<h1 id="loggers-1">Loggers</h1>
<p>ç°åœ¨æˆ‘ä»¬æ¥èŠèŠ loggerã€‚DDLog ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª logger åŸºç±» DDAbstractLogger ä»¥åŠå‡ ä¸ªé»˜è®¤å®ç°ã€‚ä¸€ä¸€æ¥è¿‡ä¸€ä¸‹ï¼›</p>
<h2 id="ddabstractlogger">DDAbstractLogger</h2>
<p>AbstractLogger å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@interface</span> <span style="color:#268bd2">DDAbstractLogger</span> : <span style="color:#268bd2">NSObject</span> <span style="color:#719e07">&lt;</span>DDLogger<span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">@public</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogFormatter<span style="color:#719e07">&gt;</span> _logFormatter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    dispatch_queue_t _loggerQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">strong</span>, nullable) <span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogFormatter<span style="color:#719e07">&gt;</span> logFormatter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, DISPATCH_QUEUE_REFERENCE_TYPE) dispatch_queue_t loggerQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">readonly</span>, <span style="color:#719e07">getter</span><span style="color:#719e07">=</span>isOnGlobalLoggingQueue)  <span style="color:#dc322f">BOOL</span> onGlobalLoggingQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">@property</span> (<span style="color:#719e07">nonatomic</span>, <span style="color:#719e07">readonly</span>, <span style="color:#719e07">getter</span><span style="color:#719e07">=</span>isOnInternalLoggerQueue) <span style="color:#dc322f">BOOL</span> onInternalLoggerQueue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">@end</span>
</code></pre></div><p>å…ˆçœ‹åˆå§‹åŒ–æ–¹æ³• <code>init</code> ï¼š</p>
<h3 id="init">Init</h3>
<p>AdstractLogger é»˜è®¤æä¾›äº† loggerQueue ä»¥åŠå½“å‰æ˜¯å¦ä¸º loggerQueue å’Œ å…¨å±€ loggingQueue çš„ convene æ–¹æ³•ã€‚loggerQueue çš„åˆå§‹åŒ–æ˜¯åœ¨ <code>init</code> ä¸­å®Œæˆçš„ï¼Œæ•´ä¸ª <code>init</code> ä¹Ÿå°±åšäº†è¿™ä¸€ä»¶äº‹ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>loggerQueueName <span style="color:#719e07">=</span> <span style="color:#b58900">NULL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">if</span> ([<span style="color:#b58900">self</span> respondsToSelector:<span style="color:#719e07">@selector</span>(loggerName)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    loggerQueueName <span style="color:#719e07">=</span> <span style="color:#b58900">self</span>.loggerName.UTF8String;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>_loggerQueue <span style="color:#719e07">=</span> dispatch_queue_create(loggerQueueName, <span style="color:#b58900">NULL</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>key <span style="color:#719e07">=</span> (<span style="color:#719e07">__bridge</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>)<span style="color:#b58900">self</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>nonNullValue <span style="color:#719e07">=</span> (<span style="color:#719e07">__bridge</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>)<span style="color:#b58900">self</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>dispatch_queue_set_specific(_loggerQueue, key, nonNullValue, <span style="color:#b58900">NULL</span>);
</code></pre></div><p>åŒæ ·å…ˆè·å– queueNameï¼Œè¿™é‡Œé»˜è®¤è¿”å›çš„ <code>loggerName</code> æ˜¯ <code>NSStringFromClass([self class]);</code> ã€‚</p>
<p>åŒæ—¶ï¼Œä»¥ self çš„åœ°å€ä½œä¸º flag å…³è”åˆ° loggerQueueï¼Œå¹¶ç”¨äºåˆ¤æ–­ <code>onInternalLoggerQueue</code> ã€‚</p>
<h3 id="logformatter">LogFormatter</h3>
<p>AdstractLogger æœ€ä¸»è¦çš„æ˜¯å®ç°äº† logFormatter çš„ getter/setter æ–¹æ³•ã€‚åŒæ—¶ä»£ç ä¸­èµ‹äºˆäº†ååˆ†è¯¦ç»†çš„è¯´æ˜ï¼Œå…ˆçœ‹çœ‹ getter å®ç°ã€‚</p>
<p><strong>Getter</strong></p>
<p>é¦–å…ˆæ˜¯çº¿ç¨‹ç›¸å…³çš„æ–­è¨€ï¼Œç¡®ä¿å½“å‰ä¸åœ¨ global queue å’Œ loggerQueueï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>NSAssert(<span style="color:#719e07">!</span>[<span style="color:#b58900">self</span> isOnGlobalLoggingQueue], <span style="color:#2aa198">@&#34;Core architecture requirement failure&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>NSAssert(<span style="color:#719e07">!</span>[<span style="color:#b58900">self</span> isOnInternalLoggerQueue], <span style="color:#2aa198">@&#34;MUST access ivar directly, NOT via self.* syntax.&#34;</span>);
</code></pre></div><p>æ¥ç€åœ¨ loggingQueue å’Œ loggerQueue ä¸­è·å– logFormatterï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>dispatch_queue_t globalLoggingQueue <span style="color:#719e07">=</span> [DDLog loggingQueue];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">__block</span> <span style="color:#dc322f">id</span> <span style="color:#719e07">&lt;</span>DDLogFormatter<span style="color:#719e07">&gt;</span> result;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>dispatch_sync(globalLoggingQueue, <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    dispatch_sync(<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_loggerQueue, <span style="color:#719e07">^</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        result <span style="color:#719e07">=</span> <span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>});
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">return</span> result;
</code></pre></div><p>çœ‹å»ä¸€ä¸ªæ™®é€šçš„ formatter ä¸ºä½•éœ€è¦å¦‚æ­¤å¤§åŠ¨å¹²æˆˆï¼Œéœ€è¦å±‚å±‚æ·±å…¥æ¥å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>DDLogVerbose(<span style="color:#2aa198">@&#34;log msg 1&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>DDLogVerbose(<span style="color:#2aa198">@&#34;log msg 2&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>[logger setFormatter:myFormatter];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>DDLogVerbose(<span style="color:#2aa198">@&#34;log msg 3&#34;</span>);
</code></pre></div><p>ä»ç›´è§‰ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ç»“æœæ˜¯æ–°è®¾ç½®çš„ formatter ä»…åº”ç”¨åœ¨ç¬¬ 3 æ¡ log message ä¸Šã€‚ç„¶è€Œ DDLog åœ¨æ•´ä¸ª logging è¿‡ç¨‹ä¸­å´éƒ½æ˜¯å¼‚æ­¥è°ƒç”¨çš„ã€‚</p>
<ol>
<li>log message æœ€ç»ˆæ˜¯åœ¨å•ç‹¬çš„ loggerQueue ä¸­æ‰§è¡Œçš„ï¼Œæ˜¯ç”± logger å„è‡ªæŒæœ‰çš„ queueï¼›</li>
<li>åœ¨è¿›å…¥æ¯ä¸ª loggerQueue ä¹‹å‰ï¼Œåˆè¦ç»è¿‡ä¸€é“å…¨å±€çš„ loggingQueueã€‚</li>
</ol>
<p>Soï¼Œæƒ³è¦çº¿ç¨‹å®‰å…¨åˆè¦ç¬¦åˆç›´è§‰çš„è¯ï¼Œåªèƒ½éµå¾ª log message çš„è„šæ­¥ï¼Œèµ°ä¸€éç›¸å…³ queueã€‚</p>
<p>éœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œloggeråœ¨å†…éƒ¨<strong>æœ€å¥½ç›´æ¥è®¿é—® FORMATTER VARIABLE</strong> ï¼Œå¦‚æœéœ€è¦çš„è¯ã€‚ä¸€æ—¦ä½¿ç”¨ <code>self.</code>  å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹æ­»é”ã€‚</p>
<p><strong>Setter</strong></p>
<p>åŒ getter ä¸€è‡´ï¼Œå…ˆæ–­è¨€ï¼Œç„¶åä¾æ¬¡è¿›å…¥é˜Ÿåˆ— <code>DDLog.loggingQueue -&gt; self-&gt;_loggerQueue</code> æ‰§è¡Œ block å¼€å§‹çœŸæ­£çš„èµ‹å€¼ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">@autoreleasepool</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    <span style="color:#719e07">if</span> (<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter <span style="color:#719e07">!=</span> logFormatter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">if</span> ([<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter respondsToSelector:<span style="color:#719e07">@selector</span>(willRemoveFromLogger:)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>            [<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter willRemoveFromLogger:<span style="color:#b58900">self</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter <span style="color:#719e07">=</span> logFormatter;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">if</span> ([<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter respondsToSelector:<span style="color:#719e07">@selector</span>(didAddToLogger:inQueue:)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>            [<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter didAddToLogger:<span style="color:#b58900">self</span> inQueue:<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_loggerQueue];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        } <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> ([<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter respondsToSelector:<span style="color:#719e07">@selector</span>(didAddToLogger:)]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>            [<span style="color:#b58900">self</span><span style="color:#719e07">-&gt;</span>_logFormatter didAddToLogger:<span style="color:#b58900">self</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>}
</code></pre></div><h2 id="ddasllogger">DDASLLogger</h2>
<p>ASLLogger æ˜¯å¯¹ <strong>Apple System Log</strong> API çš„å°è£…ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ <code>NSLog</code> ä¼šå°†å…¶è¾“å‡ºå®šå‘åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š</p>
<ul>
<li><a href="https://support.apple.com/zh-cn/guide/console/cnsl1012/mac">Apple System Log</a></li>
<li><a href="https://www.wikiwand.com/en/Standard_streams">Standard error</a> ï¼ˆtelemetryï¼‰</li>
</ul>
<p>ä¸è¿‡ ASLLogger åœ¨ macosx 10.12 iOS 10.0 å·²ç»è¢«åºŸå¼ƒäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ DDOSLogerã€‚ASLLogger èƒŒåä½¿ç”¨çš„ API æ˜¯ <a href="https://opensource.apple.com/source/Libc/Libc-583/include/asl.h.auto.html"><strong>&lt;asl.h&gt;</strong></a> ï¼Œå®ƒä¹Ÿæä¾›äº†å‡ ç§ message level</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75">/*! @defineblock Log Message Priority Levels Log levels of the message. */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">#define ASL_LEVEL_EMERG   0
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">#define ASL_LEVEL_ALERT   1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">#define ASL_LEVEL_CRIT    2 </span><span style="color:#586e75">// DDLogFlagError
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#586e75"></span><span style="color:#719e07">#define ASL_LEVEL_ERR     3 </span><span style="color:#586e75">// DDLogFlagWarning
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#586e75"></span><span style="color:#719e07">#define ASL_LEVEL_WARNING 4 </span><span style="color:#586e75">// DDLogFlagInfo, Regular NSLog&#39;s level
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#586e75"></span><span style="color:#719e07">#define ASL_LEVEL_NOTICE  5 </span><span style="color:#586e75">// default
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#586e75"></span><span style="color:#719e07">#define ASL_LEVEL_INFO    6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">#define ASL_LEVEL_DEBUG   7
</span></code></pre></div><p>é»˜è®¤æƒ…å†µä¸‹ ASL ä¼šè¿‡æ»¤ NOTICE ä¹‹ä¸Šçš„ä¿¡æ¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½• DDLog åŸºæœ¬ä¹Ÿå°±è®¾ç½®äº† 5 ç§æ—¥å¿—çº§åˆ«ã€‚</p>
<h3 id="logmessage">logMessage</h3>
<p>logMessage æ˜¯æ¯ä¸ª logger å¤„ç† log message çš„æ–¹æ³•ã€‚ASLLogger é¦–å…ˆä¼šè¿‡æ»¤ filename ä¸º <code>DDASLLogCapture</code> (ä¸»åŠ¨ç›‘å¬çš„ç³»ç»Ÿ log)ã€‚ç„¶åå¯¹ message è¿›è¡Œ formateï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objc" data-lang="objc"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>NSString <span style="color:#719e07">*</span> message <span style="color:#719e07">=</span> _logFormatter <span style="color:#719e07">?</span> [_logFormatter formatLogMessage:logMessage] <span style="color:#719e07">:</span> logMessage<span style="color:#719e07">-&gt;</span>_message;
</code></pre></div><p>å¦‚æœ message å­˜åœ¨ï¼Œç”Ÿæˆ <code>aslmsg</code>  é€šè¿‡ <code>asl_send</code> å‘é€è‡³ ASLã€‚å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>msg <span style="color:#719e07">=</span> [message UTF8String];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>size_t aslLogLevel; <span style="color:#586e75">// logMessage-&gt;_flag è·å– ASL_LEVEL_XXX
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">static</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">const</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> level_strings[] <span style="color:#719e07">=</span> { <span style="color:#2aa198">&#34;0&#34;</span>, <span style="color:#2aa198">&#34;1&#34;</span>, <span style="color:#2aa198">&#34;2&#34;</span>, <span style="color:#2aa198">&#34;3&#34;</span>, <span style="color:#2aa198">&#34;4&#34;</span>, <span style="color:#2aa198">&#34;5&#34;</span>, <span style="color:#2aa198">&#34;6&#34;</span>, <span style="color:#2aa198">&#34;7&#34;</span> };
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>uid_t <span style="color:#719e07">const</span> readUID <span style="color:#719e07">=</span> geteuid(); <span style="color:#586e75">/// the effective user ID of the calling process
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#dc322f">char</span> readUIDString[<span style="color:#2aa198">16</span>]; <span style="color:#586e75">/// formatted output conversion
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span><span style="color:#719e07">#ifndef NS_BLOCK_ASSERTIONS
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07"></span>size_t l <span style="color:#719e07">=</span> (size_t)snprintf(readUIDString, <span style="color:#719e07">sizeof</span>(readUIDString), <span style="color:#2aa198">&#34;%d&#34;</span>, readUID);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">#else
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07"></span>snprintf(readUIDString, <span style="color:#719e07">sizeof</span>(readUIDString), <span style="color:#2aa198">&#34;%d&#34;</span>, readUID);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">#endif
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>NSAssert(l <span style="color:#719e07">&lt;</span> <span style="color:#719e07">sizeof</span>(readUIDString), <span style="color:#2aa198">@&#34;Formatted euid is too long.&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>NSAssert(aslLogLevel <span style="color:#719e07">&lt;</span> (<span style="color:#719e07">sizeof</span>(level_strings) <span style="color:#719e07">/</span> <span style="color:#719e07">sizeof</span>(level_strings[<span style="color:#2aa198">0</span>])), <span style="color:#2aa198">@&#34;Unhandled ASL log level.&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>aslmsg m <span style="color:#719e07">=</span> asl_new(ASL_TYPE_MSG);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">if</span> (m <span style="color:#719e07">!=</span> <span style="color:#b58900">NULL</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>    <span style="color:#719e07">if</span> (asl_set(m, ASL_KEY_LEVEL, level_strings[aslLogLevel]) <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        asl_set(m, ASL_KEY_MSG, msg) <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        asl_set(m, ASL_KEY_READ_UID, readUIDString) <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        asl_set(m, kDDASLKeyDDLog, kDDASLDDLogValue) <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>        asl_send(_client, m);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    asl_free(m);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>}
</code></pre></div><h2 id="ddoslogger">DDOSLogger</h2>
<p>è‹¹æœçš„æ–°ä¸€ä»£ logging system <a href="https://developer.apple.com/documentation/os/logging">os_log</a>ï¼Œå®˜æ–¹æä¾›äº†æ¯”è¾ƒå®Œæ•´çš„æ¦‚è¿°å’Œè¯´æ˜ã€‚æ­£æ˜¯å®ƒå–ä»£äº† ASLï¼Œmanual å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>The unified logging system provides a single, efficient, high performance set of APIs for capturing log messages across all levels of the system.  This unified system centralizes the storage of log data in memory and in a data store on disk.</p>
</blockquote>
<p>å®ƒæä¾›äº†æ—¥å¿—è®°å½•çš„ä¸­å¿ƒåŒ–å­˜å‚¨ã€‚åŒæ—¶ API ä¹Ÿååˆ†ç®€æ´ï¼Œå…³äº os_log æœ‰æœºä¼šåœ¨å±•å¼€ã€‚</p>
<h3 id="init-1">Init</h3>
<p>é¦–å…ˆï¼ŒOSLogger éœ€è¦æŒæœ‰ä¸€ä¸ª log objectï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>os_log_t <span style="color:#268bd2">os_log_create</span>(<span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>subsystem, <span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>category);
</code></pre></div><p><strong>subsystem</strong></p>
<blockquote>
<p>An identifier string, in reverse DNS notation, that represents the subsystem thatâ€™s performing logging, for example, <code>com.your_company.your_subsystem_name</code>. The subsystem is used for categorization and filtering of related log messages, as well as for grouping related logging settings.</p>
</blockquote>
<p><strong>category</strong></p>
<blockquote>
<p>A category within the specified subsystem. The system uses the category to categorize and filter related log messages, as well as to group related logging settings within the subsystemâ€™s settings. A categoryâ€™s logging settings override those of the parent subsystem.</p>
</blockquote>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œos_log çš„å®˜æ–¹æ–‡æ¡£æ˜¯åªæä¾›äº† Swift è¯´æ˜ï¼ŒOSLog.Category <a href="https://developer.apple.com/documentation/os/oslog/category">è¯¦ç»†ç‚¹æ­¤</a>ã€‚</p>
<h3 id="logmessage-1">LogMessage</h3>
<p>åŒæ ·æ˜¯è¿‡æ»¤ filename ä¸º <code>DDASLLogCapture</code> çš„ log message å’Œå¯¹ log message çš„ formatterã€‚os_log æ‰€æä¾›çš„ API åˆ™ååˆ†å‹å¥½ç®€æ´ï¼Œæ¯ç§ <a href="https://developer.apple.com/documentation/kernel/os_log_type_t?language=objc">os_log_type_t</a> éƒ½æä¾›äº†å¯¹åº”çš„æ–¹æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objective-c" data-lang="objective-c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>__auto_type logger <span style="color:#719e07">=</span> [<span style="color:#b58900">self</span> logger];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">switch</span> (logMessage<span style="color:#719e07">-&gt;</span>_flag) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">case</span> DDLogFlagError  :
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>        os_log_error(logger, <span style="color:#2aa198">&#34;%{public}s&#34;</span>, msg);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        <span style="color:#719e07">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">case</span> DDLogFlagWarning:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">case</span> DDLogFlagInfo   :
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        os_log_info(logger, <span style="color:#2aa198">&#34;%{public}s&#34;</span>, msg);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">case</span> DDLogFlagDebug  :
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">case</span> DDLogFlagVerbose:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#719e07">default</span>              <span style="color:#719e07">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        os_log_debug(logger, <span style="color:#2aa198">&#34;%{public}s&#34;</span>, msg);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>}
</code></pre></div><h2 id="ddttylogger">DDTTYLogger</h2>
<blockquote>
<p>This class provides a logger for Terminal output or Xcode console output, depending on where you are running your code.</p>
</blockquote>
<p>é€šè¿‡å®ƒå°†æ—¥å¿—å®šå‘åˆ°ç»ˆç«¯å’Œ Xcode ç»ˆç«¯ï¼ŒåŒæ—¶æ”¯æŒå½©è‰²ã€‚Xcode æ”¯æŒéœ€è¦æ·»åŠ  <a href="https://github.com/robbiehanson/XcodeColors">XcodeColors æ’ä»¶</a>ã€‚TTYLogger å†…éƒ¨çš„ä»£ç æœ‰ä¸Šåƒè¡Œã€‚ä¸è¿‡æ‰€åšçš„äº‹æƒ…æ¯”è¾ƒç®€å•ã€‚æ ¹æ®ä¸åŒç»ˆç«¯ç±»å‹æ‰€æ”¯æŒçš„é¢œè‰²èŒƒå›´æ¥å°†è®¾ç½®çš„é¢œè‰²è¿›è¡Œé€‚é…ï¼Œæœ€ç»ˆè¾“å‡ºå‡ºæ¥ã€‚</p>
<p>å…³äºé¢œè‰²èŒƒå›´ä¸»è¦æœ‰ä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li>standard shellï¼šä»…æ”¯æŒ 16 ç§é¢œè‰²</li>
<li>Terminal.appï¼šå¯ä»¥æ”¯æŒåˆ° 256 ç§é¢œè‰²</li>
<li>xterm colors</li>
</ul>
<p>å…·ä½“è§ <a href="http://en.wikipedia.org/wiki/ANSI_escape_code">ANSI_escape_code</a>ã€‚</p>
<h3 id="logmessage-2">LogMessage</h3>
<p>TTYLogger æ”¯æŒä¸ºæ¯ä¸€ç§ logFlag é…ç½®ä¸åŒçš„é¢œè‰²ï¼Œç„¶åå°† color ä¸ flag å°è£…è¿› <code>DDTTYLoggerColorProfile</code> ç±»ä¸­ï¼Œå­˜å‚¨åœ¨ <code>_colorProfilesDict</code> ä¸­ã€‚logMessage ä¸»è¦åˆ†ä¸‰æ­¥ï¼š</p>
<ol>
<li>é€šè¿‡ <code>logMessage-&gt;_tag</code> å–å‡º colorProfileï¼›</li>
<li>å°† log message è½¬ä¸º c stringï¼›</li>
<li>å°† color å†™å…¥ <code>iovec v[iovec_len]</code>ï¼Œæœ€ç»ˆè°ƒç”¨ <code>writev(STDERR_FILENO, v, iovec_len);</code> è¾“å‡ºã€‚</li>
</ol>
<h2 id="æœªå®Œå¾…ç»­">æœªå®Œå¾…ç»­</h2>
<p>ä»¥ä¸Šä¸‰ç§ logger å±äºåŸºæœ¬çš„ç»ˆç«¯è¾“å‡ºï¼Œå¯ç”¨äºæ›¿ä»£ NSLogã€‚é™äºç¯‡å¹…çš„åŸå› ï¼Œè¿˜æœ‰ <code>DDFileLogger</code>ã€<code>DDAbstractDatabaseLogger</code> ä»¥åŠå„ç§æ‰©å±•ï¼Œå¦‚ <code>WebSocketLogger</code> ç­‰ï¼Œæœªåœ¨æœ¬ç¯‡å‡ºç°ã€‚åŒæ—¶è¿˜æœ‰ä¸€æ•´èŠ‚çš„ <code>Formatters</code> å‡æ”¾ä¸‹ä¸€ç¯‡ä¸­ã€‚</p>
<p>æœ¬ç¯‡ï¼Œé€šè¿‡ DDLog ç±»å¯¹ GCD çš„ä½¿ç”¨ï¼Œçœ‹åˆ°äº† lumberjack çš„ä½œè€…å……åˆ†åˆ©ç”¨äº† GCD çš„ç‰¹æ€§æ¥è¾¾åˆ°å®‰å…¨é«˜æ•ˆçš„å¼‚æ­¥ loggingã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­å¹¶æœªä½¿ç”¨é”æ¥è§£å†³çº¿ç¨‹å®‰å…¨ï¼Œç®—æ˜¯å¯¹ GCD çš„å¾ˆå¥½å®è·µäº†ã€‚è¯¥ä½œè€…è¿˜å‡ºå“äº† <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a> ã€<a href="https://github.com/robbiehanson/XMPPFramework">XMPPFramework</a>ã€<a href="https://github.com/robbiehanson/CocoaHTTPServer">CocoaHTTPServer</a> ç­‰çŸ¥åçš„åº“ã€‚ä¹‹åå¯ä»¥æ…¢æ…¢ç»†å“ã€‚</p>
<p>æœ€åï¼Œè´´ä¸€å¼ æ•´ç†çš„è„‘å›¾ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸å–œå‹¿å–·ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gdzcfyok9ij21ee12agqs.jpg" alt="CocoaLumberjack.png"></p>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/source-code">Source Code</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/logger">Logger</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-2/"><span>â†</span><span>æµ…æ - CocoaLumberjack 3.6 ä¹‹ FileLogger</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-ios/source-code-sdweb-en1/"><span>The Architecture of SDWebImage v5.6</span><span>â†’</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugoï¸ï¸</a>ï¸</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
