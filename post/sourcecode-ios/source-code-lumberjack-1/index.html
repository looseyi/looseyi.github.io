<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog - Aha Edmond</title>

  
  
  <meta name="description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥" />
  <meta name="author" content="åœŸåœŸEdmondæœ¨" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-1/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog" />
<meta property="og:description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-04T18:20:00&#43;08:00" />
<meta property="article:modified_time" content="2020-05-04T18:20:00&#43;08:00" />


  
  <meta itemprop="name" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog">
<meta itemprop="description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥"><meta itemprop="datePublished" content="2020-05-04T18:20:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-05-04T18:20:00&#43;08:00" />
<meta itemprop="wordCount" content="8097">
<meta itemprop="keywords" content="Source Code,iOS,Logger," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog"/>
<meta name="twitter:description" content="ä»‹ç» CocoaLumberjack is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS. å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚ ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2020-05-04</time>
      
      <span>åœŸåœŸEdmondæœ¨</span>
      
    </p>
    <h1>æµ…æ - CocoaLumberjack 3.6 ä¹‹ DDLog</h1>
  </header>
  <section class="post-content"><h1 id="ä»‹ç»">ä»‹ç»</h1>
<blockquote>
<p><strong>CocoaLumberjack</strong> is a fast &amp; simple, yet powerful &amp; flexible logging framework for Mac and iOS.</p>
</blockquote>
<p>å…ˆæ‰¯ä¸€ä¸‹ lumberjack è¿™ä¸ªå•è¯ï¼Œå¯¹åº”çš„å°±æ˜¯å®ƒçš„ logoï¼Œä¸€ä½ä¼æœ¨å·¥ã€‚
ä¸€ç›´ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆæ˜¯ç”¨è¿™ä¸ªå•è¯ï¼Œå…¶ä»–è¯­éŸ³ä¸­ä¹Ÿæœ‰æ—¥å¿—åº“ç”¨çš„è¿™ä¸ªå•è¯ã€‚æœ€åè¿˜æ˜¯æ„Ÿè°¢ç½‘å‹æç¤ºï¼šlog æœ‰ä»£è¡¨æœ¨å¤´çš„æ„æ€ï¼Œæ‰€ä»¥ç”¨ lumberjack è¿˜æ˜¯éå¸¸è´´åˆ‡çš„ï¼ŒğŸ˜‚ã€‚</p>
<p>å†™è¿™ç¯‡æ–‡ç« æ˜¯æœ€è¿‘åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¶ç„¶å‘ç°ï¼Œå®ƒå±…ç„¶æœ‰è¿™ä¹ˆå¤šéšè—åŠŸèƒ½ï¼Œå°½ç®¡é¡¹ç›®é‡Œå¼•å…¥ä¹Ÿæœ‰å¥½å¤šå¹´äº†ã€‚æ¥ç€åˆçœ‹äº†ä¸€ä¸‹å®˜æ–¹æä¾›çš„ demosï¼Œ ç®€ç›´æ˜¯æƒŠå‘†äº†ï¼ˆPSï¼šä¹Ÿå¤ªä¸°å¯Œäº†å§ï¼‰ã€‚æ‰€ä»¥æœ¬æ–‡å¸Œæœ›ä»æºç æ¥ç€é‡æ¥ä»‹ç»å®ƒçš„ä¸€äº›è®¾è®¡å’Œ ğŸ¤” ã€‚æœ€åä¼šä»‹ç»ä¸€ä¸‹å®ƒæ‰€æ”¯æŒçš„æ‰©å±•ã€‚</p>
<h3 id="document">Document</h3>
<p>ä½œä¸ºå†å²æ‚ ä¹…çš„ libraryï¼Œå®ƒçš„ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/tree/master/Documentation">document</a> è¿˜æ˜¯éå¸¸è¯¦ç»†çš„ï¼Œä¸»è¦åˆ†ä¸‰ä¸ªçº§åˆ«ï¼š</p>
<ul>
<li>Beginner å…¥é—¨çº§ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/GettingStarted.md">ä½¿ç”¨è¯´æ˜</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomFormatters.md">è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/Performance.md">æ€§èƒ½æµ‹è¯•</a>ã€æ”¯æŒ<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/XcodeColors.md">å½©è‰²è¾“å‡º</a>ç­‰ï¼›</li>
<li>Intermediate è¿›é˜¶ï¼šlumberjack <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/Architecture.md">å†…éƒ¨æ¦‚è¿°</a>ï¼Œå¦‚ä½•å®šåˆ¶ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomContext.md">custom logging context</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLoggers.md">custrom logger</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLogLevels.md">custom log levels</a> ç­‰ï¼›</li>
<li>Advancedï¼šé«˜é˜¶ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/DynamicLogLevels.md">åŠ¨æ€ä¿®æ”¹ log levels</a>ã€<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/LogFileManagement.md">log æ–‡ä»¶ç®¡ç†ï¼ˆå‹ç¼©ã€ä¸Šä¼ </a>ã€‚</li>
</ul>
<h3 id="architecturehttpsgithubcomcocoalumberjackcocoalumberjackblobmasterdocumentationarchitecturemd"><a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/Architecture.md">Architecture</a></h3>
<p>ç…§ä¾‹ï¼Œæˆ‘ä»¬å…ˆé¢„è§ˆä¸€ä¸‹ç±»å›¾ï¼Œæœ‰ä¸ªå¤§æ¦‚çš„å°è±¡ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gdzck4x5v5j213v0iv41x.jpg" alt="CocoaLumberjackClassDiagram.png"></p>
<p>åœ¨æ¢³ç†å®Œè„‘å›¾æ‰å‘ç°å®˜æ–¹å…¶å®æä¾›äº†å®Œæ•´çš„ UML å›¾ã€‚ä¸è¿‡æ—¢ç„¶æ•´ç†äº†è„‘å›¾ï¼Œé‚£æˆ‘æŠŠå®ƒè´´åœ¨æ–‡æœ«ã€‚</p>
<p>UML ä¸Šç›´è§‚æ„Ÿå—å°±æ˜¯ class å¹¶ä¸å¤šï¼Œä½†æ˜¯åŠŸèƒ½ç¡®å®ååˆ†å®Œå–„ï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥çœ‹çœ‹ã€‚</p>
<h1 id="ddlog">DDLog</h1>
<p>æœ¬æ–‡é»˜è®¤ä½ æ˜¯ç»å†è¿‡æ–°æ‰‹æ‘çš„ï¼Œå¦‚æœå¯¹ Lumberjack çš„ API å®Œå…¨ä¸ç†Ÿæ‚‰ï¼Œè¯·æŒªæ­¥ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/GettingStarted.md">getting start</a>ã€‚</p>
<p>æ ¸å¿ƒæ–‡ä»¶ DDLog.h ä¸­æœ‰å£°æ˜äº†æœ€é‡è¦çš„ä¸¤ä¸ªåè®® <strong>DDLoger</strong> å’Œ <strong>DDLogFormatter</strong>ï¼Œè€Œ <strong>DDLog</strong> class å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª manager çš„å­˜åœ¨ï¼Œå®ƒç®¡ç†ç€æ‰€æœ‰æ³¨å†Œåœ¨æ¡ˆçš„ loogers å’Œ formattersã€‚è¿™ä¸‰ä¸ªå¯¹äºæ­£å¸¸é¡¹ç›®æ¥è¯´å·²ç»å®Œå…¨å¤Ÿç”¨äº†ã€‚æˆ‘ä»¬å°±ä» protocol ç€æ‰‹ï¼Œæœ€åæ¥è¯´è¿™ä¸ª DDLogã€‚</p>
<h2 id="loggers">Loggers</h2>
<blockquote>
<p>A logger is a class that does something with a log message. The lumberjack framework comes with several different loggers. (You can also <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLoggers.md">create your own</a>.) Loggers such as <code>DDOSLogger</code> can be used to duplicate the functionality of <code>NSLog</code>. And <code>DDFileLogger</code> can be used to write log messages to a log file.</p>
</blockquote>
<p>loggers ç›¸å…³ç±»ä¸»è¦æ˜¯å¯¹ log message è¿›è¡ŒåŠ å·¥å¤„ç†ã€‚é‚£ä¹ˆä¸€æ¡ DDLogMessage ä¼šå­˜æœ‰å“ªäº›å¯ç”¨ä¿¡æ¯å‘¢ï¼Ÿ</p>
<h3 id="ddlogmessage">DDLogMessage</h3>
<blockquote>
<p>Used by the logging primitives. (And the macros use the logging primitives.)</p>
</blockquote>
<p>log message ç”¨äºè®°å½•æ—¥å¿—åŸè¯­ï¼Œå®ƒæ˜¯é€šè¿‡å®æ¥å®ç°çš„ã€‚logging primitives æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¯ä»¥ç†è§£ä¸º log message ä¿å­˜äº† log è¢«è°ƒç”¨æ—¶çš„ä¸€ç³»åˆ—ç›¸å…³ç¯å¢ƒçš„ä¸Šä¸‹æ–‡ã€‚å•è¯ primitive ä¸€å¼€å§‹æ²¡çœ‹æ˜ç™½ï¼Œä¸è¿‡è®¡ç®—æœºä¸­å€’æ˜¯æœ‰ä¸€ä¸ª<a href="https://baike.baidu.com/item/%E5%8E%9F%E8%AF%AD">åŸè¯­</a>çš„æ¦‚å¿µï¼ˆä¸ä¸€å®šå¯¹ï¼‰ï¼Œå¯ä»¥å¸®åŠ©å¤§å®¶ç†è§£è¿™ä¸ªå•è¯ã€‚</p>
<p>å…·ä½“å­˜äº†å“ªäº›ä¸œè¥¿å‘¢ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">DDLogMessage</span> : <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">NSCopying</span><span class="o">&gt;</span>
<span class="p">{</span>
    <span class="c1">// Direct accessors to be used only for performance
</span><span class="c1"></span>    <span class="k">@public</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">_message</span><span class="p">;</span>
    <span class="n">DDLogLevel</span> <span class="n">_level</span><span class="p">;</span>
    <span class="n">DDLogFlag</span> <span class="n">_flag</span><span class="p">;</span>
    <span class="n">NSInteger</span> <span class="n">_context</span><span class="p">;</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">_file</span><span class="p">;</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">_fileName</span><span class="p">;</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">_function</span><span class="p">;</span>
    <span class="n">NSUInteger</span> <span class="n">_line</span><span class="p">;</span>
    <span class="kt">id</span> <span class="n">_tag</span><span class="p">;</span>
    <span class="n">DDLogMessageOptions</span> <span class="n">_options</span><span class="p">;</span>
    <span class="n">NSDate</span> <span class="o">*</span> <span class="n">_timestamp</span><span class="p">;</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">_threadID</span><span class="p">;</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">_threadName</span><span class="p">;</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">_queueLabel</span><span class="p">;</span>
    <span class="n">NSUInteger</span> <span class="n">_qos</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œé€šè¿‡å‰ç½®å£°æ˜å®ä¾‹å˜é‡ï¼Œè¿™æ ·è°ƒç”¨æ–¹å¯ä»¥é¿å¼€ getter ç›´æ¥è®¿é—®å˜é‡ï¼Œæ¥æé«˜è®¿é—®æ•ˆç‡ã€‚å½“ç„¶ä½œè€…ä¹Ÿæä¾›äº† readonly çš„ @property methodã€‚</p>
<p>é¦–å…ˆï¼Œmessageã€fileã€function <strong>é»˜è®¤ä¸ä¼šæ‰§è¡Œ copy æ“ä½œ</strong>ï¼Œå¦‚æœéœ€è¦å¯ä»¥é€šè¿‡ DDLogMessageOptions æ¥æ§åˆ¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">typedef</span> <span class="nf">NS_OPTIONS</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">,</span> <span class="n">DDLogMessageOptions</span><span class="p">){</span>
	 <span class="c1">/// Use this to use a copy of the file path
</span><span class="c1"></span>    <span class="n">DDLogMessageCopyFile</span>        <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
 	 <span class="c1">/// Use this to use a copy of the function name
</span><span class="c1"></span>    <span class="n">DDLogMessageCopyFunction</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="c1">/// Use this to use avoid a copy of the message
</span><span class="c1"></span>    <span class="n">DDLogMessageDontCopyMessage</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äº NSString çš„æ“ä½œéœ€è¦ä½¿ç”¨ copy ï¼Œä»¥ä¿è¯æˆ‘ä»¬å¯¹å®ƒæ“ä½œæ—¶æ˜¯å®‰å…¨åŠä¸å¯å˜çš„ã€‚è¿™é‡Œé’ˆå¯¹ messageã€fileã€function å´ä¸é‡‡ç”¨ copyï¼Œæ˜¯ä¸ºäº†é¿å…ä¸å¿…è¦çš„ allocations å¼€é”€ã€‚å› ä¸º file å’Œ function æ˜¯é€šè¿‡ __FILE__ and __FUNCTION__ è¿™ä¸¤ä¸ªå®æ¥è·å–çš„ï¼Œå®ƒä»¬æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦å¸¸é‡ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆæ“ä½œã€‚è€Œ message æ­£å¸¸ç”± DDlog å†…éƒ¨ç”Ÿæˆçš„ï¼ŒLumberjack æ¥ä¿è¯ mesage ä¸å¯ä¿®æ”¹ã€‚So å®˜æ–¹æç¤ºå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>If you find need to manually create logMessage objects, there is one thing you should be aware of.</p>
</blockquote>
<p>è¯´çš„å°±æ˜¯ï¼Œå½“ä½ éœ€è¦æ‰‹åŠ¨ç”Ÿæˆ log message çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œè¿™ä¸‰ä¸ªå‚æ•°çš„å†…å­˜ä¿®é¥°æ“ä½œã€‚</p>
<p>log message å†…éƒ¨å®ç°å°±æ¯”è¾ƒç®€å•äº†ï¼Œä»¥ message å­—æ®µä¸ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">BOOL</span> <span class="n">copyMessage</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">DDLogMessageDontCopyMessage</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">_message</span> <span class="o">=</span> <span class="n">copyMessage</span> <span class="o">?</span> <span class="p">[</span><span class="n">message</span> <span class="k">copy</span><span class="p">]</span> <span class="o">:</span> <span class="n">message</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦å¤–ï¼Œå°±æ˜¯æ¯ä¸ª logMessage ä¼šè®°å½•å½“å‰è°ƒç”¨çš„ thread &amp; queue ä¿¡æ¯ï¼Œåˆ†åˆ«å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">__uint64_t</span> <span class="n">tid</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pthread_threadid_np</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_threadID</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat</span><span class="p">:</span><span class="s">@&#34;%llu&#34;</span><span class="p">,</span> <span class="n">tid</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">_threadID</span> <span class="o">=</span> <span class="s">@&#34;missing threadId&#34;</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">_threadName</span>   <span class="o">=</span> <span class="n">NSThread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
<span class="c1">// Try to get the current queue&#39;s label
</span><span class="c1"></span><span class="n">_queueLabel</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat</span><span class="p">:</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">dispatch_queue_get_label</span><span class="p">(</span><span class="n">DISPATCH_CURRENT_QUEUE_LABEL</span><span class="p">)];</span>
<span class="k">if</span> <span class="p">(@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.10</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">8.0</span><span class="p">,</span> <span class="o">*</span><span class="p">))</span>
    <span class="n">_qos</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="n">qos_class_self</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="ddloglevel">DDLogLevel</h3>
<blockquote>
<p>Log levels are used to filter out logs. Used together with flags.</p>
</blockquote>
<p>æ¯ä¸€æ¡ log mesage éƒ½è®¾ç½®äº†å¯¹åº”çš„æ—¥å¿—çº§åˆ«ï¼Œç”¨äºè¿‡æ»¤ logs çš„ã€‚å…¶å®šä¹‰æ˜¯ä¸€ä¸ªæšä¸¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">typedef</span> <span class="nf">NS_ENUM</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">,</span> <span class="n">DDLogLevel</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// No logs
</span><span class="c1"></span>    <span class="n">DDLogLevelOff</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
    <span class="c1">// Error logs only
</span><span class="c1"></span>    <span class="n">DDLogLevelError</span>     <span class="o">=</span> <span class="p">(</span><span class="n">DDLogFlagError</span><span class="p">),</span> 
    <span class="c1">// Error and warning logs
</span><span class="c1"></span>    <span class="n">DDLogLevelWarning</span>   <span class="o">=</span> <span class="p">(</span><span class="n">DDLogLevelError</span>   <span class="o">|</span> <span class="n">DDLogFlagWarning</span><span class="p">),</span>
    <span class="c1">// Error, warning and info logs
</span><span class="c1"></span>    <span class="n">DDLogLevelInfo</span>      <span class="o">=</span> <span class="p">(</span><span class="n">DDLogLevelWarning</span> <span class="o">|</span> <span class="n">DDLogFlagInfo</span><span class="p">),</span> 
    <span class="c1">// Error, warning, info and debug logs
</span><span class="c1"></span>    <span class="n">DDLogLevelDebug</span>     <span class="o">=</span> <span class="p">(</span><span class="n">DDLogLevelInfo</span>    <span class="o">|</span> <span class="n">DDLogFlagDebug</span><span class="p">),</span> 
    <span class="c1">// Error, warning, info, debug and verbose logs
</span><span class="c1"></span>    <span class="n">DDLogLevelVerbose</span>   <span class="o">=</span> <span class="p">(</span><span class="n">DDLogLevelDebug</span>   <span class="o">|</span> <span class="n">DDLogFlagVerbose</span><span class="p">),</span> 
    <span class="c1">// All logs (1...11111)
</span><span class="c1"></span>    <span class="n">DDLogLevelAll</span>       <span class="o">=</span> <span class="n">NSUIntegerMax</span> 
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>è€Œ loglevel æ˜¯ç”± DDLogFlag æ§åˆ¶ï¼Œå…¶å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">typedef</span> <span class="nf">NS_OPTIONS</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">,</span> <span class="n">DDLogFlag</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 0...00001 DDLogFlagError
</span><span class="c1"></span>    <span class="n">DDLogFlagError</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
    <span class="c1">// 0...00010 DDLogFlagWarning
</span><span class="c1"></span>    <span class="n">DDLogFlagWarning</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
    <span class="c1">// 0...00100 DDLogFlagInfo
</span><span class="c1"></span>    <span class="n">DDLogFlagInfo</span>       <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
    <span class="c1">// 0...01000 DDLogFlagDebug
</span><span class="c1"></span>    <span class="n">DDLogFlagDebug</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
    <span class="c1">// 0...10000 DDLogFlagVerbose
</span><span class="c1"></span>    <span class="n">DDLogFlagVerbose</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™äº›å°±æ˜¯ DDLog æ‰€é¢„è®¾çš„ 5 ç§ levelï¼Œå¯¹äºæ–°æ‰‹æ¥è¯´åŸºæœ¬å¤Ÿç”¨äº†ã€‚åŒæ—¶ï¼Œå¯¹äºæœ‰è‡ªå®šä¹‰ level éœ€æ±‚çš„ç”¨æˆ·æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡ç»“æ„åŒ–çš„å®ï¼Œå°±èƒ½è½»æ¾å®ç°ã€‚è¯¦è§ <a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/CustomLogLevels.md">CustomLogLevels.md</a>ã€‚</p>
<p>å…¶æ ¸å¿ƒæ˜¯å…ˆå°†é¢„è®¾çš„ level æ¸…é™¤ï¼Œç„¶ååœ¨è¿›è¡Œé‡æ–°å®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">// First undefine the default stuff we don&#39;t want to use.
</span><span class="c1"></span><span class="cp">#undef DDLogError
</span><span class="cp">#undef DDLogWarn
</span><span class="cp">#undef DDLogInfo
</span><span class="cp">#undef DDLogDebug
</span><span class="cp">#undef DDLogVerbose
</span><span class="cp"></span><span class="p">...</span>
<span class="c1">// Now define everything how we want it
</span><span class="c1"></span><span class="cp">#define LOG_FLAG_FATAL   (1 &lt;&lt; 0)  </span><span class="c1">// 0...000001
</span><span class="c1"></span><span class="cp">#define LOG_LEVEL_FATAL   (LOG_FLAG_FATAL)  </span><span class="c1">// 0...000001
</span><span class="c1"></span><span class="cp">#define LOG_FATAL   (ddLogLevel &amp; LOG_FLAG_FATAL )
</span><span class="cp">#define DDLogFatal(frmt, ...)    SYNC_LOG_OBJC_MAYBE(ddLogLevel, LOG_FLAG_FATAL,  0, frmt, ##__VA_ARGS__)
</span><span class="cp"></span><span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><p>é™¤äº†å¯¹ level çš„é‡å®šä¹‰ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å¯¹ level è¿›è¡Œæ‰©å±•æ¥æ»¡è¶³æˆ‘ä»¬å¯¹éœ€æ±‚ã€‚ç”±äº lumberjack ä½¿ç”¨çš„æ˜¯ bitmask ä¸”åªé¢„è®¾äº† 5 ä¸ª bitï¼Œå¯¹åº” 5 ç§ log flagã€‚</p>
<p>è€Œ logLevel ä½œä¸º Int ç±»å‹ï¼Œæ„å‘³ç€å¯¹äº 32 ä½çš„ç³»ç»Ÿè€Œè¨€ï¼Œé¢„ç•™ç»™æˆ‘ä»¬çš„ levels è¿˜æœ‰ 28 bitsï¼Œå› ä¸ºé»˜è®¤çš„ level ä»…ä»…å ç”¨äº† 4 bitsã€‚æ‰©å±•ç©ºé—´å¯ä»¥è¯´æ˜¯ç»°ç»°æœ‰ä½™çš„ã€‚å®˜æ–¹æä¾›äº†ä¸¤ä¸ªéœ€è¦è¿›è¡Œæ‰©å±•çš„åœºæ™¯ï¼Œè¯¦è§ï¼š<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/blob/master/Documentation/FineGrainedLogging.md">FineGrainedLogging.md</a>ã€‚</p>
<h3 id="ddloger">DDLoger</h3>
<blockquote>
<p>This protocol describes a basic logger behavior.</p>
<ul>
<li>Basically, it can log messages, store a logFormatter plus a bunch of optional behaviors.</li>
<li>(i.e. flush, get its loggerQueue, get its name, &hellip;</li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">@protocol</span> <span class="nc">DDLogger</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">logMessage</span><span class="p">:(</span><span class="n">DDLogMessage</span> <span class="o">*</span><span class="p">)</span><span class="n">logMessage</span> <span class="n">NS_SWIFT_NAME</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="nl">message</span><span class="p">:));</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="n">nullable</span><span class="p">)</span> <span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogFormatter</span><span class="o">&gt;</span> <span class="n">logFormatter</span><span class="p">;</span>

<span class="k">@optional</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">didAddLogger</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didAddLoggerInQueue:</span><span class="p">(</span><span class="n">dispatch_queue_t</span><span class="p">)</span><span class="nv">queue</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">willRemoveLogger</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">flush</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_REFERENCE_TYPE</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">dispatch_queue_t</span> <span class="n">loggerQueue</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">copy</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">DDLoggerName</span> <span class="n">loggerName</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></td></tr></table>
</div>
</div><p>logMessage æ²¡å•¥å¥½è¯´çš„ï¼ŒlogFormatter ä¼šåœ¨åé¢ä»‹ç»ã€‚é‡ç‚¹çœ‹ä¸Šé¢çš„å‡ ä¸ª optional æ–¹æ³•å’Œå‚æ•°ã€‚</p>
<p><strong>loggerQueue</strong></p>
<p>å…ˆçœ‹ loggerQueueï¼Œç”±äºæ—¥å¿—æ‰“å°å‡ä¸ºå¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥ä¼šä¸ºæ¯ä¸ª looger åˆ†é…ä¸€ä¸ª dispatch_queue_tã€‚å¦‚æœ logger æœªæä¾› loggerQueueï¼Œé‚£ä¹ˆ DDLog ä¸ºæ ¹æ®ä½ æ‰€æŒ‡å®šçš„ loggerName ä¸»åŠ¨ä¸ºä½ ç”Ÿæˆã€‚</p>
<p><strong>didAddLogger</strong></p>
<p>åŒæ ·ç”±äºå¼‚æ­¥æ‰“å°æ—¥å¿—çš„åŸå› ï¼Œlooger è¢«æ·»åŠ åˆ° loogers ä¸­æ—¶ä¹Ÿæ˜¯å¼‚æ­¥çš„è¿‡ç¨‹ï¼ŒdidAddLogger æ–¹æ³•å°±æ˜¯ç”¨äºé€šçŸ¥  logger å·²è¢«æˆåŠŸæ·»åŠ ï¼Œè€Œè¿™ä¸ªæ“ä½œæ—¶åœ¨ loggerQueue ä¸­å®Œæˆçš„ã€‚</p>
<p>åŒæ ·ï¼Œ<code>didAddLoggerInQueue:</code> å’Œ <code>willRemoveLogger</code> ç›®çš„ä¹Ÿæ˜¯ç±»ä¼¼ã€‚</p>
<p><strong>flush</strong></p>
<p>ç”¨äºåˆ·æ–°å­˜åœ¨åœ¨é˜Ÿåˆ—ä¸­è¿˜æœªå¤„ç†çš„ log messageã€‚æ¯”å¦‚ï¼Œdatabase logger å¯èƒ½é€šè¿‡ I/O buffer æ¥å‡å°‘æ—¥å¿—å­˜å‚¨é¢‘ç‡ï¼Œæ¯•ç«Ÿç£ç›˜ I/O æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œlogger ä¸­å¯èƒ½ç•™æœ‰æœªè¢«åŠæ—¶å¤„ç†çš„ log messageã€‚</p>
<p>DDLog ä¼šé€šè¿‡ <code>flushLog</code> æ¥æ‰§è¡Œ flush ã€‚éœ€è¦âš ï¸çš„æ˜¯ï¼Œå½“åº”ç”¨é€€å‡ºçš„æ—¶å€™  <code>flushLog</code> ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚å½“ç„¶ï¼Œä½œä¸ºå¼€å‘è€…æˆ‘ä»¬å¯ä»¥åœ¨é€‚å½“çš„æƒ…å†µä¸‹æ‰‹åŠ¨è§¦å‘åˆ·æ–°ï¼Œæ­£å¸¸æ˜¯ä¸éœ€è¦æ‰‹åŠ¨è§¦å‘çš„ã€‚</p>
<h3 id="ddlogformatter">DDLogFormatter</h3>
<blockquote>
<p>Formatter allow you to format a log message before the logger logs it.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">@protocol</span> <span class="nc">DDLogFormatter</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>

<span class="k">@required</span>
<span class="o">-</span> <span class="p">(</span><span class="n">nullable</span> <span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nl">formatLogMessage</span><span class="p">:(</span><span class="n">DDLogMessage</span> <span class="o">*</span><span class="p">)</span><span class="n">logMessage</span> <span class="n">NS_SWIFT_NAME</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="nl">message</span><span class="p">:));</span>

<span class="k">@optional</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">didAddToLogger</span><span class="p">:(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="n">logger</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didAddToLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span> <span class="nf">inQueue:</span><span class="p">(</span><span class="n">dispatch_queue_t</span><span class="p">)</span><span class="nv">queue</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">willRemoveFromLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>formatLogMessage:</strong></p>
<p>formatter æ˜¯å¯ä»¥æ·»åŠ åˆ°ä»»ä½• logger ä¸Šçš„ï¼Œé€šè¿‡ <code>formatLogMessage:</code> æå¤§æé«˜äº† logging çš„è‡ªç”±åº¦ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>formatLogMessage:</code> ç»™ file logger å’Œ console è¿”å›ä¸åŒçš„ç»“æœã€‚ä¾‹å¦‚ console ä¸€èˆ¬ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨ log å‰æ·»åŠ æ—¶é—´æˆ³ï¼Œè€Œå½“æˆ‘ä»¬å†™å…¥ log file æ—¶å°±éœ€è¦è‡ªè¡Œæ¥æ·»åŠ æ—¶é—´ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è¿”å› nil å°†å…¶ä½œä¸º filter æ¥è¿‡æ»¤å¯¹åº”çš„ logã€‚</p>
<p><strong>didAddToLogger</strong></p>
<p>ä¸€ä¸ª formatter å¯ä»¥è¢«æ·»åŠ åˆ°å¤šä¸ª logger ä¸Šã€‚å½“ formatter è¢«æ·»åŠ æ—¶ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥é€šçŸ¥å®ƒã€‚è¯¥æ–¹æ³•æ˜¯éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨å¼‚å¸¸ã€‚</p>
<p>åŒç†ï¼Œ<code>didAddToLogger: inQueue</code> æ˜¯æŒ‡åœ¨æŒ‡å®šé˜Ÿåˆ—ä¸­è¿›è¡Œ format æ“ä½œã€‚</p>
<p><code>willRemoveFromLogger</code> åˆ™æ˜¯ formatter è¢«ç§»é™¤æ—¶çš„é€šçŸ¥ã€‚</p>
<h2 id="ddlog-1">DDLog</h2>
<blockquote>
<p>The main class, exposes all logging mechanisms, loggers, &hellip;</p>
<p>For most of the users, this class is hidden behind the logging functions like <code>DDLogInfo</code></p>
</blockquote>
<p>DDLog ä½œä¸º lumberjack çš„ç®¡ç†ç±»ï¼Œè´Ÿè´£å°†ç”¨æˆ·çš„ log ä¿¡æ¯æ”¶é›†åé›†ä¸­è°ƒåº¦è‡³ä¸åŒçš„ logger å·²è¾¾åˆ°ä¸åŒçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ console log å’Œ file logã€‚å› æ­¤ï¼Œä½œä¸ºå•ä¾‹æ˜¯å¿…é¡»çš„ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒåˆå§‹åŒ–éƒ½å‡†å¤‡äº†ä»€ä¹ˆä¸œè¥¿ã€‚</p>
<h3 id="initialize">Initialize</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">@interface</span> <span class="nc">DDLog</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">_loggers</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">DDLog</span>

<span class="k">static</span> <span class="n">dispatch_queue_t</span> <span class="n">_loggingQueue</span><span class="p">;</span>
<span class="k">static</span> <span class="n">dispatch_group_t</span> <span class="n">_loggingGroup</span><span class="p">;</span>
<span class="k">static</span> <span class="n">dispatch_semaphore_t</span> <span class="n">_queueSemaphore</span><span class="p">;</span>
<span class="k">static</span> <span class="n">NSUInteger</span> <span class="n">_numProcessors</span><span class="p">;</span>
<span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢å‡ ä¸ªå‡ä¸ºç§æœ‰å˜é‡ï¼Œ_loggers è‡ªä¸å¿…è¯´ï¼Œä»»ä½• logger çš„æ·»åŠ /åˆ é™¤éƒ½éœ€è¦åœ¨ loggingQueue/loggingThread ä¸­è¿›è¡Œçš„ã€‚</p>
<p><strong>_loggingQueue</strong></p>
<p>å…¨å±€çš„ log queue ç”¨äºä¿è¯ FIFO çš„æ“ä½œé¡ºåºï¼Œæ‰€æœ‰ logger ä¼šé€šè¿‡å®ƒæ¥é¡ºåºæ‰§è¡Œå„ logger çš„ <code>logMessage:</code> ã€‚</p>
<p><strong>_loggingGroup</strong></p>
<p>ç”±äºæ¯ä¸ª logger æ·»åŠ æ—¶å€™éƒ½é…ç½®äº†å¯¹åº”çš„ log queueã€‚å› æ­¤ï¼Œloggers ä¹‹é—´çš„è®°å½•è¡Œä¸ºæ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚è€Œ dispatch group å¯ä»¥åŒæ­¥æ‰€æœ‰ loggers çš„æ“ä½œï¼Œç¡®ä¿è®°å½•è¡Œä¸ºé¡ºåˆ©å®Œæˆã€‚</p>
<p><strong>_queueSemaphore</strong></p>
<p>é˜²æ­¢æ‰€ä½¿ç”¨çš„é˜Ÿåˆ—è¿‡çˆ†ã€‚ç”±äºå¤§å¤šæ•°è®°å½•éƒ½æ˜¯å¼‚æ­¥æ“ä½œï¼Œå› æ­¤ï¼Œå¯èƒ½é­åˆ°æ¶æ„çº¿ç¨‹å¤§é‡çš„å¢åŠ  log å½±å“æ­£å¸¸çš„è®°å½•è¡Œä¸ºã€‚æœ€å¤§é™åˆ¶æ•°ä¸º DDLOG_MAX_QUEUE_SIZE (1000)ï¼Œä¹Ÿå°±æ˜¯è¯´å½“é˜Ÿåˆ—æ•°è¶…è¿‡é™åˆ¶ï¼Œåˆ™ä¼šä¸»åŠ¨é˜»å¡çº¿ç¨‹ï¼Œä»¥å¾…æ‰§è¡Œé˜Ÿåˆ—é™è‡³å®‰å…¨æ°´å¹³ã€‚</p>
<p>ä¾‹å¦‚ï¼šåœ¨å¤§å‹å¾ªç¯ä¸­éšæ„æ·»åŠ æ—¥å¿—è¯­å¥æ—¶ä¼šå‘ç”Ÿè¿‡ğŸ’¥ã€‚</p>
<p><strong>_numProcessors</strong></p>
<p>è®°å½•å¤„ç†å™¨å†…æ ¸æ•°é‡ï¼Œä»¥é’ˆå¯¹å•æ ¸æƒ…å†µæ—¶è¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ã€‚</p>
<p>ä½œä¸ºé™æ€å˜é‡ï¼Œå…¶åˆå§‹åŒ–åˆ™æ”¾åœ¨ <code>initialize</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initialize</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">DDLogOnceToken</span><span class="p">;</span>

    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DDLogOnceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSLogDebug</span><span class="p">(</span><span class="s">@&#34;DDLog: Using grand central dispatch&#34;</span><span class="p">);</span>

        <span class="n">_loggingQueue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&#34;cocoa.lumberjack&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">_loggingGroup</span> <span class="o">=</span> <span class="n">dispatch_group_create</span><span class="p">();</span>

        <span class="kt">void</span> <span class="o">*</span><span class="n">nonNullValue</span> <span class="o">=</span> <span class="n">GlobalLoggingQueueIdentityKey</span><span class="p">;</span> <span class="c1">// Whatever, just not null
</span><span class="c1"></span>        <span class="n">dispatch_queue_set_specific</span><span class="p">(</span><span class="n">_loggingQueue</span><span class="p">,</span> <span class="n">GlobalLoggingQueueIdentityKey</span><span class="p">,</span> <span class="n">nonNullValue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="n">_queueSemaphore</span> <span class="o">=</span> <span class="n">dispatch_semaphore_create</span><span class="p">(</span><span class="n">DDLOG_MAX_QUEUE_SIZE</span><span class="p">);</span>

        <span class="c1">// Figure out how many processors are available.
</span><span class="c1"></span>        <span class="c1">// This may be used later for an optimization on uniprocessor machines.
</span><span class="c1"></span>
        <span class="n">_numProcessors</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">([</span><span class="n">NSProcessInfo</span> <span class="n">processInfo</span><span class="p">].</span><span class="n">processorCount</span><span class="p">,</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span> <span class="mi">1</span><span class="p">);</span>

        <span class="n">NSLogDebug</span><span class="p">(</span><span class="s">@&#34;DDLog: numProcessors = %@&#34;</span><span class="p">,</span> <span class="l">@(</span><span class="n">_numProcessors</span><span class="l">)</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œé€šè¿‡ <code>dispatch_queue_set_specific</code> ä¸º _loggingQueue æ·»åŠ äº† keyï¼š<strong>GlobalLoggingQueueIdentityKey</strong> ä½œä¸ºæ ‡è®°ã€‚ä¹‹åä¼šåœ¨æ‰€æœ‰çš„å†…éƒ¨æ–¹æ³•æ‰§è¡Œå‰é€šè¿‡ <code>dispatch_get_specific</code> è·å– flag æ¥è¿›è¡Œæ–­è¨€ï¼Œç¡®ä¿å†…éƒ¨æ–¹æ³•éƒ½æ˜¯åœ¨å…¨å±€çš„ _loggingQueue ä¸­è°ƒåº¦çš„ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ DDLog å®ä¾‹çš„åˆå§‹åŒ–ï¼Œä»…åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>_loggers åˆå§‹åŒ–ï¼›</li>
<li>å°è¯•æ³¨å†Œé€šçŸ¥ï¼Œç¡®ä¿ APP è¿›ç¨‹ç»“æŸå‰èƒ½å¤ŸåŠæ—¶å°† Logger ä¸­çš„ message å¤„ç†å®Œæ¯•ï¼›</li>
</ul>
<p>ç”±äº lumberjack æ”¯æŒå…¨å¹³å°ä»¥åŠå‘½ä»¤è¡Œï¼Œè¿™é‡Œçš„ notificationName åˆ¤æ–­æ¡ä»¶ç›¸å¯¹å¤šä¸€äº›ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="cp">#if TARGET_OS_IOS
</span><span class="cp"></span>    <span class="n">NSString</span> <span class="o">*</span><span class="n">notificationName</span> <span class="o">=</span> <span class="n">UIApplicationWillTerminateNotification</span><span class="p">;</span>
<span class="cp">#else
</span><span class="cp"></span>    <span class="n">NSString</span> <span class="o">*</span><span class="n">notificationName</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="c1">// On Command Line Tool apps AppKit may not be available
</span><span class="c1"></span><span class="cp">#if !defined(DD_CLI) &amp;&amp; __has_include(&lt;AppKit/NSApplication.h&gt;)
</span><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">NSApp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">notificationName</span> <span class="o">=</span> <span class="n">NSApplicationWillTerminateNotification</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">notificationName</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If there is no NSApp -&gt; we are running Command Line Tool app.
</span><span class="c1"></span>        <span class="c1">// In this case terminate notification wouldn&#39;t be fired, so we use workaround.
</span><span class="c1"></span>        <span class="k">__weak</span> <span class="n">__auto_type</span> <span class="n">weakSelf</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
        <span class="n">atexit_b</span> <span class="p">(</span><span class="o">^</span><span class="p">{</span>
            <span class="p">[</span><span class="n">weakSelf</span> <span class="nl">applicationWillTerminate</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* if TARGET_OS_IOS */</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p>ç¨å¾®æä¸€ç‚¹ï¼Œå‘½ä»¤è¡Œä¸­æ˜¯å¦‚ä½•æ¥ç›‘å¬ç¨‹åºé€€å‡ºï¼Ÿè¿™é‡Œç”¨åˆ°äº† <code>atexit</code></p>
<blockquote>
<p>The atexit() function registers the given function to be called at program exit, whether via exit(3) or via return from the program&rsquo;s main().  Functions so registered are called in reverse order; no arguments are passed.</p>
</blockquote>
<p>å°±æ˜¯è¯´ï¼Œç¨‹åºåœ¨é€€å‡ºæ—¶ï¼Œç³»ç»Ÿä¼šä¸»åŠ¨è°ƒç”¨é€šè¿‡ atexit æ³¨å†Œçš„ callbacksï¼Œå¯ä»¥æ³¨å†Œå¤šä¸ªå›è°ƒï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚</p>
<p>DDLog åœ¨æ”¶åˆ°é€šçŸ¥åä¼šè§¦å‘ <code>flush</code>ï¼Œè¿™ä¸ªæˆ‘ä»¬æ™šä¸€ç‚¹å±•å¼€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">if</span> <span class="p">(</span><span class="n">notificationName</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">addObserver</span><span class="p">:</span><span class="nb">self</span>
                                             <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">applicationWillTerminate</span><span class="p">:)</span>
                                                 <span class="nl">name</span><span class="p">:</span><span class="n">notificationName</span>
                                               <span class="nl">object</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">applicationWillTerminate</span><span class="p">:(</span><span class="n">NSNotification</span> <span class="o">*</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">)))</span><span class="n">notification</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">flushLog</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="logger-management">Logger Management</h3>
<p>å¯¹ logger çš„æ“ä½œä¸»è¦æ˜¯æ·»åŠ å’Œåˆ é™¤ã€‚</p>
<p><strong>AddLogger</strong></p>
<p>DDLog æä¾›äº†å¤šä¸ªæ·»åŠ  logger çš„ convince æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span><span class="p">;</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span> <span class="nf">withLevel:</span><span class="p">(</span><span class="n">DDLogLevel</span><span class="p">)</span><span class="nv">level</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span> <span class="nf">withLevel:</span><span class="p">(</span><span class="n">DDLogLevel</span><span class="p">)</span><span class="nv">level</span><span class="err">ï¼›</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">addLogger</span><span class="p">:(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="n">logger</span> <span class="nl">withLevel</span><span class="p">:(</span><span class="n">DDLogLevel</span><span class="p">)</span><span class="n">level</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logger</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">_loggingQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">lt_addLogger</span><span class="p">:</span><span class="n">logger</span> <span class="nl">level</span><span class="p">:</span><span class="n">level</span><span class="p">];</span>
    <span class="p">}</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨æ”¾å…¥ _loggingQueue åï¼Œæœ€ç»ˆèµ°åˆ°äº† <code>lt_addLogger: level:</code> æ–¹æ³•ã€‚è¿™é‡Œçš„å‰ç¼€ <code>lt</code> æ˜¯ lgging thread çš„ç¼©å†™ã€‚åœ¨ logger æ·»åŠ å‰ä¼šæ£€æŸ¥å»é‡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">for</span> <span class="p">(</span><span class="n">DDLoggerNode</span> <span class="o">*</span><span class="n">node</span> <span class="k">in</span> <span class="nb">self</span><span class="p">.</span><span class="n">_loggers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">_logger</span> <span class="o">==</span> <span class="n">logger</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">_level</span> <span class="o">==</span> <span class="n">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Exactly same logger already added, exit
</span><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>DDLoggerNode</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">DDLoggerNode</span> : <span class="nc">NSObject</span>
<span class="p">{</span>
    <span class="c1">// Direct accessors to be used only for performance
</span><span class="c1"></span>    <span class="k">@public</span>
    <span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span> <span class="n">_logger</span><span class="p">;</span>
    <span class="n">DDLogLevel</span> <span class="n">_level</span><span class="p">;</span>
    <span class="n">dispatch_queue_t</span> <span class="n">_loggerQueue</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">nodeWithLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span>
                   <span class="nf">loggerQueue:</span><span class="p">(</span><span class="n">dispatch_queue_t</span><span class="p">)</span><span class="nv">loggerQueue</span>
                         <span class="nf">level:</span><span class="p">(</span><span class="n">DDLogLevel</span><span class="p">)</span><span class="nv">level</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>ç§æœ‰ç±»ï¼Œç”¨äºå…³è” loggerã€level å’Œ loggerQueueã€‚</p>
<p>ç¨å¾®æä¸€ä¸‹ï¼Œåœ¨ DDLoggerNode çš„åˆå§‹åŒ–æ–¹æ³•ä¸­çš„ï¼Œå…¼å®¹äº† MRC çš„ä½¿ç”¨ã€‚å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªå® <code>OS_OBJECT_USE_OBJC</code> æ¥åŒºåˆ† GCD æ˜¯å¦æ”¯æŒ ARCã€‚åœ¨6.0 ä¹‹å‰ GCD ä¸­çš„å¯¹è±¡æ˜¯ä¸æ”¯æŒ ARCï¼Œå› æ­¤åœ¨ 6.0 ä¹‹å‰ <code>OS_OBJECT_USE_OBJC</code> æ˜¯æ²¡æœ‰çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">if</span> <span class="p">(</span><span class="n">loggerQueue</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_loggerQueue</span> <span class="o">=</span> <span class="n">loggerQueue</span><span class="p">;</span>
    <span class="cp">#if !OS_OBJECT_USE_OBJC
</span><span class="cp"></span>    <span class="n">dispatch_retain</span><span class="p">(</span><span class="n">loggerQueue</span><span class="p">);</span>
    <span class="cp">#endif
</span><span class="cp"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¥ç€å°±æ˜¯å‰é¢æ‰€æåˆ°çš„ QueueIdentity çš„æ–­è¨€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">NSAssert</span><span class="p">(</span><span class="n">dispatch_get_specific</span><span class="p">(</span><span class="n">GlobalLoggingQueueIdentityKey</span><span class="p">),</span>
         <span class="s">@&#34;This method should only be run on the logging thread/queue&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡ loggerQueueï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">dispatch_queue_t</span> <span class="n">loggerQueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">if</span> <span class="p">([</span><span class="n">logger</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">loggerQueue</span><span class="p">)])</span> <span class="p">{</span>
    <span class="n">loggerQueue</span> <span class="o">=</span> <span class="n">logger</span><span class="p">.</span><span class="n">loggerQueue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">loggerQueue</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loggerQueueName</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">logger</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">loggerName</span><span class="p">)])</span> <span class="p">{</span>
        <span class="n">loggerQueueName</span> <span class="o">=</span> <span class="n">logger</span><span class="p">.</span><span class="n">loggerName</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">loggerQueue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="n">loggerQueueName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç ï¼Œæœ‰æ²¡æœ‰ä¼¼æ›¾ç›¸è¯†çš„å¹²ï¼Ÿè¿™æ˜¯åœ¨ <code>DDLogger Protocol</code> å£°æ˜æ—¶æåˆ°çš„é€»è¾‘ã€‚å¦‚æœ logger æä¾›äº† loggerQueue åˆ™ç›´æ¥ä½¿ç”¨ã€‚å¦åˆ™ï¼Œé€šè¿‡ loggerName æ¥åˆ›å»ºã€‚</p>
<p>æœ€åå°±æ˜¯åˆ›å»º DDLoggerNodeï¼Œæ·»åŠ  loggerï¼Œå‘é€ <code>didAddLogger</code> é€šçŸ¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">DDLoggerNode</span> <span class="o">*</span><span class="n">loggerNode</span> <span class="o">=</span> <span class="p">[</span><span class="n">DDLoggerNode</span> <span class="nl">nodeWithLogger</span><span class="p">:</span><span class="n">logger</span> <span class="nl">loggerQueue</span><span class="p">:</span><span class="n">loggerQueue</span> <span class="nl">level</span><span class="p">:</span><span class="n">level</span><span class="p">];</span>
<span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">_loggers</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">loggerNode</span><span class="p">];</span>

<span class="k">if</span> <span class="p">([</span><span class="n">logger</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">didAddLoggerInQueue</span><span class="p">:)])</span> <span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">logger</span> <span class="nl">didAddLoggerInQueue</span><span class="p">:</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">];</span>
    <span class="p">}</span> <span class="p">});</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="n">logger</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">didAddLogger</span><span class="p">)])</span> <span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">logger</span> <span class="n">didAddLogger</span><span class="p">];</span>
    <span class="p">}</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>RemoveLogger</strong></p>
<p>åŒ addLogger ç±»ä¼¼ï¼ŒremoveLogger ä¹Ÿæä¾›äº†å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•ã€‚ç±»æ–¹æ³•é€šè¿‡ sharedInstance æœ€ç»ˆæ”¶å£åˆ°å®ä¾‹æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeLogger:</span><span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">logger</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">logger</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">_loggingQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">lt_removeLogger</span><span class="p">:</span><span class="n">logger</span><span class="p">];</span>
    <span class="p">}</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>-[DDLog lt_removeLogger:]</strong></p>
<p>åˆ é™¤å‰ï¼Œç…§ä¾‹æ˜¯ loggingQueue æ£€æŸ¥ï¼Œç„¶åéå†è·å– loggerNodeï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">DDLoggerNode</span> <span class="o">*</span><span class="n">loggerNode</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">DDLoggerNode</span> <span class="o">*</span><span class="n">node</span> <span class="k">in</span> <span class="nb">self</span><span class="p">.</span><span class="n">_loggers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">_logger</span> <span class="o">==</span> <span class="n">logger</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">loggerNode</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœ loggerNode ä¸å­˜åœ¨ï¼Œåˆ™æå‰ç»“æŸã€‚å­˜åœ¨ï¼Œåˆ™ä¼šå…ˆå‘ loggerNode å‘é€ <code>willRemoveLogger</code> é€šçŸ¥ï¼Œå†ç§»é™¤ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">if</span> <span class="p">([</span><span class="n">logger</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">willRemoveLogger</span><span class="p">)])</span> <span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">logger</span> <span class="n">willRemoveLogger</span><span class="p">];</span>
    <span class="p">}</span> <span class="p">});</span>
<span class="p">}</span>
<span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">_loggers</span> <span class="nl">removeObject</span><span class="p">:</span><span class="n">loggerNode</span><span class="p">];</span>
</code></pre></td></tr></table>
</div>
</div><p>DDLog è¿˜æä¾›äº† removeAllLoggers çš„æ–¹æ³•ï¼Œä»¥ä¸€æ¬¡æ€§æ¸…é›¶ loggersï¼Œå®ç°åŒ <code>lt_removeLogger:</code> ç±»ä¼¼ï¼Œè¿™é‡Œä¸å±•å¼€äº†ã€‚</p>
<h3 id="logging">Logging</h3>
<p>logging ç›¸å…³æ–¹æ³•æ˜¯ DDLog çš„æ ¸å¿ƒï¼Œæä¾›ä¸‰ç§ç±»å‹çš„å®ä¾‹æ–¹æ³•ï¼Œä»¥åŠåˆ†åˆ«å¯¹åº”çš„ç±»æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹ç¬¬ä¸€ä¸ªï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">log:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">asynchronous</span>
      <span class="nf">level:</span><span class="p">(</span><span class="n">DDLogLevel</span><span class="p">)</span><span class="nv">level</span>
       <span class="nf">flag:</span><span class="p">(</span><span class="n">DDLogFlag</span><span class="p">)</span><span class="nv">flag</span>
    <span class="nf">context:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">context</span>
       <span class="nf">file:</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nv">file</span>
   <span class="nf">function:</span><span class="p">(</span><span class="n">nullable</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nv">function</span>
       <span class="nf">line:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nv">line</span>
        <span class="nf">tag:</span><span class="p">(</span><span class="n">nullable</span> <span class="kt">id</span><span class="p">)</span><span class="nv">tag</span>
     <span class="nf">format:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">format</span><span class="p">,</span> <span class="p">...</span> <span class="n">NS_FORMAT_FUNCTION</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ç†Ÿæ‚‰å§ï¼Œè¿™äº›å‚æ•°å‰é¢éƒ½ä»‹ç»è¿‡äº†ï¼Œæ˜¯æ„é€  log message æ‰€éœ€çš„å…³å‚æ•°ã€‚æœ€åä¸€ä¸ª C å†™æ³•çš„å¯å˜å‚æ•° <code>...</code> ç”¨äºç”Ÿæˆ log message stringï¼ŒåŒæ · DDLog ä¹Ÿæä¾›äº†å®ƒçš„å˜ç§ <code>args:(va_list)argList</code> ï¼Œè¿™å°±æ˜¯ç¬¬äºŒç§ log æ–¹æ³•ã€‚æœ€åä¸€ç§åˆ™æ˜¯ç”±ç”¨æˆ·ç›´æ¥æä¾› logMessageã€‚</p>
<p>å¯¹äº <code>...</code> çš„å¯å˜å‚æ•°çš„è·å–ï¼Œæ˜¯é€šè¿‡ c æä¾›çš„å®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFormat</span><span class="p">:</span><span class="n">format</span> <span class="nl">arguments</span><span class="p">:</span><span class="n">args</span><span class="p">];</span>
<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>-[DDLog queueLogMessage: asynchronously:]</strong></p>
<p>å‡†å¤‡å¥½ log message åˆ™å¼€å§‹åˆ†å‘ï¼Œè¿›è¡Œå¼‚æ­¥è°ƒç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">queueLogMessage:</span><span class="p">(</span><span class="n">DDLogMessage</span> <span class="o">*</span><span class="p">)</span><span class="nv">logMessage</span> <span class="nf">asynchronously:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">asyncFlag</span> <span class="p">{</span>
   <span class="n">dispatch_block_t</span> <span class="n">logBlock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">dispatch_semaphore_wait</span><span class="p">(</span><span class="n">_queueSemaphore</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
        <span class="k">@autoreleasepool</span> <span class="p">{</span>
            <span class="p">[</span><span class="nb">self</span> <span class="nl">lt_log</span><span class="p">:</span><span class="n">logMessage</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">asyncFlag</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">_loggingQueue</span><span class="p">,</span> <span class="n">logBlock</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dispatch_get_specific</span><span class="p">(</span><span class="n">GlobalLoggingQueueIdentityKey</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">logBlock</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">dispatch_sync</span><span class="p">(</span><span class="n">_loggingQueue</span><span class="p">,</span> <span class="n">logBlock</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å…ˆå¿½ç•¥ logBlockï¼Œçœ‹ DDLog å¦‚æœå¤„ç† loggingQueue è°ƒåº¦ï¼Œä»¥åŠå¦‚ä½•æ¥é¿å…çº¿ç¨‹æ­»é”é—®é¢˜ã€‚è¿™é‡Œçš„è§£å†³æ–¹å¼ç»å¯¹éœ€è¦<strong>åˆ’é‡ç‚¹</strong>ã€‚å¤§å®¶ç»å¸¸é‡åˆ°çš„ä¸»çº¿ç¨‹æ­»é”ï¼Œå¾ˆå¸¸è§çš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;1&#34;</span><span class="p">);</span>
    <span class="n">dispatch_sync</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;2&#34;</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;3&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªä¹Ÿæ˜¯é¢è¯•ä¼šè¢«å¸¸å¸¸é—®åˆ°çš„ caseã€‚æ ¸å¿ƒç‚¹åœ¨äºï¼Œä¸Šè¿°ä»£ç åœ¨ main thread æ‰§è¡Œäº† dispatch_sync å¼€å¯äº† main queue çš„åŒæ­¥ç­‰å¾…ã€‚è§£å†³æ–¹æ¡ˆå°±æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ SDWebImage ä¸­å°±æä¾›äº† <a href="https://looseyi.github.io/post/sourcecode-ios/source-code-sdweb-1/">dispatch_main_async_safe</a> æ¥é¿å…è¯¥é—®é¢˜ã€‚</p>
<p>å›åˆ° DDLogï¼Œç°åœ¨å¤§å®¶å¯ä»¥æ˜ç™½åœ¨ dispatch_sync å‰ä¸ºä½•éœ€è¦å¤šä¸€æ­¥ queue identity çš„åˆ¤æ–­äº†å§ã€‚å¦å¤–ï¼Œå…³äºè¿™ä¸ªé—®é¢˜ï¼Œ<a href="https://github.com/CocoaLumberjack/CocoaLumberjack/issues/812#issuecomment-298853313">github issuse #812</a> ä¸­æœ‰æ¯”è¾ƒè¯¦ç»†çš„è®ºè¿°ã€‚</p>
<p>æ¥ç€çœ‹ logBlockï¼Œå®ƒåœ¨æ‰§è¡Œç¬¬ä¸€è¡Œä»£ç æ—¶ï¼Œå°±å¼€å¯äº† semaphore_wait ç›´åˆ°å¯ç”¨é˜Ÿåˆ—æ•°å°äº maximumQueueSizeã€‚é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ç»™ queueSize åŠ é”çš„æ–¹å¼æ¥ç¡®ä¿å¯ç”¨é˜Ÿåˆ—æ•°çš„å‡†ç¡®æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚ä½†æ˜¯è¿™é‡Œä½œè€…å¸Œæœ›ï¼Œèƒ½å¤Ÿæ›´å¿«é€Ÿçš„æ¥è·å–æ·»åŠ  log mesage å…¥é˜Ÿåˆ—çš„æ—¶æœºï¼Œæ¯•ç«Ÿé”çš„å¼€é”€æ¯”è¾ƒå¤§ã€‚</p>
<p>è¿™ç§å®è·µåœ¨å¾ˆå¤šä¼˜ç§€å¼€æºåº“ä¸­éƒ½ç”¨åˆ°äº†ï¼Œæ¯”å¦‚ SDWebImageã€‚</p>
<p><strong>- [DDLog lt_log:]</strong></p>
<p>è¯¥æ–¹æ³•æ˜¯å°† log message åˆ†é…åˆ°æ‰€ä»¥æ»¡è¶³çš„ logger æ‰‹ä¸­ã€‚å¼€å§‹å‰ç…§ä¾‹è¿›è¡Œ QueueIdentity çš„æ–­è¨€ã€‚æ¥ç€ä¾æ® CPU å†…æ ¸æ•°æ˜¯å•æ ¸æˆ–è€…å¤šæ ¸åŒºåˆ«å¯¹å¾…ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">if</span> <span class="p">(</span><span class="n">_numProcessors</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="p">...</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>å¤šæ ¸å¤„ç†å™¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">for</span> <span class="p">(</span><span class="n">DDLoggerNode</span> <span class="o">*</span><span class="n">loggerNode</span> <span class="k">in</span> <span class="nb">self</span><span class="p">.</span><span class="n">_loggers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">logMessage</span><span class="o">-&gt;</span><span class="n">_flag</span> <span class="o">&amp;</span> <span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_level</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">_loggingGroup</span><span class="p">,</span> <span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_logger</span> <span class="nl">logMessage</span><span class="p">:</span><span class="n">logMessage</span><span class="p">];</span>
    <span class="p">}</span> <span class="p">});</span>
<span class="p">}</span>
<span class="n">dispatch_group_wait</span><span class="p">(</span><span class="n">_loggingGroup</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¨å¾®æä¸€ä¸‹ DDLog çš„è®¾è®¡æ€è·¯ï¼Œç”±äºä¸€æ¡ log message å¯èƒ½ä¼šæä¾›ç»™å¤šä¸ªä¸åŒç±»å‹çš„ logger å¤„ç†ã€‚ä¾‹å¦‚ï¼Œä¸€æ¡ log å¯èƒ½åŒæ—¶éœ€è¦è¾“å‡ºåˆ°ç»ˆç«¯ã€å†™å…¥åˆ° log file ä¸­ã€é€šè¿‡ websocket è¾“å‡ºåˆ°æµè§ˆå™¨æ–¹ä¾¿æµ‹è¯•ç­‰æ“ä½œã€‚</p>
<p>é¦–å…ˆï¼Œé€šè¿‡ logMessage-&gt;_flag è¿‡æ»¤æ‰ level ä¸åŒ¹é…çš„ loggerNodeã€‚ç„¶åä»åŒ¹é…åˆ°çš„ loggerNode ä¸­å–å‡º loggerQueue å’Œ logger è°ƒç”¨ <code>logMessage:</code> ã€‚</p>
<p>é‡ç‚¹æ¥äº†ï¼Œè¿™é‡Œåˆ©ç”¨ _loggingGroup å°†æœ¬æ¬¡çš„ <code>logMessage:</code> å…³è”åˆ° group ä¸­ï¼Œæ‰“åŒ…æˆä¸€ä¸ª &ldquo;äº‹åŠ¡&rdquo;ï¼Œä»¥ä¿è¯æ¯æ¬¡çš„ <code>lt_log:</code> éƒ½æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚è€Œæ¯ä¸ª logger æœ¬èº«éƒ½åˆ†é…äº†ç‹¬ç«‹çš„ loggerQueueï¼Œé€šè¿‡è¿™ç§ç»„åˆï¼Œå³ä¿è¯äº† logger çš„å¹¶å‘è°ƒç”¨ï¼Œåˆèƒ½æ»¡è¶³ queueSize çš„é™åˆ¶ã€‚</p>
<p>ä½¿ç”¨ dispatch_group_wait è¿˜æœ‰ä¸€ä¸ªç›®çš„ï¼Œå°±æ˜¯ç¡®ä¿é‚£äº›æ‰§è¡Œæ•ˆæœæ…¢çš„ logger ä¹Ÿèƒ½æŒ‰é¡ºåºå®Œæˆè°ƒç”¨ï¼Œé¿å…é˜Ÿåˆ—ä»»åŠ¡è¿‡å¤šæ—¶ï¼Œè¿™äº› logger æ²¡èƒ½åŠæ—¶å®Œæˆå¯¼è‡´å¤§é‡çš„ padding log message æ²¡æœ‰è¢«åŠæ—¶å¤„ç†ã€‚</p>
<ol start="2">
<li>å¯¹å•æ ¸å¤„ç†å°±æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯ç¬¬äºŒæ­¥ä¸åŒã€‚ä¸å­˜åœ¨ gropu æ“ä½œï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">dispatch_sync</span><span class="p">(</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_logger</span> <span class="nl">logMessage</span><span class="p">:</span><span class="n">logMessage</span><span class="p">];</span>
<span class="p">}</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>æœ€åï¼Œåˆ†é…å®Œ logger message åï¼Œéœ€è¦å°† _queueSemaphore åŠ  1:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">dispatch_semaphore_signal</span><span class="p">(</span><span class="n">_queueSemaphore</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>lt_flush</strong></p>
<p>DDLog çš„æœ€åä¸€ä¸ªæ–¹æ³•ï¼Œä¼šåœ¨ç¨‹åºç»“æŸå‰ç”±é€šçŸ¥æ¥è§¦å‘æ‰§è¡Œï¼Œå…¶å®ç°åŒ <code>lt_log:</code> ç±»ä¼¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">lt_flush</span> <span class="p">{</span>
    <span class="n">NSAssert</span><span class="p">(</span><span class="n">dispatch_get_specific</span><span class="p">(</span><span class="n">GlobalLoggingQueueIdentityKey</span><span class="p">),</span>
             <span class="s">@&#34;This method should only be run on the logging thread/queue&#34;</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">DDLoggerNode</span> <span class="o">*</span><span class="n">loggerNode</span> <span class="k">in</span> <span class="nb">self</span><span class="p">.</span><span class="n">_loggers</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_logger</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">flush</span><span class="p">)])</span> <span class="p">{</span>
            <span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">_loggingGroup</span><span class="p">,</span> <span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">loggerNode</span><span class="o">-&gt;</span><span class="n">_logger</span> <span class="n">flush</span><span class="p">];</span>
            <span class="p">}</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dispatch_group_wait</span><span class="p">(</span><span class="n">_loggingGroup</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="å°ç»“">å°ç»“</h3>
<p>DDLog åå‰¯å…¶å®çš„ managerï¼Œåˆ©ç”¨äº†ä¿¡å·é‡å’Œ group é«˜æ•ˆçš„å®Œæˆå¯¹ message çš„è°ƒåº¦ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å·¥ä½œï¼š</p>
<ol>
<li>ç®¡ç† logger çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶å¯¹å…¶æ·»åŠ ã€åˆ é™¤æ“ä½œè¿›è¡Œç›¸åº”é€šçŸ¥ï¼›</li>
<li>ç”Ÿæˆ logMessage å¹¶åœ¨çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œå°†å…¶åˆ†é…åˆ°å¯¹åº”çš„ logger ä»¥åŠ å·¥ messageã€‚</li>
<li>åœ¨ç¨‹åºç»“æŸåï¼ŒåŠæ—¶é€šçŸ¥ logger æ¸…ç† pending çŠ¶æ€çš„ messageã€‚</li>
</ol>
<h1 id="loggers-1">Loggers</h1>
<p>ç°åœ¨æˆ‘ä»¬æ¥èŠèŠ loggerã€‚DDLog ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª logger åŸºç±» DDAbstractLogger ä»¥åŠå‡ ä¸ªé»˜è®¤å®ç°ã€‚ä¸€ä¸€æ¥è¿‡ä¸€ä¸‹ï¼›</p>
<h2 id="ddabstractlogger">DDAbstractLogger</h2>
<p>AbstractLogger å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">@interface</span> <span class="nc">DDAbstractLogger</span> : <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">DDLogger</span><span class="o">&gt;</span>
<span class="p">{</span>
    <span class="k">@public</span>
    <span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogFormatter</span><span class="o">&gt;</span> <span class="n">_logFormatter</span><span class="p">;</span>
    <span class="n">dispatch_queue_t</span> <span class="n">_loggerQueue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="n">nullable</span><span class="p">)</span> <span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogFormatter</span><span class="o">&gt;</span> <span class="n">logFormatter</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_REFERENCE_TYPE</span><span class="p">)</span> <span class="n">dispatch_queue_t</span> <span class="n">loggerQueue</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">,</span> <span class="k">getter</span><span class="o">=</span><span class="n">isOnGlobalLoggingQueue</span><span class="p">)</span>  <span class="kt">BOOL</span> <span class="n">onGlobalLoggingQueue</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">,</span> <span class="k">getter</span><span class="o">=</span><span class="n">isOnInternalLoggerQueue</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">onInternalLoggerQueue</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></td></tr></table>
</div>
</div><p>å…ˆçœ‹åˆå§‹åŒ–æ–¹æ³• <code>init</code> ï¼š</p>
<h3 id="init">Init</h3>
<p>AdstractLogger é»˜è®¤æä¾›äº† loggerQueue ä»¥åŠå½“å‰æ˜¯å¦ä¸º loggerQueue å’Œ å…¨å±€ loggingQueue çš„ convene æ–¹æ³•ã€‚loggerQueue çš„åˆå§‹åŒ–æ˜¯åœ¨ <code>init</code> ä¸­å®Œæˆçš„ï¼Œæ•´ä¸ª <code>init</code> ä¹Ÿå°±åšäº†è¿™ä¸€ä»¶äº‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loggerQueueName</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">loggerName</span><span class="p">)])</span> <span class="p">{</span>
    <span class="n">loggerQueueName</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">loggerName</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">_loggerQueue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="n">loggerQueueName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nb">self</span><span class="p">;</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">nonNullValue</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nb">self</span><span class="p">;</span>
<span class="n">dispatch_queue_set_specific</span><span class="p">(</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">nonNullValue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>åŒæ ·å…ˆè·å– queueNameï¼Œè¿™é‡Œé»˜è®¤è¿”å›çš„ <code>loggerName</code> æ˜¯ <code>NSStringFromClass([self class]);</code> ã€‚</p>
<p>åŒæ—¶ï¼Œä»¥ self çš„åœ°å€ä½œä¸º flag å…³è”åˆ° loggerQueueï¼Œå¹¶ç”¨äºåˆ¤æ–­ <code>onInternalLoggerQueue</code> ã€‚</p>
<h3 id="logformatter">LogFormatter</h3>
<p>AdstractLogger æœ€ä¸»è¦çš„æ˜¯å®ç°äº† logFormatter çš„ getter/setter æ–¹æ³•ã€‚åŒæ—¶ä»£ç ä¸­èµ‹äºˆäº†ååˆ†è¯¦ç»†çš„è¯´æ˜ï¼Œå…ˆçœ‹çœ‹ getter å®ç°ã€‚</p>
<p><strong>Getter</strong></p>
<p>é¦–å…ˆæ˜¯çº¿ç¨‹ç›¸å…³çš„æ–­è¨€ï¼Œç¡®ä¿å½“å‰ä¸åœ¨ global queue å’Œ loggerQueueï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">NSAssert</span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isOnGlobalLoggingQueue</span><span class="p">],</span> <span class="s">@&#34;Core architecture requirement failure&#34;</span><span class="p">);</span>
<span class="n">NSAssert</span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isOnInternalLoggerQueue</span><span class="p">],</span> <span class="s">@&#34;MUST access ivar directly, NOT via self.* syntax.&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¥ç€åœ¨ loggingQueue å’Œ loggerQueue ä¸­è·å– logFormatterï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">dispatch_queue_t</span> <span class="n">globalLoggingQueue</span> <span class="o">=</span> <span class="p">[</span><span class="n">DDLog</span> <span class="n">loggingQueue</span><span class="p">];</span>

<span class="k">__block</span> <span class="kt">id</span> <span class="o">&lt;</span><span class="n">DDLogFormatter</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>

<span class="n">dispatch_sync</span><span class="p">(</span><span class="n">globalLoggingQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">dispatch_sync</span><span class="p">(</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>çœ‹å»ä¸€ä¸ªæ™®é€šçš„ formatter ä¸ºä½•éœ€è¦å¦‚æ­¤å¤§åŠ¨å¹²æˆˆï¼Œéœ€è¦å±‚å±‚æ·±å…¥æ¥å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">DDLogVerbose</span><span class="p">(</span><span class="s">@&#34;log msg 1&#34;</span><span class="p">);</span>
<span class="n">DDLogVerbose</span><span class="p">(</span><span class="s">@&#34;log msg 2&#34;</span><span class="p">);</span>
<span class="p">[</span><span class="n">logger</span> <span class="nl">setFormatter</span><span class="p">:</span><span class="n">myFormatter</span><span class="p">];</span>
<span class="n">DDLogVerbose</span><span class="p">(</span><span class="s">@&#34;log msg 3&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»ç›´è§‰ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ç»“æœæ˜¯æ–°è®¾ç½®çš„ formatter ä»…åº”ç”¨åœ¨ç¬¬ 3 æ¡ log message ä¸Šã€‚ç„¶è€Œ DDLog åœ¨æ•´ä¸ª logging è¿‡ç¨‹ä¸­å´éƒ½æ˜¯å¼‚æ­¥è°ƒç”¨çš„ã€‚</p>
<ol>
<li>log message æœ€ç»ˆæ˜¯åœ¨å•ç‹¬çš„ loggerQueue ä¸­æ‰§è¡Œçš„ï¼Œæ˜¯ç”± logger å„è‡ªæŒæœ‰çš„ queueï¼›</li>
<li>åœ¨è¿›å…¥æ¯ä¸ª loggerQueue ä¹‹å‰ï¼Œåˆè¦ç»è¿‡ä¸€é“å…¨å±€çš„ loggingQueueã€‚</li>
</ol>
<p>Soï¼Œæƒ³è¦çº¿ç¨‹å®‰å…¨åˆè¦ç¬¦åˆç›´è§‰çš„è¯ï¼Œåªèƒ½éµå¾ª log message çš„è„šæ­¥ï¼Œèµ°ä¸€éç›¸å…³ queueã€‚</p>
<p>éœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œloggeråœ¨å†…éƒ¨<strong>æœ€å¥½ç›´æ¥è®¿é—® FORMATTER VARIABLE</strong> ï¼Œå¦‚æœéœ€è¦çš„è¯ã€‚ä¸€æ—¦ä½¿ç”¨ <code>self.</code>  å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹æ­»é”ã€‚</p>
<p><strong>Setter</strong></p>
<p>åŒ getter ä¸€è‡´ï¼Œå…ˆæ–­è¨€ï¼Œç„¶åä¾æ¬¡è¿›å…¥é˜Ÿåˆ— <code>DDLog.loggingQueue -&gt; self-&gt;_loggerQueue</code> æ‰§è¡Œ block å¼€å§‹çœŸæ­£çš„èµ‹å€¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">@autoreleasepool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="o">!=</span> <span class="n">logFormatter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">willRemoveFromLogger</span><span class="p">:)])</span> <span class="p">{</span>
            <span class="p">[</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="nl">willRemoveFromLogger</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="o">=</span> <span class="n">logFormatter</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">didAddToLogger</span><span class="p">:</span><span class="nl">inQueue</span><span class="p">:)])</span> <span class="p">{</span>
            <span class="p">[</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="nl">didAddToLogger</span><span class="p">:</span><span class="nb">self</span> <span class="nl">inQueue</span><span class="p">:</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_loggerQueue</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">didAddToLogger</span><span class="p">:)])</span> <span class="p">{</span>
            <span class="p">[</span><span class="nb">self</span><span class="o">-&gt;</span><span class="n">_logFormatter</span> <span class="nl">didAddToLogger</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ddasllogger">DDASLLogger</h2>
<p>ASLLogger æ˜¯å¯¹ <strong>Apple System Log</strong> API çš„å°è£…ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ <code>NSLog</code> ä¼šå°†å…¶è¾“å‡ºå®šå‘åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š</p>
<ul>
<li><a href="https://support.apple.com/zh-cn/guide/console/cnsl1012/mac">Apple System Log</a></li>
<li><a href="https://www.wikiwand.com/en/Standard_streams">Standard error</a> ï¼ˆtelemetryï¼‰</li>
</ul>
<p>ä¸è¿‡ ASLLogger åœ¨ macosx 10.12 iOS 10.0 å·²ç»è¢«åºŸå¼ƒäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ DDOSLogerã€‚ASLLogger èƒŒåä½¿ç”¨çš„ API æ˜¯ <a href="https://opensource.apple.com/source/Libc/Libc-583/include/asl.h.auto.html"><strong>&lt;asl.h&gt;</strong></a> ï¼Œå®ƒä¹Ÿæä¾›äº†å‡ ç§ message level</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="cm">/*! @defineblock Log Message Priority Levels Log levels of the message. */</span>
<span class="cp">#define ASL_LEVEL_EMERG   0
</span><span class="cp">#define ASL_LEVEL_ALERT   1
</span><span class="cp">#define ASL_LEVEL_CRIT    2 </span><span class="c1">// DDLogFlagError
</span><span class="c1"></span><span class="cp">#define ASL_LEVEL_ERR     3 </span><span class="c1">// DDLogFlagWarning
</span><span class="c1"></span><span class="cp">#define ASL_LEVEL_WARNING 4 </span><span class="c1">// DDLogFlagInfo, Regular NSLog&#39;s level
</span><span class="c1"></span><span class="cp">#define ASL_LEVEL_NOTICE  5 </span><span class="c1">// default
</span><span class="c1"></span><span class="cp">#define ASL_LEVEL_INFO    6
</span><span class="cp">#define ASL_LEVEL_DEBUG   7
</span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤æƒ…å†µä¸‹ ASL ä¼šè¿‡æ»¤ NOTICE ä¹‹ä¸Šçš„ä¿¡æ¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½• DDLog åŸºæœ¬ä¹Ÿå°±è®¾ç½®äº† 5 ç§æ—¥å¿—çº§åˆ«ã€‚</p>
<h3 id="logmessage">logMessage</h3>
<p>logMessage æ˜¯æ¯ä¸ª logger å¤„ç† log message çš„æ–¹æ³•ã€‚ASLLogger é¦–å…ˆä¼šè¿‡æ»¤ filename ä¸º <code>DDASLLogCapture</code> (ä¸»åŠ¨ç›‘å¬çš„ç³»ç»Ÿ log)ã€‚ç„¶åå¯¹ message è¿›è¡Œ formateï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">NSString</span> <span class="o">*</span> <span class="n">message</span> <span class="o">=</span> <span class="n">_logFormatter</span> <span class="o">?</span> <span class="p">[</span><span class="n">_logFormatter</span> <span class="nl">formatLogMessage</span><span class="p">:</span><span class="n">logMessage</span><span class="p">]</span> <span class="o">:</span> <span class="n">logMessage</span><span class="o">-&gt;</span><span class="n">_message</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœ message å­˜åœ¨ï¼Œç”Ÿæˆ <code>aslmsg</code>  é€šè¿‡ <code>asl_send</code> å‘é€è‡³ ASLã€‚å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span> <span class="n">UTF8String</span><span class="p">];</span>
<span class="n">size_t</span> <span class="n">aslLogLevel</span><span class="p">;</span> <span class="c1">// logMessage-&gt;_flag è·å– ASL_LEVEL_XXX
</span><span class="c1"></span>
<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="k">const</span> <span class="n">level_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;0&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="s">&#34;2&#34;</span><span class="p">,</span> <span class="s">&#34;3&#34;</span><span class="p">,</span> <span class="s">&#34;4&#34;</span><span class="p">,</span> <span class="s">&#34;5&#34;</span><span class="p">,</span> <span class="s">&#34;6&#34;</span><span class="p">,</span> <span class="s">&#34;7&#34;</span> <span class="p">};</span>

<span class="n">uid_t</span> <span class="k">const</span> <span class="n">readUID</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span> <span class="c1">/// the effective user ID of the calling process
</span><span class="c1"></span>
<span class="kt">char</span> <span class="n">readUIDString</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">/// formatted output conversion
</span><span class="c1"></span><span class="cp">#ifndef NS_BLOCK_ASSERTIONS
</span><span class="cp"></span><span class="n">size_t</span> <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="n">snprintf</span><span class="p">(</span><span class="n">readUIDString</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">readUIDString</span><span class="p">),</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="n">readUID</span><span class="p">);</span>
<span class="cp">#else
</span><span class="cp"></span><span class="n">snprintf</span><span class="p">(</span><span class="n">readUIDString</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">readUIDString</span><span class="p">),</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="n">readUID</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="cp"></span>
<span class="n">NSAssert</span><span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">readUIDString</span><span class="p">),</span> <span class="s">@&#34;Formatted euid is too long.&#34;</span><span class="p">);</span>
<span class="n">NSAssert</span><span class="p">(</span><span class="n">aslLogLevel</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">level_strings</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">level_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="s">@&#34;Unhandled ASL log level.&#34;</span><span class="p">);</span>

<span class="n">aslmsg</span> <span class="n">m</span> <span class="o">=</span> <span class="n">asl_new</span><span class="p">(</span><span class="n">ASL_TYPE_MSG</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">asl_set</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ASL_KEY_LEVEL</span><span class="p">,</span> <span class="n">level_strings</span><span class="p">[</span><span class="n">aslLogLevel</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="n">asl_set</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ASL_KEY_MSG</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="n">asl_set</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ASL_KEY_READ_UID</span><span class="p">,</span> <span class="n">readUIDString</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="n">asl_set</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">kDDASLKeyDDLog</span><span class="p">,</span> <span class="n">kDDASLDDLogValue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">asl_send</span><span class="p">(</span><span class="n">_client</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">asl_free</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ddoslogger">DDOSLogger</h2>
<p>è‹¹æœçš„æ–°ä¸€ä»£ logging system <a href="https://developer.apple.com/documentation/os/logging">os_log</a>ï¼Œå®˜æ–¹æä¾›äº†æ¯”è¾ƒå®Œæ•´çš„æ¦‚è¿°å’Œè¯´æ˜ã€‚æ­£æ˜¯å®ƒå–ä»£äº† ASLï¼Œmanual å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>The unified logging system provides a single, efficient, high performance set of APIs for capturing log messages across all levels of the system.  This unified system centralizes the storage of log data in memory and in a data store on disk.</p>
</blockquote>
<p>å®ƒæä¾›äº†æ—¥å¿—è®°å½•çš„ä¸­å¿ƒåŒ–å­˜å‚¨ã€‚åŒæ—¶ API ä¹Ÿååˆ†ç®€æ´ï¼Œå…³äº os_log æœ‰æœºä¼šåœ¨å±•å¼€ã€‚</p>
<h3 id="init-1">Init</h3>
<p>é¦–å…ˆï¼ŒOSLogger éœ€è¦æŒæœ‰ä¸€ä¸ª log objectï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">os_log_t</span> <span class="nf">os_log_create</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subsystem</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">category</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>subsystem</strong></p>
<blockquote>
<p>An identifier string, in reverse DNS notation, that represents the subsystem thatâ€™s performing logging, for example, <code>com.your_company.your_subsystem_name</code>. The subsystem is used for categorization and filtering of related log messages, as well as for grouping related logging settings.</p>
</blockquote>
<p><strong>category</strong></p>
<blockquote>
<p>A category within the specified subsystem. The system uses the category to categorize and filter related log messages, as well as to group related logging settings within the subsystemâ€™s settings. A categoryâ€™s logging settings override those of the parent subsystem.</p>
</blockquote>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œos_log çš„å®˜æ–¹æ–‡æ¡£æ˜¯åªæä¾›äº† Swift è¯´æ˜ï¼ŒOSLog.Category <a href="https://developer.apple.com/documentation/os/oslog/category">è¯¦ç»†ç‚¹æ­¤</a>ã€‚</p>
<h3 id="logmessage-1">LogMessage</h3>
<p>åŒæ ·æ˜¯è¿‡æ»¤ filename ä¸º <code>DDASLLogCapture</code> çš„ log message å’Œå¯¹ log message çš„ formatterã€‚os_log æ‰€æä¾›çš„ API åˆ™ååˆ†å‹å¥½ç®€æ´ï¼Œæ¯ç§ <a href="https://developer.apple.com/documentation/kernel/os_log_type_t?language=objc">os_log_type_t</a> éƒ½æä¾›äº†å¯¹åº”çš„æ–¹æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="n">__auto_type</span> <span class="n">logger</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">logger</span><span class="p">];</span>
<span class="k">switch</span> <span class="p">(</span><span class="n">logMessage</span><span class="o">-&gt;</span><span class="n">_flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">DDLogFlagError</span>  <span class="p">:</span>
        <span class="n">os_log_error</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s">&#34;%{public}s&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">DDLogFlagWarning</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">DDLogFlagInfo</span>   <span class="p">:</span>
        <span class="n">os_log_info</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s">&#34;%{public}s&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">DDLogFlagDebug</span>  <span class="p">:</span>
    <span class="k">case</span> <span class="nl">DDLogFlagVerbose</span><span class="p">:</span>
    <span class="k">default</span>              <span class="o">:</span>
        <span class="n">os_log_debug</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s">&#34;%{public}s&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ddttylogger">DDTTYLogger</h2>
<blockquote>
<p>This class provides a logger for Terminal output or Xcode console output, depending on where you are running your code.</p>
</blockquote>
<p>é€šè¿‡å®ƒå°†æ—¥å¿—å®šå‘åˆ°ç»ˆç«¯å’Œ Xcode ç»ˆç«¯ï¼ŒåŒæ—¶æ”¯æŒå½©è‰²ã€‚Xcode æ”¯æŒéœ€è¦æ·»åŠ  <a href="https://github.com/robbiehanson/XcodeColors">XcodeColors æ’ä»¶</a>ã€‚TTYLogger å†…éƒ¨çš„ä»£ç æœ‰ä¸Šåƒè¡Œã€‚ä¸è¿‡æ‰€åšçš„äº‹æƒ…æ¯”è¾ƒç®€å•ã€‚æ ¹æ®ä¸åŒç»ˆç«¯ç±»å‹æ‰€æ”¯æŒçš„é¢œè‰²èŒƒå›´æ¥å°†è®¾ç½®çš„é¢œè‰²è¿›è¡Œé€‚é…ï¼Œæœ€ç»ˆè¾“å‡ºå‡ºæ¥ã€‚</p>
<p>å…³äºé¢œè‰²èŒƒå›´ä¸»è¦æœ‰ä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li>standard shellï¼šä»…æ”¯æŒ 16 ç§é¢œè‰²</li>
<li>Terminal.appï¼šå¯ä»¥æ”¯æŒåˆ° 256 ç§é¢œè‰²</li>
<li>xterm colors</li>
</ul>
<p>å…·ä½“è§ <a href="http://en.wikipedia.org/wiki/ANSI_escape_code">ANSI_escape_code</a>ã€‚</p>
<h3 id="logmessage-2">LogMessage</h3>
<p>TTYLogger æ”¯æŒä¸ºæ¯ä¸€ç§ logFlag é…ç½®ä¸åŒçš„é¢œè‰²ï¼Œç„¶åå°† color ä¸ flag å°è£…è¿› <code>DDTTYLoggerColorProfile</code> ç±»ä¸­ï¼Œå­˜å‚¨åœ¨ <code>_colorProfilesDict</code> ä¸­ã€‚logMessage ä¸»è¦åˆ†ä¸‰æ­¥ï¼š</p>
<ol>
<li>é€šè¿‡ <code>logMessage-&gt;_tag</code> å–å‡º colorProfileï¼›</li>
<li>å°† log message è½¬ä¸º c stringï¼›</li>
<li>å°† color å†™å…¥ <code>iovec v[iovec_len]</code>ï¼Œæœ€ç»ˆè°ƒç”¨ <code>writev(STDERR_FILENO, v, iovec_len);</code> è¾“å‡ºã€‚</li>
</ol>
<h2 id="æœªå®Œå¾…ç»­">æœªå®Œå¾…ç»­</h2>
<p>ä»¥ä¸Šä¸‰ç§ logger å±äºåŸºæœ¬çš„ç»ˆç«¯è¾“å‡ºï¼Œå¯ç”¨äºæ›¿ä»£ NSLogã€‚é™äºç¯‡å¹…çš„åŸå› ï¼Œè¿˜æœ‰ <code>DDFileLogger</code>ã€<code>DDAbstractDatabaseLogger</code> ä»¥åŠå„ç§æ‰©å±•ï¼Œå¦‚ <code>WebSocketLogger</code> ç­‰ï¼Œæœªåœ¨æœ¬ç¯‡å‡ºç°ã€‚åŒæ—¶è¿˜æœ‰ä¸€æ•´èŠ‚çš„ <code>Formatters</code> å‡æ”¾ä¸‹ä¸€ç¯‡ä¸­ã€‚</p>
<p>æœ¬ç¯‡ï¼Œé€šè¿‡ DDLog ç±»å¯¹ GCD çš„ä½¿ç”¨ï¼Œçœ‹åˆ°äº† lumberjack çš„ä½œè€…å……åˆ†åˆ©ç”¨äº† GCD çš„ç‰¹æ€§æ¥è¾¾åˆ°å®‰å…¨é«˜æ•ˆçš„å¼‚æ­¥ loggingã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­å¹¶æœªä½¿ç”¨é”æ¥è§£å†³çº¿ç¨‹å®‰å…¨ï¼Œç®—æ˜¯å¯¹ GCD çš„å¾ˆå¥½å®è·µäº†ã€‚è¯¥ä½œè€…è¿˜å‡ºå“äº† <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a> ã€<a href="https://github.com/robbiehanson/XMPPFramework">XMPPFramework</a>ã€<a href="https://github.com/robbiehanson/CocoaHTTPServer">CocoaHTTPServer</a> ç­‰çŸ¥åçš„åº“ã€‚ä¹‹åå¯ä»¥æ…¢æ…¢ç»†å“ã€‚</p>
<p>æœ€åï¼Œè´´ä¸€å¼ æ•´ç†çš„è„‘å›¾ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸å–œå‹¿å–·ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gdzcfyok9ij21ee12agqs.jpg" alt="CocoaLumberjack.png"></p>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/source-code">Source Code</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/logger">Logger</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/sourcecode-ios/source-code-lumberjack-2/"><span>â†</span><span>æµ…æ - CocoaLumberjack 3.6 ä¹‹ FileLogger</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-ios/source-code-sdweb-en1/"><span>The Architecture of SDWebImage v5.6</span><span>â†’</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugoï¸ï¸</a>ï¸</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
