<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>3. CocoaPods 命令解析 - CLAide - Aha Edmond</title>

  
  
  <meta name="description" content="引子 在上文 整体把握 CocoaPods 核心组件 中，我们通过对 pod install 的流程的介绍，引出 CocoaPods 的各个核心组件的角色分工和其主要作用，希望通过对这些组件的使用和介绍来帮助" />
  <meta name="author" content="土土Edmond木" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-cocoapods/03-cocoapods-claide/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="3. CocoaPods 命令解析 - CLAide" />
<meta property="og:description" content="引子 在上文 整体把握 CocoaPods 核心组件 中，我们通过对 pod install 的流程的介绍，引出 CocoaPods 的各个核心组件的角色分工和其主要作用，希望通过对这些组件的使用和介绍来帮助" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-cocoapods/03-cocoapods-claide/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-09-02T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-09-02T00:00:00&#43;00:00" />


  
  <meta itemprop="name" content="3. CocoaPods 命令解析 - CLAide">
<meta itemprop="description" content="引子 在上文 整体把握 CocoaPods 核心组件 中，我们通过对 pod install 的流程的介绍，引出 CocoaPods 的各个核心组件的角色分工和其主要作用，希望通过对这些组件的使用和介绍来帮助"><meta itemprop="datePublished" content="2020-09-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-09-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6069">
<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="3. CocoaPods 命令解析 - CLAide"/>
<meta name="twitter:description" content="引子 在上文 整体把握 CocoaPods 核心组件 中，我们通过对 pod install 的流程的介绍，引出 CocoaPods 的各个核心组件的角色分工和其主要作用，希望通过对这些组件的使用和介绍来帮助"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2020-09-02</time>
      
      <span>土土Edmond木</span>
      
    </p>
    <h1>3. CocoaPods 命令解析 - CLAide</h1>
  </header>
  <section class="post-content"><h1 id="引子">引子</h1>
<p>在上文 <a href="https://juejin.im/post/6861792671489327111">整体把握 CocoaPods 核心组件</a> 中，我们通过对 <code>pod install</code> 的流程的介绍，引出 CocoaPods 的各个核心组件的角色分工和其主要作用，希望通过对这些组件的使用和介绍来帮助大家更好的了解 CocoaPods 的完整工作流以及背后的原理。
今天我们主要聊一聊为 CocoaPods 提供的命令行解析的工具 <code>CLAide</code>，它是如何来解析 pod 命令以及 CocoaPods 的插件机制。</p>
<h1 id="open-class">Open Class</h1>
<p>开始之前，我们需要了解一个 Ruby 的语言特性：<a href="http://rubylearning.com/satishtalim/ruby_open_classes.html">Open Classes</a>
在 Ruby 中，类永远是开放的，你总是可以将新的方法加入到已有的类中，除了在你自己的代码中，还可以用在标准库和内置类中，这个特性被称为 <code>Open Classes</code>。说到这里作为 iOS 工程师，脑中基本能闪现出 Objective-C 的 <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/Category.html"><strong>Category</strong></a> 或者 Swift 的 <a href="https://docs.swift.org/swift-book/LanguageGuide/Extensions.html"><strong>Extensions</strong></a> 特性。不过，这种动态替换方法的功能也称作 Monkeypatch。(🐒  到底招谁惹谁了）
下面，我们通过在 <code>Monkey.rb</code> 文件中添加一个自定义类 <code>Monkey</code> 来简单看一下该特性，</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">Monkey</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">eat</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#34;i have banana&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>monkey <span style="color:#719e07">=</span> <span style="color:#cb4b16">Monkey</span><span style="color:#719e07">.</span>new
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">class</span> <span style="color:#268bd2">Monkey</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">eat</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#34;I have apple&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>monkey<span style="color:#719e07">.</span>eat
</code></pre></div><p>直接在 VSCode 中运行，效果如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">[</span>Running<span style="color:#719e07">]</span> ruby <span style="color:#2aa198">&#34;/Users/edmond/Desktop/Monkey.rb&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>I have apple
</code></pre></div><p>可以看到，<code>Monkey</code> 类的实例输出已经改为 <code>I have apple</code>。</p>
<blockquote>
<p>需要注意，即使是已经创建好的实例，方法替换同样是生效的。
另外 ⚠️ <code>Open Class</code> 可以跨文件、跨模块进行访问的，甚至对 Ruby 内置方法的也同样适用 (谨慎)。</p>
</blockquote>
<p>这强大的功能让我们可以很容易的对三方模块进行扩展，这也是 CocoaPods 的插件体系所依赖的基础。
举个例子，在 <em>CocoaPods</em> 主仓库 <code>cocoapods/downloader.rb</code> 中定义了一些 download 方法：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">module</span> Downloader
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">end</span>
</code></pre></div><p>但是在 <em><a href="https://github.com/CocoaPods/cocoapods-downloader">cocoapods-downloader</a></em> 模块中，module <code>Downloader</code> 的方法并不能满足全部需求，于是在 <code>cocoapods-downloader/api.rbapi.rb</code> 中就对其进行了扩展：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">module</span> Downloader
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">module</span> API
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">execute_command</span>(executable, command, raise_on_failure <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>        <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>      <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">end</span>
</code></pre></div><h1 id="claide">CLAide</h1>
<p><a href="https://github.com/CocoaPods/CLAide">CLAide</a> 虽然是一个简单的命令行解释器，但它提供了功能齐全的命令行界面和 API。它不仅负责解析我们使用到的 <code>Pods</code> 命令，例如：<code>pod install</code>, <code>pod update</code> 等，还可用于封装常用的一些脚本，将其打包成简单的命令行小工具。</p>
<blockquote>
<p>备注：所谓命令行解释器就是从标准输入或者文件中读取命令并执行的程序。详见 <a href="https://www.wikiwand.com/en/Command-line_argument_parsing">Wiki</a>。</p>
</blockquote>
<h2 id="claide-功能概览">CLAide 功能概览</h2>
<p>我们先通过 <code>pod --help</code> 来查看 <code>CLAide</code> 的真实输出效果：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>$ pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#2aa198">Usage</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  $ pod <span style="color:#cb4b16">COMMAND</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#cb4b16">CocoaPods</span>, the <span style="color:#cb4b16">Cocoa</span> library package manager<span style="color:#719e07">.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#2aa198">Commands</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">+</span> cache               <span style="color:#cb4b16">Manipulate</span> the <span style="color:#cb4b16">CocoaPods</span> cache
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#719e07">+</span> deintegrate         <span style="color:#cb4b16">Deintegrate</span> <span style="color:#cb4b16">CocoaPods</span> from your project
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#719e07">+</span> env                 <span style="color:#cb4b16">Display</span> pod environment
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#719e07">+</span> init                <span style="color:#cb4b16">Generate</span> a <span style="color:#cb4b16">Podfile</span> <span style="color:#719e07">for</span> the current directory
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#2aa198">Options</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#719e07">--</span>allow<span style="color:#719e07">-</span>root          <span style="color:#cb4b16">Allows</span> <span style="color:#cb4b16">CocoaPods</span> to run as root
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">--</span>silent              <span style="color:#cb4b16">Show</span> nothing
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  <span style="color:#719e07">--</span>version             <span style="color:#cb4b16">Show</span> the version of the tool
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#719e07">...</span>
</code></pre></div><p>👆所展示的 <code>Usage</code>、<code>Commands</code>、<code>Options</code> section 及其内容均是由 <code>CALide</code> 的输出模版 <strong>Banner</strong> 来完成的。<code>CALide</code> 提供了 Command 基类帮助我们快速定义出标准且美观的命令。除了 <code>pod</code> 命令之外，例如：<a href="https://github.com/CocoaPods/Xcodeproj">Xcodeproj</a> 所提供的命令也是由 <code>CALide</code> 来实现的。
<code>CALide</code> 还提供了一套插件加载机制在命令执行前获取所有插件中的命令，例如：<code>cocoapods-packeger</code> 提供的 <code>pod package NAME [SOURCE]</code> 就是从其 source code 中的 <code>lib/pod/commnad/package.rb</code> 读取出来的，它令我们仅需一份 <code>podspec</code> 信息，即可完成 Cocoa 依赖库的 📦。</p>
<h2 id="calide-的目录结构">CALide 的目录结构</h2>
<blockquote>
<p>对于 Ruby 的项目结构，在 Rubygems.org 中有 <a href="https://guides.rubygems.org/make-your-own-gem/">文件结构手册</a> 这个标准供大家参考学习。</p>
</blockquote>
<p>首先来看 CALide 项目的文件入口 lib/calide.rb ：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">module</span> CLAide
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#cb4b16">VERSION</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;1.0.3&#39;</span><span style="color:#719e07">.</span>freeze
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;claide/ansi&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;claide/argument&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;claide/argv&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;claide/command&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;claide/help&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;claide/informative_error&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">end</span>
</code></pre></div><p>我们接下来分析一下 <code>lib/cladie/</code> 目录下的相关代码。</p>
<h2 id="command-抽象类">Command 抽象类</h2>
<p><code>Command</code> 是用于构建命令行界面的基础抽象类。所有我们添加的命令都需要继承自 <code>Command</code>，这些子类可以嵌套组合成更加精细的命令。
<code>pod</code> 命令正是由多个 <code>Pod::Command &lt; CLAide::Command</code> 的子类组合而成的 <code>abstract command</code>。当然 <code>pod</code> 的 subcommand 同样也能声明为 <code>abstact command</code>，通过这样的方式我们就能达到多级嵌套命令的效果。有抽象命令当然也需要有具体执行任务的 <code>normal command</code>。
举个例子：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-basic" data-lang="basic"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>$ pod update <span style="color:#719e07">--</span>help
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>Usage:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  $ pod update [POD_NAMES <span style="color:#719e07">...</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    Updates the Pods identified by the specified `POD_NAMES`
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>Options:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>  <span style="color:#719e07">--</span>verbose                              Show more debugging information
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>  <span style="color:#719e07">--</span>no<span style="color:#719e07">-</span>ansi                              Show output without ANSI codes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>  <span style="color:#719e07">--</span>help                                 Show help banner of specified command
</code></pre></div><p>对应的， <code>pod update</code> 这个命令的逻辑在 <code>CLAide</code> 中就是如下描述：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Update</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>      <span style="color:#b58900">self</span><span style="color:#719e07">.</span>arguments <span style="color:#719e07">=</span> <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        <span style="color:#cb4b16">CLAide</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Argument</span><span style="color:#719e07">.</span>new(<span style="color:#2aa198">&#39;POD_NAMES&#39;</span>, <span style="color:#719e07">false</span>, <span style="color:#719e07">true</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#b58900">self</span><span style="color:#719e07">.</span>description <span style="color:#719e07">=</span> <span style="color:#2aa198">&lt;&lt;-DESC
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#2aa198"></span>        <span style="color:#cb4b16">Updates</span> the <span style="color:#cb4b16">Pods</span> identified by the specified <span style="color:#586e75">`POD_NAMES`</span><span style="color:#719e07">.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#cb4b16">DESC</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">options</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>          <span style="color:#719e07">[</span><span style="color:#2aa198">&#34;--sources&#34;</span>, <span style="color:#2aa198">&#39;The sources from which to update dependent pods&#39;</span><span style="color:#719e07">]</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>          <span style="color:#719e07">[</span><span style="color:#2aa198">&#39;--exclude-pods&#39;</span>, <span style="color:#2aa198">&#39;Pods to exclude during update&#39;</span><span style="color:#719e07">]</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>          <span style="color:#719e07">[</span><span style="color:#2aa198">&#39;--clean-install&#39;</span>, <span style="color:#2aa198">&#39;Ignore the contents of the project cache and force a full pod installation&#39;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        <span style="color:#719e07">].</span>concat(<span style="color:#719e07">super</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07">end</span>
</code></pre></div><p>当我们如此描述后，CLAide 会对这个类进行以下方式的解析：</p>
<p><img src="http://cdn.nlark.com/yuque/0/2020/png/227152/1599005020049-ddaee5cf-5280-4586-b5ab-0a3587f0d245.png?x-oss-process=image%2Fresize%2Cw_746" alt="pod update"></p>
<p>此外，<code>Command</code> class 提供了大量基础功能，其中最核心的方法为 <code>run</code>，会在 <code>normal command</code> 小节会介绍。对于任何命令类型都可以设置以下几个属性和方法：</p>
<ul>
<li><strong>summary</strong>: 用于简单描述该命令的作用</li>
<li><strong>options</strong>: 用于返回该命令的可选项及对应的描述，返回的 options 需要通过调用 <code>super</code> 插入到父类的可选项前</li>
<li><strong>initialize</strong>: 如果需要获取命令行传递的实参，需要通过重载 <code>initialize</code> 方法来获取</li>
<li><strong>validate!</strong>: 用于检查输入实参的有效性，如果校验失败，会通过调用 <code>help!</code> 方法来输出帮助信息</li>
<li><strong>help!</strong>：用于错误信息的处理和展示</li>
</ul>
<p>注意 ⚠️：这里我们说的 <strong><code>abstract command</code> 和 <code>normal command</code> 均是通过 <code>Command</code> 来实现的</strong>，只是它们的配置不同。</p>
<h3 id="abstract-command">Abstract Command</h3>
<p><code>abstract command</code> 为不提供具体命令实现的抽象容器命令类，不过它可以包含一个或多个的 subcommands。我们可以指定 subcommands 中的 <code>normal command</code> 为默认命令，就能将 <code>abstract command</code> 作为作为普通命令直接执行了。
抽象命令的现实比较简单：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#b58900">self</span><span style="color:#719e07">.</span>abstract_command <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>
</code></pre></div><p>仅需设置 <code>abstract_command</code>，然后就可以继承它来实现普通命令或者多级嵌套的抽象命令。
以 <code>pod</code> 命令的实现为例：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Command</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">CLAide</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods/command/install&#39;</span> <span style="color:#586e75"># 1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods/command/update&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>abstract_command <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>command <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;pod&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>    <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">end</span>
</code></pre></div><p>上述通过 <strong>require</strong> 引入的 <code>update</code>、<code>install</code> 等子命令都是继承自 <code>Pod::Command</code> 的 <code>normal command</code>。
<img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1598855030376-84980ad9-7ff0-4c97-bee8-266bc77772e9.jpeg?x-oss-process=image%2Fresize%2Cw_746" alt=""></p>
<h3 id="normal-command">Normal Command</h3>
<p>相对于抽象命令，普通命令就需要设置传递实参的名称和描述，以及重载 <code>run</code> 方法。
<strong>Arguments</strong>
<code>arguments</code> 用于配置该命令支持的参数列表的 banner 输出，类型为 <code>Array&lt;Argument&gt;]</code>，它最终会格式化成对应的信息展示在 <code>Usage</code> banner 中。
我们来看 <code>pod update</code> 的 <code>arguments</code> 是如何配置的：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#b58900">self</span><span style="color:#719e07">.</span>arguments <span style="color:#719e07">=</span> <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#cb4b16">CLAide</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Argument</span><span style="color:#719e07">.</span>new(<span style="color:#2aa198">&#39;POD_NAMES&#39;</span>, <span style="color:#719e07">false</span>, <span style="color:#719e07">true</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">]</span>
</code></pre></div><p>其中 <code>Argument</code> 的构造方法如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">module</span> CLAide
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Argument</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(names, required, repeatable <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>      @names <span style="color:#719e07">=</span> <span style="color:#b58900">Array</span>(names)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>      @required <span style="color:#719e07">=</span> required
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>      @repeatable <span style="color:#719e07">=</span> repeatable
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">end</span>
</code></pre></div><p>这里传入的 names 就是在 <code>Usage</code> banner 中输出的 <code>[POD_NAMES ...]</code> 。
<strong>require</strong> 表示该 Argument 是否为必传参数，可选参数会用 <code>[ ]</code> 将其包裹起来。也就是说 <code>pod update</code> 命令默认是不需要传 <code>POD_NAMES</code>
<strong>repeatable</strong> 表示该 Argument 是否可以重复多次出现。如果设置为可重复，那么会在 names 的输出信息后面会添加 <code>...</code> 表示该参数为复数参数。
举个例子：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>$ pod update Alamofire, SwiftyJSON
</code></pre></div><p>我们可以指定 <code>pod update</code> 仅更新特定的依赖库，如果不传 <code>POD_NAMES</code> 将进行全量更新。</p>
<h3 id="run-方法">Run 方法</h3>
<p>在 <code>Command</code> 类中定义了两个 <code>run</code> 方法：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">run</span>(argv <span style="color:#719e07">=</span> <span style="color:#719e07">[]</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#586e75"># 根据文件前缀来匹配对应的插件</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  plugin_prefixes<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>plugin_prefix<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#cb4b16">PluginManager</span><span style="color:#719e07">.</span>load_plugins(plugin_prefix)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  argv <span style="color:#719e07">=</span> <span style="color:#cb4b16">ARGV</span><span style="color:#719e07">.</span>coerce(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#586e75"># 解析 argument 生成对应的 command instance</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  command <span style="color:#719e07">=</span> parse(argv) 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#cb4b16">ANSI</span><span style="color:#719e07">.</span>disabled <span style="color:#719e07">=</span> <span style="color:#719e07">!</span>command<span style="color:#719e07">.</span>ansi_output?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">unless</span> command<span style="color:#719e07">.</span>handle_root_options(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    command<span style="color:#719e07">.</span>validate!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    command<span style="color:#719e07">.</span>run
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">rescue</span> <span style="color:#cb4b16">Object</span> <span style="color:#719e07">=&gt;</span> exception
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  handle_exception(command, exception)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">def</span> <span style="color:#268bd2">run</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#39;A subclass should override the `CLAide::Command#run` method to &#39;</span> \
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>  <span style="color:#2aa198">&#39;actually perform some work.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span><span style="color:#719e07">end</span>
</code></pre></div><p>这里的 <code>self.run</code> 方法是 class method，而 <code>run</code> 是 instanced method。对于 <code>Ruby</code> 不太熟悉的同学可以看看这个：<a href="https://stackoverflow.com/questions/13706373/what-does-def-self-function-name-mean">What does def <code>self.function</code> name mean?</a>
作为 <code>Command</code> 类的核心方法，类方法 <code>self.run</code> 将终端传入的参数解析成对应的 <strong>command</strong> 和 <strong>argv</strong>，并最终调用 command 的实例方法 <code>run</code> 来触发真正的命令逻辑。因此，子类需要通过重载 <code>run</code> 方法来完成对应命令的实现。
那么问题来了，方法 <code>Command::parse</code> 是如何将 <code>run</code> 的类方法转换为实例方法的呢？</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">parse</span>(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#586e75"># 通过解析 argv 获取到与 cmd 名称</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  argv <span style="color:#719e07">=</span> <span style="color:#cb4b16">ARGV</span><span style="color:#719e07">.</span>coerce(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  cmd <span style="color:#719e07">=</span> argv<span style="color:#719e07">.</span>arguments<span style="color:#719e07">.</span>first
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#586e75"># 如果 cmd 对应的 Command 类，则更新 argv，继续解析命令</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#719e07">if</span> cmd <span style="color:#719e07">&amp;&amp;</span> subcommand <span style="color:#719e07">=</span> find_subcommand(cmd)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    argv<span style="color:#719e07">.</span>shift_argument
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    subcommand<span style="color:#719e07">.</span>parse(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#586e75"># 如果 cmd 为抽象命令且指定了默认命令，则返回默认命令继续解析参数</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#719e07">elsif</span> abstract_command? <span style="color:#719e07">&amp;&amp;</span> default_subcommand
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    load_default_subcommand(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#586e75"># 初始化真正的 cmd 实例</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">new</span>(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07">end</span>
</code></pre></div><p>可以说，<code>CLAide</code> 的命令解析就是一个<strong>多叉树遍历</strong>，通过分割参数及遍历 <code>CLAide::Command</code> 的子类，最终找到用户输入的 <code>normal command</code> 并初始化返回。<img src="http://cdn.nlark.com/yuque/0/2020/png/227152/1599006816575-464e442d-5b43-475f-bc5f-4b086c59190c.png?x-oss-process=image%2Fresize%2Cw_746" alt=""></p>
<p>这里还有一个知识点就是，<code>CLAide::Command</code> 是如何知道有哪些子类集成它的呢？</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">inherited</span>(subcommand)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  subcommands <span style="color:#719e07">&lt;&lt;</span> subcommand
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">end</span>
</code></pre></div><p><strong>这里利用了 <code>Ruby</code> 提供的 <em>Hook Method</em> <code>self.inherited</code> 来获取它所继承的子类，并将其保存在 <code>subcommands</code>。</strong>
另外，这里在真正执行 <code>self.run</code> 方法之前会遍历当前项目所引入的 Gems 包中的指定目录下的命令插件文件，并进行插件加载，具体内容将在 <code>PluginManager</code> 中展开。</p>
<h3 id="argv-传入参数">ARGV 传入参数</h3>
<p><code>CLAide</code> 提供了专门的类 <code>ARGV</code> 用于解析命令行传入的参数。主要功能是对 <code>Parse</code> 解析后的 tuple 列表进行各种过滤、CURD 等操作。
按照 <code>CALide</code> 的定义参数分三种类型：</p>
<ul>
<li><code>arg</code>: 普通的实参，所谓的实参就是直接跟在命令后面的，且不带任何 <code>--</code> 修饰的字符</li>
<li><code>flag</code>: 简单理解 <code>flag</code> 就是限定为 bool 变量的 <code>option</code> 类型参数，如果 <code>flag</code> 前面添加带 <code>--no-</code> 则值为 false，否则为 true</li>
<li><code>option</code>: 可选项参数，以 <code>--</code> 为前缀且以 <code>=</code> 作为分割符来区分 key 和 value</li>
</ul>
<p>而在 <code>ARGV</code> 内部又提供了私有工具类 <code>Parser</code> 来解析终端的输入，其核心方法为 <code>parse</code>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Parser
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">parse</span>(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    entries <span style="color:#719e07">=</span> <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    copy <span style="color:#719e07">=</span> argv<span style="color:#719e07">.</span>map(<span style="color:#719e07">&amp;</span><span style="color:#2aa198">:to_s</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    double_dash <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">while</span> argument <span style="color:#719e07">=</span> copy<span style="color:#719e07">.</span>shift
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      <span style="color:#719e07">next</span> <span style="color:#719e07">if</span> <span style="color:#719e07">!</span>double_dash <span style="color:#719e07">&amp;&amp;</span> double_dash <span style="color:#719e07">=</span> (argument <span style="color:#719e07">==</span> <span style="color:#2aa198">&#39;--&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      type <span style="color:#719e07">=</span> double_dash ? <span style="color:#2aa198">:arg</span> : argument_type(argument)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      parsed_argument <span style="color:#719e07">=</span> parse_argument(type, argument)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      entries <span style="color:#719e07">&lt;&lt;</span> <span style="color:#719e07">[</span>type, parsed_argument<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    entries
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#586e75"># ,,,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">end</span>
</code></pre></div><p>parse 的返回值为 <code>[Array&lt;Array&lt;Symbol, String, Array&gt;&gt;]</code> 类型的 tuple，其中 tuple 的第一个变量为实参的类型，第二个才是对应的实参。
依旧以 <code>pod update</code> 为例：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>pod update Alamofire --no-repo-update --exclude-pods<span style="color:#719e07">=</span>SwiftyJSON
</code></pre></div><p><img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1598855030381-29d93c99-1c6c-4a40-8bf7-a40eee4140a7.jpeg?x-oss-process=image%2Fresize%2Cw_746" alt="">
解析后，输出的 tuple 列表如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">[</span><span style="color:#2aa198">:arg</span>, <span style="color:#2aa198">&#34;Alamofire&#34;</span><span style="color:#719e07">]</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  <span style="color:#719e07">[</span><span style="color:#2aa198">:flag</span>, <span style="color:#719e07">[</span><span style="color:#2aa198">&#34;repo-update&#34;</span>, <span style="color:#719e07">false</span><span style="color:#719e07">]]</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  <span style="color:#719e07">[</span><span style="color:#2aa198">:option</span>, <span style="color:#719e07">[</span><span style="color:#2aa198">&#34;exclude-pods&#34;</span>, <span style="color:#2aa198">&#34;SwiftyJSON&#34;</span><span style="color:#719e07">]]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">]</span>
</code></pre></div><h2 id="banner-与输出格式化">Banner 与输出格式化</h2>
<p>接下来，我们再来聊聊 <code>CLAide</code> 提供的格式化效果的 banner。
那什么是 banner 呢？回看第一个例子 <code>pod --help</code> 所输出的帮助信息，它分为三个 Section：</p>
<ul>
<li><code>Usage</code>：用于描该述命令的用法</li>
<li><code>Commands</code>：用于描述该命令所包含的子命令，没有则不显示。在子命令前面存在两种类型的标识
<ul>
<li><code>+</code> ：用于强调该 command 是单独添加的子命令</li>
<li><code>&gt;</code> ：用于表示指引的意思，表示该 command 是当前命令的默认实现</li>
</ul>
</li>
<li><code>Options</code>：用于描述该命令的可选项</li>
</ul>
<p><strong>这三段帮助信息就是对应的不同的 banner。</strong>
<code>CLAide</code> 对于输出的 banner 信息提供了 <a href="https://www.wikiwand.com/en/ANSI_escape_code">ANSI 转义</a>，用于在不同的终端里显示富文本的效果。banner 的主要格式化效果如下：</p>
<ol>
<li>对于 setcion 标题： <code>Usage</code>、<code>Commands</code>、<code>Options</code> 添加了下划线且加粗处理</li>
<li>Command 配置为绿色</li>
<li>Options 配置为蓝色</li>
<li>提示警告信息配置为黄色</li>
<li>错误信息则是红色</li>
</ol>
<p>对于这些配色方案，<code>CLAide</code> 提供了 String 的 convince method 来完成 ANSI 转义：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">String</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">ansi</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#cb4b16">CLAide</span><span style="color:#719e07">::</span><span style="color:#cb4b16">ANSI</span><span style="color:#719e07">::</span><span style="color:#cb4b16">StringEscaper</span><span style="color:#719e07">.</span>new(<span style="color:#b58900">self</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">end</span>
</code></pre></div><p>例如：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#2aa198">&#34;example&#34;</span><span style="color:#719e07">.</span>ansi<span style="color:#719e07">.</span>yellow <span style="color:#586e75">#=&gt; &#34;\e[33mexample\e[39m&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#2aa198">&#34;example&#34;</span><span style="color:#719e07">.</span>ansi<span style="color:#719e07">.</span>on_red <span style="color:#586e75">#=&gt; &#34;\e[41mexample\e[49m&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#2aa198">&#34;example&#34;</span><span style="color:#719e07">.</span>ansi<span style="color:#719e07">.</span>bold   <span style="color:#586e75">#=&gt; &#34;\e[1mexample\e[21m&#34;</span>
</code></pre></div><p>对于 Banner 的一些高亮效果也提供了 convince method：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">prettify_title</span>(title)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  title<span style="color:#719e07">.</span>ansi<span style="color:#719e07">.</span>underline
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">def</span> <span style="color:#268bd2">prettify_subcommand</span>(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#b58900">name</span><span style="color:#719e07">.</span>chomp<span style="color:#719e07">.</span>ansi<span style="color:#719e07">.</span>green
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">def</span> <span style="color:#268bd2">prettify_option_name</span>(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#b58900">name</span><span style="color:#719e07">.</span>chomp<span style="color:#719e07">.</span>ansi<span style="color:#719e07">.</span>blue
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">end</span>
</code></pre></div><h2 id="pluginmanager-载入插件">PluginManager 载入插件</h2>
<p><code>PluginManager</code> 是 Command 的管理类，会在第一次运行命令 <code>self.run</code> 时进行加载，且仅加载命令类中指定前缀标识的文件下的命令。让我们先看 <code>PluginManager.rb</code> 的核心实现：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">load_plugins</span>(plugin_prefix)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>   loaded_plugins<span style="color:#719e07">[</span>plugin_prefix<span style="color:#719e07">]</span> <span style="color:#719e07">||=</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>   plugin_gems_for_prefix(plugin_prefix)<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>spec, paths<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>     spec <span style="color:#719e07">if</span> safe_activate_and_require(spec, paths)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>   <span style="color:#719e07">end</span><span style="color:#719e07">.</span>compact
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">plugin_gems_for_prefix</span>(prefix)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>   glob <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;</span><span style="color:#2aa198">#{</span>prefix<span style="color:#2aa198">}</span><span style="color:#2aa198">_plugin</span><span style="color:#2aa198">#{</span><span style="color:#cb4b16">Gem</span><span style="color:#719e07">.</span>suffix_pattern<span style="color:#2aa198">}</span><span style="color:#2aa198">&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>   <span style="color:#cb4b16">Gem</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Specification</span><span style="color:#719e07">.</span>latest_specs(<span style="color:#719e07">true</span>)<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>spec<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      matches <span style="color:#719e07">=</span> spec<span style="color:#719e07">.</span>matches_for_glob(glob)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#719e07">[</span>spec, matches<span style="color:#719e07">]</span> <span style="color:#719e07">unless</span> matches<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>   <span style="color:#719e07">end</span><span style="color:#719e07">.</span>compact
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">safe_activate_and_require</span>(spec, paths)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  spec<span style="color:#719e07">.</span>activate
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  paths<span style="color:#719e07">.</span>each { <span style="color:#719e07">|</span>path<span style="color:#719e07">|</span> <span style="color:#b58900">require</span>(path) }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">rescue</span> <span style="color:#cb4b16">Exception</span> <span style="color:#719e07">=&gt;</span> exception
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span><span style="color:#719e07">end</span>
</code></pre></div><p>整体的流程大致是：</p>
<ol>
<li>调用 <code>load_plugins</code> 并传入 <code>plugin_prefix</code></li>
<li><code>plugin_gems_for_prefix</code> 对插件名进行处理，取出我们需要加载的文件</li>
<li>调用 <code>safe_activate_and_require</code> 进行对应的 gem spec 检验并对每个文件进行加载</li>
</ol>
<p>CocoaPods 的插件加载正是依托于 CLAide 的 <code>load_plugins</code>，它会遍历所有的 RubyGem，并搜索这些 Gem 中是否包含名为 <code>#{plugin_prefix}_plugin.rb</code> 的文件。例如，在 Pod 命令的实现中有如下配置：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#b58900">self</span><span style="color:#719e07">.</span>plugin_prefixes <span style="color:#719e07">=</span> <span style="color:#2aa198">%w(claide cocoapods)</span>
</code></pre></div><p>也就是说在 Pod 命令执行前，<strong>它会加载所有包含 <code>claide_plugin.rb</code> 或 <code>cocoapods_plugin.rb</code> 文件的 Gem</strong>。通过在运行时的文件检查来加载符合要求的相关命令。</p>
<p><img src="http://cdn.nlark.com/yuque/0/2020/png/227152/1599006816575-464e442d-5b43-475f-bc5f-4b086c59190c.png?x-oss-process=image%2Fresize%2Cw_746" alt="image.png"></p>
<h1 id="用-claide-实现一款--贩卖机">用 CLAide 实现一款 🥤 贩卖机</h1>
<p>最后一节让我们一起来创建一个 CLAide 命令。需求是希望实现一个自动 🥤 贩卖机，它有如下功能：主要售卖 ☕️ 和 🍵，这两种 🥤 都可以按需选择是否添加 🥛 和 🍬，对于 🍬 还可以选择不同的甜度。</p>
<ul>
<li>☕️：对于咖啡，我们提供了：BlackEye、Affogato、CaPheSuaDa、RedTux 的口味</li>
<li>🍵：对于茶，你可以选择不同的品种，有黑茶、绿茶、乌龙茶和白茶，同时茶还提供了加 🧊 的选项</li>
</ul>
<h2 id="配置模版项目">配置模版项目</h2>
<p>基于上述构想，我们最终的 <code>BeverageMaker</code> 目录将由以下文件组成：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>.
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>├── BeverageMaker.gemspec
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>│   <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>├── exe
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>│   └── beverage-maker
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>├── lib
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>│   ├── beveragemaker
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>│   │   ├── <span style="color:#b58900">command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>│   │   │   ├── coffee.rb <span style="color:#586e75"># 包含 abstract command 以及用于制作不同咖啡的 normal command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>│   │   │   ├── maker.rb  <span style="color:#586e75"># Command 抽象类</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>│   │   │   └── tea.rb    <span style="color:#586e75"># normal command, 不同种类的 🍵 通过参数配置来完成</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>│   │   ├── command.rb
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>│   │   └── version.rb
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>│   └── beveragemaker.rb
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>└── spec
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    ├── BeverageMaker_spec.rb
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    └── spec_helper.rb
</code></pre></div><h3 id="0x1-生成模版项目">0x1 生成模版项目</h3>
<p>首先，我们使用 <code>bundler gem GEM_NAME</code> 命令生成一个模版项目，项目取名为 <strong>BeverageMaker</strong>。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>$ bundle gem <span style="color:#cb4b16">BeverageMaker</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#cb4b16">Creating</span> gem <span style="color:#2aa198">&#39;BeverageMaker&#39;</span><span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#cb4b16">MIT</span> <span style="color:#cb4b16">License</span> enabled <span style="color:#719e07">in</span> config
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#cb4b16">Code</span> of conduct enabled <span style="color:#719e07">in</span> config
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  create  <span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">/</span><span style="color:#cb4b16">Gemfile</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  create  <span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">/</span>lib<span style="color:#719e07">/</span><span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">.</span>rb
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  create  <span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">/</span>lib<span style="color:#719e07">/</span><span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">/</span>version<span style="color:#719e07">.</span>rb
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  create  <span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">/</span><span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">.</span>gemspec
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  create  <span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">/</span><span style="color:#cb4b16">Rakefile</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#cb4b16">Initializing</span> git repo <span style="color:#719e07">in</span> <span style="color:#719e07">~</span><span style="color:#dc322f">/$HOME/</span><span style="color:#cb4b16">Desktop</span><span style="color:#719e07">/</span><span style="color:#cb4b16">BeverageMaker</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#cb4b16">Gem</span> <span style="color:#2aa198">&#39;BeverageMaker&#39;</span> was successfully created<span style="color:#719e07">.</span> <span style="color:#cb4b16">For</span> more information on making a <span style="color:#cb4b16">RubyGem</span> visit <span style="color:#2aa198">https</span>:<span style="color:#dc322f">//</span>bundler<span style="color:#719e07">.</span>io<span style="color:#719e07">/</span>guides<span style="color:#719e07">/</span>creating_gem<span style="color:#719e07">.</span>html
</code></pre></div><h3 id="0x2-修改-gemspec-配置">0x2 修改 gemspec 配置</h3>
<p>生成的项目中需要将 <code>BeverageMaker.gemspec</code> 文件所包含 <strong>TODO</strong> 的字段进行替换，作为示例项目相关链接都替换为个人主页了 😂。
另外，需要添加我们的依赖 <code>'claide', '&gt;= 1.0.2', '&lt; 2.0'</code> 和 <code>'colored2', '~&gt; 3.1'</code>。</p>
<blockquote>
<p><strong>colored2</strong> 用于 banner 信息的 ANSI 转义并使其能在终端以富文本格式输出。</p>
</blockquote>
<p>最终 <code>.gempsc</code> 配置如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>require_relative <span style="color:#2aa198">&#39;lib/BeverageMaker/version&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#cb4b16">Gem</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Specification</span><span style="color:#719e07">.</span>new <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>spec<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  spec<span style="color:#719e07">.</span>name          <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;BeverageMaker&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  spec<span style="color:#719e07">.</span>version       <span style="color:#719e07">=</span> <span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">::</span><span style="color:#cb4b16">VERSION</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  spec<span style="color:#719e07">.</span>authors       <span style="color:#719e07">=</span> <span style="color:#719e07">[</span><span style="color:#2aa198">&#34;Edmond&#34;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  spec<span style="color:#719e07">.</span>email         <span style="color:#719e07">=</span> <span style="color:#719e07">[</span><span style="color:#2aa198">&#34;chun574271939@gmail.com&#34;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  spec<span style="color:#719e07">.</span>summary       <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;BeverageMaker&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  spec<span style="color:#719e07">.</span>description   <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;BeverageMaker&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  spec<span style="color:#719e07">.</span>homepage      <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;https://looseyi.github.io&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  spec<span style="color:#719e07">.</span>license       <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;MIT&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  spec<span style="color:#719e07">.</span>required_ruby_version <span style="color:#719e07">=</span> <span style="color:#cb4b16">Gem</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Requirement</span><span style="color:#719e07">.</span>new(<span style="color:#2aa198">&#34;&gt;= 2.3.0&#34;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  spec<span style="color:#719e07">.</span>metadata<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;allowed_push_host&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;https://looseyi.github.io&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  spec<span style="color:#719e07">.</span>metadata<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;homepage_uri&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> spec<span style="color:#719e07">.</span>homepage
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  spec<span style="color:#719e07">.</span>metadata<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;source_code_uri&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;https://looseyi.github.io&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  spec<span style="color:#719e07">.</span>metadata<span style="color:#719e07">[</span><span style="color:#2aa198">&#34;changelog_uri&#34;</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;https://looseyi.github.io&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>  spec<span style="color:#719e07">.</span>files         <span style="color:#719e07">=</span> <span style="color:#cb4b16">Dir</span><span style="color:#719e07">.</span>chdir(<span style="color:#cb4b16">File</span><span style="color:#719e07">.</span>expand_path(<span style="color:#2aa198">&#39;..&#39;</span>, <span style="color:#268bd2">__FILE__</span>)) <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    <span style="color:#586e75">`git ls-files -z`</span><span style="color:#719e07">.</span>split(<span style="color:#2aa198">&#34;</span><span style="color:#cb4b16">\x0</span><span style="color:#2aa198">&#34;</span>)<span style="color:#719e07">.</span>reject { <span style="color:#719e07">|</span>f<span style="color:#719e07">|</span> f<span style="color:#719e07">.</span>match(<span style="color:#dc322f">%r{^(test|spec|features)/}</span>) }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>  <span style="color:#586e75"># 1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>  spec<span style="color:#719e07">.</span>bindir        <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;exe&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>  spec<span style="color:#719e07">.</span>executables   <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;beverage-maker&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>  spec<span style="color:#719e07">.</span>require_paths <span style="color:#719e07">=</span> <span style="color:#719e07">[</span><span style="color:#2aa198">&#34;lib&#34;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>  spec<span style="color:#719e07">.</span>add_runtime_dependency <span style="color:#2aa198">&#39;claide&#39;</span>,         <span style="color:#2aa198">&#39;&gt;= 1.0.2&#39;</span>, <span style="color:#2aa198">&#39;&lt; 2.0&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>  spec<span style="color:#719e07">.</span>add_runtime_dependency <span style="color:#2aa198">&#39;colored2&#39;</span>,       <span style="color:#2aa198">&#39;~&gt; 3.1&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span><span style="color:#719e07">end</span>
</code></pre></div><h3 id="0x3-添加命令行入口">0x3 添加命令行入口</h3>
<p>通过修改 <code>.gemspec</code> 的 <code>bindir</code> 和 <code>executables</code> 字段，把最终的 binary 执行文件暴露给用户，使其成为一个真正的 CLI：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>spec<span style="color:#719e07">.</span>bindir        <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;exe&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>spec<span style="color:#719e07">.</span>executables   <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;beverage-maker&#34;</span>
</code></pre></div><p>在默认生成的模版中指定的 <code>bindir</code> 为 <code>/bin</code> 目录，这里我们替换为新建的 <code>exe</code> 目录，并在 <code>exe</code> 目录下创建一个名为 <code>beverage-maker</code> 的文件，它将作为 CLI 的入口，其内容如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75">#!/usr/bin/env ruby</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;beveragemaker&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#cb4b16">BeverageMaker</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Command</span><span style="color:#719e07">.</span>run(<span style="color:#cb4b16">ARGV</span>)
</code></pre></div><h2 id="添加命令实现">添加命令实现</h2>
<p>为了让 Demo 结构清晰，我们将不能类型的饮料制作分到了不同的文件和命令类中。
<img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1598855030357-6c577c34-8687-4aa3-b495-876a2a6e4ecb.jpeg?x-oss-process=image%2Fresize%2Cw_746" alt=""></p>
<h3 id="beveragemaker">BeverageMaker</h3>
<p>先来实现 <code>beverage-maker</code> 命令，它是一个 <code>abstract command</code>，其内容如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;claide&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;colored2&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">module</span> BeverageMaker
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#586e75"># 引入具体的 coffee &amp; tea maker</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;beveragemaker/command/coffee&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;beveragemaker/command/tea&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Command</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">CLAide</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>command <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;beverage-maker&#39;</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>abstract_command <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>description <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Make delicious beverages from the comfort of your terminal.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">options</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        <span style="color:#719e07">[</span><span style="color:#2aa198">&#39;--no-milk&#39;</span>, <span style="color:#2aa198">&#39;Don’t add milk to the beverage&#39;</span><span style="color:#719e07">]</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        <span style="color:#719e07">[</span><span style="color:#2aa198">&#39;--sweetener=[sugar|honey]&#39;</span>, <span style="color:#2aa198">&#39;Use one of the available sweeteners&#39;</span><span style="color:#719e07">]</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>      <span style="color:#719e07">].</span>concat(<span style="color:#719e07">super</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      @add_milk <span style="color:#719e07">=</span> argv<span style="color:#719e07">.</span>flag?(<span style="color:#2aa198">&#39;milk&#39;</span>, <span style="color:#719e07">true</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>      @sweetener <span style="color:#719e07">=</span> argv<span style="color:#719e07">.</span>option(<span style="color:#2aa198">&#39;sweetener&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>      <span style="color:#719e07">super</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">validate!</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>      <span style="color:#719e07">super</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>      <span style="color:#719e07">if</span> @sweetener <span style="color:#719e07">&amp;&amp;</span> <span style="color:#719e07">!</span><span style="color:#2aa198">%w(sugar honey)</span><span style="color:#719e07">.</span>include?(@sweetener)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>        help! <span style="color:#2aa198">&#34;`</span><span style="color:#2aa198">#{</span>@sweetener<span style="color:#2aa198">}</span><span style="color:#2aa198">&#39; is not a valid sweetener.&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">run</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>      <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#39;* Boiling water…&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>      <span style="color:#b58900">sleep</span> <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>      <span style="color:#719e07">if</span> @add_milk
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>        <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#39;* Adding milk…&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>        <span style="color:#b58900">sleep</span> <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>      <span style="color:#719e07">if</span> @sweetener
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span>        <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#34;* Adding </span><span style="color:#2aa198">#{</span>@sweetener<span style="color:#2aa198">}</span><span style="color:#2aa198">…&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44</span>        <span style="color:#b58900">sleep</span> <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">46</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">47</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">48</span><span style="color:#719e07">end</span>
</code></pre></div><p>正常来说，对于不同口味的咖啡和茶是可以用相同的命令模式来实现的，不过为了更好的展示 <code>CLAide</code> 的效果，我们将咖啡的生产配置为 <code>abstact command</code>，对于不同口味的咖啡，需要实现不同的 <code>normal command</code>。而茶的生产直接通过 <code>normal command</code> 实现，不同品种的茶叶会以参数的形式来配置。</p>
<h3 id="coffee">Coffee</h3>
<p>接着添加 ☕️ 的代码</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">Coffee</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#b58900">self</span><span style="color:#719e07">.</span>abstract_command <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">run</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">super</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#34;* Grinding </span><span style="color:#2aa198">#{</span><span style="color:#b58900">self</span><span style="color:#719e07">.</span>class<span style="color:#719e07">.</span>command<span style="color:#2aa198">}</span><span style="color:#2aa198"> beans…&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#b58900">sleep</span> <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#39;* Brewing coffee…&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#b58900">sleep</span> <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#b58900">puts</span> <span style="color:#2aa198">&#39;* Enjoy!&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">BlackEye</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Coffee</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#b58900">self</span><span style="color:#719e07">.</span>summary <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;A Black Eye is dripped coffee with a double shot of &#39;</span> \
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#2aa198">&#39;espresso&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">end</span>
</code></pre></div><h3 id="tea">Tea</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">Tea</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#b58900">self</span><span style="color:#719e07">.</span>arguments <span style="color:#719e07">=</span> <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#cb4b16">CLAide</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Argument</span><span style="color:#719e07">.</span>new(<span style="color:#2aa198">&#39;FLAVOR&#39;</span>, <span style="color:#719e07">true</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">options</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">[[</span><span style="color:#2aa198">&#39;--iced&#39;</span>, <span style="color:#2aa198">&#39;the ice-tea version&#39;</span><span style="color:#719e07">]].</span>concat(<span style="color:#719e07">super</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(argv)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    @flavor <span style="color:#719e07">=</span> argv<span style="color:#719e07">.</span>shift_argument
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    @iced <span style="color:#719e07">=</span> argv<span style="color:#719e07">.</span>flag?(<span style="color:#2aa198">&#39;iced&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">super</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">validate!</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    <span style="color:#719e07">super</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">if</span> @flavor<span style="color:#719e07">.</span>nil?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>      help! <span style="color:#2aa198">&#39;A flavor argument is required.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    <span style="color:#719e07">unless</span> <span style="color:#2aa198">%w(black green oolong white)</span><span style="color:#719e07">.</span>include?(@flavor)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      help! <span style="color:#2aa198">&#34;`</span><span style="color:#2aa198">#{</span>@flavor<span style="color:#2aa198">}</span><span style="color:#2aa198">&#39; is not a valid flavor.&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span><span style="color:#719e07">end</span>
</code></pre></div><h2 id="安装--贩卖机">安装 🥤 贩卖机</h2>
<p>我们知道，对于正常发布的 gem 包，可以直接通过 <code>gem install GEM_NAME</code> 安装。
而我们的 Demo 程序并未发布，那要如何安装使用呢？幸好 Gem 提供了源码安装的方式：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>gem build *.gemspec
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>gem install *.gem
</code></pre></div><p><code>gem build</code> 可以根据一个 <code>.gemspec</code> 生成一个 <code>.gem</code> 文件供 gem 安装，所以在拥有源码的情况下，执行上面命令就可以安装了。
执行结果如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>$ gem build *.gemspec
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>WARNING:  description and summary are identical
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>WARNING:  See http://guides.rubygems.org/specification-reference/ <span style="color:#719e07">for</span> <span style="color:#b58900">help</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  Successfully built RubyGem
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  Name: BeverageMaker
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  Version: 0.1.0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  File: BeverageMaker-0.1.0.gem
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>$ gem install *.gem
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>Successfully installed BeverageMaker-0.1.0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>Parsing documentation <span style="color:#719e07">for</span> BeverageMaker-0.1.0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>Done installing documentation <span style="color:#719e07">for</span> BeverageMaker after <span style="color:#2aa198">0</span> seconds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#2aa198">1</span> gem installed
</code></pre></div><p>编译通过！
现在可以开始我们的 🥤 制作啦！</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>$ beverage<span style="color:#719e07">-</span>maker
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#2aa198">Usage</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  $ beverage<span style="color:#719e07">-</span>maker <span style="color:#cb4b16">COMMAND</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#cb4b16">Make</span> delicious beverages from the comfort of yourterminal<span style="color:#719e07">.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#2aa198">Commands</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#719e07">+</span> coffee                    <span style="color:#cb4b16">Drink</span> brewed from roasted coffee beans
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#2aa198">Options</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">--</span>no<span style="color:#719e07">-</span>milk                   <span style="color:#cb4b16">Don</span>’t add milk to the beverage
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">--</span>sweetener<span style="color:#719e07">=[</span>sugar<span style="color:#719e07">|</span>honey<span style="color:#719e07">]</span>   <span style="color:#cb4b16">Use</span> one of the available sweeteners
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  <span style="color:#719e07">--</span>version                   <span style="color:#cb4b16">Show</span> the version of the tool
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#719e07">--</span>verbose                   <span style="color:#cb4b16">Show</span> more debugging information
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">--</span>no<span style="color:#719e07">-</span>ansi                   <span style="color:#cb4b16">Show</span> output without <span style="color:#cb4b16">ANSI</span> codes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  <span style="color:#719e07">--</span>help                      <span style="color:#cb4b16">Show</span> help banner of specified command
</code></pre></div><p>来一杯 black-eye ☕️，休息一下吧!</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>$ beverage<span style="color:#719e07">-</span>maker coffee black<span style="color:#719e07">-</span>eye
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">*</span> <span style="color:#cb4b16">Boiling</span> water…
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">*</span> <span style="color:#cb4b16">Adding</span> milk…
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">*</span> <span style="color:#cb4b16">Grinding</span> black<span style="color:#719e07">-</span>eye beans…
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">*</span> <span style="color:#cb4b16">Brewing</span> coffee…
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07">*</span> <span style="color:#cb4b16">Enjoy</span><span style="color:#719e07">!</span>
</code></pre></div><p>如需本文的 Demo 代码，请访问：<a href="https://github.com/looseyi/BeverageMaker">https://github.com/looseyi/BeverageMaker</a></p>
<h1 id="总结">总结</h1>
<p>本文简单聊了 <code>CLAide</code> 的实现，并手动制作了一款 🥤 贩卖机来展示 CALide 的命令配置。主要感受如下：</p>
<ol>
<li>通过对源码对阅读，终于了解了对  <code>pod</code> 命令的的正确使用姿势</li>
<li>仅需简单配置 <code>Command</code> banner，就能有比较精美的终端输出效果和帮助提示等</li>
<li>提供的抽象命令功能，方便的将相关逻辑收口到统一到命令中，方便查阅</li>
<li>从侧面简单了解了，如何在终端输出带富文本效果的提示信息</li>
</ol>
<h1 id="知识点问题梳理">知识点问题梳理</h1>
<p>这里罗列了四个问题用来考察你是否已经掌握了这篇文章，如果没有建议你加入<strong>收藏</strong>再次阅读：</p>
<ol>
<li><code>CLAide</code> 预设的 banner 有哪些，其作用分别是什么 ？</li>
<li><code>CALide</code> 中设定的 Argument 有几种类型，区别是什么 ？</li>
<li><code>CALide</code> 中抽象命令的和普通命令的区别 ？</li>
<li>要实现 CLI 需要修改 <code>.gemspec</code> 中的哪些配置 ？</li>
</ol>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/cocoapods">CocoaPods</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/ruby">Ruby</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/sourcecode-cocoapods/04-cocoapods-podfile/"><span>←</span><span>4. Podfile 的解析逻辑</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-cocoapods/02-cocoapods-corecomponents/"><span>2. 整体把握 CocoaPods 核心组件</span><span>→</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
