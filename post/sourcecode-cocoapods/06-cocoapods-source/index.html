<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>6. PodSpec ç®¡ç†ç­–ç•¥ - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="åœŸåœŸEdmondæœ¨" /><meta name="description" content="æœ¬æ–‡ç›®å½• å¼•å­ æœ¬æ–‡æ˜¯ Core çš„æœ€åä¸€ç¯‡ï¼Œå®ƒä¸å¦å¤–ä¸¤ç¯‡æ–‡ç« ã€ŒPodfile è§£æé€»è¾‘ã€å’Œã€ŒPodSpec æ–‡ä»¶åˆ†æã€å…±åŒæ”¯æ’‘èµ· CocoaPods ä¸–ç•Œçš„éª¨æ¶ã€‚CocoaPo" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.71.1 with theme even" />


<link rel="canonical" href="http://looseyi.github.io/post/sourcecode-cocoapods/06-cocoapods-source/" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/06-cocoapods-source/index.xml" rel="alternate" type="application/rss+xml" title="" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/06-cocoapods-source/index.xml" rel="feed" type="application/rss+xml" title="" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="6. PodSpec ç®¡ç†ç­–ç•¥" />
<meta property="og:description" content="æœ¬æ–‡ç›®å½• å¼•å­ æœ¬æ–‡æ˜¯ Core çš„æœ€åä¸€ç¯‡ï¼Œå®ƒä¸å¦å¤–ä¸¤ç¯‡æ–‡ç« ã€ŒPodfile è§£æé€»è¾‘ã€å’Œã€ŒPodSpec æ–‡ä»¶åˆ†æã€å…±åŒæ”¯æ’‘èµ· CocoaPods ä¸–ç•Œçš„éª¨æ¶ã€‚CocoaPo" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://looseyi.github.io/post/sourcecode-cocoapods/06-cocoapods-source/" />
<meta property="article:published_time" content="2020-11-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-06T00:00:00+00:00" />
<meta itemprop="name" content="6. PodSpec ç®¡ç†ç­–ç•¥">
<meta itemprop="description" content="æœ¬æ–‡ç›®å½• å¼•å­ æœ¬æ–‡æ˜¯ Core çš„æœ€åä¸€ç¯‡ï¼Œå®ƒä¸å¦å¤–ä¸¤ç¯‡æ–‡ç« ã€ŒPodfile è§£æé€»è¾‘ã€å’Œã€ŒPodSpec æ–‡ä»¶åˆ†æã€å…±åŒæ”¯æ’‘èµ· CocoaPods ä¸–ç•Œçš„éª¨æ¶ã€‚CocoaPo">
<meta itemprop="datePublished" content="2020-11-06T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-11-06T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6228">



<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="6. PodSpec ç®¡ç†ç­–ç•¥"/>
<meta name="twitter:description" content="æœ¬æ–‡ç›®å½• å¼•å­ æœ¬æ–‡æ˜¯ Core çš„æœ€åä¸€ç¯‡ï¼Œå®ƒä¸å¦å¤–ä¸¤ç¯‡æ–‡ç« ã€ŒPodfile è§£æé€»è¾‘ã€å’Œã€ŒPodSpec æ–‡ä»¶åˆ†æã€å…±åŒæ”¯æ’‘èµ· CocoaPods ä¸–ç•Œçš„éª¨æ¶ã€‚CocoaPo"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Aha Moment</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Aha Moment</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">6. PodSpec ç®¡ç†ç­–ç•¥</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-06 </span>
        <div class="post-category">
            <a href="/categories/cocoapods/"> CocoaPods </a>
            </div>
          <span class="more-meta"> çº¦ 6228 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 13 åˆ†é’Ÿ </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#metadata">Metadata</a></li>
    <li><a href="#versions">Versions</a>
      <ul>
        <li><a href="#semantic-versioning">Semantic Versioning</a></li>
      </ul>
    </li>
    <li><a href="#cdnsource">CDNSource</a></li>
  </ul>

  <ul>
    <li><a href="#source-æºèµ·">Source æºèµ·</a></li>
    <li><a href="#podspec-æŸ¥è¯¢">PodSpec æŸ¥è¯¢</a>
      <ul>
        <li><a href="#cdn-ä»“åº“æŸ¥è¯¢">CDN ä»“åº“æŸ¥è¯¢</a></li>
        <li><a href="#pod-search-æŸ¥è¯¢å‘½ä»¤">Pod Search æŸ¥è¯¢å‘½ä»¤</a></li>
      </ul>
    </li>
    <li><a href="#repo-æ›´æ–°">Repo æ›´æ–°</a>
      <ul>
        <li><a href="#git-ä»“åº“æ›´æ–°">Git ä»“åº“æ›´æ–°</a></li>
        <li><a href="#cdn-ä»“åº“æ›´æ–°">CDN ä»“åº“æ›´æ–°</a></li>
        <li><a href="#pod-repo-æ›´æ–°å‘½ä»¤">Pod Repo æ›´æ–°å‘½ä»¤</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="æœ¬æ–‡ç›®å½•">æœ¬æ–‡ç›®å½•</h1>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqxvl1mj218w0ngtbj.jpg" alt="PodSpec æ–‡ä»¶ç®¡ç†"></p>
<h1 id="å¼•å­">å¼•å­</h1>
<p>æœ¬æ–‡æ˜¯ Core çš„æœ€åä¸€ç¯‡ï¼Œå®ƒä¸å¦å¤–ä¸¤ç¯‡æ–‡ç« ã€Œ<a href="https://looseyi.github.io/post/sourcecode-cocoapods/04-cocoapods-podfile/"><strong>Podfile è§£æé€»è¾‘</strong></a>ã€å’Œã€Œ<a href="https://looseyi.github.io/post/sourcecode-cocoapods/05-cocoapods-podspec/"><strong>PodSpec æ–‡ä»¶åˆ†æ</strong></a>ã€å…±åŒæ”¯æ’‘èµ· CocoaPods ä¸–ç•Œçš„éª¨æ¶ã€‚CocoaPods-Core è¿™ä¸ªåº“ä¹‹æ‰€ä»¥è¢«å‘½åä¸º Core å°±æ˜¯å› ä¸ºå®ƒåŒ…å«äº† <strong>Podfile -&gt; Spec Repo -&gt; PodSpec</strong> è¿™æ¡å®Œæ•´çš„é“¾è·¯ï¼Œå°†æ•£è½å„åœ°çš„ä¾èµ–åº“è¿æ¥èµ·æ¥å¹¶åŸºäºæ­¤éª¨æ¶ä¸æ–­åœ°å®Œå–„åŠŸèƒ½ã€‚ä»æä¾›å„ç§ä¾¿åˆ©çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œåˆ°ä¾èµ–åº“ä¸ä¸»é¡¹ç›®çš„è‡ªåŠ¨é›†æˆï¼Œå†åˆ°æä¾›å¤šæ ·çš„ Xcode ç¼–è¯‘é…ç½®ã€å•å…ƒæµ‹è¯•ã€èµ„æºç®¡ç†ç­‰ç­‰ï¼Œæœ€ç»ˆå½¢æˆäº†æˆ‘ä»¬æ‰€è§çš„ CocoaPodsã€‚</p>
<p>ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠ <code>Spec Repo</code> è¿™ä¸ª <code>PodSpec</code> çš„èšåˆä»“åº“ä»¥åŠå®ƒçš„æ¼”å˜ä¸é—®é¢˜ã€‚</p>
<h1 id="source">Source</h1>
<p>ä½œä¸º <code>PodSpec</code> çš„èšåˆä»“åº“ï¼ŒSpec Repo <strong>è®°å½•ç€æ‰€æœ‰ <code>pod</code> æ‰€å‘å¸ƒçš„ä¸åŒç‰ˆæœ¬çš„ <code>PodSpec</code> æ–‡ä»¶</strong>ã€‚è¯¥ä»“åº“å¯¹åº”åˆ° Core çš„æ•°æ®ç»“æ„ä¸º <code>Source</code>ï¼Œå³ä¸ºä»Šå¤©çš„ä¸»è§’ã€‚</p>
<p>æ•´ä¸ª <code>Source</code> çš„ç»“æ„æ¯”è¾ƒç®€å•ï¼Œå®ƒåŸºæœ¬æ˜¯å›´ç»•ç€ Git æ¥åšæ–‡ç« ï¼Œä¸»è¦æ˜¯å¯¹ <code>PodSpec</code> æ–‡ä»¶è¿›è¡Œå„ç§æŸ¥æ‰¾æ›´æ–°æ“ä½œã€‚ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># ç”¨äºæ£€æŸ¥ spec æ˜¯å¦ç¬¦åˆå½“å‰ Source è¦æ±‚</span>
<span class="nb">require</span> <span class="s1">&#39;cocoapods-core/source/acceptor&#39;</span>
<span class="c1"># è®°å½•æœ¬åœ° source çš„é›†åˆ</span>
<span class="nb">require</span> <span class="s1">&#39;cocoapods-core/source/aggregate&#39;</span>
<span class="c1"># ç”¨äºæ ¡éªŒ source çš„é”™è¯¯å’Œè­¦å‘Š</span>
<span class="nb">require</span> <span class="s1">&#39;cocoapods-core/source/health_reporter&#39;</span>
<span class="c1"># source ç®¡ç†å™¨</span>
<span class="nb">require</span> <span class="s1">&#39;cocoapods-core/source/manager&#39;</span>
<span class="c1"># source å…ƒæ•°æ®</span>
<span class="nb">require</span> <span class="s1">&#39;cocoapods-core/source/metadata&#39;</span>

<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Source</span>
    <span class="c1"># ä»“åº“é»˜è®¤çš„ Git åˆ†æ”¯</span>
    <span class="no">DEFAULT_SPECS_BRANCH</span> <span class="o">=</span> <span class="s1">&#39;master&#39;</span><span class="o">.</span><span class="n">freeze</span>
    <span class="c1"># è®°å½•ä»“åº“çš„å…ƒæ•°æ®</span>
    <span class="kp">attr_reader</span> <span class="ss">:metadata</span>
    <span class="c1"># è®°å½•ä»“åº“çš„æœ¬åœ°åœ°å€</span>
    <span class="kp">attr_reader</span> <span class="ss">:repo</span>
    <span class="c1"># repo ä»“åº“åœ°å€ ~/.cocoapods/repos/{repo_name}</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
      <span class="vi">@repo</span> <span class="o">=</span> <span class="no">Pathname</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span><span class="o">.</span><span class="n">expand_path</span>
      <span class="vi">@versions_by_name</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">refresh_metadata</span>
    <span class="k">end</span>
    <span class="c1"># è¯»å– Git ä»“åº“ä¸­çš„ remote url æˆ– .git ç›®å½•</span>
    <span class="k">def</span> <span class="nf">url</span>
      <span class="vi">@url</span> <span class="o">||=</span> <span class="k">begin</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="n">repo_git</span><span class="p">(</span><span class="sx">%w(config --get remote.origin.url)</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">remote</span><span class="o">.</span><span class="n">empty?</span>
          <span class="n">remote</span>
        <span class="k">elsif</span> <span class="p">(</span><span class="n">repo</span> <span class="o">+</span> <span class="s1">&#39;.git&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exist?</span>
          <span class="s2">&#34;file://</span><span class="si">#{</span><span class="n">repo</span><span class="si">}</span><span class="s2">/.git&#34;</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">type</span>
      <span class="n">git?</span> <span class="p">?</span> <span class="s1">&#39;git&#39;</span> <span class="p">:</span> <span class="s1">&#39;file system&#39;</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Source</code> è¿˜æœ‰ä¸¤ä¸ªå­ç±» <strong>CDNSource</strong> å’Œ <strong>TrunkSource</strong>ï¼ŒTrunkSouce æ˜¯ CocoaPods çš„é»˜è®¤ä»“åº“ã€‚åœ¨ç‰ˆæœ¬ 1.7.2 ä¹‹å‰ Master Repo çš„ URL æŒ‡å‘ä¸º Github çš„ <a href="https://github.com/CocoaPods/Specs">Specs ä»“åº“</a>ï¼Œè¿™ä¹Ÿæ˜¯é€ æˆæˆ‘ä»¬æ¯æ¬¡ <code>pod install</code> æˆ– <code>pod update</code> æ…¢çš„åŸå› ä¹‹ä¸€ã€‚å®ƒä¸ä»…ä¿å­˜äº†è¿‘ 10 å¹´æ¥ PodSpec æ–‡ä»¶åŒæ—¶è¿˜åŒ…æ‹¬ Git è®°å½•ï¼Œå†åŠ ä¸Šå¢™çš„åŸå› ï¼Œæ¯æ¬¡æ›´æ–°éƒ½éå¸¸ç—›è‹¦ã€‚è€Œåœ¨ 1.7.2 ä¹‹å CocoaPods çš„é»˜è®¤ Source ç»ˆäºæ”¹ä¸ºäº† CDN æŒ‡å‘ï¼ŒåŒæ—¶æ”¯æŒæŒ‰éœ€ä¸‹è½½ï¼Œç¼“è§£äº† <code>pod</code> æ›´æ–°å’Œç£ç›˜å ç”¨è¿‡å¤§é—®é¢˜ã€‚</p>
<p><code>Source</code> çš„ä¾èµ–å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqy545wj20ow0bit8z.jpg" alt="01-Source"></p>
<p>å›åˆ° <code>Source</code> æ¥çœ‹å…¶å¦‚ä½•åˆå§‹åŒ–çš„ï¼Œå¯ä»¥çœ‹åˆ°å…¶æ„é€ å‡½æ•° <code>#initialize(repo)</code> å°†ä¼ å…¥çš„ repo åœ°å€ä¿å­˜åï¼Œç›´æ¥è°ƒç”¨äº† <code>#refresh_metadata</code> æ¥å®Œæˆå…ƒæ•°æ®çš„åŠ è½½ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">refresh_metadata</span>
  <span class="vi">@metadata</span> <span class="o">=</span> <span class="no">Metadata</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">metadata_path</span>
  <span class="n">repo</span> <span class="o">+</span> <span class="s1">&#39;CocoaPods-version.yml&#39;</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="metadata">Metadata</h2>
<p>Metadata æ˜¯ä¿å­˜åœ¨ repo ç›®å½•ä¸‹ï¼Œåä¸º <code>CocoaPods-version.yml</code> çš„æ–‡ä»¶ï¼Œ<strong>ç”¨äºè®°å½•è¯¥ Source æ‰€æ”¯æŒçš„ CocoaPods çš„ç‰ˆæœ¬ä»¥åŠä»“åº“çš„åˆ†ç‰‡è§„åˆ™</strong>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">autoload</span> <span class="ss">:Digest</span><span class="p">,</span> <span class="s1">&#39;digest/md5&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;active_support/hash_with_indifferent_access&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;active_support/core_ext/hash/indifferent_access&#39;</span>

<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Source</span>
    <span class="k">class</span> <span class="nc">Metadata</span>
      <span class="c1"># æœ€ä½å¯æ”¯æŒçš„ CocoaPods ç‰ˆæœ¬ï¼Œå¯¹åº”å­—æ®µ `min`</span>
      <span class="kp">attr_reader</span> <span class="ss">:minimum_cocoapods_version</span>
      <span class="c1"># æœ€é«˜å¯æ”¯æŒçš„ CocoaPods ç‰ˆæœ¬ï¼Œå¯¹åº”å­—æ®µ `max`</span>
      <span class="kp">attr_reader</span> <span class="ss">:maximum_cocoapods_version</span>
      <span class="c1"># æœ€æ–° CocoaPods ç‰ˆæœ¬ï¼Œå¯¹åº”å­—æ®µ `last`</span>
      <span class="kp">attr_reader</span> <span class="ss">:latest_cocoapods_version</span>
      <span class="c1"># è§„å®šæˆªå–çš„å…³é”®å­—æ®µçš„å‰ç¼€é•¿åº¦å’Œæ•°é‡</span>
      <span class="kp">attr_reader</span> <span class="ss">:prefix_lengths</span>
      <span class="c1"># å¯å…¼å®¹çš„ CocoaPods æœ€æ–°ç‰ˆæœ¬</span>
      <span class="kp">attr_reader</span> <span class="ss">:last_compatible_versions</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œä»¥ç¬”è€… ğŸ’» ç¯å¢ƒä¸­ Master ä»“åº“ä¸‹çš„ <code>CocoaPods-version.yml</code> æ–‡ä»¶å†…å®¹ä¸ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">---<span class="w">
</span><span class="w"></span><span class="k">min</span><span class="p">:</span><span class="w"> </span><span class="m">1.0.0</span><span class="w">
</span><span class="w"></span><span class="k">last</span><span class="p">:</span><span class="w"> </span><span class="m">1.10.0</span>.beta<span class="m">.1</span><span class="w">
</span><span class="w"></span><span class="k">prefix_lengths</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="m">1</span><span class="w">
</span><span class="w"></span>- <span class="m">1</span><span class="w">
</span><span class="w"></span>- <span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>æœ€ä½æ”¯æŒç‰ˆæœ¬ä¸º <code>1.0.0</code>ï¼Œæœ€æ–°å¯ç”¨ç‰ˆæœ¬ä¸º <code> 1.10.0.beta.1</code>ï¼Œä»¥åŠæœ€åè¿™ä¸ª <code>prefix_lengths</code> ä¸º <code>[1, 1, 1]</code> çš„æ•°ç»„ã€‚é‚£ä¹ˆè¿™ä¸ª <strong>prefix_lengths çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ ï¼Ÿ</strong></p>
<p>è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¼  <code>Spec Repo</code> çš„ç›®å½•ç»“æ„å›¾ï¼š</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqyd7zij22m60wg7ql.jpg" alt="02-trunk-folder"></p>
<p>å† ğŸ¤” å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>ä¸ºä»€ä¹ˆ CocoaPods ç”Ÿæˆçš„ç›®å½•ç»“æ„æ˜¯è¿™æ · ï¼Ÿ</strong></p>
<p>å…¶å®åœ¨ 2016 å¹´ CocoaPods Spec ä»“åº“ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨åŒçº§ç›®å½•ï¼Œä¸åƒç°åœ¨è¿™æ ·åšäº†åˆ†ç‰‡ã€‚è¿™ä¸ªæ˜¯ä¸ºäº†è§£å†³å½“æ—¶ç”¨æˆ·çš„åæ§½ï¼š<a href="https://github.com/CocoaPods/CocoaPods/issues/4989#issuecomment-193772935">Github ä¸‹è½½æ…¢</a>ï¼Œæœ€ç»ˆè§£å†³æ–¹æ¡ˆçš„ç»“æœå°±å¦‚ä½ æ‰€è§ï¼š<strong>å°† Git ä»“åº“è¿›è¡Œäº†åˆ†ç‰‡</strong>ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<strong>ä¸ºä»€ä¹ˆåˆ†ç‰‡èƒ½å¤Ÿæå‡ Github ä¸‹è½½é€Ÿåº¦ï¼Ÿ</strong></p>
<p>å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ CocoaPods çš„ <code>Spec Repo</code> æœ¬è´¨ä¸Šæ˜¯ Git ä»“åº“ï¼Œè€Œ Git åœ¨åšå˜æ›´ç®¡ç†çš„æ—¶å€™ï¼Œä¼šè®°å½•ç›®å½•çš„å˜æ›´ï¼Œæ¯ä¸ªå­ç›®å½•éƒ½ä¼šå¯¹åº”ä¸€ä¸ª Git modelã€‚è€Œå½“ç›®å½•ä¸­çš„æ–‡ä»¶æ•°é‡è¿‡å¤šçš„æ—¶å€™ï¼ŒGit è¦æ‰¾å‡ºå¯¹åº”çš„å˜æ›´å°±å˜å¾—ååˆ†å›°éš¾ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹<a href="https://blog.cocoapods.org/Master-Spec-Repo-Rate-Limiting-Post-Mortem/#too-many-directory-entries">å®˜æ–¹è¯´æ˜</a>ã€‚</p>
<p>å¦å¤–å†è¡¥å……ä¸€ç‚¹ï¼Œåœ¨ Linux ä¸­æœ€ç»å…¸çš„ä¸€å¥è¯æ˜¯ï¼šã€Œ<strong>ä¸€åˆ‡çš†æ–‡ä»¶</strong>ã€ï¼Œä¸ä»…æ™®é€šçš„æ–‡ä»¶å’Œç›®å½•ï¼Œå°±è¿å—è®¾å¤‡ã€ç®¡é“ã€socket ç­‰ï¼Œä¹Ÿéƒ½æ˜¯ç»Ÿä¸€äº¤ç»™æ–‡ä»¶ç³»ç»Ÿç®¡ç†çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å°±ç®—ä¸ç”¨ Git æ¥ç®¡ç† Specs ä»“åº“ï¼Œå½“ç›®å½•ä¸‹å­˜åœ¨æ•°ä»¥ä¸‡è®¡çš„æ–‡ä»¶æ—¶ï¼Œå¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚</p>
<blockquote>
<p>Tipsï¼šå…³äºæ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹<a href="https://www.wikiwand.com/en/Filesystem_Hierarchy_Standard">FHS æ ‡å‡†</a>ï¼Œä»¥åŠçŸ¥ä¹è¿™ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/183238194#tocbar--13f51dj">ä¼ é€é—¨</a></p>
</blockquote>
<p>å›åˆ° CocoaPodsï¼Œå¦‚ä½•å¯¹ Master ä»“åº“ç›®å½•è¿›è¡Œåˆ†ç‰‡å°±æ¶‰åŠåˆ° Metadata ç±»ä¸­çš„å…³é”®æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">path_fragment</span><span class="p">(</span><span class="n">pod_name</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">prefixes</span> <span class="o">=</span> <span class="k">if</span> <span class="n">prefix_lengths</span><span class="o">.</span><span class="n">empty?</span>
               <span class="o">[]</span>
             <span class="k">else</span>
               <span class="n">hashed</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">pod_name</span><span class="p">)</span>
               <span class="n">prefix_lengths</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">length</span><span class="o">|</span>
                 <span class="n">hashed</span><span class="o">.</span><span class="n">slice!</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
               <span class="k">end</span>
             <span class="k">end</span>
  <span class="n">prefixes</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">[</span><span class="n">pod_name</span><span class="p">,</span> <span class="n">version</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">compact</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><code>#path_fragment</code> ä¼šä¾æ® pod_name å’Œ version æ¥ç”Ÿæˆ pod å¯¹åº”çš„ç´¢å¼•ç›®å½•ï¼š</p>
<ol>
<li>é¦–å…ˆå¯¹ pod_name è¿›è¡Œ MD5 è®¡ç®—è·å–æ‘˜è¦ï¼›</li>
<li>éå† <code>prefix_lengths</code> å¯¹ç”Ÿæˆçš„æ‘˜è¦ä¸æ–­æˆªå–æŒ‡å®šçš„é•¿åº¦ä½œä¸ºæ–‡ä»¶ç´¢å¼•ã€‚</li>
</ol>
<p>ä»¥ <code>AFNetworking</code> ä¸ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="err">$</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="s1">&#39;AFNetworking&#39;</span><span class="p">)</span>
<span class="s2">&#34;a75d452377f3996bdc4b623a5df25820&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>ç”±äºæˆ‘ä»¬çš„ <code>prefix_lengths</code> ä¸º <code>[1, 1, 1]</code> æ•°ç»„ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šä»å·¦åˆ°å³ä¾æ¬¡æˆªå–å‡ºä¸€ä¸ªå­—æ¯ï¼Œå³ï¼š <code>a</code>ã€<code>7</code>ã€<code>5</code> ï¼Œè¿™ä¸‰ä¸ªå­—æ¯ä½œä¸ºç´¢å¼•ç›®å½•ï¼Œå®ƒæ­£å¥½ç¬¦åˆæˆ‘ä»¬ ğŸ‘† ç›®å½•ç»“æ„å›¾ä¸­ AFNetworking çš„æ‰€åœ¨ä½ç½®ã€‚</p>
<h2 id="versions">Versions</h2>
<p>è¦æ‰¾åˆ° <code>Podfile</code> ä¸­é™å®šç‰ˆæœ¬å·èŒƒå›´çš„ <code>PodSpec</code> æ–‡ä»¶è¿˜éœ€è¦éœ€è¦æœ€åä¸€æ­¥ï¼Œè·å–å½“å‰å·²å‘å¸ƒçš„ Versions åˆ—è¡¨ï¼Œå¹¶é€šè¿‡æ¯”è¾ƒ Version å¾—å‡ºæœ€ç»ˆæ‰€éœ€çš„ <code>PodSpec</code> æ–‡ä»¶ã€‚</p>
<p>åœ¨ä¸Šä¸€æ­¥å·²é€šè¿‡ <code>metadata</code> å’Œ <code>pod_name</code> è®¡ç®—å‡º <code>pod</code> æ‰€åœ¨ç›®å½•ï¼Œæ¥ç€å°±æ˜¯æ‰¾åˆ° <code>pod</code> ç›®å½•ä¸‹çš„ Versions åˆ—è¡¨ï¼š</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqytgamj222g0qcaq8.jpg" alt="03-versons-folder"></p>
<p>è·å– Versionsï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">versions</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">specs_dir</span>
  <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s1">&#39;No name&#39;</span> <span class="k">unless</span> <span class="nb">name</span>
  <span class="n">pod_dir</span> <span class="o">=</span> <span class="n">pod_path</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">unless</span> <span class="n">pod_dir</span><span class="o">.</span><span class="n">exist?</span>
  <span class="vi">@versions_by_name</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">||=</span> <span class="n">pod_dir</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">to_s</span>
    <span class="k">begin</span>
      <span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">directory?</span> <span class="o">&amp;&amp;</span> <span class="n">basename</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">rescue</span> <span class="no">ArgumentError</span>
    <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="s1">&#39;An unexpected version directory ...&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">reverse</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è¯¥æ–¹æ³•é‡ç‚¹åœ¨äºå°† <code>pod_dir</code> ä¸‹çš„æ¯ä¸ªç›®å½•éƒ½è½¬æ¢æˆä¸ºäº† <strong>Version</strong> ç±»å‹ï¼Œå¹¶åœ¨æœ€åè¿›è¡Œäº† sort æ’åºã€‚</p>
<blockquote>
<p><code>#versions</code> æ–¹æ³•ä¸»è¦åœ¨ <code>pod search</code> å‘½ä»¤ä¸­è¢«è°ƒç”¨ï¼Œåç»­ä¼šä»‹ç»ã€‚</p>
</blockquote>
<p>æ¥æ‚ä¸€çœ¼ Version ç±»ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Version</span> <span class="o">&lt;</span> <span class="no">Pod</span><span class="o">::</span><span class="no">Vendor</span><span class="o">::</span><span class="no">Gem</span><span class="o">::</span><span class="no">Version</span>
  <span class="no">METADATA_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;(\+[0-9a-zA-Z\-\.]+)&#39;</span>
  <span class="no">VERSION_PATTERN</span> <span class="o">=</span> <span class="s2">&#34;[0-9]+(</span><span class="se">\\</span><span class="s2">.[0-9a-zA-Z</span><span class="se">\\</span><span class="s2">-]+)*</span><span class="si">#{</span><span class="no">METADATA_PATTERN</span><span class="si">}</span><span class="s2">?&#34;</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è¯¥ Version ç»§æ‰¿äº <a href="https://www.rubydoc.info/github/rubygems/rubygems/Gem/Version">Gem::Version</a> å¹¶å¯¹å…¶è¿›è¡Œäº†æ‰©å±•ï¼Œå®ç°äº†è¯­ä¹‰åŒ–ç‰ˆæœ¬å·çš„æ ‡å‡†ï¼Œsort æ’åºä¹Ÿæ˜¯åŸºäºè¯­ä¹‰åŒ–çš„ç‰ˆæœ¬æ¥æ¯”è¾ƒçš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç¨å¾®å±•å¼€ä¸€ä¸‹ã€‚</p>
<h3 id="semantic-versioning">Semantic Versioning</h3>
<p>è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼ˆ<a href="https://semver.org/">Semantic Versioning</a> ç®€ç§°ï¼šSemVerï¼‰ç»å¯¹æ˜¯ä¾èµ–ç®¡ç†å·¥å…·ç»•ä¸å¼€çš„åã€‚<strong>è¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å°±æ˜¯è®©ç‰ˆæœ¬å·æ›´å…·è¯­ä¹‰åŒ–ï¼Œå¯ä»¥ä¼ è¾¾å‡ºå…³äºè½¯ä»¶æœ¬èº«çš„ä¸€äº›é‡è¦ä¿¡æ¯è€Œä¸åªæ˜¯ç®€å•çš„ä¸€ä¸²æ•°å­—ã€‚</strong> æˆ‘ä»¬æ¯æ¬¡å¯¹ Pod ä¾èµ–è¿›è¡Œæ›´æ–°ï¼Œæœ€åæœ€é‡è¦çš„ä¸€æ­¥å°±æ˜¯æ›´æ–°æ­£ç¡®çš„ç‰ˆæœ¬å·ï¼Œä¸€æ—¦å‘å¸ƒå‡ºå»ï¼Œå†è¦æ›´æ”¹å°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚</p>
<blockquote>
<p><a href="https://github.com/semver/semver">SemVer</a> æ˜¯ç”± Tom Preston-Werner å‘èµ·çš„ä¸€ä¸ªå…³äºè½¯ä»¶ç‰ˆæœ¬å·çš„å‘½åè§„èŒƒï¼Œè¯¥ä½œè€…ä¸º Gravatars åˆ›åŠè€…åŒæ—¶ä¹Ÿæ˜¯ GitHub è”åˆåˆ›å§‹äººã€‚</p>
</blockquote>
<p>é‚£ä»€ä¹ˆæ˜¯è¯­ä¹‰åŒ–ç‰ˆæœ¬å·æœ‰ä»€ä¹ˆç‰¹åˆ«å‘¢ ï¼Ÿæˆ‘ä»¬ä»¥ AFNetworking çš„ <strong>release tag</strong> ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">3.0.0
3.0.0-beta.1
3.0.0-beta.2
3.0.0-beta.3
3.0.1
</code></pre></td></tr></table>
</div>
</div><p>è¿™äº› tags å¹¶ééšæ„é€’å¢çš„ï¼Œå®ƒä»¬èƒŒåæ­£æ˜¯éµå¾ªäº†è¯­ä¹‰åŒ–ç‰ˆæœ¬çš„æ ‡å‡†ã€‚</p>
<p><strong>åŸºæœ¬è§„åˆ™</strong></p>
<ul>
<li>è½¯ä»¶çš„ç‰ˆæœ¬é€šå¸¸ç”±ä¸‰ä½ç»„æˆï¼Œå¦‚ï¼šX.Y.Zã€‚</li>
<li>ç‰ˆæœ¬æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œ</li>
<li>åœ¨å‘å¸ƒé‡è¦ç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥å‘å¸ƒ alpha, rc ç­‰å…ˆè¡Œç‰ˆæœ¬ï¼Œ</li>
<li>alpha å’Œ rc ç­‰ä¿®é¥°ç‰ˆæœ¬çš„å…³é”®å­—åé¢å¯ä»¥å¸¦ä¸Šæ¬¡æ•°å’Œ meta ä¿¡æ¯ï¼Œ</li>
</ul>
<p><strong>ç‰ˆæœ¬æ ¼å¼ï¼š</strong></p>
<blockquote>
<p>ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢å·</p>
</blockquote>
<p>ç‰ˆæœ¬å·é€’å¢è§„åˆ™å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="o">|</span> <span class="no">Code</span> <span class="n">status</span>        <span class="o">|</span> <span class="no">Stage</span>                  <span class="o">|</span> <span class="no">Example</span> <span class="n">version</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">------------------</span> <span class="o">|</span> <span class="o">----------------------</span> <span class="o">|</span> <span class="o">---------------</span> <span class="o">|</span>
<span class="o">|</span> <span class="err">æ–°å“é¦–å‘</span>             <span class="o">|</span> <span class="err">ä»</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="err">å¼€å§‹</span>           <span class="o">|</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>           <span class="o">|</span>
<span class="o">|</span> <span class="err">å‘åå…¼å®¹çš„</span> <span class="no">BugFix</span>    <span class="o">|</span> <span class="err">å¢åŠ è¡¥ä¸å·</span> <span class="n">Z</span>             <span class="o">|</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>           <span class="o">|</span>
<span class="o">|</span> <span class="err">å‘åå…¼å®¹çš„</span> <span class="no">Feature</span>   <span class="o">|</span> <span class="err">å¢åŠ æ¬¡ç‰ˆæœ¬å·</span> <span class="n">Y</span>           <span class="o">|</span> <span class="mi">1</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span>           <span class="o">|</span>
<span class="o">|</span> <span class="err">å‘åä¸å…¼å®¹çš„æ”¹åŠ¨</span>      <span class="o">|</span> <span class="err">å¢åŠ ä¸»ç‰ˆæœ¬å·</span> <span class="n">X</span>           <span class="o">|</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>           <span class="o">|</span>
<span class="o">|</span> <span class="err">é‡è¦ç‰ˆæœ¬çš„é¢„è§ˆç‰ˆ</span>      <span class="o">|</span> <span class="err">è¡¥ä¸å·åæ·»åŠ </span> <span class="n">alpha</span><span class="p">,</span> <span class="n">rc</span>   <span class="o">|</span> <span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="mi">0</span>      <span class="o">|</span>
</code></pre></td></tr></table>
</div>
</div><p>å…³äº CocoaPods çš„ Version ä½¿ç”¨æè¿°ï¼Œ<a href="https://guides.cocoapods.org/using/the-podfile.html#specifying-pod-versions">ä¼ é€é—¨</a>ã€‚</p>
<h2 id="cdnsource">CDNSource</h2>
<p>CocoaPods åœ¨ 1.7.2 ç‰ˆæœ¬æ­£å¼å°† Master ä»“åº“æ‰˜ç®¡åˆ° Netlify çš„ CDN ä¸Šï¼Œå½“æ—¶å…³äºå¦‚ä½•æ”¯æŒè¿™ä¸€ç‰¹æ€§çš„æ–‡ç« å’Œè¯´æ˜é“ºå¤©ç›–åœ°ï¼Œè¿™é‡Œè¿˜æ˜¯æ¨èå¤§å®¶çœ‹<a href="https://blog.cocoapods.org/CocoaPods-1.7.2/">å®˜æ–¹è¯´æ˜</a>ã€‚å¦å¤–ï¼Œå½“æ—¶æ„Ÿå—æ˜¯ä¼¼ä¹å›½å†…çš„éƒ¨åˆ† iOS åŒå­¦éƒ½ç‚¸äº†ï¼Œå„ç§æ ‡é¢˜å…šï¼š<em>ä»€ä¹ˆæœ€å®Œç¾çš„å‡çº§</em>ç­‰ç­‰ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œæ˜ç¡®ä¸€ä¸‹ï¼Œå¯¹äº CocoaPods çš„ Master ä»“åº“æ”¯æŒäº† CDN çš„è¡Œä¸ºï¼Œä»…è§£å†³äº†ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>åˆ©ç”¨ CDN èŠ‚ç‚¹çš„å…¨çƒåŒ–éƒ¨ç½²è§£å†³å†…å®¹åˆ†å‘æ…¢ï¼Œæé«˜ Specs èµ„æºçš„ä¸‹è½½é€Ÿåº¦ã€‚</li>
<li>é€šè¿‡ Specs æŒ‰éœ€ä¸‹è½½æ‘†è„±äº†åŸæœ‰ Git Repo æ¨¡å¼ä¸‹æœ¬åœ°ä»“åº“çš„ç£ç›˜å ç”¨è¿‡å¤§ï¼Œæ“ä½œå¡çš„é—®é¢˜ã€‚</li>
</ol>
<p>ç„¶è€Œï¼Œ<strong>ä»…ä»…å¯¹ <code>PodSpec</code> å¢åŠ äº† CDN æ ¹æœ¬æ²¡èƒ½è§£å†³ GFW å¯¼è‡´çš„ Github æºç æ ¡éªŒã€æ›´æ–°ã€ä¸‹è½½æ…¢çš„é—®é¢˜ã€‚</strong> åªèƒ½è¯´è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ã€‚</p>
<blockquote>
<p>PSï¼šä½œä¸º iOS å·¥ç¨‹å¸ˆï¼Œå°±ç»å¸¸è¢«å‰ç«¯åŒå­¦ ğŸ˜’ ã€‚ä½ çœ‹è¿™ CocoaPods ä¹Ÿå¤ªåƒåœ¾äº†å§ï¼ï¼ï¼ä¸€æ—¦åˆ æ‰ <code>Pods</code> ç›®å½•é‡æ–° install å°±å¡åŠå¤©ï¼Œç¼“å­˜åŸºæœ¬ä¸ç”Ÿæ•ˆï¼Œå“ªåƒ npm å¤šå¿« balabala &hellip;</p>
</blockquote>
<p>å…ˆæ¥çœ‹ CDNSource ç»“æ„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;cocoapods-core/source&#39;</span>
<span class="c1"># ...</span>
<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">CDNSource</span> <span class="o">&lt;</span> <span class="no">Source</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
      <span class="c1"># æ ‡è®°æ˜¯å¦æ­£åœ¨åŒæ­¥æ–‡ä»¶</span>
      <span class="vi">@check_existing_files_for_update</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="c1"># è®°å½•æ—¶é—´ç”¨äºå¯¹æ¯”ä¸‹è½½æ–‡ä»¶çš„æ–°æ—§ç¨‹åº¦ï¼Œä»¥ç¡®è®¤æ˜¯å¦éœ€è¦æ›´æ–°ä¿å­˜æ‰€ä¸‹çš„èµ„æº</span>
      <span class="vi">@startup_time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span>
      <span class="c1"># ç¼“å­˜æŸ¥è¯¢è¿‡çš„ PodSpec èµ„æº</span>
      <span class="vi">@version_arrays_by_fragment_by_name</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">super</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">url</span>
      <span class="vi">@url</span> <span class="o">||=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.url&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">type</span>
      <span class="s1">&#39;CDN&#39;</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>Source ç±»æ˜¯åŸºäº Github Repo æ¥åŒæ­¥æ›´æ–° <code>PodSpec</code>ï¼Œè€Œ CDNSource åˆ™æ˜¯åŸºäº CDN æœåŠ¡æ‰€è¿”å›çš„ Responseï¼Œå› æ­¤å°† Source ç±»çš„å¤§éƒ¨åˆ†æ–¹æ³•é‡å†™äº†ä¸€ä¸ªéï¼Œå…·ä½“ä¼šåœ¨ SourceManager ä¸€èŠ‚æ¥å±•å¼€ã€‚</p>
<p>æœ€åçœ‹ä¸€ä¸‹ <code>TrunkSource</code> ç±»ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">TrunkSource</span> <span class="o">&lt;</span> <span class="no">CDNSource</span>
    <span class="c1"># æ–°ç‰ˆè½ç›˜åä»“åº“åç§°</span>
    <span class="no">TRUNK_REPO_NAME</span> <span class="o">=</span> <span class="s1">&#39;trunk&#39;</span><span class="o">.</span><span class="n">freeze</span>

    <span class="no">TRUNK_REPO_URL</span> <span class="o">=</span> <span class="s1">&#39;https://cdn.cocoapods.org/&#39;</span><span class="o">.</span><span class="n">freeze</span>

    <span class="k">def</span> <span class="nf">url</span>
      <span class="vi">@url</span> <span class="o">||=</span> <span class="no">TRUNK_REPO_URL</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>æ ¸å¿ƒå°±æ˜¯é‡å†™äº†è¿”å›çš„ <code>url</code>ï¼Œç”±äºæ—§ç‰ˆ Spec ä»“åº“åç§°ä¸º <code>master</code> ä¸ºäº†åŠ ä»¥åŒºåˆ†ï¼ŒCDN ä»“åº“åˆ™æ”¹åä¸º <code>trunk</code>ã€‚</p>
<h1 id="source-manager">Source Manager</h1>
<p><code>Manager</code> ä½œä¸º source çš„ç®¡ç†ç±»ï¼Œå…¶ä¸»è¦ä»»åŠ¡ä¸º source çš„æ·»åŠ å’Œè·å–ï¼Œè€Œå¯¹ <code>PodSpec</code> æ–‡ä»¶çš„æ›´æ–°å’ŒæŸ¥æ‰¾è¡Œä¸ºåˆ™äº¤ç”± source å„è‡ªå®ç°ã€‚ä¸è¿‡ç”±äºä¸€ä¸ª <code>pod</code> åº“å¯èƒ½å¯¹åº”å¤šä¸ªä¸åŒçš„ sourceï¼Œè¿™é‡Œåˆäº§ç”Ÿå‡º <code>Aggregate</code> ç±»æ¥ç»Ÿä¸€ <code>PodSpec</code> çš„æŸ¥è¯¢ã€‚</p>
<p>å®ƒä»¬çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqz51cgj20ow0bijrw.jpg" alt="04-manager"></p>
<p>Manager å®ç°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Source</span>
    <span class="k">class</span> <span class="nc">Manager</span>
      <span class="kp">attr_reader</span> <span class="ss">:repos_dir</span>

      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">repos_dir</span><span class="p">)</span>
        <span class="vi">@repos_dir</span> <span class="o">=</span> <span class="no">Pathname</span><span class="p">(</span><span class="n">repos_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expand_path</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">source_repos</span>
        <span class="k">return</span> <span class="o">[]</span> <span class="k">unless</span> <span class="n">repos_dir</span><span class="o">.</span><span class="n">exist?</span>
        <span class="n">repos_dir</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:directory?</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">aggregate</span>
        <span class="n">aggregate_with_repos</span><span class="p">(</span><span class="n">source_repos</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">aggregate_with_repos</span><span class="p">(</span><span class="n">repos</span><span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">repos</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span> <span class="n">source_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">}</span>
        <span class="vi">@aggregates_by_repos</span> <span class="o">||=</span> <span class="p">{}</span>
        <span class="vi">@aggregates_by_repos</span><span class="o">[</span><span class="n">repos</span><span class="o">]</span> <span class="o">||=</span> <span class="no">Source</span><span class="o">::</span><span class="no">Aggregate</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">all</span>
        <span class="n">aggregate</span><span class="o">.</span><span class="n">sources</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>Manager ç±»çš„åˆå§‹åŒ–ä»…éœ€è¦ä¼ å…¥å½“å‰ repos ç›®å½•ï¼Œå³ <code>~/.cocoapods/repos</code>ï¼Œè€Œ Aggregate çš„ç”Ÿæˆåˆ™ä¿å­˜ <code>repos_dir</code> äº†ç›®å½•ä¸‹çš„ Sourceï¼Œç”¨äºåç»­å¤„ç†ã€‚</p>
<p>å…ˆçœ‹ Source çš„ç”Ÿæˆï¼Œåœ¨ <code>#source_from_path</code> ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">source_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="vi">@sources_by_path</span> <span class="o">||=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span>
    <span class="nb">hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="k">case</span>
                <span class="k">when</span> <span class="n">key</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="no">Pod</span><span class="o">::</span><span class="no">TrunkSource</span><span class="o">::</span><span class="no">TRUNK_REPO_NAME</span>
                  <span class="no">TrunkSource</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">when</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.url&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exist?</span>
                  <span class="no">CDNSource</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">else</span>
                  <span class="no">Source</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">end</span>
  <span class="k">end</span>
  <span class="vi">@sources_by_path</span><span class="o">[</span><span class="n">path</span><span class="o">]</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»¥ <code>repos_dir</code> ä¸‹çš„ç›®å½•åç§°æ¥åŒºåˆ†ç±»å‹ï¼Œè€Œ CDNSource åˆ™éœ€è¦ç¡®ä¿å…¶ç›®å½•ä¸‹å­˜åœ¨åä¸º <code>.url</code> çš„æ–‡ä»¶ã€‚åŒæ—¶ä¼šå¯¹ç”Ÿæˆçš„ source è¿›è¡Œç¼“å­˜ã€‚</p>
<p>æœ€åçœ‹ Aggregate ç»“æ„ï¼Œæ ¸å¿ƒå°±ä¸¤ä¸ª search æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Source</span>
    <span class="k">class</span> <span class="nc">Aggregate</span>
      <span class="kp">attr_reader</span> <span class="ss">:sources</span>

      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
        <span class="k">raise</span> <span class="s2">&#34;Cannot initialize an aggregate with a nil source: (</span><span class="si">#{</span><span class="n">sources</span><span class="si">}</span><span class="s2">)&#34;</span> <span class="k">if</span> <span class="n">sources</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
        <span class="vi">@sources</span> <span class="o">=</span> <span class="n">sources</span>
      <span class="k">end</span>
      <span class="c1"># æŸ¥è¯¢ä¾èµ–å¯¹åº”çš„ specs</span>
      <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span> <span class="o">...</span> <span class="k">end</span>
       
      <span class="c1"># æŸ¥è¯¢æŸä¸ª pod ä»¥å‘å¸ƒçš„ specs</span>
      <span class="k">def</span> <span class="nf">search_by_name</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">full_text_search</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span> <span class="o">...</span> <span class="k">end</span>
        
      <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="source-æºèµ·">Source æºèµ·</h2>
<p>æœ¬èŠ‚æˆ‘ä»¬æ¥è°ˆè°ˆ source æ˜¯å¦‚ä½•æ·»åŠ åˆ° <code>repo_dir</code> ç›®å½•ä¸‹çš„ã€‚</p>
<p>ç”±å‰é¢çš„ä»‹ç»å¯çŸ¥ï¼Œæ¯ä¸ª source ä¸­è‡ªå¸¦ <strong>url</strong>ï¼Œåœ¨ Source ç±»ä¸­ url è¯»å–è‡ª Git ä»“åº“çš„ <code>remote.origin.url</code> æˆ–æœ¬åœ° <code>.git</code> ç›®å½•ï¼Œè€Œåœ¨ CDNSource ä¸­ url åˆ™æ˜¯è¯»å–è‡ªå½“å‰ç›®å½•ä¸‹çš„  <code>.url</code> æ–‡ä»¶æ‰€ä¿å­˜çš„ URL åœ°å€ã€‚</p>
<p>é‚£ CDNSource çš„  <strong><code>.url</code> æ–‡ä»¶æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«å†™å…¥çš„å‘¢ ï¼Ÿ</strong></p>
<p>è¿™éœ€è¦ä» <code>Podfile</code> è¯´èµ·ã€‚å¾ˆå¤šè€é¡¹ç›®çš„ <code>Podfile</code> å¼€å¤´éƒ¨åˆ†å¤§éƒ½ä¼šæœ‰ä¸€è¡Œæˆ–å¤šè¡Œ source å‘½ä»¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">source</span> <span class="s1">&#39;https://github.com/CocoaPods/Specs.git&#39;</span>
<span class="n">source</span> <span class="s1">&#39;https://github.com/artsy/Specs.git&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>ç”¨äºæŒ‡å®šé¡¹ç›®ä¸­ <code>PodSpec</code> çš„æŸ¥æ‰¾æºï¼Œè¿™äº›æŒ‡å®šæºæœ€ç»ˆä¼šä¿å­˜åœ¨ <code>~/.cocoapods/repos</code> ç›®å½•ä¸‹çš„ä»“åº“ã€‚</p>
<p>å½“æ•²ä¸‹ <code>pod install</code> å‘½ä»¤åï¼Œåœ¨ <code>#resolve_dependencies</code> é˜¶æ®µçš„ä¾èµ–åˆ†æä¸­å°†åŒæ—¶å®Œæˆ sources çš„åˆå§‹åŒ–ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0unhnc6tj20ow0bit9k.jpg" alt="01-pod-install"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods/installer/analyzer.rb</span>

<span class="k">def</span> <span class="nf">sources</span>
  <span class="vi">@sources</span> <span class="o">||=</span> <span class="k">begin</span>
    <span class="c1"># çœç•¥è·å– podfileã€pluginsã€dependencies çš„ source url ...</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="o">...</span>
     
    <span class="n">result</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">source_url</span><span class="o">|</span>
      <span class="n">sources_manager</span><span class="o">.</span><span class="n">find_or_create_source_with_url</span><span class="p">(</span><span class="n">source_url</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">unless</span> <span class="n">plugin_sources</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">result</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">plugin_sources</span><span class="p">)</span>
      <span class="n">plugin_sources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="o">|</span>
        <span class="n">sources_manager</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">result</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è·å– sources url ä¹‹åä¼šé€šè¿‡ <code>sources_manager</code> æ¥å®Œæˆ source æ›´æ–°ï¼Œé€»è¾‘åœ¨ CocoaPods é¡¹ç›®çš„ Manager æ‰©å±•ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods/sources_manager.rb</span>

<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Source</span>
    <span class="k">class</span> <span class="nc">Manager</span>

      <span class="k">def</span> <span class="nf">find_or_create_source_with_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">source_with_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">||</span> <span class="n">create_source_with_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">create_source_with_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="nb">name</span> <span class="o">=</span> <span class="n">name_for_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">is_cdn</span> <span class="o">=</span> <span class="n">cdn_url?</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
		  <span class="c1"># ...</span>
        <span class="k">begin</span>
          <span class="k">if</span> <span class="n">is_cdn</span>
            <span class="no">Command</span><span class="o">::</span><span class="no">Repo</span><span class="o">::</span><span class="no">AddCDN</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="o">[</span><span class="nb">name</span><span class="p">,</span> <span class="n">url</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">run</span>
          <span class="k">else</span>
            <span class="no">Command</span><span class="o">::</span><span class="no">Repo</span><span class="o">::</span><span class="no">Add</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="o">[</span><span class="nb">name</span><span class="p">,</span> <span class="n">url</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">run</span>
          <span class="k">end</span>
        <span class="k">rescue</span> <span class="no">Informative</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="c1"># ...</span>
        <span class="k">ensure</span>
          <span class="no">UI</span><span class="o">.</span><span class="n">title_level</span> <span class="o">=</span> <span class="n">previous_title_level</span>
        <span class="k">end</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">source_with_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">raise</span> <span class="s2">&#34;Unable to create a source with URL </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">unless</span> <span class="n">source</span>
        <span class="n">source</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>æŸ¥æ‰¾ä¼šå…ˆè°ƒç”¨ <code>#source_with_url</code> è¿›è¡Œç¼“å­˜æŸ¥è¯¢ï¼Œå¦‚æœªå‘½ä¸­åˆ™ä¼šå…ˆä¸‹è½½ Source ä»“åº“ï¼Œç»“æŸåé‡åˆ· aggreate ä»¥æ›´æ–° sourceã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods-core/source/manager.rb</span>

<span class="k">def</span> <span class="nf">source_with_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="n">url</span> <span class="o">=</span> <span class="n">canonic_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/cocoapods/specs&#39;</span> <span class="k">if</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">%r{github.com[:/]+cocoapods/specs}</span>
  <span class="n">all</span><span class="o">.</span><span class="n">find</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="o">|</span>
    <span class="n">source</span><span class="o">.</span><span class="n">url</span> <span class="o">&amp;&amp;</span> <span class="n">canonic_url</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="o">==</span> <span class="n">url</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">canonic_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="n">url</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\.git$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">%r{\/$}</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦å¤–ï¼Œä»“åº“çš„ä¸‹è½½çš„åˆ™ä¼šé€šè¿‡ <code>#cdn_url?</code> æ–¹æ³•åŒºåˆ†ï¼Œæœ€åçš„ä¸‹è½½åˆ™ ğŸ“¦ åœ¨ä¸¤ä¸ªå‘½ä»¤ç±»ä¸­ï¼Œæ¦‚æ‹¬å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>Command::Repo::AddCDN</strong>ï¼šå³  <code>pod repo add-cdn</code> å‘½ä»¤ï¼Œä»…æœ‰çš„æ“ä½œæ˜¯å°† url å†™å…¥ <code>.url</code> æ–‡ä»¶ä¸­ã€‚</li>
<li><strong>Command::Repo::Add</strong>ï¼šå³ <code>pod repo add</code> å‘½ä»¤ï¼Œå¯¹äºæ™®é€šç±»å‹çš„ Source ä»“åº“ä¸‹è½½æœ¬è´¨å°±æ˜¯ <code>git clone</code> æ“ä½œã€‚</li>
</ul>
<p>ç®€åŒ–åæºçš„æ·»åŠ æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqzivvpj20ow0bi3z8.jpg" alt="05-source-add"></p>
<h2 id="podspec-æŸ¥è¯¢">PodSpec æŸ¥è¯¢</h2>
<p>åŒæ ·åœ¨ <code>#resolve_dependencies</code> çš„ä¾èµ–ä»²è£é˜¶æ®µï¼Œå½“ <strong>Molinillo</strong> ä¾èµ–ä»²è£å¼€å§‹å‰ï¼Œä¼šè§¦å‘ç¼“å­˜æŸ¥è¯¢ <code>#find_cached_set</code> å¹¶æœ€ç»ˆè°ƒç”¨åˆ° Aggregate çš„ <code>#search</code>ã€‚å®Œæ•´è°ƒç”¨æ ˆæ”¾åœ¨ <a href="https://gist.github.com/looseyi/492b220ea7e933e972b65876e491886f">gist</a> ä¸Šã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>#search</code> å…¥å£ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods-core/source/aggregate.rb</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
  <span class="n">found_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">unless</span> <span class="n">found_sources</span><span class="o">.</span><span class="n">empty?</span>
    <span class="no">Specification</span><span class="o">::</span><span class="no">Set</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dependency</span><span class="o">.</span><span class="n">root_name</span><span class="p">,</span> <span class="n">found_sources</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>Aggregate å…ˆéå†å½“å‰ sources å¹¶è¿›è¡Œ dependency æŸ¥æ‰¾ã€‚ç”±äº Git ä»“åº“ä¿å­˜äº†å®Œæ•´çš„ PodSpecsï¼Œåªè¦èƒ½åœ¨åˆ†ç‰‡ç›®å½•ä¸‹æŸ¥è¯¢åˆ°å¯¹åº”æ–‡ä»¶å³å¯ï¼Œæœ€ç»ˆç»“æœä¼šå¡å…¥ <code>Specification::Set</code> è¿”å›ã€‚</p>
<blockquote>
<p>Specification::Set è®°å½•äº†å½“å‰ pod å…³è”çš„ Sourceï¼Œä¸€ä¸ª pod å¯èƒ½å­˜åœ¨ä¸å¤šä¸ªä¸åŒçš„ Spec ä»“åº“ ä¸­ã€‚</p>
</blockquote>
<h3 id="cdn-ä»“åº“æŸ¥è¯¢">CDN ä»“åº“æŸ¥è¯¢</h3>
<p>CDNSource é‡å†™äº† <code>#search</code> å®ç°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods-core/cdn_source.rb</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
  <span class="k">unless</span> <span class="n">specs_dir</span>
    <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="s2">&#34;Unable to find a source named: `</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">`&#34;</span>
  <span class="k">end</span>
  <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Dependency</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">root_name</span>
  <span class="k">end</span>

  <span class="n">fragment</span> <span class="o">=</span> <span class="n">pod_shard_fragment</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
  <span class="n">ensure_versions_file_loaded</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
  <span class="n">version_arrays_by_name</span> <span class="o">=</span> <span class="vi">@version_arrays_by_fragment_by_name</span><span class="o">[</span><span class="n">fragment</span><span class="o">]</span> <span class="o">||</span> <span class="p">{}</span>
   
  <span class="n">found</span> <span class="o">=</span> <span class="n">version_arrays_by_name</span><span class="o">[</span><span class="n">query</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">query</span>

  <span class="k">if</span> <span class="n">found</span>
    <span class="n">set</span> <span class="o">=</span> <span class="n">set</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">set</span> <span class="k">if</span> <span class="n">set</span><span class="o">.</span><span class="n">specification_name</span> <span class="o">==</span> <span class="n">query</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>é€»è¾‘ä¸¤æ­¥èµ°ï¼š</p>
<ol>
<li>é€šè¿‡ <code>#ensure_versions_file_loaded</code> æ£€æŸ¥ all_pods_versions æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šè¿›è¡Œä¸‹è½½æ“ä½œã€‚</li>
<li>å¦‚æœå½“å‰ source åŒ…å«æŸ¥è¯¢çš„ podï¼Œä¼šåˆ›å»º <code>Specification::Set</code> ä½œä¸ºæŸ¥è¯¢ç»“æœï¼Œå¹¶åœ¨ <code>#specification_name</code> æ–¹æ³•å†…å®Œæˆ <code>PodSpec</code> çš„æ£€æŸ¥å’Œä¸‹è½½ã€‚</li>
</ol>
<p><strong>0x01 all_pods_versions æ–‡ä»¶ä¸‹è½½</strong></p>
<p>ä¾æ®å‰é¢æåˆ°çš„åˆ†ç‰‡è§„åˆ™ä¼šå°† pod åç§° MD5 åˆ†å‰²åæ‹¼æˆ URLã€‚</p>
<p>ä»¥ <code>AFNetworking</code> ä¸ºä¾‹ï¼Œç» <code>#pod_shard_fragment</code> åˆ†å‰²åè·å–çš„ fragment ä¸º <code>[a, 7, 5]</code>ï¼Œåˆ™æ‹¼æ¥åçš„ URL ä¸º <a href="https://cdn.cocoapods.org/all_pods_versions_a_7_5.txt">https://cdn.cocoapods.org/all_pods_versions_a_7_5.txt</a>ï¼Œä¸‹è½½åçš„å†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">AFNetworking/0.10.0/0.10.1/.../4.0.1
AppseeAnalytics/2.4.7/2.4.8/2.4.8.0/...
DynamsoftBarcodeReader/7.1.0/...
...
</code></pre></td></tr></table>
</div>
</div><p>æ‰€åŒ…å«çš„è¿™äº› pod éƒ½æ˜¯åˆ†ç‰‡åå¾—åˆ°çš„ç›¸åŒçš„åœ°å€ï¼Œå› æ­¤ä¼šä¿å­˜åœ¨åŒä¸€ä»½ <code>all_pods_versions</code> ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">ensure_versions_file_loaded</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@version_arrays_by_fragment_by_name</span><span class="o">[</span><span class="n">fragment</span><span class="o">].</span><span class="n">nil?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="vi">@check_existing_files_for_update</span>

  <span class="n">index_file_name</span> <span class="o">=</span> <span class="n">index_file_name_for_fragment</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
  <span class="n">download_file</span><span class="p">(</span><span class="n">index_file_name</span><span class="p">)</span>
  <span class="n">versions_raw</span> <span class="o">=</span> <span class="n">local_file</span><span class="p">(</span><span class="n">index_file_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="ss">:to_a</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:chomp</span><span class="p">)</span>
  <span class="vi">@version_arrays_by_fragment_by_name</span><span class="o">[</span><span class="n">fragment</span><span class="o">]</span> <span class="o">=</span> <span class="n">versions_raw</span><span class="o">.</span><span class="n">reduce</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">row</span><span class="o">|</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">pod</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">shift</span>
    <span class="n">versions</span> <span class="o">=</span> <span class="n">row</span>

    <span class="nb">hash</span><span class="o">[</span><span class="n">pod</span><span class="o">]</span> <span class="o">=</span> <span class="n">versions</span>
    <span class="nb">hash</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">index_file_name_for_fragment</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
  <span class="n">fragment_joined</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
  <span class="n">fragment_joined</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fragment_joined</span> <span class="k">unless</span> <span class="n">fragment</span><span class="o">.</span><span class="n">empty?</span>
  <span class="s2">&#34;all_pods_versions</span><span class="si">#{</span><span class="n">fragment_joined</span><span class="si">}</span><span class="s2">.txt&#34;</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦å¤–æ¯ä¸€ä»½ pods_version éƒ½ä¼šå¯¹åº”ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ç”¨äºä¿å­˜ ETagï¼Œå…·ä½“ä¼šåœ¨ä¸‹ä¸€èŠ‚ä¼šä»‹ç»ã€‚</p>
<p><strong>0x02 PodSpec æ–‡ä»¶ä¸‹è½½</strong></p>
<p><code>#specification_name</code> å°†ä» <code>all_pods_versions</code> ç´¢å¼•æ–‡ä»¶ä¸­æ‰¾å‡ºè¯¥ pod æ‰€å‘å¸ƒçš„ç‰ˆæœ¬å·ï¼Œä¾æ¬¡æ£€æŸ¥ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ <code>PodSpec.json</code> æ–‡ä»¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Specification</span>
    <span class="k">class</span> <span class="nc">Set</span>
      <span class="kp">attr_reader</span> <span class="ss">:name</span>
      <span class="kp">attr_reader</span> <span class="ss">:sources</span>
      
      <span class="k">def</span> <span class="nf">specification_name</span>
        <span class="n">versions_by_source</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="p">,</span> <span class="n">versions</span><span class="o">|</span>
          <span class="k">next</span> <span class="k">unless</span> <span class="n">version</span> <span class="o">=</span> <span class="n">versions</span><span class="o">.</span><span class="n">first</span>
          <span class="k">return</span> <span class="n">source</span><span class="o">.</span><span class="n">specification</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">end</span>
        <span class="kp">nil</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">versions_by_source</span>
        <span class="vi">@versions_by_source</span> <span class="o">||=</span> <span class="n">sources</span><span class="o">.</span><span class="n">each_with_object</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="p">,</span> <span class="n">result</span><span class="o">|</span>
          <span class="n">result</span><span class="o">[</span><span class="n">source</span><span class="o">]</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">versions</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>ç»•äº†ä¸€åœˆåå›åˆ° Source çš„ <code>#versions</code> æ–¹æ³•ï¼Œç”±äº CDN Source ä¸ä¼šå…¨é‡ä¸‹è½½ pod çš„ PodSpec æ–‡ä»¶ï¼Œåœ¨ <a href="https://www.rubydoc.info/gems/cocoapods-core/Pod/CDNSource#versions-instance_method"><strong>#version</strong></a> çš„æ£€æŸ¥è¿‡ç¨‹ä¼šè¿›è¡Œä¸‹è½½æ“ä½œã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqzq5qoj20ow0bit9k.jpg" alt="08-cdn-search"></p>
<h3 id="pod-search-æŸ¥è¯¢å‘½ä»¤">Pod Search æŸ¥è¯¢å‘½ä»¤</h3>
<p>CocoaPods è¿˜æä¾›äº†å‘½ä»¤è¡Œå·¥å…· <code>cocoapods-search</code> ç”¨äºå·²å‘å¸ƒçš„ <code>PodSpec</code> æŸ¥æ‰¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ pod search <span class="sb">`</span>QUERY<span class="sb">`</span>
</code></pre></td></tr></table>
</div>
</div><p>å®ƒæä¾›äº† Web æŸ¥è¯¢å’Œæœ¬åœ°æŸ¥è¯¢ã€‚æœ¬åœ°æŸ¥è¯¢åˆ™ä¸åŒäº <code>#search</code>ï¼Œå®ƒéœ€è¦è°ƒç”¨ Aggregate çš„ <code>#search_by_name</code> ï¼Œå…¶å®ç°åŒ <code>#search</code> ç±»ä¼¼ï¼Œæœ€ç»ˆä¹Ÿä¼šèµ°åˆ° Source çš„ <a href="https://www.rubydoc.info/gems/cocoapods-core/Pod/Source/Aggregate#search_by_name-instance_method">#versions</a> æ–¹æ³•ã€‚</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tqzwo31j20ow0bigmc.jpg" alt="07-pod-search"></p>
<blockquote>
<p>æ³¨æ„ï¼ŒGti ä»“åº“çš„ <code>#search_by_name</code> æŸ¥è¯¢ä»æ—§ä¸ºæ–‡ä»¶æŸ¥æ‰¾ï¼Œä¸ä¼šè°ƒç”¨å…¶ <code>#versions</code> æ–¹æ³•ã€‚</p>
</blockquote>
<h2 id="repo-æ›´æ–°">Repo æ›´æ–°</h2>
<p><code>pod install</code> æ‰§è¡Œè¿‡ç¨‹å¦‚æœå¸¦ä¸Šäº† <code>--repo-update</code> å‘½ä»¤åˆ™åœ¨ <code>#resolve_dependencies</code> é˜¶æ®µä¼šè§¦å‘ <code>#update_repositories</code> æ›´æ–° Spec ä»“åº“ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods/installer/analyzer.rb</span>

<span class="k">def</span> <span class="nf">update_repositories</span>
  <span class="n">sources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">updateable?</span>
      <span class="n">sources_manager</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="no">UI</span><span class="o">.</span><span class="n">message</span> <span class="s2">&#34;Skipping ...&#34;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="vi">@specs_updated</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸è¿‡ <code>#update</code> çš„å®ç°é€»è¾‘åœ¨ CocoaPods é¡¹ç›®çš„ Manager æ‰©å±•ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods/sources_managers.rb</span>

<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">source_name</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">show_output</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">source_name</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="o">[</span><span class="n">updateable_source_named</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span><span class="o">]</span>
  <span class="k">else</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">updateable_sources</span>
  <span class="k">end</span>

  <span class="n">changed_spec_paths</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="c1"># Do not perform an update if the repos dir has not been setup yet.</span>
  <span class="k">return</span> <span class="k">unless</span> <span class="n">repos_dir</span><span class="o">.</span><span class="n">exist?</span>

  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">#{</span><span class="n">repos_dir</span><span class="si">}</span><span class="s2">/Spec_Lock&#34;</span><span class="p">,</span> <span class="no">File</span><span class="o">::</span><span class="no">CREAT</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
    <span class="n">f</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="no">File</span><span class="o">::</span><span class="no">LOCK_EX</span><span class="p">)</span>
    <span class="n">sources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="o">|</span>
      <span class="no">UI</span><span class="o">.</span><span class="n">section</span> <span class="s2">&#34;Updating spec repo `</span><span class="si">#{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">`&#34;</span> <span class="k">do</span>
        <span class="n">changed_source_paths</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">show_output</span><span class="p">)</span>
        <span class="n">changed_spec_paths</span><span class="o">[</span><span class="n">source</span><span class="o">]</span> <span class="o">=</span> <span class="n">changed_source_paths</span> <span class="k">if</span> <span class="n">changed_source_paths</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">source</span><span class="o">.</span><span class="n">verify_compatibility!</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">update_search_index_if_needed_in_background</span><span class="p">(</span><span class="n">changed_spec_paths</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>è·å–æŒ‡å®šåç§°çš„ sourceï¼Œå¯¹ aggregate è¿”å›çš„å…¨éƒ¨ sources è¿›è¡Œ filterï¼Œå¦‚æœªæŒ‡å®šåˆ™ sources å…¨é‡ã€‚</p>
</li>
<li>
<p>æŒ¨ä¸ªè°ƒç”¨ <code>source.update(show_output)</code>ï¼Œæ³¨æ„ Git å’Œ CDN ä»“åº“çš„æ›´æ–°æ–¹å¼çš„ä¸åŒã€‚</p>
</li>
</ol>
<h3 id="git-ä»“åº“æ›´æ–°">Git ä»“åº“æ›´æ–°</h3>
<p>Git ä»“åº“æ›´æ–°æœ¬è´¨å°±æ˜¯ Git æ“ä½œï¼Œå³ <code>git pull</code>ã€<code>git checkout</code> å‘½ä»¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">show_output</span><span class="p">)</span>
  <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">unchanged_github_repo?</span>
  <span class="n">prev_commit_hash</span> <span class="o">=</span> <span class="n">git_commit_hash</span>
  <span class="n">update_git_repo</span><span class="p">(</span><span class="n">show_output</span><span class="p">)</span>
  <span class="vi">@versions_by_name</span><span class="o">.</span><span class="n">clear</span>
  <span class="n">refresh_metadata</span>
  <span class="k">if</span> <span class="n">version</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">last_compatible_version</span><span class="p">(</span><span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">CORE_VERSION</span><span class="p">))</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&#34;v</span><span class="si">#{</span><span class="n">version</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="no">CoreUI</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&#34;Using the ...&#34;</span>
    <span class="n">repo_git</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">diff_until_commit_hash</span><span class="p">(</span><span class="n">prev_commit_hash</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><code>#update_git_repo</code> å°±æ˜¯ <code>git fetch</code> + <code>git reset --hard [HEAD]</code> çš„ç»“åˆä½“ï¼Œæ›´æ–°åä¼šè¿›è¡Œ cocoapods ç‰ˆæœ¬å…¼å®¹æ£€æŸ¥ï¼Œæœ€ç»ˆè¾“å‡º diff ä¿¡æ¯ã€‚</p>
<h3 id="cdn-ä»“åº“æ›´æ–°">CDN ä»“åº“æ›´æ–°</h3>
<p>Git ä»“åº“æ˜¯å¯ä»¥é€šè¿‡ Commit ä¿¡æ¯æ¥è¿›è¡Œå¢é‡æ›´æ–°ï¼Œé‚£ä»¥é™æ€èµ„æºæ–¹å¼ç¼“å­˜çš„ CDN ä»“åº“æ˜¯å¦‚ä½•æ›´æ–°æ•°æ®çš„å‘¢ ï¼Ÿ</p>
<p>åƒæµè§ˆå™¨æˆ–æœ¬åœ°ç¼“å­˜<strong>æœ¬è´¨æ˜¯åˆ©ç”¨ ETag æ¥è¿›è¡Œ Cache-Control</strong>ï¼Œå…³äº CDN ç¼“å­˜å¯ä»¥çœ‹è¿™ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/65722520">ä¼ é€é—¨</a>ã€‚</p>
<p>è€Œ ETag å°±æ˜¯ä¸€ä¸²å­—ç¬¦ï¼Œå†…å®¹é€šå¸¸æ˜¯æ•°æ®çš„å“ˆå¸Œå€¼ï¼Œç”±æœåŠ¡å™¨è¿”å›ã€‚é¦–æ¬¡è¯·æ±‚åä¼šåœ¨æœ¬åœ°ç¼“å­˜èµ·æ¥ï¼Œå¹¶åœ¨åç»­çš„è¯·æ±‚ä¸­æºå¸¦ä¸Š ETag æ¥ç¡®å®šç¼“å­˜æ˜¯å¦éœ€è¦æ›´æ–°ã€‚å¦‚æœ ETag å€¼ç›¸åŒï¼Œè¯´æ˜èµ„æºæœªæ›´æ”¹ï¼ŒæœåŠ¡å™¨ä¼šè¿”å› 304ï¼ˆNot Modifiedï¼‰å“åº”ç ã€‚</p>
<p>Core çš„å®ç°ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå®ƒä¼šå°†å„è¯·æ±‚æ‰€å¯¹åº”çš„ ETag ä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨ï¼š</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0tr05zbbj20y50d9wi9.jpg" alt="06-source-cdn"></p>
<p>âš ï¸ <strong>æ³¨æ„ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µ CDNSource ä»…ä»…æ˜¯æ›´æ–°å½“å‰ç›®å½•ä¸‹çš„ç´¢å¼•æ–‡ä»¶</strong>ï¼Œå³ <code>all_pods_versions_x_x_x.txt</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">_show_output</span><span class="p">)</span>
  <span class="vi">@check_existing_files_for_update</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">begin</span>
    <span class="n">preheat_existing_files</span>
  <span class="k">ensure</span>
    <span class="vi">@check_existing_files_for_update</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>
  <span class="o">[]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">preheat_existing_files</span>
  <span class="n">files_to_update</span> <span class="o">=</span> <span class="n">files_definitely_to_update</span> <span class="o">+</span> <span class="n">deprecated_local_podspecs</span> <span class="o">-</span> <span class="o">[</span><span class="s1">&#39;deprecated_podspecs.txt&#39;</span><span class="o">]</span>

  <span class="n">concurrent_requests_catching_errors</span> <span class="k">do</span>
    <span class="n">loaders</span> <span class="o">=</span> <span class="n">files_to_update</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
      <span class="n">download_file_async</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="no">Promises</span><span class="o">.</span><span class="n">zip_futures_on</span><span class="p">(</span><span class="no">HYDRA_EXECUTOR</span><span class="p">,</span> <span class="o">*</span><span class="n">loaders</span><span class="p">)</span><span class="o">.</span><span class="n">wait!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pod-repo-æ›´æ–°å‘½ä»¤">Pod Repo æ›´æ–°å‘½ä»¤</h3>
<p>CocoaPods å¯¹äº sources ä»“åº“çš„æ›´æ–°ä¹Ÿæä¾›äº†å‘½ä»¤è¡Œå·¥å…·ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ pod repo update <span class="sb">`</span><span class="o">[</span>NAME<span class="o">]</span><span class="sb">`</span>
</code></pre></td></tr></table>
</div>
</div><p>å…¶å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/cocoapods/command/repo/update.rb</span>

<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Command</span>
    <span class="k">class</span> <span class="nc">Repo</span> <span class="o">&lt;</span> <span class="no">Command</span>
      <span class="k">class</span> <span class="nc">Update</span> <span class="o">&lt;</span> <span class="no">Repo</span>
        <span class="k">def</span> <span class="nf">run</span>
          <span class="n">show_output</span> <span class="o">=</span> <span class="o">!</span><span class="n">config</span><span class="o">.</span><span class="n">silent?</span>
          <span class="n">config</span><span class="o">.</span><span class="n">sources_manager</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span> <span class="n">show_output</span><span class="p">)</span>
          <span class="n">exclude_repos_dir_from_backup</span>
        <span class="k">end</span>
        <span class="c1"># ...</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨å‘½ä»¤åˆå§‹åŒ–æ—¶ä¼šä¿å­˜æŒ‡å®šçš„ Source ä»“åº“åç§° <code>@name</code>ï¼Œæ¥ç€é€šè¿‡ Mixin çš„ <code>config</code> æ¥è·å– <code>sources_manager</code> è§¦å‘æ›´æ–°ã€‚</p>
<p>æœ€åç”¨ä¸€å¼ å›¾æ¥æ”¶å°¾ CocoaPods Workflowï¼š</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gk0uueca78j20ow0biwez.jpg" alt="09-cocoapods-flow"></p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>æœ€åä¸€ç¯‡ Core çš„åˆ†ææ–‡ç« ï¼Œé‡ç‚¹ä»‹ç»äº†å®ƒæ˜¯å¦‚ä½•ç®¡ç† <code>PodSpec</code> ä»“åº“ä»¥åŠ <code>PodSpec</code> æ–‡ä»¶çš„æ›´æ–°å’ŒæŸ¥æ‰¾ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š</p>
<ol>
<li>äº†è§£ Source Manager çš„å„ç§æ•°æ®ç»“æ„ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ç›¸äº’å…³ç³»ï¼Œå„ä¸ªç±»ä¹‹é—´å±…ç„¶éƒ½åšåˆ°äº†æƒè´£åˆ†æ˜ã€‚</li>
<li>é€šè¿‡å¯¹ Metadata çš„åˆ†æäº†è§£äº† Source ä»“åº“çš„æ¼”å˜è¿‡ç¨‹ï¼Œå¹¶å‰–æäº†å­˜åœ¨çš„é—®é¢˜ã€‚</li>
<li>æŒæ¡äº†å¦‚ä½•åˆ©ç”¨ CDN æ¥æ”¹é€ åŸæœ‰çš„ Git ä»“åº“ï¼Œä¼˜åŒ– PodSpec ä¸‹è½½é€Ÿåº¦ã€‚</li>
<li>å‘ç°åŸæ¥ CLI å·¥å…·ä¸ä»…ä»…å¯ä»¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œå†…éƒ¨è°ƒç”¨ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ã€‚</li>
</ol>
<h1 id="çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†">çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†</h1>
<p>è¿™é‡Œç½—åˆ—äº†äº”ä¸ªé—®é¢˜ç”¨æ¥è€ƒå¯Ÿä½ æ˜¯å¦å·²ç»æŒæ¡äº†è¿™ç¯‡æ–‡ç« ï¼Œå¦‚æœæ²¡æœ‰å»ºè®®ä½ åŠ å…¥<strong>æ”¶è—</strong>å†æ¬¡é˜…è¯»ï¼š</p>
<ol>
<li><code>PodSpecs</code> çš„èšåˆç±»æœ‰å“ªäº›ï¼Œå¯ä»¥é€šè¿‡å“ªäº›æ‰‹æ®µæ¥åŒºåˆ†ä»–ä»¬çš„ç±»å‹ ï¼Ÿ</li>
<li>è¯´è¯´ä½ å¯¹ <code>Aggregate</code> ç±»çš„ç†è§£ï¼Œä»¥åŠå®ƒçš„ä¸»è¦ä½œç”¨ ï¼Ÿ</li>
<li><code>Source</code> ç±»æ˜¯å¦‚ä½•æ›´æ–° <code>PodSpec</code> ï¼Ÿ</li>
<li>Core æ˜¯å¦‚ä½•å¯¹ä»“åº“è¿›è¡Œåˆ†ç‰‡çš„ï¼Œå®ƒçš„åˆ†ç‰‡æ–¹å¼æ˜¯å¦æ”¯æŒé…ç½® ï¼Ÿ</li>
<li>CDN ä»“åº“æ˜¯å¦‚ä½•æ¥æ›´æ–° <code>PodSpec</code> æ–‡ä»¶ ï¼Ÿ</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">åœŸåœŸEdmondæœ¨</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2020-11-06
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cocoapods/">CocoaPods</a>
          <a href="/tags/ios/">iOS</a>
          <a href="/tags/ruby/">Ruby</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/snowball/snowball-widgets/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">é›ªçƒ iOS Widget ä»é›¶åˆ°å£¹</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/post/sourcecode-cocoapods/05-cocoapods-podspec/">
            <span class="next-text nav-default">5. PodSpec æ–‡ä»¶åˆ†æ</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:chun574271939@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/looseyi" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/looseyi" class="iconfont icon-github" title="github"></a>
      <a href="https://www.weibo.com/foreverclp" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/tu-tu-edmondmu" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="http://looseyi.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019-12-11 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">åœŸåœŸEdmondæœ¨</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
