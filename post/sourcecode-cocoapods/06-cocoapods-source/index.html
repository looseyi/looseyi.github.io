<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>6. PodSpec 管理策略 - Aha Edmond</title>

  
  
  <meta name="description" content="本文目录 引子 本文是 Core 的最后一篇，它与另外两篇文章「Podfile 解析逻辑」和「PodSpec 文件分析」共同支撑起 CocoaPods 世界的骨架。CocoaPo" />
  <meta name="author" content="土土Edmond木" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-cocoapods/06-cocoapods-source/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="6. PodSpec 管理策略" />
<meta property="og:description" content="本文目录 引子 本文是 Core 的最后一篇，它与另外两篇文章「Podfile 解析逻辑」和「PodSpec 文件分析」共同支撑起 CocoaPods 世界的骨架。CocoaPo" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-cocoapods/06-cocoapods-source/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-11-06T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-11-06T00:00:00&#43;00:00" />


  
  <meta itemprop="name" content="6. PodSpec 管理策略">
<meta itemprop="description" content="本文目录 引子 本文是 Core 的最后一篇，它与另外两篇文章「Podfile 解析逻辑」和「PodSpec 文件分析」共同支撑起 CocoaPods 世界的骨架。CocoaPo"><meta itemprop="datePublished" content="2020-11-06T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-11-06T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6131">
<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="6. PodSpec 管理策略"/>
<meta name="twitter:description" content="本文目录 引子 本文是 Core 的最后一篇，它与另外两篇文章「Podfile 解析逻辑」和「PodSpec 文件分析」共同支撑起 CocoaPods 世界的骨架。CocoaPo"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2020-11-06</time>
      
      <span>土土Edmond木</span>
      
    </p>
    <h1>6. PodSpec 管理策略</h1>
  </header>
  <section class="post-content"><h1 id="本文目录">本文目录</h1>
<p><img src="https://ww1.sinaimg.cn/large/8157560cly1gmmerrqyzaj218w0ngwgr.jpg" alt="PodSpec 文件管理"></p>
<h1 id="引子">引子</h1>
<p>本文是 Core 的最后一篇，它与另外两篇文章「<a href="https://looseyi.github.io/post/sourcecode-cocoapods/04-cocoapods-podfile/"><strong>Podfile 解析逻辑</strong></a>」和「<a href="https://looseyi.github.io/post/sourcecode-cocoapods/05-cocoapods-podspec/"><strong>PodSpec 文件分析</strong></a>」共同支撑起 CocoaPods 世界的骨架。CocoaPods-Core 这个库之所以被命名为 Core 就是因为它包含了 <strong>Podfile -&gt; Spec Repo -&gt; PodSpec</strong> 这条完整的链路，将散落各地的依赖库连接起来并基于此骨架不断地完善功能。从提供各种便利的命令行工具，到依赖库与主项目的自动集成，再到提供多样的 Xcode 编译配置、单元测试、资源管理等等，最终形成了我们所见的 CocoaPods。</p>
<p>今天我们就来聊聊 <code>Spec Repo</code> 这个 <code>PodSpec</code> 的聚合仓库以及它的演变与问题。</p>
<h1 id="source">Source</h1>
<p>作为 <code>PodSpec</code> 的聚合仓库，Spec Repo <strong>记录着所有 <code>pod</code> 所发布的不同版本的 <code>PodSpec</code> 文件</strong>。该仓库对应到 Core 的数据结构为 <code>Source</code>，即为今天的主角。</p>
<p>整个 <code>Source</code> 的结构比较简单，它基本是围绕着 Git 来做文章，主要是对 <code>PodSpec</code> 文件进行各种查找更新操作。结构如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># 用于检查 spec 是否符合当前 Source 要求</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods-core/source/acceptor&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"># 记录本地 source 的集合</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods-core/source/aggregate&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"># 用于校验 source 的错误和警告</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods-core/source/health_reporter&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"># source 管理器</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods-core/source/manager&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"># source 元数据</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods-core/source/metadata&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Source</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#586e75"># 仓库默认的 Git 分支</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#cb4b16">DEFAULT_SPECS_BRANCH</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;master&#39;</span><span style="color:#719e07">.</span>freeze
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#586e75"># 记录仓库的元数据</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:metadata</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    <span style="color:#586e75"># 记录仓库的本地地址</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:repo</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>    <span style="color:#586e75"># repo 仓库地址 ~/.cocoapods/repos/{repo_name}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(repo)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      @repo <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pathname</span>(repo)<span style="color:#719e07">.</span>expand_path
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      @versions_by_name <span style="color:#719e07">=</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>      refresh_metadata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    <span style="color:#586e75"># 读取 Git 仓库中的 remote url 或 .git 目录</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">url</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>      @url <span style="color:#719e07">||=</span> <span style="color:#719e07">begin</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>        remote <span style="color:#719e07">=</span> repo_git(<span style="color:#2aa198">%w(config --get remote.origin.url)</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>        <span style="color:#719e07">if</span> <span style="color:#719e07">!</span>remote<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>          remote
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>        <span style="color:#719e07">elsif</span> (repo <span style="color:#719e07">+</span> <span style="color:#2aa198">&#39;.git&#39;</span>)<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>          <span style="color:#2aa198">&#34;file://</span><span style="color:#2aa198">#{</span>repo<span style="color:#2aa198">}</span><span style="color:#2aa198">/.git&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">type</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>      git? ? <span style="color:#2aa198">&#39;git&#39;</span> : <span style="color:#2aa198">&#39;file system&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>    <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span><span style="color:#719e07">end</span>
</code></pre></div><p><code>Source</code> 还有两个子类 <strong>CDNSource</strong> 和 <strong>TrunkSource</strong>，TrunkSouce 是 CocoaPods 的默认仓库。在版本 1.7.2 之前 Master Repo 的 URL 指向为 Github 的 <a href="https://github.com/CocoaPods/Specs">Specs 仓库</a>，这也是造成我们每次 <code>pod install</code> 或 <code>pod update</code> 慢的原因之一。它不仅保存了近 10 年来 PodSpec 文件同时还包括 Git 记录，再加上墙的原因，每次更新都非常痛苦。而在 1.7.2 之后 CocoaPods 的默认 Source 终于改为了 CDN 指向，同时支持按需下载，缓解了 <code>pod</code> 更新和磁盘占用过大问题。</p>
<p><code>Source</code> 的依赖关系如下：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmes1krayj20ow0bi3yp.jpg" alt="01-Source"></p>
<p>回到 <code>Source</code> 来看其如何初始化的，可以看到其构造函数 <code>#initialize(repo)</code> 将传入的 repo 地址保存后，直接调用了 <code>#refresh_metadata</code> 来完成元数据的加载：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">refresh_metadata</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  @metadata <span style="color:#719e07">=</span> <span style="color:#cb4b16">Metadata</span><span style="color:#719e07">.</span>from_file(metadata_path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">def</span> <span style="color:#268bd2">metadata_path</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>  repo <span style="color:#719e07">+</span> <span style="color:#2aa198">&#39;CocoaPods-version.yml&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">end</span>
</code></pre></div><h2 id="metadata">Metadata</h2>
<p>Metadata 是保存在 repo 目录下，名为 <code>CocoaPods-version.yml</code> 的文件，<strong>用于记录该 Source 所支持的 CocoaPods 的版本以及仓库的分片规则</strong>。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#b58900">autoload</span> <span style="color:#2aa198">:Digest</span>, <span style="color:#2aa198">&#39;digest/md5&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;active_support/hash_with_indifferent_access&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;active_support/core_ext/hash/indifferent_access&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Source</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Metadata</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#586e75"># 最低可支持的 CocoaPods 版本，对应字段 `min`</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:minimum_cocoapods_version</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#586e75"># 最高可支持的 CocoaPods 版本，对应字段 `max`</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:maximum_cocoapods_version</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#586e75"># 最新 CocoaPods 版本，对应字段 `last`</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:latest_cocoapods_version</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>      <span style="color:#586e75"># 规定截取的关键字段的前缀长度和数量</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:prefix_lengths</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      <span style="color:#586e75"># 可兼容的 CocoaPods 最新版本</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:last_compatible_versions</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>      <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07">end</span>
</code></pre></div><p>这里以笔者 💻 环境中 Master 仓库下的 <code>CocoaPods-version.yml</code> 文件内容为例：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#268bd2">min</span>: <span style="color:#2aa198">1.0.0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#268bd2">last</span>: <span style="color:#2aa198">1.10.0</span>.beta.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#268bd2">prefix_lengths</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>- <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>- <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>- <span style="color:#2aa198">1</span>
</code></pre></div><p>最低支持版本为 <code>1.0.0</code>，最新可用版本为 <code> 1.10.0.beta.1</code>，以及最后这个 <code>prefix_lengths</code> 为 <code>[1, 1, 1]</code> 的数组。那么这个 <strong>prefix_lengths 的作用是什么呢 ？</strong></p>
<p>要回答这个问题，我们先来看一张 <code>Spec Repo</code> 的目录结构图：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmes6ydt8j22m60wg7bp.jpg" alt="02-trunk-folder"></p>
<p>再 🤔 另外一个问题，<strong>为什么 CocoaPods 生成的目录结构是这样 ？</strong></p>
<p>其实在 2016 年 CocoaPods Spec 仓库下的所有文件都在同级目录，不像现在这样做了分片。这个是为了解决当时用户的吐槽：<a href="https://github.com/CocoaPods/CocoaPods/issues/4989#issuecomment-193772935">Github 下载慢</a>，最终解决方案的结果就如你所见：<strong>将 Git 仓库进行了分片</strong>。</p>
<p>那么问题来了，<strong>为什么分片能够提升 Github 下载速度？</strong></p>
<p>很重要的一点是 CocoaPods 的 <code>Spec Repo</code> 本质上是 Git 仓库，而 Git 在做变更管理的时候，会记录目录的变更，每个子目录都会对应一个 Git model。而当目录中的文件数量过多的时候，Git 要找出对应的变更就变得十分困难。有兴趣的同学可以查看<a href="https://blog.cocoapods.org/Master-Spec-Repo-Rate-Limiting-Post-Mortem/#too-many-directory-entries">官方说明</a>。</p>
<p>另外再补充一点，在 Linux 中最经典的一句话是：「<strong>一切皆文件</strong>」，不仅普通的文件和目录，就连块设备、管道、socket 等，也都是统一交给文件系统管理的。也就是说就算不用 Git 来管理 Specs 仓库，当目录下存在数以万计的文件时，如何高效查找目标文件也是需要考虑的问题。</p>
<blockquote>
<p>Tips：关于文件系统层次结构有兴趣的同学可以查看<a href="https://www.wikiwand.com/en/Filesystem_Hierarchy_Standard">FHS 标准</a>，以及知乎这篇：<a href="https://zhuanlan.zhihu.com/p/183238194#tocbar--13f51dj">传送门</a></p>
</blockquote>
<p>回到 CocoaPods，如何对 Master 仓库目录进行分片就涉及到 Metadata 类中的关键方法：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">path_fragment</span>(pod_name, version <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  prefixes <span style="color:#719e07">=</span> <span style="color:#719e07">if</span> prefix_lengths<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>               <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>             <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>               hashed <span style="color:#719e07">=</span> <span style="color:#cb4b16">Digest</span><span style="color:#719e07">::</span><span style="color:#cb4b16">MD5</span><span style="color:#719e07">.</span>hexdigest(pod_name)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>               prefix_lengths<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>length<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>                 hashed<span style="color:#719e07">.</span>slice!(<span style="color:#2aa198">0</span>, length)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>               <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>             <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  prefixes<span style="color:#719e07">.</span>concat(<span style="color:#719e07">[</span>pod_name, version<span style="color:#719e07">]</span>)<span style="color:#719e07">.</span>compact
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">end</span>
</code></pre></div><p><code>#path_fragment</code> 会依据 pod_name 和 version 来生成 pod 对应的索引目录：</p>
<ol>
<li>首先对 pod_name 进行 MD5 计算获取摘要；</li>
<li>遍历 <code>prefix_lengths</code> 对生成的摘要不断截取指定的长度作为文件索引。</li>
</ol>
<p>以 <code>AFNetworking</code> 为例：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>$ <span style="color:#cb4b16">Digest</span><span style="color:#719e07">::</span><span style="color:#cb4b16">MD5</span><span style="color:#719e07">.</span>hexdigest(<span style="color:#2aa198">&#39;AFNetworking&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#2aa198">&#34;a75d452377f3996bdc4b623a5df25820&#34;</span>
</code></pre></div><p>由于我们的 <code>prefix_lengths</code> 为 <code>[1, 1, 1]</code> 数组，那么它将会从左到右依次截取出一个字母，即： <code>a</code>、<code>7</code>、<code>5</code> ，这三个字母作为索引目录，它正好符合我们 👆 目录结构图中 AFNetworking 的所在位置。</p>
<h2 id="versions">Versions</h2>
<p>要找到 <code>Podfile</code> 中限定版本号范围的 <code>PodSpec</code> 文件还需要需要最后一步，获取当前已发布的 Versions 列表，并通过比较 Version 得出最终所需的 <code>PodSpec</code> 文件。</p>
<p>在上一步已通过 <code>metadata</code> 和 <code>pod_name</code> 计算出 <code>pod</code> 所在目录，接着就是找到 <code>pod</code> 目录下的 Versions 列表：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmesdsd18j222g0qcwjb.jpg" alt="03-versons-folder"></p>
<p>获取 Versions：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">versions</span>(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">return</span> <span style="color:#719e07">nil</span> <span style="color:#719e07">unless</span> specs_dir
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#719e07">raise</span> <span style="color:#cb4b16">ArgumentError</span>, <span style="color:#2aa198">&#39;No name&#39;</span> <span style="color:#719e07">unless</span> <span style="color:#b58900">name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  pod_dir <span style="color:#719e07">=</span> pod_path(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">return</span> <span style="color:#719e07">unless</span> pod_dir<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  @versions_by_name<span style="color:#719e07">[</span><span style="color:#b58900">name</span><span style="color:#719e07">]</span> <span style="color:#719e07">||=</span> pod_dir<span style="color:#719e07">.</span>children<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>v<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    basename <span style="color:#719e07">=</span> v<span style="color:#719e07">.</span>basename<span style="color:#719e07">.</span>to_s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">begin</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      <span style="color:#cb4b16">Version</span><span style="color:#719e07">.</span>new(basename) <span style="color:#719e07">if</span> v<span style="color:#719e07">.</span>directory? <span style="color:#719e07">&amp;&amp;</span> basename<span style="color:#719e07">[</span><span style="color:#2aa198">0</span>, <span style="color:#2aa198">1</span><span style="color:#719e07">]</span> <span style="color:#719e07">!=</span> <span style="color:#2aa198">&#39;.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">rescue</span> <span style="color:#cb4b16">ArgumentError</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">raise</span> <span style="color:#cb4b16">Informative</span>, <span style="color:#2aa198">&#39;An unexpected version directory ...&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  <span style="color:#719e07">end</span><span style="color:#719e07">.</span>compact<span style="color:#719e07">.</span>sort<span style="color:#719e07">.</span>reverse
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07">end</span>
</code></pre></div><p>该方法重点在于将 <code>pod_dir</code> 下的每个目录都转换成为了 <strong>Version</strong> 类型，并在最后进行了 sort 排序。</p>
<blockquote>
<p><code>#versions</code> 方法主要在 <code>pod search</code> 命令中被调用，后续会介绍。</p>
</blockquote>
<p>来搂一眼 Version 类：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">Version</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Vendor</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Gem</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Version</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#cb4b16">METADATA_PATTERN</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;(\+[0-9a-zA-Z\-\.]+)&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  <span style="color:#cb4b16">VERSION_PATTERN</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;[0-9]+(</span><span style="color:#cb4b16">\\</span><span style="color:#2aa198">.[0-9a-zA-Z</span><span style="color:#cb4b16">\\</span><span style="color:#2aa198">-]+)*</span><span style="color:#2aa198">#{</span><span style="color:#cb4b16">METADATA_PATTERN</span><span style="color:#2aa198">}</span><span style="color:#2aa198">?&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">end</span>
</code></pre></div><p>该 Version 继承于 <a href="https://www.rubydoc.info/github/rubygems/rubygems/Gem/Version">Gem::Version</a> 并对其进行了扩展，实现了语义化版本号的标准，sort 排序也是基于语义化的版本来比较的，这里我们稍微展开一下。</p>
<h3 id="semantic-versioning">Semantic Versioning</h3>
<p>语义化版本号（<a href="https://semver.org/">Semantic Versioning</a> 简称：SemVer）绝对是依赖管理工具绕不开的坎。<strong>语义化的版本就是让版本号更具语义化，可以传达出关于软件本身的一些重要信息而不只是简单的一串数字。</strong> 我们每次对 Pod 依赖进行更新，最后最重要的一步就是更新正确的版本号，一旦发布出去，再要更改就比较麻烦了。</p>
<blockquote>
<p><a href="https://github.com/semver/semver">SemVer</a> 是由 Tom Preston-Werner 发起的一个关于软件版本号的命名规范，该作者为 Gravatars 创办者同时也是 GitHub 联合创始人。</p>
</blockquote>
<p>那什么是语义化版本号有什么特别呢 ？我们以 AFNetworking 的 <strong>release tag</strong> 示例：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>3.0.0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>3.0.0-beta.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>3.0.0-beta.2
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>3.0.0-beta.3
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>3.0.1
</code></pre></div><p>这些 tags 并非随意递增的，它们背后正是遵循了语义化版本的标准。</p>
<p><strong>基本规则</strong></p>
<ul>
<li>软件的版本通常由三位组成，如：X.Y.Z。</li>
<li>版本是严格递增的，</li>
<li>在发布重要版本时，可以发布 alpha, rc 等先行版本，</li>
<li>alpha 和 rc 等修饰版本的关键字后面可以带上次数和 meta 信息，</li>
</ul>
<p><strong>版本格式：</strong></p>
<blockquote>
<p>主版本号.次版本号.修订号</p>
</blockquote>
<p>版本号递增规则如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">|</span> <span style="color:#cb4b16">Code</span> status        <span style="color:#719e07">|</span> <span style="color:#cb4b16">Stage</span>                  <span style="color:#719e07">|</span> <span style="color:#cb4b16">Example</span> version <span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#719e07">|</span> <span style="color:#719e07">------------------</span> <span style="color:#719e07">|</span> <span style="color:#719e07">----------------------</span> <span style="color:#719e07">|</span> <span style="color:#719e07">---------------</span> <span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">|</span> 新品首发             <span style="color:#719e07">|</span> 从 <span style="color:#2aa198">1</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span> 开始           <span style="color:#719e07">|</span> <span style="color:#2aa198">1</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span>           <span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">|</span> 向后兼容的 <span style="color:#cb4b16">BugFix</span>    <span style="color:#719e07">|</span> 增加补丁号 Z             <span style="color:#719e07">|</span> <span style="color:#2aa198">1</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span><span style="color:#719e07">.</span><span style="color:#2aa198">1</span>           <span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">|</span> 向后兼容的 <span style="color:#cb4b16">Feature</span>   <span style="color:#719e07">|</span> 增加次版本号 Y           <span style="color:#719e07">|</span> <span style="color:#2aa198">1</span><span style="color:#719e07">.</span><span style="color:#2aa198">1</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span>           <span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07">|</span> 向后不兼容的改动      <span style="color:#719e07">|</span> 增加主版本号 X           <span style="color:#719e07">|</span> <span style="color:#2aa198">2</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span>           <span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#719e07">|</span> 重要版本的预览版      <span style="color:#719e07">|</span> 补丁号后添加 alpha, rc   <span style="color:#719e07">|</span> <span style="color:#2aa198">2</span><span style="color:#719e07">.</span><span style="color:#2aa198">1</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span><span style="color:#719e07">-</span>rc<span style="color:#719e07">.</span><span style="color:#2aa198">0</span>      <span style="color:#719e07">|</span>
</code></pre></div><p>关于 CocoaPods 的 Version 使用描述，<a href="https://guides.cocoapods.org/using/the-podfile.html#specifying-pod-versions">传送门</a>。</p>
<h2 id="cdnsource">CDNSource</h2>
<p>CocoaPods 在 1.7.2 版本正式将 Master 仓库托管到 Netlify 的 CDN 上，当时关于如何支持这一特性的文章和说明铺天盖地，这里还是推荐大家看<a href="https://blog.cocoapods.org/CocoaPods-1.7.2/">官方说明</a>。另外，当时感受是似乎国内的部分 iOS 同学都炸了，各种标题党：<em>什么最完美的升级</em>等等。</p>
<p>所以这里明确一下，对于 CocoaPods 的 Master 仓库支持了 CDN 的行为，仅解决了两个问题：</p>
<ol>
<li>利用 CDN 节点的全球化部署解决内容分发慢，提高 Specs 资源的下载速度。</li>
<li>通过 Specs 按需下载摆脱了原有 Git Repo 模式下本地仓库的磁盘占用过大，操作卡的问题。</li>
</ol>
<p>然而，<strong>仅仅对 <code>PodSpec</code> 增加了 CDN 根本没能解决 GFW 导致的 Github 源码校验、更新、下载慢的问题。</strong> 只能说路漫漫其修远兮。</p>
<blockquote>
<p>PS：作为 iOS 工程师，就经常被前端同学 😒 。你看这 CocoaPods 也太垃圾了吧！！！一旦删掉 <code>Pods</code> 目录重新 install 就卡半天，缓存基本不生效，哪像 npm 多快 balabala &hellip;</p>
</blockquote>
<p>先来看 CDNSource 结构：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#b58900">require</span> <span style="color:#2aa198">&#39;cocoapods-core/source&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">CDNSource</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Source</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(repo)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#586e75"># 标记是否正在同步文件</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      @check_existing_files_for_update <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#586e75"># 记录时间用于对比下载文件的新旧程度，以确认是否需要更新保存所下的资源</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      @startup_time <span style="color:#719e07">=</span> <span style="color:#cb4b16">Time</span><span style="color:#719e07">.</span>new
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#586e75"># 缓存查询过的 PodSpec 资源</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      @version_arrays_by_fragment_by_name <span style="color:#719e07">=</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#719e07">super</span>(repo)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">url</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      @url <span style="color:#719e07">||=</span> <span style="color:#cb4b16">File</span><span style="color:#719e07">.</span>read(repo<span style="color:#719e07">.</span>join(<span style="color:#2aa198">&#39;.url&#39;</span>))<span style="color:#719e07">.</span>chomp<span style="color:#719e07">.</span>chomp(<span style="color:#2aa198">&#39;/&#39;</span>) <span style="color:#719e07">+</span> <span style="color:#2aa198">&#39;/&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">type</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>      <span style="color:#2aa198">&#39;CDN&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span><span style="color:#719e07">end</span>
</code></pre></div><p>Source 类是基于 Github Repo 来同步更新 <code>PodSpec</code>，而 CDNSource 则是基于 CDN 服务所返回的 Response，因此将 Source 类的大部分方法重写了一个遍，具体会在 SourceManager 一节来展开。</p>
<p>最后看一下 <code>TrunkSource</code> 类：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">TrunkSource</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">CDNSource</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#586e75"># 新版落盘后仓库名称</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#cb4b16">TRUNK_REPO_NAME</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;trunk&#39;</span><span style="color:#719e07">.</span>freeze
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#cb4b16">TRUNK_REPO_URL</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;https://cdn.cocoapods.org/&#39;</span><span style="color:#719e07">.</span>freeze
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">url</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      @url <span style="color:#719e07">||=</span> <span style="color:#cb4b16">TRUNK_REPO_URL</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">super</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
</code></pre></div><p>核心就是重写了返回的 <code>url</code>，由于旧版 Spec 仓库名称为 <code>master</code> 为了加以区分，CDN 仓库则改名为 <code>trunk</code>。</p>
<h1 id="source-manager">Source Manager</h1>
<p><code>Manager</code> 作为 source 的管理类，其主要任务为 source 的添加和获取，而对 <code>PodSpec</code> 文件的更新和查找行为则交由 source 各自实现。不过由于一个 <code>pod</code> 库可能对应多个不同的 source，这里又产生出 <code>Aggregate</code> 类来统一 <code>PodSpec</code> 的查询。</p>
<p>它们的关系如下：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmesjqrkbj20ow0bit93.jpg" alt="04-manager"></p>
<p>Manager 实现：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Source</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Manager</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:repos_dir</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(repos_dir)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        @repos_dir <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pathname</span>(repos_dir)<span style="color:#719e07">.</span>expand_path
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">source_repos</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        <span style="color:#719e07">return</span> <span style="color:#719e07">[]</span> <span style="color:#719e07">unless</span> repos_dir<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        repos_dir<span style="color:#719e07">.</span>children<span style="color:#719e07">.</span>select(<span style="color:#719e07">&amp;</span><span style="color:#2aa198">:directory?</span>)<span style="color:#719e07">.</span>sort_by { <span style="color:#719e07">|</span>d<span style="color:#719e07">|</span> d<span style="color:#719e07">.</span>basename<span style="color:#719e07">.</span>to_s<span style="color:#719e07">.</span>downcase }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">aggregate</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        aggregate_with_repos(source_repos)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">aggregate_with_repos</span>(repos)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        sources <span style="color:#719e07">=</span> repos<span style="color:#719e07">.</span>map { <span style="color:#719e07">|</span>path<span style="color:#719e07">|</span> source_from_path(path) }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        @aggregates_by_repos <span style="color:#719e07">||=</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        @aggregates_by_repos<span style="color:#719e07">[</span>repos<span style="color:#719e07">]</span> <span style="color:#719e07">||=</span> <span style="color:#cb4b16">Source</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Aggregate</span><span style="color:#719e07">.</span>new(sources)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">all</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>        aggregate<span style="color:#719e07">.</span>sources
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>      <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span><span style="color:#719e07">end</span>
</code></pre></div><p>Manager 类的初始化仅需要传入当前 repos 目录，即 <code>~/.cocoapods/repos</code>，而 Aggregate 的生成则保存 <code>repos_dir</code> 了目录下的 Source，用于后续处理。</p>
<p>先看 Source 的生成，在 <code>#source_from_path</code> 中：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">source_from_path</span>(path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  @sources_by_path <span style="color:#719e07">||=</span> <span style="color:#cb4b16">Hash</span><span style="color:#719e07">.</span>new <span style="color:#719e07">do</span> <span style="color:#719e07">|</span><span style="color:#b58900">hash</span>, key<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#b58900">hash</span><span style="color:#719e07">[</span>key<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#719e07">case</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>                <span style="color:#719e07">when</span> key<span style="color:#719e07">.</span>basename<span style="color:#719e07">.</span>to_s <span style="color:#719e07">==</span> <span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">TrunkSource</span><span style="color:#719e07">::</span><span style="color:#cb4b16">TRUNK_REPO_NAME</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>                  <span style="color:#cb4b16">TrunkSource</span><span style="color:#719e07">.</span>new(key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>                <span style="color:#719e07">when</span> (key <span style="color:#719e07">+</span> <span style="color:#2aa198">&#39;.url&#39;</span>)<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>                  <span style="color:#cb4b16">CDNSource</span><span style="color:#719e07">.</span>new(key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>                <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>                  <span style="color:#cb4b16">Source</span><span style="color:#719e07">.</span>new(key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>                <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  @sources_by_path<span style="color:#719e07">[</span>path<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
</code></pre></div><p>以 <code>repos_dir</code> 下的目录名称来区分类型，而 CDNSource 则需要确保其目录下存在名为 <code>.url</code> 的文件。同时会对生成的 source 进行缓存。</p>
<p>最后看 Aggregate 结构，核心就两个 search 方法：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Source</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Aggregate</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:sources</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(sources)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#34;Cannot initialize an aggregate with a nil source: (</span><span style="color:#2aa198">#{</span>sources<span style="color:#2aa198">}</span><span style="color:#2aa198">)&#34;</span> <span style="color:#719e07">if</span> sources<span style="color:#719e07">.</span>include?(<span style="color:#719e07">nil</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        @sources <span style="color:#719e07">=</span> sources
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#586e75"># 查询依赖对应的 specs</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">search</span>(dependency) <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>       
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#586e75"># 查询某个 pod 以发布的 specs</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">search_by_name</span>(query, full_text_search <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>) <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span><span style="color:#719e07">end</span>
</code></pre></div><h2 id="source-源起">Source 源起</h2>
<p>本节我们来谈谈 source 是如何添加到 <code>repo_dir</code> 目录下的。</p>
<p>由前面的介绍可知，每个 source 中自带 <strong>url</strong>，在 Source 类中 url 读取自 Git 仓库的 <code>remote.origin.url</code> 或本地 <code>.git</code> 目录，而在 CDNSource 中 url 则是读取自当前目录下的  <code>.url</code> 文件所保存的 URL 地址。</p>
<p>那 CDNSource 的  <strong><code>.url</code> 文件是在什么时候被写入的呢 ？</strong></p>
<p>这需要从 <code>Podfile</code> 说起。很多老项目的 <code>Podfile</code> 开头部分大都会有一行或多行 source 命令：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>source <span style="color:#2aa198">&#39;https://github.com/CocoaPods/Specs.git&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>source <span style="color:#2aa198">&#39;https://github.com/artsy/Specs.git&#39;</span>
</code></pre></div><p>用于指定项目中 <code>PodSpec</code> 的查找源，这些指定源最终会保存在 <code>~/.cocoapods/repos</code> 目录下的仓库。</p>
<p>当敲下 <code>pod install</code> 命令后，在 <code>#resolve_dependencies</code> 阶段的依赖分析中将同时完成 sources 的初始化。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmeso77rcj20ow0biaap.jpg" alt="01-pod-install"></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/cocoapods/installer/analyzer.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">sources</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  @sources <span style="color:#719e07">||=</span> <span style="color:#719e07">begin</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#586e75"># 省略获取 podfile、plugins、dependencies 的 source url ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    sources <span style="color:#719e07">=</span> <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>     
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    result <span style="color:#719e07">=</span> sources<span style="color:#719e07">.</span>uniq<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>source_url<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      sources_manager<span style="color:#719e07">.</span>find_or_create_source_with_url(source_url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">unless</span> plugin_sources<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      result<span style="color:#719e07">.</span>insert(<span style="color:#2aa198">0</span>, <span style="color:#719e07">*</span>plugin_sources)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      plugin_sources<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>source<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        sources_manager<span style="color:#719e07">.</span>add_source(source)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    result
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">end</span>
</code></pre></div><p>获取 sources url 之后会通过 <code>sources_manager</code> 来完成 source 更新，逻辑在 CocoaPods 项目的 Manager 扩展中：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/cocoapods/sources_manager.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Source</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Manager</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">find_or_create_source_with_url</span>(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        source_with_url(url) <span style="color:#719e07">||</span> create_source_with_url(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">create_source_with_url</span>(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#b58900">name</span> <span style="color:#719e07">=</span> name_for_url(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        is_cdn <span style="color:#719e07">=</span> cdn_url?(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>		  <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        <span style="color:#719e07">begin</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>          <span style="color:#719e07">if</span> is_cdn
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>            <span style="color:#cb4b16">Command</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Repo</span><span style="color:#719e07">::</span><span style="color:#cb4b16">AddCDN</span><span style="color:#719e07">.</span>parse(<span style="color:#719e07">[</span><span style="color:#b58900">name</span>, url<span style="color:#719e07">]</span>)<span style="color:#719e07">.</span>run
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>          <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>            <span style="color:#cb4b16">Command</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Repo</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Add</span><span style="color:#719e07">.</span>parse(<span style="color:#719e07">[</span><span style="color:#b58900">name</span>, url<span style="color:#719e07">]</span>)<span style="color:#719e07">.</span>run
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>          <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        <span style="color:#719e07">rescue</span> <span style="color:#cb4b16">Informative</span> <span style="color:#719e07">=&gt;</span> e
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>          <span style="color:#719e07">raise</span> <span style="color:#cb4b16">Informative</span>, <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        <span style="color:#719e07">ensure</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>          <span style="color:#cb4b16">UI</span><span style="color:#719e07">.</span>title_level <span style="color:#719e07">=</span> previous_title_level
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>        source <span style="color:#719e07">=</span> source_with_url(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#34;Unable to create a source with URL </span><span style="color:#2aa198">#{</span>url<span style="color:#2aa198">}</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">unless</span> source
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>        source
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>      <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span><span style="color:#719e07">end</span>
</code></pre></div><p>查找会先调用 <code>#source_with_url</code> 进行缓存查询，如未命中则会先下载 Source 仓库，结束后重刷 aggreate 以更新 source。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/cocoapods-core/source/manager.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">source_with_url</span>(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  url <span style="color:#719e07">=</span> canonic_url(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  url <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;https://github.com/cocoapods/specs&#39;</span> <span style="color:#719e07">if</span> url <span style="color:#719e07">=~</span> <span style="color:#dc322f">%r{github.com[:/]+cocoapods/specs}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  all<span style="color:#719e07">.</span>find <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>source<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    source<span style="color:#719e07">.</span>url <span style="color:#719e07">&amp;&amp;</span> canonic_url(source<span style="color:#719e07">.</span>url) <span style="color:#719e07">==</span> url
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">def</span> <span style="color:#268bd2">canonic_url</span>(url)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  url<span style="color:#719e07">.</span>downcase<span style="color:#719e07">.</span>gsub(<span style="color:#dc322f">/\.git$/</span>, <span style="color:#2aa198">&#39;&#39;</span>)<span style="color:#719e07">.</span>gsub(<span style="color:#dc322f">%r{\/$}</span>, <span style="color:#2aa198">&#39;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
</code></pre></div><p>另外，仓库的下载的则会通过 <code>#cdn_url?</code> 方法区分，最后的下载则 📦 在两个命令类中，概括如下：</p>
<ul>
<li><strong>Command::Repo::AddCDN</strong>：即  <code>pod repo add-cdn</code> 命令，仅有的操作是将 url 写入 <code>.url</code> 文件中。</li>
<li><strong>Command::Repo::Add</strong>：即 <code>pod repo add</code> 命令，对于普通类型的 Source 仓库下载本质就是 <code>git clone</code> 操作。</li>
</ul>
<p>简化后源的添加流程如下：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmess25w7j20ow0biwex.jpg" alt="05-source-add"></p>
<h2 id="podspec-查询">PodSpec 查询</h2>
<p>同样在 <code>#resolve_dependencies</code> 的依赖仲裁阶段，当 <strong>Molinillo</strong> 依赖仲裁开始前，会触发缓存查询 <code>#find_cached_set</code> 并最终调用到 Aggregate 的 <code>#search</code>。完整调用栈放在 <a href="https://gist.github.com/looseyi/492b220ea7e933e972b65876e491886f">gist</a> 上。</p>
<p>我们来看看 <code>#search</code> 入口：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75"># lib/cocoapods-core/source/aggregate.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">search</span>(dependency)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  found_sources <span style="color:#719e07">=</span> sources<span style="color:#719e07">.</span>select { <span style="color:#719e07">|</span>s<span style="color:#719e07">|</span> s<span style="color:#719e07">.</span>search(dependency) }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>  <span style="color:#719e07">unless</span> found_sources<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    <span style="color:#cb4b16">Specification</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Set</span><span style="color:#719e07">.</span>new(dependency<span style="color:#719e07">.</span>root_name, found_sources)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">end</span>
</code></pre></div><p>Aggregate 先遍历当前 sources 并进行 dependency 查找。由于 Git 仓库保存了完整的 PodSpecs，只要能在分片目录下查询到对应文件即可，最终结果会塞入 <code>Specification::Set</code> 返回。</p>
<blockquote>
<p>Specification::Set 记录了当前 pod 关联的 Source，一个 pod 可能存在与多个不同的 Spec 仓库 中。</p>
</blockquote>
<h3 id="cdn-仓库查询">CDN 仓库查询</h3>
<p>CDNSource 重写了 <code>#search</code> 实现：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/cocoapods-core/cdn_source.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">search</span>(query)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">unless</span> specs_dir
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">raise</span> <span style="color:#cb4b16">Informative</span>, <span style="color:#2aa198">&#34;Unable to find a source named: `</span><span style="color:#2aa198">#{</span><span style="color:#b58900">name</span><span style="color:#2aa198">}</span><span style="color:#2aa198">`&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">if</span> query<span style="color:#719e07">.</span>is_a?(<span style="color:#cb4b16">Dependency</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    query <span style="color:#719e07">=</span> query<span style="color:#719e07">.</span>root_name
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  fragment <span style="color:#719e07">=</span> pod_shard_fragment(query)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  ensure_versions_file_loaded(fragment)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  version_arrays_by_name <span style="color:#719e07">=</span> @version_arrays_by_fragment_by_name<span style="color:#719e07">[</span>fragment<span style="color:#719e07">]</span> <span style="color:#719e07">||</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  found <span style="color:#719e07">=</span> version_arrays_by_name<span style="color:#719e07">[</span>query<span style="color:#719e07">].</span>nil? ? <span style="color:#719e07">nil</span> : query
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#719e07">if</span> found
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    set <span style="color:#719e07">=</span> set(query)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    set <span style="color:#719e07">if</span> set<span style="color:#719e07">.</span>specification_name <span style="color:#719e07">==</span> query
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07">end</span>
</code></pre></div><p>逻辑两步走：</p>
<ol>
<li>通过 <code>#ensure_versions_file_loaded</code> 检查 all_pods_versions 文件，如果不存在会进行下载操作。</li>
<li>如果当前 source 包含查询的 pod，会创建 <code>Specification::Set</code> 作为查询结果，并在 <code>#specification_name</code> 方法内完成 <code>PodSpec</code> 的检查和下载。</li>
</ol>
<p><strong>0x01 all_pods_versions 文件下载</strong></p>
<p>依据前面提到的分片规则会将 pod 名称 MD5 分割后拼成 URL。</p>
<p>以 <code>AFNetworking</code> 为例，经 <code>#pod_shard_fragment</code> 分割后获取的 fragment 为 <code>[a, 7, 5]</code>，则拼接后的 URL 为 <a href="https://cdn.cocoapods.org/all_pods_versions_a_7_5.txt">https://cdn.cocoapods.org/all_pods_versions_a_7_5.txt</a>，下载后的内容大致如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>AFNetworking/0.10.0/0.10.1/.../4.0.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>AppseeAnalytics/2.4.7/2.4.8/2.4.8.0/...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>DynamsoftBarcodeReader/7.1.0/...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>...
</code></pre></div><p>所包含的这些 pod 都是分片后得到的相同的地址，因此会保存在同一份 <code>all_pods_versions</code> 中。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">ensure_versions_file_loaded</span>(fragment)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">return</span> <span style="color:#719e07">if</span> <span style="color:#719e07">!</span>@version_arrays_by_fragment_by_name<span style="color:#719e07">[</span>fragment<span style="color:#719e07">].</span>nil? <span style="color:#719e07">&amp;&amp;</span> <span style="color:#719e07">!</span>@check_existing_files_for_update
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  index_file_name <span style="color:#719e07">=</span> index_file_name_for_fragment(fragment)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  download_file(index_file_name)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  versions_raw <span style="color:#719e07">=</span> local_file(index_file_name, <span style="color:#719e07">&amp;</span><span style="color:#2aa198">:to_a</span>)<span style="color:#719e07">.</span>map(<span style="color:#719e07">&amp;</span><span style="color:#2aa198">:chomp</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  @version_arrays_by_fragment_by_name<span style="color:#719e07">[</span>fragment<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> versions_raw<span style="color:#719e07">.</span>reduce({}) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span><span style="color:#b58900">hash</span>, row<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    row <span style="color:#719e07">=</span> row<span style="color:#719e07">.</span>split(<span style="color:#2aa198">&#39;/&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    pod <span style="color:#719e07">=</span> row<span style="color:#719e07">.</span>shift
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    versions <span style="color:#719e07">=</span> row
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#b58900">hash</span><span style="color:#719e07">[</span>pod<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> versions
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#b58900">hash</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07">def</span> <span style="color:#268bd2">index_file_name_for_fragment</span>(fragment)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  fragment_joined <span style="color:#719e07">=</span> fragment<span style="color:#719e07">.</span>join(<span style="color:#2aa198">&#39;_&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  fragment_joined <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;_&#39;</span> <span style="color:#719e07">+</span> fragment_joined <span style="color:#719e07">unless</span> fragment<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  <span style="color:#2aa198">&#34;all_pods_versions</span><span style="color:#2aa198">#{</span>fragment_joined<span style="color:#2aa198">}</span><span style="color:#2aa198">.txt&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07">end</span>
</code></pre></div><p>另外每一份 pods_version 都会对应生成一个文件用于保存 ETag，具体会在下一节会介绍。</p>
<p><strong>0x02 PodSpec 文件下载</strong></p>
<p><code>#specification_name</code> 将从 <code>all_pods_versions</code> 索引文件中找出该 pod 所发布的版本号，依次检查下载对应版本的 <code>PodSpec.json</code> 文件。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Specification</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Set</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:sources</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">specification_name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>        versions_by_source<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>source, versions<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>          <span style="color:#719e07">next</span> <span style="color:#719e07">unless</span> version <span style="color:#719e07">=</span> versions<span style="color:#719e07">.</span>first
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>          <span style="color:#719e07">return</span> source<span style="color:#719e07">.</span>specification(<span style="color:#b58900">name</span>, version)<span style="color:#719e07">.</span>name
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">versions_by_source</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        @versions_by_source <span style="color:#719e07">||=</span> sources<span style="color:#719e07">.</span>each_with_object({}) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>source, result<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>          result<span style="color:#719e07">[</span>source<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> source<span style="color:#719e07">.</span>versions(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>      <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span><span style="color:#719e07">end</span>
</code></pre></div><p>绕了一圈后回到 Source 的 <code>#versions</code> 方法，由于 CDN Source 不会全量下载 pod 的 PodSpec 文件，在 <a href="https://www.rubydoc.info/gems/cocoapods-core/Pod/CDNSource#versions-instance_method"><strong>#version</strong></a> 的检查过程会进行下载操作。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gk0tqzq5qoj20ow0bit9k.jpg" alt="08-cdn-search"></p>
<h3 id="pod-search-查询命令">Pod Search 查询命令</h3>
<p>CocoaPods 还提供了命令行工具 <code>cocoapods-search</code> 用于已发布的 <code>PodSpec</code> 查找：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>$ pod search <span style="color:#586e75">`</span>QUERY<span style="color:#586e75">`</span>
</code></pre></div><p>它提供了 Web 查询和本地查询。本地查询则不同于 <code>#search</code>，它需要调用 Aggregate 的 <code>#search_by_name</code> ，其实现同 <code>#search</code> 类似，最终也会走到 Source 的 <a href="https://www.rubydoc.info/gems/cocoapods-core/Pod/Source/Aggregate#search_by_name-instance_method">#versions</a> 方法。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmesx1nzpj20ow0biwex.jpg" alt="07-pod-search"></p>
<blockquote>
<p>注意，Gti 仓库的 <code>#search_by_name</code> 查询仍旧为文件查找，不会调用其 <code>#versions</code> 方法。</p>
</blockquote>
<h2 id="repo-更新">Repo 更新</h2>
<p><code>pod install</code> 执行过程如果带上了 <code>--repo-update</code> 命令则在 <code>#resolve_dependencies</code> 阶段会触发 <code>#update_repositories</code> 更新 Spec 仓库：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/cocoapods/installer/analyzer.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">update_repositories</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  sources<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>source<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> source<span style="color:#719e07">.</span>updateable?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      sources_manager<span style="color:#719e07">.</span>update(source<span style="color:#719e07">.</span>name, <span style="color:#719e07">true</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#cb4b16">UI</span><span style="color:#719e07">.</span>message <span style="color:#2aa198">&#34;Skipping ...&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  @specs_updated <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">end</span>
</code></pre></div><p>不过 <code>#update</code> 的实现逻辑在 CocoaPods 项目的 Manager 扩展中：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/cocoapods/sources_managers.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">update</span>(source_name <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>, show_output <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">if</span> source_name
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    sources <span style="color:#719e07">=</span> <span style="color:#719e07">[</span>updateable_source_named(source_name)<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    sources <span style="color:#719e07">=</span> updateable_sources
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  changed_spec_paths <span style="color:#719e07">=</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#586e75"># Do not perform an update if the repos dir has not been setup yet.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  <span style="color:#719e07">return</span> <span style="color:#719e07">unless</span> repos_dir<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#cb4b16">File</span><span style="color:#719e07">.</span>open(<span style="color:#2aa198">&#34;</span><span style="color:#2aa198">#{</span>repos_dir<span style="color:#2aa198">}</span><span style="color:#2aa198">/Spec_Lock&#34;</span>, <span style="color:#cb4b16">File</span><span style="color:#719e07">::</span><span style="color:#cb4b16">CREAT</span>) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>f<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    f<span style="color:#719e07">.</span>flock(<span style="color:#cb4b16">File</span><span style="color:#719e07">::</span><span style="color:#cb4b16">LOCK_EX</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    sources<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>source<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>      <span style="color:#cb4b16">UI</span><span style="color:#719e07">.</span>section <span style="color:#2aa198">&#34;Updating spec repo `</span><span style="color:#2aa198">#{</span>source<span style="color:#719e07">.</span>name<span style="color:#2aa198">}</span><span style="color:#2aa198">`&#34;</span> <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>        changed_source_paths <span style="color:#719e07">=</span> source<span style="color:#719e07">.</span>update(show_output)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        changed_spec_paths<span style="color:#719e07">[</span>source<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> changed_source_paths <span style="color:#719e07">if</span> changed_source_paths<span style="color:#719e07">.</span>count <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        source<span style="color:#719e07">.</span>verify_compatibility!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>  update_search_index_if_needed_in_background(changed_spec_paths)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span><span style="color:#719e07">end</span>
</code></pre></div><ol>
<li>
<p>获取指定名称的 source，对 aggregate 返回的全部 sources 进行 filter，如未指定则 sources 全量。</p>
</li>
<li>
<p>挨个调用 <code>source.update(show_output)</code>，注意 Git 和 CDN 仓库的更新方式的不同。</p>
</li>
</ol>
<h3 id="git-仓库更新">Git 仓库更新</h3>
<p>Git 仓库更新本质就是 Git 操作，即 <code>git pull</code>、<code>git checkout</code> 命令：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">update</span>(show_output)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">return</span> <span style="color:#719e07">[]</span> <span style="color:#719e07">if</span> unchanged_github_repo?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  prev_commit_hash <span style="color:#719e07">=</span> git_commit_hash
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  update_git_repo(show_output)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  @versions_by_name<span style="color:#719e07">.</span>clear
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  refresh_metadata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">if</span> version <span style="color:#719e07">=</span> metadata<span style="color:#719e07">.</span>last_compatible_version(<span style="color:#cb4b16">Version</span><span style="color:#719e07">.</span>new(<span style="color:#cb4b16">CORE_VERSION</span>))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    tag <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;v</span><span style="color:#2aa198">#{</span>version<span style="color:#2aa198">}</span><span style="color:#2aa198">&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#cb4b16">CoreUI</span><span style="color:#719e07">.</span>warn <span style="color:#2aa198">&#34;Using the ...&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    repo_git(<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;checkout&#39;</span>, tag<span style="color:#719e07">]</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  diff_until_commit_hash(prev_commit_hash)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
</code></pre></div><p><code>#update_git_repo</code> 就是 <code>git fetch</code> + <code>git reset --hard [HEAD]</code> 的结合体，更新后会进行 cocoapods 版本兼容检查，最终输出 diff 信息。</p>
<h3 id="cdn-仓库更新">CDN 仓库更新</h3>
<p>Git 仓库是可以通过 Commit 信息来进行增量更新，那以静态资源方式缓存的 CDN 仓库是如何更新数据的呢 ？</p>
<p>像浏览器或本地缓存<strong>本质是利用 ETag 来进行 Cache-Control</strong>，关于 CDN 缓存可以看这篇：<a href="https://zhuanlan.zhihu.com/p/65722520">传送门</a>。</p>
<p>而 ETag 就是一串字符，内容通常是数据的哈希值，由服务器返回。首次请求后会在本地缓存起来，并在后续的请求中携带上 ETag 来确定缓存是否需要更新。如果 ETag 值相同，说明资源未更改，服务器会返回 304（Not Modified）响应码。</p>
<p>Core 的实现也是如此，它会将各请求所对应的 ETag 以文件形式存储：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmet1emdjj20y50d9q4c.jpg" alt="06-source-cdn"></p>
<p>⚠️ <strong>注意，在这个阶段 CDNSource 仅仅是更新当前目录下的索引文件</strong>，即 <code>all_pods_versions_x_x_x.txt</code>。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">update</span>(_show_output)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  @check_existing_files_for_update <span style="color:#719e07">=</span> <span style="color:#719e07">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#719e07">begin</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    preheat_existing_files
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">ensure</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    @check_existing_files_for_update <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">def</span> <span style="color:#268bd2">preheat_existing_files</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  files_to_update <span style="color:#719e07">=</span> files_definitely_to_update <span style="color:#719e07">+</span> deprecated_local_podspecs <span style="color:#719e07">-</span> <span style="color:#719e07">[</span><span style="color:#2aa198">&#39;deprecated_podspecs.txt&#39;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  concurrent_requests_catching_errors <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    loaders <span style="color:#719e07">=</span> files_to_update<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>file<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      download_file_async(file)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    <span style="color:#cb4b16">Promises</span><span style="color:#719e07">.</span>zip_futures_on(<span style="color:#cb4b16">HYDRA_EXECUTOR</span>, <span style="color:#719e07">*</span>loaders)<span style="color:#719e07">.</span>wait!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">end</span>
</code></pre></div><h3 id="pod-repo-更新命令">Pod Repo 更新命令</h3>
<p>CocoaPods 对于 sources 仓库的更新也提供了命令行工具：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>    $ pod repo update <span style="color:#586e75">`</span><span style="color:#719e07">[</span>NAME<span style="color:#719e07">]</span><span style="color:#586e75">`</span>
</code></pre></div><p>其实现如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/cocoapods/command/repo/update.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">module</span> Pod
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Repo</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Command</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#719e07">class</span> <span style="color:#268bd2">Update</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Repo</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">def</span> <span style="color:#268bd2">run</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>          show_output <span style="color:#719e07">=</span> <span style="color:#719e07">!</span>config<span style="color:#719e07">.</span>silent?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>          config<span style="color:#719e07">.</span>sources_manager<span style="color:#719e07">.</span>update(@name, show_output)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>          exclude_repos_dir_from_backup
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#586e75"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07">end</span>
</code></pre></div><p>在命令初始化时会保存指定的 Source 仓库名称 <code>@name</code>，接着通过 Mixin 的 <code>config</code> 来获取 <code>sources_manager</code> 触发更新。</p>
<p>最后用一张图来收尾 CocoaPods Workflow：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/8157560cly1gmmet7lhvwj20ow0biwet.jpg" alt="09-cocoapods-flow"></p>
<h1 id="总结">总结</h1>
<p>最后一篇 Core 的分析文章，重点介绍了它是如何管理 <code>PodSpec</code> 仓库以及 <code>PodSpec</code> 文件的更新和查找，总结如下：</p>
<ol>
<li>了解 Source Manager 的各种数据结构以及它们之间的相互关系，各个类之间居然都做到了权责分明。</li>
<li>通过对 Metadata 的分析了解了 Source 仓库的演变过程，并剖析了存在的问题。</li>
<li>掌握了如何利用 CDN 来改造原有的 Git 仓库，优化 PodSpec 下载速度。</li>
<li>发现原来 CLI 工具不仅仅可以提供给用户使用，内部调用也不是不可以。</li>
</ol>
<h1 id="知识点问题梳理">知识点问题梳理</h1>
<p>这里罗列了五个问题用来考察你是否已经掌握了这篇文章，如果没有建议你加入<strong>收藏</strong>再次阅读：</p>
<ol>
<li><code>PodSpecs</code> 的聚合类有哪些，可以通过哪些手段来区分他们的类型 ？</li>
<li>说说你对 <code>Aggregate</code> 类的理解，以及它的主要作用 ？</li>
<li><code>Source</code> 类是如何更新 <code>PodSpec</code> ？</li>
<li>Core 是如何对仓库进行分片的，它的分片方式是否支持配置 ？</li>
<li>CDN 仓库是如何来更新 <code>PodSpec</code> 文件 ？</li>
</ol>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/cocoapods">CocoaPods</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/ruby">Ruby</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/snowball/snowball-widgets/"><span>←</span><span>雪球 iOS Widget 从零到壹</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-cocoapods/05-cocoapods-podspec/"><span>5. PodSpec 文件分析</span><span>→</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
