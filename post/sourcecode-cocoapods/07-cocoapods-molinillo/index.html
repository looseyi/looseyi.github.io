<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>7. Molinillo ä¾èµ–æ ¡éªŒ - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="åœŸåœŸEdmondæœ¨" /><meta name="description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.82.1 with theme even" />


<link rel="canonical" href="http://looseyi.github.io/post/sourcecode-cocoapods/07-cocoapods-molinillo/" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/07-cocoapods-molinillo/index.xml" rel="alternate" type="application/rss+xml" title="" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/07-cocoapods-molinillo/index.xml" rel="feed" type="application/rss+xml" title="" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="7. Molinillo ä¾èµ–æ ¡éªŒ" />
<meta property="og:description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://looseyi.github.io/post/sourcecode-cocoapods/07-cocoapods-molinillo/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-03-08T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-03-08T00:00:00&#43;00:00" />

<meta itemprop="name" content="7. Molinillo ä¾èµ–æ ¡éªŒ">
<meta itemprop="description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥"><meta itemprop="datePublished" content="2021-03-08T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-08T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6721">
<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="7. Molinillo ä¾èµ–æ ¡éªŒ"/>
<meta name="twitter:description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Aha Moment</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Aha Moment</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">7. Molinillo ä¾èµ–æ ¡éªŒ</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-03-08 </span>
        <div class="post-category">
            <a href="/categories/cocoapods/"> CocoaPods </a>
            </div>
          <span class="more-meta"> çº¦ 6721 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 14 åˆ†é’Ÿ </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#é—®é¢˜ç±»å‹">é—®é¢˜ç±»å‹</a>
      <ul>
        <li><a href="#ä¾èµ–è¿‡å¤šå¤šé‡ä¾èµ–">ä¾èµ–è¿‡å¤š/å¤šé‡ä¾èµ–</a></li>
        <li><a href="#ä¾èµ–å†²çª">ä¾èµ–å†²çª</a></li>
        <li><a href="#ä¾èµ–å¾ªç¯">ä¾èµ–å¾ªç¯</a></li>
      </ul>
    </li>
    <li><a href="#ä¾èµ–å…³ç³»çš„è§£å†³">ä¾èµ–å…³ç³»çš„è§£å†³</a>
      <ul>
        <li><a href="#0x01-ç‰ˆæœ¬å†²çªçš„è§£å†³æ–¹æ¡ˆ">0x01 ç‰ˆæœ¬å†²çªçš„è§£å†³æ–¹æ¡ˆ</a></li>
        <li><a href="#0x02-å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆ">0x02 å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆ</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#resolutionstate">ResolutionState</a>
      <ul>
        <li><a href="#resolution-loop">Resolution Loop</a></li>
        <li><a href="#resolutionstate-çš„å˜åŒ–">ResolutionState çš„å˜åŒ–</a></li>
      </ul>
    </li>
    <li><a href="#dependencygraph">DependencyGraph</a>
      <ul>
        <li><a href="#operation-log">Operation Log</a></li>
      </ul>
    </li>
    <li><a href="#unwind-for-conflict">Unwind For Conflict</a>
      <ul>
        <li><a href="#0x1-å¯èƒ½æ€§æ ¡éªŒ">0x1 å¯èƒ½æ€§æ ¡éªŒ</a></li>
        <li><a href="#0x2-å†²çªçŠ¶æ€å›æ’¤">0x2 å†²çªçŠ¶æ€å›æ’¤</a></li>
      </ul>
    </li>
    <li><a href="#specificationprovider">SpecificationProvider</a>
      <ul>
        <li><a href="#nosuchdependencyerror">NoSuchDependencyError</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/Molinillo%20%E4%BE%9D%E8%B5%96%E6%A0%A1%E9%AA%8C.png" alt="Molinillo ä¾èµ–æ ¡éªŒ"></p>
<h1 id="å¼•å­">å¼•å­</h1>
<p>é€šè¿‡ã€Œ<a href="https://www.zhihu.com/column/c_1254403935512834048"><strong>å‰æ–‡</strong></a>ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† <code>Pod</code> æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ <code>pod install</code> çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠ <code>Pod</code> çš„ä¾èµ–æ ¡éªŒå·¥å…· &mdash; <a href="https://github.com/CocoaPods/Molinillo">Molinillo</a>ã€‚å¼€å§‹å‰ï¼Œéœ€è¦èŠèŠä¾èµ–æ ¡éªŒçš„èƒŒæ™¯ã€‚</p>
<h1 id="ä¾èµ–ç®¡ç†çš„æŒ‘æˆ˜">ä¾èµ–ç®¡ç†çš„æŒ‘æˆ˜</h1>
<p>åŒå¤§å¤šæ•°åŒ…ç®¡ç†å·¥å…·ä¸€æ · <code>Pod</code> ä¼šå°†ä¼ é€’ä¾èµ–çš„åŒ…ç”¨æ‰å¹³åŒ–çš„å½¢å¼ï¼Œå®‰è£…è‡³ workspace ç›®å½• (å³ï¼š<code>Pods/</code>)ã€‚</p>
<p><strong>ä¾èµ–ä¼ é€’</strong>ï¼š<code>pod A</code> ä¾èµ–äº <code>pod B</code>ï¼Œè€Œ <code>pod B</code> ä¾èµ– <code>Alamofire</code>ã€‚</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/01-dependency-flat.png" alt="01-dependency-flat"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç»ä¾èµ–è§£æåŸæœ‰çš„ä¾èµ–æ ‘è¢«æ‹å¹³äº†ï¼Œå®‰è£…åœ¨åŒå±‚ç›®å½•ä¸­ã€‚</p>
<p>ç„¶è€Œåœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œé‡åˆ°çš„æ›´å¤šæƒ…å†µå¯èƒ½åƒä¸‹é¢è¿™æ ·ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/02-dependency-conflict.png" alt="02-dependency-conflict"></p>
<p>**ä¾èµ–å†²çªï¼š<strong>å³ <code>pod A</code> å’Œ <code>pod B</code> åˆ†åˆ«ä¾èµ–ä¸åŒç‰ˆæœ¬çš„ <code>Alamofire</code>ã€‚è¿™å°±æ˜¯</strong><a href="https://www.wikiwand.com/zh-hans/%E7%9B%B8%E4%BE%9D%E6%80%A7%E5%9C%B0%E7%8B%B1">ä¾èµ–åœ°ç‹±</a>**çš„å¼€å§‹ã€‚</p>
<blockquote>
<p>ä¾èµ–åœ°ç‹±ï¼šæŒ‡åœ¨æ“ä½œç³»ç»Ÿä¸­ç”±äºè½¯ä»¶ä¹‹é—´çš„ä¾èµ–æ€§ä¸èƒ½è¢«æ»¡è¶³è€Œå¼•å‘çš„é—®é¢˜ã€‚</p>
</blockquote>
<p>éšç€é¡¹ç›®çš„è¿­ä»£ï¼Œæˆ‘ä»¬ä¸æ–­å¼•å…¥ä¾èµ–å¹¶æœ€ç»ˆå½¢æˆé”™ç»¼å¤æ‚çš„ç½‘ç»œã€‚è¿™ä½¿å¾—é¡¹ç›®çš„ä¾èµ–æ€§è§£æå˜å¾—å¼‚å¸¸å›°éš¾ï¼Œç”šè‡³å‡ºç°<a href="https://www.wikiwand.com/en/Fatal_exception_error">è‡´å‘½é”™è¯¯</a>ã€‚</p>
<p>é‚£ä¹ˆï¼Œäº§ç”Ÿçš„é—®é¢˜æœ‰å“ªäº›ç±»å‹ ï¼Ÿ</p>
<h2 id="é—®é¢˜ç±»å‹">é—®é¢˜ç±»å‹</h2>
<h3 id="ä¾èµ–è¿‡å¤šå¤šé‡ä¾èµ–">ä¾èµ–è¿‡å¤š/å¤šé‡ä¾èµ–</h3>
<p>å³é¡¹ç›®å­˜åœ¨å¤§é‡ä¾èµ–å…³ç³»ï¼Œæˆ–è€…ä¾èµ–æœ¬èº«æœ‰å…¶è‡ªèº«ä¾èµ–ï¼ˆä¾èµ–ä¼ é€’ï¼‰ï¼Œå¯¼è‡´ä¾èµ–å±‚çº§è¿‡æ·±ã€‚åƒå¾®ä¿¡æˆ–æ·˜å®è¿™æ ·çš„è¶…çº§åº”ç”¨ï¼Œå…¶ä¸­çš„å•ä¸€ä¸šåŠ¡æ¨¡å—éƒ½å¯èƒ½å­˜åœ¨è¿™äº›é—®é¢˜ï¼Œè¿™å°†ä½¿å¾—ä¾èµ–è§£æè¿‡äºå¤æ‚ï¼Œä¸”å®¹æ˜“äº§ç”Ÿä¾èµ–å†²çªå’Œä¾èµ–å¾ªç¯ã€‚</p>
<h3 id="ä¾èµ–å†²çª">ä¾èµ–å†²çª</h3>
<p>å³é¡¹ç›®ä¸­çš„ä¸¤ä¸ªä¾èµ–åŒ…æ— æ³•å…±å­˜çš„æƒ…å†µã€‚å¯èƒ½ä¸¤ä¸ªä¾èµ–åº“å†…éƒ¨çš„ä»£ç å†²çªï¼Œä¹Ÿå¯èƒ½å…¶åº•å±‚ä¾èµ–äº’ç›¸å†²çªã€‚ä¸Šé¢ä¾‹å­ä¸­å›  <code>Alamofire</code> ç‰ˆæœ¬ä¸åŒäº§ç”Ÿçš„é—®é¢˜å°±æ˜¯ä¾èµ–å†²çªã€‚</p>
<h3 id="ä¾èµ–å¾ªç¯">ä¾èµ–å¾ªç¯</h3>
<p>å³ä¾èµ–æ€§å…³ç³»å½¢æˆä¸€ä¸ªé—­åˆç¯è·¯ã€‚å¦‚ä¸‹å›¾ä¸‰ä¸ª pod åº“ä¹‹é—´äº’ç›¸ä¾èµ–äº§ç”Ÿå¾ªç¯ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/03-dependency-conflict.png" alt="03-dependency-conflict"></p>
<p>è¦åˆ¤æ–­ä¾èµ–å…³ç³»ä¸­æ˜¯å¦å­˜åœ¨ä¾èµ–ç¯ï¼Œåˆ™éœ€è¦é€šä¾èµ–ä»²è£ç®—æ³•æ¥è§£å†³ã€‚</p>
<h2 id="ä¾èµ–å…³ç³»çš„è§£å†³">ä¾èµ–å…³ç³»çš„è§£å†³</h2>
<p>å¯¹äºä¾èµ–è¿‡å¤šæˆ–è€…å¤šé‡ä¾èµ–é—®é¢˜ï¼Œæˆ‘ä»¬å¯é€šè¿‡åˆç†çš„æ¶æ„å’Œè®¾è®¡æ¨¡å¼æ¥è§£å†³ã€‚è€Œ<strong>ä¾èµ–æ ¡éªŒ</strong>ä¸»è¦è§£å†³çš„é—®é¢˜ä¸ºï¼š</p>
<ol>
<li>æ£€æŸ¥ä¾èµ–å›¾æ˜¯å¦å­˜åœ¨ç‰ˆæœ¬å†²çªï¼›</li>
<li>åˆ¤æ–­ä¾èµ–å›¾æ˜¯å¦å­˜åœ¨å¾ªç¯ä¾èµ–ï¼›</li>
</ol>
<h3 id="0x01-ç‰ˆæœ¬å†²çªçš„è§£å†³æ–¹æ¡ˆ">0x01 ç‰ˆæœ¬å†²çªçš„è§£å†³æ–¹æ¡ˆ</h3>
<p>å¯¹äºç‰ˆæœ¬å†²çªå¯é€šè¿‡ä¿®æ”¹æŒ‡å®šç‰ˆæœ¬ä¸ºå¸¦å…¼å®¹æ€§çš„ç‰ˆæœ¬èŒƒå›´é—®é¢˜æ¥é¿å…ã€‚å¦‚ä¸Šé¢çš„é—®é¢˜æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>é€šè¿‡ä¿®æ”¹ä¸¤ä¸ª <code>pod</code> çš„ <code>Alamofire</code> ç‰ˆæœ¬çº¦æŸä¸º <code>~&gt; 4.0</code> æ¥è§£å†³ã€‚</li>
<li>å»é™¤ä¸¤ä¸ª <code>pod</code> çš„ç‰ˆæœ¬çº¦æŸï¼Œäº¤ç”±é¡¹ç›®ä¸­çš„ <code>Podfile</code> æ¥æŒ‡å®šã€‚</li>
</ul>
<p>ä¸è¿‡è¿™æ ·ä¼šæœ‰ä¸€ä¸ªéšæ‚£ï¼Œç”±äºä¸¤ä¸ª <code>Pod</code> ä½¿ç”¨çš„ä¸»ç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½å¸¦æ¥ API ä¸å…¼å®¹ï¼Œå¯¼è‡´ <code>pod install</code> å³ä½¿æˆåŠŸäº†ï¼Œæœ€ç»ˆä¹Ÿæ— æ³•ç¼–è¯‘æˆ–è¿è¡Œæ—¶æŠ¥é”™ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ˜¯åŸºäºè¯­è¨€ç‰¹æ€§æ¥è¿›è¡Œä¾èµ–æ€§éš”ç¦»ã€‚å¦‚ npm çš„æ¯ä¸ªä¼ é€’ä¾èµ–åŒ…å¦‚æœå†²çªéƒ½å¯ä»¥æœ‰è‡ªå·±çš„ <code>node_modules</code> ä¾èµ–ç›®å½•ï¼Œå³ä¸€ä¸ªä¾èµ–åº“å¯ä»¥å­˜åœ¨å¤šä¸ªä¸åŒç‰ˆæœ¬ã€‚</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/04-dependency-conflict.png" alt="04-dependency-conflict"></p>
<h3 id="0x02-å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆ">0x02 å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆ</h3>
<p>å¾ªç¯ä¾èµ–åˆ™éœ€è¦éœ€è¦è¿›è¡Œæ•°å­¦å»ºæ¨¡ç”Ÿæˆ <code>DAG</code> å›¾ï¼Œåˆ©ç”¨æ‹“æ‰‘æ’åºçš„æ‹†ç‚¹è¿›è¡Œå¤„ç†ã€‚é€šè¿‡ç¡®å®šä¾èµ–å›¾æ˜¯å¦ä¸º <code>DAG</code> å›¾ï¼Œæ¥éªŒè¯ä¾èµ–å…³ç³»çš„åˆç†æ€§ã€‚</p>
<p>ä¸€ä¸ª DAG å›¾çš„ç¤ºä¾‹ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/05-DAG.png" alt="04-DAG"></p>
<blockquote>
<p>DAG æ˜¯å›¾è®ºä¸­å¸¸è§çš„ä¸€ç§æè¿°é—®é¢˜çš„ç»“æ„ï¼Œå…¨ç§°**æœ‰å‘æ— ç¯å›¾ (Directed Acyclic Graph) **ã€‚æƒ³äº†è§£æ›´å¤šï¼Œå¯æŸ¥çœ‹ç“œç“œçš„æ–‡ç«  &mdash;ã€Œ<a href="https://mp.weixin.qq.com/s/oj_cxBwKCxxbr0hYbrj21A">ä»æ‹“æ‰‘æ’åºåˆ° Carthage ä¾èµ–æ ¡éªŒç®—æ³•</a>ã€ã€‚</p>
</blockquote>
<p>å¦å¤–ï¼Œå„ç§åŒ…ç®¡ç†å·¥å…·çš„ä¾èµ–æ ¡éªŒç®—æ³•ä¹Ÿå„ä¸ç›¸åŒï¼Œæœ‰å¦‚ Dart å’Œ SwiftPM æ‰€ä½¿ç”¨çš„ <a href="https://medium.com/@nex3/pubgrub-2fb6470504f">PubGrub</a>ï¼Œä½œè€…å·ç§°å…¶ä¸ºä¸‹ä¸€ä»£ä¾èµ–æ ¡éªŒç®—æ³•ï¼ŒYarn çš„ <a href="https://classic.yarnpkg.com/en/docs/selective-version-resolutions">Selective dependency resolutions</a>ï¼Œè¿˜æœ‰æˆ‘ä»¬ä»Šå¤©èŠåˆ°çš„ Molinilloã€‚</p>
<h1 id="molinillo">Molinillo</h1>
<p>Molinillo ä½œä¸ºé€šç”¨çš„ä¾èµ–è§£æå·¥å…·ï¼Œå®ƒä¸ä»…åº”ç”¨åœ¨ CocoaPods ä¸­ï¼Œåœ¨ Bundler 1.9 ç‰ˆæœ¬ä¹Ÿé‡‡ç”¨ Molinilloã€‚å¦å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ Bundler åœ¨ Ruby 2.6 ä¸­è¢«ä½œä¸ºäº†é»˜è®¤çš„ gem å·¥å…·å†…åµŒã€‚å¯ä»¥è¯´ Ruby ç›¸å…³çš„ä¾èµ–å·¥å…·éƒ½é€šè¿‡ Molinillo å®Œæˆä¾èµ–è§£æã€‚</p>
<h2 id="resolutionstate">ResolutionState</h2>
<p>Molinillo ç®—æ³•çš„æ ¸å¿ƒæ˜¯åŸºäº<a href="https://en.wikipedia.org/wiki/Backtracking">å›æº¯ (Backtracking)</a> å’Œ <a href="https://en.wikipedia.org/wiki/Look-ahead_(backtracking)">å‘å‰æ£€æŸ¥ (forward checking)</a>ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šè¿½è¸ªæ ˆä¸­çš„ä¸¤ä¸ªçŠ¶æ€ <code>DependencyState</code> å’Œ <code>PossibilityState</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="c1"># è§£æçŠ¶æ€</span>
  <span class="no">ResolutionState</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
    <span class="c1"># [String] å½“å‰éœ€æ±‚åç§°</span>
    <span class="ss">:name</span><span class="p">,</span>
    <span class="c1"># [Array&lt;Object&gt;] æœªå¤„ç†çš„éœ€æ±‚</span>
    <span class="ss">:requirements</span><span class="p">,</span>
    <span class="c1"># [DependencyGraph] ä¾èµ–å…³ç³»å›¾</span>
    <span class="ss">:activated</span><span class="p">,</span>
    <span class="c1"># [Object] å½“å‰éœ€æ±‚</span>
    <span class="ss">:requirement</span><span class="p">,</span>
    <span class="c1"># [Object] æ»¡è¶³å½“å‰éœ€æ±‚çš„å¯èƒ½æ€§</span>
    <span class="ss">:possibilities</span><span class="p">,</span>
    <span class="c1"># [Integer] è§£ææ·±åº¦</span>
    <span class="ss">:depth</span><span class="p">,</span>
    <span class="c1"># [Hash] æœªè§£å†³çš„å†²çªï¼Œä»¥éœ€æ±‚åä¸º key</span>
    <span class="ss">:conflicts</span><span class="p">,</span>
    <span class="c1"># [Array&lt;UnwindDetails&gt;] è®°å½•ç€æœªå¤„ç†è¿‡çš„éœ€è¦ç”¨äºå›æº¯çš„ä¿¡æ¯</span>
    <span class="ss">:unused_unwind_options</span>
  <span class="p">)</span>

  <span class="k">class</span> <span class="nc">ResolutionState</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">empty</span>
      <span class="kp">new</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="o">[]</span><span class="p">,</span> <span class="no">DependencyGraph</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{},</span> <span class="o">[]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># è®°å½•ä¸€ç»„éœ€æ±‚å’Œæ»¡è¶³å½“å‰éœ€æ±‚çš„å¯èƒ½æ€§</span>
  <span class="k">class</span> <span class="nc">DependencyState</span> <span class="o">&lt;</span> <span class="no">ResolutionState</span>
	 <span class="c1"># é€šè¿‡ä¸æ–­ pop è¿‡æ»¤åŒ…å«çš„å¯èƒ½æ€§ï¼Œæ‰¾å‡ºæœ€ç¬¦åˆéœ€æ±‚çš„è§£</span>
    <span class="k">def</span> <span class="nf">pop_possibility_state</span>
      <span class="no">PossibilityState</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="nb">name</span><span class="p">,</span>
        <span class="n">requirements</span><span class="o">.</span><span class="n">dup</span><span class="p">,</span>
        <span class="n">activated</span><span class="p">,</span>
        <span class="n">requirement</span><span class="p">,</span>
        <span class="o">[</span><span class="n">possibilities</span><span class="o">.</span><span class="n">pop</span><span class="o">]</span><span class="p">,</span>
        <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">conflicts</span><span class="o">.</span><span class="n">dup</span><span class="p">,</span>
        <span class="n">unused_unwind_options</span><span class="o">.</span><span class="n">dup</span>
      <span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">state</span><span class="o">|</span>
        <span class="n">state</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ä»…åŒ…å«ä¸€ä¸ªæ»¡è¶³éœ€æ±‚çš„å¯èƒ½æ€§</span>
  <span class="k">class</span> <span class="nc">PossibilityState</span> <span class="o">&lt;</span> <span class="no">ResolutionState</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>å…‰çœ‹ state å®šä¹‰å¤§å®¶å¯èƒ½è§‰å¾—äº‘é‡Œé›¾é‡Œã€‚è¿™é‡Œå¾ˆæœ‰å¿…è¦è§£é‡Šä¸€ä¸‹ï¼š</p>
<p>æˆ‘ä»¬è¯´çš„éœ€æ±‚ (<code>requirement</code>) åˆ°åº•æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿå¤§å®¶å¯ä»¥ç†è§£ä¸ºåœ¨ <code>Podfile</code> ä¸­å£°æ˜çš„ podã€‚**ä¹‹æ‰€ä»¥ç§°ä¸ºéœ€æ±‚ï¼Œæ˜¯ç”±äºæ— æ³•åˆ¤æ–­å®šä¹‰çš„ dependency æ˜¯å¦åˆæ³•ã€‚**å‡è®¾å®ƒåˆæ³•ï¼Œåˆæ˜¯å¦å­˜åœ¨ç¬¦åˆéœ€æ±‚é™åˆ¶ç‰ˆæœ¬çš„è§£å‘¢ ï¼Ÿå³æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ <code>PodSpec</code> æˆ‘ä»¬ä¸è€ŒçŸ¥ã€‚å› æ­¤ï¼Œè¿™äº›æœªçŸ¥çŠ¶æ€ç§°ä¸ºç»Ÿä¸€è¢«å¯èƒ½æ€§ <code>possibility</code>ã€‚</p>
<blockquote>
<p>Tips: äº†è§£è¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œè¿™ä¹Ÿæ˜¯ç¬”è€…åœ¨å‡ ä¹å†™å®Œæœ¬æ–‡çš„æƒ…å†µä¸‹ï¼Œæ‰æƒ³æ˜ç™½è¿™äº›å˜é‡åçš„æ„ä¹‰ã€‚ğŸ’”</p>
</blockquote>
<h3 id="resolution-loop">Resolution Loop</h3>
<p>æˆ‘ä»¬å…ˆé€šè¿‡å›¾æ¥äº†è§£ä¸€ä¸‹ Molinillo çš„æ ¸å¿ƒæµç¨‹ (å…ˆå¿½ç•¥å¼‚å¸¸æµï¼‰ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/07-backtrack-state.png" alt="07-backtrack-state"></p>
<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªæµç¨‹å°±æ˜¯ä¸æ–­çš„å°† requirement çš„ possibility è¿‡æ»¤å’Œå¤„ç†ï¼Œä¸€å±‚å±‚å‰¥ç¦»è½¬æ¢ä¸º <code>DependencyState</code>ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚</p>
<p>Molinillo çš„å…¥å£ä¸º <code>Resolution::resolve</code> æ–¹æ³•ï¼Œä¹Ÿæ˜¯ä¸Šå›¾å¯¹åº”çš„å®ç°ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/molinillo/resolution.rb</span>

<span class="k">def</span> <span class="nf">resolve</span>
  <span class="c1"># 1. åˆå§‹åŒ– timer ç»Ÿè®¡è€—æ—¶åˆå§‹ä½ç½®æ‰“ç‚¹</span>
  <span class="c1"># 2. å†…éƒ¨ä¼šè°ƒç”¨ push_initial_state åˆå§‹åŒ– DependencyState å‹æ ˆ</span>
  <span class="c1"># 3. åˆå§‹åŒ– DependencyGraph å®ä¾‹</span>
  <span class="n">start_resolution</span>

  <span class="k">while</span> <span class="n">state</span>
    <span class="k">break</span> <span class="k">if</span> <span class="o">!</span><span class="n">state</span><span class="o">.</span><span class="n">requirement</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">empty?</span>
    <span class="c1"># è¾“å‡ºä¸€ä¸ªè¿›åº¦å ä½</span>
    <span class="n">indicate_progress</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:pop_possibility_state</span><span class="p">)</span> <span class="c1"># DependencyState</span>
      <span class="c1"># è°ƒè¯•æ—¥å¿—å…¥å£</span>
      <span class="c1"># å¦‚æœç¯å¢ƒå˜é‡ MOLINILLO_DEBUG æ˜¯é nil å°±è¾“å‡º log</span>
      <span class="c1"># è¿™é‡Œçš„è°ƒè¯•æ—¥å¿—æœ‰åŠ©äºæ’æŸ¥ Pod ç»„ä»¶çš„ä¾èµ–é—®é¢˜</span>
      <span class="n">debug</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Creating possibility state for </span><span class="si">#{</span><span class="n">requirement</span><span class="si">}</span><span class="s2"> (</span><span class="si">#{</span><span class="n">possibilities</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> remaining)&#34;</span> <span class="p">}</span>
      <span class="n">state</span><span class="o">.</span><span class="n">pop_possibility_state</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">s</span>
          <span class="n">states</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
          <span class="n">activated</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1"># å¤„ç†æ ˆé¡¶ Possibility State</span>
    <span class="n">process_topmost_state</span>
  <span class="k">end</span>
  <span class="c1"># éå† Dependency Graph </span>
  <span class="n">resolve_activated_specs</span>
<span class="k">ensure</span>
  <span class="n">end_resolution</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>é¦–å…ˆ <code>#start_resolution</code> ä¼šåˆå§‹åŒ– timer ç”¨äºç»Ÿè®¡è§£æè€—æ—¶ï¼Œå¹¶è°ƒç”¨ <code>#push_initial_state</code> åˆå§‹åŒ– <code>DependencyState</code> å…¥æ ˆï¼Œä»¥åŠ <strong>DependencyGraph</strong> åˆå§‹åŒ–ã€‚</li>
<li>è·å–æ ˆé¡¶ state æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¾…è§£æéœ€æ±‚ï¼Œæ¥ç€è°ƒç”¨ <code>#pop_possibility_state</code> è¿›è¡Œ state è½¬æ¢å¹¶å…¥æ ˆã€‚</li>
<li>è°ƒç”¨ <code>#process_topmost_state</code> å¤„ç†æ ˆé¡¶çš„ possiblity stateï¼Œå¦‚æœå½“å‰ state å¯è¢«æ¿€æ´»ï¼Œåˆ™å°†è¯¥ possiblity å­˜å…¥ DependencyGraph å¯¹åº”é¡¶ç‚¹çš„ payload ä¸­ã€‚å¦åˆ™åˆ¤å®šä¸ºå†²çªï¼Œéœ€è¦è¿›è¡ŒçŠ¶æ€å›æ»šã€‚</li>
<li>å¾ªç¯ç›´åˆ° state çš„å¯èƒ½æ€§å…¨éƒ¨å¤„ç†ç»“æŸã€‚</li>
<li>è°ƒç”¨ <code>#resolve_activated_specs</code> ï¼Œéå† DependencyGraph ä»¥å­˜å‚¨æ›´æ–°éœ€æ±‚çš„å¯èƒ½æ€§ï¼Œè§£æç»“æŸã€‚</li>
</ol>
<p>å½“ç„¶ï¼Œä¾èµ–å¤„ç†å¹¶éè¿™ä¹ˆç®€å•ï¼Œå¤æ‚çš„è¿‡æ»¤å’Œå›æº¯é€»è¾‘éƒ½éšè—åœ¨ <code>#process_topmost_state</code> ä¸­ã€‚</p>
<h3 id="resolutionstate-çš„å˜åŒ–">ResolutionState çš„å˜åŒ–</h3>
<p>å…¶å®ä» <code>ResolutionState</code> çš„å®šä¹‰èƒ½å¤Ÿçœ‹å‡ºï¼Œä¸ºäº†æ–¹ä¾¿å›æº¯å’Œæ•°æ®è¿˜åŸï¼Œstate æ˜¯ä»¥ Struct ç»“æ„å®šä¹‰çš„ã€‚åŒæ—¶åœ¨æ¯æ¬¡ <code>#pop_possibility_state</code> ä¸­ï¼Œé€šè¿‡ <strong><a href="https://stackoverflow.com/questions/10183370/whats-the-difference-between-rubys-dup-and-clone-methods">#dup</a></strong> å¯¹ diff æ•°æ®è¿›è¡Œäº†å¤åˆ¶ã€‚</p>
<p>è¿™é‡Œç”¨ä¾èµ–ä¼ é€’çš„ä¾‹å­æ¥å±•ç¤ºè§£æåçŠ¶æ€æ ˆçš„å˜åŒ–ã€‚å‡è®¾æˆ‘ä»¬åœ¨ Podfile ä¸­å£°æ˜äº† <code>Aï¼ŒBï¼ŒC</code> ä¸‰ä¸ªä¾èµ–ï¼Œä»–ä»¬çš„å…³ç³»ä¸ºï¼š<code>A -&gt; B -&gt; C</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">target</span> <span class="s1">&#39;Example&#39;</span> <span class="k">do</span>
  <span class="n">pod</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;../&#39;</span>
  <span class="n">pod</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;../&#39;</span>  
  <span class="n">pod</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="err">&#39;</span><span class="o">../</span><span class="err">â€™</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>#resolve_activated_specs</code> æ–¹æ³•è®¾ç½®æ–­ç‚¹ï¼Œåœ¨è§£æç»“æŸæ—¶æ‰“å°çŠ¶æ€æ ˆ <code>@states</code>ï¼ˆç®€åŒ–å¤„ç†åï¼‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"> <span class="o">[</span>
   <span class="c1">#&lt;struct Molinillo::DependencyState name=&#34;C&#34;, requirements=[B, A], ...&gt;, </span>
   <span class="c1">#&lt;struct Molinillo::PossibilityState name=&#34;C&#34;, requirements=[B, A], ...&gt;</span>
   <span class="c1">#&lt;struct Molinillo::DependencyState name=&#34;B&#34;, requirements=[A], ...&gt;</span>
   <span class="c1">#&lt;struct Molinillo::PossibilityState name=&#34;B&#34;, requirements=[A], ...&gt;</span>
   <span class="c1"># çœç•¥äº† Cã€Cã€Aã€A...</span>
   <span class="c1">#&lt;struct Molinillo::DependencyState name=&#34;B&#34;, requirements=[], ..., </span>
   <span class="c1">#&lt;struct Molinillo::PossibilityState name=&#34;B&#34;, requirements=[], ..., </span>
   <span class="c1">#&lt;struct Molinillo::DependencyState name=&#34;&#34;, requirements=[], ..., </span>
<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°æ ˆå†…ä¿å­˜çš„ states ä¸­ <code>DependencyState</code> ä¸ <code>PossibilityState</code> æ˜¯æˆå¯¹å‡ºç°çš„ã€‚ä¸è¿‡æœ€åå…¥æ ˆçš„ <code>DependencyState</code> æ˜¯ä¸€ä¸ªç©ºçŠ¶æ€ï¼Œrequirements ä¹Ÿä¸ºç©ºï¼Œæ­¤æ—¶æ— æ³•å† pop state å¾ªç¯ç»“æŸã€‚</p>
<h2 id="dependencygraph">DependencyGraph</h2>
<p>å…¶å®åŒ…æ‹¬ Molinillo åœ¨å†…çš„ä¾èµ–è§£æå·¥å…·éƒ½ä¼šåœ¨è¿è¡ŒæœŸé—´å¯¹ä¾èµ–å…³ç³»è¿›è¡Œå»ºæ¨¡æ¥æ„å»ºä¾èµ–å›¾ï¼Œæ¯•ç«Ÿè¿™æ˜¯æˆ‘ä»¬è¡¨è¾¾ä¾èµ–å…³ç³»çš„æ–¹å¼ã€‚é‚£ä¹ˆ DependencyGraph (ä»¥ä¸‹ç®€ç§° <code>dg</code> ) æ˜¯å¦‚ä½•å®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Molinillo</span>

  <span class="k">class</span> <span class="nc">DependencyGraph</span>
    <span class="c1"># æœ‰å‘è¾¹</span>
    <span class="no">Edge</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:origin</span><span class="p">,</span> <span class="ss">:destination</span><span class="p">,</span> <span class="ss">:requirement</span><span class="p">)</span>
    <span class="c1"># @return [{String =&gt; Vertex}] ç”¨å­—å…¸ä¿å­˜é¡¶ç‚¹, key ä¸ºé¡¶ç‚¹åç§°(å³ requirement.name)</span>
    <span class="kp">attr_reader</span> <span class="ss">:vertices</span>
    <span class="c1"># @return [Log] æ“ä½œæ—¥å¿—</span>
    <span class="kp">attr_reader</span> <span class="ss">:log</span>
	 <span class="o">...</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦å¤– <strong>Vertex</strong> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="k">class</span> <span class="nc">DependencyGraph</span>
    <span class="k">class</span> <span class="nc">Vertex</span>
      <span class="kp">attr_accessor</span> <span class="ss">:name</span>
      <span class="c1"># @return [Object] é¡¶ç‚¹çš„å…ƒæ•°æ®ï¼Œreqiuremnt å¯¹åº”çš„ possiblity</span>
      <span class="kp">attr_accessor</span> <span class="ss">:payload</span>
      <span class="c1"># @return [Array&lt;Object&gt;] éœ€è¦ä¾èµ–è¯¥é¡¶ç‚¹å¯èƒ½æ€§èƒ½çš„éœ€æ±‚</span>
      <span class="kp">attr_reader</span> <span class="ss">:explicit_requirements</span>
      <span class="c1"># @return [Boolean] æ˜¯å¦ä¸ºæ ¹ç»“ç‚¹</span>
      <span class="kp">attr_accessor</span> <span class="ss">:root</span>
      <span class="c1"># @return [Array&lt;Edge&gt;] å‡ºåº¦ {Edge#origin}</span>
      <span class="kp">attr_accessor</span> <span class="ss">:outgoing_edges</span>
      <span class="c1"># @return [Array&lt;Edge&gt;] å…¥åº¦ {Edge#destination}</span>
      <span class="kp">attr_accessor</span> <span class="ss">:incoming_edges</span>
      <span class="c1"># @return [Array&lt;Vertex&gt;] å…¥åº¦çš„èµ·ç‚¹</span>
      <span class="k">def</span> <span class="nf">predecessors</span>
        <span class="n">incoming_edges</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:origin</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="c1"># @return [Array&lt;Vertex&gt;] å‡ºåº¦çš„ç»ˆç‚¹</span>
      <span class="k">def</span> <span class="nf">successors</span>
        <span class="n">outgoing_edges</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:destination</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="o">...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>ç†Ÿæ‚‰å›¾è®ºçš„åŒå­¦éƒ½äº†è§£ï¼Œå›¾çš„ä¿å­˜å¸¸ç”¨çš„æ–¹å¼æ˜¯<strong>é‚»æ¥è¡¨</strong>å’Œ<strong>é‚»æ¥çŸ©é˜µ</strong>ã€‚Molinillo åˆ™é€šè¿‡ map + listï¼Œvertext å­—å…¸ä¸è¾¹é›†æ•°ç»„æ¥ä¿å­˜ã€‚å¦‚æœä»…ç”¨è¾¹é›†æ•°ç»„æ¥æŸ¥è¯¢é¡¶ç‚¹æœ¬èº«æ•ˆç‡å¹¶ä¸é«˜ï¼Œå¥½åœ¨é¡¶ç‚¹ç›´æ¥ç”¨äº†å­—å…¸ä¿å­˜äº†ã€‚Molinillo é€šè¿‡æ ˆæ¥ç»´æŠ¤è§£æçŠ¶æ€ï¼Œä¸æ–­å°†è§£æç»“æœ possibility å­˜å…¥ dg çš„ payload ä¸­ï¼ŒåŒæ—¶è®°å½•äº†å„ä¸ªé¡¶ç‚¹çš„ä¾èµ–å…³ç³»ï¼Œå³ dg çš„å‡ºåº¦å’Œå…¥åº¦ã€‚</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/06-Vertex.png" alt="06-Vertex"></p>
<blockquote>
<ul>
<li>åœ¨æœ‰å‘å›¾ä¸­å¯¹äºä¸€ä¸ªé¡¶ç‚¹æ¥è¯´ï¼Œå¦‚æœä¸€æ¡è¾¹çš„ç»ˆç‚¹æ˜¯è¿™ä¸ªé¡¶ç‚¹ï¼Œè¿™æ¡è¾¹å°±æ˜¯è¿™ä¸ªé¡¶ç‚¹çš„å…¥åº¦ï¼›</li>
<li>åœ¨æœ‰å‘å›¾ä¸­å¯¹äºä¸€ä¸ªé¡¶ç‚¹æ¥è¯´ï¼Œå¦‚æœä¸€æ¡è¾¹çš„èµ·ç‚¹æ˜¯è¿™ä¸ªé¡¶ç‚¹ï¼Œè¿™æ¡è¾¹å°±æ˜¯è¿™ä¸ªé¡¶ç‚¹çš„å‡ºåº¦ã€‚</li>
</ul>
</blockquote>
<p>å½“æˆåŠŸè§£æçš„ä¸€åˆ»ï¼Œdg å›¾ä¹Ÿæ„å»ºå®Œæ¯•ã€‚</p>
<h3 id="operation-log">Operation Log</h3>
<p>å½“è§£æè¿‡ç¨‹å‡ºç°å†²çªæ—¶ï¼ŒçŠ¶æ€æ ˆè¦å›æº¯ç›´æ¥ pop ä¸€ä¸‹å°±å®Œäº‹äº†ï¼Œè€Œ dg å’‹åŠ ? å®ƒå¯æ²¡æ³• popã€‚</p>
<p>å¥½åœ¨ Molinillo è®¾è®¡äº† Operation Log æœºåˆ¶ï¼Œé€šè¿‡ Log è®°å½• dg æ‰§è¡Œè¿‡çš„æ“ä½œã€‚è¿™äº›æ“ä½œç±»å‹åŒ…æ‹¬ï¼š<strong>AddEdgeNoCircularã€AddVertexã€DeleteEdgeã€DetachVertexNamedã€SetPayloadã€Tag</strong>ã€‚</p>
<p>Log ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># frozen_string_literal: true</span>

<span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="k">class</span> <span class="nc">DependencyGraph</span>
    <span class="k">class</span> <span class="nc">Log</span>
      <span class="k">def</span> <span class="nf">initialize</span>
        <span class="vi">@current_action</span> <span class="o">=</span> <span class="vi">@first_action</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">pop!</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="n">action</span> <span class="o">=</span> <span class="vi">@current_action</span>
        <span class="k">unless</span> <span class="vi">@current_action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">previous</span>
          <span class="vi">@first_action</span> <span class="o">=</span> <span class="kp">nil</span>
        <span class="k">end</span>
        <span class="n">action</span><span class="o">.</span><span class="n">down</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">action</span>
      <span class="k">end</span>

      <span class="c1"># å›æ’¤åˆ°æŒ‡å®šçš„æ“ä½œèŠ‚ç‚¹</span>
      <span class="k">def</span> <span class="nf">rewind_to</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="kp">loop</span> <span class="k">do</span>
          <span class="n">action</span> <span class="o">=</span> <span class="n">pop!</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
          <span class="k">raise</span> <span class="s2">&#34;No tag </span><span class="si">#{</span><span class="n">tag</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> found&#34;</span> <span class="k">unless</span> <span class="n">action</span>
          <span class="k">break</span> <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">action_name</span> <span class="o">==</span> <span class="ss">:tag</span> <span class="o">&amp;&amp;</span> <span class="n">action</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">tag</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="kp">private</span>

      <span class="c1"># æ’å…¥æ“ä½œèŠ‚ç‚¹</span>
      <span class="k">def</span> <span class="nf">push_action</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="n">action</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="vi">@current_action</span>
        <span class="vi">@current_action</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">action</span> <span class="k">if</span> <span class="vi">@current_action</span>
        <span class="vi">@current_action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="vi">@first_action</span> <span class="o">||=</span> <span class="n">action</span>
        <span class="n">action</span><span class="o">.</span><span class="n">up</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="o">...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>æ ‡å‡†çš„é“¾è¡¨ç»“æ„ï¼ŒLog æä¾›äº†å½“å‰æŒ‡é’ˆ <code>@current_action</code> å’Œè¡¨å¤´æŒ‡é’ˆ <code>@first_action</code> ä¾¿äºé“¾è¡¨çš„éå†ã€‚æ¥ç€çœ‹çœ‹ Actionï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># frozen_string_literal: true</span>

<span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="k">class</span> <span class="nc">DependencyGraph</span>

    <span class="k">class</span> <span class="nc">Action</span>
      <span class="c1"># @return [Symbol] action åç§°</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">action_name</span>
        <span class="k">raise</span> <span class="s1">&#39;Abstract&#39;</span>
      <span class="k">end</span>

      <span class="c1"># å¯¹å›¾æ‰§è¡Œæ­£å‘æ“ä½œ</span>
      <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">raise</span> <span class="s1">&#39;Abstract&#39;</span>
      <span class="k">end</span>

      <span class="c1"># æ’¤é”€å¯¹å›¾çš„æ“ä½œ</span>
      <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">raise</span> <span class="s1">&#39;Abstract&#39;</span>
      <span class="k">end</span>
       
      <span class="c1"># @return [Action,Nil] å‰åºèŠ‚ç‚¹</span>
      <span class="kp">attr_accessor</span> <span class="ss">:previous</span>
      <span class="c1"># @return [Action,Nil] ååºèŠ‚ç‚¹</span>
      <span class="kp">attr_accessor</span> <span class="ss">:next</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>Action æœ¬èº«æ˜¯ä¸ªæŠ½è±¡ç±»ï¼ŒLog é€šè¿‡ Action å­ç±»çš„ <code>#up</code>ã€<code>#down</code> æ¥å®Œæˆå¯¹ dg çš„æ“ä½œå’Œæ’¤é”€ã€‚æ‰€æä¾›çš„ Action ä¸­é™¤äº† <strong>Tag</strong> ç‰¹æ®Šä¸€ç‚¹ï¼Œå…¶ä½™å‡æ˜¯å¯¹ dg çš„é¡¶ç‚¹å’Œè¾¹çš„ CURD æ“ä½œã€‚è¿™é‡Œä»¥ <code>AddVertex</code> ä¸ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># frozen_string_literal: true</span>

<span class="n">require_relative</span> <span class="s1">&#39;action&#39;</span>
<span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="k">class</span> <span class="nc">DependencyGraph</span>
	 <span class="c1"># @!visibility private</span>
    <span class="k">class</span> <span class="nc">AddVertex</span> <span class="o">&lt;</span> <span class="no">Action</span> <span class="c1"># :nodoc:</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">action_name</span>
        <span class="ss">:add_vertex</span>
      <span class="k">end</span>
      
      <span class="c1"># æ“ä½œæ·»åŠ é¡¶ç‚¹</span>
      <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span>
          <span class="vi">@existing_payload</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">payload</span>
          <span class="vi">@existing_root</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">root</span>
        <span class="k">end</span>
        <span class="n">vertex</span> <span class="o">=</span> <span class="n">existing</span> <span class="o">||</span> <span class="no">Vertex</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">[</span><span class="n">vertex</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">vertex</span>
        <span class="n">vertex</span><span class="o">.</span><span class="n">payload</span> <span class="o">||=</span> <span class="n">payload</span>
        <span class="n">vertex</span><span class="o">.</span><span class="n">root</span> <span class="o">||=</span> <span class="n">root</span>
        <span class="n">vertex</span>
      <span class="k">end</span>

      <span class="c1"># åˆ é™¤é¡¶ç‚¹</span>
      <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="vi">@existing_payload</span><span class="p">)</span>
          <span class="n">vertex</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span>
          <span class="n">vertex</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="vi">@existing_payload</span>
          <span class="n">vertex</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="vi">@existing_root</span>
        <span class="k">else</span>
          <span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># @return [String] é¡¶ç‚¹åç§° (æˆ–è€…è¯´ä¾èµ–åç§°)</span>
      <span class="kp">attr_reader</span> <span class="ss">:name</span>
      <span class="c1"># @return [Object] é¡¶ç‚¹å…ƒæ•°æ®</span>
      <span class="kp">attr_reader</span> <span class="ss">:payload</span>
      <span class="c1"># @return [Boolean] æ˜¯å¦ä¸ºæ ¹</span>
      <span class="kp">attr_reader</span> <span class="ss">:root</span>
		<span class="o">...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>Action å­ç±»å‡å£°æ˜ä¸º private çš„ï¼Œé€šè¿‡ Log æä¾›çš„å¯¹åº”æ–¹æ³•æ¥æ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
  <span class="n">push_action</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">add_vertex</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">push_action</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="no">AddVertex</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">root</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">detach_vertex_named</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
  <span class="n">push_action</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="no">DetachVertexNamed</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">add_edge_no_circular</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">requirement</span><span class="p">)</span>
  <span class="n">push_action</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="no">AddEdgeNoCircular</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">requirement</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">delete_edge</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">origin_name</span><span class="p">,</span> <span class="n">destination_name</span><span class="p">,</span> <span class="n">requirement</span><span class="p">)</span>
  <span class="n">push_action</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="no">DeleteEdge</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin_name</span><span class="p">,</span> <span class="n">destination_name</span><span class="p">,</span> <span class="n">requirement</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">set_payload</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="n">push_action</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="no">SetPayload</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>æœ€å log å£°æ˜çš„è¿™äº›æ–¹æ³•ä¼šç”± dg ç›´æ¥è°ƒç”¨ï¼Œå¦‚ <code>#addVertext</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="k">class</span> <span class="nc">DependencyGraph</span>
    <span class="k">def</span> <span class="nf">add_vertex</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
      <span class="n">log</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="unwind-for-conflict">Unwind For Conflict</h2>
<p>æœ‰äº† op log ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦ä¸€æ ·é‡è¦çš„ä¸œè¥¿ï¼š<strong>å“¨å…µèŠ‚ç‚¹</strong>ã€‚ç”± Tag ç±»æ¥æ‰¿è½½ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># frozen_string_literal: true</span>
<span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="k">class</span> <span class="nc">DependencyGraph</span>
    <span class="c1"># @!visibility private     </span>
    <span class="k">class</span> <span class="nc">Tag</span> <span class="o">&lt;</span> <span class="no">Action</span>

      <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
      <span class="k">end</span>
       
      <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="kp">attr_reader</span> <span class="ss">:tag</span>

      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="vi">@tag</span> <span class="o">=</span> <span class="n">tag</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>ä½œä¸ºå“¨å…µèŠ‚ç‚¹ Tag çš„ <strong>#up</strong> ä¸ <strong>#down</strong> æ“ä½œæ€»æ˜¯æˆå¯¹å‡ºç°çš„ã€‚åœ¨ Molinillo ä¸­æœ‰ä¸¤å¤„éœ€è¦è¿›è¡ŒçŠ¶æ€å›æº¯ï¼Œåˆ†åˆ«ä¸ºå¯èƒ½æ€§æ ¡éªŒå’Œå†²çªçŠ¶æ€å›æ’¤ã€‚</p>
<h3 id="0x1-å¯èƒ½æ€§æ ¡éªŒ">0x1 å¯èƒ½æ€§æ ¡éªŒ</h3>
<p><code>#possibility_satisfies_requirements?</code> æ–¹æ³•ç”¨äºå†²çªäº§ç”Ÿçš„å‰åï¼Œç”¨äºåˆ¤æ–­è¯¥å¯èƒ½æ€§èƒ½å¦åŒæ—¶æ»¡è¶³å¤šä¸ªéœ€æ±‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">possibility_satisfies_requirements?</span><span class="p">(</span><span class="n">possibility</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="n">name_for</span><span class="p">(</span><span class="n">possibility</span><span class="p">)</span>

  <span class="n">activated</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="ss">:swap</span><span class="p">)</span>
  <span class="n">activated</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">possibility</span><span class="p">)</span> <span class="k">if</span> <span class="n">activated</span><span class="o">.</span><span class="n">vertex_named</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="n">satisfied</span> <span class="o">=</span> <span class="n">requirements</span><span class="o">.</span><span class="n">all?</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">requirement_satisfied_by?</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">activated</span><span class="p">,</span> <span class="n">possibility</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">activated</span><span class="o">.</span><span class="n">rewind_to</span><span class="p">(</span><span class="ss">:swap</span><span class="p">)</span>

  <span class="n">satisfied</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†ç›´è§‚çš„è¯´æ˜å‚æ•°ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ã€‚<code>Case 1</code>å‡è®¾ <code>Podfile</code> ä¸­å­˜åœ¨ pod A å’Œ Bï¼Œä¸” Aã€B åˆ†åˆ«ä¾èµ–äº† Alamofire 3.0 å’Œ 4.0ï¼Œé‚£ä¹ˆå¯¹åº”çš„å‚æ•°ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="ss">possibility</span><span class="p">:</span> <span class="c1">#&lt;Pod::Specification name=&#34;Alamofire&#34; version=&#34;4.0.0&#34;&gt;</span>
<span class="ss">requirements</span><span class="p">:</span> <span class="o">[</span>
	<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Alamofire</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span><span class="p">,</span> 		<span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Alamofire</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mi">4</span><span class="o">.</span><span class="mi">0</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨æ¥çœ‹æ–¹æ³•å®ç°ï¼š</p>
<ol>
<li>é¦–å…ˆ <code>activated</code> å°±æ˜¯ Podfile è§£æç”Ÿæˆçš„ dg å¯¹è±¡ï¼Œè¿™é‡Œå°† symbol <code>:swap</code> ä½œä¸ºæ ‡è¯†ç”¨äºç¨åçš„å›æ’¤ï¼›</li>
<li>è°ƒç”¨ <code>#set_payload</code> å°†é¡¶ç‚¹ Alamofire çš„ payload ä¿®æ”¹ä¸º possibility ç‰ˆæœ¬ï¼›</li>
<li>éå† requirements å¹¶è°ƒç”¨ä»£ç†çš„ <code>#requirement_satisfied_by</code> ä»¥æ ¡éªŒ possiblity åœ¨ dg ä¸­å­˜åœ¨çš„å¯èƒ½æ€§ï¼›</li>
<li>è°ƒç”¨ <code>#rewind_to</code> å°†é¡¶ç‚¹çš„ä¿®æ”¹å›æ’¤è‡³ <code>:swap</code> å‰çš„çŠ¶æ€ï¼Œæœ€åè¿”å›æ£€éªŒç»“æœã€‚</li>
</ol>
<blockquote>
<p>Tips: æ­¤å¤„çš„ä»£ç†æ˜¯æŒ‡ CocoaPodsï¼Œå®ƒåšä¸º Molinillo çš„ client å®ç°äº†å¾ˆå¤šä»£ç†æ–¹æ³•ï¼Œåç»­ä¼šèŠåˆ°ã€‚</p>
</blockquote>
<p>ä½œä¸ºå€™é€‰é¡¹ possibility å½“ç„¶ä¸æ­¢ä¸€ä¸ªï¼Œä»£ç†æä¾›çš„æŸ¥è¯¢æ–¹æ³• <code>#search_for(dependency)</code> ä¼šè¿”å›æ‰€æœ‰ç¬¦åˆ requiremnt åç§°çš„ä¾èµ–ã€‚åœ¨ CocoaPods ä¸­ï¼Œå°±æ˜¯é€šè¿‡ <code>Pod::Source</code> æŸ¥è¯¢è·å¾—æ‰€æœ‰ç‰ˆæœ¬çš„ <code>Pod::Specification</code>ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/275680356">PodSpec ç®¡ç†ç­–ç•¥</a>ã€‚</p>
<h3 id="0x2-å†²çªçŠ¶æ€å›æ’¤">0x2 å†²çªçŠ¶æ€å›æ’¤</h3>
<p>ä¾èµ–è§£æè¿‡ç¨‹å‡ºç°å†²çªå±äºæ­£å¸¸æƒ…å†µï¼Œæ­¤æ—¶é€šè¿‡å›æ’¤ä¹Ÿè®¸å¯ä»¥é¿å…éƒ¨åˆ†å†²çªï¼Œæ‰¾å‡ºå…¶å®ƒå¯è¡Œè§£ã€‚Molinillo é€šè¿‡å®šä¹‰ <code>Conflict</code> æ¥è®°å½•å½“å‰çš„å†²çªçš„å¿…è¦ä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Conflict</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">:requirement</span><span class="p">,</span>
  <span class="ss">:requirements</span><span class="p">,</span>
  <span class="ss">:existing</span><span class="p">,</span>
  <span class="ss">:possibility_set</span><span class="p">,</span>
  <span class="ss">:locked_requirement</span><span class="p">,</span>
  <span class="ss">:requirement_trees</span><span class="p">,</span>
  <span class="ss">:activated_by_name</span><span class="p">,</span>
  <span class="ss">:underlying_error</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>é‡ç‚¹å…³æ³¨ <code>underlying_error</code>ï¼Œå®ƒè®°å½•äº†æ‰€æ‹¦æˆªçš„æŒ‡å®šç±»å‹é”™è¯¯ï¼Œå¹¶ç”¨äºçŠ¶æ€å›æ’¤æ—¶çš„ä¸€äº›åˆ¤æ–­ä¾æ® (åé¢ä¼šè§£é‡Š)ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å®šä¹‰çš„é”™è¯¯ç±»å‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># frozen_string_literal: true</span>

<span class="k">module</span> <span class="nn">Molinillo</span>

  <span class="k">class</span> <span class="nc">ResolverError</span> <span class="o">&lt;</span> <span class="no">StandardError</span><span class="p">;</span> <span class="k">end</span>
   
  <span class="c1"># é”™è¯¯ä¿¡æ¯ï¼š&#34;Unable to find a specification for `#{dependency}`&#34;</span>
  <span class="k">class</span> <span class="nc">NoSuchDependencyError</span> <span class="o">&lt;</span> <span class="no">ResolverError</span> <span class="o">...</span> <span class="k">end</span>
        
  <span class="c1"># é”™è¯¯ä¿¡æ¯ï¼š&#34;There is a circular dependency between ...&#34;</span>
  <span class="k">class</span> <span class="nc">CircularDependencyError</span> <span class="o">&lt;</span> <span class="no">ResolverError</span> <span class="o">...</span> <span class="k">end</span>
        
  <span class="c1"># å½“å‡ºç°ç‰ˆæœ¬å†²çªæ—¶æŠ›å‡º</span>
  <span class="c1"># é”™è¯¯ä¿¡æ¯ï¼š&#34;Unable to satisfy the following requirements:\n\n ...&#34;</span>
  <span class="k">class</span> <span class="nc">VersionConflict</span> <span class="o">&lt;</span> <span class="no">ResolverError</span> <span class="o">...</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>é™¤äº†ä¸»åŠ¨æ‹¦æˆªé”™è¯¯ä¹‹å¤–ï¼Œpossiblity ä¸å­˜åœ¨æ—¶ä¹Ÿä¼šä¸»åŠ¨ç”Ÿæˆå†²çªï¼ŒåŒæ—¶è¿›å…¥çŠ¶æ€å›æ’¤å¤„ç†ã€‚å‘ç”Ÿå†²çªåè°ƒç”¨ <code>#create_conflict</code> å’Œ <code>#unwind_for_conflict</code> ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºç”Ÿæˆ Conflict å¯¹è±¡å’ŒçŠ¶æ€å›æ’¤ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">process_topmost_state</span>
  <span class="k">if</span> <span class="n">possibility</span>
    <span class="n">attempt_to_activate</span>
  <span class="k">else</span>
    <span class="n">create_conflict</span>
    <span class="n">unwind_for_conflict</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="no">CircularDependencyError</span> <span class="o">=&gt;</span> <span class="n">underlying_error</span>
  <span class="n">create_conflict</span><span class="p">(</span><span class="n">underlying_error</span><span class="p">)</span>
  <span class="n">unwind_for_conflict</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">attempt_to_activate</span>
  <span class="n">debug</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;Attempting to activate &#39;</span> <span class="o">+</span> <span class="n">possibility</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
  <span class="n">existing_vertex</span> <span class="o">=</span> <span class="n">activated</span><span class="o">.</span><span class="n">vertex_named</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">existing_vertex</span><span class="o">.</span><span class="n">payload</span>
    <span class="n">debug</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Found existing spec (</span><span class="si">#{</span><span class="n">existing_vertex</span><span class="o">.</span><span class="n">payload</span><span class="si">}</span><span class="s2">)&#34;</span> <span class="p">}</span>
    <span class="n">attempt_to_filter_existing_spec</span><span class="p">(</span><span class="n">existing_vertex</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">latest</span> <span class="o">=</span> <span class="n">possibility</span><span class="o">.</span><span class="n">latest_version</span>
    <span class="n">possibility</span><span class="o">.</span><span class="n">possibilities</span><span class="o">.</span><span class="n">select!</span> <span class="k">do</span> <span class="o">|</span><span class="n">possibility</span><span class="o">|</span>
      <span class="n">requirement_satisfied_by?</span><span class="p">(</span><span class="n">requirement</span><span class="p">,</span> <span class="n">activated</span><span class="p">,</span> <span class="n">possibility</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="n">possibility</span><span class="o">.</span><span class="n">latest_version</span><span class="o">.</span><span class="n">nil?</span>
      <span class="c1"># ensure there&#39;s a possibility for better error messages</span>
      <span class="n">possibility</span><span class="o">.</span><span class="n">possibilities</span> <span class="o">&lt;&lt;</span> <span class="n">latest</span> <span class="k">if</span> <span class="n">latest</span>
      <span class="n">create_conflict</span>
      <span class="n">unwind_for_conflict</span>
    <span class="k">else</span>
      <span class="n">activate_new_spec</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">attempt_to_filter_existing_spec</span><span class="p">(</span><span class="n">vertex</span><span class="p">)</span>
  <span class="n">filtered_set</span> <span class="o">=</span> <span class="n">filtered_possibility_set</span><span class="p">(</span><span class="n">vertex</span><span class="p">)</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">filtered_set</span><span class="o">.</span><span class="n">possibilities</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">activated</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">filtered_set</span><span class="p">)</span>
    <span class="n">new_requirements</span> <span class="o">=</span> <span class="n">requirements</span><span class="o">.</span><span class="n">dup</span>
    <span class="n">push_state_for_requirements</span><span class="p">(</span><span class="n">new_requirements</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">create_conflict</span>
    <span class="n">debug</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Unsatisfied by existing spec (</span><span class="si">#{</span><span class="n">vertex</span><span class="o">.</span><span class="n">payload</span><span class="si">}</span><span class="s2">)&#34;</span> <span class="p">}</span>
    <span class="n">unwind_for_conflict</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°è¿™ 3 ä¸ªæ–¹æ³•ä¸­å¤„ç†äº† 4 å¤„å†²çªçš„æƒ…å†µã€‚å…¶ä¸­ <code>#process_topmost_state</code> æ–¹æ³•æ‹¦æˆªäº† <strong>CircularDependencyError</strong> å¹¶å°†å…¶è®°å½•åœ¨ Conflict çš„ <code>underlying_error</code> ä¸­ï¼Œå…¶ä½™çš„éƒ½æ˜¯å› ä¸º possibility å¯è¡Œè§£ä¸å­˜åœ¨è€Œä¸»åŠ¨æŠ›å‡ºå†²çªã€‚</p>
<p>æˆ‘ä»¬ç®€åŒ–æˆä¸‹é¢çš„çŠ¶æ€å›¾ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/08-process-topmost-state.png" alt="08-process-topmost-state"></p>
<p>å¯ä»¥ç†è§£ possiblity çŠ¶æ€æœºï¼Œé€šè¿‡ä¸æ–­æ£€æŸ¥å¯èƒ½æ€§ï¼Œä¸€æ—¦å‡ºé”™ä¸»åŠ¨ç”Ÿæˆå¼‚å¸¸ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš ï¼Ÿ å› ä¸ºçŠ¶æ€å›æº¯çš„æˆæœ¬æ˜¯å¾ˆé«˜çš„ï¼Œä¸€æ—¦å‘ç”Ÿæ„å‘³ç€æˆ‘ä»¬ä¹‹å‰æ£€æŸ¥å·¥ä½œå¯èƒ½å°±ç™½è´¹äº†ã€‚è¿™ä¹Ÿæ˜¯ Molinillo å‰å‘æŸ¥è¯¢çš„å……ç”µï¼Œé€šè¿‡ææ—©æš´éœ²é—®é¢˜ï¼Œæå‰å›æº¯ã€‚</p>
<p><strong>unwind_for_conflict</strong></p>
<p>äº†è§£äº†å†²çªæ—¶å¦‚ä½•äº§ç”Ÿä¹‹åï¼Œæ¥ä¸‹æ¥è¯¥ <code>#unwind_for_conflict</code> ç™»åœºäº†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">unwind_for_conflict</span>
  <span class="n">details_for_unwind</span> <span class="o">=</span> <span class="n">build_details_for_unwind</span>
  <span class="n">unwind_options</span> <span class="o">=</span> <span class="n">unused_unwind_options</span>
  <span class="n">debug</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;Unwinding for conflict: </span><span class="si">#{</span><span class="n">requirement</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">details_for_unwind</span><span class="o">.</span><span class="n">state_index</span> <span class="o">/</span> <span class="mi">2</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">}</span>
  <span class="n">conflicts</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
    <span class="n">sliced_states</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">slice!</span><span class="p">((</span><span class="n">details_for_unwind</span><span class="o">.</span><span class="n">state_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">..-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">raise_error_unless_state</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">activated</span><span class="o">.</span><span class="n">rewind_to</span><span class="p">(</span><span class="n">sliced_states</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="ss">:initial_state</span><span class="p">)</span> <span class="k">if</span> <span class="n">sliced_states</span>
    <span class="n">state</span><span class="o">.</span><span class="n">conflicts</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">state</span><span class="o">.</span><span class="n">unused_unwind_options</span> <span class="o">=</span> <span class="n">unwind_options</span>
    <span class="n">filter_possibilities_after_unwind</span><span class="p">(</span><span class="n">details_for_unwind</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="vi">@parents_of</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">_</span><span class="p">,</span> <span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">reject!</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">index</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">state</span><span class="o">.</span><span class="n">unused_unwind_options</span><span class="o">.</span><span class="n">reject!</span> <span class="p">{</span> <span class="o">|</span><span class="n">uw</span><span class="o">|</span> <span class="n">uw</span><span class="o">.</span><span class="n">state_index</span> <span class="o">&gt;=</span> <span class="n">index</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>å†²çªå›æº¯å°±æ¶‰åŠåˆ°å‰é¢è¯´è¿‡çš„ä¸¤ä¸ªçŠ¶æ€éœ€è¦å¤„ç†ï¼Œåˆ†åˆ«æ˜¯çŠ¶æ€æ ˆ <code>@states</code> å’Œ dg å†…å®¹çš„å›æº¯ã€‚ <code>@state</code> æœ¬èº«æ˜¯æ•°ç»„å®ç°çš„ï¼Œå…¶å…ƒç´ æ˜¯å„ä¸ªçŠ¶æ€çš„ state, è¦å›æº¯åˆ°æŒ‡å®šçš„ state åˆ™è¦åˆ©ç”¨ <code>state_index</code>ï¼Œå®ƒä¿å­˜åœ¨ <code>UnwindDetails</code> ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">UnwindDetails</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">:state_index</span><span class="p">,</span>
  <span class="ss">:state_requirement</span><span class="p">,</span>
  <span class="ss">:requirement_tree</span><span class="p">,</span>
  <span class="ss">:conflicting_requirements</span><span class="p">,</span>
  <span class="ss">:requirement_trees</span><span class="p">,</span>
  <span class="ss">:requirements_unwound_to_instead</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">UnwindDetails</span>
  <span class="kp">include</span> <span class="no">Comparable</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ requirement_treesï¼Œè¿™é‡Œæ˜¯æŒ‡ä»¥å½“å‰éœ€æ±‚ä½œä¸ºä¾èµ–çš„éœ€æ±‚ã€‚ä»¥ä¸Šé¢çš„ <code>Case 1</code> ä¸ºä¾‹ï¼Œå½“å‰å†²çªçš„ requirement å°±æ˜¯ Alamofireï¼Œå¯¹åº” requirement_trees å°±æ˜¯ä¾èµ–äº† Alamofire çš„ Pod A å’Œ Bï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="o">[</span>
  <span class="o">[</span>
    <span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="n">A</span> <span class="n">requirements</span><span class="o">=</span><span class="kp">nil</span> <span class="n">source</span><span class="o">=</span><span class="kp">nil</span> <span class="n">external_source</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Alamofire</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">0</span> <span class="o">...&gt;</span>
  <span class="o">]</span><span class="p">,</span><span class="o">[</span>
    <span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="n">B</span> <span class="o">...&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="no">Pod</span><span class="o">::</span><span class="no">Dependency</span> <span class="nb">name</span><span class="o">=</span><span class="no">Alamofire</span> <span class="n">requirements</span><span class="o">=~&gt;</span> <span class="mi">4</span><span class="o">.</span><span class="mi">0</span> <span class="o">...&gt;</span>
  <span class="o">]</span>
<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><p><code>#build_details_for_unwind</code> ä¸»è¦ç”¨äºç”Ÿæˆ UnwindDetailsï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">build_details_for_unwind</span>
  <span class="n">current_conflict</span> <span class="o">=</span> <span class="n">conflicts</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span>
  <span class="n">binding_requirements</span> <span class="o">=</span> <span class="n">binding_requirements_for_conflict</span><span class="p">(</span><span class="n">current_conflict</span><span class="p">)</span>
  <span class="n">unwind_details</span> <span class="o">=</span> <span class="n">unwind_options_for_requirements</span><span class="p">(</span><span class="n">binding_requirements</span><span class="p">)</span>

  <span class="n">last_detail_for_current_unwind</span> <span class="o">=</span> <span class="n">unwind_details</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">last</span>
  <span class="n">current_detail</span> <span class="o">=</span> <span class="n">last_detail_for_current_unwind</span>

  <span class="c1"># filter &amp; update details options</span>
  <span class="o">...</span>
  <span class="n">current_detail</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>ä»¥ conflict.requirement ä¸ºå‚æ•°ï¼Œæ‰§è¡Œ <code>#binding_requirements_for_conflict</code> ä»¥æŸ¥æ‰¾å‡ºå­˜åœ¨å†²çªçš„éœ€æ±‚ binding_requirementsã€‚æŸ¥è¯¢æ˜¯é€šè¿‡ä»£ç†çš„ <code>#search_for(dependency)</code> æ–¹æ³•ï¼›</li>
<li>é€šè¿‡ <code>#unwind_options_for_requirements</code> éå†æŸ¥è¯¢åˆ°çš„ binding_requirements è·å– requirement å¯¹åº”çš„ state ä»¥åŠè¯¥ state åœ¨æ ˆä¸­çš„ indexï¼Œç”¨äºç”Ÿæˆ unwind_detailsï¼›</li>
<li>å¯¹ unwind_details æ’åºï¼Œå– last ä½œä¸º current_detail å¹¶è¿›è¡Œå…¶ä»–ç›¸å…³çš„ä¿®æ”¹ã€‚</li>
</ol>
<p><strong>å…³äºå¦‚ä½•è·å– state_index å’Œ unwind_details</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">unwind_options_for_requirements</span><span class="p">(</span><span class="n">binding_requirements</span><span class="p">)</span>
  <span class="n">unwind_details</span> <span class="o">=</span> <span class="o">[]</span>

  <span class="n">trees</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="n">binding_requirements</span><span class="o">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
    <span class="n">partial_tree</span> <span class="o">=</span> <span class="o">[</span><span class="n">r</span><span class="o">]</span>
    <span class="n">trees</span> <span class="o">&lt;&lt;</span> <span class="n">partial_tree</span>
    <span class="n">unwind_details</span> <span class="o">&lt;&lt;</span> <span class="no">UnwindDetails</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">partial_tree</span><span class="p">,</span> <span class="n">binding_requirements</span><span class="p">,</span> <span class="n">trees</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span>
    <span class="c1"># 1.1 è·å– requirement å¯¹åº”çš„ state</span>
    <span class="n">requirement_state</span> <span class="o">=</span> <span class="n">find_state_for</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="c1"># 1.2 ç¡®è®¤ possibility å­˜åœ¨</span>
    <span class="k">if</span> <span class="n">conflict_fixing_possibilities?</span><span class="p">(</span><span class="n">requirement_state</span><span class="p">,</span> <span class="n">binding_requirements</span><span class="p">)</span>
      <span class="c1"># 1.3 ç”Ÿæˆ detail å­˜å…¥ unwind_details</span>
      <span class="n">unwind_details</span> <span class="o">&lt;&lt;</span> <span class="no">UnwindDetails</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="n">states</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">requirement_state</span><span class="p">),</span>
        <span class="n">r</span><span class="p">,</span>
        <span class="n">partial_tree</span><span class="p">,</span>
        <span class="n">binding_requirements</span><span class="p">,</span>
        <span class="n">trees</span><span class="p">,</span>
        <span class="o">[]</span>
      <span class="p">)</span>
    <span class="k">end</span>
    
    <span class="c1"># 2. æ²¿ç€ requirement ä¾èµ–æ ‘çš„çˆ¶èŠ‚ç‚¹è·å–å…¶ state</span>
    <span class="n">parent_r</span> <span class="o">=</span> <span class="n">parent_of</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">next</span> <span class="k">if</span> <span class="n">parent_r</span><span class="o">.</span><span class="n">nil?</span>
    <span class="n">partial_tree</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">parent_r</span><span class="p">)</span>
    <span class="n">requirement_state</span> <span class="o">=</span> <span class="n">find_state_for</span><span class="p">(</span><span class="n">parent_r</span><span class="p">)</span>
    <span class="c1"># é‡å¤ 1.2ï¼Œ 1.3 æ­¥éª¤ ...</span>
 	
    <span class="c1"># 6. æ²¿ç€ä¾èµ–æ ‘ï¼Œé‡å¤ä¸Šè¿°æ“ä½œ</span>
    <span class="n">grandparent_r</span> <span class="o">=</span> <span class="n">parent_of</span><span class="p">(</span><span class="n">parent_r</span><span class="p">)</span>
    <span class="k">until</span> <span class="n">grandparent_r</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">partial_tree</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">grandparent_r</span><span class="p">)</span>
      <span class="n">requirement_state</span> <span class="o">=</span> <span class="n">find_state_for</span><span class="p">(</span><span class="n">grandparent_r</span><span class="p">)</span>
      <span class="c1"># é‡å¤ 1.2ã€1.3 æ­¥éª¤ ...</span>
      <span class="n">parent_r</span> <span class="o">=</span> <span class="n">grandparent_r</span>
      <span class="n">grandparent_r</span> <span class="o">=</span> <span class="n">parent_of</span><span class="p">(</span><span class="n">parent_r</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">unwind_details</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¡®è®¤ state_index åï¼Œæ ˆå›æº¯åè€Œæ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥ <code>#slice!</code> å³å¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">sliced_states = states.slice!((details_for_unwind.state_index + 1)..-1)
</code></pre></td></tr></table>
</div>
</div><p>dg å›æ’¤è¿˜æ˜¯ <code>    activated.rewind_to(sliced_states.first || :initial_state) if sliced_states</code>ã€‚å›æ’¤ç»“æŸåï¼Œæµç¨‹é‡æ–°å›åˆ° Resolution Loopã€‚</p>
<h2 id="specificationprovider">SpecificationProvider</h2>
<p>æœ€åä¸€èŠ‚ç®€å•èŠèŠ SpecificationProviderã€‚ä¸ºäº†æ›´å¥½çš„æ¥å…¥ä¸åŒå¹³å°ï¼ŒåŒæ—¶ä¿è¯ Molinillo çš„é€šç”¨æ€§å’Œçµæ´»æ€§ï¼Œä½œè€…å°†ä¾èµ–æè¿°æ–‡ä»¶æŸ¥è¯¢ç­‰é€»è¾‘æŠ½è±¡æˆäº†ä»£ç†ã€‚</p>
<p>SpecificationProvider ä½œä¸ºå•ç‹¬çš„ Module å£°æ˜äº†æ¥å…¥ç«¯å¿…é¡»å®ç°çš„ APIï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Molinillo</span>
   <span class="k">module</span> <span class="nn">SpecificationProvider</span>

    <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
      <span class="o">[]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">dependencies_for</span><span class="p">(</span><span class="n">specification</span><span class="p">)</span>
      <span class="o">[]</span>
    <span class="k">end</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è€Œ Provider å°±æ˜¯åœ¨ Molinillo åˆå§‹åŒ–çš„æ—¶å€™æ³¨å…¥çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">require_relative</span> <span class="s1">&#39;dependency_graph&#39;</span>

<span class="k">module</span> <span class="nn">Molinillo</span>

  <span class="k">class</span> <span class="nc">Resolver</span>
    <span class="n">require_relative</span> <span class="s1">&#39;resolution&#39;</span>

    <span class="kp">attr_reader</span> <span class="ss">:specification_provider</span>
    <span class="kp">attr_reader</span> <span class="ss">:resolver_ui</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">specification_provider</span><span class="p">,</span> <span class="n">resolver_ui</span><span class="p">)</span>
      <span class="vi">@specification_provider</span> <span class="o">=</span> <span class="n">specification_provider</span>
      <span class="vi">@resolver_ui</span> <span class="o">=</span> <span class="n">resolver_ui</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">requested</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="no">DependencyGraph</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
      <span class="no">Resolution</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">specification_provider</span><span class="p">,</span>
                     <span class="n">resolver_ui</span><span class="p">,</span>
                     <span class="n">requested</span><span class="p">,</span>
                     <span class="n">base</span><span class="p">)</span><span class="o">.</span>
        <span class="n">resolve</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è€Œåœ¨ CocoaPods ä¸­çš„åˆå§‹åŒ–æ–¹æ³•åˆ™æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># /lib/CocoaPods/resolver.rb</span>
<span class="k">def</span> <span class="nf">resolve</span>
  <span class="n">dependencies</span> <span class="o">=</span> <span class="vi">@podfile_dependency_cache</span><span class="o">.</span><span class="n">target_definition_list</span><span class="o">.</span><span class="n">flat_map</span> <span class="k">do</span> <span class="o">|</span><span class="n">target</span><span class="o">|</span>
    <span class="vi">@podfile_dependency_cache</span><span class="o">.</span><span class="n">target_definition_dependencies</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span>
      <span class="k">next</span> <span class="k">unless</span> <span class="n">target</span><span class="o">.</span><span class="n">platform</span>
      <span class="vi">@platforms_by_dependency</span><span class="o">[</span><span class="n">dep</span><span class="o">].</span><span class="n">push</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="o">.</span><span class="n">uniq</span>
  <span class="vi">@platforms_by_dependency</span><span class="o">.</span><span class="n">each_value</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:uniq!</span><span class="p">)</span>
  <span class="vi">@activated</span> <span class="o">=</span> <span class="no">Molinillo</span><span class="o">::</span><span class="no">Resolver</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">locked_dependencies</span><span class="p">)</span>
  <span class="n">resolver_specs_by_target</span>
<span class="k">rescue</span> <span class="no">Molinillo</span><span class="o">::</span><span class="no">ResolverError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="n">handle_resolver_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>è¯¥æ–¹æ³•åˆ™å¤„äº pod install ä¸­çš„ resolve dependencies é˜¶æ®µï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/01-pod-install.png" alt="01-pod-install"></p>
<h3 id="nosuchdependencyerror">NoSuchDependencyError</h3>
<p>å¦å¤–ï¼Œä¸ºäº†æ›´å¥½çš„å¤„ç†äº§ç”Ÿçš„å¼‚å¸¸ï¼ŒåŒæ—¶ä¿è¯æ ¸å¿ƒé€»è¾‘å¯¹ provider çš„æ— æ„ŸçŸ¥ï¼ŒMolinillo å°†ä»£ç†æ–¹æ³•åšäº†ä¸€å±‚éš”ç¦»ï¼Œå¹¶ä¸”å¯¹å¼‚å¸¸åšäº†ç»Ÿä¸€æ‹¦æˆªï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Molinillo</span>
  <span class="k">module</span> <span class="nn">Delegates</span>

    <span class="k">module</span> <span class="nn">SpecificationProvider</span>

      <span class="k">def</span> <span class="nf">search_for</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
        <span class="n">with_no_such_dependency_error_handling</span> <span class="k">do</span>
          <span class="n">specification_provider</span><span class="o">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">dependencies_for</span><span class="p">(</span><span class="n">specification</span><span class="p">)</span>
        <span class="n">with_no_such_dependency_error_handling</span> <span class="k">do</span>
          <span class="n">specification_provider</span><span class="o">.</span><span class="n">dependencies_for</span><span class="p">(</span><span class="n">specification</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="o">...</span>

      <span class="kp">private</span>

      <span class="k">def</span> <span class="nf">with_no_such_dependency_error_handling</span>
        <span class="k">yield</span>
      <span class="k">rescue</span> <span class="no">NoSuchDependencyError</span> <span class="o">=&gt;</span> <span class="n">error</span>
        <span class="k">if</span> <span class="n">state</span>
          <span class="o">...</span>
        <span class="k">end</span>
        <span class="k">raise</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>æœ¬ç¯‡æ–‡ç« ä»ä¾èµ–è§£æçš„çŠ¶æ€ç»´æŠ¤ã€çŠ¶æ€å­˜å‚¨ã€çŠ¶æ€å›æº¯ä¸‰ä¸ªç»´åº¦æ¥è§£æ„ Molinillo çš„æ ¸å¿ƒé€»è¾‘ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”äº† ResolutionStateã€DependencyGraphã€UnwindDetail è¿™ä¸‰ç§æ•°æ®ç»“æ„ã€‚ä¸€å¼€å§‹å†™è¿™ç¯‡å†…å®¹æ—¶ï¼Œå¤´è„‘ä¸­å¯¹äºè¿™äº›æ¦‚å¿µæ˜¯æœªçŸ¥çš„ï¼Œå› ä¸ºä¸€å¼€å§‹å°±ç›´æ¥çœ‹äº†ä½œè€…å¯¹ <a href="https://github.com/CocoaPods/Molinillo/blob/master/ARCHITECTURE.md">Molinillo çš„æ¶æ„é˜è¿°</a>æ›´æ˜¯å®Œå…¨æ‰¾ä¸åˆ°æ€ç»ªï¼Œå¥½åœ¨æˆ‘æœ‰ VSCode ï¼ï¼ï¼æœ€ç»ˆä¾æ®ä¸åŒ Case ä¸‹çš„æ•°æ®å‘ˆç°ï¼Œä¸€ç‚¹ç‚¹çš„è¿›è¡Œæºç è°ƒè¯•ï¼Œå¤§è‡´æ‘¸æ¸…çš„ Molinillo çš„çŠ¶æ€æ˜¯å¦‚ä½•å˜åŒ–è½¬ç§»çš„ã€‚æœ€åä¸€ç‚¹ï¼Œè‹±æ–‡å’Œæ•°æ®ç»“æ„è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œpossiblity ä½ ç†è§£äº†å— ï¼Ÿ</p>
<h1 id="çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†">çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†</h1>
<p>è¿™é‡Œç½—åˆ—äº†äº”ä¸ªé—®é¢˜ç”¨æ¥è€ƒå¯Ÿä½ æ˜¯å¦å·²ç»æŒæ¡äº†è¿™ç¯‡æ–‡ç« ï¼Œå¦‚æœæ²¡æœ‰å»ºè®®ä½ åŠ å…¥<strong>æ”¶è—</strong>å†æ¬¡é˜…è¯»ï¼š</p>
<ol>
<li>è¯´è¯´ Resolution æ ˆä¸­çš„ state æ˜¯å¦‚ä½•è½¬ç§»çš„ ï¼Ÿ</li>
<li>DependencyGraph çš„æ•°æ®é€šè¿‡ä»€ä¹ˆæ–¹å¼è¿›è¡Œå›æ’¤çš„ ï¼Ÿ</li>
<li><code>#process_topmost_state</code> å¤„ç†äº†å‡ ç§ conflict æƒ…å†µ ï¼Ÿ</li>
<li>UnwindDetail çš„ state_index æ˜¯å¦‚ä½•è·å–çš„ ï¼Ÿ</li>
<li>ä½œè€…å¦‚ä½•åˆ©ç”¨ SpecificationProvider æ¥è§£å¶çš„ ï¼Ÿ</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">åœŸåœŸEdmondæœ¨</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2021-03-08
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cocoapods/">CocoaPods</a>
          <a href="/tags/ios/">iOS</a>
          <a href="/tags/ruby/">Ruby</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">8. Xcode å·¥ç¨‹æ–‡ä»¶è§£æ</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/post/snowball/snowball-widgets/">
            <span class="next-text nav-default">é›ªçƒ iOS Widget ä»é›¶åˆ°å£¹</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:chun574271939@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/looseyi" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/looseyi" class="iconfont icon-github" title="github"></a>
      <a href="https://www.weibo.com/foreverclp" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/tu-tu-edmondmu" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="http://looseyi.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019-12-11 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">åœŸåœŸEdmondæœ¨</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
