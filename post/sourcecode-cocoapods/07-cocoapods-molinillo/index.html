<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>7. Molinillo ä¾èµ–æ ¡éªŒ - Aha Edmond</title>

  
  
  <meta name="description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥" />
  <meta name="author" content="åœŸåœŸEdmondæœ¨" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-cocoapods/07-cocoapods-molinillo/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="7. Molinillo ä¾èµ–æ ¡éªŒ" />
<meta property="og:description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-cocoapods/07-cocoapods-molinillo/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-03-08T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-03-08T00:00:00&#43;00:00" />


  
  <meta itemprop="name" content="7. Molinillo ä¾èµ–æ ¡éªŒ">
<meta itemprop="description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥"><meta itemprop="datePublished" content="2021-03-08T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-08T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6640">
<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="7. Molinillo ä¾èµ–æ ¡éªŒ"/>
<meta name="twitter:description" content="å¼•å­ é€šè¿‡ã€Œå‰æ–‡ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† Pod æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ pod install çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2021-03-08</time>
      
      <span>åœŸåœŸEdmondæœ¨</span>
      
    </p>
    <h1>7. Molinillo ä¾èµ–æ ¡éªŒ</h1>
  </header>
  <section class="post-content"><p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/Molinillo%20%E4%BE%9D%E8%B5%96%E6%A0%A1%E9%AA%8C.png" alt="Molinillo ä¾èµ–æ ¡éªŒ"></p>
<h1 id="å¼•å­">å¼•å­</h1>
<p>é€šè¿‡ã€Œ<a href="https://www.zhihu.com/column/c_1254403935512834048"><strong>å‰æ–‡</strong></a>ã€å¯¹ CocaPods-Core çš„åˆ†æï¼Œæˆ‘ä»¬å¤§ä½“äº†è§£äº† <code>Pod</code> æ˜¯å¦‚ä½•è¢«è§£æã€æŸ¥è¯¢ä¸ç®¡ç†çš„ã€‚æœ‰äº†è¿™äº›æ•´ä½“æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€æ­¥æ·±å…¥ <code>pod install</code> çš„å„ä¸ªç»†èŠ‚ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠ <code>Pod</code> çš„ä¾èµ–æ ¡éªŒå·¥å…· &mdash; <a href="https://github.com/CocoaPods/Molinillo">Molinillo</a>ã€‚å¼€å§‹å‰ï¼Œéœ€è¦èŠèŠä¾èµ–æ ¡éªŒçš„èƒŒæ™¯ã€‚</p>
<h1 id="ä¾èµ–ç®¡ç†çš„æŒ‘æˆ˜">ä¾èµ–ç®¡ç†çš„æŒ‘æˆ˜</h1>
<p>åŒå¤§å¤šæ•°åŒ…ç®¡ç†å·¥å…·ä¸€æ · <code>Pod</code> ä¼šå°†ä¼ é€’ä¾èµ–çš„åŒ…ç”¨æ‰å¹³åŒ–çš„å½¢å¼ï¼Œå®‰è£…è‡³ workspace ç›®å½• (å³ï¼š<code>Pods/</code>)ã€‚</p>
<p><strong>ä¾èµ–ä¼ é€’</strong>ï¼š<code>pod A</code> ä¾èµ–äº <code>pod B</code>ï¼Œè€Œ <code>pod B</code> ä¾èµ– <code>Alamofire</code>ã€‚</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/01-dependency-flat.png" alt="01-dependency-flat"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç»ä¾èµ–è§£æåŸæœ‰çš„ä¾èµ–æ ‘è¢«æ‹å¹³äº†ï¼Œå®‰è£…åœ¨åŒå±‚ç›®å½•ä¸­ã€‚</p>
<p>ç„¶è€Œåœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œé‡åˆ°çš„æ›´å¤šæƒ…å†µå¯èƒ½åƒä¸‹é¢è¿™æ ·ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/02-dependency-conflict.png" alt="02-dependency-conflict"></p>
<p>**ä¾èµ–å†²çªï¼š<strong>å³ <code>pod A</code> å’Œ <code>pod B</code> åˆ†åˆ«ä¾èµ–ä¸åŒç‰ˆæœ¬çš„ <code>Alamofire</code>ã€‚è¿™å°±æ˜¯</strong><a href="https://www.wikiwand.com/zh-hans/%E7%9B%B8%E4%BE%9D%E6%80%A7%E5%9C%B0%E7%8B%B1">ä¾èµ–åœ°ç‹±</a>**çš„å¼€å§‹ã€‚</p>
<blockquote>
<p>ä¾èµ–åœ°ç‹±ï¼šæŒ‡åœ¨æ“ä½œç³»ç»Ÿä¸­ç”±äºè½¯ä»¶ä¹‹é—´çš„ä¾èµ–æ€§ä¸èƒ½è¢«æ»¡è¶³è€Œå¼•å‘çš„é—®é¢˜ã€‚</p>
</blockquote>
<p>éšç€é¡¹ç›®çš„è¿­ä»£ï¼Œæˆ‘ä»¬ä¸æ–­å¼•å…¥ä¾èµ–å¹¶æœ€ç»ˆå½¢æˆé”™ç»¼å¤æ‚çš„ç½‘ç»œã€‚è¿™ä½¿å¾—é¡¹ç›®çš„ä¾èµ–æ€§è§£æå˜å¾—å¼‚å¸¸å›°éš¾ï¼Œç”šè‡³å‡ºç°<a href="https://www.wikiwand.com/en/Fatal_exception_error">è‡´å‘½é”™è¯¯</a>ã€‚</p>
<p>é‚£ä¹ˆï¼Œäº§ç”Ÿçš„é—®é¢˜æœ‰å“ªäº›ç±»å‹ ï¼Ÿ</p>
<h2 id="é—®é¢˜ç±»å‹">é—®é¢˜ç±»å‹</h2>
<h3 id="ä¾èµ–è¿‡å¤šå¤šé‡ä¾èµ–">ä¾èµ–è¿‡å¤š/å¤šé‡ä¾èµ–</h3>
<p>å³é¡¹ç›®å­˜åœ¨å¤§é‡ä¾èµ–å…³ç³»ï¼Œæˆ–è€…ä¾èµ–æœ¬èº«æœ‰å…¶è‡ªèº«ä¾èµ–ï¼ˆä¾èµ–ä¼ é€’ï¼‰ï¼Œå¯¼è‡´ä¾èµ–å±‚çº§è¿‡æ·±ã€‚åƒå¾®ä¿¡æˆ–æ·˜å®è¿™æ ·çš„è¶…çº§åº”ç”¨ï¼Œå…¶ä¸­çš„å•ä¸€ä¸šåŠ¡æ¨¡å—éƒ½å¯èƒ½å­˜åœ¨è¿™äº›é—®é¢˜ï¼Œè¿™å°†ä½¿å¾—ä¾èµ–è§£æè¿‡äºå¤æ‚ï¼Œä¸”å®¹æ˜“äº§ç”Ÿä¾èµ–å†²çªå’Œä¾èµ–å¾ªç¯ã€‚</p>
<h3 id="ä¾èµ–å†²çª">ä¾èµ–å†²çª</h3>
<p>å³é¡¹ç›®ä¸­çš„ä¸¤ä¸ªä¾èµ–åŒ…æ— æ³•å…±å­˜çš„æƒ…å†µã€‚å¯èƒ½ä¸¤ä¸ªä¾èµ–åº“å†…éƒ¨çš„ä»£ç å†²çªï¼Œä¹Ÿå¯èƒ½å…¶åº•å±‚ä¾èµ–äº’ç›¸å†²çªã€‚ä¸Šé¢ä¾‹å­ä¸­å›  <code>Alamofire</code> ç‰ˆæœ¬ä¸åŒäº§ç”Ÿçš„é—®é¢˜å°±æ˜¯ä¾èµ–å†²çªã€‚</p>
<h3 id="ä¾èµ–å¾ªç¯">ä¾èµ–å¾ªç¯</h3>
<p>å³ä¾èµ–æ€§å…³ç³»å½¢æˆä¸€ä¸ªé—­åˆç¯è·¯ã€‚å¦‚ä¸‹å›¾ä¸‰ä¸ª pod åº“ä¹‹é—´äº’ç›¸ä¾èµ–äº§ç”Ÿå¾ªç¯ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/03-dependency-conflict.png" alt="03-dependency-conflict"></p>
<p>è¦åˆ¤æ–­ä¾èµ–å…³ç³»ä¸­æ˜¯å¦å­˜åœ¨ä¾èµ–ç¯ï¼Œåˆ™éœ€è¦é€šä¾èµ–ä»²è£ç®—æ³•æ¥è§£å†³ã€‚</p>
<h2 id="ä¾èµ–å…³ç³»çš„è§£å†³">ä¾èµ–å…³ç³»çš„è§£å†³</h2>
<p>å¯¹äºä¾èµ–è¿‡å¤šæˆ–è€…å¤šé‡ä¾èµ–é—®é¢˜ï¼Œæˆ‘ä»¬å¯é€šè¿‡åˆç†çš„æ¶æ„å’Œè®¾è®¡æ¨¡å¼æ¥è§£å†³ã€‚è€Œ<strong>ä¾èµ–æ ¡éªŒ</strong>ä¸»è¦è§£å†³çš„é—®é¢˜ä¸ºï¼š</p>
<ol>
<li>æ£€æŸ¥ä¾èµ–å›¾æ˜¯å¦å­˜åœ¨ç‰ˆæœ¬å†²çªï¼›</li>
<li>åˆ¤æ–­ä¾èµ–å›¾æ˜¯å¦å­˜åœ¨å¾ªç¯ä¾èµ–ï¼›</li>
</ol>
<h3 id="0x01-ç‰ˆæœ¬å†²çªçš„è§£å†³æ–¹æ¡ˆ">0x01 ç‰ˆæœ¬å†²çªçš„è§£å†³æ–¹æ¡ˆ</h3>
<p>å¯¹äºç‰ˆæœ¬å†²çªå¯é€šè¿‡ä¿®æ”¹æŒ‡å®šç‰ˆæœ¬ä¸ºå¸¦å…¼å®¹æ€§çš„ç‰ˆæœ¬èŒƒå›´é—®é¢˜æ¥é¿å…ã€‚å¦‚ä¸Šé¢çš„é—®é¢˜æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>é€šè¿‡ä¿®æ”¹ä¸¤ä¸ª <code>pod</code> çš„ <code>Alamofire</code> ç‰ˆæœ¬çº¦æŸä¸º <code>~&gt; 4.0</code> æ¥è§£å†³ã€‚</li>
<li>å»é™¤ä¸¤ä¸ª <code>pod</code> çš„ç‰ˆæœ¬çº¦æŸï¼Œäº¤ç”±é¡¹ç›®ä¸­çš„ <code>Podfile</code> æ¥æŒ‡å®šã€‚</li>
</ul>
<p>ä¸è¿‡è¿™æ ·ä¼šæœ‰ä¸€ä¸ªéšæ‚£ï¼Œç”±äºä¸¤ä¸ª <code>Pod</code> ä½¿ç”¨çš„ä¸»ç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½å¸¦æ¥ API ä¸å…¼å®¹ï¼Œå¯¼è‡´ <code>pod install</code> å³ä½¿æˆåŠŸäº†ï¼Œæœ€ç»ˆä¹Ÿæ— æ³•ç¼–è¯‘æˆ–è¿è¡Œæ—¶æŠ¥é”™ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ˜¯åŸºäºè¯­è¨€ç‰¹æ€§æ¥è¿›è¡Œä¾èµ–æ€§éš”ç¦»ã€‚å¦‚ npm çš„æ¯ä¸ªä¼ é€’ä¾èµ–åŒ…å¦‚æœå†²çªéƒ½å¯ä»¥æœ‰è‡ªå·±çš„ <code>node_modules</code> ä¾èµ–ç›®å½•ï¼Œå³ä¸€ä¸ªä¾èµ–åº“å¯ä»¥å­˜åœ¨å¤šä¸ªä¸åŒç‰ˆæœ¬ã€‚</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/04-dependency-conflict.png" alt="04-dependency-conflict"></p>
<h3 id="0x02-å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆ">0x02 å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆ</h3>
<p>å¾ªç¯ä¾èµ–åˆ™éœ€è¦éœ€è¦è¿›è¡Œæ•°å­¦å»ºæ¨¡ç”Ÿæˆ <code>DAG</code> å›¾ï¼Œåˆ©ç”¨æ‹“æ‰‘æ’åºçš„æ‹†ç‚¹è¿›è¡Œå¤„ç†ã€‚é€šè¿‡ç¡®å®šä¾èµ–å›¾æ˜¯å¦ä¸º <code>DAG</code> å›¾ï¼Œæ¥éªŒè¯ä¾èµ–å…³ç³»çš„åˆç†æ€§ã€‚</p>
<p>ä¸€ä¸ª DAG å›¾çš„ç¤ºä¾‹ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/05-DAG.png" alt="04-DAG"></p>
<blockquote>
<p>DAG æ˜¯å›¾è®ºä¸­å¸¸è§çš„ä¸€ç§æè¿°é—®é¢˜çš„ç»“æ„ï¼Œå…¨ç§°**æœ‰å‘æ— ç¯å›¾ (Directed Acyclic Graph) **ã€‚æƒ³äº†è§£æ›´å¤šï¼Œå¯æŸ¥çœ‹ç“œç“œçš„æ–‡ç«  &mdash;ã€Œ<a href="https://mp.weixin.qq.com/s/oj_cxBwKCxxbr0hYbrj21A">ä»æ‹“æ‰‘æ’åºåˆ° Carthage ä¾èµ–æ ¡éªŒç®—æ³•</a>ã€ã€‚</p>
</blockquote>
<p>å¦å¤–ï¼Œå„ç§åŒ…ç®¡ç†å·¥å…·çš„ä¾èµ–æ ¡éªŒç®—æ³•ä¹Ÿå„ä¸ç›¸åŒï¼Œæœ‰å¦‚ Dart å’Œ SwiftPM æ‰€ä½¿ç”¨çš„ <a href="https://medium.com/@nex3/pubgrub-2fb6470504f">PubGrub</a>ï¼Œä½œè€…å·ç§°å…¶ä¸ºä¸‹ä¸€ä»£ä¾èµ–æ ¡éªŒç®—æ³•ï¼ŒYarn çš„ <a href="https://classic.yarnpkg.com/en/docs/selective-version-resolutions">Selective dependency resolutions</a>ï¼Œè¿˜æœ‰æˆ‘ä»¬ä»Šå¤©èŠåˆ°çš„ Molinilloã€‚</p>
<h1 id="molinillo">Molinillo</h1>
<p>Molinillo ä½œä¸ºé€šç”¨çš„ä¾èµ–è§£æå·¥å…·ï¼Œå®ƒä¸ä»…åº”ç”¨åœ¨ CocoaPods ä¸­ï¼Œåœ¨ Bundler 1.9 ç‰ˆæœ¬ä¹Ÿé‡‡ç”¨ Molinilloã€‚å¦å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ Bundler åœ¨ Ruby 2.6 ä¸­è¢«ä½œä¸ºäº†é»˜è®¤çš„ gem å·¥å…·å†…åµŒã€‚å¯ä»¥è¯´ Ruby ç›¸å…³çš„ä¾èµ–å·¥å…·éƒ½é€šè¿‡ Molinillo å®Œæˆä¾èµ–è§£æã€‚</p>
<h2 id="resolutionstate">ResolutionState</h2>
<p>Molinillo ç®—æ³•çš„æ ¸å¿ƒæ˜¯åŸºäº<a href="https://en.wikipedia.org/wiki/Backtracking">å›æº¯ (Backtracking)</a> å’Œ <a href="https://en.wikipedia.org/wiki/Look-ahead_(backtracking)">å‘å‰æ£€æŸ¥ (forward checking)</a>ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šè¿½è¸ªæ ˆä¸­çš„ä¸¤ä¸ªçŠ¶æ€ <code>DependencyState</code> å’Œ <code>PossibilityState</code>ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#586e75"># è§£æçŠ¶æ€</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#cb4b16">ResolutionState</span> <span style="color:#719e07">=</span> <span style="color:#cb4b16">Struct</span><span style="color:#719e07">.</span>new(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75"># [String] å½“å‰éœ€æ±‚åç§°</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#2aa198">:name</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#586e75"># [Array&lt;Object&gt;] æœªå¤„ç†çš„éœ€æ±‚</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#2aa198">:requirements</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#586e75"># [DependencyGraph] ä¾èµ–å…³ç³»å›¾</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#2aa198">:activated</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#586e75"># [Object] å½“å‰éœ€æ±‚</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#2aa198">:requirement</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#586e75"># [Object] æ»¡è¶³å½“å‰éœ€æ±‚çš„å¯èƒ½æ€§</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#2aa198">:possibilities</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#586e75"># [Integer] è§£ææ·±åº¦</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#2aa198">:depth</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#586e75"># [Hash] æœªè§£å†³çš„å†²çªï¼Œä»¥éœ€æ±‚åä¸º key</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#2aa198">:conflicts</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    <span style="color:#586e75"># [Array&lt;UnwindDetails&gt;] è®°å½•ç€æœªå¤„ç†è¿‡çš„éœ€è¦ç”¨äºå›æº¯çš„ä¿¡æ¯</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    <span style="color:#2aa198">:unused_unwind_options</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">ResolutionState</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">empty</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>      <span style="color:#719e07">new</span>(<span style="color:#719e07">nil</span>, <span style="color:#719e07">[]</span>, <span style="color:#cb4b16">DependencyGraph</span><span style="color:#719e07">.</span>new, <span style="color:#719e07">nil</span>, <span style="color:#719e07">nil</span>, <span style="color:#2aa198">0</span>, {}, <span style="color:#719e07">[]</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>  <span style="color:#586e75"># è®°å½•ä¸€ç»„éœ€æ±‚å’Œæ»¡è¶³å½“å‰éœ€æ±‚çš„å¯èƒ½æ€§</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyState</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ResolutionState</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>	 <span style="color:#586e75"># é€šè¿‡ä¸æ–­ pop è¿‡æ»¤åŒ…å«çš„å¯èƒ½æ€§ï¼Œæ‰¾å‡ºæœ€ç¬¦åˆéœ€æ±‚çš„è§£</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">pop_possibility_state</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>      <span style="color:#cb4b16">PossibilityState</span><span style="color:#719e07">.</span>new(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>        <span style="color:#b58900">name</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>        requirements<span style="color:#719e07">.</span>dup,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>        activated,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>        requirement,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>        <span style="color:#719e07">[</span>possibilities<span style="color:#719e07">.</span>pop<span style="color:#719e07">]</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>        depth <span style="color:#719e07">+</span> <span style="color:#2aa198">1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>        conflicts<span style="color:#719e07">.</span>dup,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>        unused_unwind_options<span style="color:#719e07">.</span>dup
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>      )<span style="color:#719e07">.</span>tap <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>state<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>        state<span style="color:#719e07">.</span>activated<span style="color:#719e07">.</span>tag(state)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">46</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">47</span>  <span style="color:#586e75"># ä»…åŒ…å«ä¸€ä¸ªæ»¡è¶³éœ€æ±‚çš„å¯èƒ½æ€§</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">48</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">PossibilityState</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ResolutionState</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">49</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">50</span><span style="color:#719e07">end</span>
</code></pre></div><p>å…‰çœ‹ state å®šä¹‰å¤§å®¶å¯èƒ½è§‰å¾—äº‘é‡Œé›¾é‡Œã€‚è¿™é‡Œå¾ˆæœ‰å¿…è¦è§£é‡Šä¸€ä¸‹ï¼š</p>
<p>æˆ‘ä»¬è¯´çš„éœ€æ±‚ (<code>requirement</code>) åˆ°åº•æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿå¤§å®¶å¯ä»¥ç†è§£ä¸ºåœ¨ <code>Podfile</code> ä¸­å£°æ˜çš„ podã€‚**ä¹‹æ‰€ä»¥ç§°ä¸ºéœ€æ±‚ï¼Œæ˜¯ç”±äºæ— æ³•åˆ¤æ–­å®šä¹‰çš„ dependency æ˜¯å¦åˆæ³•ã€‚**å‡è®¾å®ƒåˆæ³•ï¼Œåˆæ˜¯å¦å­˜åœ¨ç¬¦åˆéœ€æ±‚é™åˆ¶ç‰ˆæœ¬çš„è§£å‘¢ ï¼Ÿå³æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ <code>PodSpec</code> æˆ‘ä»¬ä¸è€ŒçŸ¥ã€‚å› æ­¤ï¼Œè¿™äº›æœªçŸ¥çŠ¶æ€ç§°ä¸ºç»Ÿä¸€è¢«å¯èƒ½æ€§ <code>possibility</code>ã€‚</p>
<blockquote>
<p>Tips: äº†è§£è¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œè¿™ä¹Ÿæ˜¯ç¬”è€…åœ¨å‡ ä¹å†™å®Œæœ¬æ–‡çš„æƒ…å†µä¸‹ï¼Œæ‰æƒ³æ˜ç™½è¿™äº›å˜é‡åçš„æ„ä¹‰ã€‚ğŸ’”</p>
</blockquote>
<h3 id="resolution-loop">Resolution Loop</h3>
<p>æˆ‘ä»¬å…ˆé€šè¿‡å›¾æ¥äº†è§£ä¸€ä¸‹ Molinillo çš„æ ¸å¿ƒæµç¨‹ (å…ˆå¿½ç•¥å¼‚å¸¸æµï¼‰ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/07-backtrack-state.png" alt="07-backtrack-state"></p>
<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªæµç¨‹å°±æ˜¯ä¸æ–­çš„å°† requirement çš„ possibility è¿‡æ»¤å’Œå¤„ç†ï¼Œä¸€å±‚å±‚å‰¥ç¦»è½¬æ¢ä¸º <code>DependencyState</code>ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚</p>
<p>Molinillo çš„å…¥å£ä¸º <code>Resolution::resolve</code> æ–¹æ³•ï¼Œä¹Ÿæ˜¯ä¸Šå›¾å¯¹åº”çš„å®ç°ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/molinillo/resolution.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">resolve</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#586e75"># 1. åˆå§‹åŒ– timer ç»Ÿè®¡è€—æ—¶åˆå§‹ä½ç½®æ‰“ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#586e75"># 2. å†…éƒ¨ä¼šè°ƒç”¨ push_initial_state åˆå§‹åŒ– DependencyState å‹æ ˆ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#586e75"># 3. åˆå§‹åŒ– DependencyGraph å®ä¾‹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  start_resolution
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#719e07">while</span> state
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">break</span> <span style="color:#719e07">if</span> <span style="color:#719e07">!</span>state<span style="color:#719e07">.</span>requirement <span style="color:#719e07">&amp;&amp;</span> state<span style="color:#719e07">.</span>requirements<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#586e75"># è¾“å‡ºä¸€ä¸ªè¿›åº¦å ä½</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    indicate_progress
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#719e07">if</span> state<span style="color:#719e07">.</span>respond_to?(<span style="color:#2aa198">:pop_possibility_state</span>) <span style="color:#586e75"># DependencyState</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>      <span style="color:#586e75"># è°ƒè¯•æ—¥å¿—å…¥å£</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#586e75"># å¦‚æœç¯å¢ƒå˜é‡ MOLINILLO_DEBUG æ˜¯é nil å°±è¾“å‡º log</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      <span style="color:#586e75"># è¿™é‡Œçš„è°ƒè¯•æ—¥å¿—æœ‰åŠ©äºæ’æŸ¥ Pod ç»„ä»¶çš„ä¾èµ–é—®é¢˜</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>      debug(depth) { <span style="color:#2aa198">&#34;Creating possibility state for </span><span style="color:#2aa198">#{</span>requirement<span style="color:#2aa198">}</span><span style="color:#2aa198"> (</span><span style="color:#2aa198">#{</span>possibilities<span style="color:#719e07">.</span>count<span style="color:#2aa198">}</span><span style="color:#2aa198"> remaining)&#34;</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>      state<span style="color:#719e07">.</span>pop_possibility_state<span style="color:#719e07">.</span>tap <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>s<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>        <span style="color:#719e07">if</span> s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>          states<span style="color:#719e07">.</span>push(s)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>          activated<span style="color:#719e07">.</span>tag(s)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    <span style="color:#586e75"># å¤„ç†æ ˆé¡¶ Possibility State</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    process_topmost_state
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>  <span style="color:#586e75"># éå† Dependency Graph </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>  resolve_activated_specs
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span><span style="color:#719e07">ensure</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>  end_resolution
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span><span style="color:#719e07">end</span>
</code></pre></div><ol>
<li>é¦–å…ˆ <code>#start_resolution</code> ä¼šåˆå§‹åŒ– timer ç”¨äºç»Ÿè®¡è§£æè€—æ—¶ï¼Œå¹¶è°ƒç”¨ <code>#push_initial_state</code> åˆå§‹åŒ– <code>DependencyState</code> å…¥æ ˆï¼Œä»¥åŠ <strong>DependencyGraph</strong> åˆå§‹åŒ–ã€‚</li>
<li>è·å–æ ˆé¡¶ state æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¾…è§£æéœ€æ±‚ï¼Œæ¥ç€è°ƒç”¨ <code>#pop_possibility_state</code> è¿›è¡Œ state è½¬æ¢å¹¶å…¥æ ˆã€‚</li>
<li>è°ƒç”¨ <code>#process_topmost_state</code> å¤„ç†æ ˆé¡¶çš„ possiblity stateï¼Œå¦‚æœå½“å‰ state å¯è¢«æ¿€æ´»ï¼Œåˆ™å°†è¯¥ possiblity å­˜å…¥ DependencyGraph å¯¹åº”é¡¶ç‚¹çš„ payload ä¸­ã€‚å¦åˆ™åˆ¤å®šä¸ºå†²çªï¼Œéœ€è¦è¿›è¡ŒçŠ¶æ€å›æ»šã€‚</li>
<li>å¾ªç¯ç›´åˆ° state çš„å¯èƒ½æ€§å…¨éƒ¨å¤„ç†ç»“æŸã€‚</li>
<li>è°ƒç”¨ <code>#resolve_activated_specs</code> ï¼Œéå† DependencyGraph ä»¥å­˜å‚¨æ›´æ–°éœ€æ±‚çš„å¯èƒ½æ€§ï¼Œè§£æç»“æŸã€‚</li>
</ol>
<p>å½“ç„¶ï¼Œä¾èµ–å¤„ç†å¹¶éè¿™ä¹ˆç®€å•ï¼Œå¤æ‚çš„è¿‡æ»¤å’Œå›æº¯é€»è¾‘éƒ½éšè—åœ¨ <code>#process_topmost_state</code> ä¸­ã€‚</p>
<h3 id="resolutionstate-çš„å˜åŒ–">ResolutionState çš„å˜åŒ–</h3>
<p>å…¶å®ä» <code>ResolutionState</code> çš„å®šä¹‰èƒ½å¤Ÿçœ‹å‡ºï¼Œä¸ºäº†æ–¹ä¾¿å›æº¯å’Œæ•°æ®è¿˜åŸï¼Œstate æ˜¯ä»¥ Struct ç»“æ„å®šä¹‰çš„ã€‚åŒæ—¶åœ¨æ¯æ¬¡ <code>#pop_possibility_state</code> ä¸­ï¼Œé€šè¿‡ <strong><a href="https://stackoverflow.com/questions/10183370/whats-the-difference-between-rubys-dup-and-clone-methods">#dup</a></strong> å¯¹ diff æ•°æ®è¿›è¡Œäº†å¤åˆ¶ã€‚</p>
<p>è¿™é‡Œç”¨ä¾èµ–ä¼ é€’çš„ä¾‹å­æ¥å±•ç¤ºè§£æåçŠ¶æ€æ ˆçš„å˜åŒ–ã€‚å‡è®¾æˆ‘ä»¬åœ¨ Podfile ä¸­å£°æ˜äº† <code>Aï¼ŒBï¼ŒC</code> ä¸‰ä¸ªä¾èµ–ï¼Œä»–ä»¬çš„å…³ç³»ä¸ºï¼š<code>A -&gt; B -&gt; C</code>ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>target <span style="color:#2aa198">&#39;Example&#39;</span> <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  pod <span style="color:#2aa198">&#39;C&#39;</span>, <span style="color:#2aa198">:path</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;../&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  pod <span style="color:#2aa198">&#39;B&#39;</span>, <span style="color:#2aa198">:path</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;../&#39;</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  pod <span style="color:#2aa198">&#39;A&#39;</span>, <span style="color:#2aa198">:path</span> <span style="color:#719e07">=&gt;</span> &#39;<span style="color:#719e07">../</span>â€™
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">end</span>
</code></pre></div><p>åœ¨ <code>#resolve_activated_specs</code> æ–¹æ³•è®¾ç½®æ–­ç‚¹ï¼Œåœ¨è§£æç»“æŸæ—¶æ‰“å°çŠ¶æ€æ ˆ <code>@states</code>ï¼ˆç®€åŒ–å¤„ç†åï¼‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span> <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>   <span style="color:#586e75">#&lt;struct Molinillo::DependencyState name=&#34;C&#34;, requirements=[B, A], ...&gt;, </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>   <span style="color:#586e75">#&lt;struct Molinillo::PossibilityState name=&#34;C&#34;, requirements=[B, A], ...&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>   <span style="color:#586e75">#&lt;struct Molinillo::DependencyState name=&#34;B&#34;, requirements=[A], ...&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>   <span style="color:#586e75">#&lt;struct Molinillo::PossibilityState name=&#34;B&#34;, requirements=[A], ...&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>   <span style="color:#586e75"># çœç•¥äº† Cã€Cã€Aã€A...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>   <span style="color:#586e75">#&lt;struct Molinillo::DependencyState name=&#34;B&#34;, requirements=[], ..., </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>   <span style="color:#586e75">#&lt;struct Molinillo::PossibilityState name=&#34;B&#34;, requirements=[], ..., </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>   <span style="color:#586e75">#&lt;struct Molinillo::DependencyState name=&#34;&#34;, requirements=[], ..., </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">]</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°æ ˆå†…ä¿å­˜çš„ states ä¸­ <code>DependencyState</code> ä¸ <code>PossibilityState</code> æ˜¯æˆå¯¹å‡ºç°çš„ã€‚ä¸è¿‡æœ€åå…¥æ ˆçš„ <code>DependencyState</code> æ˜¯ä¸€ä¸ªç©ºçŠ¶æ€ï¼Œrequirements ä¹Ÿä¸ºç©ºï¼Œæ­¤æ—¶æ— æ³•å† pop state å¾ªç¯ç»“æŸã€‚</p>
<h2 id="dependencygraph">DependencyGraph</h2>
<p>å…¶å®åŒ…æ‹¬ Molinillo åœ¨å†…çš„ä¾èµ–è§£æå·¥å…·éƒ½ä¼šåœ¨è¿è¡ŒæœŸé—´å¯¹ä¾èµ–å…³ç³»è¿›è¡Œå»ºæ¨¡æ¥æ„å»ºä¾èµ–å›¾ï¼Œæ¯•ç«Ÿè¿™æ˜¯æˆ‘ä»¬è¡¨è¾¾ä¾èµ–å…³ç³»çš„æ–¹å¼ã€‚é‚£ä¹ˆ DependencyGraph (ä»¥ä¸‹ç®€ç§° <code>dg</code> ) æ˜¯å¦‚ä½•å®šä¹‰ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyGraph</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75"># æœ‰å‘è¾¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#cb4b16">Edge</span> <span style="color:#719e07">=</span> <span style="color:#cb4b16">Struct</span><span style="color:#719e07">.</span>new(<span style="color:#2aa198">:origin</span>, <span style="color:#2aa198">:destination</span>, <span style="color:#2aa198">:requirement</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#586e75"># @return [{String =&gt; Vertex}] ç”¨å­—å…¸ä¿å­˜é¡¶ç‚¹, key ä¸ºé¡¶ç‚¹åç§°(å³ requirement.name)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:vertices</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#586e75"># @return [Log] æ“ä½œæ—¥å¿—</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:log</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>	 <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">end</span>
</code></pre></div><p>å¦å¤– <strong>Vertex</strong> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyGraph</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Vertex</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>      <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>      <span style="color:#586e75"># @return [Object] é¡¶ç‚¹çš„å…ƒæ•°æ®ï¼Œreqiuremnt å¯¹åº”çš„ possiblity</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:payload</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      <span style="color:#586e75"># @return [Array&lt;Object&gt;] éœ€è¦ä¾èµ–è¯¥é¡¶ç‚¹å¯èƒ½æ€§èƒ½çš„éœ€æ±‚</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:explicit_requirements</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      <span style="color:#586e75"># @return [Boolean] æ˜¯å¦ä¸ºæ ¹ç»“ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:root</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      <span style="color:#586e75"># @return [Array&lt;Edge&gt;] å‡ºåº¦ {Edge#origin}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:outgoing_edges</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#586e75"># @return [Array&lt;Edge&gt;] å…¥åº¦ {Edge#destination}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>      <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:incoming_edges</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#586e75"># @return [Array&lt;Vertex&gt;] å…¥åº¦çš„èµ·ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">predecessors</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        incoming_edges<span style="color:#719e07">.</span>map(<span style="color:#719e07">&amp;</span><span style="color:#2aa198">:origin</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>      <span style="color:#586e75"># @return [Array&lt;Vertex&gt;] å‡ºåº¦çš„ç»ˆç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">successors</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        outgoing_edges<span style="color:#719e07">.</span>map(<span style="color:#719e07">&amp;</span><span style="color:#2aa198">:destination</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span><span style="color:#719e07">end</span>
</code></pre></div><p>ç†Ÿæ‚‰å›¾è®ºçš„åŒå­¦éƒ½äº†è§£ï¼Œå›¾çš„ä¿å­˜å¸¸ç”¨çš„æ–¹å¼æ˜¯<strong>é‚»æ¥è¡¨</strong>å’Œ<strong>é‚»æ¥çŸ©é˜µ</strong>ã€‚Molinillo åˆ™é€šè¿‡ map + listï¼Œvertext å­—å…¸ä¸è¾¹é›†æ•°ç»„æ¥ä¿å­˜ã€‚å¦‚æœä»…ç”¨è¾¹é›†æ•°ç»„æ¥æŸ¥è¯¢é¡¶ç‚¹æœ¬èº«æ•ˆç‡å¹¶ä¸é«˜ï¼Œå¥½åœ¨é¡¶ç‚¹ç›´æ¥ç”¨äº†å­—å…¸ä¿å­˜äº†ã€‚Molinillo é€šè¿‡æ ˆæ¥ç»´æŠ¤è§£æçŠ¶æ€ï¼Œä¸æ–­å°†è§£æç»“æœ possibility å­˜å…¥ dg çš„ payload ä¸­ï¼ŒåŒæ—¶è®°å½•äº†å„ä¸ªé¡¶ç‚¹çš„ä¾èµ–å…³ç³»ï¼Œå³ dg çš„å‡ºåº¦å’Œå…¥åº¦ã€‚</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/06-Vertex.png" alt="06-Vertex"></p>
<blockquote>
<ul>
<li>åœ¨æœ‰å‘å›¾ä¸­å¯¹äºä¸€ä¸ªé¡¶ç‚¹æ¥è¯´ï¼Œå¦‚æœä¸€æ¡è¾¹çš„ç»ˆç‚¹æ˜¯è¿™ä¸ªé¡¶ç‚¹ï¼Œè¿™æ¡è¾¹å°±æ˜¯è¿™ä¸ªé¡¶ç‚¹çš„å…¥åº¦ï¼›</li>
<li>åœ¨æœ‰å‘å›¾ä¸­å¯¹äºä¸€ä¸ªé¡¶ç‚¹æ¥è¯´ï¼Œå¦‚æœä¸€æ¡è¾¹çš„èµ·ç‚¹æ˜¯è¿™ä¸ªé¡¶ç‚¹ï¼Œè¿™æ¡è¾¹å°±æ˜¯è¿™ä¸ªé¡¶ç‚¹çš„å‡ºåº¦ã€‚</li>
</ul>
</blockquote>
<p>å½“æˆåŠŸè§£æçš„ä¸€åˆ»ï¼Œdg å›¾ä¹Ÿæ„å»ºå®Œæ¯•ã€‚</p>
<h3 id="operation-log">Operation Log</h3>
<p>å½“è§£æè¿‡ç¨‹å‡ºç°å†²çªæ—¶ï¼ŒçŠ¶æ€æ ˆè¦å›æº¯ç›´æ¥ pop ä¸€ä¸‹å°±å®Œäº‹äº†ï¼Œè€Œ dg å’‹åŠ ? å®ƒå¯æ²¡æ³• popã€‚</p>
<p>å¥½åœ¨ Molinillo è®¾è®¡äº† Operation Log æœºåˆ¶ï¼Œé€šè¿‡ Log è®°å½• dg æ‰§è¡Œè¿‡çš„æ“ä½œã€‚è¿™äº›æ“ä½œç±»å‹åŒ…æ‹¬ï¼š<strong>AddEdgeNoCircularã€AddVertexã€DeleteEdgeã€DetachVertexNamedã€SetPayloadã€Tag</strong>ã€‚</p>
<p>Log ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># frozen_string_literal: true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyGraph</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Log</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        @current_action <span style="color:#719e07">=</span> @first_action <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">pop!</span>(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>        <span style="color:#719e07">return</span> <span style="color:#719e07">unless</span> action <span style="color:#719e07">=</span> @current_action
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        <span style="color:#719e07">unless</span> @current_action <span style="color:#719e07">=</span> action<span style="color:#719e07">.</span>previous
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>          @first_action <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        action<span style="color:#719e07">.</span>down(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        action
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>      <span style="color:#586e75"># å›æ’¤åˆ°æŒ‡å®šçš„æ“ä½œèŠ‚ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">rewind_to</span>(graph, tag)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        <span style="color:#719e07">loop</span> <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>          action <span style="color:#719e07">=</span> pop!(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>          <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#34;No tag </span><span style="color:#2aa198">#{</span>tag<span style="color:#719e07">.</span>inspect<span style="color:#2aa198">}</span><span style="color:#2aa198"> found&#34;</span> <span style="color:#719e07">unless</span> action
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>          <span style="color:#719e07">break</span> <span style="color:#719e07">if</span> action<span style="color:#719e07">.</span>class<span style="color:#719e07">.</span>action_name <span style="color:#719e07">==</span> <span style="color:#2aa198">:tag</span> <span style="color:#719e07">&amp;&amp;</span> action<span style="color:#719e07">.</span>tag <span style="color:#719e07">==</span> tag
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>      <span style="color:#719e07">private</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>      <span style="color:#586e75"># æ’å…¥æ“ä½œèŠ‚ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">push_action</span>(graph, action)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>        action<span style="color:#719e07">.</span>previous <span style="color:#719e07">=</span> @current_action
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>        @current_action<span style="color:#719e07">.</span>next <span style="color:#719e07">=</span> action <span style="color:#719e07">if</span> @current_action
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>        @current_action <span style="color:#719e07">=</span> action
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>        @first_action <span style="color:#719e07">||=</span> action
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>        action<span style="color:#719e07">.</span>up(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>      <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span><span style="color:#719e07">end</span>
</code></pre></div><p>æ ‡å‡†çš„é“¾è¡¨ç»“æ„ï¼ŒLog æä¾›äº†å½“å‰æŒ‡é’ˆ <code>@current_action</code> å’Œè¡¨å¤´æŒ‡é’ˆ <code>@first_action</code> ä¾¿äºé“¾è¡¨çš„éå†ã€‚æ¥ç€çœ‹çœ‹ Actionï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># frozen_string_literal: true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyGraph</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Action</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      <span style="color:#586e75"># @return [Symbol] action åç§°</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">action_name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#39;Abstract&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#586e75"># å¯¹å›¾æ‰§è¡Œæ­£å‘æ“ä½œ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">up</span>(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#39;Abstract&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>      <span style="color:#586e75"># æ’¤é”€å¯¹å›¾çš„æ“ä½œ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">down</span>(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>        <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#39;Abstract&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>       
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      <span style="color:#586e75"># @return [Action,Nil] å‰åºèŠ‚ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:previous</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>      <span style="color:#586e75"># @return [Action,Nil] ååºèŠ‚ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>      <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:next</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span><span style="color:#719e07">end</span>
</code></pre></div><p>Action æœ¬èº«æ˜¯ä¸ªæŠ½è±¡ç±»ï¼ŒLog é€šè¿‡ Action å­ç±»çš„ <code>#up</code>ã€<code>#down</code> æ¥å®Œæˆå¯¹ dg çš„æ“ä½œå’Œæ’¤é”€ã€‚æ‰€æä¾›çš„ Action ä¸­é™¤äº† <strong>Tag</strong> ç‰¹æ®Šä¸€ç‚¹ï¼Œå…¶ä½™å‡æ˜¯å¯¹ dg çš„é¡¶ç‚¹å’Œè¾¹çš„ CURD æ“ä½œã€‚è¿™é‡Œä»¥ <code>AddVertex</code> ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># frozen_string_literal: true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>require_relative <span style="color:#2aa198">&#39;action&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyGraph</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>	 <span style="color:#586e75"># @!visibility private</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">AddVertex</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Action</span> <span style="color:#586e75"># :nodoc:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">action_name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#2aa198">:add_vertex</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#586e75"># æ“ä½œæ·»åŠ é¡¶ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">up</span>(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>        <span style="color:#719e07">if</span> existing <span style="color:#719e07">=</span> graph<span style="color:#719e07">.</span>vertices<span style="color:#719e07">[</span><span style="color:#b58900">name</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>          @existing_payload <span style="color:#719e07">=</span> existing<span style="color:#719e07">.</span>payload
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>          @existing_root <span style="color:#719e07">=</span> existing<span style="color:#719e07">.</span>root
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        vertex <span style="color:#719e07">=</span> existing <span style="color:#719e07">||</span> <span style="color:#cb4b16">Vertex</span><span style="color:#719e07">.</span>new(<span style="color:#b58900">name</span>, payload)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>        graph<span style="color:#719e07">.</span>vertices<span style="color:#719e07">[</span>vertex<span style="color:#719e07">.</span>name<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> vertex
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        vertex<span style="color:#719e07">.</span>payload <span style="color:#719e07">||=</span> payload
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        vertex<span style="color:#719e07">.</span>root <span style="color:#719e07">||=</span> root
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>        vertex
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>      <span style="color:#586e75"># åˆ é™¤é¡¶ç‚¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">down</span>(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        <span style="color:#719e07">if</span> defined?(@existing_payload)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>          vertex <span style="color:#719e07">=</span> graph<span style="color:#719e07">.</span>vertices<span style="color:#719e07">[</span><span style="color:#b58900">name</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>          vertex<span style="color:#719e07">.</span>payload <span style="color:#719e07">=</span> @existing_payload
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>          vertex<span style="color:#719e07">.</span>root <span style="color:#719e07">=</span> @existing_root
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>        <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>          graph<span style="color:#719e07">.</span>vertices<span style="color:#719e07">.</span>delete(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>      <span style="color:#586e75"># @return [String] é¡¶ç‚¹åç§° (æˆ–è€…è¯´ä¾èµ–åç§°)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>      <span style="color:#586e75"># @return [Object] é¡¶ç‚¹å…ƒæ•°æ®</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:payload</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>      <span style="color:#586e75"># @return [Boolean] æ˜¯å¦ä¸ºæ ¹</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:root</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>		<span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45</span><span style="color:#719e07">end</span>
</code></pre></div><p>Action å­ç±»å‡å£°æ˜ä¸º private çš„ï¼Œé€šè¿‡ Log æä¾›çš„å¯¹åº”æ–¹æ³•æ¥æ‰§è¡Œã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">tag</span>(graph, tag)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  push_action(graph, <span style="color:#cb4b16">Tag</span><span style="color:#719e07">.</span>new(tag))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#719e07">def</span> <span style="color:#268bd2">add_vertex</span>(graph, <span style="color:#b58900">name</span>, payload, root)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  push_action(graph, <span style="color:#cb4b16">AddVertex</span><span style="color:#719e07">.</span>new(<span style="color:#b58900">name</span>, payload, root))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#719e07">def</span> <span style="color:#268bd2">detach_vertex_named</span>(graph, <span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  push_action(graph, <span style="color:#cb4b16">DetachVertexNamed</span><span style="color:#719e07">.</span>new(<span style="color:#b58900">name</span>))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">def</span> <span style="color:#268bd2">add_edge_no_circular</span>(graph, origin, destination, requirement)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  push_action(graph, <span style="color:#cb4b16">AddEdgeNoCircular</span><span style="color:#719e07">.</span>new(origin, destination, requirement))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07">def</span> <span style="color:#268bd2">delete_edge</span>(graph, origin_name, destination_name, requirement)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  push_action(graph, <span style="color:#cb4b16">DeleteEdge</span><span style="color:#719e07">.</span>new(origin_name, destination_name, requirement))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#719e07">def</span> <span style="color:#268bd2">set_payload</span>(graph, <span style="color:#b58900">name</span>, payload)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>  push_action(graph, <span style="color:#cb4b16">SetPayload</span><span style="color:#719e07">.</span>new(<span style="color:#b58900">name</span>, payload))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span><span style="color:#719e07">end</span>
</code></pre></div><p>æœ€å log å£°æ˜çš„è¿™äº›æ–¹æ³•ä¼šç”± dg ç›´æ¥è°ƒç”¨ï¼Œå¦‚ <code>#addVertext</code>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyGraph</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">add_vertex</span>(<span style="color:#b58900">name</span>, payload, root <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>      log<span style="color:#719e07">.</span>add_vertex(<span style="color:#b58900">self</span>, <span style="color:#b58900">name</span>, payload, root)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">end</span>
</code></pre></div><h2 id="unwind-for-conflict">Unwind For Conflict</h2>
<p>æœ‰äº† op log ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦ä¸€æ ·é‡è¦çš„ä¸œè¥¿ï¼š<strong>å“¨å…µèŠ‚ç‚¹</strong>ã€‚ç”± Tag ç±»æ¥æ‰¿è½½ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># frozen_string_literal: true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">DependencyGraph</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75"># @!visibility private     </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">class</span> <span style="color:#268bd2">Tag</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Action</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">up</span>(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>       
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">down</span>(graph)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:tag</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(tag)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        @tag <span style="color:#719e07">=</span> tag
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">end</span>
</code></pre></div><p>ä½œä¸ºå“¨å…µèŠ‚ç‚¹ Tag çš„ <strong>#up</strong> ä¸ <strong>#down</strong> æ“ä½œæ€»æ˜¯æˆå¯¹å‡ºç°çš„ã€‚åœ¨ Molinillo ä¸­æœ‰ä¸¤å¤„éœ€è¦è¿›è¡ŒçŠ¶æ€å›æº¯ï¼Œåˆ†åˆ«ä¸ºå¯èƒ½æ€§æ ¡éªŒå’Œå†²çªçŠ¶æ€å›æ’¤ã€‚</p>
<h3 id="0x1-å¯èƒ½æ€§æ ¡éªŒ">0x1 å¯èƒ½æ€§æ ¡éªŒ</h3>
<p><code>#possibility_satisfies_requirements?</code> æ–¹æ³•ç”¨äºå†²çªäº§ç”Ÿçš„å‰åï¼Œç”¨äºåˆ¤æ–­è¯¥å¯èƒ½æ€§èƒ½å¦åŒæ—¶æ»¡è¶³å¤šä¸ªéœ€æ±‚ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">possibility_satisfies_requirements?</span>(possibility, requirements)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#b58900">name</span> <span style="color:#719e07">=</span> name_for(possibility)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  activated<span style="color:#719e07">.</span>tag(<span style="color:#2aa198">:swap</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  activated<span style="color:#719e07">.</span>set_payload(<span style="color:#b58900">name</span>, possibility) <span style="color:#719e07">if</span> activated<span style="color:#719e07">.</span>vertex_named(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  satisfied <span style="color:#719e07">=</span> requirements<span style="color:#719e07">.</span>all? { <span style="color:#719e07">|</span>r<span style="color:#719e07">|</span> requirement_satisfied_by?(r, activated, possibility) }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  activated<span style="color:#719e07">.</span>rewind_to(<span style="color:#2aa198">:swap</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  satisfied
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">end</span>
</code></pre></div><p>ä¸ºäº†ç›´è§‚çš„è¯´æ˜å‚æ•°ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ã€‚<code>Case 1</code>å‡è®¾ <code>Podfile</code> ä¸­å­˜åœ¨ pod A å’Œ Bï¼Œä¸” Aã€B åˆ†åˆ«ä¾èµ–äº† Alamofire 3.0 å’Œ 4.0ï¼Œé‚£ä¹ˆå¯¹åº”çš„å‚æ•°ä¸ºï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#2aa198">possibility</span>: <span style="color:#586e75">#&lt;Pod::Specification name=&#34;Alamofire&#34; version=&#34;4.0.0&#34;&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#2aa198">requirements</span>: <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>	<span style="color:#719e07">&lt;</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Dependency</span> <span style="color:#b58900">name</span><span style="color:#719e07">=</span><span style="color:#cb4b16">Alamofire</span> requirements<span style="color:#719e07">=~&gt;</span> <span style="color:#2aa198">3</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span> source<span style="color:#719e07">=</span><span style="color:#719e07">nil</span> external_source<span style="color:#719e07">=</span><span style="color:#719e07">nil</span><span style="color:#719e07">&gt;</span>, 		<span style="color:#719e07">&lt;</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Dependency</span> <span style="color:#b58900">name</span><span style="color:#719e07">=</span><span style="color:#cb4b16">Alamofire</span> requirements<span style="color:#719e07">=~&gt;</span> <span style="color:#2aa198">4</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span> source<span style="color:#719e07">=</span><span style="color:#719e07">nil</span> external_source<span style="color:#719e07">=</span><span style="color:#719e07">nil</span><span style="color:#719e07">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">]</span>
</code></pre></div><p>ç°åœ¨æ¥çœ‹æ–¹æ³•å®ç°ï¼š</p>
<ol>
<li>é¦–å…ˆ <code>activated</code> å°±æ˜¯ Podfile è§£æç”Ÿæˆçš„ dg å¯¹è±¡ï¼Œè¿™é‡Œå°† symbol <code>:swap</code> ä½œä¸ºæ ‡è¯†ç”¨äºç¨åçš„å›æ’¤ï¼›</li>
<li>è°ƒç”¨ <code>#set_payload</code> å°†é¡¶ç‚¹ Alamofire çš„ payload ä¿®æ”¹ä¸º possibility ç‰ˆæœ¬ï¼›</li>
<li>éå† requirements å¹¶è°ƒç”¨ä»£ç†çš„ <code>#requirement_satisfied_by</code> ä»¥æ ¡éªŒ possiblity åœ¨ dg ä¸­å­˜åœ¨çš„å¯èƒ½æ€§ï¼›</li>
<li>è°ƒç”¨ <code>#rewind_to</code> å°†é¡¶ç‚¹çš„ä¿®æ”¹å›æ’¤è‡³ <code>:swap</code> å‰çš„çŠ¶æ€ï¼Œæœ€åè¿”å›æ£€éªŒç»“æœã€‚</li>
</ol>
<blockquote>
<p>Tips: æ­¤å¤„çš„ä»£ç†æ˜¯æŒ‡ CocoaPodsï¼Œå®ƒåšä¸º Molinillo çš„ client å®ç°äº†å¾ˆå¤šä»£ç†æ–¹æ³•ï¼Œåç»­ä¼šèŠåˆ°ã€‚</p>
</blockquote>
<p>ä½œä¸ºå€™é€‰é¡¹ possibility å½“ç„¶ä¸æ­¢ä¸€ä¸ªï¼Œä»£ç†æä¾›çš„æŸ¥è¯¢æ–¹æ³• <code>#search_for(dependency)</code> ä¼šè¿”å›æ‰€æœ‰ç¬¦åˆ requiremnt åç§°çš„ä¾èµ–ã€‚åœ¨ CocoaPods ä¸­ï¼Œå°±æ˜¯é€šè¿‡ <code>Pod::Source</code> æŸ¥è¯¢è·å¾—æ‰€æœ‰ç‰ˆæœ¬çš„ <code>Pod::Specification</code>ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/275680356">PodSpec ç®¡ç†ç­–ç•¥</a>ã€‚</p>
<h3 id="0x2-å†²çªçŠ¶æ€å›æ’¤">0x2 å†²çªçŠ¶æ€å›æ’¤</h3>
<p>ä¾èµ–è§£æè¿‡ç¨‹å‡ºç°å†²çªå±äºæ­£å¸¸æƒ…å†µï¼Œæ­¤æ—¶é€šè¿‡å›æ’¤ä¹Ÿè®¸å¯ä»¥é¿å…éƒ¨åˆ†å†²çªï¼Œæ‰¾å‡ºå…¶å®ƒå¯è¡Œè§£ã€‚Molinillo é€šè¿‡å®šä¹‰ <code>Conflict</code> æ¥è®°å½•å½“å‰çš„å†²çªçš„å¿…è¦ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#cb4b16">Conflict</span> <span style="color:#719e07">=</span> <span style="color:#cb4b16">Struct</span><span style="color:#719e07">.</span>new(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#2aa198">:requirement</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#2aa198">:requirements</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#2aa198">:existing</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#2aa198">:possibility_set</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#2aa198">:locked_requirement</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#2aa198">:requirement_trees</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#2aa198">:activated_by_name</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#2aa198">:underlying_error</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>)
</code></pre></div><p>é‡ç‚¹å…³æ³¨ <code>underlying_error</code>ï¼Œå®ƒè®°å½•äº†æ‰€æ‹¦æˆªçš„æŒ‡å®šç±»å‹é”™è¯¯ï¼Œå¹¶ç”¨äºçŠ¶æ€å›æ’¤æ—¶çš„ä¸€äº›åˆ¤æ–­ä¾æ® (åé¢ä¼šè§£é‡Š)ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å®šä¹‰çš„é”™è¯¯ç±»å‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># frozen_string_literal: true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">ResolverError</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">StandardError</span>; <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#586e75"># é”™è¯¯ä¿¡æ¯ï¼š&#34;Unable to find a specification for `#{dependency}`&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">NoSuchDependencyError</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ResolverError</span> <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#586e75"># é”™è¯¯ä¿¡æ¯ï¼š&#34;There is a circular dependency between ...&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">CircularDependencyError</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ResolverError</span> <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>        
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  <span style="color:#586e75"># å½“å‡ºç°ç‰ˆæœ¬å†²çªæ—¶æŠ›å‡º</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#586e75"># é”™è¯¯ä¿¡æ¯ï¼š&#34;Unable to satisfy the following requirements:\n\n ...&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">VersionConflict</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ResolverError</span> <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07">end</span>
</code></pre></div><p>é™¤äº†ä¸»åŠ¨æ‹¦æˆªé”™è¯¯ä¹‹å¤–ï¼Œpossiblity ä¸å­˜åœ¨æ—¶ä¹Ÿä¼šä¸»åŠ¨ç”Ÿæˆå†²çªï¼ŒåŒæ—¶è¿›å…¥çŠ¶æ€å›æ’¤å¤„ç†ã€‚å‘ç”Ÿå†²çªåè°ƒç”¨ <code>#create_conflict</code> å’Œ <code>#unwind_for_conflict</code> ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºç”Ÿæˆ Conflict å¯¹è±¡å’ŒçŠ¶æ€å›æ’¤ã€‚</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">process_topmost_state</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">if</span> possibility
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    attempt_to_activate
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    create_conflict
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    unwind_for_conflict
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#719e07">rescue</span> <span style="color:#cb4b16">CircularDependencyError</span> <span style="color:#719e07">=&gt;</span> underlying_error
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  create_conflict(underlying_error)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  unwind_for_conflict
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">def</span> <span style="color:#268bd2">attempt_to_activate</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  debug(depth) { <span style="color:#2aa198">&#39;Attempting to activate &#39;</span> <span style="color:#719e07">+</span> possibility<span style="color:#719e07">.</span>to_s }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  existing_vertex <span style="color:#719e07">=</span> activated<span style="color:#719e07">.</span>vertex_named(<span style="color:#b58900">name</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  <span style="color:#719e07">if</span> existing_vertex<span style="color:#719e07">.</span>payload
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    debug(depth) { <span style="color:#2aa198">&#34;Found existing spec (</span><span style="color:#2aa198">#{</span>existing_vertex<span style="color:#719e07">.</span>payload<span style="color:#2aa198">}</span><span style="color:#2aa198">)&#34;</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    attempt_to_filter_existing_spec(existing_vertex)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>    latest <span style="color:#719e07">=</span> possibility<span style="color:#719e07">.</span>latest_version
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    possibility<span style="color:#719e07">.</span>possibilities<span style="color:#719e07">.</span>select! <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>possibility<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      requirement_satisfied_by?(requirement, activated, possibility)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">if</span> possibility<span style="color:#719e07">.</span>latest_version<span style="color:#719e07">.</span>nil?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>      <span style="color:#586e75"># ensure there&#39;s a possibility for better error messages</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>      possibility<span style="color:#719e07">.</span>possibilities <span style="color:#719e07">&lt;&lt;</span> latest <span style="color:#719e07">if</span> latest
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>      create_conflict
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>      unwind_for_conflict
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>    <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>      activate_new_spec
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span><span style="color:#719e07">def</span> <span style="color:#268bd2">attempt_to_filter_existing_spec</span>(vertex)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>  filtered_set <span style="color:#719e07">=</span> filtered_possibility_set(vertex)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>  <span style="color:#719e07">if</span> <span style="color:#719e07">!</span>filtered_set<span style="color:#719e07">.</span>possibilities<span style="color:#719e07">.</span>empty?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>    activated<span style="color:#719e07">.</span>set_payload(<span style="color:#b58900">name</span>, filtered_set)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>    new_requirements <span style="color:#719e07">=</span> requirements<span style="color:#719e07">.</span>dup
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>    push_state_for_requirements(new_requirements, <span style="color:#719e07">false</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>  <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>    create_conflict
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span>    debug(depth) { <span style="color:#2aa198">&#34;Unsatisfied by existing spec (</span><span style="color:#2aa198">#{</span>vertex<span style="color:#719e07">.</span>payload<span style="color:#2aa198">}</span><span style="color:#2aa198">)&#34;</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44</span>    unwind_for_conflict
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">46</span><span style="color:#719e07">end</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°è¿™ 3 ä¸ªæ–¹æ³•ä¸­å¤„ç†äº† 4 å¤„å†²çªçš„æƒ…å†µã€‚å…¶ä¸­ <code>#process_topmost_state</code> æ–¹æ³•æ‹¦æˆªäº† <strong>CircularDependencyError</strong> å¹¶å°†å…¶è®°å½•åœ¨ Conflict çš„ <code>underlying_error</code> ä¸­ï¼Œå…¶ä½™çš„éƒ½æ˜¯å› ä¸º possibility å¯è¡Œè§£ä¸å­˜åœ¨è€Œä¸»åŠ¨æŠ›å‡ºå†²çªã€‚</p>
<p>æˆ‘ä»¬ç®€åŒ–æˆä¸‹é¢çš„çŠ¶æ€å›¾ï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/08-process-topmost-state.png" alt="08-process-topmost-state"></p>
<p>å¯ä»¥ç†è§£ possiblity çŠ¶æ€æœºï¼Œé€šè¿‡ä¸æ–­æ£€æŸ¥å¯èƒ½æ€§ï¼Œä¸€æ—¦å‡ºé”™ä¸»åŠ¨ç”Ÿæˆå¼‚å¸¸ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš ï¼Ÿ å› ä¸ºçŠ¶æ€å›æº¯çš„æˆæœ¬æ˜¯å¾ˆé«˜çš„ï¼Œä¸€æ—¦å‘ç”Ÿæ„å‘³ç€æˆ‘ä»¬ä¹‹å‰æ£€æŸ¥å·¥ä½œå¯èƒ½å°±ç™½è´¹äº†ã€‚è¿™ä¹Ÿæ˜¯ Molinillo å‰å‘æŸ¥è¯¢çš„å……ç”µï¼Œé€šè¿‡ææ—©æš´éœ²é—®é¢˜ï¼Œæå‰å›æº¯ã€‚</p>
<p><strong>unwind_for_conflict</strong></p>
<p>äº†è§£äº†å†²çªæ—¶å¦‚ä½•äº§ç”Ÿä¹‹åï¼Œæ¥ä¸‹æ¥è¯¥ <code>#unwind_for_conflict</code> ç™»åœºäº†ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">unwind_for_conflict</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  details_for_unwind <span style="color:#719e07">=</span> build_details_for_unwind
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  unwind_options <span style="color:#719e07">=</span> unused_unwind_options
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  debug(depth) { <span style="color:#2aa198">&#34;Unwinding for conflict: </span><span style="color:#2aa198">#{</span>requirement<span style="color:#2aa198">}</span><span style="color:#2aa198"> to </span><span style="color:#2aa198">#{</span>details_for_unwind<span style="color:#719e07">.</span>state_index <span style="color:#719e07">/</span> <span style="color:#2aa198">2</span><span style="color:#2aa198">}</span><span style="color:#2aa198">&#34;</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  conflicts<span style="color:#719e07">.</span>tap <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>c<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    sliced_states <span style="color:#719e07">=</span> states<span style="color:#719e07">.</span>slice!((details_for_unwind<span style="color:#719e07">.</span>state_index <span style="color:#719e07">+</span> <span style="color:#2aa198">1</span>)<span style="color:#719e07">..-</span><span style="color:#2aa198">1</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    raise_error_unless_state(c)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    activated<span style="color:#719e07">.</span>rewind_to(sliced_states<span style="color:#719e07">.</span>first <span style="color:#719e07">||</span> <span style="color:#2aa198">:initial_state</span>) <span style="color:#719e07">if</span> sliced_states
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    state<span style="color:#719e07">.</span>conflicts <span style="color:#719e07">=</span> c
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    state<span style="color:#719e07">.</span>unused_unwind_options <span style="color:#719e07">=</span> unwind_options
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    filter_possibilities_after_unwind(details_for_unwind)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    index <span style="color:#719e07">=</span> states<span style="color:#719e07">.</span>size <span style="color:#719e07">-</span> <span style="color:#2aa198">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    @parents_of<span style="color:#719e07">.</span>each { <span style="color:#719e07">|</span>_, a<span style="color:#719e07">|</span> a<span style="color:#719e07">.</span>reject! { <span style="color:#719e07">|</span>i<span style="color:#719e07">|</span> i <span style="color:#719e07">&gt;=</span> index } }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    state<span style="color:#719e07">.</span>unused_unwind_options<span style="color:#719e07">.</span>reject! { <span style="color:#719e07">|</span>uw<span style="color:#719e07">|</span> uw<span style="color:#719e07">.</span>state_index <span style="color:#719e07">&gt;=</span> index }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span><span style="color:#719e07">end</span>
</code></pre></div><p>å†²çªå›æº¯å°±æ¶‰åŠåˆ°å‰é¢è¯´è¿‡çš„ä¸¤ä¸ªçŠ¶æ€éœ€è¦å¤„ç†ï¼Œåˆ†åˆ«æ˜¯çŠ¶æ€æ ˆ <code>@states</code> å’Œ dg å†…å®¹çš„å›æº¯ã€‚ <code>@state</code> æœ¬èº«æ˜¯æ•°ç»„å®ç°çš„ï¼Œå…¶å…ƒç´ æ˜¯å„ä¸ªçŠ¶æ€çš„ state, è¦å›æº¯åˆ°æŒ‡å®šçš„ state åˆ™è¦åˆ©ç”¨ <code>state_index</code>ï¼Œå®ƒä¿å­˜åœ¨ <code>UnwindDetails</code> ä¸­ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#cb4b16">UnwindDetails</span> <span style="color:#719e07">=</span> <span style="color:#cb4b16">Struct</span><span style="color:#719e07">.</span>new(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#2aa198">:state_index</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#2aa198">:state_requirement</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#2aa198">:requirement_tree</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#2aa198">:conflicting_requirements</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#2aa198">:requirement_trees</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#2aa198">:requirements_unwound_to_instead</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">class</span> <span style="color:#268bd2">UnwindDetails</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#719e07">include</span> <span style="color:#cb4b16">Comparable</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
</code></pre></div><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ requirement_treesï¼Œè¿™é‡Œæ˜¯æŒ‡ä»¥å½“å‰éœ€æ±‚ä½œä¸ºä¾èµ–çš„éœ€æ±‚ã€‚ä»¥ä¸Šé¢çš„ <code>Case 1</code> ä¸ºä¾‹ï¼Œå½“å‰å†²çªçš„ requirement å°±æ˜¯ Alamofireï¼Œå¯¹åº” requirement_trees å°±æ˜¯ä¾èµ–äº† Alamofire çš„ Pod A å’Œ Bï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#719e07">&lt;</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Dependency</span> <span style="color:#b58900">name</span><span style="color:#719e07">=</span>A requirements<span style="color:#719e07">=</span><span style="color:#719e07">nil</span> source<span style="color:#719e07">=</span><span style="color:#719e07">nil</span> external_source<span style="color:#719e07">=</span><span style="color:#719e07">nil</span><span style="color:#719e07">&gt;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#719e07">&lt;</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Dependency</span> <span style="color:#b58900">name</span><span style="color:#719e07">=</span><span style="color:#cb4b16">Alamofire</span> requirements<span style="color:#719e07">=~&gt;</span> <span style="color:#2aa198">3</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span> <span style="color:#719e07">...&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>  <span style="color:#719e07">]</span>,<span style="color:#719e07">[</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    <span style="color:#719e07">&lt;</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Dependency</span> <span style="color:#b58900">name</span><span style="color:#719e07">=</span>B <span style="color:#719e07">...&gt;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    <span style="color:#719e07">&lt;</span><span style="color:#cb4b16">Pod</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Dependency</span> <span style="color:#b58900">name</span><span style="color:#719e07">=</span><span style="color:#cb4b16">Alamofire</span> requirements<span style="color:#719e07">=~&gt;</span> <span style="color:#2aa198">4</span><span style="color:#719e07">.</span><span style="color:#2aa198">0</span> <span style="color:#719e07">...&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>  <span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">]</span>
</code></pre></div><p><code>#build_details_for_unwind</code> ä¸»è¦ç”¨äºç”Ÿæˆ UnwindDetailsï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">build_details_for_unwind</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  current_conflict <span style="color:#719e07">=</span> conflicts<span style="color:#719e07">[</span><span style="color:#b58900">name</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  binding_requirements <span style="color:#719e07">=</span> binding_requirements_for_conflict(current_conflict)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  unwind_details <span style="color:#719e07">=</span> unwind_options_for_requirements(binding_requirements)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  last_detail_for_current_unwind <span style="color:#719e07">=</span> unwind_details<span style="color:#719e07">.</span>sort<span style="color:#719e07">.</span>last
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  current_detail <span style="color:#719e07">=</span> last_detail_for_current_unwind
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#586e75"># filter &amp; update details options</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  current_detail
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">end</span>
</code></pre></div><ol>
<li>ä»¥ conflict.requirement ä¸ºå‚æ•°ï¼Œæ‰§è¡Œ <code>#binding_requirements_for_conflict</code> ä»¥æŸ¥æ‰¾å‡ºå­˜åœ¨å†²çªçš„éœ€æ±‚ binding_requirementsã€‚æŸ¥è¯¢æ˜¯é€šè¿‡ä»£ç†çš„ <code>#search_for(dependency)</code> æ–¹æ³•ï¼›</li>
<li>é€šè¿‡ <code>#unwind_options_for_requirements</code> éå†æŸ¥è¯¢åˆ°çš„ binding_requirements è·å– requirement å¯¹åº”çš„ state ä»¥åŠè¯¥ state åœ¨æ ˆä¸­çš„ indexï¼Œç”¨äºç”Ÿæˆ unwind_detailsï¼›</li>
<li>å¯¹ unwind_details æ’åºï¼Œå– last ä½œä¸º current_detail å¹¶è¿›è¡Œå…¶ä»–ç›¸å…³çš„ä¿®æ”¹ã€‚</li>
</ol>
<p><strong>å…³äºå¦‚ä½•è·å– state_index å’Œ unwind_details</strong>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">unwind_options_for_requirements</span>(binding_requirements)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  unwind_details <span style="color:#719e07">=</span> <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  trees <span style="color:#719e07">=</span> <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  binding_requirements<span style="color:#719e07">.</span>reverse_each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>r<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    partial_tree <span style="color:#719e07">=</span> <span style="color:#719e07">[</span>r<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    trees <span style="color:#719e07">&lt;&lt;</span> partial_tree
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    unwind_details <span style="color:#719e07">&lt;&lt;</span> <span style="color:#cb4b16">UnwindDetails</span><span style="color:#719e07">.</span>new(<span style="color:#719e07">-</span><span style="color:#2aa198">1</span>, <span style="color:#719e07">nil</span>, partial_tree, binding_requirements, trees, <span style="color:#719e07">[]</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#586e75"># 1.1 è·å– requirement å¯¹åº”çš„ state</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    requirement_state <span style="color:#719e07">=</span> find_state_for(r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#586e75"># 1.2 ç¡®è®¤ possibility å­˜åœ¨</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#719e07">if</span> conflict_fixing_possibilities?(requirement_state, binding_requirements)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#586e75"># 1.3 ç”Ÿæˆ detail å­˜å…¥ unwind_details</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>      unwind_details <span style="color:#719e07">&lt;&lt;</span> <span style="color:#cb4b16">UnwindDetails</span><span style="color:#719e07">.</span>new(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        states<span style="color:#719e07">.</span>index(requirement_state),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>        r,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>        partial_tree,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>        binding_requirements,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>        trees,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>        <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>      )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#586e75"># 2. æ²¿ç€ requirement ä¾èµ–æ ‘çš„çˆ¶èŠ‚ç‚¹è·å–å…¶ state</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>    parent_r <span style="color:#719e07">=</span> parent_of(r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    <span style="color:#719e07">next</span> <span style="color:#719e07">if</span> parent_r<span style="color:#719e07">.</span>nil?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>    partial_tree<span style="color:#719e07">.</span>unshift(parent_r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>    requirement_state <span style="color:#719e07">=</span> find_state_for(parent_r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>    <span style="color:#586e75"># é‡å¤ 1.2ï¼Œ 1.3 æ­¥éª¤ ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span> 	
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>    <span style="color:#586e75"># 6. æ²¿ç€ä¾èµ–æ ‘ï¼Œé‡å¤ä¸Šè¿°æ“ä½œ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>    grandparent_r <span style="color:#719e07">=</span> parent_of(parent_r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>    <span style="color:#719e07">until</span> grandparent_r<span style="color:#719e07">.</span>nil?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>      partial_tree<span style="color:#719e07">.</span>unshift(grandparent_r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>      requirement_state <span style="color:#719e07">=</span> find_state_for(grandparent_r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>      <span style="color:#586e75"># é‡å¤ 1.2ã€1.3 æ­¥éª¤ ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span>      parent_r <span style="color:#719e07">=</span> grandparent_r
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38</span>      grandparent_r <span style="color:#719e07">=</span> parent_of(parent_r)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42</span>  unwind_details
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43</span><span style="color:#719e07">end</span>
</code></pre></div><p>ç¡®è®¤ state_index åï¼Œæ ˆå›æº¯åè€Œæ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥ <code>#slice!</code> å³å¯ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>sliced_states = states.slice!((details_for_unwind.state_index + 1)..-1)
</code></pre></div><p>dg å›æ’¤è¿˜æ˜¯ <code>    activated.rewind_to(sliced_states.first || :initial_state) if sliced_states</code>ã€‚å›æ’¤ç»“æŸåï¼Œæµç¨‹é‡æ–°å›åˆ° Resolution Loopã€‚</p>
<h2 id="specificationprovider">SpecificationProvider</h2>
<p>æœ€åä¸€èŠ‚ç®€å•èŠèŠ SpecificationProviderã€‚ä¸ºäº†æ›´å¥½çš„æ¥å…¥ä¸åŒå¹³å°ï¼ŒåŒæ—¶ä¿è¯ Molinillo çš„é€šç”¨æ€§å’Œçµæ´»æ€§ï¼Œä½œè€…å°†ä¾èµ–æè¿°æ–‡ä»¶æŸ¥è¯¢ç­‰é€»è¾‘æŠ½è±¡æˆäº†ä»£ç†ã€‚</p>
<p>SpecificationProvider ä½œä¸ºå•ç‹¬çš„ Module å£°æ˜äº†æ¥å…¥ç«¯å¿…é¡»å®ç°çš„ APIï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>   <span style="color:#719e07">module</span> SpecificationProvider
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">search_for</span>(dependency)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>      <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">dependencies_for</span>(specification)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
</code></pre></div><p>è€Œ Provider å°±æ˜¯åœ¨ Molinillo åˆå§‹åŒ–çš„æ—¶å€™æ³¨å…¥çš„ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>require_relative <span style="color:#2aa198">&#39;dependency_graph&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Resolver</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    require_relative <span style="color:#2aa198">&#39;resolution&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:specification_provider</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:resolver_ui</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(specification_provider, resolver_ui)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      @specification_provider <span style="color:#719e07">=</span> specification_provider
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      @resolver_ui <span style="color:#719e07">=</span> resolver_ui
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">resolve</span>(requested, base <span style="color:#719e07">=</span> <span style="color:#cb4b16">DependencyGraph</span><span style="color:#719e07">.</span>new)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>      <span style="color:#cb4b16">Resolution</span><span style="color:#719e07">.</span>new(specification_provider,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>                     resolver_ui,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>                     requested,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>                     base)<span style="color:#719e07">.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>        resolve
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span><span style="color:#719e07">end</span>
</code></pre></div><p>è€Œåœ¨ CocoaPods ä¸­çš„åˆå§‹åŒ–æ–¹æ³•åˆ™æ˜¯ï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># /lib/CocoaPods/resolver.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#719e07">def</span> <span style="color:#268bd2">resolve</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  dependencies <span style="color:#719e07">=</span> @podfile_dependency_cache<span style="color:#719e07">.</span>target_definition_list<span style="color:#719e07">.</span>flat_map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>target<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    @podfile_dependency_cache<span style="color:#719e07">.</span>target_definition_dependencies(target)<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>dep<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>      <span style="color:#719e07">next</span> <span style="color:#719e07">unless</span> target<span style="color:#719e07">.</span>platform
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      @platforms_by_dependency<span style="color:#719e07">[</span>dep<span style="color:#719e07">].</span>push(target<span style="color:#719e07">.</span>platform)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#719e07">end</span><span style="color:#719e07">.</span>uniq
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  @platforms_by_dependency<span style="color:#719e07">.</span>each_value(<span style="color:#719e07">&amp;</span><span style="color:#2aa198">:uniq!</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  @activated <span style="color:#719e07">=</span> <span style="color:#cb4b16">Molinillo</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Resolver</span><span style="color:#719e07">.</span>new(<span style="color:#b58900">self</span>, <span style="color:#b58900">self</span>)<span style="color:#719e07">.</span>resolve(dependencies, locked_dependencies)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  resolver_specs_by_target
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#719e07">rescue</span> <span style="color:#cb4b16">Molinillo</span><span style="color:#719e07">::</span><span style="color:#cb4b16">ResolverError</span> <span style="color:#719e07">=&gt;</span> e
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>  handle_resolver_error(e)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#719e07">end</span>
</code></pre></div><p>è¯¥æ–¹æ³•åˆ™å¤„äº pod install ä¸­çš„ resolve dependencies é˜¶æ®µï¼š</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/01-pod-install.png" alt="01-pod-install"></p>
<h3 id="nosuchdependencyerror">NoSuchDependencyError</h3>
<p>å¦å¤–ï¼Œä¸ºäº†æ›´å¥½çš„å¤„ç†äº§ç”Ÿçš„å¼‚å¸¸ï¼ŒåŒæ—¶ä¿è¯æ ¸å¿ƒé€»è¾‘å¯¹ provider çš„æ— æ„ŸçŸ¥ï¼ŒMolinillo å°†ä»£ç†æ–¹æ³•åšäº†ä¸€å±‚éš”ç¦»ï¼Œå¹¶ä¸”å¯¹å¼‚å¸¸åšäº†ç»Ÿä¸€æ‹¦æˆªï¼š</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Molinillo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">module</span> Delegates
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#719e07">module</span> SpecificationProvider
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">search_for</span>(dependency)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        with_no_such_dependency_error_handling <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>          specification_provider<span style="color:#719e07">.</span>search_for(dependency)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">dependencies_for</span>(specification)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>        with_no_such_dependency_error_handling <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>          specification_provider<span style="color:#719e07">.</span>dependencies_for(specification)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>      <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>      <span style="color:#719e07">private</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">with_no_such_dependency_error_handling</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>        <span style="color:#719e07">yield</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>      <span style="color:#719e07">rescue</span> <span style="color:#cb4b16">NoSuchDependencyError</span> <span style="color:#719e07">=&gt;</span> error
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>        <span style="color:#719e07">if</span> state
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>          <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>        <span style="color:#719e07">raise</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>      <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span><span style="color:#719e07">end</span>
</code></pre></div><h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>æœ¬ç¯‡æ–‡ç« ä»ä¾èµ–è§£æçš„çŠ¶æ€ç»´æŠ¤ã€çŠ¶æ€å­˜å‚¨ã€çŠ¶æ€å›æº¯ä¸‰ä¸ªç»´åº¦æ¥è§£æ„ Molinillo çš„æ ¸å¿ƒé€»è¾‘ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”äº† ResolutionStateã€DependencyGraphã€UnwindDetail è¿™ä¸‰ç§æ•°æ®ç»“æ„ã€‚ä¸€å¼€å§‹å†™è¿™ç¯‡å†…å®¹æ—¶ï¼Œå¤´è„‘ä¸­å¯¹äºè¿™äº›æ¦‚å¿µæ˜¯æœªçŸ¥çš„ï¼Œå› ä¸ºä¸€å¼€å§‹å°±ç›´æ¥çœ‹äº†ä½œè€…å¯¹ <a href="https://github.com/CocoaPods/Molinillo/blob/master/ARCHITECTURE.md">Molinillo çš„æ¶æ„é˜è¿°</a>æ›´æ˜¯å®Œå…¨æ‰¾ä¸åˆ°æ€ç»ªï¼Œå¥½åœ¨æˆ‘æœ‰ VSCode ï¼ï¼ï¼æœ€ç»ˆä¾æ®ä¸åŒ Case ä¸‹çš„æ•°æ®å‘ˆç°ï¼Œä¸€ç‚¹ç‚¹çš„è¿›è¡Œæºç è°ƒè¯•ï¼Œå¤§è‡´æ‘¸æ¸…çš„ Molinillo çš„çŠ¶æ€æ˜¯å¦‚ä½•å˜åŒ–è½¬ç§»çš„ã€‚æœ€åä¸€ç‚¹ï¼Œè‹±æ–‡å’Œæ•°æ®ç»“æ„è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œpossiblity ä½ ç†è§£äº†å— ï¼Ÿ</p>
<h1 id="çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†">çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†</h1>
<p>è¿™é‡Œç½—åˆ—äº†äº”ä¸ªé—®é¢˜ç”¨æ¥è€ƒå¯Ÿä½ æ˜¯å¦å·²ç»æŒæ¡äº†è¿™ç¯‡æ–‡ç« ï¼Œå¦‚æœæ²¡æœ‰å»ºè®®ä½ åŠ å…¥<strong>æ”¶è—</strong>å†æ¬¡é˜…è¯»ï¼š</p>
<ol>
<li>è¯´è¯´ Resolution æ ˆä¸­çš„ state æ˜¯å¦‚ä½•è½¬ç§»çš„ ï¼Ÿ</li>
<li>DependencyGraph çš„æ•°æ®é€šè¿‡ä»€ä¹ˆæ–¹å¼è¿›è¡Œå›æ’¤çš„ ï¼Ÿ</li>
<li><code>#process_topmost_state</code> å¤„ç†äº†å‡ ç§ conflict æƒ…å†µ ï¼Ÿ</li>
<li>UnwindDetail çš„ state_index æ˜¯å¦‚ä½•è·å–çš„ ï¼Ÿ</li>
<li>ä½œè€…å¦‚ä½•åˆ©ç”¨ SpecificationProvider æ¥è§£å¶çš„ ï¼Ÿ</li>
</ol>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/cocoapods">CocoaPods</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/ruby">Ruby</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/"><span>â†</span><span>8. Xcode å·¥ç¨‹æ–‡ä»¶è§£æ</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/snowball/snowball-widgets/"><span>é›ªçƒ iOS Widget ä»é›¶åˆ°å£¹</span><span>â†’</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugoï¸ï¸</a>ï¸</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
