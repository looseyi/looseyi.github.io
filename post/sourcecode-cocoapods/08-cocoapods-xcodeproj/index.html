<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>8. Xcode 工程文件解析 - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="土土Edmond木" /><meta name="description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.82.1 with theme even" />


<link rel="canonical" href="http://looseyi.github.io/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/index.xml" rel="alternate" type="application/rss+xml" title="" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/index.xml" rel="feed" type="application/rss+xml" title="" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="8. Xcode 工程文件解析" />
<meta property="og:description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://looseyi.github.io/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-16T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-05-16T00:00:00&#43;00:00" />

<meta itemprop="name" content="8. Xcode 工程文件解析">
<meta itemprop="description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文"><meta itemprop="datePublished" content="2021-05-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-05-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6857">
<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="8. Xcode 工程文件解析"/>
<meta name="twitter:description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Aha Moment</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Aha Moment</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">8. Xcode 工程文件解析</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-05-16 </span>
        <div class="post-category">
            <a href="/categories/ios/"> iOS </a>
            <a href="/categories/cocoapods/"> CocoaPods </a>
            </div>
          <span class="more-meta"> 约 6857 字 </span>
          <span class="more-meta"> 预计阅读 14 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#xcworkspace">xcworkspace</a></li>
    <li><a href="#xcodeproj">xcodeproj</a>
      <ul>
        <li><a href="#property-list">Property List</a></li>
        <li><a href="#projectpbxproj">project.pbxproj</a></li>
        <li><a href="#xcode-object-identifiers">Xcode Object Identifiers</a></li>
        <li><a href="#xcode-object">Xcode Object</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#project-解析">Project 解析</a></li>
    <li><a href="#object-module">Object Module</a>
      <ul>
        <li><a href="#abstractobject">AbstractObject</a></li>
        <li><a href="#const-accessor">Const Accessor</a></li>
      </ul>
    </li>
    <li><a href="#object-attributes">Object Attributes</a>
      <ul>
        <li><a href="#abstractobjectattribute">AbstractObjectAttribute</a></li>
        <li><a href="#attribute">Attribute</a></li>
      </ul>
    </li>
    <li><a href="#xcode-object-1">Xcode Object</a>
      <ul>
        <li><a href="#pbxfilereference">PBXFileReference</a></li>
        <li><a href="#pbxgroup">PBXGroup</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#为-xcode-工程添加文件">为 Xcode 工程添加文件</a>
      <ul>
        <li><a href="#0x01-添加源文件">0x01 添加源文件</a></li>
        <li><a href="#0x02-添加编译依赖">0x02 添加编译依赖</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/10-xcode-project-src.png" alt="10-xcode-project-src"></p>
<h1 id="引子">引子</h1>
<p>在「<a href="https://zhuanlan.zhihu.com/p/355415807"><strong>Molinillo 依赖校验</strong></a>」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文重点就来聊聊 Xcode Project 的内容构成，以及 <a href="https://github.com/CocoaPods/Xcodeproj">xcodeproj</a> 是如果组织 Xcode Project 内容的。</p>
<h1 id="xcode-工程文件">Xcode 工程文件</h1>
<p>早在前文「<a href="https://zhuanlan.zhihu.com/p/248308670"><strong>Podfile 的解析逻辑</strong></a>」中，我们简单介绍过 <strong>Xcode 的工程结构：Workspace、Project、Target 及 Build Setting</strong> 等。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/00-xcode-project-struct.png" alt="04-workspace"></p>
<p>我们先来了解下这些数据在 Xcode 中是如何表示，了解这些结构才能方便我们理解 xcodeproj 的代码设计思路。</p>
<h2 id="xcworkspace">xcworkspace</h2>
<p>早在 Xcode 4 之前就出现 workspace bundle 了，只是那会 workspace 仍内嵌于 <code>.xcodeproj</code> 中。Xcode 4 之后，我们才对 workspace 单独可见。让我们新建一个 Test.xcodeproj 项目，来看看其目录结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">Test.xcodeproj
├── project.pbxproj
├── project.xcworkspace
│   ├── contents.xcworkspacedata
│   └── xcuserdata
│       └── edmond.xcuserdatad
│           └── UserInterfaceState.xcuserstate
└── xcuserdata
    └── edmond.xcuserdatad
        └── xcschemes
            └── xcschememanagement.plist
</code></pre></td></tr></table>
</div>
</div><p>可以发现 <code>Test.xcodeproj</code> bundle 内包含 <code>project.workspace</code>。而当我们通过 <code>pod install</code> 命令成功添加 Pod 依赖后，Xcode 工程目录下会多出 <code>Test.workspace</code>，它是 Xcodeproj 替我们生成的，用于管理当前的 <code>Test.project</code> 与 <code>Pods.pbxproj</code>。新建的 workspace 目录如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">Test.xcworkspace
└── contents.xcworkspacedata
</code></pre></td></tr></table>
</div>
</div><p>生成的 workspace 文件夹内部只包含了 <code>contents.xcworkspacedata</code>，为 xml 格式的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;Workspace</span>
   <span class="na">version =</span> <span class="s">&#34;1.0&#34;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;FileRef</span>
      <span class="na">location =</span> <span class="s">&#34;group:Test.xcodeproj&#34;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;/FileRef&gt;</span>
   <span class="nt">&lt;FileRef</span>
      <span class="na">location =</span> <span class="s">&#34;group:Pods/Pods.xcodeproj&#34;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;/FileRef&gt;</span>
<span class="nt">&lt;/Workspace&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>在标签 Workspace 下声明了两个 <code>FileRef</code> 其地址分别指向了 <code>Test.xcodeproj</code> 和 <code>Pods.xcodeproj</code>。这里注意的是 <code>FileRef</code> 属性的值使用前缀 <code>group + path</code> 来修饰的，而内嵌的 <code>project.xcworkspace</code>，使用 <code>self</code> 作为前缀：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;Workspace</span>
   <span class="na">version =</span> <span class="s">&#34;1.0&#34;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;FileRef</span>
      <span class="na">location =</span> <span class="s">&#34;self:&#34;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;/FileRef&gt;</span>
<span class="nt">&lt;/Workspace&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>另外，当我们用 Xcode 打开项目后，能发现 workspace 目录下会自动生成 <code>xcuserdata</code> 目录，它用于保存用户的 Xcode 配置。比如：</p>
<ul>
<li><code>UserInterfaceState.xcuserstate</code>：以二进制的 Plist 保存，用于记录窗口布局等个性化设置。</li>
<li><code>xcdebugger</code>：记录各种断点数据。</li>
</ul>
<p>这也是在日常开发中，经常会选择将 <code>xcuserdata</code> 目录 ignore 掉的原因。</p>
<h2 id="xcodeproj">xcodeproj</h2>
<p>与 <code>.xcworkspace</code> 类似 <code>.xcodeproj</code> 同为 Xcode 工程配置的 bundle，接下来重点展开 <code>project.pbxproj</code>，它记录了 Xcode 工程的各项配置，本质上是一种旧风格的 Plist 文件。</p>
<h3 id="property-list">Property List</h3>
<p>Plist 被设计为人类可读的、可以手工修改的格式，故采用了类似于编程语言的语法将数据序列化为ASCII数据。Plist 最早可追溯到 NeXTSTEP 时期，由于历史原因，目前它支持多种格式，string、binary、array、dictionary 等类型数据。相比于 JSON，Plist 还支持二进制数据的表示，以 <code>&lt;&gt;</code> 修饰文本形式的十六进制数，其中字典与数组的区别如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">Array：</span>
<span class="err">plist</span> <span class="err">=&gt;</span> <span class="err">(</span> <span class="s2">&#34;1&#34;</span><span class="err">,</span> <span class="s2">&#34;2&#34;</span><span class="err">,</span> <span class="s2">&#34;3&#34;</span> <span class="err">)</span>
<span class="err">json</span> <span class="err">=&gt;</span> <span class="p">[</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span> <span class="p">]</span>

<span class="err">Dictionary：</span>
<span class="err">plist</span> <span class="err">=&gt;</span> <span class="p">{</span> <span class="nt">&#34;key&#34;</span> <span class="err">=</span> <span class="s2">&#34;value&#34;</span><span class="err">;</span> <span class="err">...</span> <span class="p">}</span>
<span class="err">json</span> <span class="err">=&gt;</span> <span class="p">{</span> <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;value&#34;</span><span class="p">,</span> <span class="err">...</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>处理 Plist 文件可使用 Unix 提供的 <code>plutil</code> 工具。 比如将 Plist 文件转成 XML 格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">plutil -convert xml1 -s -r -o project.pbxproj.xml project.pbxproj
</code></pre></td></tr></table>
</div>
</div><p><code>-convert fmt</code> 选项支持转换的格式有：xml1、binary1、json、swift、json。</p>
<h3 id="projectpbxproj">project.pbxproj</h3>
<p><strong>pbxproj 文件全称为 Project Builder Xcode Project</strong>，光看第一层元数据比较简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">!$*UTF</span><span class="mi">8</span><span class="err">*$!</span>
<span class="p">{</span>
	<span class="err">archiveVersion</span> <span class="err">=</span> <span class="err">1;</span>
	<span class="err">classes</span> <span class="err">=</span> <span class="err">{</span>
	<span class="p">}</span><span class="err">;</span>
	<span class="err">objectVersion</span> <span class="err">=</span> <span class="mi">50</span><span class="err">;</span>
	<span class="err">objects</span> <span class="err">=</span> <span class="p">{</span>
		<span class="err">...</span>
   <span class="p">}</span><span class="err">;</span>
	<span class="err">rootObject</span> <span class="err">=</span> <span class="mi">8528</span><span class="err">A</span><span class="mi">0</span><span class="err">D</span><span class="mi">92651</span><span class="err">F</span><span class="mi">281005</span><span class="err">BEBA</span><span class="mi">5</span> <span class="err">/*</span> <span class="err">Project</span> <span class="err">object</span> <span class="err">*/;</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>文件以明确的编码信息开头，<code>archiveVersion</code> 通常为 1，表示序列化的版本号；<code>classes</code> 则似乎一直为空；<code>objectVersion</code> 表示所兼容的最低版本的 Xcode，该数字与 Xcode 的版本对应关系如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="mi">53</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 11.4&#39;</span><span class="p">,</span>
<span class="mi">52</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 11.0&#39;</span><span class="p">,</span>
<span class="mi">51</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 10.0&#39;</span><span class="p">,</span>
<span class="mi">50</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 9.3&#39;</span><span class="p">,</span>
<span class="mi">48</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 8.0&#39;</span><span class="p">,</span>
<span class="mi">47</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 6.3&#39;</span><span class="p">,</span>
<span class="mi">46</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 3.2&#39;</span><span class="p">,</span>
<span class="mi">45</span> <span class="o">=&gt;</span> <span class="s1">&#39;Xcode 3.1&#39;</span><span class="p">,</span>
</code></pre></td></tr></table>
</div>
</div><p><code>rootObject</code> 记录的 16 进制数字，为 project 对象的索引。这里我们可以称其为 Xcode Object Identifier，pbxproj 中的每个 Xcode Object 创建时，都会生成对应唯一标识数字，而上面的 <code>objects</code> 字典则记录了整个 Xcode 项目的所有 Xcode Object。</p>
<h3 id="xcode-object-identifiers">Xcode Object Identifiers</h3>
<p>Xcode Object Identifier 是用 24 位的 16 进制字符表示，我们暂且称其为 GUID。</p>
<blockquote>
<p>⚠️ 注意这并不意味着它与其他称为 GUID 的其他事物相似。</p>
</blockquote>
<p>生成的 GUID 不仅在项目文件中必须唯一，并且在 Xcode 中同时打开的其他项目文件中也必须唯一，即<strong>跨工程唯一性</strong>。只有这样能避免了多人合作中，同时新增或编辑工程文件带来的问题。这其实是一个有趣的竞争需求，有兴趣的可以查看 <a href="https://github.com/premake/premake-core">Premake</a> 这个项目，它能保证重新生成的项目具有相同的 GUID。</p>
<p>对于 Xcode 使用的 GUID 算法可参考 <a href="https://pewpewthespells.com/blog/pbxproj_identifiers.html">PBXProj Identifers</a>，它是通过逆向 <code>DevToolsCore.framework</code> 获取的，从中可以窥见 GUID 的生成需要依赖 👇 这些数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">globalidentifier</span> <span class="p">{</span>
    <span class="n">int8_t</span> <span class="n">user</span><span class="p">;</span>            <span class="c1">// encoded username
</span><span class="c1"></span>    <span class="n">int8_t</span> <span class="n">pid</span><span class="p">;</span>             <span class="c1">// encoded current pid #
</span><span class="c1"></span>    <span class="n">int16_t</span> <span class="n">_random</span><span class="p">;</span>        <span class="c1">// encoded random value
</span><span class="c1"></span>    <span class="n">int32_t</span> <span class="n">_time</span><span class="p">;</span>          <span class="c1">// encoded time value
</span><span class="c1"></span>    <span class="n">int8_t</span> <span class="n">zero</span><span class="p">;</span>            <span class="c1">// zero
</span><span class="c1"></span>    <span class="n">int8_t</span> <span class="n">host_shift</span><span class="p">;</span>      <span class="c1">// encoded, shifted hostid
</span><span class="c1"></span>    <span class="n">int8_t</span> <span class="n">host_h</span><span class="p">;</span>          <span class="c1">// high byte of lower bytes of hostid
</span><span class="c1"></span>    <span class="n">int8_t</span> <span class="n">host_l</span><span class="p">;</span>          <span class="c1">// low byte of lower bytes of hostid
</span><span class="c1"></span><span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>  <span class="c1">// packed, so we always have a length of 12 bytes
</span></code></pre></td></tr></table>
</div>
</div><h3 id="xcode-object">Xcode Object</h3>
<p>Xcode Object 是指所有记录在 <code>objects</code> 字典中的对象 (后续简称为 Object)，内部以 <code>isa</code> 来标识类型。同时Xcode 按 <code>isa</code> 类型划分出若干 section，以注释的方式分节。</p>
<p>以 <code>PBXProject</code> 为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">/*</span> <span class="err">Begin</span> <span class="err">PBXProject</span> <span class="err">section</span> <span class="err">*/</span>
   <span class="mi">8528</span><span class="err">A</span><span class="mi">0</span><span class="err">D</span><span class="mi">92651</span><span class="err">F</span><span class="mi">281005</span><span class="err">BEBA</span><span class="mi">5</span> <span class="err">/*</span> <span class="err">Project</span> <span class="err">object</span> <span class="err">*/</span> <span class="err">=</span> <span class="p">{</span>
      <span class="err">isa</span> <span class="err">=</span> <span class="err">PBXProject;</span>
      <span class="err">...</span>
      <span class="err">mainGroup</span> <span class="err">=</span> <span class="err">8528A0D82651F281005BEBA5;</span>
      <span class="err">productRefGroup</span> <span class="err">=</span> <span class="err">8528A0E22651F281005BEBA5</span> <span class="err">/*</span> <span class="err">Products</span> <span class="err">*/;</span>
      <span class="err">projectDirPath</span> <span class="err">=</span> <span class="nt">&#34;&#34;</span><span class="err">;</span>
      <span class="err">projectRoot</span> <span class="err">=</span> <span class="s2">&#34;&#34;</span><span class="err">;</span>
      <span class="err">targets</span> <span class="err">=</span> <span class="err">(</span> 
         <span class="mi">8528</span><span class="err">A</span><span class="mf">0E02651</span><span class="err">F</span><span class="mi">281005</span><span class="err">BEBA</span><span class="mi">5</span> <span class="err">/*</span> <span class="err">Test</span> <span class="err">*/</span><span class="p">,</span>
      <span class="err">);</span>
   <span class="p">}</span><span class="err">;</span>
<span class="err">/*</span> <span class="err">End</span> <span class="err">PBXProject</span> <span class="err">section</span> <span class="err">*/</span>
</code></pre></td></tr></table>
</div>
</div><p>这里 <code>Project object</code> 的索引值正是 <code>rootObject</code> 记录的 <em>8528A0D92651F281005BEBA5</em>，其 <code>isa</code> 类型为 <code>PBXProject</code>，<code>targets</code> 数组记录了项目需要构建的任务：<code>Test target</code>。整个 PBXProject section 就定义在 <code>objects</code> 中。</p>
<p>Object 类型的引用关系大致如下图：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/00-xcodte-project.png" alt="00-xcodte-project"></p>
<blockquote>
<p>关于 pbxproj 内 Object 的详细说明，可参照 <a href="http://www.monobjc.net/xcode-project-file-format.html">Xcode Project File Format</a>。</p>
</blockquote>
<ul>
<li>PBXProject：Project 的设置，编译工程所需信息</li>
<li>PBXNativeTarget：Target 的设置</li>
<li>PBXTargetDependency： Target 依赖</li>
<li>PBXContainerItemProxy：部署的元素</li>
<li>XCConfigurationList：构建配置相关，包含 project 和 target 文件</li>
<li>XCBuildConfiguration：编译配置，对应 Xcode 的 Build Setting 内容</li>
<li>PBXVariantGroup：国际化对照表或 <code>.storyboard</code> 文件</li>
<li>PBXBuildFile：各类文件，最终会关联到 PBXFileReference</li>
<li>PBXFileReference：源码、资源、库，Info.plist 等文件索引</li>
<li>PBXGroup：虚拟文件夹，可嵌套，记录管理的 PBXFileReference 与子 PBXGroup</li>
<li>PBXSourcesBuildPhase：编译源文件（.m、.swift）</li>
<li>PBXFrameworksBuildPhase：用于 framework 的构建</li>
<li>PBXResourcesBuildPhase：编译资源文件，有 xib、storyboard、plist 以及 xcassets 等资源文件</li>
</ul>
<h1 id="xcodeproj-1">Xcodeproj</h1>
<p><a href="https://github.com/CocoaPods/Xcodeproj">Xcodeproj</a> 能够通过 Ruby 来创建和修改 Xcode 工程文件，其内部完整映射了 <code>project.pbxproj</code> 的 Object 类型及其对应的属性，限于篇幅本文会重点介绍关键的 Object 和解析逻辑。</p>
<h2 id="project-解析">Project 解析</h2>
<p>上节内容可知，Xcode 解析工程的是依次检查 <code>*.xcworkspace</code> &gt; <code>*.xcproject</code> &gt; <code>project.pbxproj</code>，根据 <code>project.pbxproj</code> 的数据结构，Xcodeproj 提供了 Project 类，用于记录根元素。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Xcodeproj</span>
  <span class="k">class</span> <span class="nc">Project</span>
    <span class="c1"># object 模块，后面会提到</span>
    <span class="kp">include</span> <span class="no">Object</span>	
    <span class="o">...</span>
    <span class="c1"># 序列化时 project 的最低兼容版本, 与 object_version 对应</span>
    <span class="kp">attr_reader</span> <span class="ss">:archive_version</span>
    <span class="c1"># 作用未知</span>
    <span class="kp">attr_reader</span> <span class="ss">:classes</span>
    <span class="c1"># project 最低兼容版本</span>
    <span class="kp">attr_reader</span> <span class="ss">:object_version</span>
    <span class="c1"># project 所包含的 objects，结构为 [Hash{String =&gt; AbstractObject}]</span>
    <span class="kp">attr_reader</span> <span class="ss">:objects_by_uuid</span>
    <span class="c1"># project 的根结点，即 PBXProject</span>
    <span class="kp">attr_reader</span> <span class="ss">:root_object</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>pod install</code> 的依赖解析阶段，会读取 <code>project.pbxproj</code>。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/01-resolve-dependencies.png" alt="01-resolve-dependencies"></p>
<p>最终在 <code>inspect_targets_to_integrate</code> 方法内打开项目：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">inspect_targets_to_integrate</span>
  <span class="n">project</span> <span class="o">=</span> <span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Project</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>继续看 <code>Xcodeproj::Project::open</code> 实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/xcproject/Project.rb</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">path</span> <span class="o">=</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">pwd</span> <span class="o">+</span> <span class="n">path</span>
  <span class="k">unless</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exist?</span>
    <span class="k">raise</span> <span class="s2">&#34;[Xcodeproj] Unable to open `</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">` because it doesn&#39;t exist.&#34;</span>
  <span class="k">end</span>
  <span class="n">project</span> <span class="o">=</span> <span class="kp">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">project</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:initialize_from_file</span><span class="p">)</span>
  <span class="n">project</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">initialize_from_file</span>
  <span class="n">pbxproj_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;project.pbxproj&#39;</span>
  <span class="n">plist</span> <span class="o">=</span> <span class="no">Plist</span><span class="o">.</span><span class="n">read_from_path</span><span class="p">(</span><span class="n">pbxproj_path</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="n">root_object</span><span class="o">.</span><span class="n">remove_referrer</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">root_object</span>
  <span class="vi">@root_object</span>     <span class="o">=</span> <span class="n">new_from_plist</span><span class="p">(</span><span class="n">plist</span><span class="o">[</span><span class="s1">&#39;rootObject&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">plist</span><span class="o">[</span><span class="s1">&#39;objects&#39;</span><span class="o">]</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
  <span class="vi">@archive_version</span> <span class="o">=</span> <span class="n">plist</span><span class="o">[</span><span class="s1">&#39;archiveVersion&#39;</span><span class="o">]</span>
  <span class="vi">@object_version</span>  <span class="o">=</span> <span class="n">plist</span><span class="o">[</span><span class="s1">&#39;objectVersion&#39;</span><span class="o">]</span>
  <span class="vi">@classes</span>         <span class="o">=</span> <span class="n">plist</span><span class="o">[</span><span class="s1">&#39;classes&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="p">{}</span>
  <span class="vi">@dirty</span>           <span class="o">=</span> <span class="kp">false</span>

  <span class="k">unless</span> <span class="n">root_object</span>
    <span class="k">raise</span> <span class="s2">&#34;[Xcodeproj] Unable to find a root object in </span><span class="si">#{</span><span class="n">pbxproj_path</span><span class="si">}</span><span class="s2">.&#34;</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">archive_version</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="no">Constants</span><span class="o">::</span><span class="no">LAST_KNOWN_ARCHIVE_VERSION</span>
    <span class="k">raise</span> <span class="s1">&#39;[Xcodeproj] Unknown archive version.&#39;</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">object_version</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="no">Constants</span><span class="o">::</span><span class="no">LAST_KNOWN_OBJECT_VERSION</span>
    <span class="k">raise</span> <span class="s1">&#39;[Xcodeproj] Unknown object version.&#39;</span>
  <span class="k">end</span>

  <span class="c1"># Projects can have product_ref_groups that are not listed in the main_groups[&#34;Products&#34;]</span>
  <span class="n">root_object</span><span class="o">.</span><span class="n">product_ref_group</span> <span class="o">||=</span> <span class="n">root_object</span><span class="o">.</span><span class="n">main_group</span><span class="o">[</span><span class="s1">&#39;Products&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="n">root_object</span><span class="o">.</span><span class="n">main_group</span><span class="o">.</span><span class="n">new_group</span><span class="p">(</span><span class="s1">&#39;Products&#39;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>在 open 方法中会检验路径，初始化 Project 对象;</li>
<li>使用内部 Property List 类 <code>Plist</code> 来读取 <code>project.pbxproj</code> 数据;</li>
</ol>
<p>需要注意的是 <code>new_from_plist</code> 不仅完成了 rootObject 的解析，同时也完成 objects 的解析。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">new_from_plist</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">objects_by_uuid_plist</span><span class="p">,</span> <span class="n">root_object</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
  <span class="n">attributes</span> <span class="o">=</span> <span class="n">objects_by_uuid_plist</span><span class="o">[</span><span class="n">uuid</span><span class="o">]</span>
  <span class="k">if</span> <span class="n">attributes</span>
    <span class="c1"># 以 isa 获取 Xcodeproj 中对应的 Xcode Object 类型</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;isa&#39;</span><span class="o">]</span><span class="p">)</span>
    <span class="n">object</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
    <span class="n">objects_by_uuid</span><span class="o">[</span><span class="n">uuid</span><span class="o">]</span> <span class="o">=</span> <span class="n">object</span>
    <span class="n">object</span><span class="o">.</span><span class="n">add_referrer</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">root_object</span>
    <span class="c1"># 解析 objects 节点，并完成 ISA 数据到 Xcode Object 的映射</span>
    <span class="n">object</span><span class="o">.</span><span class="n">configure_with_plist</span><span class="p">(</span><span class="n">objects_by_uuid_plist</span><span class="p">)</span>
    <span class="n">object</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>以 uuid 取出 Plist 数据并利用 isa kclass 完成 Project 对象的初始化和映射。<code>Object const</code> 中记录了支持的 <code>isa</code>；</li>
<li>将 object 存入 objects_by_uuid 字典中，以覆盖原有的 GUID；</li>
<li>执行 <code>configure_with_plist</code> 递归，完成 <code>objects</code> 映射。</li>
</ol>
<blockquote>
<p>Tips: <code>configure_with_plist</code> 于下篇展开.</p>
</blockquote>
<p><code>project.pbxproj</code> 解析主体流程如下</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/02-parse-project.png" alt="02-parse-project"></p>
<p>图中的 reference attributes 是指 Object 的引用属性，后面会有介绍。</p>
<h2 id="object-module">Object Module</h2>
<h3 id="abstractobject">AbstractObject</h3>
<p>Object 的抽象类，Xcode 项目并不存在对应的 <code>isa</code> 类型。先简单介绍部分属性，方便后续理解。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AbstractObject</span>
  <span class="c1"># object 类型</span>
  <span class="kp">attr_reader</span> <span class="ss">:isa</span>
  <span class="c1"># object 唯一标识</span>
  <span class="kp">attr_reader</span> <span class="ss">:uuid</span>
  <span class="c1"># 持有 object 的 project</span>
  <span class="kp">attr_reader</span> <span class="ss">:project</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">uuid</span><span class="p">)</span>
    <span class="vi">@project</span> <span class="o">=</span> <span class="n">project</span>
    <span class="vi">@uuid</span> <span class="o">=</span> <span class="n">uuid</span>
    <span class="vi">@isa</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">isa</span>
    <span class="vi">@referrers</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="k">unless</span> <span class="vi">@isa</span> <span class="o">=~</span> <span class="sr">/^(PBX|XC)/</span>
      <span class="k">raise</span> <span class="s2">&#34;[Xcodeproj] Attempt to initialize an abstract class (</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">).&#34;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>注意，Object 类在 initialize 时关联了 project 对象，作者不建议我们直接使用，而在 Xcodeproj 模块内提供了 convince 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span>
     <span class="n">klass</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
   <span class="k">end</span>
   <span class="n">object</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">generate_uuid</span><span class="p">)</span>
   <span class="n">object</span><span class="o">.</span><span class="n">initialize_defaults</span>
   <span class="n">object</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>作者保留 project 的引用是为了方便处理 Object 的引用计数，project 作为项目的根节点，记录了完整的工程配置和各模块的交叉引用关系，有了 project 的引用能给进行 object 的引用管理。</p>
<h3 id="const-accessor">Const Accessor</h3>
<p>这里先插播一下 Object 模块中 <code>const</code> 定义及其存储的值。在 Ruby 中 Module 可以在运行时添加模块级的常量，方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Module</span><span class="c1">#const_get</span>
<span class="no">Module</span><span class="c1">#const_set</span>
</code></pre></td></tr></table>
</div>
</div><p>那么问题来了，这些 const 常量是在什么时机存入 Object 中的呢 ？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/xcodeproj/project/object.rb</span>

<span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Constants</span><span class="o">::</span><span class="no">KNOWN_ISAS</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">superclass_name</span><span class="p">,</span> <span class="n">isas</span><span class="o">|</span>
  <span class="n">superklass</span> <span class="o">=</span> <span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Project</span><span class="o">::</span><span class="no">Object</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">superclass_name</span><span class="p">)</span>
  <span class="n">isas</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">isa</span><span class="o">|</span>
    <span class="n">c</span> <span class="o">=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">superklass</span><span class="p">)</span>
    <span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Project</span><span class="o">::</span><span class="no">Object</span><span class="o">.</span><span class="n">const_set</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>在 object.rb 文件中，可以定位到 <code>Object.const_set</code> 的调用，它是在 Object 类被加载时触发的。Xcodeproj 支持的 <code>isa</code> 类型名称都定义在 <code>Xcodeproj::Constants::KNOWN_ISAS</code> 中。Object 加载时通过遍历它来载入 <code>isa class</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">KNOWN_ISAS</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;AbstractObject&#39;</span> <span class="o">=&gt;</span> <span class="sx">%w(
</span><span class="sx">    PBXBuildFile
</span><span class="sx">    AbstractBuildPhase
</span><span class="sx">    PBXBuildRule
</span><span class="sx">    XCBuildConfiguration
</span><span class="sx">    XCConfigurationList
</span><span class="sx">    PBXContainerItemProxy
</span><span class="sx">    PBXFileReference
</span><span class="sx">    PBXGroup
</span><span class="sx">    PBXProject
</span><span class="sx">    PBXTargetDependency
</span><span class="sx">    PBXReferenceProxy
</span><span class="sx">    AbstractTarget
</span><span class="sx">  )</span><span class="p">,</span>

  <span class="s1">&#39;AbstractBuildPhase&#39;</span> <span class="o">=&gt;</span> <span class="sx">%w(
</span><span class="sx">    PBXCopyFilesBuildPhase
</span><span class="sx">    PBXResourcesBuildPhase
</span><span class="sx">    PBXSourcesBuildPhase
</span><span class="sx">    PBXFrameworksBuildPhase
</span><span class="sx">    PBXHeadersBuildPhase
</span><span class="sx">    PBXShellScriptBuildPhase
</span><span class="sx">  )</span><span class="p">,</span>

  <span class="s1">&#39;AbstractTarget&#39;</span> <span class="o">=&gt;</span> <span class="sx">%w(
</span><span class="sx">    PBXNativeTarget
</span><span class="sx">    PBXAggregateTarget
</span><span class="sx">    PBXLegacyTarget
</span><span class="sx">  )</span><span class="p">,</span>

  <span class="s1">&#39;PBXGroup&#39;</span> <span class="o">=&gt;</span> <span class="sx">%w(
</span><span class="sx">    XCVersionGroup
</span><span class="sx">    PBXVariantGroup
</span><span class="sx">  )</span><span class="p">,</span>
<span class="p">}</span><span class="o">.</span><span class="n">freeze</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="object-attributes">Object Attributes</h2>
<p><code>AbstractObject</code> 作为 <code>Xcodeproj</code> 提供的 Object 基类，它不仅提供了基本属性，如 <code>isa</code> 类型和 uuid 等，还提供了特殊的属性修饰器如 <code>Attribute</code>，方便快速添加属性。光从 <code>KNOWN_ISAS</code> 看来这些 <code>isa</code> 类型就已经够多了，还要考虑属性的 CURD 以及数据到对象映射等一系列操作。</p>
<p>为此，<strong>Xcodeproj 实现了一套针对 <code>project.pbxproj</code> 的 DSL 解析</strong>。这些特性的实现正是依赖于属性修饰器和 Ruby 强大的 Runtime 能力。</p>
<h3 id="abstractobjectattribute">AbstractObjectAttribute</h3>
<p><code>AbstractObjectAttribute</code> 是用于声明和存储 Object 属性的关键信息，定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AbstractObjectAttribute</span>
   
  <span class="c1"># 属性本身类型，:simple, :to_one, :to_many.</span>
  <span class="kp">attr_reader</span> <span class="ss">:type</span>
   
  <span class="c1"># 属性名</span>
  <span class="kp">attr_reader</span> <span class="ss">:name</span>
   
  <span class="c1"># 属性的持有者</span>
  <span class="kp">attr_accessor</span> <span class="ss">:owner</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span>
    <span class="vi">@type</span>  <span class="o">=</span> <span class="n">type</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="nb">name</span>
    <span class="vi">@owner</span> <span class="o">=</span> <span class="n">owner</span>
  <span class="k">end</span>

  <span class="c1"># 属性支持的类型</span>
  <span class="kp">attr_accessor</span> <span class="ss">:classes</span>
   
  <span class="c1"># 仅限于 :references_by_keys 关联的类型</span>
  <span class="kp">attr_accessor</span> <span class="ss">:classes_by_key</span>
   
  <span class="c1"># 仅限于 :simple 类型指定默认值</span>
  <span class="kp">attr_accessor</span> <span class="ss">:default_value</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><code>AbstractObject</code> 通过 Ruby 提供的 <code>Singleton Classes</code> 以实现属性修饰器方法的扩展。</p>
<p>对于单例模式，Ruby 提供了多种实现方式。在 Ruby 中，每个对象可以拥有一个匿名<strong>单例类</strong>。默认情况下，自定义类是不存在单例类，不过可通过 <code>class &lt;&lt; obj</code> 来打开对象的单例类空间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">C</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="nb">puts</span> <span class="nb">self</span>	<span class="c1"># 输出：#&lt;Class:C&gt;，类 C 类对象的单例类</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意：Ruby 中每个对象 (Class / Module 也是对象) 都有自己所属的类，它们都是有具体名称的类。</p>
</blockquote>
<p><code>Xcodeproj</code> 针对 Attribute 提供了多种单例类方法，定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Object</span>
  <span class="k">class</span> <span class="nc">AbstractObject</span>
    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="c1"># 普通属性声明方法</span>
      <span class="k">def</span> <span class="nf">attribute</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">default_value</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span> <span class="o">...</span> <span class="k">end</span>
       
      <span class="c1"># 单一引用的属性声明方法</span>
      <span class="k">def</span> <span class="nf">has_one</span><span class="p">(</span><span class="n">singular_name</span><span class="p">,</span> <span class="n">isas</span><span class="p">)</span> <span class="o">...</span> <span class="k">end</span>
       
      <span class="c1"># 多引用的属性声明方法</span>
      <span class="k">def</span> <span class="nf">has_many</span><span class="p">(</span><span class="n">plural_name</span><span class="p">,</span> <span class="n">isas</span><span class="p">)</span> <span class="o">...</span> <span class="k">end</span>
       
      <span class="c1"># 多引用且不同 key 的属性声明方法</span>
      <span class="k">def</span> <span class="nf">has_many_references_by_keys</span><span class="p">(</span><span class="n">plural_name</span><span class="p">,</span> <span class="n">classes_by_key</span><span class="p">)</span> <span class="o">...</span> <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>直接看如何使用，声明属性比较直观：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Object</span>
  <span class="k">class</span> <span class="nc">PBXProject</span> <span class="o">&lt;</span> <span class="no">AbstractObject</span>     
     
    <span class="c1"># 声明为 [String] 类型的 project_dir_path，默认值为空</span>
    <span class="n">attribute</span> <span class="ss">:project_dir_path</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    
    <span class="c1"># 声明为 [PBXGroup] 类型的 main_group</span>
    <span class="n">has_one</span> <span class="ss">:main_group</span><span class="p">,</span> <span class="no">PBXGroup</span>

    <span class="c1"># 声明为 [ObjectList&lt;AbstractTarget&gt;] 类型的 targets</span>
    <span class="n">has_many</span> <span class="ss">:targets</span><span class="p">,</span> <span class="no">AbstractTarget</span>
     
    <span class="c1"># 声明为 [Array&lt;ObjectDictionary&gt;] 类型的 project_references </span>
    <span class="n">has_many_references_by_keys</span> <span class="ss">:project_references</span><span class="p">,</span>
                                <span class="ss">:project_ref</span>   <span class="o">=&gt;</span> <span class="no">PBXFileReference</span><span class="p">,</span>
                                <span class="ss">:product_group</span> <span class="o">=&gt;</span> <span class="no">PBXGroup</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>所谓的单一或者多引用是指<strong>Object 之间引用关系</strong>。以 <code>PBXProject</code> 为例，一个项目只能指定一个 mainGroup，但对于 targets 可以存在多个。这里不直接使用 <code>attribute</code> 来修饰是因为，像 target 这种存在交叉引用的 Object 被删除时，我们需要知道谁引用了它，才保证所有的引用都能被清理干净。因此，<strong>Xcodeproj 实现了一套针对 Object 的引用计数管理</strong> (不在本文讨论范围)。</p>
<h3 id="attribute">Attribute</h3>
<p>今天先看普通属性的 DSL 实现，<code>has_one</code> 与 <code>has_many</code> 的属性修饰将在下篇展开。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/xcodeproj/project/object_attributes.rb</span>

<span class="k">def</span> <span class="nf">attribute</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">default_value</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="c1"># 1. 初始化 attribute，记录属性名，属性类型及默认值</span>
  <span class="n">attrb</span> <span class="o">=</span> <span class="no">AbstractObjectAttribute</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:simple</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
  <span class="n">attrb</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="o">[</span><span class="n">klass</span><span class="o">]</span>
  <span class="n">attrb</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">default_value</span>
  <span class="c1"># 2. 将 attrb 存入 @attributes</span>
  <span class="n">add_attribute</span><span class="p">(</span><span class="n">attrb</span><span class="p">)</span>
  
  <span class="c1"># 3. 添加名为 name 的 getter</span>
  <span class="n">define_method</span><span class="p">(</span><span class="n">attrb</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@simple_attributes_hash</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="vi">@simple_attributes_hash</span><span class="o">[</span><span class="n">attrb</span><span class="o">.</span><span class="n">plist_name</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="c1"># 4. 添加名为 #{name}= 的 setter，并将值存入 @simple_attributes_hash 字典中</span>
  <span class="n">define_method</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">#{</span><span class="n">attrb</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=&#34;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
    <span class="vi">@simple_attributes_hash</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="c1"># 5. 检查 value 是否为 klass 支持的类型</span>
    <span class="n">attrb</span><span class="o">.</span><span class="n">validate_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">existing</span> <span class="o">=</span> <span class="vi">@simple_attributes_hash</span><span class="o">[</span><span class="n">attrb</span><span class="o">.</span><span class="n">plist_name</span><span class="o">]</span>
    <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">keys</span> <span class="o">==</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span> <span class="o">&amp;&amp;</span> <span class="n">existing</span> <span class="o">==</span> <span class="n">value</span>
    <span class="k">elsif</span> <span class="n">existing</span> <span class="o">==</span> <span class="n">value</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">end</span>
    <span class="n">mark_project_as_dirty!</span>
    <span class="vi">@simple_attributes_hash</span><span class="o">[</span><span class="n">attrb</span><span class="o">.</span><span class="n">plist_name</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>代码比较长核心逻辑就 2 步：</p>
<ol>
<li>
<p>初始化 attribute，记录属性名，属性类型及默认值，将 attrb 存入对象的 <code>@attributes</code> 用于后续遍历；</p>
</li>
<li>
<p>利用 <code>define_method</code> 为修饰的对象添加实例变量存取方法。</p>
<p>由于修饰的属性类型不同，accessor 方法直接使用 Hash 容器来保存变量值，key 为 <code>attribute.name</code>，使用 Hash 是为了避免受到 Object 引用计数的影响。</p>
</li>
</ol>
<p>本质上 attribute 为我们生成的 accessor 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">project_dir_path</span>
  <span class="vi">@simple_attributes_hash</span><span class="o">[</span><span class="n">projectDirPath</span><span class="o">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">project_dir_path</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">attribute</span><span class="o">.</span><span class="n">validate_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="vi">@simple_attributes_hash</span><span class="o">[</span><span class="n">projectDirPath</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="xcode-object-1">Xcode Object</h2>
<p>最后我们来聊两个 <code>project.pbxproj</code> 中的基础 Object 类型：<code>PBXFileReference</code> 和 <code>PBXGroup</code>。放在文章末尾，是希望看到这里的同学能理解Xcode 设计的背后思想。</p>
<h3 id="pbxfilereference">PBXFileReference</h3>
<p><code>PBXFileReference</code> 记录了构建 Xcode 项目所需要的真实文件信息，<strong>主要记录了文件路径</strong>。这些 <code>PBXFileReference</code> 就是我们在 Xcode 项目的左侧边栏中所见的文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">F8DA09E31396AC040057D0CC</span> <span class="sr">/* main.m */</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">isa</span> <span class="o">=</span> <span class="no">PBXFileReference</span><span class="p">;</span> 
  <span class="n">fileEncoding</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">lastKnownFileType</span> <span class="o">=</span> <span class="n">sourcecode</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">objc</span><span class="p">;</span> 
  <span class="n">path</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">m</span><span class="p">;</span> 
  <span class="n">sourceTree</span> <span class="o">=</span> <span class="no">SOURCE_ROOT</span><span class="p">;</span> 
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>对于 <code>PBXFileReference</code> 路径，重点在于确认该 path 是相对路径还是绝对路径，<code>sourceTree</code> 就是用来描述这个的，它有几种相对关系：</p>
<ul>
<li>
<p><code>&lt;absolute&gt;</code>：绝对路径</p>
</li>
<li>
<p><code>&lt;group&gt;</code> 基于 PBXGroup 的相对路径</p>
</li>
<li>
<p><code>SOURCE_ROOT</code> 基于 project 的相对路径</p>
</li>
<li>
<p><code>DEVELOPER_DIR</code> 基于 developer directory 的相对路径</p>
</li>
<li>
<p><code>BUILT_PRODUCTS_DIR</code> 基于 build  products directory 的相对路径</p>
</li>
<li>
<p><code>SDKROOT</code> 基于 SDK directory 的相对路径</p>
</li>
</ul>
<p><code>Xcodeproj</code> 提供了 <code>GroupableHelper</code> 用于获取各种状态的文件目录，比如文件的绝对目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">source_tree_real_path</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">object</span><span class="o">.</span><span class="n">source_tree</span>
  <span class="k">when</span> <span class="s1">&#39;&lt;group&gt;&#39;</span>
    <span class="n">object_parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">object_parent</span><span class="o">.</span><span class="n">isa</span> <span class="o">==</span> <span class="s1">&#39;PBXProject&#39;</span><span class="o">.</span><span class="n">freeze</span>
      <span class="n">object</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_dir</span> <span class="o">+</span> <span class="n">object</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">root_object</span><span class="o">.</span><span class="n">project_dir_path</span>
    <span class="k">else</span>
      <span class="n">real_path</span><span class="p">(</span><span class="n">object_parent</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">when</span> <span class="s1">&#39;SOURCE_ROOT&#39;</span>
    <span class="n">object</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">project_dir</span>
  <span class="k">when</span> <span class="s1">&#39;&lt;absolute&gt;&#39;</span>
    <span class="kp">nil</span>
  <span class="k">else</span>
    <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&#34;${</span><span class="si">#{</span><span class="n">object</span><span class="o">.</span><span class="n">source_tree</span><span class="si">}</span><span class="s2">}&#34;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><code>PBXFileReference</code> 主要定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Object</span>
  <span class="k">class</span> <span class="nc">PBXFileReference</span> <span class="o">&lt;</span> <span class="no">AbstractObject</span>
    <span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
    <span class="n">attribute</span> <span class="ss">:path</span><span class="p">,</span> <span class="nb">String</span>
    <span class="n">attribute</span> <span class="ss">:source_tree</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="s1">&#39;SOURCE_ROOT&#39;</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pbxgroup">PBXGroup</h3>
<p>基于 <code>PBXFileReference</code> 之上的一层抽象，能更好的对 <code>PBXFileReference</code> 进行管理和分组。<code>PBXGroup</code> 背后并不一定真实存在对应的文件夹，另外 <code>PBXGroup</code> 可以引用其他 <code>PBXGroup</code>，进行嵌套。定义如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Object</span>
  <span class="k">class</span> <span class="nc">PBXGroup</span> <span class="o">&lt;</span> <span class="no">AbstractObject</span>
    <span class="c1"># group 可包含的类型</span>
    <span class="n">has_many</span> <span class="ss">:children</span><span class="p">,</span> <span class="o">[</span><span class="no">PBXGroup</span><span class="p">,</span> <span class="no">PBXFileReference</span><span class="p">,</span> <span class="no">PBXReferenceProxy</span><span class="o">]</span>
    <span class="n">attribute</span> <span class="ss">:source_tree</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="s1">&#39;&lt;group&gt;&#39;</span>
    <span class="c1"># 记录 group 在文件系统中的路径</span>
    <span class="n">attribute</span> <span class="ss">:path</span><span class="p">,</span> <span class="nb">String</span>
		<span class="c1"># 默认情况下，如果指定了路径，则此属性不存在。</span>
    <span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>它提供了一个便利的初始化方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">new_group</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">source_tree</span> <span class="o">=</span> <span class="ss">:group</span><span class="p">)</span>
  <span class="n">group</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">PBXGroup</span><span class="p">)</span>
  <span class="n">children</span> <span class="o">&lt;&lt;</span> <span class="n">group</span>
  <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="n">group</span><span class="o">.</span><span class="n">set_source_tree</span><span class="p">(</span><span class="n">source_tree</span><span class="p">)</span>
  <span class="n">group</span><span class="o">.</span><span class="n">set_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">group</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的 name 是必须传的，path 则可以为空。而我们在 Xcode 的导航栏中所见的各个分组名称和路径就是由这两个属性来决定的。没有 name 的情况下则是以 path 的 basename 作为 display_name 来呈现。</p>
<p>最后来看个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">F8E469631395739D00DB05C8</span> <span class="sr">/* Frameworks */</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">isa</span> <span class="o">=</span> <span class="no">PBXGroup</span><span class="p">;</span>
  <span class="n">children</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">50</span><span class="no">ABD6EC159FC2CE001BE42C</span> <span class="sr">/* MobileCoreServices.framework */</span><span class="p">,</span>
    <span class="o">...</span>
  <span class="p">);</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="no">Frameworks</span><span class="p">;</span>
  <span class="n">sourceTree</span> <span class="o">=</span> <span class="s2">&#34;&lt;group&gt;&#34;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>项目中并不存在真实的 <code>Framework</code> 文件夹，所以无需指定 path。另外注意，mainGroup 既没有 name 也没有 path，大家可以思考一下原因。</p>
<h1 id="通过代码编辑-xcode-工程">通过代码编辑 Xcode 工程</h1>
<p>最后一章，一起来实践一下简单的功能。</p>
<h2 id="为-xcode-工程添加文件">为 Xcode 工程添加文件</h2>
<h3 id="0x01-添加源文件">0x01 添加源文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">project</span> <span class="o">=</span> <span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Project</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">first</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">main_group</span><span class="o">.</span><span class="n">find_subpath</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Xcodeproj&#39;</span><span class="p">,</span> <span class="s1">&#39;Test&#39;</span><span class="p">),</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">set_source_tree</span><span class="p">(</span><span class="s1">&#39;SOURCE_ROOT&#39;</span><span class="p">)</span>
<span class="n">file_ref</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">new_reference</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">add_file_references</span><span class="p">(</span><span class="o">[</span><span class="n">file_ref</span><span class="o">]</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">save</span>
</code></pre></td></tr></table>
</div>
</div><p>给 Xcode 工程添加文件算是常规操作。这段代码引用自 <a href="https://draveness.me/bei-xcodeproj-keng-de-zhe-ji-tian/">draveness 的文章</a>，作者对每一步都做了详细的解释了。我们从代码角度重点说一下 <code>new_reference</code> 和 <code>add_file_references</code>。</p>
<p><strong>PBXGroup::new_references</strong></p>
<p>Xcode 工程会指定 main_group 作为项目资源的入口，所添加的文件资源需要先加入 main_group 内，以生成对应的 <code>PBXFileReference</code>，这样 target 任务和 buildPhase 等配置才能访问该资源。因此，<code>new_reference</code> 核心是 <code>new_file_reference</code> 代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">new_reference</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source_tree</span><span class="p">)</span>
  <span class="n">ref</span> <span class="o">=</span> <span class="k">case</span> <span class="no">File</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">downcase</span>
        <span class="k">when</span> <span class="s1">&#39;.xcdatamodeld&#39;</span>
          <span class="n">new_xcdatamodeld</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source_tree</span><span class="p">)</span>
        <span class="k">when</span> <span class="s1">&#39;.xcodeproj&#39;</span>
          <span class="n">new_subproject</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source_tree</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">new_file_reference</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source_tree</span><span class="p">)</span>
        <span class="k">end</span>

  <span class="n">configure_defaults_for_file_reference</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
  <span class="n">ref</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">new_file_reference</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source_tree</span><span class="p">)</span>
  <span class="n">path</span> <span class="o">=</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">ref</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">PBXFileReference</span><span class="p">)</span>
  <span class="n">group</span><span class="o">.</span><span class="n">children</span> <span class="o">&lt;&lt;</span> <span class="n">ref</span>
  <span class="no">GroupableHelper</span><span class="o">.</span><span class="n">set_path_with_source_tree</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source_tree</span><span class="p">)</span>
  <span class="n">ref</span><span class="o">.</span><span class="n">set_last_known_file_type</span>
  <span class="n">ref</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>PBXNativeTarget::add_file_references</strong></p>
<p>加入文件资源后，便可将其加入对应的构建任务中去。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">add_file_references</span><span class="p">(</span><span class="n">file_references</span><span class="p">,</span> <span class="n">compiler_flags</span> <span class="o">=</span> <span class="p">{})</span>
  <span class="n">file_references</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">downcase</span>
    <span class="n">header_extensions</span> <span class="o">=</span> <span class="no">Constants</span><span class="o">::</span><span class="no">HEADER_FILES_EXTENSIONS</span>
    <span class="c1"># 依据资源类型区分是头文件还是源文件 </span>
    <span class="n">is_header_phase</span> <span class="o">=</span> <span class="n">header_extensions</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">is_header_phase</span> <span class="p">?</span> <span class="n">headers_build_phase</span> <span class="p">:</span> <span class="n">source_build_phase</span>

    <span class="c1"># 将文件资源作为编译资源加入到编译源中</span>
    <span class="k">unless</span> <span class="n">build_file</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">build_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
      <span class="n">build_file</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">PBXBuildFile</span><span class="p">)</span>
      <span class="n">build_file</span><span class="o">.</span><span class="n">file_ref</span> <span class="o">=</span> <span class="n">file</span>
      <span class="n">phase</span><span class="o">.</span><span class="n">files</span> <span class="o">&lt;&lt;</span> <span class="n">build_file</span>
    <span class="k">end</span>
	 <span class="o">...</span>
    <span class="k">yield</span> <span class="n">build_file</span> <span class="k">if</span> <span class="nb">block_given?</span>

    <span class="n">build_file</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="0x02-添加编译依赖">0x02 添加编译依赖</h3>
<p>这里的编译依赖是指，依赖的 framework、library、bundle。不同于文件，他有均有对应的虚拟 group。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># 添加 framework 引用</span>
<span class="n">file_ref</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">frameworks_group</span><span class="o">.</span><span class="n">new_file</span><span class="p">(</span><span class="s1">&#39;path/to/A.framework&#39;</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">frameworks_build_phases</span><span class="o">.</span><span class="n">add_file_reference</span><span class="p">(</span><span class="n">file_ref</span><span class="p">)</span>

<span class="c1"># 添加 libA.a 引用</span>
<span class="n">file_ref</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">frameworks_group</span><span class="o">.</span><span class="n">new_file</span><span class="p">(</span><span class="s1">&#39;path/to/libA.a&#39;</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">frameworks_build_phases</span><span class="o">.</span><span class="n">add_file_reference</span><span class="p">(</span><span class="n">file_ref</span><span class="p">)</span>

<span class="c1"># 添加 bundle 引用</span>
<span class="n">file_ref</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">frameworks_group</span><span class="o">.</span><span class="n">new_file</span><span class="p">(</span><span class="s1">&#39;path/to/xxx.bundle&#39;</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">resources_build_phase</span><span class="o">.</span><span class="n">add_file_reference</span><span class="p">(</span><span class="n">file_ref</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>大家有兴趣可以看看 CocoaPods 是如何配置 <code>Pods.project</code>，为 Pod  生成对应 target，入口在 <code>Installer::generate_pods_project</code> 处。</p>
<h1 id="总结">总结</h1>
<p><strong>Xcode 通过 project.pbxproj，在文件系统之上又抽象出基于 <code>PBXFileReference</code> 和 <code>PBXGroup</code> 的任务构建系统</strong>。对于这一操作一直是不能理解的。为什么不像其他 IDE 一样直接使用项目的文件目录，而是另起炉灶搞了一套似乎并不好用构建件系统呢 ？</p>
<p>在了解完 <code>project.pbxproj</code> 和 Xcodeproj 后，似乎能理解一些设计者的意图。</p>
<p>假设你参与的是一个多人合作的超大型项目 (Project)，它将同时存在多个子任务 (Target)，同时这些任务之间可能存在大量交叉的资源依赖。这些资源不限于  File、Framework、Target、Project。如果我们直接基于文件路径来记录这些资源及其依赖关系，那么当资源发生产生变化时，将会产生大量的修改，例如文件路径变更。</p>
<p>这其实是不能接受的。而有了 <code>PBXFileReference</code> 的存在，任务构建者只需关心 <code>PBXFileReference</code> 这唯一引用，无需在意它背后的文件是否存在，路径是否正确，甚至是内容是否变更，这些都不重要。<strong>通过 <code>PBXFileReference</code> 这层隔离，实现了任务的构建行为及资源关系的固化。</strong></p>
<h1 id="知识点问题梳理">知识点问题梳理</h1>
<p>这里罗列了五个问题用来考察你是否已经掌握了这篇文章，如果没有建议你加入<strong>收藏</strong>再次阅读：</p>
<ol>
<li>说说 <code>xcworkspace</code> 和 <code>xcodeproj</code> 本质是什么，有什么区别 ？</li>
<li><code>pbxproj</code> 中 <code>isa</code> 关键字的作用，有哪些类型 ？</li>
<li>说说 <code>pbxproj</code> 中是如何定义和引用源文件的 ？</li>
<li><code>pbxproj</code> 如何映射为 Xcodeproj 中的对象的 ？</li>
<li>谈谈你对 <code>PBXGroup</code> 和 <code>PBXFileReference</code> 的理解 ？</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">土土Edmond木</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-05-16
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cocoapods/">CocoaPods</a>
          <a href="/tags/ios/">iOS</a>
          <a href="/tags/ruby/">Ruby</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/wwdc/wwdc21/wwdc21-session-10019/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">WWDC21 - Discover concurrency in SwiftUI</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/sourcecode-cocoapods/07-cocoapods-molinillo/">
            <span class="next-text nav-default">7. Molinillo 依赖校验</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:chun574271939@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/looseyi" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/looseyi" class="iconfont icon-github" title="github"></a>
      <a href="https://www.weibo.com/foreverclp" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/tu-tu-edmondmu" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="http://looseyi.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019-12-11 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">土土Edmond木</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
