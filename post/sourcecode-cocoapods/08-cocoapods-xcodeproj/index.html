<!DOCTYPE html>















<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>8. Xcode 工程文件解析 - Aha Edmond</title>

  
  
  <meta name="description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文" />
  <meta name="author" content="土土Edmond木" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://looseyi.github.io/app.min.css" />

  

  
  <link rel="preload" as="image" href="https://looseyi.github.io/theme.png" />

  
  <link rel="preload" as="image" href="https://looseyi.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://looseyi.github.io/github.svg" />
  

  
  <link rel="icon" href="https://looseyi.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://looseyi.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.82.1" />

  
  
  <link
    rel="alternate"
    type="application/rss&#43;xml"
    href="https://looseyi.github.io/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/index.xml"
    title="Aha Edmond"
  />
  

  
  
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
  
  
  <meta property="og:title" content="8. Xcode 工程文件解析" />
<meta property="og:description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://looseyi.github.io/post/sourcecode-cocoapods/08-cocoapods-xcodeproj/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-16T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-05-16T00:00:00&#43;00:00" />


  
  <meta itemprop="name" content="8. Xcode 工程文件解析">
<meta itemprop="description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文"><meta itemprop="datePublished" content="2021-05-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-05-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6731">
<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="8. Xcode 工程文件解析"/>
<meta name="twitter:description" content="引子 在「Molinillo 依赖校验」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文"/>

  
  
</head>


  <body class="not-ready" data-menu="true">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://looseyi.github.io/">Aha Edmond</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  
  <nav class="menu">
    
    <a class="" href="/">Home</a>
    
  </nav>
  

  
  <nav class="social">
    
    <a
      class="twitter"
      style="--url: url(./twitter.svg)"
      href="https://twitter.com/looseyi"
      target="_blank"
    ></a>
    
    <a
      class="github"
      style="--url: url(./github.svg)"
      href="https://github.com/looseyi"
      target="_blank"
    ></a>
    
  </nav>
  
</header>


    <main class="main">
			

<article class="post-single">
  <header class="post-title">
    <p>
      <time>2021-05-16</time>
      
      <span>土土Edmond木</span>
      
    </p>
    <h1>8. Xcode 工程文件解析</h1>
  </header>
  <section class="post-content"><p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/10-xcode-project-src.png" alt="10-xcode-project-src"></p>
<h1 id="引子">引子</h1>
<p>在「<a href="https://zhuanlan.zhihu.com/p/355415807"><strong>Molinillo 依赖校验</strong></a>」通过后，CocoaPods 会根据确定的 PodSpec 下载对应的源代码和资源，并为每个 PodSpec 生成对应的 Xcode Target。本文重点就来聊聊 Xcode Project 的内容构成，以及 <a href="https://github.com/CocoaPods/Xcodeproj">xcodeproj</a> 是如果组织 Xcode Project 内容的。</p>
<h1 id="xcode-工程文件">Xcode 工程文件</h1>
<p>早在前文「<a href="https://zhuanlan.zhihu.com/p/248308670"><strong>Podfile 的解析逻辑</strong></a>」中，我们简单介绍过 <strong>Xcode 的工程结构：Workspace、Project、Target 及 Build Setting</strong> 等。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/00-xcode-project-struct.png" alt="04-workspace"></p>
<p>我们先来了解下这些数据在 Xcode 中是如何表示，了解这些结构才能方便我们理解 xcodeproj 的代码设计思路。</p>
<h2 id="xcworkspace">xcworkspace</h2>
<p>早在 Xcode 4 之前就出现 workspace bundle 了，只是那会 workspace 仍内嵌于 <code>.xcodeproj</code> 中。Xcode 4 之后，我们才对 workspace 单独可见。让我们新建一个 Test.xcodeproj 项目，来看看其目录结构：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>Test.xcodeproj
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>├── project.pbxproj
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>├── project.xcworkspace
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>│   ├── contents.xcworkspacedata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>│   └── xcuserdata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>│       └── edmond.xcuserdatad
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>│           └── UserInterfaceState.xcuserstate
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>└── xcuserdata
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    └── edmond.xcuserdatad
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>        └── xcschemes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>            └── xcschememanagement.plist
</code></pre></div><p>可以发现 <code>Test.xcodeproj</code> bundle 内包含 <code>project.workspace</code>。而当我们通过 <code>pod install</code> 命令成功添加 Pod 依赖后，Xcode 工程目录下会多出 <code>Test.workspace</code>，它是 Xcodeproj 替我们生成的，用于管理当前的 <code>Test.project</code> 与 <code>Pods.pbxproj</code>。新建的 workspace 目录如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>Test.xcworkspace
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>└── contents.xcworkspacedata
</code></pre></div><p>生成的 workspace 文件夹内部只包含了 <code>contents.xcworkspacedata</code>，为 xml 格式的内容：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span><span style="color:#268bd2">&lt;Workspace</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>   version = <span style="color:#2aa198">&#34;1.0&#34;</span><span style="color:#268bd2">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>   <span style="color:#268bd2">&lt;FileRef</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>      location = <span style="color:#2aa198">&#34;group:Test.xcodeproj&#34;</span><span style="color:#268bd2">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>   <span style="color:#268bd2">&lt;/FileRef&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>   <span style="color:#268bd2">&lt;FileRef</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      location = <span style="color:#2aa198">&#34;group:Pods/Pods.xcodeproj&#34;</span><span style="color:#268bd2">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>   <span style="color:#268bd2">&lt;/FileRef&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#268bd2">&lt;/Workspace&gt;</span>
</code></pre></div><p>在标签 Workspace 下声明了两个 <code>FileRef</code> 其地址分别指向了 <code>Test.xcodeproj</code> 和 <code>Pods.xcodeproj</code>。这里注意的是 <code>FileRef</code> 属性的值使用前缀 <code>group + path</code> 来修饰的，而内嵌的 <code>project.xcworkspace</code>，使用 <code>self</code> 作为前缀：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#268bd2">&lt;Workspace</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>   version = <span style="color:#2aa198">&#34;1.0&#34;</span><span style="color:#268bd2">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>   <span style="color:#268bd2">&lt;FileRef</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>      location = <span style="color:#2aa198">&#34;self:&#34;</span><span style="color:#268bd2">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>   <span style="color:#268bd2">&lt;/FileRef&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#268bd2">&lt;/Workspace&gt;</span>
</code></pre></div><p>另外，当我们用 Xcode 打开项目后，能发现 workspace 目录下会自动生成 <code>xcuserdata</code> 目录，它用于保存用户的 Xcode 配置。比如：</p>
<ul>
<li><code>UserInterfaceState.xcuserstate</code>：以二进制的 Plist 保存，用于记录窗口布局等个性化设置。</li>
<li><code>xcdebugger</code>：记录各种断点数据。</li>
</ul>
<p>这也是在日常开发中，经常会选择将 <code>xcuserdata</code> 目录 ignore 掉的原因。</p>
<h2 id="xcodeproj">xcodeproj</h2>
<p>与 <code>.xcworkspace</code> 类似 <code>.xcodeproj</code> 同为 Xcode 工程配置的 bundle，接下来重点展开 <code>project.pbxproj</code>，它记录了 Xcode 工程的各项配置，本质上是一种旧风格的 Plist 文件。</p>
<h3 id="property-list">Property List</h3>
<p>Plist 被设计为人类可读的、可以手工修改的格式，故采用了类似于编程语言的语法将数据序列化为ASCII数据。Plist 最早可追溯到 NeXTSTEP 时期，由于历史原因，目前它支持多种格式，string、binary、array、dictionary 等类型数据。相比于 JSON，Plist 还支持二进制数据的表示，以 <code>&lt;&gt;</code> 修饰文本形式的十六进制数，其中字典与数组的区别如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>Array：
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>plist =&gt; ( <span style="color:#2aa198">&#34;1&#34;</span>, <span style="color:#2aa198">&#34;2&#34;</span>, <span style="color:#2aa198">&#34;3&#34;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>json =&gt; [ <span style="color:#2aa198">&#34;1&#34;</span>, <span style="color:#2aa198">&#34;2&#34;</span>, <span style="color:#2aa198">&#34;3&#34;</span> ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>Dictionary：
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>plist =&gt; { <span style="color:#268bd2">&#34;key&#34;</span> = <span style="color:#2aa198">&#34;value&#34;</span>; ... }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>json =&gt; { <span style="color:#268bd2">&#34;key&#34;</span> : <span style="color:#2aa198">&#34;value&#34;</span>, ... }
</code></pre></div><p>处理 Plist 文件可使用 Unix 提供的 <code>plutil</code> 工具。 比如将 Plist 文件转成 XML 格式：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>plutil -convert xml1 -s -r -o project.pbxproj.xml project.pbxproj
</code></pre></div><p><code>-convert fmt</code> 选项支持转换的格式有：xml1、binary1、json、swift、json。</p>
<h3 id="projectpbxproj">project.pbxproj</h3>
<p><strong>pbxproj 文件全称为 Project Builder Xcode Project</strong>，光看第一层元数据比较简单：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>// !$*UTF<span style="color:#2aa198">8</span>*$!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>	archiveVersion = 1;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>	classes = {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>	};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>	objectVersion = <span style="color:#2aa198">50</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>	objects = {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>		...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>   };
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>	rootObject = <span style="color:#2aa198">8528</span>A<span style="color:#2aa198">0</span>D<span style="color:#2aa198">92651</span>F<span style="color:#2aa198">281005</span>BEBA<span style="color:#2aa198">5</span> /* Project object */;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>}
</code></pre></div><p>文件以明确的编码信息开头，<code>archiveVersion</code> 通常为 1，表示序列化的版本号；<code>classes</code> 则似乎一直为空；<code>objectVersion</code> 表示所兼容的最低版本的 Xcode，该数字与 Xcode 的版本对应关系如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#2aa198">53</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 11.4&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#2aa198">52</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 11.0&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#2aa198">51</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 10.0&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#2aa198">50</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 9.3&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#2aa198">48</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 8.0&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#2aa198">47</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 6.3&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span><span style="color:#2aa198">46</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 3.2&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#2aa198">45</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">&#39;Xcode 3.1&#39;</span>,
</code></pre></div><p><code>rootObject</code> 记录的 16 进制数字，为 project 对象的索引。这里我们可以称其为 Xcode Object Identifier，pbxproj 中的每个 Xcode Object 创建时，都会生成对应唯一标识数字，而上面的 <code>objects</code> 字典则记录了整个 Xcode 项目的所有 Xcode Object。</p>
<h3 id="xcode-object-identifiers">Xcode Object Identifiers</h3>
<p>Xcode Object Identifier 是用 24 位的 16 进制字符表示，我们暂且称其为 GUID。</p>
<blockquote>
<p>⚠️ 注意这并不意味着它与其他称为 GUID 的其他事物相似。</p>
</blockquote>
<p>生成的 GUID 不仅在项目文件中必须唯一，并且在 Xcode 中同时打开的其他项目文件中也必须唯一，即<strong>跨工程唯一性</strong>。只有这样能避免了多人合作中，同时新增或编辑工程文件带来的问题。这其实是一个有趣的竞争需求，有兴趣的可以查看 <a href="https://github.com/premake/premake-core">Premake</a> 这个项目，它能保证重新生成的项目具有相同的 GUID。</p>
<p>对于 Xcode 使用的 GUID 算法可参考 <a href="https://pewpewthespells.com/blog/pbxproj_identifiers.html">PBXProj Identifers</a>，它是通过逆向 <code>DevToolsCore.framework</code> 获取的，从中可以窥见 GUID 的生成需要依赖 👇 这些数据：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">struct</span> globalidentifier {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>    int8_t user;            <span style="color:#586e75">// encoded username
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#586e75"></span>    int8_t pid;             <span style="color:#586e75">// encoded current pid #
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#586e75"></span>    int16_t _random;        <span style="color:#586e75">// encoded random value
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"></span>    int32_t _time;          <span style="color:#586e75">// encoded time value
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#586e75"></span>    int8_t zero;            <span style="color:#586e75">// zero
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#586e75"></span>    int8_t host_shift;      <span style="color:#586e75">// encoded, shifted hostid
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#586e75"></span>    int8_t host_h;          <span style="color:#586e75">// high byte of lower bytes of hostid
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"></span>    int8_t host_l;          <span style="color:#586e75">// low byte of lower bytes of hostid
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#586e75"></span>} __attribute__((packed));  <span style="color:#586e75">// packed, so we always have a length of 12 bytes
</span></code></pre></div><h3 id="xcode-object">Xcode Object</h3>
<p>Xcode Object 是指所有记录在 <code>objects</code> 字典中的对象 (后续简称为 Object)，内部以 <code>isa</code> 来标识类型。同时Xcode 按 <code>isa</code> 类型划分出若干 section，以注释的方式分节。</p>
<p>以 <code>PBXProject</code> 为例：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span>/* Begin PBXProject section */
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>   <span style="color:#2aa198">8528</span>A<span style="color:#2aa198">0</span>D<span style="color:#2aa198">92651</span>F<span style="color:#2aa198">281005</span>BEBA<span style="color:#2aa198">5</span> /* Project object */ = {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>      isa = PBXProject;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>      ...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>      mainGroup = 8528A0D82651F281005BEBA5;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      productRefGroup = 8528A0E22651F281005BEBA5 /* Products */;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      projectDirPath = <span style="color:#268bd2">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      projectRoot = <span style="color:#2aa198">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>      targets = ( 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>         <span style="color:#2aa198">8528</span>A<span style="color:#2aa198">0E02651</span>F<span style="color:#2aa198">281005</span>BEBA<span style="color:#2aa198">5</span> /* Test */,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>   };
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>/* End PBXProject section */
</code></pre></div><p>这里 <code>Project object</code> 的索引值正是 <code>rootObject</code> 记录的 <em>8528A0D92651F281005BEBA5</em>，其 <code>isa</code> 类型为 <code>PBXProject</code>，<code>targets</code> 数组记录了项目需要构建的任务：<code>Test target</code>。整个 PBXProject section 就定义在 <code>objects</code> 中。</p>
<p>Object 类型的引用关系大致如下图：</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/00-xcodte-project.png" alt="00-xcodte-project"></p>
<blockquote>
<p>关于 pbxproj 内 Object 的详细说明，可参照 <a href="http://www.monobjc.net/xcode-project-file-format.html">Xcode Project File Format</a>。</p>
</blockquote>
<ul>
<li>PBXProject：Project 的设置，编译工程所需信息</li>
<li>PBXNativeTarget：Target 的设置</li>
<li>PBXTargetDependency： Target 依赖</li>
<li>PBXContainerItemProxy：部署的元素</li>
<li>XCConfigurationList：构建配置相关，包含 project 和 target 文件</li>
<li>XCBuildConfiguration：编译配置，对应 Xcode 的 Build Setting 内容</li>
<li>PBXVariantGroup：国际化对照表或 <code>.storyboard</code> 文件</li>
<li>PBXBuildFile：各类文件，最终会关联到 PBXFileReference</li>
<li>PBXFileReference：源码、资源、库，Info.plist 等文件索引</li>
<li>PBXGroup：虚拟文件夹，可嵌套，记录管理的 PBXFileReference 与子 PBXGroup</li>
<li>PBXSourcesBuildPhase：编译源文件（.m、.swift）</li>
<li>PBXFrameworksBuildPhase：用于 framework 的构建</li>
<li>PBXResourcesBuildPhase：编译资源文件，有 xib、storyboard、plist 以及 xcassets 等资源文件</li>
</ul>
<h1 id="xcodeproj-1">Xcodeproj</h1>
<p><a href="https://github.com/CocoaPods/Xcodeproj">Xcodeproj</a> 能够通过 Ruby 来创建和修改 Xcode 工程文件，其内部完整映射了 <code>project.pbxproj</code> 的 Object 类型及其对应的属性，限于篇幅本文会重点介绍关键的 Object 和解析逻辑。</p>
<h2 id="project-解析">Project 解析</h2>
<p>上节内容可知，Xcode 解析工程的是依次检查 <code>*.xcworkspace</code> &gt; <code>*.xcproject</code> &gt; <code>project.pbxproj</code>，根据 <code>project.pbxproj</code> 的数据结构，Xcodeproj 提供了 Project 类，用于记录根元素。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Xcodeproj
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">Project</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#586e75"># object 模块，后面会提到</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#719e07">include</span> <span style="color:#cb4b16">Object</span>	
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#586e75"># 序列化时 project 的最低兼容版本, 与 object_version 对应</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:archive_version</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    <span style="color:#586e75"># 作用未知</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:classes</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#586e75"># project 最低兼容版本</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:object_version</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    <span style="color:#586e75"># project 所包含的 objects，结构为 [Hash{String =&gt; AbstractObject}]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:objects_by_uuid</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#586e75"># project 的根结点，即 PBXProject</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:root_object</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07">end</span>
</code></pre></div><p>在 <code>pod install</code> 的依赖解析阶段，会读取 <code>project.pbxproj</code>。</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/01-resolve-dependencies.png" alt="01-resolve-dependencies"></p>
<p>最终在 <code>inspect_targets_to_integrate</code> 方法内打开项目：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">inspect_targets_to_integrate</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  project <span style="color:#719e07">=</span> <span style="color:#cb4b16">Xcodeproj</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Project</span><span style="color:#719e07">.</span>open(project_path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span><span style="color:#719e07">end</span>
</code></pre></div><p>继续看 <code>Xcodeproj::Project::open</code> 实现：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/xcproject/Project.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">open</span>(path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  path <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pathname</span><span style="color:#719e07">.</span>pwd <span style="color:#719e07">+</span> path
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">unless</span> <span style="color:#cb4b16">Pathname</span><span style="color:#719e07">.</span>new(path)<span style="color:#719e07">.</span>exist?
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#34;[Xcodeproj] Unable to open `</span><span style="color:#2aa198">#{</span>path<span style="color:#2aa198">}</span><span style="color:#2aa198">` because it doesn&#39;t exist.&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  project <span style="color:#719e07">=</span> <span style="color:#719e07">new</span>(path, <span style="color:#719e07">true</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  project<span style="color:#719e07">.</span>send(<span style="color:#2aa198">:initialize_from_file</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  project
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">def</span> <span style="color:#268bd2">initialize_from_file</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  pbxproj_path <span style="color:#719e07">=</span> path <span style="color:#719e07">+</span> <span style="color:#2aa198">&#39;project.pbxproj&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  plist <span style="color:#719e07">=</span> <span style="color:#cb4b16">Plist</span><span style="color:#719e07">.</span>read_from_path(pbxproj_path<span style="color:#719e07">.</span>to_s)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  root_object<span style="color:#719e07">.</span>remove_referrer(<span style="color:#b58900">self</span>) <span style="color:#719e07">if</span> root_object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  @root_object     <span style="color:#719e07">=</span> new_from_plist(plist<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;rootObject&#39;</span><span style="color:#719e07">]</span>, plist<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;objects&#39;</span><span style="color:#719e07">]</span>, <span style="color:#b58900">self</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  @archive_version <span style="color:#719e07">=</span> plist<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;archiveVersion&#39;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  @object_version  <span style="color:#719e07">=</span> plist<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;objectVersion&#39;</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  @classes         <span style="color:#719e07">=</span> plist<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;classes&#39;</span><span style="color:#719e07">]</span> <span style="color:#719e07">||</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>  @dirty           <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>  <span style="color:#719e07">unless</span> root_object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#34;[Xcodeproj] Unable to find a root object in </span><span style="color:#2aa198">#{</span>pbxproj_path<span style="color:#2aa198">}</span><span style="color:#2aa198">.&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>  <span style="color:#719e07">if</span> archive_version<span style="color:#719e07">.</span>to_i <span style="color:#719e07">&gt;</span> <span style="color:#cb4b16">Constants</span><span style="color:#719e07">::</span><span style="color:#cb4b16">LAST_KNOWN_ARCHIVE_VERSION</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>    <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#39;[Xcodeproj] Unknown archive version.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>  <span style="color:#719e07">if</span> object_version<span style="color:#719e07">.</span>to_i <span style="color:#719e07">&gt;</span> <span style="color:#cb4b16">Constants</span><span style="color:#719e07">::</span><span style="color:#cb4b16">LAST_KNOWN_OBJECT_VERSION</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>    <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#39;[Xcodeproj] Unknown object version.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span>  <span style="color:#586e75"># Projects can have product_ref_groups that are not listed in the main_groups[&#34;Products&#34;]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>  root_object<span style="color:#719e07">.</span>product_ref_group <span style="color:#719e07">||=</span> root_object<span style="color:#719e07">.</span>main_group<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;Products&#39;</span><span style="color:#719e07">]</span> <span style="color:#719e07">||</span> root_object<span style="color:#719e07">.</span>main_group<span style="color:#719e07">.</span>new_group(<span style="color:#2aa198">&#39;Products&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37</span><span style="color:#719e07">end</span>
</code></pre></div><ol>
<li>在 open 方法中会检验路径，初始化 Project 对象;</li>
<li>使用内部 Property List 类 <code>Plist</code> 来读取 <code>project.pbxproj</code> 数据;</li>
</ol>
<p>需要注意的是 <code>new_from_plist</code> 不仅完成了 rootObject 的解析，同时也完成 objects 的解析。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">new_from_plist</span>(uuid, objects_by_uuid_plist, root_object <span style="color:#719e07">=</span> <span style="color:#719e07">false</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  attributes <span style="color:#719e07">=</span> objects_by_uuid_plist<span style="color:#719e07">[</span>uuid<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#719e07">if</span> attributes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75"># 以 isa 获取 Xcodeproj 中对应的 Xcode Object 类型</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    klass <span style="color:#719e07">=</span> <span style="color:#cb4b16">Object</span><span style="color:#719e07">.</span>const_get(attributes<span style="color:#719e07">[</span><span style="color:#2aa198">&#39;isa&#39;</span><span style="color:#719e07">]</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    object <span style="color:#719e07">=</span> klass<span style="color:#719e07">.</span>new(<span style="color:#b58900">self</span>, uuid)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    objects_by_uuid<span style="color:#719e07">[</span>uuid<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    object<span style="color:#719e07">.</span>add_referrer(<span style="color:#b58900">self</span>) <span style="color:#719e07">if</span> root_object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#586e75"># 解析 objects 节点，并完成 ISA 数据到 Xcode Object 的映射</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    object<span style="color:#719e07">.</span>configure_with_plist(objects_by_uuid_plist)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
</code></pre></div><ol>
<li>以 uuid 取出 Plist 数据并利用 isa kclass 完成 Project 对象的初始化和映射。<code>Object const</code> 中记录了支持的 <code>isa</code>；</li>
<li>将 object 存入 objects_by_uuid 字典中，以覆盖原有的 GUID；</li>
<li>执行 <code>configure_with_plist</code> 递归，完成 <code>objects</code> 映射。</li>
</ol>
<blockquote>
<p>Tips: <code>configure_with_plist</code> 于下篇展开.</p>
</blockquote>
<p><code>project.pbxproj</code> 解析主体流程如下</p>
<p><img src="https://gitee.com/looseyi/blog-image/raw/master/uPic/02-parse-project.png" alt="02-parse-project"></p>
<p>图中的 reference attributes 是指 Object 的引用属性，后面会有介绍。</p>
<h2 id="object-module">Object Module</h2>
<h3 id="abstractobject">AbstractObject</h3>
<p>Object 的抽象类，Xcode 项目并不存在对应的 <code>isa</code> 类型。先简单介绍部分属性，方便后续理解。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">AbstractObject</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#586e75"># object 类型</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:isa</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#586e75"># object 唯一标识</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:uuid</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#586e75"># 持有 object 的 project</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:project</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(project, uuid)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    @project <span style="color:#719e07">=</span> project
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    @uuid <span style="color:#719e07">=</span> uuid
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>    @isa <span style="color:#719e07">=</span> <span style="color:#b58900">self</span><span style="color:#719e07">.</span>class<span style="color:#719e07">.</span>isa
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    @referrers <span style="color:#719e07">=</span> <span style="color:#719e07">[]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">unless</span> @isa <span style="color:#719e07">=~</span> <span style="color:#dc322f">/^(PBX|XC)/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>      <span style="color:#719e07">raise</span> <span style="color:#2aa198">&#34;[Xcodeproj] Attempt to initialize an abstract class (</span><span style="color:#2aa198">#{</span><span style="color:#b58900">self</span><span style="color:#719e07">.</span>class<span style="color:#2aa198">}</span><span style="color:#2aa198">).&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">end</span>
</code></pre></div><p>注意，Object 类在 initialize 时关联了 project 对象，作者不建议我们直接使用，而在 Xcodeproj 模块内提供了 convince 方法。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">new</span>(klass)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>   <span style="color:#719e07">if</span> klass<span style="color:#719e07">.</span>is_a?(<span style="color:#b58900">String</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>     klass <span style="color:#719e07">=</span> <span style="color:#cb4b16">Object</span><span style="color:#719e07">.</span>const_get(klass)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>   <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>   object <span style="color:#719e07">=</span> klass<span style="color:#719e07">.</span>new(<span style="color:#b58900">self</span>, generate_uuid)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>   object<span style="color:#719e07">.</span>initialize_defaults
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>   object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">end</span>
</code></pre></div><p>作者保留 project 的引用是为了方便处理 Object 的引用计数，project 作为项目的根节点，记录了完整的工程配置和各模块的交叉引用关系，有了 project 的引用能给进行 object 的引用管理。</p>
<h3 id="const-accessor">Const Accessor</h3>
<p>这里先插播一下 Object 模块中 <code>const</code> 定义及其存储的值。在 Ruby 中 Module 可以在运行时添加模块级的常量，方法如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#cb4b16">Module</span><span style="color:#586e75">#const_get</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span><span style="color:#cb4b16">Module</span><span style="color:#586e75">#const_set</span>
</code></pre></div><p>那么问题来了，这些 const 常量是在什么时机存入 Object 中的呢 ？</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#586e75"># lib/xcodeproj/project/object.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#cb4b16">Xcodeproj</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Constants</span><span style="color:#719e07">::</span><span style="color:#cb4b16">KNOWN_ISAS</span><span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>superclass_name, isas<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  superklass <span style="color:#719e07">=</span> <span style="color:#cb4b16">Xcodeproj</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Project</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Object</span><span style="color:#719e07">.</span>const_get(superclass_name)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>  isas<span style="color:#719e07">.</span>each <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>isa<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>    c <span style="color:#719e07">=</span> <span style="color:#cb4b16">Class</span><span style="color:#719e07">.</span>new(superklass)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>    <span style="color:#cb4b16">Xcodeproj</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Project</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Object</span><span style="color:#719e07">.</span>const_set(isa, c)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span><span style="color:#719e07">end</span>
</code></pre></div><p>在 object.rb 文件中，可以定位到 <code>Object.const_set</code> 的调用，它是在 Object 类被加载时触发的。Xcodeproj 支持的 <code>isa</code> 类型名称都定义在 <code>Xcodeproj::Constants::KNOWN_ISAS</code> 中。Object 加载时通过遍历它来载入 <code>isa class</code>。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#cb4b16">KNOWN_ISAS</span> <span style="color:#719e07">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#2aa198">&#39;AbstractObject&#39;</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">%w(
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#2aa198">    PBXBuildFile
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span><span style="color:#2aa198">    AbstractBuildPhase
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#2aa198">    PBXBuildRule
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span><span style="color:#2aa198">    XCBuildConfiguration
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span><span style="color:#2aa198">    XCConfigurationList
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span><span style="color:#2aa198">    PBXContainerItemProxy
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#2aa198">    PBXFileReference
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#2aa198">    PBXGroup
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span><span style="color:#2aa198">    PBXProject
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span><span style="color:#2aa198">    PBXTargetDependency
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#2aa198">    PBXReferenceProxy
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span><span style="color:#2aa198">    AbstractTarget
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#2aa198">  )</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#2aa198">&#39;AbstractBuildPhase&#39;</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">%w(
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span><span style="color:#2aa198">    PBXCopyFilesBuildPhase
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#2aa198">    PBXResourcesBuildPhase
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#2aa198">    PBXSourcesBuildPhase
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span><span style="color:#2aa198">    PBXFrameworksBuildPhase
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span><span style="color:#2aa198">    PBXHeadersBuildPhase
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span><span style="color:#2aa198">    PBXShellScriptBuildPhase
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span><span style="color:#2aa198">  )</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>  <span style="color:#2aa198">&#39;AbstractTarget&#39;</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">%w(
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span><span style="color:#2aa198">    PBXNativeTarget
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span><span style="color:#2aa198">    PBXAggregateTarget
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span><span style="color:#2aa198">    PBXLegacyTarget
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span><span style="color:#2aa198">  )</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span>  <span style="color:#2aa198">&#39;PBXGroup&#39;</span> <span style="color:#719e07">=&gt;</span> <span style="color:#2aa198">%w(
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33</span><span style="color:#2aa198">    XCVersionGroup
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34</span><span style="color:#2aa198">    PBXVariantGroup
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35</span><span style="color:#2aa198">  )</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36</span>}<span style="color:#719e07">.</span>freeze
</code></pre></div><h2 id="object-attributes">Object Attributes</h2>
<p><code>AbstractObject</code> 作为 <code>Xcodeproj</code> 提供的 Object 基类，它不仅提供了基本属性，如 <code>isa</code> 类型和 uuid 等，还提供了特殊的属性修饰器如 <code>Attribute</code>，方便快速添加属性。光从 <code>KNOWN_ISAS</code> 看来这些 <code>isa</code> 类型就已经够多了，还要考虑属性的 CURD 以及数据到对象映射等一系列操作。</p>
<p>为此，<strong>Xcodeproj 实现了一套针对 <code>project.pbxproj</code> 的 DSL 解析</strong>。这些特性的实现正是依赖于属性修饰器和 Ruby 强大的 Runtime 能力。</p>
<h3 id="abstractobjectattribute">AbstractObjectAttribute</h3>
<p><code>AbstractObjectAttribute</code> 是用于声明和存储 Object 属性的关键信息，定义如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">AbstractObjectAttribute</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#586e75"># 属性本身类型，:simple, :to_one, :to_many.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:type</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  <span style="color:#586e75"># 属性名</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  <span style="color:#719e07">attr_reader</span> <span style="color:#2aa198">:name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  <span style="color:#586e75"># 属性的持有者</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:owner</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(type, <span style="color:#b58900">name</span>, owner)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    @type  <span style="color:#719e07">=</span> type
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    @name  <span style="color:#719e07">=</span> <span style="color:#b58900">name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    @owner <span style="color:#719e07">=</span> owner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  <span style="color:#586e75"># 属性支持的类型</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:classes</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>  <span style="color:#586e75"># 仅限于 :references_by_keys 关联的类型</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>  <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:classes_by_key</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>  <span style="color:#586e75"># 仅限于 :simple 类型指定默认值</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>  <span style="color:#719e07">attr_accessor</span> <span style="color:#2aa198">:default_value</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>  <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span><span style="color:#719e07">end</span>
</code></pre></div><p><code>AbstractObject</code> 通过 Ruby 提供的 <code>Singleton Classes</code> 以实现属性修饰器方法的扩展。</p>
<p>对于单例模式，Ruby 提供了多种实现方式。在 Ruby 中，每个对象可以拥有一个匿名<strong>单例类</strong>。默认情况下，自定义类是不存在单例类，不过可通过 <code>class &lt;&lt; obj</code> 来打开对象的单例类空间。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">class</span> <span style="color:#268bd2">C</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">class</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#b58900">self</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    <span style="color:#b58900">puts</span> <span style="color:#b58900">self</span>	<span style="color:#586e75"># 输出：#&lt;Class:C&gt;，类 C 类对象的单例类</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">end</span>
</code></pre></div><blockquote>
<p>注意：Ruby 中每个对象 (Class / Module 也是对象) 都有自己所属的类，它们都是有具体名称的类。</p>
</blockquote>
<p><code>Xcodeproj</code> 针对 Attribute 提供了多种单例类方法，定义如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">AbstractObject</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#719e07">class</span> <span style="color:#719e07">&lt;&lt;</span> <span style="color:#b58900">self</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>      <span style="color:#586e75"># 普通属性声明方法</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">attribute</span>(<span style="color:#b58900">name</span>, klass, default_value <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>) <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>       
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>      <span style="color:#586e75"># 单一引用的属性声明方法</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">has_one</span>(singular_name, isas) <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>       
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>      <span style="color:#586e75"># 多引用的属性声明方法</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">has_many</span>(plural_name, isas) <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>       
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      <span style="color:#586e75"># 多引用且不同 key 的属性声明方法</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>      <span style="color:#719e07">def</span> <span style="color:#268bd2">has_many_references_by_keys</span>(plural_name, classes_by_key) <span style="color:#719e07">...</span> <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07">end</span>
</code></pre></div><p>直接看如何使用，声明属性比较直观：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">PBXProject</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">AbstractObject</span>     
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>     
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    <span style="color:#586e75"># 声明为 [String] 类型的 project_dir_path，默认值为空</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    attribute <span style="color:#2aa198">:project_dir_path</span>, <span style="color:#b58900">String</span>, <span style="color:#2aa198">&#39;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#586e75"># 声明为 [PBXGroup] 类型的 main_group</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>    has_one <span style="color:#2aa198">:main_group</span>, <span style="color:#cb4b16">PBXGroup</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#586e75"># 声明为 [ObjectList&lt;AbstractTarget&gt;] 类型的 targets</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    has_many <span style="color:#2aa198">:targets</span>, <span style="color:#cb4b16">AbstractTarget</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>     
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#586e75"># 声明为 [Array&lt;ObjectDictionary&gt;] 类型的 project_references </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    has_many_references_by_keys <span style="color:#2aa198">:project_references</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>                                <span style="color:#2aa198">:project_ref</span>   <span style="color:#719e07">=&gt;</span> <span style="color:#cb4b16">PBXFileReference</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>                                <span style="color:#2aa198">:product_group</span> <span style="color:#719e07">=&gt;</span> <span style="color:#cb4b16">PBXGroup</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>    <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span><span style="color:#719e07">end</span>
</code></pre></div><p>所谓的单一或者多引用是指<strong>Object 之间引用关系</strong>。以 <code>PBXProject</code> 为例，一个项目只能指定一个 mainGroup，但对于 targets 可以存在多个。这里不直接使用 <code>attribute</code> 来修饰是因为，像 target 这种存在交叉引用的 Object 被删除时，我们需要知道谁引用了它，才保证所有的引用都能被清理干净。因此，<strong>Xcodeproj 实现了一套针对 Object 的引用计数管理</strong> (不在本文讨论范围)。</p>
<h3 id="attribute">Attribute</h3>
<p>今天先看普通属性的 DSL 实现，<code>has_one</code> 与 <code>has_many</code> 的属性修饰将在下篇展开。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># lib/xcodeproj/project/object_attributes.rb</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span><span style="color:#719e07">def</span> <span style="color:#268bd2">attribute</span>(<span style="color:#b58900">name</span>, klass, default_value <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>  <span style="color:#586e75"># 1. 初始化 attribute，记录属性名，属性类型及默认值</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>  attrb <span style="color:#719e07">=</span> <span style="color:#cb4b16">AbstractObjectAttribute</span><span style="color:#719e07">.</span>new(<span style="color:#2aa198">:simple</span>, <span style="color:#b58900">name</span>, <span style="color:#b58900">self</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>  attrb<span style="color:#719e07">.</span>classes <span style="color:#719e07">=</span> <span style="color:#719e07">[</span>klass<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>  attrb<span style="color:#719e07">.</span>default_value <span style="color:#719e07">=</span> default_value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>  <span style="color:#586e75"># 2. 将 attrb 存入 @attributes</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>  add_attribute(attrb)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  <span style="color:#586e75"># 3. 添加名为 name 的 getter</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  define_method(attrb<span style="color:#719e07">.</span>name) <span style="color:#719e07">do</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    @simple_attributes_hash <span style="color:#719e07">||=</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    @simple_attributes_hash<span style="color:#719e07">[</span>attrb<span style="color:#719e07">.</span>plist_name<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  <span style="color:#586e75"># 4. 添加名为 #{name}= 的 setter，并将值存入 @simple_attributes_hash 字典中</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  define_method(<span style="color:#2aa198">&#34;</span><span style="color:#2aa198">#{</span>attrb<span style="color:#719e07">.</span>name<span style="color:#2aa198">}</span><span style="color:#2aa198">=&#34;</span>) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>value<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>    @simple_attributes_hash <span style="color:#719e07">||=</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>    <span style="color:#586e75"># 5. 检查 value 是否为 klass 支持的类型</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>    attrb<span style="color:#719e07">.</span>validate_value(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23</span>    existing <span style="color:#719e07">=</span> @simple_attributes_hash<span style="color:#719e07">[</span>attrb<span style="color:#719e07">.</span>plist_name<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24</span>    <span style="color:#719e07">if</span> existing<span style="color:#719e07">.</span>is_a?(<span style="color:#cb4b16">Hash</span>) <span style="color:#719e07">&amp;&amp;</span> value<span style="color:#719e07">.</span>is_a?(<span style="color:#cb4b16">Hash</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25</span>      <span style="color:#719e07">return</span> value <span style="color:#719e07">if</span> existing<span style="color:#719e07">.</span>keys <span style="color:#719e07">==</span> value<span style="color:#719e07">.</span>keys <span style="color:#719e07">&amp;&amp;</span> existing <span style="color:#719e07">==</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26</span>    <span style="color:#719e07">elsif</span> existing <span style="color:#719e07">==</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27</span>      <span style="color:#719e07">return</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29</span>    mark_project_as_dirty!
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30</span>    @simple_attributes_hash<span style="color:#719e07">[</span>attrb<span style="color:#719e07">.</span>plist_name<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32</span><span style="color:#719e07">end</span>
</code></pre></div><p>代码比较长核心逻辑就 2 步：</p>
<ol>
<li>
<p>初始化 attribute，记录属性名，属性类型及默认值，将 attrb 存入对象的 <code>@attributes</code> 用于后续遍历；</p>
</li>
<li>
<p>利用 <code>define_method</code> 为修饰的对象添加实例变量存取方法。</p>
<p>由于修饰的属性类型不同，accessor 方法直接使用 Hash 容器来保存变量值，key 为 <code>attribute.name</code>，使用 Hash 是为了避免受到 Object 引用计数的影响。</p>
</li>
</ol>
<p>本质上 attribute 为我们生成的 accessor 如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">project_dir_path</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  @simple_attributes_hash<span style="color:#719e07">[</span>projectDirPath<span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span><span style="color:#719e07">def</span> <span style="color:#268bd2">project_dir_path</span><span style="color:#719e07">=</span>(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>  attribute<span style="color:#719e07">.</span>validate_value(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>  @simple_attributes_hash<span style="color:#719e07">[</span>projectDirPath<span style="color:#719e07">]</span> <span style="color:#719e07">=</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">end</span>
</code></pre></div><h2 id="xcode-object-1">Xcode Object</h2>
<p>最后我们来聊两个 <code>project.pbxproj</code> 中的基础 Object 类型：<code>PBXFileReference</code> 和 <code>PBXGroup</code>。放在文章末尾，是希望看到这里的同学能理解Xcode 设计的背后思想。</p>
<h3 id="pbxfilereference">PBXFileReference</h3>
<p><code>PBXFileReference</code> 记录了构建 Xcode 项目所需要的真实文件信息，<strong>主要记录了文件路径</strong>。这些 <code>PBXFileReference</code> 就是我们在 Xcode 项目的左侧边栏中所见的文件。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#cb4b16">F8DA09E31396AC040057D0CC</span> <span style="color:#dc322f">/* main.m */</span> <span style="color:#719e07">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  isa <span style="color:#719e07">=</span> <span style="color:#cb4b16">PBXFileReference</span>; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  fileEncoding <span style="color:#719e07">=</span> <span style="color:#2aa198">4</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  lastKnownFileType <span style="color:#719e07">=</span> sourcecode<span style="color:#719e07">.</span>c<span style="color:#719e07">.</span>objc; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>  path <span style="color:#719e07">=</span> main<span style="color:#719e07">.</span>m; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>  sourceTree <span style="color:#719e07">=</span> <span style="color:#cb4b16">SOURCE_ROOT</span>; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>};
</code></pre></div><p>对于 <code>PBXFileReference</code> 路径，重点在于确认该 path 是相对路径还是绝对路径，<code>sourceTree</code> 就是用来描述这个的，它有几种相对关系：</p>
<ul>
<li>
<p><code>&lt;absolute&gt;</code>：绝对路径</p>
</li>
<li>
<p><code>&lt;group&gt;</code> 基于 PBXGroup 的相对路径</p>
</li>
<li>
<p><code>SOURCE_ROOT</code> 基于 project 的相对路径</p>
</li>
<li>
<p><code>DEVELOPER_DIR</code> 基于 developer directory 的相对路径</p>
</li>
<li>
<p><code>BUILT_PRODUCTS_DIR</code> 基于 build  products directory 的相对路径</p>
</li>
<li>
<p><code>SDKROOT</code> 基于 SDK directory 的相对路径</p>
</li>
</ul>
<p><code>Xcodeproj</code> 提供了 <code>GroupableHelper</code> 用于获取各种状态的文件目录，比如文件的绝对目录：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">source_tree_real_path</span>(object)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">case</span> object<span style="color:#719e07">.</span>source_tree
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>  <span style="color:#719e07">when</span> <span style="color:#2aa198">&#39;&lt;group&gt;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    object_parent <span style="color:#719e07">=</span> parent(object)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#719e07">if</span> object_parent<span style="color:#719e07">.</span>isa <span style="color:#719e07">==</span> <span style="color:#2aa198">&#39;PBXProject&#39;</span><span style="color:#719e07">.</span>freeze
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>      object<span style="color:#719e07">.</span>project<span style="color:#719e07">.</span>project_dir <span style="color:#719e07">+</span> object<span style="color:#719e07">.</span>project<span style="color:#719e07">.</span>root_object<span style="color:#719e07">.</span>project_dir_path
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>      real_path(object_parent)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>  <span style="color:#719e07">when</span> <span style="color:#2aa198">&#39;SOURCE_ROOT&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>    object<span style="color:#719e07">.</span>project<span style="color:#719e07">.</span>project_dir
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  <span style="color:#719e07">when</span> <span style="color:#2aa198">&#39;&lt;absolute&gt;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>    <span style="color:#719e07">nil</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>  <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>    <span style="color:#cb4b16">Pathname</span><span style="color:#719e07">.</span>new(<span style="color:#2aa198">&#34;${</span><span style="color:#2aa198">#{</span>object<span style="color:#719e07">.</span>source_tree<span style="color:#2aa198">}</span><span style="color:#2aa198">}&#34;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span><span style="color:#719e07">end</span>
</code></pre></div><p><code>PBXFileReference</code> 主要定义如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">module</span> Object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">PBXFileReference</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">AbstractObject</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>    attribute <span style="color:#2aa198">:name</span>, <span style="color:#b58900">String</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    attribute <span style="color:#2aa198">:path</span>, <span style="color:#b58900">String</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    attribute <span style="color:#2aa198">:source_tree</span>, <span style="color:#b58900">String</span>, <span style="color:#2aa198">&#39;SOURCE_ROOT&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span><span style="color:#719e07">end</span>
</code></pre></div><h3 id="pbxgroup">PBXGroup</h3>
<p>基于 <code>PBXFileReference</code> 之上的一层抽象，能更好的对 <code>PBXFileReference</code> 进行管理和分组。<code>PBXGroup</code> 背后并不一定真实存在对应的文件夹，另外 <code>PBXGroup</code> 可以引用其他 <code>PBXGroup</code>，进行嵌套。定义如下:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">module</span> Object
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  <span style="color:#719e07">class</span> <span style="color:#268bd2">PBXGroup</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">AbstractObject</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    <span style="color:#586e75"># group 可包含的类型</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    has_many <span style="color:#2aa198">:children</span>, <span style="color:#719e07">[</span><span style="color:#cb4b16">PBXGroup</span>, <span style="color:#cb4b16">PBXFileReference</span>, <span style="color:#cb4b16">PBXReferenceProxy</span><span style="color:#719e07">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    attribute <span style="color:#2aa198">:source_tree</span>, <span style="color:#b58900">String</span>, <span style="color:#2aa198">&#39;&lt;group&gt;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    <span style="color:#586e75"># 记录 group 在文件系统中的路径</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    attribute <span style="color:#2aa198">:path</span>, <span style="color:#b58900">String</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>		<span style="color:#586e75"># 默认情况下，如果指定了路径，则此属性不存在。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    attribute <span style="color:#2aa198">:name</span>, <span style="color:#b58900">String</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span><span style="color:#719e07">end</span>
</code></pre></div><p>它提供了一个便利的初始化方法：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">new_group</span>(<span style="color:#b58900">name</span>, path <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>, source_tree <span style="color:#719e07">=</span> <span style="color:#2aa198">:group</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  group <span style="color:#719e07">=</span> project<span style="color:#719e07">.</span>new(<span style="color:#cb4b16">PBXGroup</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  children <span style="color:#719e07">&lt;&lt;</span> group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>  group<span style="color:#719e07">.</span>name <span style="color:#719e07">=</span> <span style="color:#b58900">name</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>  group<span style="color:#719e07">.</span>set_source_tree(source_tree)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>  group<span style="color:#719e07">.</span>set_path(path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>  group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span><span style="color:#719e07">end</span>
</code></pre></div><p>这里的 name 是必须传的，path 则可以为空。而我们在 Xcode 的导航栏中所见的各个分组名称和路径就是由这两个属性来决定的。没有 name 的情况下则是以 path 的 basename 作为 display_name 来呈现。</p>
<p>最后来看个例子：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span><span style="color:#cb4b16">F8E469631395739D00DB05C8</span> <span style="color:#dc322f">/* Frameworks */</span> <span style="color:#719e07">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>  isa <span style="color:#719e07">=</span> <span style="color:#cb4b16">PBXGroup</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>  children <span style="color:#719e07">=</span> (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>    <span style="color:#2aa198">50</span><span style="color:#cb4b16">ABD6EC159FC2CE001BE42C</span> <span style="color:#dc322f">/* MobileCoreServices.framework */</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>    <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>  <span style="color:#b58900">name</span> <span style="color:#719e07">=</span> <span style="color:#cb4b16">Frameworks</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">8</span>  sourceTree <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;&lt;group&gt;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">9</span>};
</code></pre></div><p>项目中并不存在真实的 <code>Framework</code> 文件夹，所以无需指定 path。另外注意，mainGroup 既没有 name 也没有 path，大家可以思考一下原因。</p>
<h1 id="通过代码编辑-xcode-工程">通过代码编辑 Xcode 工程</h1>
<p>最后一章，一起来实践一下简单的功能。</p>
<h2 id="为-xcode-工程添加文件">为 Xcode 工程添加文件</h2>
<h3 id="0x01-添加源文件">0x01 添加源文件</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">1</span>project <span style="color:#719e07">=</span> <span style="color:#cb4b16">Xcodeproj</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Project</span><span style="color:#719e07">.</span>open(path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">2</span>target <span style="color:#719e07">=</span> project<span style="color:#719e07">.</span>targets<span style="color:#719e07">.</span>first
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">3</span>group <span style="color:#719e07">=</span> project<span style="color:#719e07">.</span>main_group<span style="color:#719e07">.</span>find_subpath(<span style="color:#cb4b16">File</span><span style="color:#719e07">.</span>join(<span style="color:#2aa198">&#39;Xcodeproj&#39;</span>, <span style="color:#2aa198">&#39;Test&#39;</span>), <span style="color:#719e07">true</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">4</span>group<span style="color:#719e07">.</span>set_source_tree(<span style="color:#2aa198">&#39;SOURCE_ROOT&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">5</span>file_ref <span style="color:#719e07">=</span> group<span style="color:#719e07">.</span>new_reference(file_path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">6</span>target<span style="color:#719e07">.</span>add_file_references(<span style="color:#719e07">[</span>file_ref<span style="color:#719e07">]</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">7</span>project<span style="color:#719e07">.</span>save
</code></pre></div><p>给 Xcode 工程添加文件算是常规操作。这段代码引用自 <a href="https://draveness.me/bei-xcodeproj-keng-de-zhe-ji-tian/">draveness 的文章</a>，作者对每一步都做了详细的解释了。我们从代码角度重点说一下 <code>new_reference</code> 和 <code>add_file_references</code>。</p>
<p><strong>PBXGroup::new_references</strong></p>
<p>Xcode 工程会指定 main_group 作为项目资源的入口，所添加的文件资源需要先加入 main_group 内，以生成对应的 <code>PBXFileReference</code>，这样 target 任务和 buildPhase 等配置才能访问该资源。因此，<code>new_reference</code> 核心是 <code>new_file_reference</code> 代码如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">new_reference</span>(group, path, source_tree)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  ref <span style="color:#719e07">=</span> <span style="color:#719e07">case</span> <span style="color:#cb4b16">File</span><span style="color:#719e07">.</span>extname(path)<span style="color:#719e07">.</span>downcase
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>        <span style="color:#719e07">when</span> <span style="color:#2aa198">&#39;.xcdatamodeld&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>          new_xcdatamodeld(group, path, source_tree)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>        <span style="color:#719e07">when</span> <span style="color:#2aa198">&#39;.xcodeproj&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>          new_subproject(group, path, source_tree)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>        <span style="color:#719e07">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>          new_file_reference(group, path, source_tree)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>        <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>  configure_defaults_for_file_reference(ref)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>  ref
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span><span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span><span style="color:#719e07">def</span> <span style="color:#268bd2">new_file_reference</span>(group, path, source_tree)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>  path <span style="color:#719e07">=</span> <span style="color:#cb4b16">Pathname</span><span style="color:#719e07">.</span>new(path)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>  ref <span style="color:#719e07">=</span> group<span style="color:#719e07">.</span>project<span style="color:#719e07">.</span>new(<span style="color:#cb4b16">PBXFileReference</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>  group<span style="color:#719e07">.</span>children <span style="color:#719e07">&lt;&lt;</span> ref
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  <span style="color:#cb4b16">GroupableHelper</span><span style="color:#719e07">.</span>set_path_with_source_tree(ref, path, source_tree)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span>  ref<span style="color:#719e07">.</span>set_last_known_file_type
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21</span>  ref
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22</span><span style="color:#719e07">end</span>
</code></pre></div><p><strong>PBXNativeTarget::add_file_references</strong></p>
<p>加入文件资源后，便可将其加入对应的构建任务中去。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#719e07">def</span> <span style="color:#268bd2">add_file_references</span>(file_references, compiler_flags <span style="color:#719e07">=</span> {})
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>  file_references<span style="color:#719e07">.</span>map <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>file<span style="color:#719e07">|</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>    extension <span style="color:#719e07">=</span> <span style="color:#cb4b16">File</span><span style="color:#719e07">.</span>extname(file<span style="color:#719e07">.</span>path)<span style="color:#719e07">.</span>downcase
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>    header_extensions <span style="color:#719e07">=</span> <span style="color:#cb4b16">Constants</span><span style="color:#719e07">::</span><span style="color:#cb4b16">HEADER_FILES_EXTENSIONS</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span>    <span style="color:#586e75"># 依据资源类型区分是头文件还是源文件 </span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>    is_header_phase <span style="color:#719e07">=</span> header_extensions<span style="color:#719e07">.</span>include?(extension)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>    phase <span style="color:#719e07">=</span> is_header_phase ? headers_build_phase : source_build_phase
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span>    <span style="color:#586e75"># 将文件资源作为编译资源加入到编译源中</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>    <span style="color:#719e07">unless</span> build_file <span style="color:#719e07">=</span> phase<span style="color:#719e07">.</span>build_file(file)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>      build_file <span style="color:#719e07">=</span> project<span style="color:#719e07">.</span>new(<span style="color:#cb4b16">PBXBuildFile</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12</span>      build_file<span style="color:#719e07">.</span>file_ref <span style="color:#719e07">=</span> file
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13</span>      phase<span style="color:#719e07">.</span>files <span style="color:#719e07">&lt;&lt;</span> build_file
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14</span>    <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15</span>	 <span style="color:#719e07">...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16</span>    <span style="color:#719e07">yield</span> build_file <span style="color:#719e07">if</span> <span style="color:#b58900">block_given?</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18</span>    build_file
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19</span>  <span style="color:#719e07">end</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20</span><span style="color:#719e07">end</span>
</code></pre></div><h3 id="0x02-添加编译依赖">0x02 添加编译依赖</h3>
<p>这里的编译依赖是指，依赖的 framework、library、bundle。不同于文件，他有均有对应的虚拟 group。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1</span><span style="color:#586e75"># 添加 framework 引用</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2</span>file_ref <span style="color:#719e07">=</span> project<span style="color:#719e07">.</span>frameworks_group<span style="color:#719e07">.</span>new_file(<span style="color:#2aa198">&#39;path/to/A.framework&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3</span>target<span style="color:#719e07">.</span>frameworks_build_phases<span style="color:#719e07">.</span>add_file_reference(file_ref)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5</span><span style="color:#586e75"># 添加 libA.a 引用</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6</span>file_ref <span style="color:#719e07">=</span> project<span style="color:#719e07">.</span>frameworks_group<span style="color:#719e07">.</span>new_file(<span style="color:#2aa198">&#39;path/to/libA.a&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7</span>target<span style="color:#719e07">.</span>frameworks_build_phases<span style="color:#719e07">.</span>add_file_reference(file_ref)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9</span><span style="color:#586e75"># 添加 bundle 引用</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10</span>file_ref <span style="color:#719e07">=</span> project<span style="color:#719e07">.</span>frameworks_group<span style="color:#719e07">.</span>new_file(<span style="color:#2aa198">&#39;path/to/xxx.bundle&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11</span>target<span style="color:#719e07">.</span>resources_build_phase<span style="color:#719e07">.</span>add_file_reference(file_ref)
</code></pre></div><p>大家有兴趣可以看看 CocoaPods 是如何配置 <code>Pods.project</code>，为 Pod  生成对应 target，入口在 <code>Installer::generate_pods_project</code> 处。</p>
<h1 id="总结">总结</h1>
<p><strong>Xcode 通过 project.pbxproj，在文件系统之上又抽象出基于 <code>PBXFileReference</code> 和 <code>PBXGroup</code> 的任务构建系统</strong>。对于这一操作一直是不能理解的。为什么不像其他 IDE 一样直接使用项目的文件目录，而是另起炉灶搞了一套似乎并不好用构建件系统呢 ？</p>
<p>在了解完 <code>project.pbxproj</code> 和 Xcodeproj 后，似乎能理解一些设计者的意图。</p>
<p>假设你参与的是一个多人合作的超大型项目 (Project)，它将同时存在多个子任务 (Target)，同时这些任务之间可能存在大量交叉的资源依赖。这些资源不限于  File、Framework、Target、Project。如果我们直接基于文件路径来记录这些资源及其依赖关系，那么当资源发生产生变化时，将会产生大量的修改，例如文件路径变更。</p>
<p>这其实是不能接受的。而有了 <code>PBXFileReference</code> 的存在，任务构建者只需关心 <code>PBXFileReference</code> 这唯一引用，无需在意它背后的文件是否存在，路径是否正确，甚至是内容是否变更，这些都不重要。<strong>通过 <code>PBXFileReference</code> 这层隔离，实现了任务的构建行为及资源关系的固化。</strong></p>
<h1 id="知识点问题梳理">知识点问题梳理</h1>
<p>这里罗列了五个问题用来考察你是否已经掌握了这篇文章，如果没有建议你加入<strong>收藏</strong>再次阅读：</p>
<ol>
<li>说说 <code>xcworkspace</code> 和 <code>xcodeproj</code> 本质是什么，有什么区别 ？</li>
<li><code>pbxproj</code> 中 <code>isa</code> 关键字的作用，有哪些类型 ？</li>
<li>说说 <code>pbxproj</code> 中是如何定义和引用源文件的 ？</li>
<li><code>pbxproj</code> 如何映射为 Xcodeproj 中的对象的 ？</li>
<li>谈谈你对 <code>PBXGroup</code> 和 <code>PBXFileReference</code> 的理解 ？</li>
</ol>
</section>

  
  
  <footer class="post-tags">
     
    <a href="https://looseyi.github.io/tags/cocoapods">CocoaPods</a>
     
    <a href="https://looseyi.github.io/tags/ios">iOS</a>
     
    <a href="https://looseyi.github.io/tags/ruby">Ruby</a>
    
  </footer>
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://looseyi.github.io/post/wwdc/wwdc21/wwdc21-session-10019/"><span>←</span><span>WWDC21 - Discover concurrency in SwiftUI</span></a>
     
    <a class="next" href="https://looseyi.github.io/post/sourcecode-cocoapods/07-cocoapods-molinillo/"><span>7. Molinillo 依赖校验</span><span>→</span></a>
    
  </nav>
  

  
  
</article>


			

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

		</main>

    <footer class="footer">
  <p>&copy; 2021 <a href="https://looseyi.github.io/">Aha Edmond</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

		


  </body>
</html>
