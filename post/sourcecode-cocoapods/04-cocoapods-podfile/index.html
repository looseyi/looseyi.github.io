<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>4. Podfile 的解析逻辑 - </title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="土土Edmond木" /><meta name="description" content="引子 在上文 CocoaPods 命令解析 中，我们通过对 CLAide 的源码分析，了解了 CocoaPods 是如何处理 pod 命令，多级命令又是如何组织和嵌套的，并解释了命令行输出所代表的含义。今天" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.71.1 with theme even" />


<link rel="canonical" href="http://looseyi.github.io/post/sourcecode-cocoapods/04-cocoapods-podfile/" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/04-cocoapods-podfile/index.xml" rel="alternate" type="application/rss+xml" title="" />
  <link href="http://looseyi.github.io/post/sourcecode-cocoapods/04-cocoapods-podfile/index.xml" rel="feed" type="application/rss+xml" title="" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="4. Podfile 的解析逻辑" />
<meta property="og:description" content="引子 在上文 CocoaPods 命令解析 中，我们通过对 CLAide 的源码分析，了解了 CocoaPods 是如何处理 pod 命令，多级命令又是如何组织和嵌套的，并解释了命令行输出所代表的含义。今天" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://looseyi.github.io/post/sourcecode-cocoapods/04-cocoapods-podfile/" />
<meta property="article:published_time" content="2020-09-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-09-17T00:00:00+00:00" />
<meta itemprop="name" content="4. Podfile 的解析逻辑">
<meta itemprop="description" content="引子 在上文 CocoaPods 命令解析 中，我们通过对 CLAide 的源码分析，了解了 CocoaPods 是如何处理 pod 命令，多级命令又是如何组织和嵌套的，并解释了命令行输出所代表的含义。今天">
<meta itemprop="datePublished" content="2020-09-17T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-09-17T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="5926">



<meta itemprop="keywords" content="CocoaPods,iOS,Ruby," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="4. Podfile 的解析逻辑"/>
<meta name="twitter:description" content="引子 在上文 CocoaPods 命令解析 中，我们通过对 CLAide 的源码分析，了解了 CocoaPods 是如何处理 pod 命令，多级命令又是如何组织和嵌套的，并解释了命令行输出所代表的含义。今天"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Aha Moment</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Aha Moment</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">4. Podfile 的解析逻辑</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-09-17 </span>
        <div class="post-category">
            <a href="/categories/ios/"> iOS </a>
            <a href="/categories/cocoapods/"> CocoaPods </a>
            </div>
          <span class="more-meta"> 约 5926 字 </span>
          <span class="more-meta"> 预计阅读 12 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#target---最小可编译单元">Target - 最小可编译单元</a></li>
    <li><a href="#project---targets-的载体">Project - Targets 的载体</a></li>
    <li><a href="#workspace---容器">Workspace - 容器</a></li>
    <li><a href="#scheme---描述-build-过程">Scheme - 描述 Build 过程</a></li>
  </ul>

  <ul>
    <li><a href="#cocoapods-core-的文件构成">CocoaPods-Core 的文件构成</a></li>
    <li><a href="#podfile-的主要数据结构">Podfile 的主要数据结构</a>
      <ul>
        <li><a href="#specification">Specification</a></li>
        <li><a href="#targetdefinition">TargetDefinition</a></li>
        <li><a href="#podfile">Podfile</a></li>
        <li><a href="#lockfile">Lockfile</a></li>
      </ul>
    </li>
    <li><a href="#podfile-内容加载">Podfile 内容加载</a>
      <ul>
        <li><a href="#podfile-文件类型">Podfile 文件类型</a></li>
        <li><a href="#podfile-文件读取">Podfile 文件读取</a></li>
        <li><a href="#podfile-from-ruby-解析">Podfile From Ruby 解析</a></li>
        <li><a href="#podfile-from-yaml-解析">Podfile From YAML 解析</a></li>
      </ul>
    </li>
    <li><a href="#podfile-内容解析">Podfile 内容解析</a></li>
  </ul>

  <ul>
    <li><a href="#target-嵌套">Target 嵌套</a></li>
    <li><a href="#abstract-target">Abstract Target</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="引子">引子</h1>
<p>在上文 <a href="https://zhuanlan.zhihu.com/p/212101448">CocoaPods 命令解析</a> 中，我们通过对 <strong>CLAide</strong> 的源码分析，了解了 CocoaPods 是如何处理 <code>pod</code> 命令，多级命令又是如何组织和嵌套的，并解释了命令行输出所代表的含义。今天我们开始学习 <code>Podfile</code> 。</p>
<p>大多 iOS 工程师最先接触到的 CocoaPods 概念应该是 <code>Podfile</code>，而 <code>Podfile</code> 属于 <code>cocoapods-core</code>（以下简称 <strong>Core</strong>） 的两大概念之一。另外一个则是 <a href="https://guides.cocoapods.org/syntax/podspec.html"><code>Podspec</code></a> (用于描述 Pod Library 的配置文件)，只有当你需要开发 Pod 组件的时候才会接触。</p>
<p>在介绍 Podfile 的内容结构之前，必须要谈谈 Xcode 的工程结构。</p>
<h1 id="xcode-工程结构">Xcode 工程结构</h1>
<p>我们先来看一个极简 Podfile 声明：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">target</span> <span class="s1">&#39;Demo&#39;</span> <span class="k">do</span>
  <span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;./Alamofire&#39;</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>它编译后的工程目录如下：</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cgy1gji200f30rj20o005haal.jpg" alt="02-xcode-structure"></p>
<p>如你所见 Podfile 的配置是围绕 Xcode 的这些工程结构：<strong>Workspace、Project、Target 及 Build Setting</strong> 来展开的。
作为包管理工具 CocoaPods 将所管理的 Pods 依赖库组装成一个个 Target，统一放入 <code>Pods.project</code> 中的 <code>Demo target</code>，并自动配置好 Target 间的依赖关系。</p>
<p>之后将 <code>Example.project</code> 主工程和 <code>Pods.project</code> 工程一起打包到新建的 <code>Example.workspace</code>，配好主工程与 <code>Pods</code> 工程之间的依赖，完成最终转换。</p>
<p>接下来，我们来聊一聊这些 Xcode 结构：</p>
<h2 id="target---最小可编译单元">Target - 最小可编译单元</h2>
<blockquote>
<p>A <a href="https://developer.apple.com/library/archive/featuredarticles/XcodeConcepts/Concept-Targets.html#//apple_ref/doc/uid/TP40009328-CH4-SW1">target</a> specifies a product to build and contains the instructions for building the product from a set of files in a project or workspace.</p>
</blockquote>
<p><strong>首先是 Target，它作为工程中最小的可编译单元，根据 <a href="https://www.objc.io/issues/6-build-tools/build-process/#controlling-the-build-process">Build Phases</a> 和 <a href="https://developer.apple.com/library/archive/featuredarticles/XcodeConcepts/Concept-Build_Settings.html#//apple_ref/doc/uid/TP40009328-CH6-SW1">Build Settings</a> 将源码作为输入，经编译后输出结果产物。</strong>
其输出结果可以是链接库、可执行文件或者资源包等，具体细节如下：</p>
<ul>
<li>Build Setting：比如指定使用的编译器，目标平台、编译参数、头文件搜索路径等；</li>
<li>Build 时的前置依赖、执行的脚本文件；</li>
<li>Build 生成目标的签名、Capabilities 等属性；</li>
<li>Input：哪些源码或者资源文件会被编译打包；</li>
<li>Output：哪些静态库、动态库会被链接；</li>
</ul>
<h2 id="project---targets-的载体">Project - Targets 的载体</h2>
<blockquote>
<p>An <a href="https://developer.apple.com/library/archive/featuredarticles/XcodeConcepts/Concept-Projects.html#//apple_ref/doc/uid/TP40009328-CH5-SW1">Xcode project</a> is a repository for all the files, resources, and information required to build one or more software products.</p>
</blockquote>
<p><strong>Project 就是一个独立的 Xcode 工程，作为一个或多个 Targets 的资源管理器，本身无法被编译。</strong>
Project 所管理的资源都来自它所包含的 Targets。特点如下：</p>
<ul>
<li>至少包含一个或多个可编译的 Target；</li>
<li>为所包含的 Targets 定义了一份默认编译选项，如果 Target 有自己的配置，则会覆盖 Project 的预设值；</li>
<li>能将其他 Project 作为依赖嵌入其中；</li>
</ul>
<p>下图为 Project 与所包含对 Targets 的关系：</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cgy1gji272r51bj21nk0q8wq4.jpg" alt="03-xcode-project"></p>
<h2 id="workspace---容器">Workspace - 容器</h2>
<blockquote>
<p>A <a href="https://developer.apple.com/library/archive/featuredarticles/XcodeConcepts/Concept-Workspace.html">workspace</a> is an Xcode document that groups projects</p>
</blockquote>
<p><strong>作为纯粹的项目容器，Workspace 不参与任何编译链接过程，仅用于管理同层级的 Project</strong>，其特点：</p>
<ul>
<li><strong>Workspace 可以包含多个 Projects</strong>；</li>
<li>同一个 Workspace 中的 Proejct 文件对于其他 Project 是默认可见的，<strong>这些 Projcts 会共享 <code>workspace build directory</code></strong> ；</li>
<li>一个 Xcode Project 可以被包含在多个不同的 Workspace 中，因为每个 Project 都有独立的 Identity，默认是 Project Name；</li>
</ul>
<p><img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1599993134181-70da3da0-70d6-46ff-b9ad-358e77f64466.jpeg#align=left&amp;display=inline&amp;height=309&amp;margin=%5Bobject%20Object%5D&amp;originHeight=309&amp;originWidth=532&amp;size=0&amp;status=done&amp;style=none&amp;width=532#align=left&amp;display=inline&amp;height=309&amp;margin=%5Bobject%20Object%5D&amp;originHeight=309&amp;originWidth=532&amp;status=done&amp;style=none&amp;width=532" alt=""></p>
<h2 id="scheme---描述-build-过程">Scheme - 描述 Build 过程</h2>
<blockquote>
<p>An <a href="https://developer.apple.com/library/archive/featuredarticles/XcodeConcepts/Concept-Schemes.html">Xcode scheme</a> defines a collection of targets to build, a configuration to use when building, and a collection of tests to execute.</p>
</blockquote>
<p><strong>Scheme 是对于整个 Build 过程的一个抽象</strong>，它描述了 Xcode 应该使用哪种 <a href="https://medium.com/practical-ios-development/some-practical-uses-for-xcode-build-schemes-and-build-configurations-swift-e50d15a1304f">Build Configurations</a> 、执行什么任务、环境参数等来构建我们所需的 Target。</p>
<p>Scheme 中预设了六个主要过程： <strong>Build、Run、Test、Profile、Analyze、Archive</strong>。包括了我们对 Target 的所有操作，每一个过程都可以单独配置。</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cgy1gji27cghb4j21nk11kwsz.jpg" alt="05-xcode-scheme"></p>
<h1 id="cocoapods-core">CocoaPods-Core</h1>
<blockquote>
<p>The <a href="https://link.zhihu.com/?target=https%3A//github.com/CocoaPods/Core">CocoaPods-Core</a> gem provides support to work with the models of CocoaPods, for example the Podspecs or the Podfile.</p>
</blockquote>
<p>CocoaPods-Core 用于 CocoaPods 中配置文件的解析，包括 <code>Podfile</code>、<code>Podspec</code> 以及解析后的依赖锁存文件，如 Podfile.lock 等。</p>
<h2 id="cocoapods-core-的文件构成">CocoaPods-Core 的文件构成</h2>
<p>照例，我们先通过入口文件 <code>lib/cocoapods-core.rb</code> 来一窥 Core 项目的主要文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>
  <span class="nb">require</span> <span class="s1">&#39;cocoapods-core/gem_version&#39;</span>

  <span class="k">class</span> <span class="nc">PlainInformative</span> <span class="o">&lt;</span> <span class="no">StandardError</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">class</span> <span class="nc">Informative</span> <span class="o">&lt;</span> <span class="no">PlainInformative</span><span class="p">;</span> <span class="k">end</span>

  <span class="nb">require</span> <span class="s1">&#39;pathname&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;cocoapods-core/vendor&#39;</span>
   
  <span class="c1"># 用于存储 PodSpec 中的版本号</span>
  <span class="nb">autoload</span> <span class="ss">:Version</span><span class="p">,</span>        <span class="s1">&#39;cocoapods-core/version&#39;</span>
  <span class="c1"># pod 的版本限制</span>
  <span class="nb">autoload</span> <span class="ss">:Requirement</span><span class="p">,</span>    <span class="s1">&#39;cocoapods-core/requirement&#39;</span>
  <span class="c1"># 配置 Podfile 或 PodSpec 中的 pod 依赖</span>
  <span class="nb">autoload</span> <span class="ss">:Dependency</span><span class="p">,</span>     <span class="s1">&#39;cocoapods-core/dependency&#39;</span>
  <span class="c1"># 获取 Github 仓库信息</span>
  <span class="nb">autoload</span> <span class="ss">:GitHub</span><span class="p">,</span>         <span class="s1">&#39;cocoapods-core/github&#39;</span>
  <span class="c1"># 处理 HTTP 请求</span>
  <span class="nb">autoload</span> <span class="ss">:HTTP</span><span class="p">,</span>           <span class="s1">&#39;cocoapods-core/http&#39;</span>
  <span class="c1"># 记录最终 pod 的依赖信息</span>
  <span class="nb">autoload</span> <span class="ss">:Lockfile</span><span class="p">,</span>       <span class="s1">&#39;cocoapods-core/lockfile&#39;</span>
  <span class="c1"># 记录 SDK 的名称和 target 版本</span>
  <span class="nb">autoload</span> <span class="ss">:Platform</span><span class="p">,</span>       <span class="s1">&#39;cocoapods-core/platform&#39;</span>
  <span class="c1"># 对应 Podfile 文件的 class</span>
  <span class="nb">autoload</span> <span class="ss">:Podfile</span><span class="p">,</span>        <span class="s1">&#39;cocoapods-core/podfile&#39;</span>
  <span class="c1"># 管理 PodSpec 的集合</span>
  <span class="nb">autoload</span> <span class="ss">:Source</span><span class="p">,</span>         <span class="s1">&#39;cocoapods-core/source&#39;</span>
  <span class="c1"># 管理基于 CDN 来源的 PodSpec 集合</span>
  <span class="nb">autoload</span> <span class="ss">:CDNSource</span><span class="p">,</span>      <span class="s1">&#39;cocoapods-core/cdn_source&#39;</span>
  <span class="c1"># 管理基于 Trunk 来源的 PodSpec 集合</span>
  <span class="nb">autoload</span> <span class="ss">:TrunkSource</span><span class="p">,</span>    <span class="s1">&#39;cocoapods-core/trunk_source&#39;</span>
  <span class="c1"># 对应 PodSpec 文件的 class</span>
  <span class="nb">autoload</span> <span class="ss">:Specification</span><span class="p">,</span>  <span class="s1">&#39;cocoapods-core/specification&#39;</span>
  <span class="c1"># 将 pod 信息转为 .yml 文件，用于 lockfile 的序列化</span>
  <span class="nb">autoload</span> <span class="ss">:YAMLHelper</span><span class="p">,</span>     <span class="s1">&#39;cocoapods-core/yaml_helper&#39;</span>
  <span class="c1"># 记录 pod 依赖类型，是静态库/动态库</span>
  <span class="nb">autoload</span> <span class="ss">:BuildType</span><span class="p">,</span>      <span class="s1">&#39;cocoapods-core/build_type&#39;</span>
  
  <span class="o">...</span>

  <span class="no">Spec</span> <span class="o">=</span> <span class="no">Specification</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>将这些 Model 类按照对应的依赖关系进行划分，层级如下：</p>
<p><img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1599993134206-3a7f8fdb-611d-44c1-a2c4-026365408d5e.jpeg?x-oss-process=image%2Fresize%2Cw_746#align=left&amp;display=inline&amp;height=384&amp;margin=%5Bobject%20Object%5D&amp;originHeight=384&amp;originWidth=783&amp;size=0&amp;status=done&amp;style=none&amp;width=783" alt=""></p>
<h2 id="podfile-的主要数据结构">Podfile 的主要数据结构</h2>
<p>先来了解 Podfile 的主要数据结构</p>
<h3 id="specification">Specification</h3>
<blockquote>
<p>The Specification provides a DSL to describe a Pod. A pod is defined as a library originating from a source. A specification can support detailed attributes for modules of code  through subspecs.</p>
</blockquote>
<p>Specification 即存储 <code>PodSpec</code> 的内容，是用于<strong>描述一个 Pod 库的源代码和资源将如何被打包编译成链接库或 framework</strong>，后续将会介绍更多的细节。</p>
<h3 id="targetdefinition">TargetDefinition</h3>
<blockquote>
<p>The TargetDefinition stores the information of a CocoaPods static library. The target definition can be linked with one or more targets of the user project.</p>
</blockquote>
<p><code>TargetDefinition</code> 是一个多叉树结构，每个节点记录着 <code>Podfile</code> 中定义的 Pod 的 Source 来源、Build Setting、Pod 子依赖等。该树的根节点指向 <code>Podfile</code>，而 <code>Podfile</code> 中的 <code>root_target_definitions</code> 则记录着所有的 <code>TargetDefinition</code> 的根节点，正常情况下该 list 中只有一个 root 即 <strong><code>Pods.project</code></strong>。</p>
<p>为了便于阅读，简化了大量的 DSL 配置相关的方法和属性并对代码顺序做了调整，大致结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Podfile</span>
    <span class="k">class</span> <span class="nc">TargetDefinition</span>
		<span class="c1"># 父节点: TargetDefinition 或者 Podfile</span>
      <span class="kp">attr_reader</span> <span class="ss">:parent</span>
      <span class="c1"># 子节点: TargetDefinition</span>
      <span class="kp">attr_reader</span> <span class="ss">:children</span>
      <span class="c1"># 记录 tareget 的配置信息</span>
      <span class="kp">attr_accessor</span> <span class="ss">:internal_hash</span>

      <span class="k">def</span> <span class="nf">root?</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Podfile</span><span class="p">)</span> <span class="o">||</span> <span class="n">parent</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">root</span>
        <span class="k">if</span> <span class="n">root?</span>
          <span class="nb">self</span>
        <span class="k">else</span>
          <span class="n">parent</span><span class="o">.</span><span class="n">root</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">podfile</span>
        <span class="n">root</span><span class="o">.</span><span class="n">parent</span>
      <span class="k">end</span>
       
      <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>对应上一节 Xcode 工程结构中的 <code>Podfile</code> 关系如下：</p>
<p><img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1599993134189-fdfc2639-938d-47c7-ad69-1a8141502f8f.jpeg#align=left&amp;display=inline&amp;height=280&amp;margin=%5Bobject%20Object%5D&amp;originHeight=280&amp;originWidth=357&amp;size=0&amp;status=done&amp;style=none&amp;width=357#align=left&amp;display=inline&amp;height=280&amp;margin=%5Bobject%20Object%5D&amp;originHeight=280&amp;originWidth=357&amp;status=done&amp;style=none&amp;width=357" alt=""></p>
<p>CocoaPods 正是巧妙利用了 Xcode 工程结构的特点，引入  <code>Pods.project</code> 这一中间层，将主工程的 Pods 依赖全部转接到 <code>Pods.project</code> 上，最后再将 <code>Pods.project</code> 作为主项目的依赖。尽管这么做也受到了一些质疑和诟病（所谓的侵入性太强），但笔者的观点是，正得益于 <code>Pods.project</code> 这一设计隔绝了第三方依赖库对于主项目的频繁更改，也便于后续的管理和更新，体现了软件工程中的<strong>开放-关闭原则</strong>。</p>
<p>比如，在 Pod 1.7.0 版本中支持的 <strong><a href="http://blog.cocoapods.org/CocoaPods-1.7.0-beta/">Multiple Xcodeproj Generation</a></strong> 就是解决随着项目的迭代而日益增大的 <code>Pods.project</code> 的问题。试想当你的项目中存在上百个依赖库，每个依赖库的变更都会影响到你的主工程，这将是非常可怕的事情。</p>
<h3 id="podfile">Podfile</h3>
<blockquote>
<p>The Podfile is a specification that describes the dependencies of the targets of one or more Xcode projects.</p>
</blockquote>
<p><code>Podfile</code> 是用于描述一个或多个 Xcode Project 中各个 Targets 之间的依赖关系。</p>
<p>这些 Targets 的依赖关系对应的就是 <code>TargetDefinition</code> 树中的各子节点的层级关系。如前面所说，<strong>有了 <code>Podfile</code> 这个根节点的指向，仅需对依赖树进行遍历，就能轻松获取完整的依赖关系</strong>。</p>
<p>有了这层依赖树，对于某个 <code>Pod</code> 库的更新即是对树节点的更新，便可轻松的分析出此次更新涉及的影响。</p>
<p>简化调整后的 Podfile 代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;cocoapods-core/podfile/dsl&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;cocoapods-core/podfile/target_definition&#39;</span>

<span class="k">module</span> <span class="nn">Pod</span>
  <span class="k">class</span> <span class="nc">Podfile</span>

    <span class="kp">include</span> <span class="no">Pod</span><span class="o">::</span><span class="no">Podfile</span><span class="o">::</span><span class="no">DSL</span>
    <span class="c1"># podfile 路径</span>
    <span class="kp">attr_accessor</span> <span class="ss">:defined_in_file</span>
    <span class="c1"># 所有的 TargetDefinition 的根节点, 正常只有一个，即 Pods.project target</span>
    <span class="kp">attr_accessor</span> <span class="ss">:root_target_definitions</span>
    <span class="c1"># 记录 Pods.project 项目的配置信息</span>
    <span class="kp">attr_accessor</span> <span class="ss">:internal_hash</span>
    <span class="c1"># 当前 DSL 解析使用的 TargetDefinition</span>
    <span class="kp">attr_accessor</span> <span class="ss">:current_target_definition</span>

    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>直接看 <code>dsl.rb</code>，该文件内部定义了 Podfile DSL 支持的所有方法。通过 <strong>include</strong> 的使用将 <code>Pod::Podfile::DSL</code> 模块 Mix-in 后插入到 Podfile 类中。
想了解更多 Mix-in 特性，移步 <a href="https://mp.weixin.qq.com/s?__biz=MzA5MTM1NTc2Ng==&amp;mid=2458324049&amp;idx=1&amp;sn=8de53f46fbc52427cdb660b427cb8226&amp;chksm=870e0348b0798a5ed6d14715cc4a1af93cd168a5e15198acfb3b84ea49506b0f815fa891d683&amp;token=883887783&amp;lang=zh_CN#rd">Ruby 特性之 Mix-in</a>。</p>
<h3 id="lockfile">Lockfile</h3>
<blockquote>
<p>The Lockfile stores information about the pods that were installed by  CocoaPods.</p>
</blockquote>
<p><strong>Lockfile，顾名思义是用于记录最后一次 CocoaPods 所安装的 Pod 依赖库版本的信息快照。也就是生成的 <strong><code>Podfile.lock</code></strong>。</strong></p>
<p>在 <code>pod install</code> 过程，Podfile 会结合它来确认最终所安装的 Pod 版本，固定 Pod 依赖库版本防止其自动更新。Lockfile 也作为 Pods 状态清单 (mainfest)，用于记录安装过程的中哪些 Pod 需要被删除或安装或更新等。</p>
<p>以开头的 Podfile 经 <code>pod install</code> 所生成的 <code>Podfile.lock</code> 为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="ss">PODS</span><span class="p">:</span>
  <span class="o">-</span> <span class="no">Alamofire</span> <span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="mi">6</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

<span class="ss">DEPENDENCIES</span><span class="p">:</span>
  <span class="o">-</span> <span class="no">Alamofire</span> <span class="p">(</span><span class="n">from</span> <span class="sb">`./Alamofire`</span><span class="p">)</span>

<span class="no">EXTERNAL</span> <span class="ss">SOURCES</span><span class="p">:</span>
  <span class="ss">Alamofire</span><span class="p">:</span>
    <span class="ss">:path</span><span class="p">:</span> <span class="s2">&#34;./Alamofire&#34;</span>

<span class="no">SPEC</span> <span class="ss">CHECKSUMS</span><span class="p">:</span>
  <span class="ss">Alamofire</span><span class="p">:</span> <span class="mi">0</span><span class="n">dda98a0ed7eec4bdcd5fe3cdd35fcd2b3022825</span>

<span class="no">PODFILE</span> <span class="ss">CHECKSUM</span><span class="p">:</span> <span class="n">da12cc12a30cfb48ebc5d14e8f51737ab65e8241</span>

<span class="ss">COCOAPODS</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="mi">2</span>
</code></pre></td></tr></table>
</div>
</div><p>我们来分析一下，通过该 Lockfile 能够获取哪些信息：</p>
<table>
<thead>
<tr>
<th><strong>Key</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PODS</strong></td>
<td>记录所有 Pod 库的具体安装版本号</td>
</tr>
<tr>
<td><strong>DEPENDENCIES</strong></td>
<td>记录各 Pod 库之间的相互依赖关系，由于这里只有 Alamofire 且它无其他依赖，暂时无关看出区别</td>
</tr>
<tr>
<td><strong>EXTERNAL SOURCES</strong></td>
<td>记录部分通过外部源的 Pod 库（Git 引入、Path 引入）</td>
</tr>
<tr>
<td><strong>SPEC CHECKSUMS</strong></td>
<td>记录当前各 Pod 库的 Podspec 文件 Hash 值，其实就是文件的 md5</td>
</tr>
<tr>
<td><strong>PODFILE CHECKSUM</strong></td>
<td>记录 Podfile 文件的 Hash 值，同样是 md5，确认是否有变更</td>
</tr>
<tr>
<td><strong>COCOAPODS</strong></td>
<td>记录上次所使用的 CocoaPods 版本</td>
</tr>
</tbody>
</table>
<h2 id="podfile-内容加载">Podfile 内容加载</h2>
<h3 id="podfile-文件类型">Podfile 文件类型</h3>
<p>你可以在 CocoaPods 的 <code>/lib/cocoapods/config.rb</code> 找到 Podfile 所支持的文件类型：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">PODFILE_NAMES</span> <span class="o">=</span> <span class="o">[</span>
   <span class="s1">&#39;CocoaPods.podfile.yaml&#39;</span><span class="p">,</span>
   <span class="s1">&#39;CocoaPods.podfile&#39;</span><span class="p">,</span>
   <span class="s1">&#39;Podfile&#39;</span><span class="p">,</span>
   <span class="s1">&#39;Podfile.rb&#39;</span><span class="p">,</span>
<span class="o">].</span><span class="n">freeze</span>
</code></pre></td></tr></table>
</div>
</div><p>CocoaPods 按照上述命名优先级来查找工程目录下所对应的 Podfile 文件。当发现目录中存在 <strong>CocoaPods.podfile.yaml</strong> 文件时会优先加载。很多同学可能只知道到 Podfile 支持 Ruby 的文件格式，而不了解它还支持了 YAML 格式。YAML 是 <code>YAML Ain't Markup Language</code> 的缩写，其 <a href="https://yaml.org/">官方定义</a>：</p>
<blockquote>
<p>YAML is a human friendly data serialization standard for all programming languages.</p>
</blockquote>
<p>它是一种面向工程师友好的序列化语言。我们的 Lockfile 文件就是以 YAML 格式写入 <code>Podfile.lock</code> 中的。</p>
<h3 id="podfile-文件读取">Podfile 文件读取</h3>
<p>回到 <code>lib/cocoapods-core/podfile.rb</code> 来看读取方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Pod</span>

  <span class="k">class</span> <span class="nc">Podfile</span>

    <span class="kp">include</span> <span class="no">Pod</span><span class="o">::</span><span class="no">Podfile</span><span class="o">::</span><span class="no">DSL</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="n">path</span> <span class="o">=</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">unless</span> <span class="n">path</span><span class="o">.</span><span class="n">exist?</span>
        <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="s2">&#34;No Podfile exists at path `</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">`.&#34;</span>
      <span class="k">end</span>

      <span class="c1"># 这里我们可以看出，Podfile 目前已经支持了结尾是 .podfile 和 .rb 后缀的文件名</span>
      <span class="c1"># 其实是为了改善很多编译器使用文件后缀来确认 filetype，比如 vim</span>
      <span class="c1"># 相比与 Podfile 这个文件名要更加的友好</span>
      <span class="k">case</span> <span class="n">path</span><span class="o">.</span><span class="n">extname</span>
      <span class="k">when</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;.podfile&#39;</span><span class="p">,</span> <span class="s1">&#39;.rb&#39;</span>
        <span class="no">Podfile</span><span class="o">.</span><span class="n">from_ruby</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">when</span> <span class="s1">&#39;.yaml&#39;</span>
        <span class="c1"># 现在也支持了 .yaml 格式</span>
        <span class="no">Podfile</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="s2">&#34;Unsupported Podfile format `</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">`.&#34;</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><code>from_file</code> 在 <code>pod install</code> 命令执行后的 <code>verify_podfile_exists!</code> 中被调用的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">verify_podfile_exists!</span>
  <span class="k">unless</span> <span class="n">config</span><span class="o">.</span><span class="n">podfile</span>
    <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="s2">&#34;No `Podfile&#39; found in the project directory.&#34;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>而 Podfile 文件的读取就是 <code>config.podfile</code>  里触发的，代码在 CocoaPods 的 <code>config.rb</code> 文件中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">podfile_path_in_dir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
  <span class="no">PODFILE_NAMES</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
    <span class="n">candidate</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">+</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">file?</span>
      <span class="k">return</span> <span class="n">candidate</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="kp">nil</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">podfile_path</span>
  <span class="vi">@podfile_path</span> <span class="o">||=</span> <span class="n">podfile_path_in_dir</span><span class="p">(</span><span class="n">installation_root</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">podfile</span>
  <span class="vi">@podfile</span> <span class="o">||=</span> <span class="no">Podfile</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">podfile_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">podfile_path</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的方法 <code>podfile</code> 和 <code>podfile_path</code> 都是 lazy 加载的。最后 Core 的 <code>from_file</code> 将依据目录下的 <code>Podfile</code> 文件类型选择调用 <code>from_yaml</code> 或者 <code>from_ruby</code>。</p>
<p>从 <code>Pod::Command::Install</code> 命令到 Podfile 文件加载的调用栈如下：</p>
<p><img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1599993134203-782e510d-c084-4b57-98fe-970f5a38cc79.jpeg#align=left&amp;display=inline&amp;height=570&amp;margin=%5Bobject%20Object%5D&amp;originHeight=570&amp;originWidth=728&amp;size=0&amp;status=done&amp;style=none&amp;width=728" alt=""></p>
<h3 id="podfile-from-ruby-解析">Podfile From Ruby 解析</h3>
<p>当我们通过 <code>pod init</code> 来初始化 CocoaPods 项目时，默认生成的 Podfile 名称就是 <code>Podfile</code>，那就从 <code>Podfile.from_ruby</code> 开始。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_ruby</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="c1"># ①</span>
  <span class="n">contents</span> <span class="o">||=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r:utf-8&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="ss">:read</span><span class="p">)</span>
  <span class="c1"># 兼容 1.9 版本的 Rubinius 中的编码问题</span>
  <span class="k">if</span> <span class="n">contents</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:encoding</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">contents</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;UTF-8&#39;</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">encode!</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 对 Podfile 中不规范的单引号或双引号进行检查，并进行自动修正，及抛出错误</span>
  <span class="k">if</span> <span class="n">contents</span><span class="o">.</span><span class="n">tr!</span><span class="p">(</span><span class="s1">&#39;“”‘’‛&#39;</span><span class="p">,</span> <span class="sx">%(&#34;&#34;&#39;&#39;&#39;)</span><span class="p">)</span>
    <span class="no">CoreUI</span><span class="o">.</span><span class="n">warn</span> <span class="s2">&#34;...&#34;</span>
  <span class="k">end</span>
  <span class="c1"># ②</span>
  <span class="n">podfile</span> <span class="o">=</span> <span class="no">Podfile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">begin</span>
      <span class="nb">eval</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">message</span> <span class="o">=</span> <span class="s2">&#34;Invalid `</span><span class="si">#{</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">` file: </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&#34;</span>
      <span class="k">raise</span> <span class="no">DSLError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">podfile</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>①</strong> 是对 Podfile 内容的读取和编码，同时对可能出现的单引号和双引号的匹配问题进行了修正。
<strong>②</strong> 以 <code>path</code> 和 <code>block</code> 为入参进行 <code>podfile</code> 类的初始化并将其放回，保存在全局的 <code>config.podfile</code> 中。</p>
<blockquote>
<p>Tips: 如果要在 Ruby 对象的初始化中传入参数，需要重载 Object 的 <a href="https://ruby-doc.org/docs/ruby-doc-bundle/UsersGuide/rg/objinitialization.html">initialize</a> 方法，这里的 Podfile.new(&hellip;) 本质上是 <code>initialize</code> 的方法调用。</p>
</blockquote>
<p><code>initialize</code> 方法所传入的尾随闭包 <code>block</code> 的核心在于内部的 <code>eval</code> 函数（在 <a href="https://zhuanlan.zhihu.com/p/187272448">CocoaPods 核心组件</a> 中有提到）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">eval</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>它将 Podfile 中的文本内容转化为方法执行，也就是说里面的参数是一段 Ruby 的代码字符串，通过 <code>eval</code> 方法可以直接执行。
继续看 Podfile 的 <code>initialize</code> 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">defined_in_file</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">internal_hash</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">defined_in_file</span> <span class="o">=</span> <span class="n">defined_in_file</span>
  <span class="vi">@internal_hash</span> <span class="o">=</span> <span class="n">internal_hash</span>
  <span class="k">if</span> <span class="n">block</span>
    <span class="n">default_target_def</span> <span class="o">=</span> <span class="no">TargetDefinition</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Pods&#39;</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
    <span class="n">default_target_def</span><span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="vi">@root_target_definitions</span> <span class="o">=</span> <span class="o">[</span><span class="n">default_target_def</span><span class="o">]</span>
    <span class="vi">@current_target_definition</span> <span class="o">=</span> <span class="n">default_target_def</span>
    <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="vi">@root_target_definitions</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>它定义了三个参数：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>defined_in_file</strong></td>
<td><code>Podfile</code> 文件路径</td>
</tr>
<tr>
<td><strong>internal_hash</strong></td>
<td>通过 yaml 序列化得到的 <code>Podfile</code> 配置信息，保存在 <code>internal_hash</code> 中</td>
</tr>
<tr>
<td><strong>block</strong></td>
<td>用于映射 <code>Podfile</code> 的 DSL 配置</td>
</tr>
</tbody>
</table>
<blockquote>
<p>需要注意的是，通过 <code>from_ruby</code> 初始化的 <code>Podfile</code> 只传入了参数 1 和 3，参数 2 <code>internal_hash</code> 则是提供给 <code>from_yaml</code> 的。</p>
</blockquote>
<p>当 <code>block</code> 存在，会初始化名为 <code>Pods</code> 的 TargetDefinition 对象，用于保存 <code>Pods project</code> 的相关信息和 Pod 依赖。然后调用 <em><a href="https://ruby-doc.org/core-2.7.0/BasicObject.html">instance_eval</a></em> 执行传入的 <code>block</code>，将 Podfile 的 DSL 内容转换成对应的方法和参数，最终将参数存入 <code>internal_hash</code> 和对应的 <code>target_definitions</code> 中。</p>
<blockquote>
<p>Tips: 在 Ruby 中存在两种不同的方式来执行代码块 <code>block</code>，分别是 <code>instance_eval</code> 和 <code>class_eval</code>。
<code>class_eval</code> 的执行上下文与调用类相关，调用者是类名或者模块名，而 <code>instance_eval</code> 的调用者可以是类的实例或者类本身。细节看 <a href="https://stackoverflow.com/questions/900419/how-to-understand-the-difference-between-class-eval-and-instance-eval">StackoverFlow</a>。</p>
</blockquote>
<h3 id="podfile-from-yaml-解析">Podfile From YAML 解析</h3>
<p>YAML 格式的 Podfile 加载需要借助 <strong>YAMLHelper</strong> 类来完成，YAMLHelper 则是基于 <a href="https://github.com/ruby/yaml">yaml</a> 的简单封装。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_yaml</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">string</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r:utf-8&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="ss">:read</span><span class="p">)</span>

  <span class="c1"># 为了解决 Rubinius incomplete encoding in 1.9 mode</span>
	<span class="c1"># https://github.com/rubinius/rubinius/issues/1539</span>
  <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:encoding</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">string</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;UTF-8&#39;</span>
    <span class="n">string</span><span class="o">.</span><span class="n">encode!</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="nb">hash</span> <span class="o">=</span> <span class="no">YAMLHelper</span><span class="o">.</span><span class="n">load_string</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="n">from_hash</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_hash</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">internal_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">dup</span>
  <span class="n">target_definitions</span> <span class="o">=</span> <span class="n">internal_hash</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;target_definitions&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">[]</span>
  <span class="n">podfile</span> <span class="o">=</span> <span class="no">Podfile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">internal_hash</span><span class="p">)</span>
  <span class="n">target_definitions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">definition_hash</span><span class="o">|</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="no">TargetDefinition</span><span class="o">.</span><span class="n">from_hash</span><span class="p">(</span><span class="n">definition_hash</span><span class="p">,</span> <span class="n">podfile</span><span class="p">)</span>
    <span class="n">podfile</span><span class="o">.</span><span class="n">root_target_definitions</span> <span class="o">&lt;&lt;</span> <span class="n">definition</span>
  <span class="k">end</span>
  <span class="n">podfile</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>通过 <code>from_yaml</code> 将文件内容转成 Ruby hash 后转入 <code>from_hash</code> 方法。</p>
<p>区别于 <code>from_ruby</code>，这里调用的 <code>initialize</code> 将读取的 hash 直接存入 <code>internal_hash</code>，然后利用 <code>TargetDefinition.from_hash</code> 来完成的 hash 内容到 targets 的转换，因此，这里无需传入 block 进行 DSL 解析和方法转换。</p>
<h2 id="podfile-内容解析">Podfile 内容解析</h2>
<p>前面提到 Podfile 的内容最终保存在 <code>internal_hash</code> 和 <code>target_definitions</code> 中，本质上都是使用了 <code>hash</code> 来保存数据。由于 YAML 文件格式的 Podfile 加载后就是 hash 对象，无需过多加工。唯一需要处理的是递归调用 TargetDefinition 的 <code>from_hash</code> 方法来解析 target 子节点的数据。</p>
<p>因此，接下来的内容解析主要针对 Ruby 文件格式的 DSL 解析，我们以 <code>pod</code> 方法为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">target</span> <span class="s1">&#39;Example&#39;</span> <span class="k">do</span>
	<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>当解析到 <code>pod 'Alamofire'</code> 时，会先通过 <code>eval(contents, nil, path.to_s</code> 将其转换为 <code>dsl.rb</code> 中的方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">pod</span><span class="p">(</span><span class="nb">name</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">*</span><span class="n">requirements</span><span class="p">)</span>
  <span class="k">unless</span> <span class="nb">name</span>
    <span class="k">raise</span> <span class="no">StandardError</span><span class="p">,</span> <span class="s1">&#39;A dependency requires a name.&#39;</span>
  <span class="k">end</span>
  <span class="n">current_target_definition</span><span class="o">.</span><span class="n">store_pod</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">requirements</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>name 为 Alamofire，由于我们没有指定对应的 Alamofire 版本，默认会使用最新版本。<code>requirements</code>  是控制 该 pod 来源获取或者 pod target 的编译选项等，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9&#39;</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:modular_headers</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:configurations</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;Debug&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta&#39;</span><span class="o">]</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://github.com/CocoaPods/Specs.git&#39;</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:subspecs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;Attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;QuerySet&#39;</span><span class="o">]</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:testspecs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;UnitTests&#39;</span><span class="p">,</span> <span class="s1">&#39;SomeOtherTests&#39;</span><span class="o">]</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;~/Documents/AFNetworking&#39;</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:podspec</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://example.com/Alamofire.podspec&#39;</span>
<span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://github.com/looseyi/Alamofire.git&#39;</span><span class="p">,</span> <span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="s1">&#39;0.7.0&#39;</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Tips：requirements 最终是以 Gem::Requirement 对象来保存的。关于 pod 详细说明请移步：<a href="https://guides.cocoapods.org/syntax/podfile.html#pod">Podfile 手册</a>。</p>
</blockquote>
<p>对 name 进行校验后，直接转入 <code>current_target_definition</code> 毕竟 Pod 库都是存在 <code>Pods.project</code> 之下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">store_pod</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">requirements</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">if</span> <span class="n">parse_subspecs</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span> <span class="c1"># This parse method must be called first</span>
  <span class="n">parse_inhibit_warnings</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
  <span class="n">parse_modular_headers</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
  <span class="n">parse_configuration_whitelist</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
  <span class="n">parse_project_name</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">requirements</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">requirements</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">pod</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span> <span class="o">=&gt;</span> <span class="n">requirements</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="n">pod</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="k">end</span>

  <span class="n">get_hash_value</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">pod</span>
  <span class="kp">nil</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">get_hash_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">base_value</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="k">unless</span> <span class="no">HASH_KEYS</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">StandardError</span><span class="p">,</span> <span class="s2">&#34;Unsupported hash key `</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">`&#34;</span>
  <span class="k">end</span>
  <span class="n">internal_hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">base_value</span> <span class="k">if</span> <span class="n">internal_hash</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">nil?</span>
  <span class="n">internal_hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">set_hash_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">unless</span> <span class="no">HASH_KEYS</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">StandardError</span><span class="p">,</span> <span class="s2">&#34;Unsupported hash key `</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">`&#34;</span>
  <span class="k">end</span>
  <span class="n">internal_hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>经过一系列检查之后，调用 <code>get_hash_value</code> 获取 <code>internal_hash</code> 的 <code>dependencies</code>，并将 name 和 <code>requirements</code> 选项存入。</p>
<p>这里的 <code>dependencies</code> key 是定义在 TargetDefinition 文件的 <code>**HASH_KEYS**</code>，表示 Core 所支持的配置参数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># freeze 表示该数组不可修改。另外，%w 用于表示其中元素被单引号括起的数组。 </span>
<span class="c1"># %W(#{foo} Bar Bar\ with\ space) =&gt; [&#34;Foo&#34;, &#34;Bar&#34;, &#34;Bar with space&#34;] </span>
<span class="c1"># 对应的还有 %W 表示其中元素被双引号括起的数组。</span>

<span class="no">HASH_KEYS</span> <span class="o">=</span> <span class="sx">%w(
</span><span class="sx">  name
</span><span class="sx">  platform
</span><span class="sx">  podspecs
</span><span class="sx">  exclusive
</span><span class="sx">  link_with
</span><span class="sx">  link_with_first_target
</span><span class="sx">  inhibit_warnings
</span><span class="sx">  use_modular_headers
</span><span class="sx">  user_project_path
</span><span class="sx">  build_configurations
</span><span class="sx">  project_names
</span><span class="sx">  dependencies
</span><span class="sx">  script_phases
</span><span class="sx">  children
</span><span class="sx">  configuration_pod_whitelist
</span><span class="sx">  uses_frameworks
</span><span class="sx">  swift_version_requirements
</span><span class="sx">  inheritance
</span><span class="sx">  abstract
</span><span class="sx">  swift_version
</span><span class="sx">)</span><span class="o">.</span><span class="n">freeze</span>
</code></pre></td></tr></table>
</div>
</div><p>整个映射过程如下：</p>
<p><img src="http://cdn.nlark.com/yuque/0/2020/jpeg/98641/1599993134247-591416bf-8bbb-46cb-a8b9-86c41721acde.jpeg#align=left&amp;display=inline&amp;height=421&amp;margin=%5Bobject%20Object%5D&amp;originHeight=421&amp;originWidth=276&amp;size=0&amp;status=done&amp;style=none&amp;width=276" alt=""></p>
<h1 id="精细化的-podfile-配置">精细化的 Podfile 配置</h1>
<p>最后一节让我们来展示一下 💪，看看 <code>Podfile</code> 所谓的 <code>targets</code> 之间的依赖关系可以玩出什么花来 😂。</p>
<h2 id="target-嵌套">Target 嵌套</h2>
<p>最简单的 <code>Podfile</code> 就是文章开头所展示的，不过在 <code>Podfile</code> 中还可以对 Target 进行嵌套使用。假设在我们的主工程同时维护了三个项目，它们都依赖了 Alamofire，通过俄罗斯套娃就能轻松满足条件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">target</span> <span class="s1">&#39;Demo1&#39;</span> <span class="k">do</span>
  <span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span>

  <span class="n">target</span> <span class="s1">&#39;Demo2&#39;</span> <span class="k">do</span>
    <span class="n">target</span> <span class="s1">&#39;Demo3&#39;</span> <span class="k">do</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>编译后的 <code>Pods.project</code> 项目结构如下：</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cgy1gji2j7fb2pj21nk0q8wpl.jpg" alt="09-podfile-queue"></p>
<p>我们知道，CocoaPods 在 <code>Pods.project</code> 中为每个在 Podfile 中声明的 Target 生成一个与之对应的专属 Target 来集成它的 Pod 依赖。对于有依赖关系的 Target 其生成的专属 Target 名称则会按照依赖关系叠加来命名，如  <code>target Demo3</code> 的专属 Target 名称为 <strong>Pods-Demo1-Demo2-Demo3</strong>。安装完成后主项目将会引入该专属 Target 来完成依赖关联，如 Demo3：</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cgy1gji2kfu6xlj21nk0q8gw5.jpg" alt="10-podfile-link"></p>
<p>关于 Target 嵌套，一个父节点是可以有多个子节点的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">target</span> <span class="s1">&#39;Demo1&#39;</span> <span class="k">do</span>
  <span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span>

  <span class="n">target</span> <span class="s1">&#39;Demo2&#39;</span> <span class="k">do</span>
  	<span class="n">pod</span> <span class="s1">&#39;RxSwift&#39;</span>
  <span class="k">end</span>
  <span class="n">target</span> <span class="s1">&#39;Demo3&#39;</span> <span class="k">do</span>
	  <span class="n">pod</span> <span class="s1">&#39;SwiftyJSON&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="abstract-target">Abstract Target</h2>
<p>上面例子中，由于 Demo1 与 Demo2 都需要依赖 Alamofire，我们通过 Target 嵌套让 Demo2 来继承 Demo1 的 Pods 库依赖。这么做可能会有一个限制，就是当 Demo1 的 Pod 依赖并非 Demo2 所需要的时候，就会有依赖冗余。此时就需要 <code>Abstract Target</code> 登场了。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">abstract_target</span> <span class="s1">&#39;Networking&#39;</span> <span class="k">do</span>
  <span class="n">pod</span> <span class="s1">&#39;Alamofire&#39;</span>

  <span class="n">target</span> <span class="s1">&#39;Demo1&#39;</span> <span class="k">do</span>
    <span class="n">pod</span> <span class="s1">&#39;RxSwift&#39;</span>
  <span class="k">end</span>
  <span class="n">target</span> <span class="s1">&#39;Demo2&#39;</span> <span class="k">do</span>
    <span class="n">pod</span> <span class="s1">&#39;ReactCocoa&#39;</span>
  <span class="k">end</span>
  <span class="n">target</span> <span class="s1">&#39;Demo3&#39;</span> <span class="k">do</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></td></tr></table>
</div>
</div><p>将网络请求的 pod 依赖抽象到 <code>Networking</code> target 中，这样就能避免 Demo2 对 RxSwift 的依赖。这种方式配置所生成的 <code>Pods.project</code> 并不会存在名称为 <code>Networking</code> 的 Target，它仅会在主工程的专属 Target 中留下印记：</p>
<p><img src="http://ww1.sinaimg.cn/large/8157560cly1gji2mw1b6fj21nk0q8aks.jpg" alt="11-podfile-abstract-target"></p>
<h1 id="总结">总结</h1>
<p>本文结合 Xcode 工程结构来展开 CocoaPods-Core 的 Podfile 之旅，主要感受如下：</p>
<ol>
<li>再一次感受了 Ruby 语言的动态之美，给我一个字符串，还你一个未知世界；</li>
<li>结合 Xcode 工程结构更好的理解了 Podfile 的设计初衷，<strong>基础知识很重要；</strong></li>
<li>所谓“算法无用论”这种事情，在计算机的世界是不存在的，没有好的数据结构知识如何更好的抽象；</li>
<li>了解 Podfile 的 DSL 是如何映射到内存中，又是如何来存储每个关键数据的</li>
</ol>
<h1 id="知识点问题梳理">知识点问题梳理</h1>
<p>这里罗列了四个问题用来考察你是否已经掌握了这篇文章，如果没有建议你加入<strong>收藏</strong>再次阅读：</p>
<ol>
<li>说说 TargetDefinition 的数据结构 ？</li>
<li>说说 TargetDefinition 与 Xcode Project 的关系 ？</li>
<li>Podfile 的文件格式有几种，分别是如何加载 ？</li>
<li>Lockfile 和 Podfile 的关系</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">土土Edmond木</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-09-17
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cocoapods/">CocoaPods</a>
          <a href="/tags/ios/">iOS</a>
          <a href="/tags/ruby/">Ruby</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/sourcecode-cocoapods/05-cocoapods-podspec/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">5. Podspec 文件分析</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/sourcecode-cocoapods/03-cocoapods-claide/">
            <span class="next-text nav-default">3. CocoaPods 命令解析 - CLAide</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="looseyi/looseyi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:chun574271939@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/looseyi" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/looseyi" class="iconfont icon-github" title="github"></a>
      <a href="https://www.weibo.com/foreverclp" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/tu-tu-edmondmu" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="http://looseyi.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019-12-11 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">土土Edmond木</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62789092-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
